(()=>{var UE=Object.defineProperty,VE=Object.defineProperties;var zE=Object.getOwnPropertyDescriptors;var qm=Object.getOwnPropertySymbols;var WE=Object.prototype.hasOwnProperty,YE=Object.prototype.propertyIsEnumerable;var Fm=(it,Qe,Ae)=>Qe in it?UE(it,Qe,{enumerable:!0,configurable:!0,writable:!0,value:Ae}):it[Qe]=Ae,na=(it,Qe)=>{for(var Ae in Qe||(Qe={}))WE.call(Qe,Ae)&&Fm(it,Ae,Qe[Ae]);if(qm)for(var Ae of qm(Qe))YE.call(Qe,Ae)&&Fm(it,Ae,Qe[Ae]);return it},lc=(it,Qe)=>VE(it,zE(Qe));var hu=(it,Qe,Ae)=>{if(!Qe.has(it))throw TypeError("Cannot "+Ae)};var N=(it,Qe,Ae)=>(hu(it,Qe,"read from private field"),Ae?Ae.call(it):Qe.get(it)),F=(it,Qe,Ae)=>{if(Qe.has(it))throw TypeError("Cannot add the same private member more than once");Qe instanceof WeakSet?Qe.add(it):Qe.set(it,Ae)},pe=(it,Qe,Ae,Za)=>(hu(it,Qe,"write to private field"),Za?Za.call(it,Ae):Qe.set(it,Ae),Ae),Um=(it,Qe,Ae,Za)=>({set _(p){pe(it,Qe,p,Ae)},get _(){return N(it,Qe,Za)}}),H=(it,Qe,Ae)=>(hu(it,Qe,"access private method"),Ae);var oe=(it,Qe,Ae)=>new Promise((Za,p)=>{var ke=et=>{try{qe(Ae.next(et))}catch(ve){p(ve)}},Te=et=>{try{qe(Ae.throw(et))}catch(ve){p(ve)}},qe=et=>et.done?Za(et.value):Promise.resolve(et.value).then(ke,Te);qe((Ae=Ae.apply(it,Qe)).next())});(()=>{var it={970:function(p,ke,Te){var qe;(function(et){"use strict";function ve(W,q){var j=(W&65535)+(q&65535),Je=(W>>16)+(q>>16)+(j>>16);return Je<<16|j&65535}function K(W,q){return W<<q|W>>>32-q}function S(W,q,j,Je,me,T){return ve(K(ve(ve(q,W),ve(Je,T)),me),j)}function M(W,q,j,Je,me,T,re){return S(q&j|~q&Je,W,q,me,T,re)}function te(W,q,j,Je,me,T,re){return S(q&Je|j&~Je,W,q,me,T,re)}function $(W,q,j,Je,me,T,re){return S(q^j^Je,W,q,me,T,re)}function se(W,q,j,Je,me,T,re){return S(j^(q|~Je),W,q,me,T,re)}function Ee(W,q){W[q>>5]|=128<<q%32,W[(q+64>>>9<<4)+14]=q;var j,Je,me,T,re,z=1732584193,R=-271733879,O=-1732584194,Y=271733878;for(j=0;j<W.length;j+=16)Je=z,me=R,T=O,re=Y,z=M(z,R,O,Y,W[j],7,-680876936),Y=M(Y,z,R,O,W[j+1],12,-389564586),O=M(O,Y,z,R,W[j+2],17,606105819),R=M(R,O,Y,z,W[j+3],22,-1044525330),z=M(z,R,O,Y,W[j+4],7,-176418897),Y=M(Y,z,R,O,W[j+5],12,1200080426),O=M(O,Y,z,R,W[j+6],17,-1473231341),R=M(R,O,Y,z,W[j+7],22,-45705983),z=M(z,R,O,Y,W[j+8],7,1770035416),Y=M(Y,z,R,O,W[j+9],12,-1958414417),O=M(O,Y,z,R,W[j+10],17,-42063),R=M(R,O,Y,z,W[j+11],22,-1990404162),z=M(z,R,O,Y,W[j+12],7,1804603682),Y=M(Y,z,R,O,W[j+13],12,-40341101),O=M(O,Y,z,R,W[j+14],17,-1502002290),R=M(R,O,Y,z,W[j+15],22,1236535329),z=te(z,R,O,Y,W[j+1],5,-165796510),Y=te(Y,z,R,O,W[j+6],9,-1069501632),O=te(O,Y,z,R,W[j+11],14,643717713),R=te(R,O,Y,z,W[j],20,-373897302),z=te(z,R,O,Y,W[j+5],5,-701558691),Y=te(Y,z,R,O,W[j+10],9,38016083),O=te(O,Y,z,R,W[j+15],14,-660478335),R=te(R,O,Y,z,W[j+4],20,-405537848),z=te(z,R,O,Y,W[j+9],5,568446438),Y=te(Y,z,R,O,W[j+14],9,-1019803690),O=te(O,Y,z,R,W[j+3],14,-187363961),R=te(R,O,Y,z,W[j+8],20,1163531501),z=te(z,R,O,Y,W[j+13],5,-1444681467),Y=te(Y,z,R,O,W[j+2],9,-51403784),O=te(O,Y,z,R,W[j+7],14,1735328473),R=te(R,O,Y,z,W[j+12],20,-1926607734),z=$(z,R,O,Y,W[j+5],4,-378558),Y=$(Y,z,R,O,W[j+8],11,-2022574463),O=$(O,Y,z,R,W[j+11],16,1839030562),R=$(R,O,Y,z,W[j+14],23,-35309556),z=$(z,R,O,Y,W[j+1],4,-1530992060),Y=$(Y,z,R,O,W[j+4],11,1272893353),O=$(O,Y,z,R,W[j+7],16,-155497632),R=$(R,O,Y,z,W[j+10],23,-1094730640),z=$(z,R,O,Y,W[j+13],4,681279174),Y=$(Y,z,R,O,W[j],11,-358537222),O=$(O,Y,z,R,W[j+3],16,-722521979),R=$(R,O,Y,z,W[j+6],23,76029189),z=$(z,R,O,Y,W[j+9],4,-640364487),Y=$(Y,z,R,O,W[j+12],11,-421815835),O=$(O,Y,z,R,W[j+15],16,530742520),R=$(R,O,Y,z,W[j+2],23,-995338651),z=se(z,R,O,Y,W[j],6,-198630844),Y=se(Y,z,R,O,W[j+7],10,1126891415),O=se(O,Y,z,R,W[j+14],15,-1416354905),R=se(R,O,Y,z,W[j+5],21,-57434055),z=se(z,R,O,Y,W[j+12],6,1700485571),Y=se(Y,z,R,O,W[j+3],10,-1894986606),O=se(O,Y,z,R,W[j+10],15,-1051523),R=se(R,O,Y,z,W[j+1],21,-2054922799),z=se(z,R,O,Y,W[j+8],6,1873313359),Y=se(Y,z,R,O,W[j+15],10,-30611744),O=se(O,Y,z,R,W[j+6],15,-1560198380),R=se(R,O,Y,z,W[j+13],21,1309151649),z=se(z,R,O,Y,W[j+4],6,-145523070),Y=se(Y,z,R,O,W[j+11],10,-1120210379),O=se(O,Y,z,R,W[j+2],15,718787259),R=se(R,O,Y,z,W[j+9],21,-343485551),z=ve(z,Je),R=ve(R,me),O=ve(O,T),Y=ve(Y,re);return[z,R,O,Y]}function $e(W){var q,j="",Je=W.length*32;for(q=0;q<Je;q+=8)j+=String.fromCharCode(W[q>>5]>>>q%32&255);return j}function Xe(W){var q,j=[];for(j[(W.length>>2)-1]=void 0,q=0;q<j.length;q+=1)j[q]=0;var Je=W.length*8;for(q=0;q<Je;q+=8)j[q>>5]|=(W.charCodeAt(q/8)&255)<<q%32;return j}function bt(W){return $e(Ee(Xe(W),W.length*8))}function J(W,q){var j,Je=Xe(W),me=[],T=[],re;for(me[15]=T[15]=void 0,Je.length>16&&(Je=Ee(Je,W.length*8)),j=0;j<16;j+=1)me[j]=Je[j]^909522486,T[j]=Je[j]^1549556828;return re=Ee(me.concat(Xe(q)),512+q.length*8),$e(Ee(T.concat(re),640))}function Me(W){var q="0123456789abcdef",j="",Je,me;for(me=0;me<W.length;me+=1)Je=W.charCodeAt(me),j+=q.charAt(Je>>>4&15)+q.charAt(Je&15);return j}function st(W){return unescape(encodeURIComponent(W))}function Oe(W){return bt(st(W))}function rt(W){return Me(Oe(W))}function ot(W,q){return J(st(W),st(q))}function Aa(W,q){return Me(ot(W,q))}function aa(W,q,j){return q?j?ot(q,W):Aa(q,W):j?Oe(W):rt(W)}qe=function(){return aa}.call(ke,Te,ke,p),qe!==void 0&&(p.exports=qe)})(this)},680:function(p){(function(ke,Te){p.exports=Te()})(this,function(){"use strict";var ke=1e3,Te=6e4,qe=36e5,et="millisecond",ve="second",K="minute",S="hour",M="day",te="week",$="month",se="quarter",Ee="year",$e="date",Xe="Invalid Date",bt=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,J=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Me={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},st=function(me,T,re){var z=String(me);return!z||z.length>=T?me:""+Array(T+1-z.length).join(re)+me},Oe={s:st,z:function(me){var T=-me.utcOffset(),re=Math.abs(T),z=Math.floor(re/60),R=re%60;return(T<=0?"+":"-")+st(z,2,"0")+":"+st(R,2,"0")},m:function me(T,re){if(T.date()<re.date())return-me(re,T);var z=12*(re.year()-T.year())+(re.month()-T.month()),R=T.clone().add(z,$),O=re-R<0,Y=T.clone().add(z+(O?-1:1),$);return+(-(z+(re-R)/(O?R-Y:Y-R))||0)},a:function(me){return me<0?Math.ceil(me)||0:Math.floor(me)},p:function(me){return{M:$,y:Ee,w:te,d:M,D:$e,h:S,m:K,s:ve,ms:et,Q:se}[me]||String(me||"").toLowerCase().replace(/s$/,"")},u:function(me){return me===void 0}},rt="en",ot={};ot[rt]=Me;var Aa=function(me){return me instanceof j},aa=function me(T,re,z){var R;if(!T)return rt;if(typeof T=="string"){var O=T.toLowerCase();ot[O]&&(R=O),re&&(ot[O]=re,R=O);var Y=T.split("-");if(!R&&Y.length>1)return me(Y[0])}else{var nt=T.name;ot[nt]=T,R=nt}return!z&&R&&(rt=R),R||!z&&rt},W=function(me,T){if(Aa(me))return me.clone();var re=typeof T=="object"?T:{};return re.date=me,re.args=arguments,new j(re)},q=Oe;q.l=aa,q.i=Aa,q.w=function(me,T){return W(me,{locale:T.$L,utc:T.$u,x:T.$x,$offset:T.$offset})};var j=function(){function me(re){this.$L=aa(re.locale,null,!0),this.parse(re)}var T=me.prototype;return T.parse=function(re){this.$d=function(z){var R=z.date,O=z.utc;if(R===null)return new Date(NaN);if(q.u(R))return new Date;if(R instanceof Date)return new Date(R);if(typeof R=="string"&&!/Z$/i.test(R)){var Y=R.match(bt);if(Y){var nt=Y[2]-1||0,ye=(Y[7]||"0").substring(0,3);return O?new Date(Date.UTC(Y[1],nt,Y[3]||1,Y[4]||0,Y[5]||0,Y[6]||0,ye)):new Date(Y[1],nt,Y[3]||1,Y[4]||0,Y[5]||0,Y[6]||0,ye)}}return new Date(R)}(re),this.$x=re.x||{},this.init()},T.init=function(){var re=this.$d;this.$y=re.getFullYear(),this.$M=re.getMonth(),this.$D=re.getDate(),this.$W=re.getDay(),this.$H=re.getHours(),this.$m=re.getMinutes(),this.$s=re.getSeconds(),this.$ms=re.getMilliseconds()},T.$utils=function(){return q},T.isValid=function(){return this.$d.toString()!==Xe},T.isSame=function(re,z){var R=W(re);return this.startOf(z)<=R&&R<=this.endOf(z)},T.isAfter=function(re,z){return W(re)<this.startOf(z)},T.isBefore=function(re,z){return this.endOf(z)<W(re)},T.$g=function(re,z,R){return q.u(re)?this[z]:this.set(R,re)},T.unix=function(){return Math.floor(this.valueOf()/1e3)},T.valueOf=function(){return this.$d.getTime()},T.startOf=function(re,z){var R=this,O=!!q.u(z)||z,Y=q.p(re),nt=function(ae,Wt){var Ue=q.w(R.$u?Date.UTC(R.$y,Wt,ae):new Date(R.$y,Wt,ae),R);return O?Ue:Ue.endOf(M)},ye=function(ae,Wt){return q.w(R.toDate()[ae].apply(R.toDate("s"),(O?[0,0,0,0]:[23,59,59,999]).slice(Wt)),R)},wt=this.$W,Pt=this.$M,_n=this.$D,Ot="set"+(this.$u?"UTC":"");switch(Y){case Ee:return O?nt(1,0):nt(31,11);case $:return O?nt(1,Pt):nt(0,Pt+1);case te:var Mt=this.$locale().weekStart||0,Rt=(wt<Mt?wt+7:wt)-Mt;return nt(O?_n-Rt:_n+(6-Rt),Pt);case M:case $e:return ye(Ot+"Hours",0);case S:return ye(Ot+"Minutes",1);case K:return ye(Ot+"Seconds",2);case ve:return ye(Ot+"Milliseconds",3);default:return this.clone()}},T.endOf=function(re){return this.startOf(re,!1)},T.$set=function(re,z){var R,O=q.p(re),Y="set"+(this.$u?"UTC":""),nt=(R={},R[M]=Y+"Date",R[$e]=Y+"Date",R[$]=Y+"Month",R[Ee]=Y+"FullYear",R[S]=Y+"Hours",R[K]=Y+"Minutes",R[ve]=Y+"Seconds",R[et]=Y+"Milliseconds",R)[O],ye=O===M?this.$D+(z-this.$W):z;if(O===$||O===Ee){var wt=this.clone().set($e,1);wt.$d[nt](ye),wt.init(),this.$d=wt.set($e,Math.min(this.$D,wt.daysInMonth())).$d}else nt&&this.$d[nt](ye);return this.init(),this},T.set=function(re,z){return this.clone().$set(re,z)},T.get=function(re){return this[q.p(re)]()},T.add=function(re,z){var R,O=this;re=Number(re);var Y=q.p(z),nt=function(Pt){var _n=W(O);return q.w(_n.date(_n.date()+Math.round(Pt*re)),O)};if(Y===$)return this.set($,this.$M+re);if(Y===Ee)return this.set(Ee,this.$y+re);if(Y===M)return nt(1);if(Y===te)return nt(7);var ye=(R={},R[K]=Te,R[S]=qe,R[ve]=ke,R)[Y]||1,wt=this.$d.getTime()+re*ye;return q.w(wt,this)},T.subtract=function(re,z){return this.add(-1*re,z)},T.format=function(re){var z=this,R=this.$locale();if(!this.isValid())return R.invalidDate||Xe;var O=re||"YYYY-MM-DDTHH:mm:ssZ",Y=q.z(this),nt=this.$H,ye=this.$m,wt=this.$M,Pt=R.weekdays,_n=R.months,Ot=function(Wt,Ue,Le,Ne){return Wt&&(Wt[Ue]||Wt(z,O))||Le[Ue].slice(0,Ne)},Mt=function(Wt){return q.s(nt%12||12,Wt,"0")},Rt=R.meridiem||function(Wt,Ue,Le){var Ne=Wt<12?"AM":"PM";return Le?Ne.toLowerCase():Ne},ae={YY:String(this.$y).slice(-2),YYYY:this.$y,M:wt+1,MM:q.s(wt+1,2,"0"),MMM:Ot(R.monthsShort,wt,_n,3),MMMM:Ot(_n,wt),D:this.$D,DD:q.s(this.$D,2,"0"),d:String(this.$W),dd:Ot(R.weekdaysMin,this.$W,Pt,2),ddd:Ot(R.weekdaysShort,this.$W,Pt,3),dddd:Pt[this.$W],H:String(nt),HH:q.s(nt,2,"0"),h:Mt(1),hh:Mt(2),a:Rt(nt,ye,!0),A:Rt(nt,ye,!1),m:String(ye),mm:q.s(ye,2,"0"),s:String(this.$s),ss:q.s(this.$s,2,"0"),SSS:q.s(this.$ms,3,"0"),Z:Y};return O.replace(J,function(Wt,Ue){return Ue||ae[Wt]||Y.replace(":","")})},T.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},T.diff=function(re,z,R){var O,Y=q.p(z),nt=W(re),ye=(nt.utcOffset()-this.utcOffset())*Te,wt=this-nt,Pt=q.m(this,nt);return Pt=(O={},O[Ee]=Pt/12,O[$]=Pt,O[se]=Pt/3,O[te]=(wt-ye)/6048e5,O[M]=(wt-ye)/864e5,O[S]=wt/qe,O[K]=wt/Te,O[ve]=wt/ke,O)[Y]||wt,R?Pt:q.a(Pt)},T.daysInMonth=function(){return this.endOf($).$D},T.$locale=function(){return ot[this.$L]},T.locale=function(re,z){if(!re)return this.$L;var R=this.clone(),O=aa(re,z,!0);return O&&(R.$L=O),R},T.clone=function(){return q.w(this.$d,this)},T.toDate=function(){return new Date(this.valueOf())},T.toJSON=function(){return this.isValid()?this.toISOString():null},T.toISOString=function(){return this.$d.toISOString()},T.toString=function(){return this.$d.toUTCString()},me}(),Je=j.prototype;return W.prototype=Je,[["$ms",et],["$s",ve],["$m",K],["$H",S],["$W",M],["$M",$],["$y",Ee],["$D",$e]].forEach(function(me){Je[me[1]]=function(T){return this.$g(T,me[0],me[1])}}),W.extend=function(me,T){return me.$i||(me(T,j,W),me.$i=!0),W},W.locale=aa,W.isDayjs=Aa,W.unix=function(me){return W(1e3*me)},W.en=ot[rt],W.Ls=ot,W.p={},W})},852:(p,ke,Te)=>{"use strict";Te.r(ke),Te.d(ke,{Constants:()=>S});var qe=Te(314);const et="2.10.11",ve="production",K=class{};let S=K;S.SIYUAN_VERSION=et,S.NODE_ENV=ve,S.SIYUAN_APPID=Math.random().toString(36).substring(8),S.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",S.PROTYLE_CDN="/stage/protyle",S.UPLOAD_ADDRESS="/upload",S.SERVICE_WORKER_PATH="/service-worker.js",S.SIYUAN_DROP_FILE="application/siyuan-file",S.SIYUAN_DROP_GUTTER="application/siyuan-gutter",S.SIYUAN_DROP_TAB="application/siyuan-tab",S.SIYUAN_DROP_EDITOR="application/siyuan-editor",S.SIYUAN_CMD="siyuan-cmd",S.SIYUAN_GET="siyuan-get",S.SIYUAN_EVENT="siyuan-event",S.SIYUAN_CONFIG_TRAY="siyuan-config-tray",S.SIYUAN_QUIT="siyuan-quit",S.SIYUAN_HOTKEY="siyuan-hotkey",S.SIYUAN_INIT="siyuan-init",S.SIYUAN_SEND_WINDOWS="siyuan-send-windows",S.SIYUAN_SAVE_CLOSE="siyuan-save-close",S.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",S.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",S.SIYUAN_OPEN_URL="siyuan-open-url",S.SIYUAN_OPEN_WINDOW="siyuan-open-window",S.SIYUAN_OPEN_FOLDER="siyuan-open-folder",S.SIYUAN_OPEN_FILE="siyuan-open-file",S.SIYUAN_EXPORT_PDF="siyuan-export-pdf",S.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",S.CUSTOM_SY_READONLY="custom-sy-readonly",S.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",S.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",S.CUSTOM_RIFF_DECKS="custom-riff-decks",S.SIZE_LINK_TEXT_MAX=24,S.SIZE_TOOLBAR_HEIGHT=(0,qe.tq)()?0:32,S.SIZE_GET_MAX=102400,S.SIZE_UNDO=64,S.SIZE_TITLE=512,S.SIZE_EDITOR_WIDTH=760,S.SIZE_ZOOM=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3],S.CB_MOVE_NOLIST="cb-move-nolist",S.CB_MOUNT_REMOVE="cb-mount-remove",S.CB_GET_APPEND="cb-get-append",S.CB_GET_BEFORE="cb-get-before",S.CB_GET_UNCHANGEID="cb-get-unchangeid",S.CB_GET_HL="cb-get-hl",S.CB_GET_FOCUS="cb-get-focus",S.CB_GET_FOCUSFIRST="cb-get-focusfirst",S.CB_GET_SETID="cb-get-setid",S.CB_GET_ALL="cb-get-all",S.CB_GET_BACKLINK="cb-get-backlink",S.CB_GET_UNUNDO="cb-get-unundo",S.CB_GET_SCROLL="cb-get-scroll",S.CB_GET_CONTEXT="cb-get-context",S.CB_GET_ROOTSCROLL="cb-get-rootscroll",S.CB_GET_HTML="cb-get-html",S.CB_GET_HISTORY="cb-get-history",S.LOCAL_ZOOM="local-zoom",S.LOCAL_SEARCHDATA="local-searchdata",S.LOCAL_SEARCHKEYS="local-searchkeys",S.LOCAL_SEARCHASSET="local-searchasset",S.LOCAL_DOCINFO="local-docinfo",S.LOCAL_DAILYNOTEID="local-dailynoteid",S.LOCAL_HISTORYNOTEID="local-historynoteid",S.LOCAL_CODELANG="local-codelang",S.LOCAL_FONTSTYLES="local-fontstyles",S.LOCAL_EXPORTPDF="local-exportpdf",S.LOCAL_EXPORTWORD="local-exportword",S.LOCAL_EXPORTIMG="local-exportimg",S.LOCAL_BAZAAR="local-bazaar",S.LOCAL_PDFTHEME="local-pdftheme",S.LOCAL_LAYOUTS="local-layouts",S.LOCAL_AI="local-ai",S.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",S.TIMEOUT_DBLCLICK=190,S.TIMEOUT_INPUT=256,S.TIMEOUT_LOAD=300,S.TIMEOUT_TRANSITION=300,S.TIMEOUT_COUNT=1e3,S.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr"},S.QUICK_DECK_ID="20230218211946-2kw8jgx",S.KEYCODELIST={8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2318",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},S.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:"\u23251",custom:"\u23251"},outline:{default:"\u23252",custom:"\u23252"},bookmark:{default:"\u23253",custom:"\u23253"},tag:{default:"\u23254",custom:"\u23254"},dailyNote:{default:"\u23255",custom:"\u23255"},inbox:{default:"\u23256",custom:"\u23256"},backlinks:{default:"\u23257",custom:"\u23257"},graphView:{default:"\u23258",custom:"\u23258"},globalGraph:{default:"\u23259",custom:"\u23259"},riffCard:{default:"\u23250",custom:"\u23250"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},S.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:227,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:227,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:227,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:227,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},S.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,S.SIYUAN_IMAGE_FILE="1f4c4",S.SIYUAN_IMAGE_NOTE="1f5c3",S.SIYUAN_IMAGE_FOLDER="1f4d1",S.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],S.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a"],S.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],S.SIYUAN_ASSETS_EXTS=[".pdf"].concat(K.SIYUAN_ASSETS_IMAGE).concat(K.SIYUAN_ASSETS_AUDIO).concat(K.SIYUAN_ASSETS_VIDEO),S.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],S.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],S.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],S.ZWSP="\u200B",S.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo"],S.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],S.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},S.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],S.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig"},706:(p,ke,Te)=>{"use strict";Te.r(ke),Te.d(ke,{addScript:()=>et,addScriptSync:()=>qe});const qe=(ve,K)=>{if(document.getElementById(K))return!1;const S=new XMLHttpRequest;S.open("GET",ve,!1),S.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),S.send("");const M=document.createElement("script");M.type="text/javascript",M.text=S.responseText,M.id=K,document.head.appendChild(M)},et=(ve,K)=>new Promise(S=>{if(document.getElementById(K))return S(!1),!1;const M=document.createElement("script");M.src=ve,M.async=!0,document.head.appendChild(M),M.onload=()=>{if(document.getElementById(K))return M.remove(),S(!1),!1;M.id=K,S(!0)}})},314:(p,ke,Te)=>{"use strict";Te.d(ke,{FJ:()=>K,MK:()=>J,N_:()=>et,Qf:()=>bt,UP:()=>ve,Y$:()=>Ee,b1:()=>S,jU:()=>se,on:()=>$,qP:()=>M,rJ:()=>$e,sZ:()=>te,tq:()=>qe,vc:()=>Xe});const qe=()=>!!document.getElementById("sidebar"),et=()=>["docker","ios","android"].includes(window.siyuan.config.system.container)?window.siyuan.config.system.container:window.siyuan.config.system.os,ve=()=>window.navigator.userAgent.startsWith("SiYuan/")?K()?"desktop-window":"desktop":"browser-desktop",K=()=>!document.getElementById("toolbar"),S=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,M=(Me,st)=>Me.length===st.length&&Me.every(Oe=>st.includes(Oe)),te=(Me,st)=>Math.floor(Math.random()*(st-Me+1))+Me,$=(Me,st=window.location.search)=>{const Oe=st.substring(st.indexOf("?")),rt=Oe.indexOf("#");return new URLSearchParams(Oe.substring(0,rt>=0?rt:void 0)).get(Me)},se=()=>!0,Ee=Me=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(Me),$e=Me=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(Me),Xe=Me=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(Me),bt=Me=>Function(`"use strict";return (${Me})`)(),J=(Me,st)=>{if(Me===st||typeof Me=="number"&&isNaN(Me)&&typeof st=="number"&&isNaN(st))return!0;if(Me instanceof Date&&st instanceof Date)return Me.getTime()===st.getTime();if(!Me||!st||typeof Me!="object"&&typeof st!="object")return Me===st;if(Me.prototype!==st.prototype)return!1;const Oe=Object.keys(Me);return Oe.length!==Object.keys(st).length?!1:Oe.every(rt=>J(Me[rt],st[rt]))}},5:p=>{"use strict";function ke(ve){if(typeof ve!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(ve))}function Te(ve,K){for(var S="",M=0,te=-1,$=0,se,Ee=0;Ee<=ve.length;++Ee){if(Ee<ve.length)se=ve.charCodeAt(Ee);else{if(se===47)break;se=47}if(se===47){if(!(te===Ee-1||$===1))if(te!==Ee-1&&$===2){if(S.length<2||M!==2||S.charCodeAt(S.length-1)!==46||S.charCodeAt(S.length-2)!==46){if(S.length>2){var $e=S.lastIndexOf("/");if($e!==S.length-1){$e===-1?(S="",M=0):(S=S.slice(0,$e),M=S.length-1-S.lastIndexOf("/")),te=Ee,$=0;continue}}else if(S.length===2||S.length===1){S="",M=0,te=Ee,$=0;continue}}K&&(S.length>0?S+="/..":S="..",M=2)}else S.length>0?S+="/"+ve.slice(te+1,Ee):S=ve.slice(te+1,Ee),M=Ee-te-1;te=Ee,$=0}else se===46&&$!==-1?++$:$=-1}return S}function qe(ve,K){var S=K.dir||K.root,M=K.base||(K.name||"")+(K.ext||"");return S?S===K.root?S+M:S+ve+M:M}var et={resolve:function(){for(var K="",S=!1,M,te=arguments.length-1;te>=-1&&!S;te--){var $;te>=0?$=arguments[te]:(M===void 0&&(M=process.cwd()),$=M),ke($),$.length!==0&&(K=$+"/"+K,S=$.charCodeAt(0)===47)}return K=Te(K,!S),S?K.length>0?"/"+K:"/":K.length>0?K:"."},normalize:function(K){if(ke(K),K.length===0)return".";var S=K.charCodeAt(0)===47,M=K.charCodeAt(K.length-1)===47;return K=Te(K,!S),K.length===0&&!S&&(K="."),K.length>0&&M&&(K+="/"),S?"/"+K:K},isAbsolute:function(K){return ke(K),K.length>0&&K.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var K,S=0;S<arguments.length;++S){var M=arguments[S];ke(M),M.length>0&&(K===void 0?K=M:K+="/"+M)}return K===void 0?".":et.normalize(K)},relative:function(K,S){if(ke(K),ke(S),K===S||(K=et.resolve(K),S=et.resolve(S),K===S))return"";for(var M=1;M<K.length&&K.charCodeAt(M)===47;++M);for(var te=K.length,$=te-M,se=1;se<S.length&&S.charCodeAt(se)===47;++se);for(var Ee=S.length,$e=Ee-se,Xe=$<$e?$:$e,bt=-1,J=0;J<=Xe;++J){if(J===Xe){if($e>Xe){if(S.charCodeAt(se+J)===47)return S.slice(se+J+1);if(J===0)return S.slice(se+J)}else $>Xe&&(K.charCodeAt(M+J)===47?bt=J:J===0&&(bt=0));break}var Me=K.charCodeAt(M+J),st=S.charCodeAt(se+J);if(Me!==st)break;Me===47&&(bt=J)}var Oe="";for(J=M+bt+1;J<=te;++J)(J===te||K.charCodeAt(J)===47)&&(Oe.length===0?Oe+="..":Oe+="/..");return Oe.length>0?Oe+S.slice(se+bt):(se+=bt,S.charCodeAt(se)===47&&++se,S.slice(se))},_makeLong:function(K){return K},dirname:function(K){if(ke(K),K.length===0)return".";for(var S=K.charCodeAt(0),M=S===47,te=-1,$=!0,se=K.length-1;se>=1;--se)if(S=K.charCodeAt(se),S===47){if(!$){te=se;break}}else $=!1;return te===-1?M?"/":".":M&&te===1?"//":K.slice(0,te)},basename:function(K,S){if(S!==void 0&&typeof S!="string")throw new TypeError('"ext" argument must be a string');ke(K);var M=0,te=-1,$=!0,se;if(S!==void 0&&S.length>0&&S.length<=K.length){if(S.length===K.length&&S===K)return"";var Ee=S.length-1,$e=-1;for(se=K.length-1;se>=0;--se){var Xe=K.charCodeAt(se);if(Xe===47){if(!$){M=se+1;break}}else $e===-1&&($=!1,$e=se+1),Ee>=0&&(Xe===S.charCodeAt(Ee)?--Ee===-1&&(te=se):(Ee=-1,te=$e))}return M===te?te=$e:te===-1&&(te=K.length),K.slice(M,te)}else{for(se=K.length-1;se>=0;--se)if(K.charCodeAt(se)===47){if(!$){M=se+1;break}}else te===-1&&($=!1,te=se+1);return te===-1?"":K.slice(M,te)}},extname:function(K){ke(K);for(var S=-1,M=0,te=-1,$=!0,se=0,Ee=K.length-1;Ee>=0;--Ee){var $e=K.charCodeAt(Ee);if($e===47){if(!$){M=Ee+1;break}continue}te===-1&&($=!1,te=Ee+1),$e===46?S===-1?S=Ee:se!==1&&(se=1):S!==-1&&(se=-1)}return S===-1||te===-1||se===0||se===1&&S===te-1&&S===M+1?"":K.slice(S,te)},format:function(K){if(K===null||typeof K!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof K);return qe("/",K)},parse:function(K){ke(K);var S={root:"",dir:"",base:"",ext:"",name:""};if(K.length===0)return S;var M=K.charCodeAt(0),te=M===47,$;te?(S.root="/",$=1):$=0;for(var se=-1,Ee=0,$e=-1,Xe=!0,bt=K.length-1,J=0;bt>=$;--bt){if(M=K.charCodeAt(bt),M===47){if(!Xe){Ee=bt+1;break}continue}$e===-1&&(Xe=!1,$e=bt+1),M===46?se===-1?se=bt:J!==1&&(J=1):se!==-1&&(J=-1)}return se===-1||$e===-1||J===0||J===1&&se===$e-1&&se===Ee+1?$e!==-1&&(Ee===0&&te?S.base=S.name=K.slice(1,$e):S.base=S.name=K.slice(Ee,$e)):(Ee===0&&te?(S.name=K.slice(1,se),S.base=K.slice(1,$e)):(S.name=K.slice(Ee,se),S.base=K.slice(Ee,$e)),S.ext=K.slice(se,$e)),Ee>0?S.dir=K.slice(0,Ee-1):te&&(S.dir="/"),S},sep:"/",delimiter:":",win32:null,posix:null};et.posix=et,p.exports=et},916:(p,ke,Te)=>{"use strict";Te.r(ke),Te.d(ke,{GenericScripting:()=>K,docPropertiesLookup:()=>ve});var qe=Te(272),et=Te.n(qe);function ve(S){return oe(this,null,function*(){const M="",te=M.split("#")[0];let{info:$,metadata:se,contentDispositionFilename:Ee,contentLength:$e}=yield S.getMetadata();if(!$e){const{length:Xe}=yield S.getDownloadInfo();$e=Xe}return lc(na({},$),{baseURL:te,filesize:$e,filename:Ee||(0,qe.getPdfFilenameFromUrl)(M),metadata:se==null?void 0:se.getRaw(),authors:se==null?void 0:se.get("dc:creator"),numPages:S.numPages,URL:M})})}class K{constructor(M){this._ready=(0,qe.loadScript)(M,!0).then(()=>window.pdfjsSandbox.QuickJSSandbox())}createSandbox(M){return oe(this,null,function*(){(yield this._ready).create(M)})}dispatchEventInSandbox(M){return oe(this,null,function*(){const te=yield this._ready;setTimeout(()=>te.dispatchEvent(M),0)})}destroySandbox(){return oe(this,null,function*(){(yield this._ready).nukeSandbox()})}}},272:(p,ke,Te)=>{"use strict";const{addScriptSync:qe}=Te(706),{Constants:et}=Te(852);qe(`${et.PROTYLE_CDN}/js/pdf/pdf.js?v=3.5.141`,"pdfjsScript"),p.exports=window["pdfjs-dist/build/pdf"]},917:p=>{function ke(Te){return Promise.resolve().then(()=>{var qe=new Error("Cannot find module '"+Te+"'");throw qe.code="MODULE_NOT_FOUND",qe})}ke.keys=()=>[],ke.resolve=ke,ke.id=917,p.exports=ke}},Qe={};function Ae(p){var ke=Qe[p];if(ke!==void 0)return ke.exports;var Te=Qe[p]={exports:{}};return it[p].call(Te.exports,Te,Te.exports,Ae),Te.exports}Ae.n=p=>{var ke=p&&p.__esModule?()=>p.default:()=>p;return Ae.d(ke,{a:ke}),ke},Ae.d=(p,ke)=>{for(var Te in ke)Ae.o(ke,Te)&&!Ae.o(p,Te)&&Object.defineProperty(p,Te,{enumerable:!0,get:ke[Te]})},Ae.o=(p,ke)=>Object.prototype.hasOwnProperty.call(p,ke),Ae.r=p=>{typeof Symbol!="undefined"&&Symbol.toStringTag&&Object.defineProperty(p,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(p,"__esModule",{value:!0})};var Za={};(()=>{var qa,_i,vi,hs,Ei,ms,yo,mu,rr,Vm,bs,cr,zm,ea,bn,ta,ki,_o,vo,bu,dr,Wm,Eo,wu,ur,Ym,fr,Gm,pr,jm,gr,Km,hr,Zm,mr,Xm,Tn,ko,yu,Si,nl,So,_u,br,Jm,Lo,vu,wr,Qm,ws,Li,yr,eb,Co,Eu,xo,ku,_r,tb,vr,nb,Er,ab,Ao,Su,kr,ib,Sr,sb,ys,rc,Ci,al,Fa,Ms,Lr,ob,To,Lu,Io,Cu,_s,cc,Cr,lb,Do,xu,$o,Au,xi,il,Ai,sl,Po,Tu,vs,jt,xr,rb,Ti,ol,Ar,cb,Tr,db,Ir,ub,Dr,fb,Mo,Iu,$r,pb,Ii,ll,Pr,gb,Mr,hb,Nr,mb,Hr,bb,Br,wb,No,Du,Ua,Ns,Es,dc,ks,uc,Or,yb,Ho,$u,Rr,_b,Ss,qr,vb,Fr,Eb,Bo,Ls,va,Oo,Pu,In,Ro,Mu,qo,Nu,Ea,Dn,ka,Va,Cs,fc,Fo,Hu,xs,As,Ts,Ur,kb,Vr,Sb,za,Wa,Ya,Vo,Is,Di,Ds,pc,zo,Bu,Wo,Ou,Yo,Ru,Go,qu,zr,Lb,Wr,Cb,Sa,$i,jo,Fu,Pi,La,Jt,Mi,Ko,Zo,Xo,Yr,Ni,wn,Ga,Gr,xb,jr,Ab,Kr,Tb,Hi,rl,$s,gc,Zr,Ib,Jo,Uu,Xr,Db,Un,xa,Qo,Vu,Jr,$b,Qr,Pb,el,zu,ec,Mb,Ps,hc,tc,Nb,nc,Hb,ac,Bb,ic,Ob,tl,sc,Rb,pu,GE,ja,Hs,oc,qb,$n,yn,Ka,Rm;"use strict";var p=Ae(852);const ke=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,n=>(parseInt(n,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(n,10)/4).toString(16));class Te{constructor(e){const t=Object.assign({direction:"tb",size:"auto",type:"normal"},e);this.id=ke(),this.direction=t.direction,this.type=t.type,this.size=t.size,this.resize=e.resize,this.children=[],this.element=e.element||document.createElement("div"),this.type==="center"&&this.element.classList.add("layout__center"),t.direction==="tb"?this.element.classList.add("fn__flex-column"):this.element.classList.add("fn__flex"),t.type==="left"&&this.element.classList.add("fn__flex-shrink")}addLayout(e,t){t?this.children.find((a,i)=>{if(a.id===t)return this.children.splice(i+1,0,e),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this&&this.element.append(e.element)),e.size==="auto"?e.element.classList.add("fn__flex-1"):e.element.style[this&&this.direction==="lr"?"width":"height"]=e.size,_m(e),e.parent=this}addWnd(e,t){t?this.children.find((a,i)=>{if(a.id===t)return this.children.splice(i+1,0,e),a.element.style.width="",a.element.style.height="",a.element.classList.add("fn__flex-1"),this.direction==="lr"&&a.element.querySelectorAll(".protyle-content").forEach(s=>{s.parentElement.classList.contains("fn__none")||(s.classList.remove("protyle-content--transition"),s.querySelector(".protyle-wysiwyg").style.padding="",s.classList.add("protyle-content--transition"))}),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this.element.append(e.element)),_m(e),nn(),this.direction==="tb"&&(e.element.style.minHeight="64px"),e.parent=this}}const qe=(n,e)=>{if(!n)return!1;n.nodeType===3&&(n=n.parentElement);let t=n,a=!1;for(;t&&!a&&!t.classList.contains("b3-typography");)t.nodeName.indexOf(e)===0?a=!0:t=t.parentElement;return a&&t},et=(n,e,t=!1)=>{let a=$(n,e,t),i=!1,s=!1;for(;a&&(t?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!s;)i=$(a.parentElement,e,t),i?a=i:s=!0;return a||!1},ve=(n,e)=>{let t=qe(n,e),a=!1,i=!1;for(;t&&!t.classList.contains("protyle-wysiwyg")&&!i;)a=qe(t.parentElement,e),a?t=a:i=!0;return t||!1},K=(n,e,t,a=!1)=>{let i=S(n,e,t,a),s=!1,o=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!o;)s=S(i.parentElement,e,t,a),s?i=s:o=!0;return i||!1},S=(n,e,t,a=!1)=>{var i;if(!n)return!1;n.nodeType===3&&(n=n.parentElement);let s=n,o=!1;for(;s&&!o&&(a?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)typeof t=="string"&&((i=s.getAttribute(e))!=null&&i.split(" ").includes(t))||typeof t!="string"&&s.hasAttribute(e)?o=!0:s=s.parentElement;return o&&s},M=n=>{var e;const t=S(n,"data-node-id",null);return t&&t.tagName!=="BUTTON"&&((e=t.getAttribute("data-type"))!=null&&e.startsWith("Node"))?t:!1},te=(n,e)=>{if(!n)return!1;n.nodeType===3&&(n=n.parentElement);let t=n,a=!1;for(;t&&!a&&!t.classList.contains("protyle-wysiwyg");)t.nodeName===e?a=!0:t=t.parentElement;return a&&t},$=(n,e,t=!1)=>{var a;if(!n)return!1;n.nodeType===3&&(n=n.parentElement);let i=n,s=!1;for(;i&&!s&&(t?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)(a=i.classList)!=null&&a.contains(e)?s=!0:i=i.parentElement;return s&&i},se=n=>{let e=n;for(;e;){if(e.previousElementSibling&&e.previousElementSibling.getAttribute("data-node-id"))return e.previousElementSibling;const t=M(e.parentElement);if(t)e=t;else return!1}},Ee=n=>{let e;return Array.from(n.querySelectorAll("[data-node-id]")).reverse().find(t=>{if(!S(t.parentElement,"data-type","NodeBlockQueryEmbed"))return e=t,!0}),e||n},$e=n=>{let e;return Array.from(n.querySelectorAll("[data-node-id]")).find(t=>{if(!S(t.parentElement,"data-type","NodeBlockQueryEmbed")&&!t.classList.contains("li")&&!t.classList.contains("sb"))return e=t,!0}),e||n},Xe=n=>{let e=n;for(;e;){if(e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr"))return e.nextElementSibling;const t=M(e.parentElement);if(t)e=t;else return!1}return!1},bt=n=>{let e=n;for(;e;)if(e.classList.contains("list")||e.classList.contains("li")||e.classList.contains("bq")||e.classList.contains("sb"))e=e.querySelector("[data-node-id]");else return e;return!1},J=n=>!n||n.getAttribute("contenteditable")==="true"&&!n.classList.contains("protyle-wysiwyg")?n:n.querySelector('[contenteditable="true"]'),Me=n=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(n.getAttribute("data-type"))||n.getAttribute("data-type")==="NodeCodeBlock"&&n.classList.contains("render-node"),st=n=>{var e,t;let a=n;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let i=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(s=>{if(s.textContent.replace(p.Constants.ZWSP,"").replace(`
`,"")!=="")return i=!0,!0}),i||(e=a.previousElementSibling)!=null&&e.getAttribute("data-node-id")||(t=a.nextElementSibling)!=null&&t.getAttribute("data-node-id"))break;a=a.parentElement}return a},Oe=n=>{if(n.parentElement.getAttribute("data-type")==="NodeBlockquote"&&n.parentElement.childElementCount===2)for(;!n.parentElement.classList.contains("protyle-wysiwyg");)if(n.parentElement.getAttribute("data-type")==="NodeBlockquote"&&n.parentElement.childElementCount===2)n=n.parentElement;else{n=Oe(n);break}else if(n.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&n.parentElement.childElementCount===2)for(;!n.parentElement.classList.contains("protyle-wysiwyg");)if(n.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&n.parentElement.childElementCount===2)n=n.parentElement;else{n=Oe(n);break}else if(n.parentElement.getAttribute("data-type")==="NodeListItem"&&n.parentElement.childElementCount===3)for(;!n.parentElement.classList.contains("protyle-wysiwyg");)if(n.parentElement.getAttribute("data-type")==="NodeListItem"&&n.parentElement.childElementCount===3)n=n.parentElement;else if(n.parentElement.getAttribute("data-type")==="NodeList"&&n.parentElement.childElementCount===2)n=n.parentElement;else{n=Oe(n);break}else if(n.parentElement.getAttribute("data-type")==="NodeList"&&n.parentElement.childElementCount===2)for(;!n.parentElement.classList.contains("protyle-wysiwyg");)if(n.parentElement.getAttribute("data-type")==="NodeList"&&n.parentElement.childElementCount===2)n=n.parentElement;else if(n.parentElement.getAttribute("data-type")==="NodeListItem"&&n.parentElement.childElementCount===3)n=n.parentElement;else{n=Oe(n);break}return n},rt=n=>{let e=n.nextSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.nextSibling;else return e;return!1},ot=n=>{let e=n.previousSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.previousSibling;else return e;return!1},Aa=n=>{let e=n.nextElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.firstElementChild:!1;for(e=n.parentElement;e.tagName==="UL";)if(!e.nextElementSibling)e=e.parentElement;else{if(e.nextElementSibling.tagName==="LI")return e.nextElementSibling;if(e.nextElementSibling.tagName==="UL")return e.nextElementSibling.firstElementChild}return!1},aa=n=>{let e=n.previousElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.lastElementChild:!1;for(e=n.parentElement;e.tagName==="UL";)if(!e.previousElementSibling)e=e.parentElement;else{if(e.previousElementSibling.tagName==="LI")return e.previousElementSibling;if(e.previousElementSibling.tagName==="UL"){const t=e.previousElementSibling.querySelectorAll(".b3-list-item");return t[t.length-1]}}return!1},W=()=>{const n=document.getElementById("message");n.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button--cancel b3-button b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.clearMessage}"><svg style="margin-right: 0"><use xlink:href="#iconSelect"></use></svg></button>`,n.addEventListener("click",e=>{let t=e.target;for(;t&&!t.isEqualNode(n);){if(t.classList.contains("b3-snackbar__close")){j(t.parentElement.getAttribute("data-id")),e.preventDefault();break}else if(t.isSameNode(n.lastElementChild)){t.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{t.parentElement.firstElementChild.innerHTML=""},p.Constants.TIMEOUT_INPUT),e.preventDefault();break}else{if(t.tagName==="A"||t.tagName==="BUTTON")break;if(t.classList.contains("b3-snackbar")){j(t.getAttribute("data-id")),e.preventDefault(),e.stopPropagation();break}}t=t.parentElement}})},q=(n,e=6e3,t="info",a)=>{const i=document.getElementById("message").firstElementChild;if(!i){alert(n);return}const s=a||ke(),o=i.querySelector(`.b3-snackbar[data-id="${s}"]`),l=n+(t==="error"?" v"+p.Constants.SIYUAN_VERSION:"");if(o){if(window.clearTimeout(parseInt(o.getAttribute("data-timeoutid"))),o.innerHTML=`<div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${l}</div>${e===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,t==="error"?o.classList.add("b3-snackbar--error"):o.classList.remove("b3-snackbar--error"),e>0){const c=window.setTimeout(()=>{j(s)},e);o.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${t==="error"?" b3-snackbar--error":""}"><div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${l}</div>`;if(e===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(e!==-1){const c=window.setTimeout(()=>{j(s)},e);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},j=n=>{const e=document.getElementById("message").firstElementChild;if(e)if(n){const t=e.querySelector(`[data-id="${n}"]`);t&&(t.classList.add("b3-snackbar--hide"),setTimeout(()=>{t.remove(),e.childElementCount===0&&j()},p.Constants.TIMEOUT_INPUT));let a=!1;Array.from(e.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?e.parentElement.classList.add("b3-snackbars--show"):e.parentElement.classList.remove("b3-snackbars--show")}else e.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{e.innerHTML=""},p.Constants.TIMEOUT_INPUT)},Je=n=>{var e;if(n.cmd==="msg")return q(n.msg,n.data.closeTimeout,n.code===0?"info":"error",n.data.id),!1;if(n.cmd==="cmsg")return j(n.data.id),!1;if(n.cmd==="cprogress"){const t=document.getElementById("progress");return t&&t.remove(),!1}return n.cmd==="reloadui"?(Tt({reload:!0,onlyData:!1,errorExit:!1,dropEditScroll:(e=n.data)==null?void 0:e.resetScroll}),!1):n.code<0?(q(n.msg,n.data&&n.data.closeTimeout||0,n.code===-1?"error":"info"),!1):n},me=(n,e)=>{n.addEventListener("mousedown",t=>{if($(t.target,"protyle-util")&&!n.classList.contains("protyle-util"))return;let a=$(t.target,"resize__move"),i,s;const o=n.getBoundingClientRect();if(a?(i=t.clientX-o.left,s=t.clientY-o.top):(i=t.clientX,s=t.clientY,a=$(t.target,"resize__rd")||$(t.target,"resize__r")||$(t.target,"resize__rt")||$(t.target,"resize__d")||$(t.target,"resize__l")||$(t.target,"resize__ld")||$(t.target,"resize__lt")||$(t.target,"resize__t")),!a)return;const l=n.clientHeight,r=n.clientWidth,c=a.className.split("resize__")[1].split(" ")[0],u=document;n.style.userSelect="none",n.classList.contains("b3-dialog__container")&&n.parentElement.style.display!=="block"&&(n.parentElement.style.display="block",n.style.left=o.left+"px",n.style.top=o.top+"px",n.style.width=o.width+"px"),u.ondragstart=()=>!1,u.onmousemove=d=>{if(n)if(c==="move"){let f=d.clientX-i,g=d.clientY-s;f>window.innerWidth-r&&(f=window.innerWidth-r),g>window.innerHeight-l&&(g=window.innerHeight-l),n.style.left=Math.max(f,0)+"px",n.style.top=Math.max(g,p.Constants.SIZE_TOOLBAR_HEIGHT)+"px"}else c==="r"&&d.clientX-i+r>200&&d.clientX-i+r<window.innerWidth?n.style.width=d.clientX-i+r+"px":c==="d"&&d.clientY-s+l>160&&d.clientY-s+l<window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT?(n.style.height=d.clientY-s+l+"px",n.style.maxHeight=""):c==="t"&&d.clientY>p.Constants.SIZE_TOOLBAR_HEIGHT&&s-d.clientY+l>160?(n.style.top=d.clientY+"px",n.style.maxHeight="",n.style.height=s-d.clientY+l+"px"):c==="l"&&d.clientX>0&&i-d.clientX+r>200?(n.style.left=d.clientX+"px",n.style.width=i-d.clientX+r+"px"):c==="rd"&&d.clientX-i+r>200&&d.clientX-i+r<window.innerWidth&&d.clientY-s+l>160&&d.clientY-s+l<window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT?(n.style.height=d.clientY-s+l+"px",n.style.maxHeight="",n.style.width=d.clientX-i+r+"px"):c==="rt"&&d.clientX-i+r>200&&d.clientX-i+r<window.innerWidth&&d.clientY>p.Constants.SIZE_TOOLBAR_HEIGHT&&s-d.clientY+l>160?(n.style.width=d.clientX-i+r+"px",n.style.top=d.clientY+"px",n.style.maxHeight="",n.style.height=s-d.clientY+l+"px"):c==="lt"&&d.clientX>0&&i-d.clientX+r>200&&d.clientY>p.Constants.SIZE_TOOLBAR_HEIGHT&&s-d.clientY+l>160?(n.style.left=d.clientX+"px",n.style.width=i-d.clientX+r+"px",n.style.top=d.clientY+"px",n.style.maxHeight="",n.style.height=s-d.clientY+l+"px"):c==="ld"&&d.clientX>0&&i-d.clientX+r>200&&d.clientY-s+l>160&&d.clientY-s+l<window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT&&(n.style.left=d.clientX+"px",n.style.width=i-d.clientX+r+"px",n.style.height=d.clientY-s+l+"px",n.style.maxHeight="")},u.onmouseup=()=>{n&&(window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0),n.style.userSelect="auto",u.onmousemove=null,u.onmouseup=null,u.ondragstart=null,u.onselectstart=null,u.onselect=null,e&&e(c))}})};var T=Ae(314),re=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const z=n=>{n&&(window.siyuan.config.system.container==="ios"?window.location.href=n:Mt()?window.JSAndroid.openExternal(n):window.open(n))},R=()=>Mt()?window.JSAndroid.readClipboard():navigator.clipboard.readText(),O=n=>{let e;getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0).cloneRange());try{if(Mt()){window.JSAndroid.writeClipboard(n);return}if(Rt()){window.webkit.messageHandlers.setClipboard.postMessage(n);return}navigator.clipboard.writeText(n)}catch(t){if(Rt())window.webkit.messageHandlers.setClipboard.postMessage(n);else if(Mt())window.JSAndroid.writeClipboard(n);else{const a=document.createElement("textarea");a.value=n,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),e&&ee(e)}}},Y=n=>re(void 0,null,function*(){n=n.replace(new RegExp(p.Constants.ZWSP,"g"),""),yield O(n)}),nt=()=>Pt()?"touchstart":"click",ye=n=>Ot()?!!(n.metaKey&&!n.ctrlKey):!!(!n.metaKey&&n.ctrlKey),wt=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,Pt=()=>navigator.userAgent.indexOf("iPhone")>-1,_n=()=>navigator.userAgent.indexOf("iPad")>-1,Ot=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,Mt=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Rt=()=>{var n;return window.siyuan.config.system.container==="ios"&&((n=window.webkit)==null?void 0:n.messageHandlers)},ae=n=>{if(/Mac/.test(navigator.platform)||navigator.platform==="iPhone")return n;const e=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),t=[];n.indexOf("\u2318")>-1&&t.push(e.get("\u2318")),n.indexOf("\u21E7")>-1&&t.push(e.get("\u21E7")),n.indexOf("\u2325")>-1&&t.push(e.get("\u2325"));const a=n.replace(/⌘|⇧|⌥/g,"");return a&&t.push(e.get(a)||a),t.join("+")},Wt=n=>{_("/api/storage/getLocalStorage",void 0,e=>{window.siyuan.storage=e.data;const t={};t[p.Constants.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},p.Constants.SIYUAN_ASSETS_SEARCH.forEach(a=>{t[p.Constants.LOCAL_SEARCHASSET].types[a]=!0}),t[p.Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},t[p.Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},t[p.Constants.LOCAL_LAYOUTS]=[],t[p.Constants.LOCAL_AI]=[],t[p.Constants.LOCAL_PLUGINTOPUNPIN]=[],t[p.Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},t[p.Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},t[p.Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1},t[p.Constants.LOCAL_EXPORTIMG]={keepFold:!1},t[p.Constants.LOCAL_DOCINFO]={id:""},t[p.Constants.LOCAL_FONTSTYLES]=[],t[p.Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock}},t[p.Constants.LOCAL_ZOOM]=1,[p.Constants.LOCAL_EXPORTIMG,p.Constants.LOCAL_SEARCHKEYS,p.Constants.LOCAL_PDFTHEME,p.Constants.LOCAL_BAZAAR,p.Constants.LOCAL_EXPORTWORD,p.Constants.LOCAL_EXPORTPDF,p.Constants.LOCAL_DOCINFO,p.Constants.LOCAL_FONTSTYLES,p.Constants.LOCAL_SEARCHDATA,p.Constants.LOCAL_ZOOM,p.Constants.LOCAL_LAYOUTS,p.Constants.LOCAL_AI,p.Constants.LOCAL_PLUGINTOPUNPIN,p.Constants.LOCAL_SEARCHASSET].forEach(a=>{if(typeof e.data[a]=="string")try{const i=JSON.parse(e.data[a]);typeof i=="number"?window.siyuan.storage[a]=i:window.siyuan.storage[a]=Object.assign(t[a],i)}catch(i){window.siyuan.storage[a]=t[a]}else typeof e.data[a]=="undefined"&&(window.siyuan.storage[a]=t[a])}),n(),_("/api/storage/removeLocalStorageVals",{app:p.Constants.SIYUAN_APPID,keys:["leftColumn","local-searchkey","local-searchedata","local-searchekeys","local-searchetabdata","rightColumn","topBar"]})})},Ue=(n,e)=>{_("/api/storage/setLocalStorageVal",{app:p.Constants.SIYUAN_APPID,key:n,val:e})};class Le{constructor(e){this.disableClose=e.disableClose,this.id=ke(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div"),this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};">
<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container" style="width:${e.width||"auto"};height:${e.height||"auto"}">
  <svg ${(0,T.tq)()&&e.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||e.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>
  <div class="b3-dialog__body">${e.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",t=>{this.disableClose||this.destroy(),t.preventDefault(),t.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",t=>{this.destroy(),t.preventDefault(),t.stopPropagation()}),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")}),me(this.element.querySelector(".b3-dialog__container"),e.resizeCallback)}destroy(e){this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(e),window.siyuan.dialogs.find((t,a)=>{if(t.id===this.id)return window.siyuan.dialogs.splice(a,1),!0})}bindInput(e,t){e.focus(),e.addEventListener("keydown",a=>{if(a.isComposing){a.preventDefault();return}const i=document.querySelector("#confirmDialogConfirmBtn");if(a.key==="Escape"){i?i.previousElementSibling.previousElementSibling.dispatchEvent(new CustomEvent("click")):this.destroy(),a.preventDefault(),a.stopPropagation();return}!a.shiftKey&&!ye(a)&&a.key==="Enter"&&t&&(i?i.dispatchEvent(new CustomEvent("click")):t(),a.preventDefault(),a.stopPropagation())})}}const Ne=(n,e,t,a)=>{const i=new Le({title:n,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{a&&a(i),i.destroy()}),s[1].addEventListener("click",()=>{t&&t(i),i.destroy()})},De=n=>n.replace(/&/g,"&amp;").replace(/</g,"&lt;"),cl=n=>n.replace(/</g,"&lt;"),ia=n=>n.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),Bi=n=>n.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;"),Wu=n=>{const e=new Le({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${n}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{e.destroy()});const a=e.element.querySelector("input");e.bindInput(a,()=>{t[1].click()}),a.focus(),a.select(),t[1].addEventListener("click",()=>{_("/api/tag/renameTag",{oldLabel:n,newLabel:a.value})})},Yu=()=>window.siyuan.config.system.workspaceDir.replace(/^.*[\\\/]/,""),Gu=()=>{},Fb=()=>{const n=new Le({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),e=n.element.querySelector("input"),t=n.element.querySelectorAll(".b3-button");n.bindInput(e,()=>{t[1].click()}),e.select(),t[0].addEventListener("click",()=>{n.destroy()}),t[1].addEventListener("click",()=>{_("/api/system/setAccessAuthCode",{accessAuthCode:e.value})})},qt=n=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${n}`,mc=(n=window.siyuan.languages.needLogin)=>window.siyuan.user?!1:(n&&q(n),!0),sa=(n=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(n&&(n===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?q(window.siyuan.languages._kernel[122]):(n===window.siyuan.languages._kernel[29]&&(n=window.siyuan.languages._kernel[29].replace("${url}",qt("subscribe/siyuan"))),q(n))),!0),Ub=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1);var bc=Ae(5);const dl=(n,e,t=!1)=>{if((0,T.tq)())return;const a=e.getBoundingClientRect();if(a.height===0||!n){Mn();return}let i=document.getElementById("tooltip");i?i.innerHTML=n:(document.body.insertAdjacentHTML("beforeend",`<div class="tooltip" id="tooltip">${n}</div>`),i=document.getElementById("tooltip")),t?i.classList.add("tooltip--error"):i.classList.remove("tooltip--error"),e.getAttribute("data-inline-memo-content")?i.classList.add("tooltip--memo"):i.classList.remove("tooltip--memo");let s=a.left,o=a.bottom;const l=e.getAttribute("data-position"),r=e.parentElement.getBoundingClientRect();l==="right"?s=a.right-i.clientWidth:l==="parentE"&&(o=r.top,s=r.right+8);const c=l==="parentE"?o:a.top,u=window.innerHeight-o;i.style.maxHeight=Math.max(c,u)+"px",o+i.clientHeight>window.innerHeight&&c>u?i.style.top=(l==="parentE"?r.bottom:a.top)-i.clientHeight+"px":i.style.top=o+"px",s+i.clientWidth>window.innerWidth?l==="parentE"?i.style.left=r.left-8-i.clientWidth+"px":i.style.left=window.innerWidth-i.clientWidth+"px":i.style.left=Math.max(0,s)+"px"},Mn=()=>{const n=document.getElementById("tooltip");n&&n.remove()};class ht{constructor(e){if(this.id=ke(),this.callback=e.callback,e.title||e.icon){this.title=e.title,this.icon=e.icon,this.docIcon=e.docIcon,this.headElement=document.createElement("li"),this.headElement.setAttribute("data-type","tab-header"),this.headElement.setAttribute("draggable","true"),this.headElement.setAttribute("data-id",this.id),this.headElement.classList.add("item","item--focus");let t="";e.icon?t=`<svg class="item__graphic"><use xlink:href="#${e.icon}"></use></svg>`:e.docIcon&&(t=`<span class="item__icon">${fe(e.docIcon)}</span>`),this.headElement.innerHTML=`${t}<span class="item__text">${De(e.title)}</span>
<span class="item__close"><svg><use xlink:href="#iconClose"></use></svg></span>`,this.headElement.addEventListener("mouseenter",a=>{var i,s,o;a.stopPropagation(),a.preventDefault();let l="";if(this.model instanceof gt&&((o=(s=(i=this.model.editor)==null?void 0:i.protyle)==null?void 0:s.block)!=null&&o.rootID))l=this.model.editor.protyle.block.rootID;else if(!this.model){const r=JSON.parse(this.headElement.getAttribute("data-initdata")||"{}");r&&r.instance==="Editor"&&(l=r.blockId)}l&&_("/api/filetree/getFullHPathByID",{id:l},r=>{this.headElement.getAttribute("aria-label")||dl(cl(r.data),this.headElement),this.headElement.setAttribute("aria-label",cl(r.data))})}),this.headElement.addEventListener("dragstart",a=>{if((0,T.b1)()){a.stopPropagation(),a.preventDefault();return}window.getSelection().removeAllRanges();const i=qe(a.target,"LI");if(i){a.dataTransfer.setData("text/html",i.outerHTML);const s={id:this.id};us(this,s),a.dataTransfer.setData(p.Constants.SIYUAN_DROP_TAB,JSON.stringify(s)),a.dataTransfer.dropEffect="move",i.style.opacity="0.1",window.siyuan.dragElement=this.headElement}}),this.headElement.addEventListener("dragend",a=>{const i=qe(a.target,"LI");i&&(i.style.opacity="1",document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(s=>{s.remove()})),window.siyuan.dragElement=void 0,a.dataTransfer.dropEffect==="none"&&this.parent.children.forEach((s,o)=>{const l=this.headElement.parentElement.children[o];s.headElement.isSameNode(l)||(o===0?this.headElement.parentElement.firstElementChild.before(s.headElement):this.headElement.parentElement.children[o-1].after(s.headElement))})})}this.panelElement=document.createElement("div"),this.panelElement.classList.add("fn__flex-1"),this.panelElement.innerHTML=e.panel||"",this.panelElement.setAttribute("data-id",this.id)}updateTitle(e){this.title=e,this.headElement.querySelector(".item__text").innerHTML=De(e)}addModel(e){this.model=e,e.parent=this}pin(){if(!(!this.headElement.previousElementSibling||this.headElement.previousElementSibling&&this.headElement.previousElementSibling.classList.contains("item--pin"))){let e,t=0,a;this.parent.children.find((i,s)=>{if(i.headElement.classList.contains("item--pin")&&(t=s+1,a=i.headElement),i.id===this.id)return e=this.parent.children.splice(s,1)[0],!0}),a?a.after(e.headElement):this.parent.children[0].headElement.before(e.headElement),this.parent.children.splice(t,0,e)}this.headElement.classList.add("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.add("fn__none")}setDocIcon(e){if(this.docIcon=e,this.docIcon){const t=this.headElement.querySelector(".item__icon");t?t.innerHTML=fe(e):this.headElement.querySelector(".item__text").insertAdjacentHTML("beforebegin",`<span class="item__icon">${fe(e)}</span>`),this.headElement.classList.contains("item--pin")&&this.headElement.querySelector(".item__text").classList.add("fn__none")}else this.headElement.querySelector(".item__icon").remove(),this.headElement.querySelector(".item__text").classList.remove("fn__none")}unpin(){if(!(!this.headElement.nextElementSibling||this.headElement.nextElementSibling&&!this.headElement.nextElementSibling.classList.contains("item--pin"))){let e,t=0,a;for(let i=0;i<this.parent.children.length;i++)this.parent.children[i].id===this.id&&(e=this.parent.children.splice(i,1)[0],i--),i>-1&&this.parent.children[i].headElement.classList.contains("item--pin")&&(t=i+1,a=this.parent.children[i].headElement);a.after(e.headElement),this.parent.children.splice(t,0,e)}this.headElement.classList.remove("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.remove("fn__none")}close(){this.parent.removeTab(this.id)}}class sn{constructor(e){this.app=e.app,e.msgCallback&&this.connect(e)}connect(e){const t=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${t}?app=${p.Constants.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);a.onopen=()=>{e.callback&&e.callback.call(this),document.getElementById("errorLog")&&(Gh(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},a.onmessage=i=>{if(e.msgCallback){const s=Je(JSON.parse(i.data));e.msgCallback.call(this,s)}},a.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})},3e3))},a.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&Kh()},this.ws=a}send(e,t,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:t})))}}var vt=Ae(706);const Ve=(n,e,t,a=0,i=0)=>{n.style.top=t+"px",n.style.left=e+"px";const s=n.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<p.Constants.SIZE_TOOLBAR_HEIGHT){const o=t-s.height-a;o>p.Constants.SIZE_TOOLBAR_HEIGHT&&o+s.height<window.innerHeight?n.style.top=o+"px":o<=p.Constants.SIZE_TOOLBAR_HEIGHT?n.style.top=p.Constants.SIZE_TOOLBAR_HEIGHT+"px":n.style.top=Math.max(p.Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?n.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(n.style.left="0")},ne=(n,e,t=!1)=>{if(!e){if(n.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(n.includes("hint")&&(clearTimeout(e.hint.timeId),e.hint.element.classList.add("fn__none")),e.gutter&&n.includes("gutter")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML="",e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),e.toolbar&&n.includes("toolbar")&&(e.toolbar.element.classList.add("fn__none"),e.toolbar.element.style.display=""),e.toolbar&&n.includes("util")){const a=e.toolbar.subElement.querySelector('[data-type="pin"]');(t||!a||a&&!a.classList.contains("block__icon--active"))&&(e.toolbar.subElement.classList.add("fn__none"),e.toolbar.subElementCloseCB&&(e.toolbar.subElementCloseCB(),e.toolbar.subElementCloseCB=void 0))}n.includes("select")&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},Oi=n=>{n.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(e=>{e.classList.add("fn__none"),e.style.display=""}),n.includes("util")&&zh().forEach(e=>{e.protyle.toolbar&&(e.protyle.toolbar.subElement.classList.add("fn__none"),e.protyle.toolbar.subElementCloseCB&&(e.protyle.toolbar.subElementCloseCB(),e.protyle.toolbar.subElementCloseCB=void 0))}),n.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(e=>{e.classList.add("fn__none")}),n.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(e=>{e.classList.add("fn__none"),e.innerHTML=""})},wc=n=>{n.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){n.classList.remove("protyle-wysiwyg--hl")},1024)},yc=(n,e,t=!1)=>{let a;const i=n.wysiwyg.element;if(!n.preview.element.classList.contains("fn__none")){a=document.getElementById(e),a&&(n.preview.element.scrollTop=a.offsetTop,wc(a));return}if(Array.from(i.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!S(s,"data-type","block-render",!0))return a=s,!0}),a)return Ge(n,a,t),wc(a),a;if(e===n.block.rootID&&n.options.render.title)return wc(n.title.editElement),n.title.editElement},Ge=(n,e,t=!1,a="auto")=>{if(!t&&getSelection().rangeCount>0&&M(getSelection().getRangeAt(0).startContainer)){const r=n.contentElement,c=Cn(r).top-r.getBoundingClientRect().top;let u=0;c<0?u=r.scrollTop+c:c>r.clientHeight-74&&(u=r.scrollTop+(c+74-r.clientHeight)),u!==0&&r.scroll({top:u,behavior:a});return}if(e||(e=M(he(n.wysiwyg.element).startContainer)),!e)return;let i=0,s=e;for(;!s.classList.contains("protyle-wysiwyg");)i+=s.offsetTop,s=s.parentElement;let o=0,l=n.element.firstElementChild;for(;l&&!l.classList.contains("protyle-content");)o+=l.clientHeight,l=l.nextElementSibling;if(t){n.contentElement.scroll({top:i-o,behavior:a});return}n.contentElement.scrollTop>i-32?n.contentElement.scroll({top:i-o,behavior:a}):n.contentElement.scrollTop+n.contentElement.clientHeight<i+e.clientHeight-o&&n.contentElement.scroll({top:i+e.clientHeight-o-n.contentElement.clientHeight,behavior:a})},oa=(n,e="outerHTML")=>{if(!n.querySelector("[data-type='block-render']"))return n[e];const t=n.cloneNode(!0);return t.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),t[e]},Vb=n=>{const e=document.createElement("template");return e.innerHTML=n,e.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(t=>{$(t,"protyle-wysiwyg__embed")||t.setAttribute("contenteditable","true")}),e.innerHTML},ul=(n,e)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(n)?(e?dl(window.siyuan.languages.fileNameRule,e,!0):q(window.siyuan.languages.fileNameRule),!1):n.length>p.Constants.SIZE_TITLE?(e?dl(window.siyuan.languages._kernel[106],e,!0):q(window.siyuan.languages._kernel[106]),!1):!0,on=n=>n.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,p.Constants.SIZE_TITLE),jE=n=>n.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),_c=n=>{if(window.siyuan.config.readonly)return;const e=new Le({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px",destroyCallback(){n.range&&ee(n.range)}}),t=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(t,()=>{a[1].click()}),t.value=Lute.UnEscapeHTMLStr(n.name),t.focus(),t.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(!ul(t.value))return!1;if(t.value===n.name)return e.destroy(),!1;t.value.trim()===""?t.value="Untitled":t.value=on(t.value),n.type==="notebook"?_("/api/notebook/renameNotebook",{notebook:n.notebookId,name:t.value},()=>{cv(n.notebookId,t.value)}):_("/api/filetree/renameDoc",{notebook:n.notebookId,path:n.path,title:t.value}),e.destroy()})},vc=n=>{const e=new Le({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),t=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(t,()=>{a[1].click()});const i=Yh(n);t.value=i,t.focus(),t.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(t.value===i||!t.value)return e.destroy(),!1;_("/api/asset/renameAsset",{oldPath:n,newName:t.value})})},zb=n=>{if(getSelection().rangeCount===0)return;const e=getSelection().getRangeAt(0),t=M(e.startContainer);if(!t)return;let a=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[t]);let i="",s=e.toString();if(s===""){if(s=a[0].textContent,a.forEach(o=>{i+=oa(o)}),!s)return}else{const o=document.createElement("div");o.appendChild(e.cloneContents()),i=o.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=on(s),_("/api/filetree/createDoc",{notebook:n.notebookId,path:xe().join(pt(n.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:n.lute.BlockDOM2StdMd(i)})},Wb=n=>{let e="",t="";if(Ye().editor.find(a=>{const i=a.parent.headElement;if(i.classList.contains("item--focus")&&(e=a.editor.protyle.notebookId,n?t=a.editor.protyle.path:t=xe().dirname(a.editor.protyle.path),$(i,"layout__wnd--active")))return!0}),!e){const a=At("file").data.file;if(a instanceof ha){const i=a.element.querySelector(".b3-list-item--focus");if(i){const s=ve(i,"UL");s&&(e=s.getAttribute("data-url"));const o=i.getAttribute("data-path");n?t=o:t=xe().dirname(o)}}}return e||window.siyuan.notebooks.find(a=>{if(!a.closed)return e=a.id,t="/",!0}),{notebookId:e,currentPath:t}},Xa=n=>{if(Wd()===0){q(window.siyuan.languages.newFileTip);return}if(!n.notebookId){const e=Wb(n.useSavePath);n.notebookId=e.notebookId,n.currentPath=e.currentPath}_("/api/filetree/getDocCreateSavePath",{notebook:n.notebookId},e=>{if(e.data.path.indexOf("/")>-1&&n.useSavePath||n.name)e.data.path.startsWith("/")||n.currentPath==="/"?_("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:xe().join(e.data.path,n.name||""),markdown:""},t=>{be({app:n.app,id:t.data,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})}):_("/api/filetree/getHPathByPath",{notebook:n.notebookId,path:n.currentPath.endsWith(".sy")?n.currentPath:n.currentPath+".sy"},t=>{_("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:xe().join(t.data,e.data.path,n.name||""),parentID:pt(n.currentPath,!0,!0),markdown:""},a=>{be({app:n.app,id:a.data,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})})});else{let t=e.data.path||"Untitled";if(t=t.substring(t.lastIndexOf("/")+1),!ul(t))return;const a=Lute.NewNodeID(),i=xe().join(pt(n.currentPath,!1,!0),a+".sy");n.paths&&(n.paths[n.paths.indexOf(void 0)]=i),_("/api/filetree/createDoc",{notebook:n.notebookId,path:i,title:t,md:"",sorts:n.paths},()=>{be({app:n.app,id:a,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})})}})},Ec=(n,e,t)=>{_("/api/filetree/getRefCreateSavePath",{notebook:e},a=>{a.data.path?a.data.path.startsWith("/")?t(pt(a.data.path,!1,!0)):_("/api/filetree/getHPathByPath",{notebook:e,path:n},i=>{t(pt(xe().join(i.data,a.data.path),!1,!0))}):_("/api/filetree/getHPathByPath",{notebook:e,path:n},i=>{t(pt(i.data,!1,!0))})})},kc=(n,e)=>{ne(["dialog"]),Xa({app:n,useSavePath:!0,name:on(e.trim())||"Untitled"})};class Yb{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener((0,T.tq)()?"click":"mouseover",e=>{const t=e.target;if((0,T.tq)()&&($(t,"b3-menu__title")||typeof e.detail=="string"&&e.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):this.remove();return}const a=$(t,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const i=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(a)&&!s.isSameNode(a)&&!a.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),i&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(e){const t=e.parentElement.getBoundingClientRect();e.style.top=t.top-8+"px",e.style.left=t.right+8+"px",e.style.bottom="auto";const a=e.getBoundingClientRect();a.right>window.innerWidth&&(t.left-8>a.width?e.style.left=t.left-8-a.width+"px":e.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(e.style.top="auto",e.style.bottom="8px")}preventDefault(e){!$(e.target,"b3-menu")&&!$(e.target,"keyboard__bar")&&e.preventDefault()}addSeparator(e){this.addItem({type:"separator",index:e})}addItem(e){const t=new I(e);return this.append(t.element,e.index),t.element}removeScrollEvent(){window.removeEventListener((0,T.tq)()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),window.siyuan.menus.menu.element.removeAttribute("data-name")}append(e,t){if(e){if(typeof t=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[t];if(a){a.before(e);return}}this.element.lastElementChild.append(e)}}popup(e){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener((0,T.tq)()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),Ve(this.element,e.x-(e.isLeft?window.siyuan.menus.menu.element.clientWidth:0),e.y,e.h,e.w))}fullscreen(e="all"){this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{e==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0}}class I{constructor(e){if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),e.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener("click",t=>{if(this.element.getAttribute("disabled"))return;let a=e.click(this.element,t);a instanceof Promise&&(a=!1),t.preventDefault(),t.stopImmediatePropagation(),t.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),e.id&&this.element.setAttribute("data-id",e.id),e.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),e.element)this.element.append(e.element);else{let t=`<span class="b3-menu__label">${e.label}</span>`;typeof e.iconHTML=="string"?t=e.iconHTML+t:t=`<svg class="b3-menu__icon ${e.iconClass||""}" style="${e.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${t}`,e.accelerator&&(t+=`<span class="b3-menu__accelerator">${ae(e.accelerator)}</span>`),e.action&&(t+=`<svg class="b3-menu__action"><use xlink:href="#${e.action}"></use></svg>`),this.element.innerHTML=t}if(e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const t=document.createElement("div");t.classList.add("b3-menu__submenu"),t.innerHTML='<div class="b3-menu__items"></div>',e.submenu.forEach(a=>{t.firstElementChild.append(new I(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>'),this.element.append(t)}}}const Ja=(n,e)=>{let t=n;for(;t&&(t.classList.contains("b3-menu__separator")||t.classList.contains("b3-menu__item--readonly"));)e?t=t.nextElementSibling:t=t.previousElementSibling;return t},Gb=n=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||n.altKey||n.shiftKey||ye(n))return!1;const e=n.target;if(window.siyuan.menus.menu.element.contains(e)&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"))return!1;if(n.code==="ArrowDown"||n.code==="ArrowUp"){const t=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let a;if(t?(t.classList.remove("b3-menu__item--current","b3-menu__item--show"),n.code==="ArrowUp"?(a=Ja(t.previousElementSibling,!1),a||(a=Ja(t.parentElement.lastElementChild,!1))):(a=Ja(t.nextElementSibling,!0),a||(a=Ja(t.parentElement.firstElementChild,!0)))):n.code==="ArrowUp"?a=Ja(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):a=Ja(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),a){a.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--show");const i=a.parentElement.getBoundingClientRect(),s=a.getBoundingClientRect();(i.top>s.top||i.bottom<s.bottom)&&a.scrollIntoView(i.top>s.top)}return!0}else if(n.code==="ArrowRight"){const t=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!t)return!0;const a=t.querySelector(".b3-menu__submenu");if(!a)return!0;t.classList.remove("b3-menu__item--current"),t.classList.add("b3-menu__item--show");const i=Ja(a.firstElementChild.firstElementChild,!0);return i&&i.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(a),!0}else if(n.code==="ArrowLeft"){const t=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!t)return!0;const a=$(t,"b3-menu__item--show");return a&&(a.classList.remove("b3-menu__item--show"),a.classList.add("b3-menu__item--current"),t.classList.remove("b3-menu__item--current")),!0}else if(n.code==="Enter"){const t=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(t){const a=t.querySelector(".b3-text-field"),i=t.querySelector(".b3-switch");if(a)return a.focus(),!0;i?i.click():t.dispatchEvent(new CustomEvent(nt())),window.siyuan.menus.menu.remove()}else return!1;return!0}};class jb{constructor(){this.menus=[]}addSeparator(e){typeof e=="number"?this.menus.splice(e,0,{type:"separator"}):this.menus.push({type:"separator"})}addItem(e){typeof e.index=="number"?this.menus.splice(e.index,0,e):this.menus.push(e)}}var ue=Ae(680);const Qa=(n,e)=>{if(!document.getElementById(e)){const t=document.createElement("link");t.id=e,t.rel="stylesheet",t.type="text/css",t.href=n,document.getElementsByTagName("head")[0].appendChild(t)}},la=(n,e)=>{let t="";return n.forEach(a=>{typeof a=="string"?t+=`<option value="${a}" ${e===a?"selected":""}>${a}</option>`:t+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label}</option>`}),t},ju=()=>{_("/api/snippet/getSnippet",{type:"all",enabled:2},n=>{n.data.snippets.forEach(e=>{const t=`snippet${e.type==="css"?"CSS":"JS"}${e.id}`;let a=document.getElementById(t);if(!e.enabled){a&&a.remove();return}if(a){if(a.innerHTML===e.content)return;a.remove()}e.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${t}">${e.content}</style>`):e.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=e.content,a.id=t,document.head.appendChild(a))})})},Kb=()=>{_("/api/snippet/getSnippet",{type:"all",enabled:2},n=>{let e="",t="";n.data.snippets.forEach(s=>{s.type==="css"?e+=Sc(s):t+=Sc(s)});const a=new Le({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        ${e}
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="addCodeSnippetCSS">
                <svg><use xlink:href="#iconAdd"></use></svg> ${window.siyuan.languages.addAttr} CSS
            </button>
        </div>
    </div>
    <div class="fn__none">
        ${t}
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="addCodeSnippetJS">
                <svg><use xlink:href="#iconAdd"></use></svg> ${window.siyuan.languages.addAttr} JS
            </button>
        </div>
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});n.data.snippets.forEach(s=>{const o=a.element.querySelector(`[data-id="${s.id}"] input`);o.value=s.name;const l=a.element.querySelector(`[data-id="${s.id}"] textarea`);l.textContent=s.content});const i=[];a.element.addEventListener("click",s=>{const o=s.target;if(o.id==="addCodeSnippetCSS"||o.id==="addCodeSnippetJS"){o.parentElement.insertAdjacentHTML("beforebegin",Sc({type:o.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!1}));return}if(o.classList.contains("b3-button--cancel")){a.destroy();return}if(o.classList.contains("b3-button--text")){const c=[];a.element.querySelectorAll("[data-id]").forEach(u=>{c.push({id:u.getAttribute("data-id"),name:u.querySelector("input").value,type:u.getAttribute("data-type"),content:u.querySelector("textarea").value,enabled:u.querySelector(".b3-switch").checked})}),_("/api/snippet/setSnippet",{snippets:c},()=>{i.forEach(u=>{const d=document.querySelector(u);d&&d.remove()}),ju(),a.destroy()});return}const l=$(o,"item");if(l){l.getAttribute("data-type")==="css"?(l.classList.add("item--focus"),l.nextElementSibling.classList.remove("item--focus"),l.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),l.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(l.classList.add("item--focus"),l.previousElementSibling.classList.remove("item--focus"),l.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),l.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none"));return}const r=$(o,"b3-tooltips");if(r){const c=r.parentElement.parentElement;i.push("#snippet"+(c.getAttribute("data-type")==="css"?"CSS":"JS")+c.getAttribute("data-id")),c.nextElementSibling.remove(),c.remove()}})})},Sc=n=>`<div data-id="${n.id||""}" data-type="${n.type}">
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__flex-1 fn__space"></div>
        <input data-type="snippet" class="b3-switch fn__flex-center" type="checkbox"${n.enabled?" checked":""}>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
</div><div class="fn__hr--b"></div>`,ln=(n,e)=>{let t="";switch(n){case"NodeDocument":t="iconFile";break;case"NodeThematicBreak":t="iconLine";break;case"NodeParagraph":t="iconParagraph";break;case"NodeHeading":e?t="icon"+e.toUpperCase():t="iconHeadings";break;case"NodeBlockquote":t="iconQuote";break;case"NodeList":e==="t"?t="iconCheck":e==="o"?t="iconOrderedList":t="iconList";break;case"NodeListItem":t="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":t="iconCode";break;case"NodeTable":t="iconTable";break;case"NodeBlockQueryEmbed":t="iconSQL";break;case"NodeSuperBlock":t="iconSuper";break;case"NodeMathBlock":t="iconMath";break;case"NodeHTMLBlock":t="iconHTML5";break;case"NodeWidget":t="iconBoth";break;case"NodeIFrame":t="iconLanguage";break;case"NodeVideo":t="iconVideo";break;case"NodeAudio":t="iconRecord";break;case"NodeAttributeView":t="iconDatabase";break}return t},ra=(n,e=p.Constants.PROTYLE_CDN,t=!1)=>{let a=[];n.getAttribute("data-subtype")==="math"?a=[n]:a=Array.from(n.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(Qa(`${e}/js/katex/katex.min.css?v=0.16.0`,"protyleKatexStyle"),(0,vt.addScript)(`${e}/js/katex/katex.min.js?v=0.16.0`,"protyleKatexScript").then(()=>{(0,vt.addScript)(`${e}/js/katex/mhchem.min.js?v=0.16.0`,"protyleKatexMhchemScript").then(()=>{a.forEach(i=>{var s,o;if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let l=i;i.tagName==="DIV"&&(l=i.firstElementChild);let r={};try{r=JSON.parse(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}try{l.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:i.tagName==="DIV",output:"html",macros:r,trust:!0,strict:u=>u==="unicodeTextInMathMode"?"ignore":"warn"}),l.classList.remove("ft__error");const c=M(i);if(i.tagName==="DIV"){l.firstElementChild.setAttribute("contenteditable","false"),l.childElementCount<2&&l.insertAdjacentHTML("beforeend",`<span style="position: absolute">${p.Constants.ZWSP}</span>`);const u=l.querySelectorAll(".base");u.length>0&&u[u.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const d=l.querySelector(".katex-html > .newline");d&&(d.parentElement.style.display="block")}else{c&&i.getBoundingClientRect().width>c.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const u=rt(i);u?u&&u.nodeType!==3&&((s=u.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1?i.after(document.createTextNode(p.Constants.ZWSP)):u&&!u.textContent.startsWith(`
`)&&u.textContent!==p.Constants.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",p.Constants.ZWSP),(o=i.previousSibling)!=null&&o.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",p.Constants.ZWSP):!ot(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",p.Constants.ZWSP)}t&&setTimeout(()=>{if(i.tagName==="DIV"){const u=i.querySelector(".katex-display");u.clientWidth<u.scrollWidth&&u.firstElementChild.setAttribute("style",`font-size:${u.clientWidth*100/u.scrollWidth}%`)}else c&&i.offsetWidth>c.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/i.offsetWidth}%`)})}catch(c){l.innerHTML=c.message,l.classList.add("ft__error")}})})}))};class Bs{constructor(e){this.click=e.click,this.ctrlClick=e.ctrlClick,this.altClick=e.altClick,this.shiftClick=e.shiftClick,this.rightClick=e.rightClick,this.toggleClick=e.toggleClick,this.element=e.element,this.blockExtHTML=e.blockExtHTML,this.topExtHTML=e.topExtHTML,this.updateData(e.data),this.bindEvent()}updateData(e){this.data=e,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),ra(this.element))}genHTML(e){let t=`<ul${e[0].depth===0?" class='b3-list b3-list--background'":""}>`;return e.forEach(a=>{let i="",s='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(i=` aria-label="${Bi(a.hPath)}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${ln(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(i=` aria-label="${Bi(Lute.BlockDOM2Content(a.name))}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${ln(a.nodeType,a.subType)}"></use></svg>`);let o="";a.count&&(o=`<span class="counter">${a.count}</span>`);const l=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";(0,T.tq)()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${(a.depth-1)*18+22}px;margin-right: 2px`,t+=`<li class="b3-list-item${(0,T.tq)()?"":" b3-list-item--hide-action"}" 
${a.nodeType!=="NodeDocument"&&a.type==="backlink"?'draggable="true" ':""}
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${a.type==="backlink"||l?" b3-list-item__toggle--hl":""}${l||a.type==="backlink"?"":" fn__hidden"}">
        <svg data-id="${encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${l?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${s}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${i}>${a.name}</span>
    ${this.topExtHTML||""}
    ${o}
</li>`,a.children&&a.children.length>0&&(t+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(t+=this.genBlockHTML(a.blocks,!0,a.type)+"</ul>")}),t}genBlockHTML(e,t=!1,a){let i=`<ul class="${t?"":"fn__none"}">`;return e.forEach(s=>{let o="";s.count&&(o=`<span class="counter">${s.count}</span>`);let l;s.type==="NodeDocument"?l=`<span data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}">${fe(s.ial.icon||p.Constants.SIYUAN_IMAGE_FILE)}</span>`:l=`<svg data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}"><use xlink:href="#${ln(s.type,s.subType)}"></use></svg>`;let r="";(0,T.tq)()?s.depth>0&&(r=`padding-left: ${(s.depth-1)*20+24}px`):r=`padding-left: ${(s.depth-1)*18+22}px;margin-right: 2px`,i+=`<li ${a==="backlink"?'draggable="true"':""} 
class="b3-list-item${(0,T.tq)()?"":" b3-list-item--hide-action"}"  
data-node-id="${s.id}" 
data-ref-text="${encodeURIComponent(s.refText)}" 
data-def-id="${s.defID}" 
data-type="${s.type}" 
data-subtype="${s.subType}" 
data-treetype="${a}"
data-def-path="${s.defPath}">
    <span style="${r}" class="b3-list-item__toggle${s.children?" b3-list-item__toggle--hl":""}${s.children?"":" fn__hidden"}">
        <svg data-id="${s.id}" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${l}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+Bi(Lute.BlockDOM2Content(s.content))+'"':""}>${s.content}</span>
    ${o}
    ${this.blockExtHTML||""}
</li>`,s.children&&s.children.length>0&&(i+=this.genBlockHTML(s.children,!1,a)+"</ul>")}),i}toggleBlocks(e){if(this.toggleClick){this.toggleClick(e);return}if(!e.nextElementSibling)return;const t=e.firstElementChild.firstElementChild;t.classList.contains("b3-list-item__arrow--open")?(t.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling.classList.add("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.add("fn__none")):(t.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(e){e.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(t=>{t.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if(t.tagName==="LI"&&this.rightClick){this.rightClick(t,e),e.preventDefault(),e.stopPropagation();break}t=t.parentElement}}),this.element.addEventListener("click",e=>{let t=e.target;for(;t&&!t.isEqualNode(this.element);){if(t.classList.contains("b3-list-item__toggle")&&!t.classList.contains("fn__hidden")){this.toggleBlocks(t.parentElement),this.setCurrent(t.parentElement),e.preventDefault();break}if(t.classList.contains("b3-list-item__action")&&this.click){const a=te(t,"LI");a&&this.click(a,e),e.preventDefault(),e.stopPropagation();break}else if(t.tagName==="LI"){this.setCurrent(t),t.getAttribute("data-node-id")||t.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(t):this.altClick&&window.siyuan.altIsPressed?this.altClick(t):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(t):this.click&&this.click(t,e),e.stopPropagation()):this.toggleBlocks(t),e.preventDefault();break}t=t.parentElement}}),this.element.addEventListener("dragstart",e=>{const t=qe(e.target,"LI");t&&(e.dataTransfer.setData("text/html",t.outerHTML),t.style.opacity="0.1",window.siyuan.dragElement=t)}),this.element.addEventListener("dragend",e=>{const t=qe(e.target,"LI");t&&(t.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const e=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(t=>{e.push(t.getAttribute("data-id"))}),e}setExpandIds(e){this.element.querySelectorAll(".b3-list-item__arrow").forEach(t=>{e.includes(t.getAttribute("data-id"))?(t.classList.add("b3-list-item__arrow--open"),t.parentElement.parentElement.nextElementSibling&&t.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(t.classList.remove("b3-list-item__arrow--open"),t.parentElement.parentElement.nextElementSibling&&t.parentElement.parentElement.nextElementSibling.tagName==="UL"&&t.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}const Ta=()=>`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`,Ku=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="abc"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="abc"]')),t.length!==0&&t.length>0&&(0,vt.addScript)(`${e}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{t.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",Ta()),a.childElementCount<4&&a.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${p.Constants.ZWSP}</span>`);const i=a.firstElementChild.nextElementSibling;window.ABCJS.renderAbc(i,Lute.UnEscapeHTMLStr(a.getAttribute("data-content")),{responsive:"resize"}),i.setAttribute("contenteditable","false"),a.setAttribute("data-render","true")})})};var Zb=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Zu=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="echarts"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="echarts"]')),t.length!==0&&t.length>0&&(0,vt.addScript)(`${e}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{(0,vt.addScript)(`${e}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{let a;if(t[0].firstElementChild.clientWidth===0){const i=$(t[0],"layout-tab-container",!0);i&&Array.from(i.children).find(s=>{if(s.classList.contains("protyle")&&!s.classList.contains("fn__none"))return a=s.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}t.forEach(i=>Zb(void 0,null,function*(){if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Ta());const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height;const o=yield(0,T.Qf)(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption(o),i.setAttribute("data-render","true"),s.classList.remove("ft__error"),s.textContent.endsWith(p.Constants.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",p.Constants.ZWSP)}catch(o){window.echarts.dispose(s),s.classList.add("ft__error"),s.innerHTML=`echarts render error: <br>${o}`}}))})})},Xu=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="graphviz"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="graphviz"]')),t.length!==0&&(0,vt.addScript)(`${e}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then(()=>{t.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",Ta());const i=a.firstElementChild.nextElementSibling;try{const s=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),l=(window.URL||window.webkitURL).createObjectURL(s),r=new Worker(l);new Viz({worker:r}).renderSVGElement(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))).then(c=>{i.innerHTML=c.outerHTML,i.classList.remove("ft__error"),i.setAttribute("contenteditable","false"),a.textContent.endsWith(p.Constants.ZWSP)||a.insertAdjacentHTML("beforeend",`<span style="position: absolute">${p.Constants.ZWSP}</span>`)}).catch(c=>{i.innerHTML=`graphviz render error: <br>${c}`,i.classList.add("ft__error")})}catch(s){console.error("Graphviz error",s)}a.setAttribute("data-render","true")})})},Ju=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="mermaid"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="mermaid"]')),t.length!==0&&(0,vt.addScript)(`${e}/js/mermaid/mermaid.min.js?v=10.3.0`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),t[0].firstElementChild.clientWidth===0){const i=S(t[0],"fold","1");if(!i)return;const s=new MutationObserver(()=>{Qu(t),s.disconnect()});s.observe(i,{attributeFilter:["fold"]})}else Qu(t)})},Qu=n=>{n.forEach((e,t)=>{if(e.getAttribute("data-render")==="true")return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`);const a=e.firstElementChild.nextElementSibling;a.removeAttribute("data-processed"),a.textContent=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),setTimeout(()=>{window.mermaid.init(void 0,a)},p.Constants.TIMEOUT_LOAD*t),e.setAttribute("data-render","true"),a.setAttribute("contenteditable","false"),e.textContent.endsWith(p.Constants.ZWSP)||e.insertAdjacentHTML("beforeend",`<span style="position: absolute">${p.Constants.ZWSP}</span>`)})},ef=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="mindmap"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="mindmap"]')),t.length!==0&&(0,vt.addScript)(`${e}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{let a;if(t[0].firstElementChild.clientWidth===0){const i=$(t[0],"layout-tab-container",!0);i&&Array.from(i.children).find(s=>{if(s.classList.contains("protyle")&&!s.classList.contains("fn__none")&&s.querySelector(".protyle-wysiwyg").firstElementChild)return a=s.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}t.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",Ta());const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height,window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(o,l)=>{var r;return(r=l==null?void 0:l.data)!=null&&r.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),i.setAttribute("data-render","true"),s.textContent.endsWith(p.Constants.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",p.Constants.ZWSP),s.classList.remove("ft__error")}catch(o){s.classList.add("ft__error"),s.innerHTML=`Mindmap render error: <br>${o}`}})})},tf=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="flowchart"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="flowchart"]')),t.length!==0&&(0,vt.addScript)(`${e}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then(()=>{if(t[0].firstElementChild.clientWidth===0){const a=S(t[0],"fold","1");if(!a)return;const i=new MutationObserver(()=>{nf(t),i.disconnect()});i.observe(a,{attributeFilter:["fold"]})}else nf(t)})},nf=n=>{n.forEach(e=>{if(e.getAttribute("data-render")==="true")return;e.getAttribute("data-node-id")&&(e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",Ta()),e.childElementCount<4&&e.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${p.Constants.ZWSP}</span>`));const t=e.firstElementChild.nextElementSibling||e.firstElementChild,a=flowchart.parse(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")));t.innerHTML="";try{a.drawSVG(t)}catch(i){t.classList.add("ft__error"),t.innerHTML=`Flow Chart render error: <br>${i}`}t.setAttribute("contenteditable","false"),e.setAttribute("data-render","true")})},af=(n,e=p.Constants.PROTYLE_CDN)=>{let t=[];n.getAttribute("data-subtype")==="plantuml"?t=[n]:t=Array.from(n.querySelectorAll('[data-subtype="plantuml"]')),t.length!==0&&(0,vt.addScript)(`${e}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{t.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",Ta());const i=a.firstElementChild.nextElementSibling;try{i.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(a.getAttribute("data-content")))}">`,i.classList.remove("ft__error"),a.setAttribute("data-render","true")}catch(s){i.classList.add("ft__error"),i.innerHTML=`plantuml render error: <br>${s}`}})})},sf=n=>{let e=[];n.getAttribute("data-type")==="NodeHTMLBlock"?e=[n]:e=Array.from(n.querySelectorAll('[data-type="NodeHTMLBlock"]')),e.length!==0&&e.length>0&&e.forEach(t=>{t.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),t.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Xb=(n,e)=>{const t=document.createElement("div");t.innerHTML=n;let a=!1;if((t.childElementCount===1&&t.lastElementChild.style.fontFamily.indexOf("monospace")>-1||t.childElementCount===1&&t.querySelectorAll("pre").length===1||n.indexOf(`
<p class="p1">`)===0||t.childElementCount===1&&t.firstElementChild.tagName==="TABLE"&&t.querySelector(".line-number")&&t.querySelector(".line-content"))&&(a=!0),a){let i=e||n;return/\n/.test(i)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[p.Constants.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${i.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`:(i=i.replace("<","&lt;").replace(">","&gt;"),"`"+i+"`")}return!1},yt=n=>{const e=n.getAttribute("data-subtype");if(!["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"].includes(e)||n.getAttribute("data-type")!=="NodeHTMLBlock"){Ku(n),sf(n),af(n),Ju(n),tf(n),Zu(n),ef(n),Xu(n),ra(n);return}e==="abc"?Ku(n):e==="plantuml"?af(n):e==="mermaid"?Ju(n):e==="flowchart"?tf(n):e==="echarts"?Zu(n):e==="mindmap"?ef(n):e==="graphviz"?Xu(n):e==="math"?ra(n):n.getAttribute("data-type")==="NodeHTMLBlock"&&sf(n)};class Kt{constructor(e,t){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,e){const a=this.menu.element.getAttribute("data-name");a&&a===e&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(this.menu.element.setAttribute("data-name",e),this.menu.removeCB=t)}showSubMenu(e){this.menu.showSubMenu(e)}addItem(e){if(!this.isOpen)return this.menu.addItem(e)}addSeparator(e){this.isOpen||this.menu.addSeparator(e)}open(e){this.isOpen||this.menu.popup(e)}fullscreen(e="all"){this.isOpen||this.menu.fullscreen(e)}close(){this.menu.remove()}}const U=(n,e)=>{if(!n)return!1;if(n.indexOf("\u21E7")===-1&&n.indexOf("\u2318")===-1&&n.indexOf("\u2325")===-1&&n.indexOf("\u2303")===-1)return!e.ctrlKey&&!ye(e)&&!e.altKey&&!e.shiftKey&&n===p.Constants.KEYCODELIST[e.keyCode];const t=n.split("");if(n.indexOf("F")>-1&&t.forEach((i,s)=>{i==="F"&&(t[s]="F"+t.splice(s+1,1),t[s+1]&&(t[s+1]+=t.splice(s+1,1)))}),n.startsWith("\u21E7")&&t.length===2)return!!(!e.ctrlKey&&!ye(e)&&!e.altKey&&e.shiftKey&&t[1]===p.Constants.KEYCODELIST[e.keyCode]);if(n.startsWith("\u2325")){let i=t.length===3?t[2]:t[1];t.length===4&&(i=t[3]);const s=i===p.Constants.KEYCODELIST[e.keyCode];return!!(s&&e.altKey&&!e.shiftKey&&(t.length===3?ye(e)&&n.startsWith("\u2325\u2318"):!ye(e))||s&&n.startsWith("\u2325\u21E7\u2318")&&t.length===4&&e.altKey&&e.shiftKey&&ye(e)||s&&n.startsWith("\u2325\u21E7")&&t.length===3&&e.altKey&&e.shiftKey&&!ye(e))}if(n.startsWith("\u2303")){let i=t.length===3?t[2]:t[1];t.length===4&&(i=t[3]);const s=i===p.Constants.KEYCODELIST[e.keyCode];return!!(s&&t.length===2&&e.ctrlKey&&!e.altKey&&!e.shiftKey&&!e.metaKey||s&&n.startsWith("\u2303\u21E7")&&t.length===3&&e.ctrlKey&&!e.altKey&&e.shiftKey&&!e.metaKey||s&&n.startsWith("\u2303\u2325")&&t.length===3&&e.ctrlKey&&e.altKey&&!e.shiftKey&&!e.metaKey||s&&n.startsWith("\u2303\u2325\u21E7")&&t.length===4&&e.ctrlKey&&e.altKey&&e.shiftKey&&!e.metaKey)}const a=t.length>2&&t[0]==="\u21E7";return ye(e)&&!e.altKey&&(!a&&!e.shiftKey||a&&e.shiftKey)?(a?t[2]:t[1])===p.Constants.KEYCODELIST[e.keyCode]:!1},ct=(n,e)=>{if(n.getAttribute("data-subtype")!=="o")return;let t;Array.from(n.children).forEach((a,i)=>{i===0?e?(t=e,a.setAttribute("data-marker",t+"."),a.querySelector(".protyle-action--order").textContent=t+"."):t=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(t++,a.setAttribute("data-marker",t+"."),a.querySelector(".protyle-action--order").textContent=t+".")})},ei=(n,e=0,t=!1)=>{const a=document.createElement("template"),i=n.getAttribute("data-subtype");if(i==="o"){const s=parseInt(n.getAttribute("data-marker"))+e;a.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${pl(!1,t)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${pl(!1,t)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${pl(!1,t)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},of=(n,e,t)=>{const a=e[0].previousElementSibling;if(!a)return;t.collapse(!1),t.insertNode(document.createElement("wbr")),e.forEach(s=>{s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end")});const i=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=a.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");e.forEach((u,d)=>{o.push({action:"move",id:u.getAttribute("data-node-id"),previousID:c}),l.push({action:"move",id:u.getAttribute("data-node-id"),previousID:d===0?a.getAttribute("data-node-id"):c}),c=u.getAttribute("data-node-id"),u.setAttribute("data-subtype",r);const f=u.querySelector(".protyle-action");r==="o"?(f.classList.add("protyle-action--order"),f.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(u)):r==="t"?(u.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconUncheck"></use></svg>',f.classList.remove("protyle-action--order"),f.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(u)):(u.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',f.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(u))}),r==="o"?(ct(a.lastElementChild.previousElementSibling),ct(a.parentElement)):a.getAttribute("data-subtype")==="o"&&ct(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:s,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),G(n,o,l))}else{const s=a.outerHTML,o=e[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:l.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(l);const u=[];let d;e.forEach((f,g)=>{c.push({action:"move",id:f.getAttribute("data-node-id"),parentID:r,previousID:d}),u.push({action:"move",id:f.getAttribute("data-node-id"),previousID:g===0?a.getAttribute("data-node-id"):d}),d=f.getAttribute("data-node-id"),l.lastElementChild.before(f)}),u.push({action:"delete",id:r}),o==="o"&&(ct(l,1),ct(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),u.push({action:"update",data:s,id:a.getAttribute("data-node-id")}),G(n,c,u))}a.parentElement.classList.contains("protyle-wysiwyg")||ie(n,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,i),_e(a,t)},Jb=(n,e,t)=>{var a,i;const s=e.parentElement,o=s.getAttribute("data-node-id"),l=[],r=[];t.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let u="",d=0;Array.from(s.parentElement.children).forEach(g=>{!d&&g.isSameNode(s)?d=1:d&&!g.classList.contains("protyle-attr")&&(r.push({id:g.getAttribute("data-node-id"),action:"move",previousID:o}),l.push({id:g.getAttribute("data-node-id"),action:"delete"}),g.getAttribute("data-subtype")==="o"&&(r.push({id:g.getAttribute("data-node-id"),action:"update",data:g.outerHTML}),g.setAttribute("data-marker",d+"."),g.firstElementChild.innerHTML=d+"."),u+=g.outerHTML,g.remove(),d++)}),r.reverse(),u=`<div data-subtype="${s.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${ue().format("YYYYMMDDHHmmss")}">${u}<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`,s.parentElement.insertAdjacentHTML("afterend",u),l.push({id:c,action:"insert",previousID:s.parentElement.getAttribute("data-node-id"),data:u}),r.push({id:c,action:"delete"}),Array.from(s.children).reverse().forEach(g=>{!g.classList.contains("protyle-action")&&!g.classList.contains("protyle-attr")&&(l.push({id:g.getAttribute("data-node-id"),action:"move",previousID:s.parentElement.getAttribute("data-node-id")}),r.push({id:g.getAttribute("data-node-id"),action:"move",parentID:o}),s.parentElement.after(g))});const f=s.parentElement.getAttribute("data-node-id");s.parentElement.childElementCount===2?(r.splice(0,0,{id:f,action:"insert",data:s.parentElement.outerHTML,previousID:(a=s.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:s.parentElement.parentElement.getAttribute("data-node-id")||n.block.rootID}),s.parentElement.remove(),l.push({id:f,action:"delete"})):(r.splice(0,0,{id:o,action:"insert",data:s.outerHTML,previousID:(i=s.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:f}),s.remove(),l.push({id:o,action:"delete"})),G(n,l,r),_e(n.wysiwyg.element,t)},fl=(n,e,t)=>{var a,i,s,o,l,r,c,u;const d=e[0].parentElement,f=d.getAttribute("data-node-id");if(!f)return;const g=d.parentElement,h=g.parentElement;if((a=d.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&!h.getAttribute("data-node-id"))return;if(g.classList.contains("protyle-wysiwyg")||g.classList.contains("sb")||g.classList.contains("bq")){const v=[],A=[];t.collapse(!1),t.insertNode(document.createElement("wbr"));let C;!e[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(C=parseInt(e[0].getAttribute("data-marker")));let D=f,x=d,P=e[e.length-1].nextElementSibling,B=e[e.length-1].lastElementChild.previousElementSibling;if(e.forEach(X=>{X.classList.remove("protyle-wysiwyg--select"),X.removeAttribute("select-start"),X.removeAttribute("select-end"),Array.from(X.children).forEach((Q,ce)=>{const Pe=Q.getAttribute("data-node-id");Pe&&(v.push({action:"move",id:Pe,previousID:D,parentID:g.getAttribute("data-node-id")||n.block.parentID}),A.push({action:"move",id:Pe,previousID:ce===1?void 0:D,parentID:X.getAttribute("data-node-id"),data:Q.contains(t.startContainer)?"focus":""}),D=Pe,x.after(Q),x=Q)})}),!window.siyuan.config.editor.listLogicalOutdent&&!P.classList.contains("protyle-attr")){let X;B.getAttribute("data-subtype")!==P.getAttribute("data-subtype")&&(X=Lute.NewNodeID(),B=document.createElement("div"),B.classList.add("list"),B.setAttribute("data-subtype",P.getAttribute("data-subtype")),B.setAttribute("data-node-id",X),B.setAttribute("data-type","NodeList"),B.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),B.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,x.after(B),v.push({action:"insert",id:X,data:B.outerHTML,previousID:x.getAttribute("data-node-id")}));let Q;for(;P&&!P.classList.contains("protyle-attr");){v.push({action:"move",id:P.getAttribute("data-node-id"),previousID:Q||((i=B.lastElementChild.previousElementSibling)==null?void 0:i.getAttribute("data-node-id")),parentID:B.getAttribute("data-node-id")}),A.push({action:"move",id:P.getAttribute("data-node-id"),parentID:B.getAttribute("data-node-id"),previousID:Q||((s=P.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"))}),Q=P.getAttribute("data-node-id");const ce=P;P=P.nextElementSibling,B.lastElementChild.before(ce)}B.getAttribute("data-subtype")==="o"&&(Array.from(B.children).forEach(ce=>{const Pe=ce.getAttribute("data-node-id");Pe&&A.push({action:"update",id:Pe,data:ce.outerHTML})}),ct(B,1),Array.from(B.children).forEach(ce=>{const Pe=ce.getAttribute("data-node-id");Pe&&v.push({action:"update",id:Pe,data:ce.outerHTML})})),X&&A.push({action:"delete",id:X})}const V=d.outerHTML;e.forEach(X=>{X.remove()}),d.childElementCount===1?(v.push({action:"delete",id:f}),f===n.block.id&&(n.block.id=n.block.parentID),A.splice(0,0,{action:"insert",data:V,id:f,previousID:(o=d.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:g.getAttribute("data-node-id")||n.block.parentID}),d.remove()):(d.getAttribute("data-subtype")==="o"&&ct(d,C),v.push({action:"update",id:f,data:d.outerHTML}),A.splice(0,0,{action:"update",id:f,data:V})),G(n,v,A),_e(g,t);return}if(d.childElementCount===2&&g.childElementCount===3){t.collapse(!1),t.insertNode(document.createElement("wbr"));const v=g.outerHTML;e[0].firstElementChild.remove(),e[0].lastElementChild.remove(),d.outerHTML=e[0].innerHTML,ie(n,g.getAttribute("data-node-id"),g.outerHTML,v),_e(g,t);return}t.collapse(!1),t.insertNode(document.createElement("wbr"));const m=[],b=[],y=(l=e[0].previousElementSibling)==null?void 0:l.getAttribute("data-node-id");e.forEach(v=>{v.classList.remove("protyle-wysiwyg--select"),v.removeAttribute("select-start"),v.removeAttribute("select-end")});let w;!e[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(w=parseInt(e[0].getAttribute("data-marker")));const E=g.parentElement.outerHTML;let k=e[e.length-1].nextElementSibling,L=e[e.length-1].lastElementChild.previousElementSibling;if(e.reverse().forEach(v=>{const A=v.getAttribute("data-node-id");m.push({action:"move",id:A,previousID:g.getAttribute("data-node-id")}),b.push({action:"move",id:A,previousID:y,parentID:d.getAttribute("data-node-id")}),g.after(v),(v.getAttribute("data-subtype")==="o"||v.getAttribute("data-subtype")==="t")&&g.getAttribute("data-subtype")==="u"?(b.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',v.setAttribute("data-subtype","u"),v.setAttribute("data-marker","*"),m.push({action:"update",id:A,data:v.outerHTML})):(v.getAttribute("data-subtype")==="u"||v.getAttribute("data-subtype")==="t")&&g.getAttribute("data-subtype")==="o"?(b.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',v.setAttribute("data-subtype","o"),v.setAttribute("data-marker","1."),m.push({action:"update",id:A,data:v.outerHTML})):(v.getAttribute("data-subtype")==="u"||v.getAttribute("data-subtype")==="0")&&g.getAttribute("data-subtype")==="t"&&(b.push({action:"update",id:A,data:v.outerHTML}),v.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',v.setAttribute("data-subtype","t"),v.setAttribute("data-marker","*"),m.push({action:"update",id:A,data:v.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!k.classList.contains("protyle-attr")){let v;L.classList.contains("list")||(v=Lute.NewNodeID(),L=document.createElement("div"),L.classList.add("list"),L.setAttribute("data-subtype",k.getAttribute("data-subtype")),L.setAttribute("data-node-id",v),L.setAttribute("data-type","NodeList"),L.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),L.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,m.push({action:"insert",id:v,data:L.outerHTML,previousID:e[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),e[0].lastElementChild.before(L));let A;for(;k&&!k.classList.contains("protyle-attr");){const C=k.getAttribute("data-node-id");k.getAttribute("data-subtype")!==L.getAttribute("data-subtype")&&(b.push({action:"update",id:C,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML=L.querySelector(".protyle-action").outerHTML,k.setAttribute("data-subtype",L.getAttribute("data-subtype")),k.setAttribute("data-marker",L.getAttribute("data-marker")),m.push({action:"update",id:C,data:k.outerHTML})),m.push({action:"move",id:C,previousID:A||((r=L.lastElementChild.previousElementSibling)==null?void 0:r.getAttribute("data-node-id")),parentID:L.getAttribute("data-node-id")}),b.push({action:"move",id:C,previousID:A||((c=L.parentElement)==null?void 0:c.getAttribute("data-node-id"))}),A=C;const D=k;k=k.nextElementSibling,L.lastElementChild.before(D)}L.getAttribute("data-subtype")==="o"&&(Array.from(L.children).forEach(C=>{const D=C.getAttribute("data-node-id");D&&b.push({action:"update",id:D,data:C.outerHTML})}),ct(L,1),Array.from(L.children).forEach(C=>{const D=C.getAttribute("data-node-id");D&&m.push({action:"update",id:D,data:C.outerHTML})})),v&&b.push({action:"delete",id:v})}if(!window.siyuan.config.editor.listLogicalOutdent&&d.nextElementSibling){k=d.nextElementSibling;let v;for(;k&&!k.classList.contains("protyle-attr");){const A=k.getAttribute("data-node-id");m.push({action:"move",id:A,previousID:v||L.getAttribute("data-node-id")}),b.push({action:"move",id:A,previousID:v||d.getAttribute("data-node-id")}),v=A;const C=k;k=k.nextElementSibling,L.after(C),L=C}}d.childElementCount===1&&g.childElementCount===3?(m.push({action:"delete",id:g.getAttribute("data-node-id")}),b.splice(0,0,{action:"insert",id:g.getAttribute("data-node-id"),data:g.outerHTML,previousID:(u=g.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:g.parentElement.getAttribute("data-node-id")}),g.remove()):d.childElementCount===1?(m.push({action:"delete",id:d.getAttribute("data-node-id")}),b.splice(0,0,{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:d.previousElementSibling.getAttribute("data-node-id")}),d.remove()):d.getAttribute("data-subtype")==="o"&&(b.splice(0,0,{action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")}),ct(d,w),m.push({action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")})),h.classList.contains("protyle-wysiwyg")?G(n,m,b):(g&&g.getAttribute("data-subtype")==="o"&&ct(h),ie(n,h.getAttribute("data-node-id"),h.outerHTML,E)),_e(h,t)},Ri=(n,e)=>{const t=[],a=[];let i=e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0;e.classList.remove("protyle-wysiwyg--select"),e.removeAttribute("select-start"),e.removeAttribute("select-end");const s=e.getAttribute("data-node-id"),o=e.cloneNode();return o.innerHTML=e.lastElementChild.outerHTML,a.push({action:"insert",id:s,data:o.outerHTML,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}),Array.from(e.children).forEach((l,r)=>{if(r===e.childElementCount-1){t.push({action:"delete",id:s}),e.lastElementChild.remove(),e.outerHTML=e.innerHTML;return}t.push({action:"move",id:l.getAttribute("data-node-id"),previousID:i,parentID:e.parentElement.getAttribute("data-node-id")||n.block.parentID}),a.push({action:"move",id:l.getAttribute("data-node-id"),previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:s}),i=l.getAttribute("data-node-id")}),t.forEach(l=>{const r=n.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Ke(n,r))}),{doOperations:t,undoOperations:a,previousId:i}},lf=(n,e,t)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",e||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",n),a.innerHTML=t||`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,a},rf=(n,e)=>{const t=Oe(e);if(t){const a=$(t,"list")||$(t,"bq")||$(t,"sb")||t,i=Xe(a);i&&(we(i),Ge(n,i))}},rn=(n,e,t)=>{const a=he(n.wysiwyg.element);let i;if(t)i=n.wysiwyg.element.querySelector(`[data-node-id="${t}"]`);else{const c=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(e==="beforebegin"?i=c[0]:i=c[c.length-1],ne(["select"],n)):(i=M(a.startContainer),i=Oe(i))}if(!i)return;let s=Nn(!1,!0),o=1;i.getAttribute("data-type")==="NodeListItem"&&(s=ei(i,0,!0),o=parseInt(i.parentElement.firstElementChild.getAttribute("data-marker")));const l=i.parentElement.outerHTML,r=s.getAttribute("data-node-id");if(i.insertAdjacentElement(e,s),i.getAttribute("data-type")==="NodeListItem"&&i.getAttribute("data-subtype")==="o"&&!s.parentElement.classList.contains("protyle-wysiwyg"))ct(s.parentElement,o),ie(n,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,l);else{let c;e==="beforebegin"?c=[{action:"insert",data:s.outerHTML,id:r,nextID:i.getAttribute("data-node-id")}]:c=[{action:"insert",data:s.outerHTML,id:r,previousID:i.getAttribute("data-node-id")}],G(n,c,[{action:"delete",id:r}])}_e(n.wysiwyg.element,a),Ge(n)},pl=(n=!0,e=!0,t)=>{let a="";return n&&(a=p.Constants.ZWSP),e&&(a+="<wbr>"),t&&(a+=t),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${p.Constants.ZWSP}</div></div>`},Nn=(n=!0,e=!0,t)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",t||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${n?p.Constants.ZWSP:""}${e?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,a},Lc=(n,e,t)=>{if(n.getAttribute("custom-pinthead")==="true"){const a=n.querySelector("table");a.clientHeight+a.scrollTop<e.offsetTop+e.clientHeight?a.scrollTop=e.offsetTop-a.clientHeight+e.clientHeight+1:a.scrollTop>e.offsetTop-e.clientHeight&&(a.scrollTop=e.offsetTop-e.clientHeight+1)}else Ge(t,e)},vn=n=>{let e=n.previousElementSibling,t=0;for(;e;)t++,e=e.previousElementSibling;return t},cf=(n,e,t=!0)=>{let a=n.previousElementSibling;return a||(n.parentElement.previousElementSibling?a=n.parentElement.previousElementSibling.lastElementChild:n.parentElement.parentElement.tagName==="TBODY"&&n.parentElement.parentElement.previousElementSibling?a=n.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(e.selectNodeContents(a),t||e.collapse(!1),ee(e)),a},ca=(n,e,t,a,i)=>{i.insertNode(document.createElement("wbr"));const s=t.outerHTML,o=t.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,c=[];for(let u=0;u<r;u++){for(let d=0;d<l;d++)o.rows[u].cells[d].isSameNode(e[c.length])&&c.push(d);if(c.length>0)break}for(let u=0;u<r;u++)c.forEach(d=>{o.rows[u].cells[d].setAttribute("align",a)});ie(n,t.getAttribute("data-node-id"),t.outerHTML,s),_e(o,i)},Cc=(n,e,t,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let o="";for(let r=0;r<t.parentElement.childElementCount;r++)o+=`<td align="${t.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(t.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(t.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=t.parentElement.parentElement.nextElementSibling.firstElementChild)}else t.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=t.parentElement.nextElementSibling;e.selectNodeContents(l.cells[vn(t)]),e.collapse(!0),ee(e),ie(n,a.getAttribute("data-node-id"),a.outerHTML,s),Lc(a,l,n)},df=(n,e,t,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let o="",l=!1;for(let c=0;c<t.parentElement.childElementCount;c++){const u=t.parentElement.children[c];u.className==="fn__none"&&(l=!0),t.tagName==="TH"?o+=`<th class="${u.className}" colspan="${u.colSpan}" align="${u.getAttribute("align")}"></th>`:o+=`<td class="${u.className}" colspan="${u.colSpan}" align="${u.getAttribute("align")}"></td>`}if(l){let c=t.parentElement.previousElementSibling,u=1;for(;c;)u++,Array.from(c.children).forEach(d=>{d.rowSpan>=u&&d.rowSpan>1&&(d.rowSpan=d.rowSpan+1)}),c=c.previousElementSibling}let r;t.parentElement.parentElement.tagName==="THEAD"&&!t.parentElement.previousElementSibling?(t.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=a.querySelector("thead tr"),t.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",t.parentElement.parentElement.innerHTML),t.parentElement.parentElement.remove()):(t.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=t.parentElement.previousElementSibling),e.selectNodeContents(r.cells[vn(t)]),e.collapse(!0),ee(e),ie(n,a.getAttribute("data-node-id"),a.outerHTML,s),Lc(a,r,n)},gl=(n,e,t,a,i)=>{const s=document.createElement("wbr");i.insertNode(s);const o=e.outerHTML;s.remove();const l=vn(t),r=e.querySelector("table");for(let c=0;c<r.rows.length;c++){const u=r.rows[c].cells[l],d=document.createElement(u.tagName);u.insertAdjacentElement(a,d),u.isSameNode(t)?(d.innerHTML="<wbr> ",d.offsetLeft+d.clientWidth>e.firstElementChild.scrollLeft+e.firstElementChild.clientWidth&&(e.firstElementChild.scrollLeft=d.offsetLeft+d.clientWidth-e.firstElementChild.clientWidth)):d.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(a,"<col>"),_e(e,i),ie(n,e.getAttribute("data-node-id"),e.outerHTML,o)},uf=(n,e,t,a)=>{if(t.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();const o=vn(t),l=t.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;t.parentElement.previousElementSibling&&(r=t.parentElement.previousElementSibling),l.childElementCount===1?l.remove():t.parentElement.remove(),e.selectNodeContents(r.cells[o]),e.collapse(!0),ee(e),Lc(a,r,n),ie(n,a.getAttribute("data-node-id"),a.outerHTML,s)}},ff=(n,e,t,a)=>{var i;const s=document.createElement("wbr");e.insertNode(s);const o=t.outerHTML;s.remove();const l=vn(a),r=a.previousElementSibling||a.nextElementSibling;r&&(e.selectNodeContents(r),e.collapse(!0),r.offsetLeft+r.clientWidth>t.firstElementChild.scrollLeft+t.firstElementChild.clientWidth&&(t.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-t.firstElementChild.clientWidth));const c=t.querySelector("table");for(let u=0;u<c.rows.length;u++){const d=c.rows[u].cells;if(d.length===1){c.remove();break}d[l].remove()}(i=t.querySelectorAll("col")[l])==null||i.remove(),ie(n,t.getAttribute("data-node-id"),t.outerHTML,o),ee(e)},pf=(n,e,t,a)=>{const i=t.parentElement;if(i.parentElement.tagName==="THEAD")return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const o=i.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.previousElementSibling.append(i)}ie(n,a.getAttribute("data-node-id"),a.outerHTML,s),_e(a,e),Ge(n,i)},gf=(n,e,t,a)=>{const i=t.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const o=i.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}ie(n,a.getAttribute("data-node-id"),a.outerHTML,s),_e(a,e),Ge(n,i)},hf=(n,e,t,a)=>{if(!t.previousElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(t.parentElement.children).find((l,r)=>{if(t.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].after(l.cells[s-1])}),t.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=t.offsetLeft);const o=a.querySelectorAll("col");o[s].after(o[s-1]),ie(n,a.getAttribute("data-node-id"),a.outerHTML,i),_e(a,e)},mf=(n,e,t,a)=>{if(!t.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(t.parentElement.children).find((l,r)=>{if(t.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].before(l.cells[s+1])}),t.offsetLeft+t.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=t.offsetLeft+t.clientWidth-a.firstElementChild.clientWidth);const o=a.querySelectorAll("col");o[s].before(o[s+1]),ie(n,a.getAttribute("data-node-id"),a.outerHTML,i),_e(a,e)},Qb=(n,e,t)=>{var a,i,s;const o=te(t.startContainer,"TD")||te(t.startContainer,"TH"),l=M(t.startContainer);if(!o||!l||l.classList.contains("protyle-wysiwyg--select"))return!1;if(e.key==="Enter"&&e.shiftKey&&!ye(e)&&!e.altKey){const C=document.createElement("wbr");t.insertNode(C);const D=l.outerHTML;if(C.remove(),o&&!o.innerHTML.endsWith("<br>")&&o.insertAdjacentHTML("beforeend","<br>"),t.extractContents(),n.toolbar.getCurrentType(t).includes("code")&&t.startContainer.nodeType!==3){const P=document.createElement("br");t.startContainer.after(P),t.setStartAfter(P)}else t.insertNode(document.createElement("br"));return t.collapse(!1),Ge(n),ie(n,l.getAttribute("data-node-id"),l.outerHTML,D),e.preventDefault(),!0}if(!ye(e)&&!e.shiftKey&&!e.altKey&&e.key==="Enter"){e.preventDefault();const C=o.parentElement;if(!C.nextElementSibling&&C.parentElement.tagName==="TBODY"||C.parentElement.tagName==="THEAD"&&!C.parentElement.nextElementSibling)return!0;let D=C.nextElementSibling;return D||(D=C.parentElement.nextElementSibling.firstChild),D&&(t.selectNodeContents(D.cells[vn(o)]),t.collapse(!0),Ge(n)),!0}if(e.key==="ArrowRight"&&t.toString()===""&&!l.nextElementSibling&&o.isSameNode(l.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&Et(o,n.wysiwyg.element,t).start===o.textContent.length)return e.preventDefault(),rn(n,"afterend",l.getAttribute("data-node-id")),!0;if(e.key==="Tab"&&!e.ctrlKey){if(e.shiftKey)return cf(o,t),e.preventDefault(),!0;let C=o.nextElementSibling;return C||(o.parentElement.nextElementSibling?C=o.parentElement.nextElementSibling.firstElementChild:o.parentElement.parentElement.tagName==="THEAD"&&o.parentElement.parentElement.nextElementSibling?C=o.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:C=null),C?t.selectNodeContents(C):(Cc(n,t,o,l),t.selectNodeContents(l.querySelector("tbody").lastElementChild.firstElementChild)),e.preventDefault(),!0}if(e.key==="ArrowUp"&&!ye(e)&&!e.shiftKey&&!e.altKey){const C=t.startContainer;let D;for(C.nodeType!==3&&(C.tagName==="TH"||C.tagName==="TD")?D=(a=C.childNodes[Math.max(0,t.startOffset-1)])==null?void 0:a.previousElementSibling:C.parentElement.tagName==="SPAN"?D=C.parentElement.previousElementSibling:D=C.previousElementSibling;D;){if(D.tagName==="BR")return!1;D=D.previousElementSibling}const x=o.parentElement;let P=x.previousElementSibling;return P||(P=x.parentElement.previousElementSibling.lastElementChild),!P||(P==null?void 0:P.tagName)==="COL"?!1:(t.selectNodeContents(P.cells[vn(o)]),t.collapse(!1),Ge(n),e.preventDefault(),!0)}if(e.key==="ArrowDown"&&!ye(e)&&!e.shiftKey&&!e.altKey){const C=t.endContainer;let D;for(C.nodeType!==3&&(C.tagName==="TH"||C.tagName==="TD")?D=(i=C.childNodes[Math.max(0,t.endOffset-1)])==null?void 0:i.nextElementSibling:C.parentElement.tagName==="SPAN"?D=C.parentElement.nextElementSibling:D=C.nextElementSibling;D;){if(D.tagName==="BR"&&D.nextSibling)return!1;D=D.nextElementSibling}const x=o.parentElement;if(!x.nextElementSibling&&x.parentElement.tagName==="TBODY"||x.parentElement.tagName==="THEAD"&&!x.parentElement.nextElementSibling)return!1;let P=x.nextElementSibling;return P||(P=x.parentElement.nextElementSibling.firstChild),P?(t.selectNodeContents(P.cells[vn(o)]),t.collapse(!0),Ge(n),e.preventDefault(),!0):!1}if(!ye(e)&&!e.shiftKey&&!e.altKey&&e.key==="Backspace"&&Et(o,n.wysiwyg.element,t).start===0&&t.toString()===""&&(t.startOffset===0||t.startOffset===1&&o.querySelectorAll("br").length===1))return!cf(o,t,!1)&&l.previousElementSibling&&we(l.previousElementSibling,void 0,!1),Ge(n),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.general.alignLeft.custom,e))return ca(n,[o],l,"left",t),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.general.alignCenter.custom,e))return ca(n,[o],l,"center",t),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.general.alignRight.custom,e))return ca(n,[o],l,"right",t),e.preventDefault(),!0;const r=l.querySelector("table"),c=o.parentElement.querySelector(".fn__none");let u=!1,d=!1;Array.from(o.parentElement.children).forEach(C=>{C.colSpan>1&&(u=!0),C.rowSpan>1&&(d=!0)});let f=!1,g=!1,h=!1,m=o.parentElement.previousElementSibling;!m&&o.parentElement.parentElement.tagName==="TBODY"&&(m=r.querySelector("thead").lastElementChild),m&&(f=m.querySelector(".fn__none"),Array.from(m.children).forEach(C=>{C.colSpan>1&&(g=!0),C.rowSpan>1&&(h=!0)}));let b=!1,y=!1,w=!1,E=o.parentElement.nextElementSibling;!E&&o.parentElement.parentElement.tagName==="THEAD"&&(E=(s=r.querySelector("tbody"))==null?void 0:s.firstElementChild),E&&(b=E.querySelector(".fn__none"),Array.from(E.children).forEach(C=>{C.colSpan>1&&(y=!0),C.rowSpan>1&&(w=!0)}));const k=vn(o);let L=!0;Array.from(r.rows).find(C=>{const D=C.cells[k];if(D.classList.contains("fn__none")||D.colSpan>1||D.rowSpan>1)return L=!1,!0});let v=!0;Array.from(r.rows).find(C=>{const D=C.cells[k+1];if(D&&(D.classList.contains("fn__none")||D.colSpan>1||D.rowSpan>1))return v=!1,!0});let A=!0;if(Array.from(r.rows).find(C=>{const D=C.cells[k-1];if(D&&(D.classList.contains("fn__none")||D.colSpan>1||D.rowSpan>1))return A=!1,!0}),U(window.siyuan.config.keymap.editor.table.moveToUp.custom,e))return(!c||c&&!d&&u)&&(!f||f&&!h&&g)&&pf(n,t,o,l),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table.moveToDown.custom,e))return(!c||c&&!d&&u)&&(!b||b&&!w&&y)&&gf(n,t,o,l),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table.moveToLeft.custom,e))return L&&A&&hf(n,t,o,l),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table.moveToRight.custom,e))return L&&v&&mf(n,t,o,l),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,e))return df(n,t,o,l),e.preventDefault(),e.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,e))return(!b||b&&!w&&y)&&Cc(n,t,o,l),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,e))return(L||A)&&gl(n,l,o,"beforebegin",t),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,e))return(L||v)&&gl(n,l,o,"afterend",t),e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.table["delete-row"].custom,e))return(!c&&!d||c&&!d&&u)&&uf(n,t,o,l),e.preventDefault(),e.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.table["delete-column"].custom,e))return L&&ff(n,t,l,o),e.preventDefault(),!0},cn=(n,e=0,t=1e3)=>{n.scroll.lastScrollTop=-1,setTimeout(()=>{n.scroll.lastScrollTop=e},t)},KE=n=>{},bf=(n,e,t,a)=>{const i=[{icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:`${ae(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${ae("\u2325Click")}`,click:()=>{t?be({app:n,id:e,position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}):_("/api/block/checkBlockFold",{id:e},s=>{be({app:n,id:e,position:"right",action:s.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:s.data})})}},{icon:"iconLayoutBottom",label:window.siyuan.languages.insertBottom,accelerator:"\u21E7Click",click:()=>{t?be({app:n,id:e,position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}):_("/api/block/checkBlockFold",{id:e},s=>{be({app:n,id:e,position:"bottom",action:s.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:s.data})})}}];window.siyuan.config.fileTree.openFilesUseCurrentTab&&i.push({label:window.siyuan.languages.openInNewTab,accelerator:"\u2325\u2318Click",click:()=>{t?be({app:n,id:e,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],removeCurrentTab:!1}):_("/api/block/checkBlockFold",{id:e},s=>{be({app:n,id:e,action:s.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:s.data,removeCurrentTab:!1})})}}),i.push({type:"separator"}),i.push({icon:"iconPreview",label:window.siyuan.languages.preview,click:()=>{be({app:n,id:e,mode:"preview"})}}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.openBy,submenu:i}).element)},wf=n=>{if(Mt()){window.JSAndroid.writeImageClipboard(n.getAttribute("src"));return}else{const e=document.createElement("canvas"),t=document.createElement("img");t.onload=a=>{e.width=a.target.width,e.height=a.target.height,e.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),e.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:i})])},"image/png",1)},t.src=n.getAttribute("src")}},yf=(n,e)=>{const t=new Kt("av-header-add"),a=e.getAttribute("data-av-id");return t.addItem({icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:a,type:"text",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"text",name:window.siyuan.languages.text,id:i})}}),t.addItem({icon:"iconNumber",label:window.siyuan.languages.number,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:a,type:"number",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"number",name:window.siyuan.languages.number,id:i})}}),t.addItem({icon:"iconListItem",label:window.siyuan.languages.select,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:a,type:"select",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"select",name:window.siyuan.languages.select,id:i})}}),t.addItem({icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:a,type:"mSelect",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"mSelect",name:window.siyuan.languages.multiSelect,id:i})}}),t.addItem({icon:"iconCalendar",label:window.siyuan.languages.date,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:a,type:"date",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"date",name:window.siyuan.languages.date,id:i})}}),t.addItem({icon:"iconImage",label:window.siyuan.languages.assets,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:a,type:"mAsset",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"mAsset",name:window.siyuan.languages.assets,id:i})}}),t.addItem({icon:"iconLink",label:window.siyuan.languages.link,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:a,type:"url",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"url",name:window.siyuan.languages.link,id:i})}}),t.addItem({icon:"iconEmail",label:window.siyuan.languages.email,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:a,type:"email",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"email",name:window.siyuan.languages.email,id:i})}}),t.addItem({icon:"iconPhone",label:window.siyuan.languages.phone,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:a,type:"phone",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"phone",name:window.siyuan.languages.phone,id:i})}}),t.addItem({icon:"iconMath",label:window.siyuan.languages.template,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:a,type:"template",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"template",name:window.siyuan.languages.template,id:i})}}),t.addItem({icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:a,type:"created",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"created",name:window.siyuan.languages.createdTime,id:i})}}),t.addItem({icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const i=Lute.NewNodeID();G(n,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:a,type:"updated",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),fn({blockElement:e,protyle:n,type:"updated",name:window.siyuan.languages.updatedTime,id:i})}}),t},En=(n,e,t="b3-list-item--focus")=>{var a;let i=n.querySelector("."+t);const s=t.split("--")[0];if(e.key==="ArrowDown")return e.preventDefault(),e.stopPropagation(),i.classList.remove(t),i.nextElementSibling?i.nextElementSibling.classList.contains(s)?i.nextElementSibling.classList.add(t):i.nextElementSibling.nextElementSibling.classList.add(t):n.children[0].classList.add(t),i=n.querySelector("."+t),(n.scrollTop<i.offsetTop-n.clientHeight+i.clientHeight||n.scrollTop>i.offsetTop)&&i.scrollIntoView(n.scrollTop>i.offsetTop),i;if(e.key==="ArrowUp"){if(e.preventDefault(),e.stopPropagation(),i.classList.remove(t),i.previousElementSibling)i.previousElementSibling.classList.contains(s)?i.previousElementSibling.classList.add(t):i.previousElementSibling.previousElementSibling.classList.add(t);else{const l=n.children.length;n.children[l-1].classList.add(t)}i=n.querySelector("."+t);const o=n.scrollTop>i.offsetTop-(((a=i.previousElementSibling)==null?void 0:a.clientHeight)||0);return(n.scrollTop<i.offsetTop-n.clientHeight+i.clientHeight||o)&&i.scrollIntoView(o),i}},Ia=n=>{var e,t;let a="";switch(n.type){case"block":a=`<div class="fn__flex-1">${n.block.content}</div>`;break;case"text":a=`<textarea rows="${n.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1">${n.text.content}</textarea>`;break;case"number":a=`<input value="${n.number.content}" type="number" class="b3-text-field b3-text-field--text fn__flex-1">`;break;case"mSelect":case"select":(e=n.mSelect)==null||e.forEach(i=>{a+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">${i.content}</span>`});break;case"mAsset":(t=n.mAsset)==null||t.forEach(i=>{i.type==="image"?a+=`<img class="av__cellassetimg" src="${i.content}">`:a+=`<span class="b3-chip b3-chip--middle av__celltext--url" data-url="${i.content}">${i.name}</span>`});break;case"date":case"created":case"updated":n[n.type].isNotEmpty&&(a=`<span data-content="${n[n.type].content}">${ue(n[n.type].content).format("YYYY-MM-DD HH:mm")}</span>`),n[n.type].hasEndDate&&n[n.type].isNotEmpty2&&n[n.type].isNotEmpty&&(a+=`<svg class="custom-attr__avarrow"><use xlink:href="#iconForward"></use></svg><span data-content="${n[n.type].content2}">${ue(n[n.type].content2).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":a=`<input value="${n.url.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="${n.url.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":a=`<input value="${n.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="tel:${n.phone.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"template":a=`<div class="fn__flex-1">${n.template.content}</div>`;break;case"email":a=`<input value="${n.email.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="mailto:${n.email.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break}return a},ew=(n,e,t)=>{_("/api/av/getAttributeViewKeys",{id:e},a=>{let i="";a.data.forEach(s=>{var o;i+=`<div data-av-id="${s.avID}" data-node-id="${e}" data-type="NodeAttributeView"><div class="block__logo custom-attr__avheader">
    <svg><use xlink:href="#iconDatabase"></use></svg>
    <span>${s.avName||window.siyuan.languages.database}</span>
</div>`,(o=s.keyValues)==null||o.forEach(l=>{var r;i+=`<div class="block__icons" data-id="${e}">
    <div class="block__logo">
        <svg><use xlink:href="#${un(l.key.type)}"></use></svg>
        <span>${l.key.name}</span>
    </div>
    <div data-av-id="${s.avID}" data-col-id="${l.values[0].keyID}" data-block-id="${l.values[0].blockID}" data-id="${l.values[0].id}" data-type="${l.values[0].type}" 
data-options="${(r=l.key)!=null&&r.options?ia(JSON.stringify(l.key.options)):"[]"}"
class="fn__flex-1 fn__flex${["url","text","number","email","phone"].includes(l.values[0].type)?"":" custom-attr__avvalue"}">
        ${Ia(l.values[0])}
    </div>
</div>`}),i+="</div>"}),n.innerHTML=i,n.addEventListener("click",s=>{const o=s.target,l=S(o,"data-type","date");if(l){Pa(t,[l],"date"),s.stopPropagation(),s.preventDefault();return}const r=S(o,"data-type","select")||S(o,"data-type","mSelect");if(r){Pa(t,[r],r.getAttribute("data-type")),s.stopPropagation(),s.preventDefault();return}const c=S(o,"data-type","mAsset");if(c){Pa(t,[c],"mAsset"),s.stopPropagation(),s.preventDefault();return}}),n.querySelectorAll(".b3-text-field--text").forEach(s=>{s.addEventListener("change",()=>{let o;["url","text","email","phone"].includes(s.parentElement.dataset.type)?o={[s.parentElement.dataset.type]:{content:s.value}}:s.parentElement.dataset.type==="number"&&(o={number:{content:parseFloat(s.value)}}),_("/api/av/setAttributeViewBlockAttr",{avID:s.parentElement.dataset.avId,keyID:s.parentElement.dataset.colId,rowID:s.parentElement.dataset.blockId,cellID:s.parentElement.dataset.id,value:o})})})})},xc=(n,e)=>{let t="",a=!1;if(e&&e.forEach(i=>{(!n||n.toLowerCase().indexOf(i.name.toLowerCase())>-1||i.name.toLowerCase().indexOf(n.toLowerCase())>-1)&&(t+=`<button data-type="addColOptionOrCell" class="b3-menu__item${t?"":" b3-menu__item--current"}" draggable="true" data-name="${i.name}" data-color="${i.color}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">
            <span class="fn__ellipsis">${i.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`),n===i.name&&(a=!0)}),!a&&n){const i=((e==null?void 0:e.length)||0)%13+1;t=`<button data-type="addColOptionOrCell" class="b3-menu__item${t?"":" b3-menu__item--current"}" data-name="${n}" data-color="${i}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${i});color:var(--b3-font-color${i})">
        <span class="fn__ellipsis">${n}</span>
    </span>
</div>
<span class="b3-menu__accelerator">Enter</span>
</button>${t}`}return t},_f=(n,e,t,a)=>{if(!a)return;const i=t[0].dataset.colId,s=[],o=[];let l;t.forEach((r,c)=>{var u;const d=r.parentElement.dataset.id,f=r.dataset.id;let g;e.view.rows.find(m=>{if(m.id===d)return m.cells.find(b=>{if(b.id===f)return g=b,!0}),!0});const h=Object.assign([],g.value.mSelect);c===0?((u=g.value.mSelect)==null||u.find((m,b)=>{if(m.content===a.dataset.content)return g.value.mSelect.splice(b,1),!0}),l=g.value.mSelect):g.value.mSelect=l,s.push({action:"updateAttrViewCell",id:f,keyID:i,rowID:d,avID:e.id,data:g.value}),o.push({action:"updateAttrViewCell",id:f,keyID:i,rowID:d,avID:e.id,data:{mSelect:h}}),r.classList.contains("custom-attr__avvalue")?r.innerHTML=Ia(g.value):kn(r)}),G(n,s,o),a.remove()},tw=(n,e,t,a)=>{const i=$(t,"b3-menu");if(!i)return;const s=a?a[0].dataset.colId:i.querySelector(".b3-menu__item").getAttribute("data-col-id");let o=t.parentElement.dataset.name,l=t.parentElement.dataset.color;const r=new Kt("av-col-option",()=>{o!==u.value&&(G(n,[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{newColor:l,oldName:o,newName:u.value}}],[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{newColor:l,oldName:u.value,newName:o}}]),e.view.columns.find(d=>{if(d.id===s)return d.options.find(f=>{if(f.name===o)return f.name=u.value,!0}),!0}),a?(a.forEach(d=>{e.view.rows.find(f=>{if(f.id===d.parentElement.dataset.id)return f.cells.find(g=>{if(g.id===d.dataset.id)return g.value.mSelect.find(h=>{if(h.content===o)return h.content=u.value,!0}),d.classList.contains("custom-attr__avvalue")?d.innerHTML=Ia(g.value):kn(d),!0}),!0})}),i.innerHTML=Fi(e.view,a),qi(n,e,i,a)):(i.innerHTML=fa({protyle:n,data:e,colId:s}),pa({protyle:n,data:e,menuElement:i})))});if(r.isOpen)return;r.addItem({iconHTML:"",label:`<input class="b3-text-field" style="margin: 4px 0" value="${o}">`,bind(d){d.querySelector("input").addEventListener("keydown",f=>{f.isComposing||f.key==="Enter"&&r.close()})}}),r.addItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let d=[];e.view.columns.find(g=>{if(g.id===s)return d=g.options,!0});const f=t.parentElement.dataset.name;G(n,[{action:"removeAttrViewColOption",id:s,avID:e.id,data:f}],[{action:"updateAttrViewColOptions",id:s,avID:e.id,data:d}]),d.find((g,h)=>{if(g.name===f)return d.splice(h,1),!0}),a?(a.forEach(g=>{e.view.rows.find(h=>{if(h.id===g.parentElement.dataset.id)return h.cells.find(m=>{if(m.id===g.dataset.id)return m.value.mSelect.find((b,y)=>{if(b.content===f)return m.value.mSelect.splice(y,1),!0}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=Ia(m.value):kn(g),!0}),!0})}),i.innerHTML=Fi(e.view,a),qi(n,e,i,a)):(i.innerHTML=fa({protyle:n,data:e,colId:s}),pa({protyle:n,data:e,menuElement:i}))})}}),r.addSeparator(),Array.from(Array(13).keys()).forEach(d=>{r.addItem({accelerator:parseInt(l)===d+1?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,iconHTML:"",label:`<span class="color__square"  style="padding: 5px;margin: 2px;color: var(--b3-font-color${d+1});background-color: var(--b3-font-background${d+1});">A</span>`,click(f){var g;if(!f.lastElementChild.classList.contains("b3-menu__accelerator"))return(g=f.parentElement.querySelector(".b3-menu__accelerator"))==null||g.remove(),f.insertAdjacentHTML("beforeend",'<span class="b3-menu__accelerator"><svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg></span>'),G(n,[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{oldName:o,newName:u.value,oldColor:l,newColor:(d+1).toString()}}],[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{oldName:u.value,newName:o,oldColor:(d+1).toString(),newColor:l}}]),e.view.columns.find(h=>{if(h.id===s)return h.options.find(m=>{if(m.name===o)return m.name=u.value,m.color=(d+1).toString(),!0}),!0}),a?(a.forEach(h=>{e.view.rows.find(m=>{if(m.id===h.parentElement.dataset.id)return m.cells.find(b=>{if(b.id===h.dataset.id)return b.value.mSelect.find(y=>{if(y.content===o)return y.content=u.value,y.color=(d+1).toString(),!0}),h.classList.contains("custom-attr__avvalue")?h.innerHTML=Ia(b.value):kn(h),!0}),!0})}),i.innerHTML=Fi(e.view,a),qi(n,e,i,a)):(i.innerHTML=fa({protyle:n,data:e,colId:s}),pa({protyle:n,data:e,menuElement:i})),o=u.value,l=(d+1).toString(),!0}})});const c=t.getBoundingClientRect();r.open({x:c.right,y:c.bottom,w:c.width,h:c.height});const u=window.siyuan.menus.menu.element.querySelector("input");u.select()},qi=(n,e,t,a)=>{const i=t.querySelector("input"),s=a[0].dataset.colId;let o;e.view.columns.find(r=>{if(r.id===s){o=r;return}}),o.options||(o.options=[]);const l=t.lastElementChild.lastElementChild;i.addEventListener("input",r=>{r.isComposing||(l.innerHTML=xc(i.value,o.options))}),i.addEventListener("compositionend",r=>{r.isComposing||(l.innerHTML=xc(i.value,o.options))}),i.addEventListener("keydown",r=>{if(r.isComposing)return;let c=En(l,r,"b3-menu__item--current");r.key==="Enter"?(c||(c=t.querySelector(".b3-menu__item--current")),vf(n,e,a,c,t)):r.key==="Backspace"&&i.value===""?_f(n,e,a,i.previousElementSibling):r.key==="Escape"&&t.parentElement.remove()})},vf=(n,e,t,a,i)=>{let s=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(f=>{if(f.dataset.content===a.dataset.name)return s=!0,!0}),s){i.querySelector("input").focus();return}const o=t[0].dataset.colId;let l;Array.from(t[0].parentElement.querySelectorAll(".av__cell")).find((f,g)=>{if(f.dataset.id===t[0].dataset.id)return l=g,!0});let r;e.view.columns.find(f=>{if(f.id===o){r=f,r.options||(r.options=[]);return}});const c=[],u=[];let d;t.forEach((f,g)=>{let h;const m=f.parentElement.dataset.id;e.view.rows.find(y=>{if(y.id===m)return typeof l=="number"?(h=y.cells[l],h.id=f.dataset.id,(!h.value||!h.value.mSelect)&&(h.value={mSelect:[]})):h=y.cells.find(w=>{if(w.id===f.dataset.id)return!0}),!0});const b=Object.assign([],h.value.mSelect);if(r.type==="mSelect")if(g===0){let y=!1;h.value.mSelect.find(w=>{if(w.content===a.dataset.name)return y=!0,!0}),y||h.value.mSelect.push({color:a.dataset.color,content:a.dataset.name}),d=h.value.mSelect}else h.value.mSelect=d;else g===0?(h.value.mSelect=[{color:a.dataset.color,content:a.dataset.name}],d=h.value.mSelect):h.value.mSelect=d;c.push({action:"updateAttrViewCell",id:h.id,keyID:o,rowID:m,avID:e.id,data:h.value}),u.push({action:"updateAttrViewCell",id:h.id,keyID:o,rowID:m,avID:e.id,data:{[r.type]:b}}),f.classList.contains("custom-attr__avvalue")?f.innerHTML=Ia(h.value):kn(f)}),a.querySelector(".b3-menu__accelerator")?(r.options.push({color:a.dataset.color,name:a.dataset.name}),c.splice(0,0,{action:"updateAttrViewColOptions",id:o,avID:e.id,data:r.options}),G(n,c,[{action:"removeAttrViewColOption",id:o,avID:e.id,data:a.dataset.name}])):G(n,c,u),r.type==="select"?i.parentElement.remove():(i.innerHTML=Fi(e.view,t),qi(n,e,i,t),i.querySelector("input").focus())},Fi=(n,e)=>{const t=e[0].dataset.colId,a=n.columns.find(o=>{if(o.id===t)return o});let i=[];n.rows.find(o=>{if(e[0].parentElement.dataset.id===o.id)return o.cells.find(l=>{if(l.id===e[0].dataset.id)return l.value&&l.value.mSelect&&(i=l.value.mSelect),!0}),!0});let s="";return i.forEach(o=>{s+=`<div class="b3-chip b3-chip--middle" data-content="${o.content}" style="background-color:var(--b3-font-background${o.color});color:var(--b3-font-color${o.color})">${o.content}<svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips">
    ${s}
    <input>
</div>
<div>${xc("",a.options)}</div>
</div>`},Ac=n=>{if(n==="number"||n==="select")return"=";if(["text","mSelect","url","block","email","phone","template"].includes(n))return"Contains"},Ef=(n,e,t)=>{const a=$(n,"b3-menu");a&&a.querySelectorAll("input, .b3-chip").forEach((i,s)=>{const o=$(i,"b3-menu__item");o&&(["date","updated","created"].includes(t)?e==="Is between"?o.classList.remove("fn__none"):e==="Is empty"||e==="Is not empty"?o.classList.add("fn__none"):s===0?o.classList.remove("fn__none"):o.classList.add("fn__none"):e!=="Is empty"&&e!=="Is not empty"?o.classList.remove("fn__none"):o.classList.add("fn__none"))})},Tc=n=>{var e,t;let a=n.target.getBoundingClientRect();a.height===0&&(a=n.protyle.wysiwyg.element.querySelector(`[data-col-id="${n.target.dataset.colId}"]`).getBoundingClientRect());const i=new Kt("set-filter-"+n.filter.column,()=>{const c=JSON.parse(JSON.stringify(n.data.view.filters)),u=window.siyuan.menus.menu.element.querySelector(".b3-select").value;let d=!1,f;if(r.length>0)["date","updated","created"].includes(o.type)?f=Os(o.type,{isNotEmpty2:r[1].value!=="",isNotEmpty:r[0].value!=="",content:new Date(r[0].value).getTime(),content2:new Date(r[1].value).getTime(),hasEndDate:u==="Is between"}):f=Os(o.type,r[0].value);else{const b=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(y=>{if(y.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const w=y.nextElementSibling.firstElementChild;b.push({color:w.dataset.color,content:w.dataset.name})}}),b.length===0&&b.push({color:"",content:""}),f=Os(o.type,b)}const g={column:n.filter.column,value:f,operator:u};let h=!1;if(n.data.view.filters.find((b,y)=>{if(b.column===n.filter.column)return(0,T.MK)(b,g)?(h=!0,!0):(n.data.view.filters[y]=g,d=!0,!0)}),h||!d)return;G(n.protyle,[{action:"setAttrViewFilters",avID:n.data.id,data:n.data.view.filters}],[{action:"setAttrViewFilters",avID:n.data.id,data:c}]);const m=$(n.target,"b3-menu");m&&(m.innerHTML=Da(n.data.view))});if(i.isOpen)return;let s="",o;switch(n.data.view.columns.find(c=>{if(c.id===n.filter.column)return o=c,!0}),o.type){case"block":case"text":case"url":case"phone":case"email":s=`<option ${n.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${n.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${n.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${n.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${n.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${n.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${n.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${n.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":s=`<option ${n.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${n.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${n.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${n.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${n.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${n.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${n.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${n.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${n.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${n.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${n.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${n.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":s=`<option ${n.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${n.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${n.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${n.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${n.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${n.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${n.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${n.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":s=`<option ${n.filter.operator==="="?"selected":""} value="=">=</option>
<option ${n.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${n.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${n.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${n.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${n.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${n.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${n.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"select":o.type==="select"?s=`<option ${n.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${n.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${n.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${n.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`:s=`<option ${n.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${n.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${n.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${n.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(i.addItem({iconHTML:"",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${s}</select>`}),o.type==="select"||o.type==="mSelect")(e=o.options)==null||e.forEach(c=>{var u;let d="iconUncheck";(u=n.filter.value)==null||u.mSelect.find(f=>{f.content===c.name&&(d="iconCheck")}),i.addItem({icon:d,label:`<span class="b3-chip b3-chip--middle" data-name="${c.name}" data-color="${c.color}" style="margin:3px 0;background-color:var(--b3-font-background${c.color});color:var(--b3-font-color${c.color})">
    <span class="fn__ellipsis">${c.name}</span>
</span>`,bind(f){f.addEventListener("click",()=>{const g=f.querySelector("use");g.getAttribute("xlink:href")==="#iconUncheck"?g.setAttribute("xlink:href","#iconCheck"):g.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template"].includes(o.type))i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${n.filter.value?n.filter.value[o.type].content:""}" class="b3-text-field fn__size200">`});else if(o.type==="number")i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${(t=n.filter.value)!=null&&t.number.isNotEmpty?n.filter.value.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(o.type)){const c=n.filter.value?n.filter.value[o.type]:null;i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${c.isNotEmpty||o.type!=="date"?ue(c.content).format("YYYY-MM-DDTHH:mm"):""}" type="datetime-local" class="b3-text-field fn__size200">`}),i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${c.isNotEmpty2?ue(c.content2).format("YYYY-MM-DDTHH:mm"):""}" type="datetime-local" class="b3-text-field fn__size200">`})}i.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){const c=Object.assign([],n.data.view.filters);n.data.view.filters.find((d,f)=>{if(d.column===n.filter.column)return n.data.view.filters.splice(f,1),!0}),G(n.protyle,[{action:"setAttrViewFilters",avID:n.data.id,data:n.data.view.filters}],[{action:"setAttrViewFilters",avID:n.data.id,data:c}]);const u=$(n.target,"b3-menu");u&&(u.innerHTML=Da(n.data.view))}});const l=window.siyuan.menus.menu.element.querySelector(".b3-select");l.addEventListener("change",()=>{Ef(l,l.value,o.type)});const r=window.siyuan.menus.menu.element.querySelectorAll(".b3-text-field");r.forEach(c=>{c.addEventListener("keydown",u=>{if(u.isComposing){u.preventDefault();return}u.key==="Enter"&&(i.close(),u.preventDefault())})}),Ef(l,l.value,o.type),i.open({x:a.left,y:a.bottom}),r.length>0&&r[0].select()},nw=n=>{const e=new Kt("av-add-filter");n.data.view.columns.forEach(t=>{let a=!1;n.data.view.filters.find(i=>{if(i.column===t.id)return a=!0,!0}),!a&&t.type!=="mAsset"&&e.addItem({label:t.name,iconHTML:t.icon?fe(t.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${un(t.type)}"></use></svg>`,click:()=>{const i=Object.assign([],n.data.view.filters),s=Os(t.type,"");n.data.view.filters.push({column:t.id,operator:Ac(t.type),value:s}),G(n.protyle,[{action:"setAttrViewFilters",avID:n.data.id,data:n.data.view.filters}],[{action:"setAttrViewFilters",avID:n.data.id,data:i}]),n.menuElement.innerHTML=Da(n.data.view),Ve(n.menuElement,n.tabRect.right-n.menuElement.clientWidth,n.tabRect.bottom,n.tabRect.height);const o=n.menuElement.querySelector(`[data-id="${t.id}"] .b3-chip`);Tc({filter:{operator:Ac(t.type),column:t.id,value:s},protyle:n.protyle,data:n.data,target:o})}})}),e.open({x:n.rect.left,y:n.rect.bottom,h:n.rect.height})},Da=n=>{let e="";const t=a=>{let i="";return n.columns.find(s=>{var o,l,r,c,u,d,f,g,h,m,b,y,w,E,k,L,v,A,C,D,x,P,B,V,X,Q,ce,Pe;if(s.id===a.column){let ge="";if(a.operator==="Is empty")ge=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(a.operator==="Is not empty")ge=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if((l=(o=a.value)==null?void 0:o.date)!=null&&l.content)(c=(r=a.value)==null?void 0:r.date)!=null&&c.content2&&a.operator==="Is between"?ge=` ${window.siyuan.languages.filterOperatorIsBetween} ${ue(a.value.date.content).format("YYYY-MM-DD HH:mm")} ${ue(a.value.date.content2).format("YYYY-MM-DD HH:mm")}`:a.operator==="="?ge=`: ${ue(a.value.date.content).format("YYYY-MM-DD HH:mm")}`:[">","<"].includes(a.operator)?ge=` ${a.operator} ${ue(a.value.date.content).format("YYYY-MM-DD HH:mm")}`:a.operator===">="?ge=` \u2265 ${ue(a.value.date.content).format("YYYY-MM-DD HH:mm")}`:a.operator==="<="&&(ge=` \u2264 ${ue(a.value.date.content).format("YYYY-MM-DD HH:mm")}`);else if(((d=(u=a.value)==null?void 0:u.mSelect)==null?void 0:d.length)>0){let de="";a.value.mSelect.forEach((It,Ie)=>{de+=It.content,Ie!==a.value.mSelect.length-1&&(de+=", ")}),a.operator==="Contains"?ge=`: ${de}`:a.operator==="Does not contains"&&(ge=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${de}`)}else if((g=(f=a.value)==null?void 0:f.number)!=null&&g.content)["=","!=",">","<"].includes(a.operator)?ge=` ${a.operator} ${a.value.number.content}`:a.operator===">="?ge=` \u2265 ${a.value.number.content}`:a.operator==="<="&&(ge=` \u2264 ${a.value.number.content}`);else if((m=(h=a.value)==null?void 0:h.text)!=null&&m.content||(y=(b=a.value)==null?void 0:b.block)!=null&&y.content||(E=(w=a.value)==null?void 0:w.url)!=null&&E.content||(L=(k=a.value)==null?void 0:k.phone)!=null&&L.content||(A=(v=a.value)==null?void 0:v.email)!=null&&A.content){const de=((D=(C=a.value)==null?void 0:C.text)==null?void 0:D.content)||((P=(x=a.value)==null?void 0:x.block)==null?void 0:P.content)||((V=(B=a.value)==null?void 0:B.url)==null?void 0:V.content)||((Q=(X=a.value)==null?void 0:X.phone)==null?void 0:Q.content)||((Pe=(ce=a.value)==null?void 0:ce.email)==null?void 0:Pe.content);["=","Contains"].includes(a.operator)?ge=`: ${de}`:a.operator==="Does not contains"?ge=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${de}`:a.operator==="!="?ge=` ${window.siyuan.languages.filterOperatorIsNot} ${de}`:a.operator==="Starts with"?ge=` ${window.siyuan.languages.filterOperatorStartsWith} ${de}`:a.operator==="Ends with"&&(ge=` ${window.siyuan.languages.filterOperatorEndsWith} ${de}`)}return i+=`<span data-type="setFilter" class="b3-chip${ge?" b3-chip--primary":""}">
    ${s.icon?fe(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${un(s.type)}"></use></svg>`}
    <span class="fn__ellipsis">${s.name}${ge}</span>
</span>`,!0}}),i};return n.filters.forEach(a=>{e+=`<button class="b3-menu__item" draggable="true" data-id="${a.column}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${t(a)}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goConfig">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${e}
<button class="b3-menu__item${n.filters.length===n.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${e?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},aw=n=>{const e=new Kt("av-add-sort");n.data.view.columns.forEach(t=>{let a=!1;n.data.view.sorts.find(i=>{if(i.column===t.id)return a=!0,!0}),a||e.addItem({label:t.name,iconHTML:t.icon?fe(t.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${un(t.type)}"></use></svg>`,click:()=>{const i=Object.assign([],n.data.view.sorts);n.data.view.sorts.push({column:t.id,order:"ASC"}),G(n.protyle,[{action:"setAttrViewSorts",avID:n.data.id,data:n.data.view.sorts}],[{action:"setAttrViewSorts",avID:n.data.id,data:i}]),n.menuElement.innerHTML=Vi(n.data.view.columns,n.data.view.sorts),Ui(n.protyle,n.menuElement,n.data),Ve(n.menuElement,n.tabRect.right-n.menuElement.clientWidth,n.tabRect.bottom,n.tabRect.height)}})}),e.open({x:n.rect.left,y:n.rect.bottom,h:n.rect.height})},Ui=(n,e,t)=>{e.querySelectorAll("select").forEach(a=>{a.addEventListener("change",()=>{const i=a.parentElement.getAttribute("data-id"),s=JSON.parse(JSON.stringify(t.view.sorts));a.previousElementSibling.classList.contains("b3-menu__icon")?t.view.sorts.find(o=>{if(o.column===i)return o.column=a.value,a.parentElement.setAttribute("data-id",a.value),!0}):t.view.sorts.find(o=>o.column===i).order=a.value,G(n,[{action:"setAttrViewSorts",avID:t.id,data:t.view.sorts}],[{action:"setAttrViewSorts",avID:t.id,data:s}])})})},Vi=(n,e)=>{let t="";const a=i=>{let s="";return n.forEach(o=>{s+=`<option value="${o.id}" ${o.id===i?"selected":""}>${o.name}</option>`}),s};return e.forEach(i=>{t+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${a(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goConfig">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${t}
<button class="b3-menu__item${e.length===n.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${t?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},iw=(n,e)=>{var t,a,i,s;let o=!0,l;e.forEach(u=>{n.rows.find(d=>{if(u.parentElement.dataset.id===d.id)return d.cells.find(f=>{if(f.id===u.dataset.id)return(!f.value||!f.value.date||!f.value.date.hasEndDate)&&(o=!1),l=f,!0}),!0})}),l||(o=!1);let r="";(a=(t=l==null?void 0:l.value)==null?void 0:t.date)!=null&&a.isNotEmpty&&(r=ue(l.value.date.content).format("YYYY-MM-DDTHH:mm"));let c="";return(s=(i=l==null?void 0:l.value)==null?void 0:i.date)!=null&&s.isNotEmpty2&&(c=ue(l.value.date.content2).format("YYYY-MM-DDTHH:mm")),`<div class="b3-menu__items">
<div>
    <input type="datetime-local" value="${r}" class="b3-text-field fn__size200"><br>
    <input type="datetime-local" value="${c}" style="margin-top: 8px" class="b3-text-field fn__size200${o?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span>${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch fn__flex-center"${o?" checked":""}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},sw=n=>{const e=n.menuElement.querySelectorAll(".b3-text-field");e[0].addEventListener("change",()=>{hl({cellElements:n.cellElements,data:n.data,protyle:n.protyle,value:{isNotEmpty:e[0].value!=="",content:new Date(e[0].value).getTime()}})}),e[1].addEventListener("change",()=>{hl({cellElements:n.cellElements,data:n.data,protyle:n.protyle,value:{isNotEmpty2:e[1].value!=="",content2:new Date(e[1].value).getTime()}})});const t=n.menuElement.querySelector(".b3-switch");t.addEventListener("change",()=>{t.checked?e[1].classList.remove("fn__none"):e[1].classList.add("fn__none"),hl({cellElements:n.cellElements,data:n.data,protyle:n.protyle,value:{hasEndDate:t.checked}})})},hl=n=>{let e;Array.from(n.cellElements[0].parentElement.querySelectorAll(".av__cell")).find((s,o)=>{if(s.dataset.id===n.cellElements[0].dataset.id)return e=o,!0});const t=n.cellElements[0].dataset.colId,a=[],i=[];n.cellElements.forEach(s=>{let o,l;const r=s.parentElement.dataset.id;n.data.view.rows.find(c=>{if(c.id===r)return typeof e=="number"?(o=c.cells[e],o.id=s.dataset.id,o.value||(o.value={})):o=c.cells.find(u=>{if(s.dataset.id===u.id)return!0}),l=Object.assign({},o.value.date),o.value.date=Object.assign(o.value.date||{isNotEmpty2:!1,isNotEmpty:!1},n.value),!0}),a.push({action:"updateAttrViewCell",id:o.id,keyID:t,rowID:r,avID:n.data.id,data:o.value}),i.push({action:"updateAttrViewCell",id:o.id,keyID:t,rowID:r,avID:n.data.id,data:{date:l}}),s.classList.contains("custom-attr__avvalue")?s.innerHTML=Ia(o.value):kn(s)}),G(n.protyle,a,i)},dn=n=>{n.menu.addItem({iconHTML:"",label:kf(n.format),click(){G(n.protyle,[{action:"updateAttrViewColNumberFormat",id:n.colId,avID:n.avID,format:n.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:n.colId,avID:n.avID,format:n.oldFormat,type:"number"}]),n.avPanelElement.remove()}})},ow=n=>{const e=new Kt("av-col-format-number");dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"commas",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"percent",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"usDollar",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"yuan",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"euro",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"pound",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"yen",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"ruble",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"rupee",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"won",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"canadianDollar",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement}),dn({menu:e,protyle:n.protyle,colId:n.colId,avID:n.avID,format:"franc",oldFormat:n.oldFormat,avPanelElement:n.avPanelElement});const t=n.element.getBoundingClientRect();e.open({x:t.left,y:t.bottom,h:t.height,w:t.width,isLeft:!0})},kf=n=>{switch(n){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},Ic=n=>{(0,vt.addScript)(`${p.Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{const e=document.createElement("ul");e.innerHTML=`<li><img src="${n}"></li>`,window.siyuan.viewer=new Viewer(e,{title:[1,(t,a)=>{let i=t.alt;return i||(i=t.src.substring(t.src.lastIndexOf("/")+1)),i=i.substring(0,i.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${i} [${a.naturalWidth} \xD7 ${a.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},Sf=(n,e)=>{(0,vt.addScript)(`${p.Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{_("/api/asset/getDocImageAssets",{id:e},t=>{const a=document.createElement("ul");let i="",s=-1;t.data.forEach((o,l)=>{o&&(i+=`<li><img src="${o}"></li>`,s===-1&&(n.endsWith(encodeURI(o))||n.endsWith(o))&&(s=l))}),a.innerHTML=i,window.siyuan.viewer=new Viewer(a,{title:[1,(o,l)=>{let r=o.alt;return r||(r=o.src.substring(o.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,initialViewIndex:s,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},Lf=n=>{n.menuElement.querySelector("input").addEventListener("change",e=>{e.target.files.length!==0&&da(n.protyle,e.target.files,e.target,t=>{const a=JSON.parse(t),i=[];Object.keys(a.data.succMap).forEach(s=>{i.push({name:s,content:a.data.succMap[s],type:p.Constants.SIYUAN_ASSETS_IMAGE.includes(xe().extname(a.data.succMap[s]).toLowerCase())?"image":"file"})}),zi({protyle:n.protyle,data:n.data,cellElements:n.cellElements,type:"addUpdate",addUpdateValue:i})})})},Cf=(n,e)=>{var t;const a=e[0].dataset.id,i=e[0].parentElement.dataset.id;let s;n.rows.find(l=>{if(l.id===i)return l.cells.find(r=>{if(r.id===a)return s=r,!0}),!0});let o="";return(t=s==null?void 0:s.value)!=null&&t.mAsset&&s.value.mAsset.forEach(l=>{if(!l.content)return;let r;l.type==="image"?r=`<span data-type="openAssetItem" class="fn__flex-1">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${l.content}"/>
</span>`:r=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label" style="max-width: 360px">${l.name}</span>`,o+=`<button class="b3-menu__item" draggable="true" data-name="${l.name}" data-type="${l.type}" data-content="${l.content}">
<svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
${r}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${o}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},zi=n=>{let e;Array.from(n.cellElements[0].parentElement.querySelectorAll(".av__cell")).find((l,r)=>{if(l.dataset.id===n.cellElements[0].dataset.id)return e=r,!0});const t=n.cellElements[0].dataset.colId,a=[],i=[];let s=[];n.cellElements.forEach((l,r)=>{let c;const u=l.parentElement.dataset.id;n.data.view.rows.find(f=>{if(f.id===u)return typeof e=="number"?(c=f.cells[e],c.id=l.dataset.id,(!c.value||!c.value.mAsset)&&(c.value={mAsset:[]})):c=f.cells.find(g=>{if(g.id===l.dataset.id)return!0}),!0});const d=Object.assign([],c.value.mAsset);n.type==="remove"?r===0?(c.value.mAsset.find((f,g)=>{if(f.content===n.removeContent)return c.value.mAsset.splice(g,1),!0}),s=c.value.mAsset):c.value.mAsset=s:n.type==="addUpdate"?r===0?(n.addUpdateValue.forEach(f=>{if(!f.content)return;c.value.mAsset.find(h=>{if(h.content===f.content)return h.name=f.name,h.type=f.type,!0})||(f.type==="file"&&!f.name&&(f.name=f.content),c.value.mAsset.push(f))}),s=c.value.mAsset):c.value.mAsset=s:c.value.mAsset=n.replaceValue,a.push({action:"updateAttrViewCell",id:c.id,keyID:t,rowID:u,avID:n.data.id,data:c.value}),i.push({action:"updateAttrViewCell",id:c.id,keyID:t,rowID:u,avID:n.data.id,data:{mAsset:d}}),l.classList.contains("custom-attr__avvalue")?l.innerHTML=Ia(c.value):kn(l)}),G(n.protyle,a,i);const o=document.querySelector(".av__panel > .b3-menu");if(o){o.innerHTML=Cf(n.data.view,n.cellElements),Lf({protyle:n.protyle,data:n.data,menuElement:o,cellElements:n.cellElements});const l=(n.cellElements[0].classList.contains("custom-attr__avvalue")?n.cellElements[0]:n.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${n.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{Ve(o,l.left,l.bottom,l.height)},p.Constants.TIMEOUT_LOAD)}},lw=(n,e,t,a)=>{const i=a.dataset.content,s=a.dataset.type,o=new Kt("av-asset-edit",()=>{!l||!l.value||l.value===a.dataset.name||zi({protyle:n,data:e,cellElements:t,type:"addUpdate",addUpdateValue:[{content:i,name:l.value,type:s}]})});if(o.isOpen)return;s==="file"?o.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,T.tq)()?"200":"360"}px" class="b3-text-field"></textarea>`}):o.addItem({icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){Ic(i)}}),o.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){zi({protyle:n,data:e,cellElements:t,type:"remove",removeContent:i})}}),Js(n?n.app:window.siyuan.ws.app,i,!1,!0);const l=o.element.querySelector("textarea");l&&(l.value=a.dataset.name);const r=a.getBoundingClientRect();o.open({x:r.right,y:r.top,w:r.width,h:r.height})},rw=(n,e,t,a)=>{const i=new Kt("av-asset-link",()=>{const o=i.element.querySelectorAll("textarea");o[0].value&&zi({protyle:n,data:e,cellElements:t,type:"addUpdate",addUpdateValue:[{type:"file",name:o[1].value,content:o[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,T.tq)()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.link}"></textarea>`}),i.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,T.tq)()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.title}"></textarea>`});const s=a.getBoundingClientRect();i.open({x:s.right,y:s.bottom,w:a.parentElement.clientWidth+8,h:s.height})},$a=n=>{let e=document.querySelector(".av__panel");if(e){e.remove();return}window.siyuan.menus.menu.remove();const t=n.blockElement.getAttribute("data-av-id");_("/api/av/renderAttributeView",{id:t},a=>{var i;const s=a.data;let o;n.type==="config"?o=xf(s.view):n.type==="properties"?o=ti(s.view):n.type==="sorts"?o=Vi(s.view.columns,s.view.sorts):n.type==="filters"?o=Da(s.view):n.type==="select"?o=Fi(s.view,n.cellElements):n.type==="asset"?o=Cf(s.view,n.cellElements):n.type==="edit"?o=fa({protyle:n.protyle,data:s,colId:n.colId}):n.type==="date"&&(o=iw(s.view,n.cellElements)),document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${o}</div>
</div>`),e=document.querySelector(".av__panel");const l=e.lastElementChild,r=(i=n.blockElement.querySelector(".layout-tab-bar"))==null?void 0:i.getBoundingClientRect();if(["select","date","asset"].includes(n.type)){const u=n.cellElements[n.cellElements.length-1].getBoundingClientRect();if(n.type==="select"?qi(n.protyle,s,l,n.cellElements):n.type==="date"?sw({protyle:n.protyle,data:s,menuElement:l,cellElements:n.cellElements}):n.type==="asset"&&(Lf({protyle:n.protyle,data:s,menuElement:l,cellElements:n.cellElements}),setTimeout(()=>{Ve(l,u.left,u.bottom,u.height)},p.Constants.TIMEOUT_LOAD)),["select","date"].includes(n.type)){const d=l.querySelector("input");d.select(),d.focus(),Ve(l,u.left,u.bottom,u.height)}}else Ve(l,r.right-l.clientWidth,r.bottom,r.height),n.type==="sorts"?Ui(n.protyle,l,s):n.type==="edit"&&pa({protyle:n.protyle,data:s,menuElement:l});e.addEventListener("dragstart",u=>{window.siyuan.dragElement=u.target,window.siyuan.dragElement.style.opacity=".1"}),e.addEventListener("drop",u=>{var d,f;window.siyuan.dragElement.style.opacity="";const g=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,n.protyle&&n.protyle.disabled){u.preventDefault(),u.stopPropagation();return}if(!n.protyle&&window.siyuan.config.readonly){u.preventDefault(),u.stopPropagation();return}const h=u.target,m=S(h,"draggable","true");if(!m||!m.classList.contains("dragover__top")&&!m.classList.contains("dragover__bottom"))return;let b="columns";const y=m.classList.contains("dragover__top");if(m.querySelector('[data-type="removeSort"]'))b="sorts";else if(m.querySelector('[data-type="removeFilter"]'))b="filters";else if(m.querySelector('[data-type="editAssetItem"]'))b="assets";else if(m.querySelector('[data-type="setColOption"]')){const L=n.cellElements?n.cellElements[0].dataset.colId:l.querySelector(".b3-menu__item").getAttribute("data-col-id"),v=s.view.columns.find(D=>D.id===L).options,A=Object.assign([],v);let C;v.find((D,x)=>{if(D.name===g.dataset.name)return C=v.splice(x,1)[0],!0}),v.find((D,x)=>{if(D.name===m.dataset.name)return y?v.splice(x,0,C):v.splice(x+1,0,C),!0}),G(n.protyle,[{action:"updateAttrViewColOptions",id:L,avID:s.id,data:v}],[{action:"updateAttrViewColOptions",id:L,avID:s.id,data:A}]),n.cellElements?(l.innerHTML=Fi(s.view,n.cellElements),qi(n.protyle,s,l,n.cellElements)):(l.innerHTML=fa({protyle:n.protyle,data:s,colId:L}),pa({protyle:n.protyle,data:s,menuElement:l}));return}const w=g.dataset.id,E=m.dataset.id;if(b==="sorts"){const L=s.view.sorts,v=Object.assign([],L);let A;L.find((C,D)=>{if(C.column===w)return A=L.splice(D,1)[0],!0}),L.find((C,D)=>{if(C.column===E)return y?L.splice(D,0,A):L.splice(D+1,0,A),!0}),G(n.protyle,[{action:"setAttrViewSorts",avID:t,data:L}],[{action:"setAttrViewSorts",avID:t,data:v}]),l.innerHTML=Vi(s.view.columns,s.view.sorts),Ui(n.protyle,l,s);return}if(b==="filters"){const L=s.view.filters,v=Object.assign([],L);let A;L.find((C,D)=>{if(C.column===w)return A=L.splice(D,1)[0],!0}),L.find((C,D)=>{if(C.column===E)return y?L.splice(D,0,A):L.splice(D+1,0,A),!0}),G(n.protyle,[{action:"setAttrViewFilters",avID:t,data:L}],[{action:"setAttrViewFilters",avID:t,data:v}]),l.innerHTML=Da(s.view);return}if(b==="assets"){y?m.before(g):m.after(g);const L=[];Array.from(m.parentElement.children).forEach(v=>{v.dataset.content&&L.push({content:v.dataset.content,name:v.dataset.name,type:v.dataset.type})}),zi({protyle:n.protyle,data:s,cellElements:n.cellElements,type:"replace",replaceValue:L});return}G(n.protyle,[{action:"sortAttrViewCol",avID:t,previousID:(m.classList.contains("dragover__top")?(d=m.previousElementSibling)==null?void 0:d.getAttribute("data-id"):m.getAttribute("data-id"))||"",id:w}],[{action:"sortAttrViewCol",avID:t,previousID:((f=g.previousElementSibling)==null?void 0:f.getAttribute("data-id"))||"",id:w}]);let k;s.view.columns.find((L,v)=>{if(L.id===w)return k=s.view.columns.splice(v,1)[0],!0}),s.view.columns.find((L,v)=>{if(L.id===E)return y?s.view.columns.splice(v,0,k):s.view.columns.splice(v+1,0,k),!0}),l.innerHTML=ti(s.view)});let c;e.addEventListener("dragover",u=>{const d=u.target,f=S(d,"draggable","true");if(!(!f||f.isSameNode(window.siyuan.dragElement))){if(u.preventDefault(),c&&f.isSameNode(c)){const g=f.getBoundingClientRect();u.clientY>g.top+g.height/2?f.classList.add("dragover__bottom"):f.classList.add("dragover__top");return}c=f}}),e.addEventListener("dragleave",u=>{const d=u.target,f=S(d,"draggable","true");f&&f.classList.remove("dragover__top","dragover__bottom")}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("click",u=>{let d=u.target;for(;d&&!d.isSameNode(e);){const f=d.dataset.type;if(f==="close"){n.protyle.toolbar.subElement.className.includes("fn__none")?e.remove():ne(["util"],n.protyle),window.siyuan.menus.menu.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="goConfig"){l.innerHTML=xf(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="goProperties"){l.innerHTML=ti(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="goSorts"){l.innerHTML=Vi(s.view.columns,s.view.sorts),Ui(n.protyle,l,s),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="removeSorts"){G(n.protyle,[{action:"setAttrViewSorts",avID:t,data:[]}],[{action:"setAttrViewSorts",avID:t,data:s.view.sorts}]),s.view.sorts=[],l.innerHTML=Vi(s.view.columns,s.view.sorts),Ui(n.protyle,l,s),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="addSort"){aw({data:s,rect:d.getBoundingClientRect(),menuElement:l,tabRect:r,avId:t,protyle:n.protyle}),u.preventDefault(),u.stopPropagation();break}else if(f==="removeSort"){const g=Object.assign([],s.view.sorts);s.view.sorts.find((h,m)=>{if(h.column===d.parentElement.dataset.id)return s.view.sorts.splice(m,1),!0}),G(n.protyle,[{action:"setAttrViewSorts",avID:t,data:s.view.sorts}],[{action:"setAttrViewSorts",avID:t,data:g}]),l.innerHTML=Vi(s.view.columns,s.view.sorts),Ui(n.protyle,l,s),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="goFilters"){l.innerHTML=Da(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="removeFilters"){G(n.protyle,[{action:"setAttrViewFilters",avID:t,data:[]}],[{action:"setAttrViewFilters",avID:t,data:s.view.filters}]),s.view.filters=[],l.innerHTML=Da(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="addFilter"){nw({data:s,rect:d.getBoundingClientRect(),menuElement:l,tabRect:r,avId:t,protyle:n.protyle}),u.preventDefault(),u.stopPropagation();break}else if(f==="removeFilter"){window.siyuan.menus.menu.remove();const g=Object.assign([],s.view.filters);s.view.filters.find((h,m)=>{if(h.column===d.parentElement.dataset.id)return s.view.filters.splice(m,1),!0}),G(n.protyle,[{action:"setAttrViewFilters",avID:t,data:s.view.filters}],[{action:"setAttrViewFilters",avID:t,data:g}]),l.innerHTML=Da(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="setFilter"){s.view.filters.find(g=>{if(g.column===d.parentElement.parentElement.dataset.id)return Tc({filter:g,protyle:n.protyle,data:s,target:d}),!0}),u.preventDefault(),u.stopPropagation();break}else if(f==="numberFormat"){ow({avPanelElement:e,element:d,protyle:n.protyle,oldFormat:d.dataset.format,colId:l.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:t}),u.preventDefault(),u.stopPropagation();break}else if(f==="newCol"){e.remove(),yf(n.protyle,n.blockElement).open({x:r.right,y:r.bottom,h:r.height,isLeft:!0}),u.preventDefault(),u.stopPropagation();break}else if(f==="update-icon"){const g=d.getBoundingClientRect();ls("","av",{x:g.left,y:g.bottom,h:g.height,w:g.width},h=>{const m=l.querySelector(".b3-menu__item").getAttribute("data-col-id");G(n.protyle,[{action:"setAttrViewColIcon",id:m,avID:t,data:h}],[{action:"setAttrViewColIcon",id:m,avID:t,data:d.dataset.icon}]),d.innerHTML=h?fe(h):`<svg><use xlink:href="#${un(d.dataset.colType)}"></use></svg>`,kn(n.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${m}"]`))}),u.preventDefault(),u.stopPropagation();break}else if(f==="showAllCol"){const g=[],h=[];s.view.columns.forEach(m=>{m.hidden&&(g.push({action:"setAttrViewColHidden",id:m.id,avID:t,data:!1}),h.push({action:"setAttrViewColHidden",id:m.id,avID:t,data:!0}),m.hidden=!1)}),g.length>0&&(G(n.protyle,g,h),l.innerHTML=ti(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height)),u.preventDefault(),u.stopPropagation();break}else if(f==="hideAllCol"){const g=[],h=[];s.view.columns.forEach(m=>{!m.hidden&&m.type!=="block"&&(g.push({action:"setAttrViewColHidden",id:m.id,avID:t,data:!0}),h.push({action:"setAttrViewColHidden",id:m.id,avID:t,data:!1}),m.hidden=!0)}),g.length>0&&(G(n.protyle,g,h),l.innerHTML=ti(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height)),u.preventDefault(),u.stopPropagation();break}else if(f==="editCol"){l.innerHTML=fa({protyle:n.protyle,data:s,colId:d.parentElement.dataset.id}),pa({protyle:n.protyle,data:s,menuElement:l}),u.preventDefault(),u.stopPropagation();break}else if(f==="hideCol"){const g=l.querySelector('[data-type="goProperties"]'),h=g?l.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");G(n.protyle,[{action:"setAttrViewColHidden",id:h,avID:t,data:!0}],[{action:"setAttrViewColHidden",id:h,avID:t,data:!1}]),s.view.columns.find(m=>m.id===h).hidden=!0,g?(l.innerHTML=fa({protyle:n.protyle,data:s,colId:h}),pa({protyle:n.protyle,data:s,menuElement:l})):l.innerHTML=ti(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="showCol"){const g=l.querySelector('[data-type="goProperties"]'),h=g?l.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");G(n.protyle,[{action:"setAttrViewColHidden",id:h,avID:t,data:!1}],[{action:"setAttrViewColHidden",id:h,avID:t,data:!0}]),s.view.columns.find(m=>m.id===h).hidden=!1,g?(l.innerHTML=fa({protyle:n.protyle,data:s,colId:h}),pa({protyle:n.protyle,data:s,menuElement:l})):l.innerHTML=ti(s.view),Ve(l,r.right-l.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="duplicateCol"){const g=l.querySelector(".b3-menu__item").getAttribute("data-col-id"),h=s.view.columns.find(m=>m.id===g);Ep({protyle:n.protyle,type:h.type,avID:t,colId:g,icon:h.icon,newValue:h.name}),e.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="removeCol"){const g=l.querySelector(".b3-menu__item").getAttribute("data-col-id"),h=s.view.columns.find(m=>m.id===g);G(n.protyle,[{action:"removeAttrViewCol",id:g,avID:t}],[{action:"addAttrViewCol",name:h.name,avID:t,type:h.type,id:g}]),Pf(n.blockElement,g),e.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="setColOption"){tw(n.protyle,s,d,n.cellElements),u.preventDefault(),u.stopPropagation();break}else if(f==="addColOptionOrCell"){vf(n.protyle,s,n.cellElements,d,l),window.siyuan.menus.menu.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="removeCellOption"){_f(n.protyle,s,n.cellElements,d.parentElement),u.preventDefault(),u.stopPropagation();break}else if(f==="addAssetLink"){rw(n.protyle,s,n.cellElements,d),u.preventDefault(),u.stopPropagation();break}else if(f==="addAssetExist"){const g=d.getBoundingClientRect();n.protyle.toolbar.showAssets(n.protyle,{x:g.right,y:g.bottom,w:d.parentElement.clientWidth+8,h:g.height},h=>{let m;p.Constants.SIYUAN_ASSETS_IMAGE.includes(xe().extname(h).toLowerCase())?m={type:"image",content:h,name:""}:m={type:"file",content:h,name:xe().basename(h).substring(0,p.Constants.SIZE_LINK_TEXT_MAX)},zi({protyle:n.protyle,data:s,cellElements:n.cellElements,type:"addUpdate",addUpdateValue:[m]}),ne(["util"],n.protyle)}),u.preventDefault(),u.stopPropagation();break}else if(f==="openAssetItem"){const g=d.parentElement.dataset.content,h=xe().extname(g);go(g)&&[".pdf"].concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(h)&&(h!==".pdf"||h===".pdf"&&!g.startsWith("file://"))?as(n.protyle.app,g.trim(),parseInt((0,T.on)("page",g)),"right"):p.Constants.SIYUAN_ASSETS_IMAGE.includes(h)?Ic(g):window.open(g),u.preventDefault(),u.stopPropagation();break}else if(f==="editAssetItem"){lw(n.protyle,s,n.cellElements,d.parentElement),u.preventDefault(),u.stopPropagation();break}else if(f==="clearDate"){hl({cellElements:n.cellElements,data:s,protyle:n.protyle,value:{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1}}),e.remove(),u.preventDefault(),u.stopPropagation();break}d=d.parentElement}})})},ti=n=>{let e="",t="";return n.columns.forEach(a=>{a.hidden?t+=`<button class="b3-menu__item" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${a.icon?fe(a.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${un(a.type)}"></use></svg>`}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__action" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`:e+=`<button class="b3-menu__item" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${a.icon?fe(a.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${un(a.type)}"></use></svg>`}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`}),t&&(t=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${t}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goConfig">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.attr}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${e}
${t}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},xf=n=>`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="goProperties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
    <span class="b3-menu__accelerator">${n.columns.filter(e=>!e.hidden).length}/${n.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${n.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${n.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.pageCount}</span>
    <span class="b3-menu__accelerator">50</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
</div>`,cw=n=>{if(!n.calc||!n.calc.result)return"";let e=n.calc.result.number;(n.calc.operator==="Earliest"||n.calc.operator==="Latest"||n.calc.operator==="Range"&&["date","created","updated"].includes(n.type))&&(e=n.calc.result[n.type]);let t="";switch(n.calc.operator){case"Count all":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountAll}`;break;case"Count values":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountValues}`;break;case"Count unique values":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountUniqueValues}`;break;case"Count empty":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountEmpty}`;break;case"Count not empty":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountNotEmpty}`;break;case"Percent empty":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultPercentEmpty}`;break;case"Percent not empty":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultPercentNotEmpty}`;break;case"Sum":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultSum}`;break;case"Average":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultAverage}`;break;case"Median":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMedian}`;break;case"Min":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMin}`;break;case"Max":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMax}`;break;case"Range":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultRange}`;break;case"Earliest":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcOperatorEarliest}`;break;case"Latest":t=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcOperatorLatest}`;break}return t},Os=(n,e)=>{let t;return typeof e=="string"?n==="number"?e?t={type:n,number:{content:parseFloat(e),isNotEmpty:!0}}:t={type:n,number:{isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(n)?t={type:n,[n]:{content:e}}:n==="mSelect"||n==="select"?t={type:n,mSelect:[{content:e,color:""}]}:["date","created","updated"].includes(n)&&e===""&&(t={type:n,[n]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1}}):n==="mSelect"||n==="select"?t={type:n,mSelect:e}:["date","created","updated"].includes(n)?t={type:n,[n]:e}:n==="mAsset"&&(t={type:n,mAsset:e}),t},Ft=n=>{n.menu.addItem({iconHTML:"",label:n.label,click(){G(n.protyle,[{action:"setAttrViewColCalc",avID:n.avId,id:n.colId,data:{operator:n.operator}}],[{action:"setAttrViewColCalc",avID:n.avId,id:n.colId,data:{operator:n.oldOperator}}])}})},dw=(n,e)=>{const t=M(e);if(!t)return;e.parentElement.classList.add("av__row--show");const a=new Kt("av-calc",()=>{e.parentElement.classList.remove("av__row--show")});if(a.isOpen)return;const i=e.dataset.dtype,s=e.dataset.colId,o=t.dataset.avId,l=e.dataset.operator;Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"",label:window.siyuan.languages.calcOperatorNone}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Count all",label:window.siyuan.languages.calcOperatorCountAll}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Count values",label:window.siyuan.languages.calcOperatorCountValues}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Count unique values",label:window.siyuan.languages.calcOperatorCountUniqueValues}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Count empty",label:window.siyuan.languages.calcOperatorCountEmpty}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Count not empty",label:window.siyuan.languages.calcOperatorCountNotEmpty}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Percent empty",label:window.siyuan.languages.calcOperatorPercentEmpty}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Percent not empty",label:window.siyuan.languages.calcOperatorPercentNotEmpty}),["number","template"].includes(i)?(Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Sum",label:window.siyuan.languages.calcOperatorSum}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Average",label:window.siyuan.languages.calcOperatorAverage}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Median",label:window.siyuan.languages.calcOperatorMedian}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Min",label:window.siyuan.languages.calcOperatorMin}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Max",label:window.siyuan.languages.calcOperatorMax}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Range",label:window.siyuan.languages.calcOperatorRange})):["date","created","updated"].includes(i)&&(Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Earliest",label:window.siyuan.languages.calcOperatorEarliest}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Latest",label:window.siyuan.languages.calcOperatorLatest}),Ft({menu:a,protyle:n,colId:s,avId:o,oldOperator:l,operator:"Range",label:window.siyuan.languages.calcOperatorRange}));const r=e.getBoundingClientRect();a.open({x:r.left,y:r.bottom,h:r.height})},ni=(n,e,t=!0)=>{if(!t){const i=n.querySelector(".av__scroll"),s=i.getBoundingClientRect();s.left>e.left?i.scrollLeft=i.scrollLeft+e.left-s.left:s.right<e.right&&(i.scrollLeft=i.scrollLeft+e.right-s.right)}const a=n.querySelector(".av__header").getBoundingClientRect();if(a.bottom>e.top){const i=$(n,"protyle-content",!0);i&&(i.scrollTop=i.scrollTop+e.top-a.bottom)}else{const i=n.querySelector(".av__row--footer").getBoundingClientRect();if(i.top<e.bottom){const s=$(n,"protyle-content",!0);s&&(s.scrollTop=s.scrollTop+e.bottom-i.top)}}},Pa=(n,e,t)=>{if(t||(t=e[0].parentElement.parentElement.firstElementChild.querySelector(`[data-col-id="${e[0].getAttribute("data-col-id")}"]`).getAttribute("data-dtype")),t==="updated"||t==="created"||t==="block"&&(e.length>1||!e[0].getAttribute("data-detached")))return;const a=M(e[0]);let i=e[0].getBoundingClientRect();a&&ni(a,i),i=e[0].getBoundingClientRect();let s="";const o=`style="position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,100)}px;height: ${i.height}px"`;if(["text","url","email","phone","block","template"].includes(t))s=`<textarea ${o} class="b3-text-field">${e[0].firstElementChild.textContent}</textarea>`;else if(t==="number")s=`<input type="number" value="${e[0].firstElementChild.getAttribute("data-content")}" ${o} class="b3-text-field">`;else if(["select","mSelect"].includes(t)&&a){$a({protyle:n,blockElement:a,type:"select",cellElements:e});return}else if(t==="mAsset"&&a){$a({protyle:n,blockElement:a,type:"asset",cellElements:e});return}else if(t==="date"&&a){$a({protyle:n,blockElement:a,type:"date",cellElements:e});return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${s}
</div>`);const l=document.querySelector(".av__mask"),r=l.querySelector(".b3-text-field");r&&(r.select(),r.focus(),a&&t==="template"&&_("/api/av/renderAttributeView",{id:a.dataset.avId},c=>{c.data.view.columns.find(u=>{if(u.id===e[0].dataset.colId)return r.value=u.template,r.dataset.template=u.template,!0})}),r.addEventListener("blur",()=>{Af(n,t,e)}),r.addEventListener("keydown",c=>{c.isComposing||(c.key==="Escape"||c.key==="Enter"&&!c.shiftKey&&!ye(c))&&(Af(n,t,e),c.preventDefault(),c.stopPropagation())})),l.addEventListener("click",c=>{c.target.classList.contains("av__mask")&&(l==null||l.remove())})},Af=(n,e,t)=>{if(!document.contains(t[0])&&t.length===1){const c=t[0].parentElement.dataset.avid;if(c)t[0]=n.wysiwyg.element.querySelector(`[data-av-id="${c}"] .av__row--add`).previousElementSibling.querySelector('[data-detached="true"]');else if(t[0]=n.wysiwyg.element.querySelector(`.av__cell[data-id="${t[0].dataset.id}"]`),!t[0])return}if(t.length===1&&t[0].dataset.detached==="true"&&!t[0].parentElement.dataset.id)return;const a=M(t[0]);if(!a)return;const i=document.querySelector(".av__mask"),s=[],o=[],l=a.getAttribute("data-av-id"),r=a.getAttribute("data-node-id");if(e==="template"){const c=t[0].getAttribute("data-col-id"),u=i.querySelector(".b3-text-field");u.value!==u.dataset.template&&G(n,[{action:"updateAttrViewColTemplate",id:c,avID:l,data:u.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:c,avID:l,data:u.dataset.template,type:"template"}])}else t.forEach(c=>{const u=$(c,"av__row");if(!u)return;const d=u.getAttribute("data-id"),f=c.getAttribute("data-id"),g=c.getAttribute("data-col-id"),h={content:i.querySelector(".b3-text-field").value},m={content:e==="block"?c.firstElementChild.textContent.trim():c.textContent.trim()};e==="number"&&(m.content=parseFloat(m.content),m.isNotEmpty=typeof m.content=="number"&&!isNaN(m.content),h.content=parseFloat(h.content),h.isNotEmpty=typeof h.content=="number"&&!isNaN(h.content)),!(0,T.MK)(h,m)&&(s.push({action:"updateAttrViewCell",id:f,avID:l,keyID:g,rowID:d,data:{[e]:h}},{action:"doUpdateUpdated",id:r,data:ue().format("YYYYMMDDHHmmss")}),o.push({action:"updateAttrViewCell",id:f,avID:l,keyID:g,rowID:d,data:{[e]:m}},{action:"doUpdateUpdated",id:r,data:a.getAttribute("updated")}),kn(c))});s.length>0&&G(n,s,o),t[0].classList.add("av__cell--select"),a&&we(a),setTimeout(()=>{i.remove()})},Vn=(n,e)=>{const t=n.parentElement,a=n.querySelector("use");t.classList.contains("av__row--header")||e==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"?t.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck"),i.parentElement.classList.remove("av__row--select")}):t.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck"),i.parentElement.classList.add("av__row--select")}):e==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&e==="toggle"?(n.parentElement.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(e==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&e==="toggle")&&(n.parentElement.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),we(M(t)),Wi(t)},Wi=n=>{const e=M(n);if(!e)return;const t=n.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=n.parentElement.childElementCount-3-t,i=n.parentElement.firstElementChild,s=i.querySelector("use"),o=e.querySelector(".av__counter"),l=e.querySelector(".av__header");if(a===0&&n.parentElement.childElementCount-3!==0)i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck");else if(a===n.parentElement.childElementCount-3){i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck"),o.classList.add("fn__none"),l.style.position="";return}else a>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));o.classList.remove("fn__none"),o.innerHTML=`${t} selected`,l.style.position="sticky"},Dc=(n,e,t,a)=>{const i=n.querySelector(`.av__row[data-id="${t}"]`)||n.querySelector(".av__row--header");let s="";i.querySelectorAll(".av__cell").forEach(l=>{s+=`<div class="av__cell" style="width: ${l.style.width}" ${l.getAttribute("data-block-id")?' data-detached="true"':""}><span class="av__pulse"></span></div>`});let o="";new Array(e).fill(1).forEach(()=>{o+=`<div class="av__row" data-avid="${a}">
    <div style="width: 24px"></div>
    ${s}
</div>`}),i.insertAdjacentHTML("afterend",o)};class uw{constructor(e=""){this.eventTarget=document.appendChild(document.createComment(e))}on(e,t){this.eventTarget.addEventListener(e,t)}once(e,t){this.eventTarget.addEventListener(e,t,{once:!0})}off(e,t){this.eventTarget.removeEventListener(e,t)}emit(e,t){return this.eventTarget.dispatchEvent(new CustomEvent(e,{detail:t}))}}const Qt=n=>{const e=new jb;n.detail.menu=e,n.plugins.forEach(t=>{t.eventBus.emit(n.type,n.detail)}),e.menus.length>0&&(n.separatorPosition==="top"&&window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:e.menus}).element),n.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new I({type:"separator"}).element))},ai=n=>{if(!n)return"";const e=xe().extname(n).toLowerCase();return p.Constants.SIYUAN_ASSETS_IMAGE.includes(e)?`<img style="max-height: 100%" src="${n}">`:p.Constants.SIYUAN_ASSETS_AUDIO.includes(e)?`<audio style="max-width: 100%" controls="controls" src="${n}"></audio>`:p.Constants.SIYUAN_ASSETS_VIDEO.includes(e)?`<video style="max-width: 100%" controls="controls" src="${n}"></video>`:n},fw=()=>{Ye().asset.forEach(n=>{const e=n.pdfObject;if(!e)return;const{pdfDocument:t,pdfViewer:a}=e;if(!t)return;const i=n.element.querySelector("#viewerContainer");if(i.clientHeight===0)return;if(i){const o=i.getAttribute("data-scrolltop");o&&(i.scrollTo(0,parseInt(o)),i.removeAttribute("data-scrolltop"))}const s=a.currentScaleValue;(s==="auto"||s==="page-fit"||s==="page-width")&&(a.currentScaleValue=s),a.update()})},Tf=(n,e,t,a)=>{let i="";if(p.Constants.SIYUAN_ASSETS_AUDIO.includes(n))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${ue().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${e}" data-src="${e}"></audio>${p.Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`;else if(p.Constants.SIYUAN_ASSETS_IMAGE.includes(n)){let s="";e.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${e}" data-src="${e}" alt="${t}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else p.Constants.SIYUAN_ASSETS_VIDEO.includes(n)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${ue().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${p.Constants.ZWSP}<video controls="controls" src="${e}" data-src="${e}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${e}">${a}</span>`;return i},$c=(n,e)=>{const t=[{filter:["\u6A21\u7248","moban","mb","template"],value:p.Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["\u6302\u4EF6","widget","gj","guajian"],value:p.Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:["\u8D44\u6E90","assets","zy","ziyuan"],value:p.Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["\u5F15\u7528\u5757","yinyong","yy","block reference"],value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["\u5D4C\u5165\u5757","qianrukuai","qrk","embed block"],value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["ai chat"],value:p.Constants.ZWSP+5,html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI Chat</span></div>'}];Ub()&&t.push({filter:["\u6570\u636E\u5E93","\u5C5E\u6027\u89C6\u56FE","shujuku","shuxingshitu","sjk","sxst","database","attribute view"],value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`}),[{filter:["\u6587\u6863","\u5B50\u6587\u6863","wendang","wd","ziwendang","zwd","xjwd"],value:p.Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.general.newFile.custom)}</span></div>`},{value:"",html:"separator"},{filter:["yijibiaoti","\u4E00\u7EA7\u6807\u9898","yjbt","h1","heading"],value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.heading.heading1.custom)}</span></div>`},{filter:["erjibiaoti","\u4E8C\u7EA7\u6807\u9898","ejbt","h2","heading"],value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.heading.heading2.custom)}</span></div>`},{filter:["sanjibiaoti","\u4E09\u7EA7\u6807\u9898","sjbt","h3","heading"],value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.heading.heading3.custom)}</span></div>`},{filter:["sijibiaoti","\u56DB\u7EA7\u6807\u9898","sjbt","h4","heading"],value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.heading.heading4.custom)}</span></div>`},{filter:["wujibiaoti","\u4E94\u7EA7\u6807\u9898","wjbt","h5","heading"],value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.heading.heading5.custom)}</span></div>`},{filter:["liujibiaoti","\u516D\u7EA7\u6807\u9898","ljbt","h6","heading"],value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.heading.heading6.custom)}</span></div>`},{filter:["\u65E0\u5E8F\u5217\u8868","wuxuliebiao","wxlb","unordered list"],value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span><span class="b3-list-item__meta">*&nbsp;</span></div>`},{filter:["\u6709\u5E8F\u5217\u8868","youxuliebiao","yxlb","ordered list"],value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span><span class="b3-list-item__meta">1.&nbsp;</span></div>`},{filter:["\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb","task list","todo list"],value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.check.custom)}</span></div>`},{filter:["\u5F15\u8FF0","yinshu","ys","bq","blockquote"],value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span><span class="b3-list-item__meta">&gt;</span></div>`},{filter:["\u4EE3\u7801\u5757","daimakuai","dmk","code block"],value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span><span class="b3-list-item__meta">\`\`\`Enter</span></div>`},{filter:["\u8868\u683C","biaoge","bg","table"],value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["\u5206\u5272\u7EBF","\u5206\u9694\u7EBF","fengexian","fgx","divider","thematic","break"],value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:["\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk","math block"],value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",html:"separator"},{filter:["\u8868\u60C5","biaoqing","bq","emoji"],value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:["\u94FE\u63A5","lianjie","lj","link","a"],value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["\u7C97\u4F53","cuti","ct","bold","strong"],value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["\u659C\u4F53","xieti","xt","italic","em"],value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["\u4E0B\u5212\u7EBF","xiahuaxian","xhx","underline"],value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["\u5220\u9664\u7EBF","shanchuxian","scx","strike"],value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["\u6807\u8BB0","biaoji","bj","mark"],value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["\u4E0A\u6807","shangbiao","sb","superscript"],value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["\u4E0B\u6807","xiaobiao","xb","subscript"],value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["\u6807\u7B7E","biaoqian","bq","tag"],value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["\u884C\u5185\u4EE3\u7801","hangneidaima","hndm","inline code"],value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["\u884C\u5185\u6570\u5B66\u516C\u5F0F","hangneishuxuegongshi","hnsxgs","inline math"],value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${ae(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",html:"separator"},{filter:["\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","upload","\u4E0A\u4F20","crtphwj","sc"],value:p.Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${e.options.upload.accept?'multiple="'+e.options.upload.accept+'"':""}></div>`},{filter:["iframe","\u5D4C\u5165\u7F51\u5740","qianruwangzhan","qrwz"],value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["\u63D2\u5165\u56FE\u7247\u94FE\u63A5","insert image link","charutupianlianjie","crtptp"],value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj","insert video url"],value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj","insert audio url"],value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",html:"separator"},{filter:["\u4E94\u7EBF\u8C31","wuxianpu","wxp","staff"],value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["\u56FE\u8868","tubiao","tb","chart"],value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["\u6D41\u7A0B\u56FE","liuchengtu","lct","flow chart"],value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["\u72B6\u6001\u56FE","zhuangtaitu","ztt","graph viz"],value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["\u6D41\u7A0B\u56FE","\u65F6\u5E8F\u56FE","\u7518\u7279\u56FE","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["\u8111\u56FE","naotu","nt","mind map"],value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["\u7EDF\u4E00\u5EFA\u6A21\u8BED\u8A00","tongyijianmoyuyan","tyjmyy","plant uml"],value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",html:"separator"},{filter:["\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys","info style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys","success style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys","warning style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys","error style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["\u79FB\u9664\u6837\u5F0F","yichuyangshi","ycys","remove style"],value:`style${p.Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`}].forEach(i=>{t.push(i)}),t.push({value:"",html:"separator"});let a=!1;return e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{t.push({filter:s.filter,value:`plugin${p.Constants.ZWSP}${i.name}${p.Constants.ZWSP}${s.id}`,html:s.html}),a=!0})}),a||t.pop(),n===""?t:t.filter(i=>i.filter?!!i.filter.find(o=>{if(o.indexOf(n.toLowerCase())>-1)return!0}):!1)},pw=(n,e)=>(e.hint.genLoading(e),_("/api/search/searchTag",{k:n},t=>{const a=[];let i=!1;t.data.tags.forEach(s=>{const o=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`#${o}#`,html:s}),o===t.data.k&&(i=!0)}),t.data.k&&!i&&(a.splice(0,0,{value:`#${t.data.k}#`,html:`${window.siyuan.languages.new} <mark>${De(t.data.k)}</mark>`}),a.length>1&&(a[1].focus=!0)),e.hint.genHTML(a,e,!0,"hint")}),[]),Pc=n=>{let e;n.type==="NodeDocument"&&n.ial.icon?(e=fe(n.ial.icon,"b3-list-item__graphic popover__block",!0),e=e.replace('popover__block"',`popover__block" data-id="${n.id}"`)):e=`<svg class="b3-list-item__graphic popover__block" data-id="${n.id}"><use xlink:href="#${ln(n.type)}"></use></svg>`;let t="";return n.name&&(t+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${n.name}</span></span><span class="fn__space"></span>`),n.alias&&(t+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${n.alias}</span></span><span class="fn__space"></span>`),n.memo&&(t+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${n.memo}</span></span>`),t&&(t=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${t}</div>`),`${t}<div class="b3-list-item__first">
    ${e}
    <span class="b3-list-item__text">${n.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${n.hPath}</div>`},ii=(n,e,t)=>{const a=M(he(e.wysiwyg.element).startContainer);return e.hint.genLoading(e),_("/api/search/searchRefBlock",{k:n,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID,isSquareBrackets:["[[","\u3010\u3010"].includes(e.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const o=Lute.UnEscapeHTMLStr(on(i.data.k));s.push({value:t==="search"?`((newFile "${o}"${p.Constants.ZWSP}'${o}${Lute.Caret}'))`:`((newFile '${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(o=>{let l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText}</span>`;t==="search"&&(l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${n}</span>`),s.push({value:l,html:Pc(o)})}),t==="search"&&(e.hint.splitChar="((",e.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),e.hint.genHTML(s,e,!0,t)}),[]},Yi=(n,e)=>{if(n.endsWith("}}")||n.endsWith("\u300D\u300D"))return[];e.hint.genLoading(e);const t=M(he(e.wysiwyg.element).startContainer);return _("/api/search/searchRefBlock",{k:n,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),id:t?t.getAttribute("data-node-id"):e.block.parentID,rootID:e.block.rootID},a=>{const i=[];a.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:Pc(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),e.hint.genHTML(i,e,!0,"hint")}),[]},If=(n,e,t)=>{_("/api/template/render",{id:e.block.parentID,path:n},a=>{ee(e.toolbar.range);const i=J(t);i&&i.textContent.trim()===""?_t(a.data.content,e,!0):_t(a.data.content,e),e.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),Ke(e,e.wysiwyg.element),yt(e.wysiwyg.element),Ze(e.wysiwyg.element),Ct(e.wysiwyg.element,e),ne(["util"],e)})},Df=(n,e)=>{ee(e.toolbar.range),_t(e.lute.SpinBlockDOM(`<iframe src="/widgets/${n}" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),e,!0),ne(["util"],e)},$f=(n,e)=>{ee(e.toolbar.range);const t=xe().extname(n).toLowerCase(),a=n.startsWith("assets/")?Yh(n):n;_t(Tf(t,n,a,n.startsWith("assets/")?a+t:n),e),ne(["util"],e)},Mc=(n,e,t)=>{if(n==="/")return;const a=pt(n,!0,!0);if(t.block.rootID===a)return;const i=[];let s;const o=e[0].parentElement;let l;if(e.forEach((r,c)=>{c===e.length-1&&r.parentElement&&(s=Oe(r),l=s.nextElementSibling||s.previousElementSibling,s.isSameNode(r)&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)ct(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(t.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{Yt({protyle:t,id:t.block.parent2ID,focusId:t.block.parent2ID})},p.Constants.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!$(o,"block__edit",!0)&&t.block.id===t.block.rootID){const r=Lute.NewNodeID(),c=Nn(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:t.block.parentID}),o.innerHTML=c.outerHTML,we(c)}else l&&we(l);G(t,i)},gw=(n,e)=>{const t=M(e.target);if(!t)return!1;if(e.shiftKey){const w=$(e.target,"av__row");if(w&&!w.classList.contains("av__row--header"))return Vn(w.querySelector(".av__firstcol"),"toggle"),!0}const a=S(e.target,"data-type","copy");if(a)return O(a.previousElementSibling.textContent.trim()),q(window.siyuan.languages.copied),e.preventDefault(),e.stopPropagation(),!0;if(n.disabled)return!1;const i=S(e.target,"data-type","av-header-add");if(i){const w=yf(n,t),E=i.getBoundingClientRect();return w.open({x:E.left,y:E.bottom,h:E.height}),e.preventDefault(),e.stopPropagation(),!0}const s=$(e.target,"av__gutters");if(s){const w=s.getBoundingClientRect();return Nc(n,s.parentElement,{x:w.left,y:w.bottom,w:w.width,h:w.height}),e.preventDefault(),e.stopPropagation(),!0}const o=$(e.target,"av__firstcol");if(o)return window.siyuan.menus.menu.remove(),Vn(o,"toggle"),e.preventDefault(),e.stopPropagation(),!0;if(S(e.target,"data-type","av-header-more"))return $a({protyle:n,blockElement:t,type:"properties"}),e.preventDefault(),e.stopPropagation(),!0;if(S(e.target,"data-type","av-more"))return $a({protyle:n,blockElement:t,type:"config"}),e.preventDefault(),e.stopPropagation(),!0;if(S(e.target,"data-type","av-sort"))return $a({protyle:n,blockElement:t,type:"sorts"}),e.preventDefault(),e.stopPropagation(),!0;if(S(e.target,"data-type","av-filter"))return $a({protyle:n,blockElement:t,type:"filters"}),e.preventDefault(),e.stopPropagation(),!0;const d=$(e.target,"av__celltext--url");if(d){let w=d.textContent.trim();d.dataset.type==="phone"?w="tel:"+w:d.dataset.type==="email"?w="mailto:"+w:d.classList.contains("b3-chip")&&(w=d.dataset.url);const E=xe().extname(w);return go(w)&&[".pdf"].concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(E)&&(E!==".pdf"||E===".pdf"&&!w.startsWith("file://"))?as(n.app,w.trim(),parseInt((0,T.on)("page",w)),"right"):window.open(w),e.preventDefault(),e.stopPropagation(),!0}const f=$(e.target,"av__cellassetimg");if(f)return Ic(f.src),e.preventDefault(),e.stopPropagation(),!0;const g=$(e.target,"av__cellheader");if(g)return kp(n,t,g.parentElement),e.preventDefault(),e.stopPropagation(),!0;const h=S(e.target,"data-type","block-more");if(h)return n.toolbar.range=document.createRange(),n.toolbar.range.selectNodeContents(h),ee(n.toolbar.range),ii(h.previousElementSibling.textContent.trim(),n,"av"),e.preventDefault(),e.stopPropagation(),!0;const m=$(e.target,"av__cell");if(m&&!m.parentElement.classList.contains("av__row--header")){const w=m.parentElement.parentElement.firstElementChild.querySelector(`[data-col-id="${m.getAttribute("data-col-id")}"]`).getAttribute("data-dtype");return w==="updated"||w==="created"||w==="block"&&!m.getAttribute("data-detached")?Vn(m.parentElement.querySelector(".av__firstcol"),"toggle"):(m.parentElement.parentElement.querySelectorAll(".av__row--select").forEach(E=>{E.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),E.classList.remove("av__row--select")}),Wi(m.parentElement),Pa(n,[m])),e.preventDefault(),e.stopPropagation(),!0}const b=$(e.target,"av__calc");if(b)return dw(n,b),e.preventDefault(),e.stopPropagation(),!0;const y=$(e.target,"av__row--add");if(y){const w=t.getAttribute("data-av-id"),E=[Lute.NewNodeID()],k=y.previousElementSibling.getAttribute("data-id")||"";return G(n,[{action:"insertAttrViewBlock",avID:w,previousID:k,srcIDs:E,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:E,avID:w}]),Dc(t,1,k,w),Pa(n,[y.previousElementSibling.querySelector('[data-detached="true"]')],"block"),e.preventDefault(),e.stopPropagation(),!0}return!1},Nc=(n,e,t)=>{var a;if(e.classList.contains("av__row--header"))return!1;const i=M(e);if(!i)return!1;e.classList.contains("av__row--select")||(i.querySelectorAll(".av__row--select").forEach(u=>{u.classList.remove("av__row--select")}),i.querySelectorAll(".av__firstcol use").forEach(u=>{u.setAttribute("xlink:href","#iconUncheck")}));const s=new Kt("av-row-menu");if(s.isOpen)return!0;e.classList.add("av__row--select"),e.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const o=[],l=[],r=i.querySelectorAll(".av__row--select:not(.av__row--header)");r.forEach(u=>{o.push(u.getAttribute("data-id")),l.push(u.querySelector(".av__cell").getAttribute("data-block-id"))}),Wi(e),s.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){const u=r[0].previousElementSibling;G(n,[{action:"removeAttrViewBlock",srcIDs:l,avID:i.getAttribute("data-av-id")}],[{action:"insertAttrViewBlock",avID:i.getAttribute("data-av-id"),previousID:(u==null?void 0:u.getAttribute("data-id"))||"",srcIDs:o}]),r.forEach(d=>{d.remove()}),Wi(u)}}),o.length===1&&(s.addSeparator(),bf(n.app,o[0]),s.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:li(o[0])})),s.addSeparator();const c=[];return e.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(u=>{let d=!1;const f=Array.from(i.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${u.dataset.colId}"]`));u.dataset.dtype==="block"&&f.find(h=>{if(!h.dataset.detached)return d=!0,!0});const g=u.getAttribute("data-dtype");if(!d&&!["updated","created"].includes(g)){const h=u.dataset.icon;c.push({iconHTML:h?fe(h,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${un(g)}"></use></svg>`,label:u.querySelector(".av__celltext").textContent.trim(),click(){Pa(n,f)}})}}),s.addItem({icon:"iconAttr",label:window.siyuan.languages.attr,type:"submenu",submenu:c}),(a=n==null?void 0:n.app)!=null&&a.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-av",detail:{protyle:n,element:i,selectRowElements:r},separatorPosition:"top"}),s.open(t),!0},ml=(n,e)=>{const t=e.getAttribute("data-av-id"),a=e.getAttribute("data-node-id"),i=e.querySelector(".av__title"),s=i.textContent.trim();if(s===i.dataset.title.trim())return;const o=ue().format("YYYYMMDDHHmmss");G(n,[{action:"setAttrViewName",id:t,data:s},{action:"doUpdateUpdated",id:a,data:o}],[{action:"setAttrViewName",id:t,data:i.dataset.title},{action:"doUpdateUpdated",id:a,data:e.getAttribute("updated")}]),e.setAttribute("updated",o),i.dataset.title=s,e.querySelector(".layout-tab-bar .item__text").textContent=s},kn=n=>{n.style.opacity="0.38",n.style.backgroundColor="var(--b3-theme-surface-light)"},Pf=(n,e)=>{n.querySelectorAll(`.av__cell[data-col-id="${e}"]`).forEach(t=>{t.remove()})},_t=(n,e,t=!1,a=!1)=>{var i,s;if(n==="")return;const o=a?e.toolbar.range:he(e.wysiwyg.element);Yd(o);let l;S(o.startContainer,"data-type","NodeTable")&&!t&&(te(o.startContainer,"TABLE")?l=e.lute.BlockDOM2InlineBlockDOM(n):t=!0);let r=M(o.startContainer);if(r||(e.toolbar.range?r=M(e.toolbar.range.startContainer):r=e.wysiwyg.element.firstElementChild),!r)return;if(r.classList.contains("av")){o.deleteContents();const E=R();typeof E=="string"?(o.insertNode(document.createTextNode(E)),o.collapse(!1),ml(e,r)):E.then(k=>{o.insertNode(document.createTextNode(k)),o.collapse(!1),ml(e,r)});return}let c=r.getAttribute("data-node-id");o.insertNode(document.createElement("wbr"));let u=r.outerHTML;const d=r.getAttribute("data-type")==="NodeCodeBlock";if(!t&&(d||e.toolbar.getCurrentType(o).includes("code"))){o.deleteContents(),o.insertNode(document.createTextNode(n.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),o.collapse(!1),o.insertNode(document.createElement("wbr")),d?(J(r).removeAttribute("data-render"),Ze(r)):_e(r,o),r.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(e,c,r.outerHTML,u),setTimeout(()=>{Ge(e,r,!1,"smooth")},p.Constants.TIMEOUT_LOAD);return}const f=[],g=[];if(o.toString()!==""){const E=S(o.commonAncestorContainer,"data-type","inline-math");E?E.remove():(o.startContainer.nodeType===3&&((i=o.startContainer.parentElement.getAttribute("data-type"))==null?void 0:i.indexOf("block-ref"))>-1&&o.startContainer.parentElement.remove(),o.deleteContents()),o.insertNode(document.createElement("wbr")),f.push({action:"update",id:c,data:u}),g.push({action:"update",id:c,data:r.outerHTML})}const h=document.createElement("template");h.innerHTML=l||e.lute.SpinBlockDOM(n)||n;const m=J(r);if(!t&&(h.content.firstChild.nodeType===3||h.content.firstChild.nodeType!==3&&(h.content.firstElementChild.classList.contains("p")&&h.content.childElementCount===1||h.content.firstElementChild.tagName!=="DIV"))){h.content.firstChild.nodeType!==3&&h.content.firstElementChild.classList.contains("p")&&(h.innerHTML=h.content.firstElementChild.firstElementChild.innerHTML.trim());const E=o.startContainer.nodeType===3?o.startContainer.parentElement:o.startContainer;if(E.tagName==="SPAN"&&E.isSameNode(o.endContainer.nodeType===3?o.endContainer.parentElement:o.endContainer)&&h.content.querySelector("span, img")){const v=document.createElement("span"),A=E.attributes;for(let C=0;C<A.length;C++)v.setAttribute(A[C].name,A[C].value);o.setEnd(E.lastChild,E.lastChild.textContent.length),v.append(o.extractContents()),E.after(v),o.setStartBefore(v),o.collapse(!0)}o.insertNode(h.content.cloneNode(!0)),o.collapse(!1),r.setAttribute("updated",ue().format("YYYYMMDDHHmmss"));const k=m?m.innerHTML.trimStart():"";if(m&&(k.startsWith("```")||k.startsWith("~~~")||k.startsWith("\xB7\xB7\xB7")||k.indexOf("\n```")>-1||k.indexOf(`
~~~`)>-1||k.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(k.indexOf(`
`)===-1&&k.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let v=m.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();v.endsWith("\n```")||(v+="\n```");const A=v.indexOf("```")+3;v=v.substring(0,A)+(localStorage["local-codelang"]||"")+v.substring(A),m.innerHTML=v}const L=m.querySelector("wbr");if(L&&m&&!k.endsWith(`
`)){const v=ot(L);v&&v.nodeType!==3&&(v.dataset.type||"").indexOf("inline-math")>-1&&!rt(L)&&L.insertAdjacentText("afterend",`
`)}ra(r),ie(e,c,r.outerHTML,u),_e(e.wysiwyg.element,o);return}const b=$(r,"li");if(((s=h.content.children[0])==null?void 0:s.getAttribute("data-type"))==="NodeListItem")if(b)r=b,c=r.getAttribute("data-node-id"),u=r.outerHTML;else{const k=h.content.children[0].getAttribute("data-subtype");h.innerHTML=`<div${k==="o"?' data-marker="1."':""} data-subtype="${k}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${n}<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`}let y;Array.from(h.content.children).reverse().forEach(E=>{let k=E.getAttribute("data-node-id");if(k===c)g.push({action:"update",data:E.outerHTML,id:k}),f.push({action:"update",id:k,data:u});else{if(E.classList.contains("li")&&!r.parentElement.classList.contains("list")){k=Lute.NewNodeID();const L=document.createElement("div");L.setAttribute("data-subtype",E.getAttribute("data-subtype")),L.setAttribute("data-node-id",k),L.setAttribute("data-type","NodeList"),L.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),L.classList.add("list"),L.append(E),E=L}g.push({action:"insert",data:E.outerHTML,id:k,previousID:c}),f.push({action:"delete",id:k})}r.after(E),y||(y=E)}),m&&m.textContent===""&&r.classList.contains("p")&&(g.find((E,k)=>{if(E.id===c)return g.splice(k,1),!0}),g.push({action:"delete",id:c}),f.find((E,k)=>{if(E.id===c&&E.action==="update")return f.splice(k,1),!0}),f.push({action:"insert",data:u,id:c,previousID:r.previousElementSibling?r.previousElementSibling.getAttribute("data-node-id"):"",parentID:r.parentElement.getAttribute("data-node-id")||e.block.parentID}),r.remove()),y&&we(y,void 0,!1);const w=e.wysiwyg.element.querySelector("wbr");w&&w.remove(),G(e,g,f)},Mf=n=>{if(n){n.element.classList.remove("protyle"),n.element.removeAttribute("style"),n.wysiwyg&&(n.wysiwyg.lastHTMLs={}),n.undo&&n.undo.clear();try{n.ws.send("closews",{})}catch(e){setTimeout(()=>{n.ws.send("closews",{})},10240)}n.app.plugins.forEach(e=>{e.eventBus.emit("destroy-protyle",{protyle:n})})}};class hw{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const mw=(n,e)=>{const t=[];let a="",i="";for(let o=e.length,l=0;l<o;l++){const r=e[l];let c=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>n.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${n.options.upload.max/1024/1024}M</li>`,c=!1);const u=r.name.lastIndexOf("."),d=u===-1?"":r.name.substr(u),f=u===-1?r.name:n.options.upload.filename(r.name.substr(0,u))+d;n.options.upload.accept&&(n.options.upload.accept.split(",").some(h=>{const m=h.trim();if(m.indexOf(".")===0){if(d.toLowerCase()===m.toLowerCase())return!0}else if(r.type.split("/")[0]===m.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(t.push(r),i+=`<li>${f} ${window.siyuan.languages.uploading}</li>`)}let s;return(a!==""||i!=="")&&(s=q(`<ul>${a}${i}</ul>`,-1)),{files:t,msgId:s}},Nf=(n,e)=>{const t=JSON.parse(n);let a="";t.code===1&&(a=`${t.msg}`),t.data.errFiles&&t.data.errFiles.length>0&&(a=`<ul><li>${a}</li>`,t.data.errFiles.forEach(c=>{const u=c.lastIndexOf("."),d=u===-1?c:e.options.upload.filename(c.substr(0,u))+c.substr(u);a+=`<li>${d} ${window.siyuan.languages.uploadError}</li>`}),a+="</ul>"),a&&q(a);let i=!0;const s=he(e.wysiwyg.element);s.toString()===""&&s.startContainer.nodeType===3&&e.toolbar.getCurrentType(s).length>0&&(s.setEndAfter(s.startContainer.parentElement),s.collapse(!1));const o=M(s.startContainer);if(o)if(o.classList.contains("table"))i=!1;else{const c=J(o);c&&c.textContent!==""&&o.classList.contains("p")&&(i=!1)}let l="";const r=Object.keys(t.data.succMap);r.forEach((c,u)=>{const d=t.data.succMap[c],f=xe().extname(c).toLowerCase(),g=e.options.upload.filename(c);l+=Tf(f,d,g.substring(0,g.length-f.length),g),!p.Constants.SIYUAN_ASSETS_AUDIO.includes(f)&&!p.Constants.SIYUAN_ASSETS_VIDEO.includes(f)&&r.length-1!==u&&(o&&o.classList.contains("table")?l+="<br>":i?l+=`

`:l+=`
`)}),_t(l,e,i)},Hf=(n,e,t)=>{const a=q(window.siyuan.languages.uploading,0);_("/api/asset/insertLocalAssets",{assetPaths:n,isUpload:t,id:e.block.rootID},i=>{j(a),Nf(JSON.stringify(i),e)})},da=(n,e,t,a)=>{if(!n){const u=new FormData;for(let f=0,g=e.length;f<g;f++)u.append("file[]",e[f]);const d=new XMLHttpRequest;d.open("POST",p.Constants.UPLOAD_ADDRESS),d.onreadystatechange=()=>{d.readyState===XMLHttpRequest.DONE&&(d.status===200?a(d.responseText):d.status===0?q(window.siyuan.languages.fileTypeError):q(d.responseText),t&&(t.value=""))},d.send(u);return}let i=[];for(let u=0;u<e.length;u++){let d=e[u];d instanceof DataTransferItem&&(d=d.getAsFile()),d.size===0&&d.type===""&&d.name.indexOf(".")===-1?Hf([d.path],n,!1):i.push(d)}if(n.options.upload.handler){const u=n.options.upload.handler(i);if(typeof u=="string"){q(u);return}return}if(!n.options.upload.url||!n.upload){t&&(t.value=""),q("please config: options.upload.url");return}if(n.options.upload.file&&(i=n.options.upload.file(i)),n.options.upload.validate){const u=n.options.upload.validate(i);if(typeof u=="string"){q(u);return}}const s=n.wysiwyg.element,o=mw(n,i);if(o.files.length===0){t&&(t.value="");return}const l=new FormData,r=n.options.upload.extraData;for(const u of Object.keys(r))l.append(u,r[u]);for(let u=0,d=o.files.length;u<d;u++)l.append(n.options.upload.fieldName,o.files[u]);l.append("id",n.block.rootID);const c=new XMLHttpRequest;c.open("POST",n.options.upload.url),n.options.upload.token&&c.setRequestHeader("X-Upload-Token",n.options.upload.token),n.options.upload.withCredentials&&(c.withCredentials=!0),n.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(n.upload.isUploading=!1,!document.body.contains(n.element)){Mf(n);return}if(c.status===200)if(j(o.msgId),n.options.upload.success)n.options.upload.success(s,c.responseText);else if(a)a(c.responseText);else{let u=c.responseText;n.options.upload.format&&(u=n.options.upload.format(e,c.responseText)),Nf(u,n)}else c.status===0?q(window.siyuan.languages.fileTypeError):n.options.upload.error?n.options.upload.error(c.responseText):q(c.responseText);t&&(t.value=""),n.upload.element.style.display="none"}},c.upload.onprogress=u=>{if(!u.lengthComputable)return;const d=u.loaded/u.total*100;n.upload.element.style.display="block";const f=n.upload.element;f.style.width=d+"%"},c.send(l)};var Hc=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Bf=(n,e)=>Hc(void 0,null,function*(){try{let t=yield R();t=t.replace(/\\/g,"\\\\\\\\").replace(/\*/g,"\\\\\\*").replace(/\_/g,"\\\\\\_").replace(/\[/g,"\\\\\\[").replace(/\]/g,"\\\\\\]").replace(/\!/g,"\\\\\\!").replace(/\`/g,"\\\\\\`").replace(/\</g,"\\\\\\<").replace(/\>/g,"\\\\\\>").replace(/\&/g,"\\\\\\&").replace(/\~/g,"\\\\\\~").replace(/\{/g,"\\\\\\{").replace(/\}/g,"\\\\\\}").replace(/\(/g,"\\\\\\(").replace(/\)/g,"\\\\\\)").replace(/\=/g,"\\\\\\=").replace(/\#/g,"\\\\\\#").replace(/\$/g,"\\\\\\$").replace(/\^/g,"\\\\\\^").replace(/\|/g,"\\\\\\|"),Oc(n,t,e)}catch(t){console.log(t)}}),Rs=(n,e)=>{let t=!0;n.options.hint.extend.find(a=>{if(a.key===e)return t=!1,!0}),t&&n.hint.render(n)},Bc=n=>Hc(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(t=>{_t(n.lute.BlockDOM2EscapeMarkerContent(n.lute.Md2BlockDOM(t)),n),Rs(n,t)})}),Oc=(n,e,t)=>{const a=he(n.wysiwyg.element);if(t.getAttribute("data-type")==="NodeCodeBlock"){_t(e,n);return}a.toString()!==""&&((0,T.Y$)(e)?e=e.replace(/'.+'\)\)$/,` "${a.toString()}"))`):(0,T.rJ)(e)?e=e.replace(/".+">>$/,`"${a.toString()}">>`):n.lute.IsValidLinkDest(e)&&(e=`[${a.toString()}](${e})`)),_t(n.lute.Md2BlockDOM(e),n),Ke(n,n.wysiwyg.element),yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n),Rs(n,e),Ge(n,void 0,!1,"smooth")},Of=(n,e)=>Hc(void 0,null,function*(){var t;e.stopPropagation(),e.preventDefault();let a,i,s,o;if("clipboardData"in e?(a=e.clipboardData.getData("text/html"),i=e.clipboardData.getData("text/plain"),s=e.clipboardData.getData("text/siyuan"),o=e.clipboardData.files):(a=e.dataTransfer.getData("text/html"),i=e.dataTransfer.getData("text/plain"),s=e.dataTransfer.getData("text/siyuan"),e.dataTransfer.types[0]==="Files"&&(o=e.dataTransfer.items)),(a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${i}">${i}</a>`||a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${i}">${i}</a><!--EndFragment-->`)&&(a=""),i.endsWith(p.Constants.ZWSP)&&!a&&!s&&(s=i.substr(0,i.length-1)),!s){const u=new DOMParser().parseFromString(a,"text/html");u.body&&u.body.innerHTML&&(a=u.body.innerHTML),a.startsWith(`
<!--StartFragment-->`)&&a.endsWith(`<!--EndFragment-->

`)&&(a=u.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),a=Lute.Sanitize(a)}const l=M(e.target);if(!l){o&&o.length>0&&da(n,o);return}ne(["select"],n),n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(u=>{u.classList.remove("protyle-wysiwyg--hl")});const r=Xb(a,i),c=he(n.wysiwyg.element);if(l.getAttribute("data-type")==="NodeCodeBlock"||n.toolbar.getCurrentType(c).includes("code")){(t=l.querySelector(".protyle-action"))!=null&&t.contains(c.startContainer)&&c.setStart(l.querySelector(".hljs").firstChild,0),_t(i,n);return}else if(s){const u=document.createElement("div");u.innerHTML=s;let d=!1;u.querySelectorAll("[data-node-id]").forEach(g=>{const h=Lute.NewNodeID();g.setAttribute("data-node-id",h),g.removeAttribute(p.Constants.CUSTOM_RIFF_DECKS),g.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),g.setAttribute("updated",h.split("-")[0]),d=!0}),l.classList.contains("table")&&(d=!1),u.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(g=>{g.setAttribute("contenteditable","true")});const f=u.innerHTML;_t(f,n,d),Rs(n,n.lute.BlockDOM2StdMd(f)),Ke(n,n.wysiwyg.element),yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n)}else if(r)r.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(_t(r,n,!0),Ze(n.wysiwyg.element)):_t(r,n),ne(["hint"],n);else{let u=!1;if(a.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(a=a.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),o&&o.length===1&&(a.startsWith("<img")||a.startsWith("<table")&&a.indexOf("<img")>-1)?u=!1:u=!0),u){const d=document.createElement("div");d.innerHTML=a,d.querySelectorAll("[style]").forEach(f=>{f.removeAttribute("style")}),d.querySelectorAll("a").forEach(f=>{f.innerHTML.trim()===""&&f.remove()}),_("/api/lute/html2BlockDOM",{dom:d.innerHTML},f=>{_t(f.data,n),n.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(g=>{g.textContent===""&&_("/api/block/getRefText",{id:g.getAttribute("data-id")},h=>{g.innerHTML=h.data})}),Ke(n,n.wysiwyg.element),yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n),Rs(n,f.data),Ge(n,void 0,!1,"smooth")});return}else if(o&&o.length>0)da(n,o);else if(i.trim()!==""&&o&&o.length===0){if(c.toString()!==""){const f=i.split(`
`)[0];if((0,T.Y$)(i)){n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${i.substring(2,22+2)}${p.Constants.ZWSP}s${p.Constants.ZWSP}${c.toString()}`});return}else if((0,T.rJ)(f)){n.toolbar.setInlineMark(n,"file-annotation-ref","range",{type:"file-annotation-ref",color:f.substring(2).replace(/ ".+">>$/,"")});return}else if(n.lute.IsValidLinkDest(i)){n.toolbar.setInlineMark(n,"a","range",{type:"a",color:i});return}}const d=n.lute.Md2BlockDOM(i);_t(d,n),Rs(n,i)}Ke(n,n.wysiwyg.element),yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n)}Ge(n,void 0,!1,"smooth")}),qs=(n,e=!1)=>{if(!n.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const t={rootId:n.block.rootID,startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:n.contentElement.scrollTop||parseInt(n.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!n.wysiwyg.element.contains(a.startContainer))&&(a=n.toolbar.range),a&&n.wysiwyg.element.contains(a.startContainer)){const s=M(a.startContainer);if(s){const o=Et(s,void 0,a);t.focusId=s.getAttribute("data-node-id"),t.focusStart=o.start,t.focusEnd=o.end}}if(n.block.showAll&&(t.zoomInId=n.block.id),e)return t;const i=JSON.stringify(t);_("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{scroll:i}},()=>{n.wysiwyg.element.setAttribute("scroll",i)})},Rc=n=>{var e,t;let a=[];if(n.mergedOptions?a=n.mergedOptions.action:n.focus?a=[p.Constants.CB_GET_UNUNDO,p.Constants.CB_GET_FOCUS]:a=[p.Constants.CB_GET_UNUNDO],n.scrollAttr.zoomInId){_("/api/filetree/getDoc",{id:n.scrollAttr.zoomInId,size:p.Constants.SIZE_GET_MAX},i=>{a.push(p.Constants.CB_GET_ALL),dt({data:i,protyle:n.protyle,action:a,scrollAttr:n.scrollAttr,afterCB:n.cb})});return}_("/api/filetree/getDoc",{id:n.scrollAttr.rootId||((e=n.mergedOptions)==null?void 0:e.blockId)||((t=n.protyle.block)==null?void 0:t.rootID)||n.scrollAttr.startId,startID:n.scrollAttr.startId,endID:n.scrollAttr.endId},i=>{dt({data:i,protyle:n.protyle,action:a,scrollAttr:n.scrollAttr,afterCB:n.cb})})},zn=(n,e)=>{if(!n.preview.element.classList.contains("fn__none")){n.preview.render(n);return}if(window.siyuan.config.editor.displayBookmarkIcon?n.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):n.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),n.title&&(n.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?n.title.element.classList.add("protyle-wysiwyg--attr"):n.title.element.classList.remove("protyle-wysiwyg--attr")),n.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),n.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),os(n),n.options.backlinkData){const t=n.element.getAttribute("data-ismention")==="true",a=$(n.element,"sy__backlink");if(a){const i=a.querySelectorAll(".b3-form__icon-input");_(t?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:n.element.getAttribute("data-defid"),refTreeID:n.block.rootID,keyword:t?i[1].value:i[0].value},s=>{n.options.backlinkData=t?s.data.backmentions:s.data.backlinks,Lp(n,n.options.backlinkData)})}}else cn(n),Rc({protyle:n,focus:e,scrollAttr:qs(n,!0)})};var bw=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const ww=(n,e)=>{const t=new Le({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${n.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${n.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${n.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${n.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${n.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${n.types.document?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${n.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${n.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${n.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${n.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${n.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${n.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${n.types.databaseBlock?" checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px",height:"70vh"}),a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{t.element.querySelectorAll(".b3-switch").forEach(i=>{n.types[i.getAttribute("data-type")]=i.checked}),e(),t.destroy()})},yw=(n,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new I({iconHTML:"",label:window.siyuan.languages.keyword,current:n.method===0,click(){n.method=0,e()}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:window.siyuan.languages.querySyntax,current:n.method===1,click(){n.method=1,e()}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:"SQL",current:n.method===2,click(){n.method=2,e()}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:window.siyuan.languages.regex,current:n.method===3,click(){n.method=3,e()}}).element)},bl=(n,e,t,a,i)=>{n.removed=!1;const s=n;s.name=a,e.push(Object.assign({},s)),window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]=Object.assign({},n),Ue(p.Constants.LOCAL_SEARCHDATA,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]),_("/api/storage/setCriterion",{criterion:s},()=>{var o;i.destroy();const l=t.querySelector("#criteria").firstElementChild;l.classList.remove("fn__none"),(o=l.querySelector(".b3-chip--current"))==null||o.classList.remove("b3-chip--current"),l.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][l.childElementCount%7]}">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},Rf=(n,e,t)=>{const a=new Le({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),i=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{const s=a.element.querySelector("input").value;if(!s){q(window.siyuan.languages._kernel[142]);return}(0,T.tq)()?(n.k=document.querySelector("#toolbarSearch").value,n.r=t.querySelector("#toolbarReplace").value):(n.k=t.querySelector("#searchInput").value,n.r=t.querySelector("#replaceInput").value);const o=t.querySelector("#criteria").firstElementChild;let l="",r="";if(e.forEach(c=>{c.name===s&&(l=c.name),qf(c,n)&&(r=c.name)}),l&&!r)Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(o.children).forEach(c=>{c.textContent===s&&c.remove()}),e.find((c,u)=>{if(c.name===s)return e.splice(u,1),!0}),bl(n,e,t,s,a)});else if(l&&r)if(l===r)a.destroy();else{const c=l===s?r:l;Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",s),()=>{Array.from(o.children).forEach(u=>{(u.textContent===r||u.textContent===l)&&u.remove()}),e.find((u,d)=>{if(u.name===c||u.name===l)return _("/api/storage/removeCriterion",{name:c}),e.splice(d,1),!0}),bl(n,e,t,s,a)})}else!l&&r?Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",r).replace("${y}",s),()=>{Array.from(o.children).forEach(c=>{c.textContent===r&&c.remove()}),e.find((c,u)=>{if(c.name===r)return _("/api/storage/removeCriterion",{name:r}),e.splice(u,1),!0}),bl(n,e,t,s,a)}):bl(n,e,t,s,a)})},_w=(n,e,t,a,i,s)=>bw(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore");const o=[{iconHTML:"",label:window.siyuan.languages.type,current:n.sort===0,click(){n.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:n.sort===1,click(){n.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:n.sort===2,click(){n.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:n.sort===3,click(){n.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:n.sort===4,click(){n.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:n.sort===6,click(){n.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:n.sort===7,click(){n.sort=7,a()}}];n.group===1&&o.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:n.sort===5,click(){n.sort=5,a()}}),window.siyuan.menus.menu.append(new I({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:n.group===0,click(){(0,T.tq)()?(t.querySelector('[data-type="expand"]').classList.add("fn__none"),t.querySelector('[data-type="contract"]').classList.add("fn__none")):t.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),n.group=0,n.sort===5&&(n.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:n.group===1,click(){(0,T.tq)()?(t.querySelector('[data-type="expand"]').classList.remove("fn__none"),t.querySelector('[data-type="contract"]').classList.remove("fn__none")):t.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),n.group=1,a()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){Rf(n,e,t)}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)}),qf=(n,e)=>!!(e.group===n.group&&e.hPath===n.hPath&&e.hasReplace===n.hasReplace&&e.k===n.k&&e.method===n.method&&e.r===n.r&&e.sort===n.sort&&(0,T.MK)(e.types,n.types)&&(0,T.MK)(e.idPath,n.idPath)),vw=(n,e,t)=>{_("/api/storage/getCriteria",{},a=>{let i="";a.data.forEach((s,o)=>{e.push(s);let l=!1;qf(s,t)&&(l=!0),i+=`<div data-type="set-criteria" class="${l?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][o%7]}">${De(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),n.innerHTML=`<div class="b3-chips">
    ${i}
</div>
<span class="fn__flex-1"></span>
<button data-type="saveCriterion" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.saveCriterion}</button>
<span class="fn__space"></span>
<button data-type="removeCriterion" aria-label="${window.siyuan.languages.useCriterion}" class="b3-tooltips b3-tooltips__nw b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.removeCriterion}</button>
<span class="fn__space"></span>`})},Ew=n=>{const e=[];return n.querySelectorAll("mark").forEach(t=>{e.push(t.textContent)}),[...new Set(e)].join(" ")},kw=(n,e)=>{if(window.siyuan.menus.menu.remove(),n.previousElementSibling.classList.add("fn__none"),n.classList.remove("fn__none"),n.innerHTML){n.querySelector("#searchAssetInput").select();return}const t=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET];n.nextElementSibling.classList.remove("fn__none");let i="";n.innerHTML=`<div class="b3-form__icon search__header">
    <span class="fn__a" id="assetHistoryBtn">
        <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
    </span>
    <input id="searchAssetInput" value="${t.k}" style="padding-right: 60px" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.keyword}">
    <div id="searchAssetHistoryList" data-close="false" class="fn__none b3-menu b3-list b3-list--background"></div>
    <div class="block__icons">
        <span data-type="assetRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon b3-tooltips b3-tooltips__w">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetSyntaxCheck" aria-label="${vl(t.method)}" class="block__icon b3-tooltips b3-tooltips__w">
            <svg><use xlink:href="#iconRegex"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetFilter" aria-label="${window.siyuan.languages.type}" class="block__icon b3-tooltips b3-tooltips__w">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetMore" aria-label="${window.siyuan.languages.more}" class="block__icon b3-tooltips b3-tooltips__w">
            <svg><use xlink:href="#iconMore"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchAssetClose" aria-label="${e?window.siyuan.languages.stickSearch:window.siyuan.languages.globalSearch}" class="block__icon b3-tooltips b3-tooltips__w">
            <svg><use xlink:href="#iconBack"></use></svg>
        </span>
    </div>
</div>
<div class="block__icons">
    <span data-type="assetPrevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__ne" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="assetNext" class="block__icon block__icon--show b3-tooltips b3-tooltips__ne" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
    <span class="fn__space"></span>
    <span id="searchAssetResult" class="ft__selectnone"></span>
    <span class="fn__space"></span>
    <span class="fn__flex-1"></span>
</div>
<div class="search__layout${t.layout===1?" search__layout--row":""}">
    <div id="searchAssetList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
    <div class="search__drag"></div>
    <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px"></div>
</div>
<div class="search__tip${e?" fn__none":""}">
    <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
    ${i}
    <kbd>Click</kbd> ${window.siyuan.languages.searchTip3}
    <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
</div>`;const s=n.querySelector("#searchAssetList");if(n.querySelector("#searchAssetList").innerHTML!=="")return;const o=n.querySelector("#searchAssetPreview");t.layout===1?t.col&&(o.style.width=t.col,o.classList.remove("fn__flex-1")):t.row&&(o.classList.remove("fn__flex-1"),o.style.height=t.row);const l=n.querySelector("#searchAssetInput");l.select(),l.addEventListener("compositionend",d=>{d.isComposing||en(n,t)}),l.addEventListener("input",d=>{d.isComposing||en(n,t)}),l.addEventListener("blur",()=>{if(!l.value)return;let d=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys;d.splice(0,0,l.value),d=Array.from(new Set(d)),d.length>window.siyuan.config.search.limit&&d.splice(window.siyuan.config.search.limit,d.length-window.siyuan.config.search.limit),window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].k=l.value,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys=d,Ue(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])});const r=n.querySelector("#searchAssetHistoryList"),c=28;l.addEventListener("keydown",d=>{if(d.isComposing)return;let f=s.querySelector(".b3-list-item--focus");const g=!r.classList.contains("fn__none");if(d.key==="Enter"){g&&(l.value=r.querySelector(".b3-list-item--focus").textContent.trim(),en(n,t),wl(r,l),Fs(o,f.dataset.id,l.value,t.method)),d.preventDefault();return}if(d.key==="ArrowDown"&&d.altKey){wl(r,l);return}if(g){d.key==="Escape"?wl(r,l):En(r,d),d.stopPropagation(),d.preventDefault();return}if(f){if(d.key==="ArrowDown")f.classList.remove("b3-list-item--focus"),f.nextElementSibling?f.nextElementSibling.classList.add("b3-list-item--focus"):s.firstElementChild.classList.add("b3-list-item--focus"),f=s.querySelector(".b3-list-item--focus"),(s.scrollTop<f.offsetTop-s.clientHeight+c||s.scrollTop>f.offsetTop)&&(s.scrollTop=f.offsetTop-s.clientHeight+c),d.preventDefault(),Fs(o,f.dataset.id,l.value,t.method);else if(d.key==="ArrowUp")f.classList.remove("b3-list-item--focus"),f.previousElementSibling?f.previousElementSibling.classList.add("b3-list-item--focus"):s.lastElementChild.classList.add("b3-list-item--focus"),f=s.querySelector(".b3-list-item--focus"),(s.scrollTop<f.offsetTop-s.clientHeight+c||s.scrollTop>f.offsetTop-c*2)&&(s.scrollTop=f.offsetTop-c*2),d.preventDefault(),Fs(o,f.dataset.id,l.value,t.method);else if(p.Constants.KEYCODELIST[d.keyCode]==="PageUp"){if(!n.querySelector('[data-type="assetPrevious"]').getAttribute("disabled")){let h=parseInt(n.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);h>1&&(h--,en(n,t,h))}d.preventDefault()}else if(p.Constants.KEYCODELIST[d.keyCode]==="PageDown"){if(!n.querySelector('[data-type="assetNext"]').getAttribute("disabled")){let h=parseInt(n.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);h<parseInt(n.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])&&(h++,en(n,t,h))}d.preventDefault()}}}),en(n,t);const u=n.querySelector(".search__drag");u.addEventListener("mousedown",d=>{const f=document,g=u.nextElementSibling,h=u.previousElementSibling,m=t.layout===1?"lr":"tb",b=d[m==="lr"?"clientX":"clientY"],y=m==="lr"?h.clientWidth:h.clientHeight,w=m==="lr"?g.clientWidth:g.clientHeight;g.classList.remove("fn__flex-1"),g.style[m==="lr"?"width":"height"]=w+"px",f.onmousemove=E=>{E.preventDefault(),E.stopPropagation();const k=y+(E[m==="lr"?"clientX":"clientY"]-b),L=w-(E[m==="lr"?"clientX":"clientY"]-b);k<120||L<120||(g.style[m==="lr"?"width":"height"]=L+"px")},f.onmouseup=()=>{f.onmousemove=null,f.onmouseup=null,f.ondragstart=null,f.onselectstart=null,f.onselect=null,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET][m==="lr"?"col":"row"]=g[m==="lr"?"clientWidth":"clientHeight"]+"px",Ue(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}})};let Ff;const en=(n,e,t=1)=>{n.nextElementSibling.classList.remove("fn__none"),clearTimeout(Ff),Ff=window.setTimeout(()=>{e||(e=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET]);const a=n.querySelector('[data-type="assetPrevious"]');t>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=n.querySelector("#searchAssetInput");_("/api/search/fullTextSearchAssetContent",{page:t,query:i.value,types:e.types,method:e.method,orderBy:e.sort},s=>{var o,l;n.nextElementSibling.classList.add("fn__none");const r=n.querySelector('[data-type="assetNext"]');t<s.data.pageCount?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled");let c="";s.data.assetContents.forEach((d,f)=>{c+=`<div data-type="search-item" class="b3-list-item${f===0?" b3-list-item--focus":""}" data-id="${d.id}">
<span class="ft__on-surface">${d.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${d.content}</span>
<span class="b3-list-item__meta">${d.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Bi(d.path)}">${d.name}</span>
</div>`});const u=n.querySelector("#searchAssetPreview");s.data.assetContents.length>0?(u.classList.remove("fn__none"),(o=n.querySelector(".search__drag"))==null||o.classList.remove("fn__none"),Fs(u,s.data.assetContents[0].id,i.value,e.method)):(u.classList.add("fn__none"),(l=n.querySelector(".search__drag"))==null||l.classList.add("fn__none")),n.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${t}/${s.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${s.data.matchedAssetCount}</span>`,n.querySelector("#searchAssetList").innerHTML=c||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},p.Constants.TIMEOUT_INPUT)},wl=(n,e)=>{if(n.classList.contains("fn__none")){const t=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys;if(!t||t.length===0)return;let a="";if(t.forEach(i=>{i!==e.value&&i&&(a+=`<div class="b3-list-item${a?"":" b3-list-item--focus"}">${De(i)}</div>`)}),a==="")return;n.classList.remove("fn__none"),n.innerHTML=a}else n.classList.add("fn__none")},Fs=(n,e,t,a)=>{_("/api/search/getAssetContent",{id:e,query:t,queryMethod:a},i=>{n.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=n.querySelector("mark");if(s){s.classList.add("mark--hl");const o=n.getBoundingClientRect();n.scrollTop=n.scrollTop+s.getBoundingClientRect().top-o.top-o.height/2}})},Sw=n=>{let e;const t=Array.from(n.querySelectorAll("mark"));if(t.find((a,i)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),e=t[i+1];return}}),e||(e=t[0]),e){e.classList.add("mark--hl");const a=n.getBoundingClientRect();n.scrollTop=n.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},Lw=(n,e)=>{const t=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.keyword,current:t===0,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method=0,e()}}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.querySyntax,current:t===1,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method=1,e()}}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.regex,current:t===3,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method=3,e()}}).element);const a=n.getBoundingClientRect();window.siyuan.menus.menu.popup({x:a.right,y:a.bottom,isLeft:!0})},Cw=n=>{let e="";return p.Constants.SIYUAN_ASSETS_SEARCH.sort((t,a)=>t.localeCompare(a)).forEach(t=>{e+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${t}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${t}" type="checkbox" ${n[t]?" checked":""}>
    </label>`}),e},xw=n=>{const e=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].types,t=new Le({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${Cw(e)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"}),a=t.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{t.destroy()}),a[1].addEventListener("click",()=>{t.element.querySelectorAll(".b3-switch").forEach(i=>{e[i.getAttribute("data-type")]=i.checked}),en(n),Ue(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET]),t.destroy()})},Aw=(n,e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const a=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET],i=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,t()}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,t()}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,t()}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,t()}}];window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.topBottomLayout,current:a.layout===0,click(){e.querySelector(".search__layout").classList.remove("search__layout--row");const o=e.querySelector("#searchAssetPreview");o.style.width="",a.row?(o.style.height=a.row,o.classList.remove("fn__flex-1")):o.classList.add("fn__flex-1"),a.layout=0,Ue(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.leftRightLayout,current:a.layout===1,click(){const o=e.querySelector("#searchAssetPreview");e.querySelector(".search__layout").classList.add("search__layout--row"),o.style.height="",a.col?(o.style.width=a.col,o.classList.remove("fn__flex-1")):o.classList.add("fn__flex-1"),a.layout=1,Ue(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}}]}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.rebuildIndex,click(){e.nextElementSibling.classList.remove("fn__none"),_("/api/asset/fullReindexAssetContent",{},()=>{en(e,a)})}}).element);const s=n.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.right,y:s.bottom,isLeft:!0})},yl=(n,e,t)=>{if(n.classList.contains("fn__none")){const a=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS];if(!a.replaceKeys||a.replaceKeys.length===0)return;let i="";if(a.replaceKeys.forEach(s=>{s!==t.value&&s&&(i+=`<div class="b3-list-item${i?"":" b3-list-item--focus"}">${De(s)}</div>`)}),i==="")return;n.classList.remove("fn__none"),n.innerHTML=i}else n.classList.add("fn__none");e.classList.add("fn__none")},_l=(n,e,t)=>{if(n.classList.contains("fn__none")){const a=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS];if(!a.keys||a.keys.length===0)return;let i="";if(a.keys.forEach(s=>{s!==t.value&&s&&(i+=`<div class="b3-list-item${i?"":" b3-list-item--focus"}">${De(s)}</div>`)}),i==="")return;n.classList.remove("fn__none"),n.innerHTML=i}else n.classList.add("fn__none");e.classList.add("fn__none")},Uf=(n,e)=>{let t=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][n];t.splice(0,0,e),t=Array.from(new Set(t)),t.length>window.siyuan.config.search.limit&&t.splice(window.siyuan.config.search.limit,t.length-window.siyuan.config.search.limit),window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][n]=t,Ue(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])},Hn=(n,e,t)=>{if(e=e.trim(),Ye().search.find(s=>(s.parent.parent.switchTab(s.parent.headElement),s.updateSearch(e,t),!0)))return;const i=window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA];jn({app:n,searchData:{k:e,r:"",hasReplace:!1,method:i.method,hPath:"",idPath:[],group:i.group,sort:i.sort,types:Object.assign({},i.types),removed:i.removed,page:1},position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0})},Vf=(n,e,t,a)=>{let i=window.siyuan.languages.keyword;e.method===1?i=window.siyuan.languages.querySyntax:e.method===2?i="SQL":e.method===3&&(i=window.siyuan.languages.regex);let s=!0,o=!1;e.idPath.forEach(v=>{v.endsWith(".sy")&&(s=!1),v.split("/").length>1&&(o=!0)});const l=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS];t.innerHTML=`<div class="fn__flex-column" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}">
    <div class="b3-form__icon search__header">
        <span class="fn__a" id="searchHistoryBtn">
            <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="searchInput" style="padding-right: 60px" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}">
        <div id="searchHistoryList" data-close="false" class="fn__none b3-menu b3-list b3-list--background"></div>
        <div class="block__icons">
            <span id="searchRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconRefresh"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchReplace" aria-label="${window.siyuan.languages.replace}" class="block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconReplace"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchSyntaxCheck" aria-label="${window.siyuan.languages.searchMethod} ${i}" class="block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconRegex"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchFilter" aria-label="${window.siyuan.languages.type}" class="block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchMore" aria-label="${window.siyuan.languages.more}" class="block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <span class="${a?"":"fn__none "}fn__space"></span>
            <span id="searchOpen" aria-label="${window.siyuan.languages.openInNewTab}" class="${a?"":"fn__none "}block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconLayoutRight"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchAsset" aria-label="${window.siyuan.languages.searchAssetContent}" class="block__icon b3-tooltips b3-tooltips__w">
                <svg><use xlink:href="#iconExact"></use></svg>
            </span>
        </div>
    </div>
    <div class="b3-form__icon search__header${e.hasReplace?"":" fn__none"}">
        <span class="fn__a" id="replaceHistoryBtn">
            <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconReplace"></use></svg>
            <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="replaceInput" class="b3-text-field b3-text-field--text">
        <svg class="fn__rotate fn__none svg" style="padding: 0 8px;align-self: center;"><use xlink:href="#iconRefresh"></use></svg>
        <button id="replaceAllBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button id="replaceBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">\u21B5 ${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
        <div id="replaceHistoryList" data-close="false" class="fn__none b3-menu b3-list b3-list--background"></div>
    </div>
    <div id="criteria" class="fn__flex" style="min-height:40px;background-color: var(--b3-theme-background)"></div>
    <div class="block__icons">
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__ne" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__ne" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span id="searchResult" class="fn__flex-shrink ft__selectnone"></span>
        <span class="fn__space"></span>
        <span class="fn__flex-1"></span>
        <span id="searchPathInput" class="search__path ft__on-surface fn__flex-center ft__smaller fn__ellipsis ariaLabel" aria-label="${Bi(e.hPath)}">
            ${De(e.hPath)}
            <svg class="search__rmpath${e.hPath?"":" fn__none"}"><use xlink:href="#iconCloseRound"></use></svg>
        </span>
        <span class="fn__space"></span>
        <button ${o?"":"disabled"} id="searchInclude" class="b3-button b3-button--mid${s?"":" b3-button--cancel"}">${window.siyuan.languages.includeChildDoc}</button>
        <span class="fn__space"></span>
        <span id="searchPath" aria-label="${window.siyuan.languages.specifyPath}" class="block__icon block__icon--show b3-tooltips b3-tooltips__w">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <div class="fn__flex${e.group===0?" fn__none":""}">
            <span class="fn__space"></span>
            <span id="searchExpand" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.expand}">
                <svg><use xlink:href="#iconExpand"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchCollapse" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.collapse}">
                <svg><use xlink:href="#iconContract"></use></svg>
            </span>
        </div>
    </div>
    <div class="search__layout${(a?l.layout===1:l.layoutTab===1)?" search__layout--row":""}">
        <div id="searchList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
        <div class="search__drag"></div>
        <div id="searchPreview" class="fn__flex-1 search__preview"></div>
    </div>
    <div class="search__tip${a?"":" fn__none"}">
        <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${ae(window.siyuan.config.keymap.general.newFile.custom)}</kbd> ${window.siyuan.languages.new}
        <kbd>Enter/Double Click</kbd> ${window.siyuan.languages.searchTip2}
        <kbd>Click</kbd> ${window.siyuan.languages.searchTip3}
        <kbd>${ae(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${ae("\u2325Click")}</kbd> ${window.siyuan.languages.searchTip4}
        <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
    </div>
</div>
<div class="fn__flex-column fn__none" id="searchAssets" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}"></div>
<div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>`;const r=[];vw(t.querySelector("#criteria"),r,e);const c=t.querySelector("#searchList"),u=t.querySelector("#searchInput"),d=t.querySelector("#replaceInput"),f=t.querySelector("#replaceHistoryList"),g=t.querySelector("#searchHistoryList"),h=28,m=new hn(n,t.querySelector("#searchPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}});a?l.layout===1?l.col&&(m.protyle.element.style.width=l.col,m.protyle.element.classList.remove("fn__flex-1")):l.row&&(m.protyle.element.classList.remove("fn__flex-1"),m.protyle.element.style.height=l.row):l.layoutTab===1?l.colTab&&(m.protyle.element.style.width=l.colTab,m.protyle.element.classList.remove("fn__flex-1")):l.rowTab&&(m.protyle.element.classList.remove("fn__flex-1"),m.protyle.element.style.height=l.rowTab);let b,y=new Date().getTime(),w;u.value=e.k||"",d.value=e.r||"",u.select();const E=t.querySelector(".search__drag");E.addEventListener("mousedown",v=>{const A=document,C=E.nextElementSibling,D=E.previousElementSibling,x=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][a?"layout":"layoutTab"]===1?"lr":"tb",P=v[x==="lr"?"clientX":"clientY"],B=x==="lr"?D.clientWidth:D.clientHeight,V=x==="lr"?C.clientWidth:C.clientHeight;C.classList.remove("fn__flex-1"),C.style[x==="lr"?"width":"height"]=V+"px",A.onmousemove=X=>{X.preventDefault(),X.stopPropagation();const Q=B+(X[x==="lr"?"clientX":"clientY"]-P),ce=V-(X[x==="lr"?"clientX":"clientY"]-P);Q<120||ce<120||(C.style[x==="lr"?"width":"height"]=ce+"px")},A.onmouseup=()=>{A.onmousemove=null,A.onmouseup=null,A.ondragstart=null,A.onselectstart=null,A.onselect=null,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][x==="lr"?a?"col":"colTab":a?"row":"rowTab"]=C[x==="lr"?"clientWidth":"clientHeight"]+"px",Ue(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS]),x==="lr"&&Bt(m.protyle)}});const k=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET],L=t.querySelector("#searchAssets");return t.addEventListener("click",v=>{var A,C,D;let x=v.target;const P=t.querySelector("#searchPathInput");for(;x&&!x.isSameNode(t);){const B=x.getAttribute("data-type");if(B==="removeCriterion"){qc(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}},e,m),(A=t.querySelector(".b3-chip--current"))==null||A.classList.remove("b3-chip--current"),v.stopPropagation(),v.preventDefault();break}else if(B==="saveCriterion"){Rf(e,r,t),v.stopPropagation(),v.preventDefault();break}else if(B==="next"){x.getAttribute("disabled")||e.page<parseInt(x.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(e.page++,w=Ut(t,e,w,m)),v.stopPropagation(),v.preventDefault();break}else if(B==="previous"){x.getAttribute("disabled")||e.page>1&&(e.page--,w=Ut(t,e,w,m)),v.stopPropagation(),v.preventDefault();break}else if(x.classList.contains("b3-chip")&&B==="set-criteria"){e.removed=!1,(C=x.parentElement.querySelector(".b3-chip--current"))==null||C.classList.remove("b3-chip--current"),x.classList.add("b3-chip--current"),r.find(V=>{if(V.name===x.innerText.trim())return qc(t,V,e,m),!0}),v.stopPropagation(),v.preventDefault();break}else if(x.classList.contains("b3-chip__close")&&B==="remove-criteria"){const V=x.parentElement.innerText.trim();_("/api/storage/removeCriterion",{name:V}),r.find((X,Q)=>{if(X.name===V)return r.splice(Q,1),!0}),x.parentElement.remove(),v.stopPropagation(),v.preventDefault();break}else if(x.classList.contains("search__rmpath")){e.idPath=[],e.hPath="",e.page=1,P.innerHTML=e.hPath,P.setAttribute("aria-label",""),w=Ut(t,e,w,m,!0);const V=t.querySelector("#searchInclude");V.classList.remove("b3-button--cancel"),V.setAttribute("disabled","disabled"),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchExpand"){Array.from(c.children).forEach(V=>{V.classList.contains("b3-list-item")&&(V.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),V.nextElementSibling.classList.remove("fn__none"))}),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchCollapse"){Array.from(c.children).forEach(V=>{V.classList.contains("b3-list-item")&&(V.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),V.nextElementSibling.classList.add("fn__none"))}),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchPath"){ya((V,X)=>{_("/api/filetree/getHPathsByPaths",{paths:V},Q=>{e.idPath=[];const ce=[];let Pe=!1;V.forEach((de,It)=>{de==="/"?(e.idPath.push(X[It]),ce.push(Xn(X[It]))):(Pe=!0,e.idPath.push(xe().join(X[It],de.replace(".sy",""))))}),Q.data&&ce.push(...Q.data),e.hPath=ce.join(" "),e.page=1,P.innerHTML=`${De(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,P.setAttribute("aria-label",De(e.hPath));const ge=t.querySelector("#searchInclude");ge.classList.remove("b3-button--cancel"),Pe?ge.removeAttribute("disabled"):ge.setAttribute("disabled","disabled"),w=Ut(t,e,w,m,!0)})},[],void 0,window.siyuan.languages.specifyPath),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchInclude"){x.classList.toggle("b3-button--cancel"),x.classList.contains("b3-button--cancel")?e.idPath.forEach((V,X)=>{!V.endsWith(".sy")&&V.split("/").length>1&&(e.idPath[X]=V+".sy")}):e.idPath.forEach((V,X)=>{V.endsWith(".sy")&&(e.idPath[X]=V.replace(".sy",""))}),e.page=1,w=Ut(t,e,w,m,!0),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchReplace"){e.hasReplace=!e.hasReplace,t.querySelector("#replaceHistoryBtn").parentElement.classList.toggle("fn__none"),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchAsset"){kw(L,!a),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchAssetClose"){window.siyuan.menus.menu.remove(),L.classList.add("fn__none"),L.previousElementSibling.classList.remove("fn__none"),u.select(),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchOpen"){e.k=u.value,e.r=d.value,jn({app:n,searchData:e,position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0}),a&&a(),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchRefresh"){w=Ut(t,e,w,m),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchMore"){_w(e,r,t,()=>{e.page=1,Ut(t,e,void 0,m,!0)},()=>{var X;qc(t,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}},e,m),(X=t.querySelector("#criteria .b3-chip--current"))==null||X.classList.remove("b3-chip--current")},()=>{const X=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS],Q=$(t,"b3-dialog__container");window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.topBottomLayout,current:Q?X.layout===0:X.layoutTab===0,click(){t.querySelector(".search__layout").classList.remove("search__layout--row"),m.protyle.element.style.width="",Q&&X.row||!Q&&X.rowTab?(m.protyle.element.style.height=Q?X.row:X.rowTab,m.protyle.element.classList.remove("fn__flex-1")):m.protyle.element.classList.add("fn__flex-1"),Bt(m.protyle),Q?X.layout=0:X.layoutTab=0,Ue(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.leftRightLayout,current:Q?X.layout===1:X.layoutTab===1,click(){t.querySelector(".search__layout").classList.add("search__layout--row"),m.protyle.element.style.height="",Q&&X.col||!Q&&X.colTab?(m.protyle.element.style.width=Q?X.col:X.colTab,m.protyle.element.classList.remove("fn__flex-1")):m.protyle.element.classList.add("fn__flex-1"),Bt(m.protyle),Q?X.layout=1:X.layoutTab=1,Ue(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])}}]}).element)});const V=x.getBoundingClientRect();window.siyuan.menus.menu.popup({x:V.right,y:V.bottom,isLeft:!0}),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchFilter"){window.siyuan.menus.menu.remove(),ww(e,()=>{e.page=1,Ut(t,e,void 0,m,!0)}),v.stopPropagation(),v.preventDefault();break}else if(B==="assetPrevious"){if(!x.getAttribute("disabled")){let V=parseInt(L.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);V>1&&(V--,en(L,k,V))}v.stopPropagation(),v.preventDefault();break}else if(B==="assetNext"){if(!x.getAttribute("disabled")){let V=parseInt(L.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);V<parseInt(L.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])&&(V++,en(L,k,V))}v.stopPropagation(),v.preventDefault();break}else if(x.id==="assetMore"){Aw(x,L,()=>{en(L),Ue(p.Constants.LOCAL_SEARCHASSET,k)}),v.stopPropagation(),v.preventDefault();break}else if(x.id==="assetFilter"){xw(L),v.stopPropagation(),v.preventDefault();break}else if(x.id==="assetSyntaxCheck"){Lw(x,()=>{t.querySelector("#assetSyntaxCheck").setAttribute("aria-label",vl(k.method)),en(L,k),Ue(p.Constants.LOCAL_SEARCHASSET,k)}),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchSyntaxCheck"){yw(e,()=>{t.querySelector("#searchSyntaxCheck").setAttribute("aria-label",vl(e.method)),e.page=1,Ut(t,e,void 0,m,!0)});const V=x.getBoundingClientRect();window.siyuan.menus.menu.popup({x:V.right,y:V.bottom,isLeft:!0}),v.stopPropagation(),v.preventDefault();break}else if(x.id==="searchHistoryBtn"){_l(g,f,u),v.stopPropagation(),v.preventDefault();return}else if(x.id==="assetHistoryBtn"){wl(x.nextElementSibling.nextElementSibling,x.nextElementSibling),v.stopPropagation(),v.preventDefault();return}else if(x.id==="replaceHistoryBtn"){yl(f,g,d),v.stopPropagation(),v.preventDefault();return}else if(x.id==="replaceAllBtn"){Fc(t,e,m,!0),v.stopPropagation(),v.preventDefault();break}else if(B==="assetRefresh"){en(L),v.stopPropagation(),v.preventDefault();break}else if(x.id==="replaceBtn"){Fc(t,e,m,!1),v.stopPropagation(),v.preventDefault();break}else if(x.classList.contains("b3-list-item__toggle")){x.parentElement.nextElementSibling.classList.toggle("fn__none"),x.firstElementChild.classList.toggle("b3-list-item__arrow--open"),v.stopPropagation(),v.preventDefault();break}else if(x.classList.contains("b3-list-item")){const V=t.querySelector("#searchAssetInput");if(x.parentElement.id==="searchHistoryList")u.value=x.textContent,e.page=1,w=Ut(t,e,w,m,!0);else if(x.parentElement.id==="searchAssetHistoryList")V.value=x.textContent,en(L);else if(x.parentElement.id==="replaceHistoryList")d.value=x.textContent,f.classList.add("fn__none");else if(B==="search-new")kc(n,u.value);else if(B==="search-item"){const X=x.dataset.id;let Q=v.detail===1,ce=v.detail===2;const Pe=new Date().getTime();if(Q=Pe-y>p.Constants.TIMEOUT_DBLCLICK,ce=!Q,y=Pe,Q)b=window.setTimeout(()=>{if(X)x.classList.contains("b3-list-item--focus")?x.classList.contains("b3-list-item--focus")&&(Sw(t.querySelector("#searchAssetPreview")),V.focus()):(L.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),x.classList.add("b3-list-item--focus"),Fs(t.querySelector("#searchAssetPreview"),x.dataset.id,V.value,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method),V.focus());else if(v.altKey){const ge=x.getAttribute("data-node-id");_("/api/block/checkBlockFold",{id:ge},de=>{be({app:n,id:ge,action:de.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:ge===x.getAttribute("data-root-id")?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ROOTSCROLL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:de.data,position:"right"}),a&&a()})}else x.classList.contains("b3-list-item--focus")?x.classList.contains("b3-list-item--focus")&&(Tw({edit:m,id:x.getAttribute("data-node-id"),target:x}),u.focus()):(c.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),x.classList.add("b3-list-item--focus"),Gi({edit:m,id:x.getAttribute("data-node-id"),config:e,value:u.value}),u.focus())},p.Constants.TIMEOUT_DBLCLICK);else if(ce&&!v.ctrlKey&&(clearTimeout(b),!X)){const ge=x.getAttribute("data-node-id");_("/api/block/checkBlockFold",{id:ge},de=>{be({app:n,id:ge,action:de.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:ge===x.getAttribute("data-root-id")?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ROOTSCROLL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:de.data}),a&&a()})}window.siyuan.menus.menu.remove()}else x.querySelector(".b3-list-item__toggle")&&(x.nextElementSibling.classList.toggle("fn__none"),x.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));v.stopPropagation(),v.preventDefault();break}x=x.parentElement}g.classList.add("fn__none"),f.classList.add("fn__none"),(D=t.querySelector("#searchAssetHistoryList"))==null||D.classList.add("fn__none")},!1),u.addEventListener("compositionend",v=>{e.page=1,!v.isComposing&&(w=Ut(t,e,w,m,!0))}),u.addEventListener("input",v=>{e.page=1,!v.isComposing&&(w=Ut(t,e,w,m,!0))}),u.addEventListener("blur",()=>{e.removed&&(e.k=u.value,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]=Object.assign({},e),Ue(p.Constants.LOCAL_SEARCHDATA,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA])),Uf("keys",u.value)}),u.addEventListener("keydown",v=>{let A=c.querySelector(".b3-list-item--focus");if(!A||v.isComposing)return;if(u.value&&U(window.siyuan.config.keymap.editor.general.insertRight.custom,v)){const x=A.getAttribute("data-node-id");_("/api/block/checkBlockFold",{id:x},P=>{be({app:n,id:x,position:"right",action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:x===A.getAttribute("data-root-id")?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ROOTSCROLL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:P.data}),a&&a()}),v.preventDefault(),v.stopPropagation();return}if(u.value&&U(window.siyuan.config.keymap.general.newFile.custom,v)){kc(n,u.value),v.preventDefault(),v.stopPropagation();return}const C=A.getAttribute("data-type")==="search-new",D=!g.classList.contains("fn__none");if(v.key==="Enter"){if(D)u.value=g.querySelector(".b3-list-item--focus").textContent.trim(),e.page=1,w=Ut(t,e,w,m,!0),_l(g,f,u);else if(C)kc(n,u.value);else{const x=A.getAttribute("data-node-id");_("/api/block/checkBlockFold",{id:x},P=>{be({app:n,id:x,action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:x===A.getAttribute("data-root-id")?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ROOTSCROLL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:P.data}),a&&a()})}v.preventDefault()}if(v.key==="ArrowDown"&&v.altKey){_l(g,f,u);return}if(D){v.key==="Escape"?_l(g,f,u):En(g,v),v.stopPropagation(),v.preventDefault();return}if(!(C&&!D)){if(v.key==="ArrowDown")A.classList.remove("b3-list-item--focus"),A.nextElementSibling?A.nextElementSibling.classList.add("b3-list-item--focus"):e.group===1?A.parentElement.nextElementSibling?A.parentElement.nextElementSibling.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):c.children[1].firstElementChild.classList.add("b3-list-item--focus"):c.firstElementChild.classList.add("b3-list-item--focus"),A=c.querySelector(".b3-list-item--focus"),(c.scrollTop<A.offsetTop-c.clientHeight+h||c.scrollTop>A.offsetTop)&&(c.scrollTop=A.offsetTop-c.clientHeight+h),Gi({id:A.getAttribute("data-node-id"),config:e,value:u.value,edit:m}),v.preventDefault();else if(v.key==="ArrowUp")A.classList.remove("b3-list-item--focus"),A.previousElementSibling?A.previousElementSibling.classList.add("b3-list-item--focus"):e.group===1?A.parentElement.previousElementSibling.previousElementSibling?A.parentElement.previousElementSibling.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):c.lastElementChild.lastElementChild.classList.add("b3-list-item--focus"):c.lastElementChild.classList.add("b3-list-item--focus"),A=c.querySelector(".b3-list-item--focus"),(c.scrollTop<A.offsetTop-c.clientHeight+h||c.scrollTop>A.offsetTop-h*2)&&(c.scrollTop=A.offsetTop-h*2),Gi({id:A.getAttribute("data-node-id"),config:e,value:u.value,edit:m}),v.preventDefault();else if(p.Constants.KEYCODELIST[v.keyCode]==="PageUp")t.querySelector('[data-type="previous"]').getAttribute("disabled")||e.page>1&&(e.page--,w=Ut(t,e,w,m)),v.preventDefault();else if(p.Constants.KEYCODELIST[v.keyCode]==="PageDown"){const x=t.querySelector('[data-type="next"]');x.getAttribute("disabled")||e.page<parseInt(x.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(e.page++,w=Ut(t,e,w,m)),v.preventDefault()}}}),d.addEventListener("keydown",v=>{if(v.isComposing)return;const A=!f.classList.contains("fn__none");if(v.key==="Enter"&&(A?(d.value=f.querySelector(".b3-list-item--focus").textContent.trim(),yl(f,g,d)):Fc(t,e,m,!1),v.preventDefault()),v.key==="ArrowDown"&&v.altKey){yl(f,g,d);return}if(A){v.key==="Escape"?yl(f,g,d):En(f,v),v.stopPropagation(),v.preventDefault();return}}),w=Ut(t,e,w,m),m},vl=n=>{let e=window.siyuan.languages.searchMethod+" ";switch(n){case 0:e+=window.siyuan.languages.keyword;break;case 1:e+=window.siyuan.languages.querySyntax;break;case 2:e+="SQL";break;case 3:e+=window.siyuan.languages.regex;break}return e},qc=(n,e,t,a)=>{const i=$(n,"b3-dialog--open");i&&i.getAttribute("data-key")===window.siyuan.config.keymap.general.search.custom&&(e.hPath=t.hPath,e.idPath=t.idPath.join(",").split(",")),t.hasReplace!==e.hasReplace&&(e.hasReplace?n.querySelector("#replaceHistoryBtn").parentElement.classList.remove("fn__none"):n.querySelector("#replaceHistoryBtn").parentElement.classList.add("fn__none"));const s=n.querySelector("#searchPathInput");e.hPath?(s.innerHTML=`${De(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,s.setAttribute("aria-label",De(e.hPath))):(s.innerHTML="",s.setAttribute("aria-label","")),t.group!==e.group&&(e.group===0?n.querySelector("#searchExpand").parentElement.classList.add("fn__none"):n.querySelector("#searchExpand").parentElement.classList.remove("fn__none"));let o=!0,l=!1;e.idPath.forEach(c=>{c.endsWith(".sy")&&(o=!1),c.split("/").length>1&&(l=!0)});const r=n.querySelector("#searchInclude");o?r.classList.remove("b3-button--cancel"):r.classList.add("b3-button--cancel"),l?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),n.querySelector("#searchInput").value=e.k,n.querySelector("#replaceInput").value=e.r,n.querySelector("#searchSyntaxCheck").setAttribute("aria-label",vl(e.method)),Object.assign(t,e),window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]=Object.assign({},t),Ue(p.Constants.LOCAL_SEARCHDATA,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]),Ut(n,t,void 0,a),window.siyuan.menus.menu.remove()},Tw=n=>{let e;const t=Array.from(n.edit.protyle.wysiwyg.element.querySelectorAll(`div[data-node-id="${n.id}"] span[data-type~="search-mark"]`));if(t.find((a,i)=>{if(a.classList.contains("search-mark--hl")){a.classList.remove("search-mark--hl"),e=t[i+1];return}}),e||(e=t[0]),e){e.classList.add("search-mark--hl");const a=n.edit.protyle.contentElement.getBoundingClientRect();n.edit.protyle.contentElement.scrollTop=n.edit.protyle.contentElement.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},Gi=n=>{_("/api/block/checkBlockFold",{id:n.id},e=>{n.edit.protyle.scroll.lastScrollTop=0,os(n.edit.protyle),_("/api/filetree/getDoc",{id:n.id,query:n.value,queryMethod:n.config.method,queryTypes:n.config.types,mode:e.data?0:3,size:e.data?p.Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,zoom:e.data},t=>{dt({data:t,protyle:n.edit.protyle,action:e.data?[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_HTML]});const a=n.edit.protyle.wysiwyg.element.querySelector(`div[data-node-id="${n.id}"] span[data-type~="search-mark"]`);if(a){a.classList.add("search-mark--hl");const i=n.edit.protyle.contentElement.getBoundingClientRect();n.edit.protyle.contentElement.scrollTop=n.edit.protyle.contentElement.scrollTop+a.getBoundingClientRect().top-i.top-i.height/2}})})},Fc=(n,e,t,a)=>{if(e.method===1||e.method===2){q(window.siyuan.languages._kernel[132]);return}const i=n.querySelector("#searchList"),s=n.querySelector("#replaceInput"),o=n.querySelector("#searchInput"),l=s.nextElementSibling;if(!l.classList.contains("fn__none"))return;Uf("replaceKeys",s.value);let r=i.querySelector(".b3-list-item--focus");!r||r.dataset.type==="search-new"||(l.classList.remove("fn__none"),_("/api/search/findReplace",{k:e.method===0?Ew(r):o.value,r:s.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page,ids:a?[]:[r.getAttribute("data-node-id")]},c=>{var u;if(l.classList.add("fn__none"),c.code===1){q(c.msg);return}if(a)return;const d=r.getAttribute("data-root-id");if(Ye().editor.forEach(f=>{d===f.editor.protyle.block.rootID&&zn(f.editor.protyle,!1)}),r.nextElementSibling?r.nextElementSibling.classList.add("b3-list-item--focus"):r.previousElementSibling&&r.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(r.nextElementSibling||r.previousElementSibling)r.remove();else{const f=r.parentElement.nextElementSibling||((u=r.parentElement.previousElementSibling.previousElementSibling)==null?void 0:u.previousElementSibling);f&&(f.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),f.nextElementSibling.classList.remove("fn__none"),f.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),r.parentElement.previousElementSibling.remove(),r.parentElement.remove()}else r.remove();if(r=i.querySelector(".b3-list-item--focus"),!r){i.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,t.protyle.element.classList.add("fn__none"),n.querySelector(".search__drag").classList.add("fn__none");return}(i.scrollTop<r.offsetTop-i.clientHeight+30||i.scrollTop>r.offsetTop)&&(i.scrollTop=r.offsetTop-i.clientHeight+30),Gi({edit:t,id:r.getAttribute("data-node-id"),config:e,value:o.value})}))},Ut=(n,e,t,a,i=!1)=>(clearTimeout(t),t=window.setTimeout(()=>{var s,o;i&&((s=n.querySelector("#criteria .b3-chip--current"))==null||s.classList.remove("b3-chip--current"));const l=n.querySelector("#searchInput"),r=n.querySelector(".fn__loading--top");r.classList.remove("fn__none");const c=l.value;n.querySelector("#searchList").scrollTo(0,0);const u=n.querySelector('[data-type="previous"]'),d=n.querySelector('[data-type="next"]');(o=a.protyle)==null||o.app.plugins.forEach(g=>{g.eventBus.emit("input-search",{protyle:a,config:e,searchElement:l})});const f=n.querySelector("#searchResult");c===""&&(!e.idPath||e.idPath.length===0)?_("/api/block/getRecentUpdatedBlocks",{},g=>{zf(g.data,a,n,e),r.classList.add("fn__none"),f.innerHTML="",u.setAttribute("disabled","true"),d.setAttribute("disabled","true")}):(e.page>1?u.removeAttribute("disabled"):u.setAttribute("disabled","disabled"),_("/api/search/fullTextSearchBlock",{query:c,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page||1},g=>{e.page||(e.page=1),e.page<g.data.pageCount?d.removeAttribute("disabled"):d.setAttribute("disabled","disabled"),zf(g.data.blocks,a,n,e),f.innerHTML=`${e.page}/${g.data.pageCount||1}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.findInDoc.replace("${x}",g.data.matchedRootCount).replace("${y}",g.data.matchedBlockCount)}</span>`,r.classList.add("fn__none"),f.setAttribute("data-pagecount",g.data.pageCount||1)}))},p.Constants.TIMEOUT_INPUT),t),zf=(n,e,t,a)=>{let i="";if(n.forEach((s,o)=>{const l=Xn(s.box)+pt(s.hPath,!1);s.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${fe(rv(s.box)||p.Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text ariaLabel" style="color: var(--b3-theme-on-surface)" aria-label="${ia(l)}">${cl(l)}</span>
</div><div>`,s.children.forEach((r,c)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${c===0&&o===0?" b3-list-item--focus":""}" data-node-id="${r.id}" data-root-id="${r.rootID}">
<svg class="b3-list-item__graphic"><use xlink:href="#${ln(r.type)}"></use></svg>
${fe(r.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${r.content}</span>
</div>`}),i+="</div>"):i+=`<div data-type="search-item" class="b3-list-item${o===0?" b3-list-item--focus":""}" data-node-id="${s.id}" data-root-id="${s.rootID}">
<svg class="b3-list-item__graphic"><use xlink:href="#${ln(s.type)}"></use></svg>
${fe(s.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${s.content}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${Bi(l)}">${cl(l)}</span>
</div>`}),n[0]){e.protyle.element.classList.remove("fn__none"),t.querySelector(".search__drag").classList.remove("fn__none");const s=t.querySelector("#searchInput");n[0].children?Gi({edit:e,id:n[0].children[0].id,config:a,value:s.value}):Gi({edit:e,id:n[0].id,config:a,value:s.value})}else e.protyle.element.classList.add("fn__none"),t.querySelector(".search__drag").classList.add("fn__none");t.querySelector("#searchList").innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${t.querySelector("#searchInput").value}</mark>
    </span>
    <kbd class="b3-list-item__meta">${window.siyuan.languages.enterNew}</kbd>
</div>
<div class="search__empty">
    ${window.siyuan.languages.enterNewTip}
</div>`},Wf=n=>{var e;const t=parseInt(n.getAttribute("data-subtype").substr(1));let a=n.nextElementSibling;for(;a;)if(a.classList.contains("sb")){let i=a.firstElementChild;for(;i&&i.classList.contains("sb");)i=i.firstElementChild;if(i.getAttribute("data-type")==="NodeHeading"&&parseInt(i.getAttribute("data-subtype").substr(1))>t||i.getAttribute("data-type")!=="NodeHeading"){const s=a;a=a.nextElementSibling,s.remove()}else break}else{const i=parseInt((e=a.getAttribute("data-subtype"))==null?void 0:e.substr(1));if(!a.classList.contains("protyle-attr")&&(isNaN(i)||i>t)){const s=a;a=a.nextElementSibling,s.remove()}else break}};class Iw{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled||this.undoStack.length===0)return;const t=this.undoStack.pop();this.render(e,t,!1),this.hasUndo=!0,this.redoStack.push(t)}redo(e){if(e.disabled||this.redoStack.length===0)return;const t=this.redoStack.pop();this.render(e,t,!0),this.undoStack.push(t)}render(e,t,a){ne(["hint","gutter"],e),e.wysiwyg.lastHTMLs={},a?(t.doOperations.forEach(i=>{ad(e,i,!0)}),G(e,t.doOperations)):(t.undoOperations.forEach(i=>{ad(e,i,!0)}),G(e,t.undoOperations)),cn(e),Ge(e)}replace(e){this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1),this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,t){this.undoStack.push({undoOperations:t,doOperations:e}),this.undoStack.length>p.Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1)}clear(){this.undoStack=[],this.redoStack=[]}}const Ma=n=>!1,Dw=(n,e,t)=>{var a,i,s,o,l,r,c,u,d;let f,g="",h=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(h.length===0){let b=Oe(e);const y=S(b,"fold","1");y&&(b=y),(a=b.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(b=Oe(b.parentElement)),h=[b]}const m=h[0].getAttribute("data-type");if(m==="NodeListItem"&&!h[0].previousElementSibling&&((s=(i=h[0].parentElement.previousElementSibling)==null?void 0:i.previousElementSibling)!=null&&s.classList.contains("protyle-action")))if((o=h[0].parentElement.parentElement.previousElementSibling)!=null&&o.classList.contains("li")){if(f=h[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),t.insertNode(document.createElement("wbr")),g=h[0].parentElement.parentElement.parentElement.outerHTML,!f){const b=Lute.NewNodeID();h[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${h[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=h[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(m==="NodeList"&&((r=(l=h[0].previousElementSibling)==null?void 0:l.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=h[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(f=h[0].parentElement.previousElementSibling.querySelector(".list"),t.insertNode(document.createElement("wbr")),g=h[0].parentElement.parentElement.outerHTML,!f){const b=Lute.NewNodeID();h[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${h[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=h[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(f){f=f.lastElementChild.previousElementSibling;const b=h[0].classList.contains("list")?h[0]:h[0].parentElement;h.reverse().forEach(y=>{y.classList.contains("list")?f.after(y.firstElementChild):f.after(y)}),f.id==="moveTempLi"&&(f=f.nextElementSibling,f.previousElementSibling.remove()),b.childElementCount===1?b.remove():b.getAttribute("data-subtype")==="o"&&b.classList.contains("list")&&ct(b,1),f.getAttribute("data-subtype")==="o"&&ct(f.parentElement),ie(n,f.parentElement.parentElement.parentElement.getAttribute("data-node-id"),f.parentElement.parentElement.parentElement.outerHTML,g),cn(n),Ge(n),_e(f.parentElement,t);return}if(!(!h[0].previousElementSibling||(u=h[0].previousElementSibling)!=null&&u.classList.contains("protyle-action"))){if(f=h[0].previousElementSibling,h[0].getAttribute("data-subtype")==="o"&&m==="NodeListItem"){const b=h[0].parentElement.outerHTML;h[h.length-1].after(f),ct(h[0].parentElement,1),ie(n,h[0].parentElement.getAttribute("data-node-id"),h[0].parentElement.outerHTML,b)}else{const b=f.getAttribute("data-node-id");G(n,[{action:"move",id:b,previousID:h[h.length-1].getAttribute("data-node-id")}],[{action:"move",id:b,previousID:(d=f.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||n.block.parentID}]),h[h.length-1].after(f)}cn(n),Ge(n)}},$w=(n,e,t)=>{var a,i,s,o,l,r,c;let u,d="",f=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(f.length===0){let h=Oe(e);const m=S(h,"fold","1");m&&(h=m),(a=h.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(h=Oe(h.parentElement)),f=[h]}const g=f[0].getAttribute("data-type");if(g==="NodeListItem"&&f[f.length-1].nextElementSibling.classList.contains("protyle-attr")&&((i=f[0].parentElement.parentElement)!=null&&i.classList.contains("li")))if((s=f[0].parentElement.parentElement.nextElementSibling)!=null&&s.classList.contains("li")){if(u=f[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),t.insertNode(document.createElement("wbr")),d=f[0].parentElement.parentElement.parentElement.outerHTML,!u){const h=Lute.NewNodeID();f[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${h}" data-type="NodeList" class="list" updated="${h.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=f[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(g==="NodeList"&&f[f.length-1].nextElementSibling.classList.contains("protyle-attr")&&((o=f[0].parentElement)!=null&&o.classList.contains("li")))if((l=f[0].parentElement.nextElementSibling)!=null&&l.classList.contains("li")){if(u=f[0].parentElement.nextElementSibling.querySelector(".list > .li"),t.insertNode(document.createElement("wbr")),d=f[0].parentElement.parentElement.outerHTML,!u){const h=Lute.NewNodeID();f[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${h}" data-type="NodeList" class="list" updated="${h.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=f[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(u){const h=f[0].classList.contains("list")?f[0]:f[0].parentElement;f.forEach(m=>{m.classList.contains("list")?u.before(m.firstElementChild):u.before(m)}),h.childElementCount===1?h.remove():h.getAttribute("data-subtype")==="o"&&h.classList.contains("list")&&ct(h,1),u.getAttribute("data-subtype")==="o"&&ct(u.parentElement,1),ie(n,u.parentElement.parentElement.parentElement.getAttribute("data-node-id"),u.parentElement.parentElement.parentElement.outerHTML,d),cn(n),Ge(n),_e(u.parentElement,t);return}if(!(!f[f.length-1].nextElementSibling||(r=f[f.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(u=f[f.length-1].nextElementSibling,u.getAttribute("data-subtype")==="o"&&u.getAttribute("data-type")==="NodeListItem"){const h=u.parentElement.outerHTML;f[0].before(u),ct(u.parentElement,1),ie(n,u.parentElement.getAttribute("data-node-id"),u.parentElement.outerHTML,h)}else{const h=u.getAttribute("data-node-id");G(n,[{action:"move",id:h,previousID:(c=f[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"move",id:h,previousID:f[f.length-1].getAttribute("data-node-id")}]),f[0].before(u)}cn(n),Ge(n)}},Yf=()=>{if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===window.siyuan.config.keymap.general.dailyNote.custom)return i.destroy(),!0}))return;const e=Wd();if(e===0){q(window.siyuan.languages.newFileTip);return}if(e===1){let i="";window.siyuan.notebooks.find(s=>{s.closed||(i=s.id)}),_("/api/filetree/createDailyNote",{notebook:i,app:p.Constants.SIYUAN_APPID});return}const t=window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID],a=window.siyuan.notebooks.find(i=>{if(i.id===t&&!i.closed)return!0});if(t&&a&&!(0,T.tq)())_("/api/filetree/createDailyNote",{notebook:t,app:p.Constants.SIYUAN_APPID});else{let i="";window.siyuan.notebooks.forEach(r=>{r.closed||(i+=`<option value="${r.id}">${r.name}</option>`)});const s=new Le({title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${i}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"});s.element.setAttribute("data-key",window.siyuan.config.keymap.general.dailyNote.custom);const o=s.element.querySelectorAll(".b3-button"),l=s.element.querySelector(".b3-select");l.value=t,o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const r=l.value;window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]=r,Ue(p.Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]),_("/api/filetree/createDailyNote",{notebook:r,app:p.Constants.SIYUAN_APPID}),s.destroy()})}},El=()=>{const n=p.Constants.HELP_PATH[window.siyuan.config.appearance.lang];_("/api/notebook/removeNotebook",{notebook:n,callback:p.Constants.CB_MOUNT_REMOVE},()=>{_("/api/notebook/openNotebook",{notebook:n})})},Gf=()=>{const n=new Le({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),e=n.element.querySelectorAll(".b3-button");n.bindInput(n.element.querySelector("input"),()=>{e[1].dispatchEvent(new CustomEvent("click"))}),e[0].addEventListener("click",()=>{n.destroy()}),e[1].addEventListener("click",()=>{const t=n.element.querySelector("input").value;if(!ul(t))return!1;_("/api/notebook/createNotebook",{name:t}),n.destroy()})},jf=(n,e,t)=>{if(e.method===1||e.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const a=n.querySelector("#searchList"),i=n.querySelector("#toolbarReplace"),s=i.nextElementSibling;if(!s.classList.contains("fn__none"))return;let o=a.querySelector(".b3-list-item--focus");if(!o)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none"),a.previousElementSibling.innerHTML="";let l=[];t?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{l.push(r.getAttribute("data-node-id"))}):l=[o.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:e.method===0?getKeyByLiElement(o):document.querySelector("#toolbarSearch").value,r:i.value,ids:l,types:e.types,method:e.method},r=>{var c;if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(l.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),o.nextElementSibling?o.nextElementSibling.classList.add("b3-list-item--focus"):o.previousElementSibling&&o.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(o.nextElementSibling||o.previousElementSibling)o.remove();else{const u=o.parentElement.nextElementSibling||((c=o.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);u&&(u.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),u.nextElementSibling.classList.remove("fn__none"),u.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),o.parentElement.previousElementSibling.remove(),o.parentElement.remove()}else o.remove();if(o=a.querySelector(".b3-list-item--focus"),!o){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<o.offsetTop-a.clientHeight+30||a.scrollTop>o.offsetTop)&&(a.scrollTop=o.offsetTop-a.clientHeight+30)}})},Kf=(n,e,t)=>{t.hasReplace!==e.hasReplace&&(e.hasReplace?(n.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),n.querySelector(".toolbar").classList.remove("fn__none")):(n.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),n.querySelector(".toolbar").classList.add("fn__none")));const a=n.querySelector("#searchPath");e.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(e.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),t.group!==e.group&&(e.group===0?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;e.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(s=!0)});const o=n.querySelector('[data-type="include"]');i?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),s?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=e.k,n.querySelector("#toolbarReplace").value=e.r,Object.assign(t,e),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},t),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),Bn(t,n),window.siyuan.menus.menu.remove()},Zf=(n,e,t)=>{const a=document.querySelector("#searchList");let i="";n.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);o.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(o.box)||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,o.children.forEach((c,u)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${u===0&&l===0?" b3-list-item--focus":""}" data-node-id="${c.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(c.type)}"></use></svg>
${unicode2Emoji(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
</div>`}),i+="</div>"):i+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta" style="margin-top: -4px">${escapeGreat(r)}</span>
</div>`}),a.innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let s="";t&&(s=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",t.data.matchedRootCount).replace("${y}",t.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e.page}/${t.data.pageCount||1}</span>`),a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=s};let Xf=0;const Bn=(n,e,t=!1)=>{clearTimeout(Xf),Xf=window.setTimeout(()=>{var a;t&&((a=e.querySelector("#criteria .b3-chip--current"))==null||a.classList.remove("b3-chip--current"));const i=e.querySelector(".fn__loading--top");i.classList.remove("fn__none");const s=e.querySelector('[data-type="previous"]'),o=e.querySelector('[data-type="next"]'),l=document.getElementById("toolbarSearch");l.value===""&&(!n.idPath||n.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},r=>{Zf(r.data,n),i.classList.add("fn__none"),s.setAttribute("disabled","true"),o.setAttribute("disabled","true")}):(n.page||(n.page=1),n.page>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:l.value,method:n.method,types:n.types,paths:n.idPath||[],groupBy:n.group,orderBy:n.sort,page:n.page},r=>{Zf(r.data.blocks,n,r),i.classList.add("fn__none"),n.page<r.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},Pw=(n,e,t)=>{const a=document.getElementById("toolbarSearch");a.value=t.k||"",a.addEventListener("compositionend",c=>{c&&c.isComposing||(t.page=1,Bn(t,e,!0))}),a.addEventListener("input",c=>{c&&c.isComposing||(t.page=1,Bn(t,e,!0))}),a.addEventListener("blur",()=>{t.removed&&(t.k=a.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},t),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]))});const i=e.querySelector(".toolbar .toolbar__title");i.value=t.r||"";const s=[];initCriteriaMenu(e.querySelector("#criteria"),s,t);const o=document.querySelector("#searchAssetsPanel"),l=e.querySelector("#searchList"),r=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];e.addEventListener("click",c=>{var u;let d=c.target;for(;d&&!d.isSameNode(e);){const f=d.getAttribute("data-type");if(f==="previous"){d.getAttribute("disabled")||(t.page--,Bn(t,e)),c.stopPropagation(),c.preventDefault();break}else if(f==="next"){d.getAttribute("disabled")||(t.page++,Bn(t,e)),c.stopPropagation(),c.preventDefault();break}else if(f==="set-criteria"){t.removed=!1,(u=d.parentElement.querySelector(".b3-chip--current"))==null||u.classList.remove("b3-chip--current"),d.classList.add("b3-chip--current"),s.find(g=>{if(g.name===d.innerText.trim())return Kf(e,g,t),!0}),c.stopPropagation(),c.preventDefault();break}else if(f==="remove-criteria"){const g=d.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:g}),s.find((h,m)=>{if(h.name===g)return s.splice(m,1),!0}),d.parentElement.parentElement.childElementCount===1&&d.parentElement.parentElement.classList.add("fn__none"),d.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(f==="remove-path"){t.idPath=[],t.hPath="",e.querySelector("#searchPath").classList.add("fn__none"),t.page=1,Bn(t,e,!0);const g=e.querySelector('[data-type="include"]');g.classList.remove("toolbar__icon--active"),g.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(f==="expand"){Array.from(l.children).forEach(g=>{g.classList.contains("b3-list-item")&&(g.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),g.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(f==="contract"){Array.from(l.children).forEach(g=>{g.classList.contains("b3-list-item")&&(g.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),g.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(f==="currentPath"&&!d.hasAttribute("disabled")){const g=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[g.path]},h=>{t.idPath=[pathPosix().join(g.notebookId,g.path)],t.hPath=h.data[0];const m=e.querySelector("#searchPath");m.classList.remove("fn__none"),m.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const b=e.querySelector('[data-type="include"]');b.classList.remove("toolbar__icon--active"),b.removeAttribute("disabled"),t.page=1,Bn(t,e,!0)}),c.stopPropagation(),c.preventDefault();break}else if(f==="path"){movePathTo((g,h)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:g},m=>{t.idPath=[];const b=[];let y=!1;g.forEach((k,L)=>{k==="/"?(t.idPath.push(h[L]),b.push(getNotebookName(h[L]))):(y=!0,t.idPath.push(pathPosix().join(h[L],k.replace(".sy",""))))}),m.data&&b.push(...m.data),t.hPath=b.join(" ");const w=e.querySelector("#searchPath");w.classList.remove("fn__none"),w.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(t.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const E=e.querySelector('[data-type="include"]');E.classList.add("toolbar__icon--active"),y?E.removeAttribute("disabled"):E.setAttribute("disabled","disabled"),t.page=1,Bn(t,e,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(f==="include"&&!d.hasAttribute("disabled")){d.classList.toggle("toolbar__icon--active"),d.classList.contains("toolbar__icon--active")?t.idPath.forEach((g,h)=>{g.endsWith(".sy")&&(t.idPath[h]=g.replace(".sy",""))}):t.idPath.forEach((g,h)=>{!g.endsWith(".sy")&&g.split("/").length>1&&(t.idPath[h]=g+".sy")}),t.page=1,Bn(t,e,!0),c.stopPropagation(),c.preventDefault();break}else if(f==="toggle-replace"){t.hasReplace=!t.hasReplace,i.parentElement.classList.toggle("fn__none"),d.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(f==="more"){moreMenu(t,s,e,()=>{t.page=1,Bn(t,e,!0)},()=>{Kf(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}},t)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(f==="replace-all"){jf(e,t,!0),c.stopPropagation(),c.preventDefault();break}else if(f==="queryAsset"){assetMethodMenu(d,()=>{assetInputEvent(o,r),setStorageVal(Constants.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(f==="filterAsset"){assetFilterMenu(o),c.stopPropagation(),c.preventDefault();break}else if(f==="moreAsset"){assetMoreMenu(d,o,()=>{assetInputEvent(o),setStorageVal(Constants.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(f==="goAsset"){Mw(),c.stopPropagation(),c.preventDefault();break}else if(f==="goSearch"){o.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(f==="assetPrevious"){d.getAttribute("disabled")||assetInputEvent(o,r,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(f==="assetNext"){d.getAttribute("disabled")||assetInputEvent(o,r,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(f==="replace"){jf(e,t,!1),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__toggle")){d.parentElement.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")){if(d.getAttribute("data-type")==="search-new")newFileByName(n,a.value);else if(d.getAttribute("data-type")==="search-item"){const g=d.getAttribute("data-node-id");g?(window.siyuan.mobile.editor.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),fetchPost("/api/block/checkBlockFold",{id:g},h=>{openMobileFileById(n,g,h.data?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):d.classList.contains("b3-list-item--focus")?d.classList.contains("b3-list-item--focus")&&renderNextAssetMark(e.querySelector("#searchAssetPreview")):(e.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus"),renderPreview(e.querySelector("#searchAssetPreview"),d.dataset.id,e.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else d.querySelector(".b3-list-item__toggle")&&(d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}d=d.parentElement}},!1)},ZE=(n,e=window.siyuan.storage[Constants.LOCAL_SEARCHDATA])=>{activeBlur(),hideKeyboardToolbar();let t=!0,a=!1;e.idPath.forEach(i=>{i.endsWith(".sy")&&(t=!1),i.split("/").length>1&&(a=!0)}),openModel({title:`<input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">`,icon:"iconSearch",html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${e.hasReplace?"":" fn__none"}">
        <svg class="toolbar__icon"><use xlink:href="#iconReplace"></use></svg>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${e.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(e.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${e.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${a?"":"disabled"} data-type="include" class="toolbar__icon${t?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
            <svg class="toolbar__icon"><use xlink:href="#iconSearch"></use></svg>
            <span class="toolbar__text"><input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block"></span>
            <svg class="toolbar__icon" data-type="goSearch">
                <use xlink:href="#iconCloseRound"></use>
            </svg>
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(i){Pw(n,i.firstElementChild,e),Bn(e,i)}})},Mw=()=>{const n=document.querySelector("#searchAssetsPanel");if(n.classList.remove("fn__none"),n.querySelector("#searchAssetList").innerHTML)return;const t=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],a=n.querySelector("input");a.value=t.k,a.addEventListener("compositionend",i=>{i.isComposing||assetInputEvent(n,t)}),a.addEventListener("input",i=>{i.isComposing||assetInputEvent(n,t)}),assetInputEvent(n,t)},XE=n=>{fetchPost("/api/storage/getRecentDocs",{},e=>{let t="";e.data.forEach((a,i)=>{t+=`<li data-index="${i}" data-node-id="${a.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${unicode2Emoji(a.icon||Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(a.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${t}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&openMobileFileById(n,s.dataset.nodeId,[Constants.CB_GET_SCROLL])})}})})},Uc=(n,e)=>{if(!n||n.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let t="";return n.forEach((a,i)=>{let s="";e&&(s=`data-id2="${e[i].fileID}"`),t+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${ia(a.path)} ${a.hSize}">${De(a.title)}</span>
</li>`}),t};let ji,Us;const Nw=(n,e)=>{const t=$(e,"history__diff");if(!t)return;const a=t.nextElementSibling.firstElementChild,i=t.nextElementSibling.lastElementChild;ji||(ji=new hn(n,a.lastElementChild,{blockId:"",action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yn(ji.protyle),Us=new hn(n,i.lastElementChild,{blockId:"",action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yn(Us.protyle)),_("/api/repo/openRepoSnapshotDoc",{id:e.getAttribute("data-id")},o=>{a.classList.remove("fn__none");const l=a.querySelector("textarea"),r=xe().extname(o.data.content).toLowerCase();p.Constants.SIYUAN_ASSETS_IMAGE.concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(r)?(l.previousElementSibling.innerHTML=ai(o.data.content),l.previousElementSibling.classList.remove("fn__none"),l.classList.add("fn__none"),a.lastElementChild.classList.add("fn__none")):o.data.isProtyleDoc?(l.value=o.data.content,l.classList.remove("fn__none"),a.lastElementChild.classList.add("fn__none"),l.previousElementSibling.classList.add("fn__none")):(l.classList.add("fn__none"),a.lastElementChild.classList.remove("fn__none"),l.previousElementSibling.classList.add("fn__none"),dt({data:o,protyle:ji.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]})),a.querySelector(".history__date").textContent=ue(o.data.updated).format("YYYY-MM-DD HH:mm")});const s=e.getAttribute("data-id2");s?(i.classList.remove("fn__none"),_("/api/repo/openRepoSnapshotDoc",{id:s},o=>{const l=i.querySelector("textarea"),r=xe().extname(o.data.content).toLowerCase();p.Constants.SIYUAN_ASSETS_IMAGE.concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(r)?(l.previousElementSibling.innerHTML=ai(o.data.content),l.previousElementSibling.classList.remove("fn__none"),l.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):o.data.isProtyleDoc?(l.value=o.data.content,l.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),l.previousElementSibling.classList.add("fn__none")):(l.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),l.previousElementSibling.classList.add("fn__none"),dt({data:o,protyle:Us.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]})),i.querySelector(".history__date").textContent=ue(o.data.updated).format("YYYY-MM-DD HH:mm")})):i.classList.add("fn__none")},Hw=(n,e)=>{if(e.length!==2)return;let t,a;e[0].time>e[1].time?(t=e[1].id,a=e[0].id):(t=e[0].id,a=e[1].id);const i=new Le({title:window.siyuan.languages.compare,content:"",width:(0,T.tq)()?"92vw":"90vw",height:"80vh",destroyCallback(){ji=void 0,Us=void 0}});i.element.addEventListener("click",s=>{var o;let l=s.target;for(;l&&l!==i.element;){if(l.classList.contains("b3-list-item")&&!l.dataset.id){l.nextElementSibling.classList.toggle("fn__none"),l.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("b3-list-item")&&l.dataset.id){if(l.classList.contains("b3-list-item--focus"))return;(o=i.element.querySelector(".history__diff .b3-list-item--focus"))==null||o.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus"),Nw(n,l),s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("block__icon")){l.getAttribute("data-direct")==="left"?(l.setAttribute("data-direct","right"),Vc(a,t,i,"right")):(l.setAttribute("data-direct","left"),Vc(t,a,i,"left")),s.preventDefault(),s.stopPropagation();break}l=l.parentElement}}),Vc(t,a,i,"left")},Vc=(n,e,t,a)=>{ji=void 0,Us=void 0;const i=(0,T.tq)();_("/api/repo/diffRepoSnapshots",{left:n,right:e},s=>{const o=t.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}">${n.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${ue(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${ue(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__diff">
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${Uc(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${Uc(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${Uc(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="fn__flex-1 fn__flex">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${ue(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${ue(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`})},Jf=n=>{const e=document.getElementById("model");e.style.transform="translateY(0px)",e.querySelector(".toolbar__icon use").setAttribute("xlink:href","#"+n.icon),e.querySelector(".toolbar__text").innerHTML=n.title;const t=e.querySelector("#modelMain");t.innerHTML=n.html,n.bindEvent(t)};let Vs;const zs=(n,e)=>{const t=n.querySelector('[data-type="docprevious"]'),a=n.querySelector('[data-type="docnext"]');n.setAttribute("data-page",e.toString()),e>1?t.removeAttribute("disabled"):t.setAttribute("disabled","disabled");const i=n.querySelector(".b3-text-field"),s=n.querySelector('.b3-select[data-type="opselect"]'),o=n.querySelector('.b3-select[data-type="typeselect"]'),l=n.querySelector('.b3-select[data-type="notebookselect"]');window.siyuan.storage[p.Constants.LOCAL_HISTORYNOTEID]=l.value,Ue(p.Constants.LOCAL_HISTORYNOTEID,window.siyuan.storage[p.Constants.LOCAL_HISTORYNOTEID]);const r=n.querySelector('.history__text[data-type="docPanel"]'),c=n.querySelector('.history__text[data-type="assetPanel"]'),u=n.querySelector('.history__text[data-type="mdPanel"]');r.classList.add("fn__none"),u.classList.add("fn__none"),o.value==="0"||o.value==="1"?(s.removeAttribute("disabled"),l.removeAttribute("disabled"),c.classList.add("fn__none")):(s.setAttribute("disabled","disabled"),l.setAttribute("disabled","disabled"),c.classList.remove("fn__none")),_("/api/history/searchHistory",{notebook:l.value,query:i.value,page:e,op:s.value,type:parseInt(o.value)},d=>{if(e<d.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),a.nextElementSibling.nextElementSibling.textContent=`${e}/${d.data.pageCount||1}`,d.data.histories.length===0){n.lastElementChild.lastElementChild.previousElementSibling.classList.add("fn__none"),n.lastElementChild.lastElementChild.classList.add("fn__none"),n.lastElementChild.firstElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let f="";d.data.histories.forEach(g=>{f+=`<li class="b3-list-item" data-type="toggle" data-created="${g}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${ue(parseInt(g)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),n.lastElementChild.firstElementChild.innerHTML=f})},Qf=(n,e,t)=>{if(n.data.snapshots.length===0){e.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";t==="getCloudRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeCloudRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:t==="getCloudRepoSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>`:t==="getRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="uploadSnapshot" aria-label="${window.siyuan.languages.upload}"><svg><use xlink:href="#iconUpload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:t==="getRepoSnapshots"&&(a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="genTag" aria-label="${window.siyuan.languages.tagSnapshot}"><svg><use xlink:href="#iconTags"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>`);let i="";const s=(0,T.tq)();n.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(c=>{l+=`${c.type} ${c.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${De(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;i+=`<li class="b3-list-item b3-list-item--hide-action" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">${r}</div>
${a}
</li>`}),e.lastElementChild.innerHTML=`${i}`},si=(n,e)=>{const t=n.querySelector(".b3-select").value;n.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const a=n.querySelector('[data-type="previous"]'),i=n.querySelector('[data-type="next"]'),s=i.nextElementSibling.nextElementSibling;n.setAttribute("data-init","true"),t==="getRepoTagSnapshots"||t==="getCloudRepoTagSnapshots"?(_(`/api/repo/${t}`,{},o=>{Qf(o,n,t)}),a.classList.add("fn__none"),i.classList.add("fn__none"),s.classList.add("fn__none")):(a.classList.remove("fn__none"),i.classList.remove("fn__none"),s.classList.remove("fn__none"),n.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.setAttribute("disabled","disabled"),_(`/api/repo/${t}`,{page:e},o=>{e<o.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),s.textContent=`${e}/${o.data.pageCount||1}`,Qf(o,n,t)}))},Bw=n=>{n.setAttribute("data-init","true"),_("/api/history/getNotebookHistory",{},e=>{if(e.data.histories.length===0){n.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let t="";e.data.histories.forEach((a,i)=>{t+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(t+=`<ul class="${i===0?"":"fn__none"}">`,a.items.forEach(s=>{t+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${De(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),t+="</ul>")}),n.innerHTML=t})},zc=n=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(i=>{if(i.element.querySelector("#historyContainer"))return i.destroy(),!0}))return;let t="";window.siyuan.notebooks.forEach(i=>{i.closed||(t+=` <option value="${i.id}"${i.id===window.siyuan.storage[p.Constants.LOCAL_HISTORYNOTEID]?" selected":""}>${De(i.name)}</option>`)});const a=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div style="overflow:auto;">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${(0,T.tq)()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${(0,T.tq)()?"fn__size96":"fn__size200"}">
                        <option value="0" selected>${window.siyuan.languages.docName}</option>
                        <option value="1">${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2">${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${(0,T.tq)()?" fn__size96":""}">
                        <option value="all" selected>${window.siyuan.languages.allOp}</option>
                        <option value="clean">clean</option>
                        <option value="update">update</option>
                        <option value="delete">delete</option>
                        <option value="format">format</option>
                        <option value="sync">sync</option>
                        <option value="replace">replace</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${(0,T.tq)()?"fn__size96":"fn__size200"}">
                        ${t}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background" style="overflow:auto;">
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div style="overflow: auto"">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${(0,T.tq)()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if((0,T.tq)())Jf({html:a,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(i){ep(n,i.firstElementChild)}});else{const i=new Le({content:a,width:"90vw",height:"80vh",destroyCallback(){Vs=void 0}});ep(n,i.element,i)}},ep=(n,e,t)=>{const a=e.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(c=>{c.addEventListener("change",()=>{zs(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",c=>{c.isComposing||zs(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{zs(a,1)});const i=a.querySelector('.history__text[data-type="docPanel"]'),s=a.querySelector('.history__text[data-type="assetPanel"]'),o=a.querySelector('.history__text[data-type="mdPanel"]');zs(a,1),Vs=new hn(n,i,{blockId:"",action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yn(Vs.protyle);const l=e.querySelector('#historyContainer [data-type="repo"]'),r=l.querySelector(".b3-select");r.addEventListener("change",()=>{si(l,1);const c=e.querySelector(".b3-button[data-type='compare']");c.setAttribute("disabled","disabled"),c.removeAttribute("data-ids")}),e.addEventListener("click",c=>{var u;let d=c.target;for(;d&&!d.isEqualNode(e);){const f=d.getAttribute("data-type");if(d.classList.contains("item")){d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(e.querySelector("#historyContainer").children).forEach(g=>{g.getAttribute("data-type")===f?(g.classList.remove("fn__none"),g.classList.add("fn__block"),d.classList.add("item--focus"),g.getAttribute("data-init")!=="true"&&(f==="notebook"?Bw(g):f==="repo"&&si(g,1))):(g.classList.add("fn__none"),g.classList.remove("fn__block"))}),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__action")&&f==="rollback"&&!window.siyuan.config.readonly){Ne("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",d.parentElement.textContent.trim())}`,()=>{const g=d.parentElement.getAttribute("data-type");g==="assets"?_("/api/history/rollbackAssetsHistory",{historyPath:d.parentElement.getAttribute("data-path")}):g==="doc"?_("/api/history/rollbackDocHistory",{notebook:a.querySelector('.b3-select[data-type="notebookselect"]').value,historyPath:d.parentElement.getAttribute("data-path")}):g==="notebook"?_("/api/history/rollbackNotebookHistory",{historyPath:d.parentElement.getAttribute("data-path")}):_("/api/repo/checkoutRepo",{id:d.parentElement.getAttribute("data-id")})}),c.stopPropagation(),c.preventDefault();break}else if(f==="more"){d.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(g=>{g.classList.toggle("fn__none")}),c.stopPropagation(),c.preventDefault();break}else if(f==="toggle"){const g=d.firstElementChild.firstElementChild;if(g.classList.contains("b3-list-item__arrow--open"))d.nextElementSibling.classList.add("fn__none"),g.classList.remove("b3-list-item__arrow--open");else if(d.nextElementSibling&&d.nextElementSibling.tagName==="UL")d.nextElementSibling.classList.remove("fn__none"),g.classList.add("b3-list-item__arrow--open");else{const h=a.querySelector(".b3-text-field"),m=a.querySelector('.b3-select[data-type="opselect"]'),b=a.querySelector('.b3-select[data-type="typeselect"]'),y=a.querySelector('.b3-select[data-type="notebookselect"]');_("/api/history/getHistoryItems",{notebook:y.value,query:h.value,op:m.value,type:parseInt(b.value),created:d.getAttribute("data-created")},w=>{g.classList.add("b3-list-item__arrow--open");let E="";w.data.items.forEach(k=>{E+=`<li title="${ia(k.title)}" data-type="${b.value==="2"?"assets":"doc"}" data-path="${k.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 40px">
    <span class="b3-list-item__text">${De(k.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),d.insertAdjacentHTML("afterend",`<ul>${E}</ul>`)})}c.stopPropagation(),c.preventDefault();break}else if(f==="rmtoggle"){d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")&&f==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(r.value)){const g=e.querySelector(".b3-button[data-type='compare']"),h=JSON.parse(g.getAttribute("data-ids")||"[]"),m=d.getAttribute("data-id");if(d.classList.contains("b3-list-item--focus"))d.classList.remove("b3-list-item--focus"),h.forEach((b,y)=>{m===b.id&&h.splice(y,1)});else{for(d.classList.add("b3-list-item--focus");h.length>1;)h[0].id!==m&&((u=d.parentElement.querySelector(`.b3-list-item[data-id="${h.splice(0,1)[0].id}"]`))==null||u.classList.remove("b3-list-item--focus"));h.push({id:m,time:d.querySelector('[data-type="hCreated"]').textContent})}h.length===2?g.removeAttribute("disabled"):g.setAttribute("disabled","disabled"),g.setAttribute("data-ids",JSON.stringify(h)),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")&&(f==="assets"||f==="doc")){const g=d.getAttribute("data-path");f==="assets"?s.innerHTML=ai(g):f==="doc"&&_("/api/history/getDocHistoryContent",{historyPath:g,k:a.querySelector(".b3-text-field").value},m=>{m.data.isLargeDoc?(o.value=m.data.content,o.classList.remove("fn__none"),i.classList.add("fn__none")):(o.classList.add("fn__none"),i.classList.remove("fn__none"),dt({data:m,protyle:Vs.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]}))});let h=$(d,"b3-list");h&&(h=h.querySelector(".b3-list-item--focus"),h&&h.classList.remove("b3-list-item--focus")),d.classList.add("b3-list-item--focus"),c.stopPropagation(),c.preventDefault();break}else if(f==="genRepo"){const g=new Le({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),h=g.element.querySelector("textarea");h.focus();const m=g.element.querySelectorAll(".b3-button");g.bindInput(h,()=>{m[1].click()}),m[0].addEventListener("click",()=>{g.destroy()}),m[1].addEventListener("click",()=>{_("/api/repo/createSnapshot",{memo:h.value},()=>{si(l,1)}),g.destroy()}),c.stopPropagation(),c.preventDefault();break}else if(f==="removeRepoTagSnapshot"||f==="removeCloudRepoTagSnapshot"){const g=d.parentElement.getAttribute("data-tag");Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${g}</i>?`,()=>{_("/api/repo/"+f,{tag:g},()=>{si(l,1)})}),c.stopPropagation(),c.preventDefault();break}else if(f==="uploadSnapshot"){_("/api/repo/uploadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(f==="downloadSnapshot"){_("/api/repo/downloadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(f==="genTag"){const g=new Le({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${ue().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),h=g.element.querySelector(".b3-text-field");h.select();const m=g.element.querySelectorAll(".b3-button");m[0].addEventListener("click",()=>{g.destroy()}),m[2].addEventListener("click",()=>{_("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:h.value},()=>{_("/api/repo/uploadCloudSnapshot",{tag:h.value,id:d.parentElement.getAttribute("data-id")},()=>{si(l,1)})}),g.destroy()}),m[1].addEventListener("click",()=>{_("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:h.value},()=>{si(l,1)}),g.destroy()}),c.stopPropagation(),c.preventDefault();break}else if((f==="previous"||f==="next")&&d.getAttribute("disabled")!=="disabled"){const g=parseInt(l.getAttribute("data-page"));si(l,f==="previous"?g-1:g+1),c.stopPropagation(),c.preventDefault();break}else if((f==="docprevious"||f==="docnext")&&d.getAttribute("disabled")!=="disabled"){const g=parseInt(a.getAttribute("data-page"));zs(a,f==="docprevious"?g-1:g+1),c.stopPropagation(),c.preventDefault();break}else if(f==="rebuildIndex"){_("/api/history/reindexHistory"),t?t.destroy():(Uw(),Vs=void 0),c.stopPropagation(),c.preventDefault();break}else if(f==="compare"&&!d.getAttribute("disabled")){Hw(n,JSON.parse(d.getAttribute("data-ids")||"[]")),c.stopPropagation(),c.preventDefault();break}d=d.parentElement}})},JE=n=>{document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.classList.remove("fn__none"),e.innerHTML===""&&(e.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.help}</span>
</div>`,e.addEventListener("click",t=>{let a=t.target;for(;a&&!a.isEqualNode(e);){if(a.id==="emptySearch"){popSearch(n),t.stopPropagation(),t.preventDefault();break}else if(a.id==="emptyRecent"){getRecentDocs(n),t.stopPropagation(),t.preventDefault();break}else if(a.id==="emptyHistory"){openHistory(n),t.stopPropagation(),t.preventDefault();break}else if(a.id==="emptyNewFile"){window.siyuan.mobile.editor?newFile({app:n,notebookId:window.siyuan.mobile.editor.protyle.notebookId,currentPath:window.siyuan.mobile.editor.protyle.path,useSavePath:!0}):window.siyuan.notebooks.find(i=>{if(!i.closed)return newFile({app:n,notebookId:i.id,currentPath:"/",useSavePath:!0}),!0}),t.stopPropagation(),t.preventDefault();break}else if(a.id==="emptyNewNotebook"){newNotebook(),t.stopPropagation(),t.preventDefault();break}else if(a.id==="emptyHelp"){mountHelp(),t.stopPropagation(),t.preventDefault();break}a=a.parentElement}}))},QE=()=>{document.getElementById("toolbarName").classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},Wc=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,ek=(n,e,t=[Constants.CB_GET_HL])=>{if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:e},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),window.siyuan.mobile.editor){hideElements(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&setEditMode(window.siyuan.mobile.editor.protyle,"wysiwyg");let a;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find(i=>{if(!hasClosestByAttribute(i.parentElement,"data-type","NodeBlockQueryEmbed"))return a=i,!0}),a){pushBack(),scrollCenter(window.siyuan.mobile.editor.protyle,a,!0),closePanel();return}}fetchPost("/api/block/getBlockInfo",{id:e},a=>{if(a.code===3){showMessage(a.msg);return}window.siyuan.mobile.editor?(pushBack(),addLoading(window.siyuan.mobile.editor.protyle),fetchPost("/api/filetree/getDoc",{id:e,size:t.includes(Constants.CB_GET_ALL)?Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:t.includes(Constants.CB_GET_CONTEXT)?3:0},i=>{onGet({data:i,protyle:window.siyuan.mobile.editor.protyle,action:t})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new Protyle(n,document.getElementById("editor"),{blockId:e,action:t,render:{scroll:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]}}),document.getElementById("toolbarName").value=a.data.rootTitle==="Untitled"?"":a.data.rootTitle,setEditor(),closePanel()})};class Ki{constructor(e,t){this.element=document.createElement("button");const a=t.hotkey?` ${ae(t.hotkey)}`:"",i=t.tip||window.siyuan.languages[t.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${t.tipPosition}`),this.element.setAttribute("data-type",t.name),this.element.setAttribute("aria-label",i+a),this.element.innerHTML=`<svg><use xlink:href="#${t.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(t.name)&&this.element.addEventListener(nt(),s=>{s.preventDefault(),e.toolbar.setInlineMark(e,t.name,"toolbar")})}}class Ow extends Ki{constructor(e,t){super(e,t),this.element.addEventListener("click",()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Yc(e,tp(e))),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0,ee(e.toolbar.range);const a=Cn(e.wysiwyg.element,e.toolbar.range);Ve(e.toolbar.subElement,a.left,a.top+18,26)})}}const Yc=(n,e)=>{let t="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(u=>{t+=`<button class="color__square" data-type="color" style="color:${u}">A</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(u=>{a+=`<button class="color__square" data-type="backgroundColor" style="background-color:${u}"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;e==null||e.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="ft__on-surface fn__flex-center">${ae(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex" style="align-items: center">`,l.forEach(u=>{const d=u.split(p.Constants.ZWSP);switch(d[0]){case"color":o+=`<button class="color__square" data-type="${d[0]}" style="color:${d[1]}">A</button>`;break;case"backgroundColor":o+=`<button class="color__square" data-type="${d[0]}" style="background-color:${d[1]}"></button>`;break;case"style2":o+=`<button data-type="${d[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="${d[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(o+=`<button data-type="${d[0]}" class="protyle-font__style">${d[1]}</button>`);break;case"style1":o+=`<button data-type="${d[0]}" style="background-color:${d[1]};color:${d[2]}" class="color__square">A</button>`;break;case"clear":o+=`<button data-type="${d[0]}" class="protyle-font__style">${window.siyuan.languages.clearFontStyle}</button>`;break}}),o+="</div>");let r,c="16px";return e&&e.length>0?r=e[0]:(r=n.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=S(n.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px"),i.innerHTML=`${o}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${t}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div class="${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${s?" fn__none":""}"></div>
<div class="fn__flex${s?" fn__none":""}">
    <select class="b3-select fn__block">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>
<div class="fn__hr"></div>
<button class="b3-button b3-button--cancel" data-type="clear">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
</button>`,i.addEventListener("click",function(u){let d=u.target;for(;d&&!d.isEqualNode(i);){const f=d.getAttribute("data-type");if(d.tagName==="BUTTON"){f==="style1"?Na(n,e,f,d.style.backgroundColor+p.Constants.ZWSP+d.style.color):f==="fontSize"?Na(n,e,f,d.textContent.trim()):f==="backgroundColor"?Na(n,e,f,d.style.backgroundColor):f==="color"?Na(n,e,f,d.style.color):Na(n,e,f);break}d=d.parentElement}}),i.querySelector("select").addEventListener("change",function(u){Na(n,e,"fontSize",u.target.value)}),i},Na=(n,e,t,a)=>{let i=window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES];if(t)i.splice(0,0,`${t}${p.Constants.ZWSP}${a}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES]=i,Ue(p.Constants.LOCAL_FONTSTYLES,window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES]);else if(i.length===0)t="style1",a="var(--b3-card-error-color)"+p.Constants.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(p.Constants.ZWSP);t=s[0],a=s[1]}e&&e.length>0?(Zs(e,n,s=>{if(t==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="";else if(t==="style1"){const o=a.split(p.Constants.ZWSP);s.style.backgroundColor=o[0],s.style.color=o[1]}else t==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):t==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":t==="color"?s.style.color=a:t==="backgroundColor"?s.style.backgroundColor=a:t==="fontSize"&&(s.style.fontSize=a);(t==="fontSize"||t==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&Xs(s.querySelector(".hljs"))}),ee(n.toolbar.range)):t==="clear"?n.toolbar.setInlineMark(n,"clear","range",{type:"text"}):n.toolbar.setInlineMark(n,"text","range",{type:t,color:a})},Gc=(n,e)=>{const t=s=>{const o=s.split(p.Constants.ZWSP);n.setAttribute("data-id",o.splice(0,1)[0]),n.setAttribute("data-subtype",o.splice(0,1)[0]),n.removeAttribute("data-href"),n.innerText=o.join("")},a=s=>{const o=s.split(p.Constants.ZWSP);n.setAttribute("data-href",o[0]),n.removeAttribute("data-subtype"),n.removeAttribute("data-id"),o[1]&&(n.textContent=o[1])},i=s=>{const o=s.split(p.Constants.ZWSP);n.setAttribute("data-id",o[0]),n.removeAttribute("data-href"),n.removeAttribute("data-subtype"),o[1]&&(n.textContent=o[1])};if(e)switch(e.type){case"color":n.style.color=e.color;break;case"fontSize":n.style.fontSize=e.color;break;case"backgroundColor":n.style.backgroundColor=e.color;break;case"style1":n.style.backgroundColor=e.color.split(p.Constants.ZWSP)[0],n.style.color=e.color.split(p.Constants.ZWSP)[1];break;case"style2":n.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",n.style.webkitTextFillColor="transparent";break;case"style4":n.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":t(e.color);break;case"inline-math":n.className="render-node",n.setAttribute("contenteditable","false"),n.setAttribute("data-subtype","math"),n.setAttribute("data-content",n.textContent.replace(p.Constants.ZWSP,"")),n.removeAttribute("data-render"),n.textContent="";break;case"a":a(e.color);break;case"file-annotation-ref":i(e.color);break;case"inline-memo":n.removeAttribute("contenteditable"),n.removeAttribute("data-subtype"),n.removeAttribute("data-content");break}},Zi=(n,e,t)=>{if(!t)return!0;if(t.type==="inline-math"||t.type==="inline-memo"||t.type==="a")return!1;if(t.type==="id"){if(n.nodeType!==3)return n.getAttribute("data-id")===e.getAttribute("data-id")&&n.getAttribute("data-subtype")===e.getAttribute("data-subtype")&&n.textContent===e.textContent;const c=t.color.split(p.Constants.ZWSP);return c[0]===e.getAttribute("data-id")&&c[1]===e.getAttribute("data-subtype")&&c[2]===e.textContent}if(t.type==="file-annotation-ref")return n.nodeType!==3?n.getAttribute("data-id")===e.getAttribute("data-id")&&n.textContent===e.textContent:t.color===e.getAttribute("data-id");let a="",i="",s="",o="",l="",r="";return n.nodeType!==3&&(a=n.style.color,i=n.style.webkitTextFillColor,s=n.style.webkitTextStroke,o=n.style.textShadow,l=n.style.backgroundColor,r=n.style.fontSize),t.type==="text"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:t.type==="color"?t.color===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:t.type==="backgroundColor"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&t.color===e.style.backgroundColor:t.type==="style1"?t.color.split(p.Constants.ZWSP)[0]===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&t.color.split(p.Constants.ZWSP)[1]===e.style.backgroundColor:t.type==="style2"?a===e.style.color&&e.style.webkitTextFillColor==="transparent"&&e.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:t.type==="style4"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&r===e.style.fontSize&&e.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&l===e.style.backgroundColor:t.type==="fontSize"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&t.color===e.style.fontSize&&l===e.style.backgroundColor:!0},tp=n=>{let e;if(n.toolbar.range.toString()===""&&(e=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0)){const t=M(n.toolbar.range.startContainer);t&&(e=[t])}return e};let np,Ws=!1;const Ce=(n,e,t,a="false")=>{let i;return e&&e.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${e}"></use></svg>`:i=e,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(n)}">
    ${i}
    <span class="keyboard__slash-text">${t}</span>
</button>`},ap=(n,e)=>{let t="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((d,f)=>{t+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" style="color:${d}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${f+1}</span>
</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((d,f)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" style="background-color:${d}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${f+1}</span>
</button>`});const i=tp(n);let s=!1;i==null||i.find(d=>{if(d.classList.contains("list")||d.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,l.forEach(d=>{const f=d.split(p.Constants.ZWSP);switch(f[0]){case"color":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${parseInt(f[1].replace("var(--b3-font-color",""))+1}</span>
</button>`;break;case"backgroundColor":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${parseInt(f[1].replace("var(--b3-font-background",""))+1}</span>
</button>`;break;case"style2":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${f[1]}</span>
</button>`);break;case"style1":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]};color:${f[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[f[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`;break;case"clear":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),o+="</div>");let r,c="16px";i&&i.length>0?r=i[0]:(r=n.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=S(n.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const u=e.querySelector(".keyboard__util");u.innerHTML=`${o}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${t}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,u.querySelector("select").addEventListener("change",function(d){Na(n,i,"fontSize",d.target.value)})},Rw=(n,e)=>{n.hint.splitChar="/",n.hint.lastIndex=-1;const t=e.querySelector(".keyboard__util");t.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ce(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${Ce(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${Ce(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${Ce("((","iconRef",window.siyuan.languages.ref,"true")}
    ${Ce("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${Ce(Constants.ZWSP+5,"iconSparkles","AI Chat")}
    ${Ce(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newFile)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ce("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${Ce("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${Ce("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${Ce("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${Ce("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${Ce("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${Ce("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${Ce("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${Ce("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${Ce("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${Ce("```","iconCode",window.siyuan.languages.code,"true")}
    ${Ce(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${Ce("---","iconLine",window.siyuan.languages.line,"true")}
    ${Ce("$$","iconMath",window.siyuan.languages.math)}
    ${Ce("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ce("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
    ${Ce("a","iconLink",window.siyuan.languages.link)}
    ${Ce("strong","iconBold",window.siyuan.languages.bold,"true")}
    ${Ce("em","iconItalic",window.siyuan.languages.italic,"true")}
    ${Ce("u","iconUnderline",window.siyuan.languages.underline,"true")}
    ${Ce("s","iconStrike",window.siyuan.languages.strike,"true")}
    ${Ce("mark","iconMark",window.siyuan.languages.mark,"true")}
    ${Ce("sup","iconSup",window.siyuan.languages.sup,"true")}
    ${Ce("sub","iconSub",window.siyuan.languages.sub,"true")}
    ${Ce("tag","iconTags",window.siyuan.languages.tag,"true")}
    ${Ce("code","iconInlineCode",window.siyuan.languages["inline-code"],"true")}
    ${Ce("inline-math","iconMath",window.siyuan.languages["inline-math"])}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ce(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(n.options.upload.accept?' multiple="'+n.options.upload.accept+'"':"")+"/>","true")}
    ${Ce('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${Ce("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${Ce('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${Ce('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ce("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${Ce("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${Ce("```flowchart\n```","","Flow Chart","true")}
    ${Ce("```graphviz\n```","","Graph","true")}
    ${Ce("```mermaid\n```","","Mermaid","true")}
    ${Ce("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${Ce("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${Ce(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${Ce(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${Ce(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${Ce(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${Ce(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>`,n.hint.bindUploadEvent(n,t)},jc=n=>{window.siyuan.menus.menu.remove(),Ws=!0;const e=document.getElementById("keyboardToolbar");let t=e.getAttribute("data-keyboardheight");t=(t?parseInt(t)+42:window.innerHeight/2)+"px";const a=Wc();a&&(a.protyle.element.parentElement.style.paddingBottom=t,a.protyle.contentElement.scrollTop=n),setTimeout(()=>{e.style.height=t},p.Constants.TIMEOUT_TRANSITION),setTimeout(()=>{Ws=!1},1e3)},Ys=()=>{const n=document.getElementById("keyboardToolbar");n.style.height="";const e=getCurrentEditor();e&&(e.protyle.element.parentElement.style.paddingBottom="42px"),n.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},qw=()=>{clearTimeout(np),np=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){Xi();return}if(document.activeElement&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){Xi();return}Ws||Ys(),Fw();const n=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),e=getSelection().getRangeAt(0);if(!hasClosestByClassName(e.startContainer,"protyle-wysiwyg",!0)){n[0].classList.add("fn__none"),n[1].classList.add("fn__none");return}e.toString()||n[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(n[0].classList.add("fn__none"),n[1].classList.remove("fn__none")):(n[0].classList.remove("fn__none"),n[1].classList.add("fn__none"));const i=getCurrentEditor().protyle;if(!n[0].classList.contains("fn__none")){i.undo.undoStack.length===0?n[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):n[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?n[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):n[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=hasClosestBlock(e.startContainer);if(s){const o=n[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none"),o.nextElementSibling.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"),o.nextElementSibling.nextElementSibling.classList.add("fn__none"))}}n[1].classList.contains("fn__none")||(n[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(e).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=n[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},Fw=()=>{Ws||Ys();const n=document.getElementById("keyboardToolbar");if(!n.classList.contains("fn__none"))return;n.classList.remove("fn__none"),n.style.zIndex=(++window.siyuan.zIndex).toString();const e=document.getElementById("model");e.style.transform==="translateY(0px)"&&(e.style.paddingBottom="42px");const t=getSelection().getRangeAt(0),a=getCurrentEditor();a&&a.protyle.wysiwyg.element.contains(t.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),setTimeout(()=>{const i=hasClosestByClassName(t.startContainer,"protyle-content",!0);if(i){const s=getSelectionPosition(i).top-i.getBoundingClientRect().top;if(s<window.innerHeight-118.5)return;i.scroll({top:i.scrollTop+s-((window.outerHeight-118.5)/2-26),left:i.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},Xi=()=>{if(Ws)return;const n=document.getElementById("keyboardToolbar");n.classList.add("fn__none"),n.style.height="";const e=Wc();e&&(e.protyle.element.parentElement.style.paddingBottom="");const t=document.getElementById("model");t.style.transform==="translateY(0px)"&&(t.style.paddingBottom="")},Gs=()=>{document.activeElement.blur()},tk=()=>{let n=!1;document.addEventListener("selectionchange",()=>{n||qw()},!1);const e=document.getElementById("keyboardToolbar");e.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="more"><svg><use xlink:href="#iconMore"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,e.addEventListener("click",t=>{var a;const i=(a=getCurrentEditor())==null?void 0:a.protyle,s=t.target,o=hasClosestByClassName(t.target,"keyboard__slash-item");if(o&&!o.getAttribute("data-type")){const d=decodeURIComponent(o.getAttribute("data-value"));i.hint.fill(d,i,!1),d!==Constants.ZWSP+3&&(t.preventDefault(),t.stopPropagation()),o.getAttribute("data-focus")==="true"&&focusByRange(i.toolbar.range);return}const l=hasClosestByMatchTag(s,"BUTTON");if(!l||l.getAttribute("disabled"))return;const r=l.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(r)){const d=getFontNodeElements(i),f=l.firstElementChild;r==="style1"?fontEvent(i,d,r,f.style.backgroundColor+Constants.ZWSP+f.style.color):r==="fontSize"?fontEvent(i,d,r,f.textContent.trim()):r==="backgroundColor"?fontEvent(i,d,r,f.style.backgroundColor):r==="color"?fontEvent(i,d,r,f.style.color):fontEvent(i,d,r)}if(t.preventDefault(),t.stopPropagation(),getSelection().rangeCount===0)return;const c=getSelection().getRangeAt(0);if(r==="done"){e.clientHeight>100?(Ys(),focusByRange(c)):(Gs(),Xi());return}if(window.siyuan.config.readonly||!i||i.disabled)return;if(r==="undo"){i.undo.undo(i);return}else if(r==="redo"){i.undo.redo(i);return}if(getSelection().rangeCount===0)return;const u=hasClosestBlock(c.startContainer);if(u){if(r==="goback"){e.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const d=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");d[0].classList.remove("fn__none"),d[1].classList.add("fn__none"),focusByRange(c),n=!0,setTimeout(()=>{n=!1},1e3);return}else if(r==="goinline"){l.classList.add("protyle-toolbar__item--current");const d=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");d[1].classList.remove("fn__none"),d[0].classList.add("fn__none"),focusByRange(c);return}else if(["a","block-ref","inline-math","inline-memo"].includes(r)){hasClosestByAttribute(c.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],i),i.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click")));return}else if(l.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){hasClosestByAttribute(c.startContainer,"data-type","NodeCodeBlock")||i.toolbar.setInlineMark(i,r,"toolbar");return}else if(r==="text"){if(l.classList.contains("protyle-toolbar__item--current"))Ys(),focusByRange(c);else{l.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const d=i.contentElement.scrollTop;ap(i,e),jc(d)}return}else if(r==="moveup"){moveToUp(i,u,c),focusByRange(c);return}else if(r==="movedown"){moveToDown(i,u,c),focusByRange(c);return}else if(r==="add"){if(l.classList.contains("protyle-toolbar__item--current"))Ys(),focusByRange(c);else{l.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const d=i.contentElement.scrollTop;Rw(i,e),jc(d)}return}else if(r==="more"){i.breadcrumb.showMenu(i,{x:0,y:0,isLeft:!0}),Gs(),Xi();return}else if(r==="block"){i.gutter.renderMenu(i,u),window.siyuan.menus.menu.fullscreen(),Gs(),Xi();return}else if(r==="outdent"){listOutdent(i,[u.parentElement],c),focusByRange(c);return}else if(r==="indent"){listIndent(i,[u.parentElement],c),focusByRange(c);return}}})},nk=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const n=document.querySelector(".side-mask");n.classList.add("fn__none"),n.style.opacity="",window.siyuan.menus.menu.remove()},Uw=()=>{document.getElementById("model").style.transform="",Gs(),Xi()},Kc=null,Vw=n=>{const e=getCurrentEditor().protyle;if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:n.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],e),e.contentElement.classList.contains("fn__none")&&setEditMode(e,"wysiwyg"),e.notebookId=n.data.notebookId,e.path=n.data.path,n.data.startId===e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&n.data.endId===e.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){e.contentElement.scrollTo({top:n.scrollTop,behavior:"smooth"});return}if(n.id!==e.block.rootID&&fetchPost("/api/block/getDocInfo",{id:n.id},t=>{document.getElementById("toolbarName").value=t.data.name==="Untitled"?"":t.data.name,e.background.render(t.data.ial,e.block.rootID),e.wysiwyg.renderCustom(t.data.ial)}),n.zoomId){n.zoomId!==e.block.id?fetchPost("/api/block/checkBlockExist",{id:n.id},t=>{t.data&&zoomOut({protyle:e,id:n.id,isPushBack:!1,callback:()=>{e.contentElement.scrollTop=n.scrollTop}})}):e.contentElement.scrollTop=n.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:n.id,startID:n.data.startId,endID:n.data.endId},t=>{if(e.block.parentID=t.data.parentID,e.block.parent2ID=t.data.parent2ID,e.block.rootID=t.data.rootID,e.block.showAll=!1,e.block.mode=t.data.mode,e.block.blockCount=t.data.blockCount,e.block.id=t.data.id,e.block.action=n.callback,e.wysiwyg.element.setAttribute("data-doc-type",t.data.type),e.wysiwyg.element.innerHTML=t.data.content,processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element,n.scrollTop),t.data.isSyncing)disabledForeverProtyle(e);else{let a=window.siyuan.config.readonly?"true":"false";a==="false"&&(a=e.wysiwyg.element.getAttribute(Constants.CUSTOM_SY_READONLY),a||(a=window.siyuan.config.editor.readOnly?"true":"false")),a==="true"?disabledProtyle(e):enableProtyle(e)}e.contentElement.scrollTop=n.scrollTop})},zw=()=>{const n=Wc().protyle;window.siyuan.backStack.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})},ak=()=>{const n=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const t=document.getElementById("searchAssetsPanel");!t||t.classList.contains("fn__none")?document.getElementById("model").style.transform="":t.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(n&&!n.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],n.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if(window.JSAndroid&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(Kc.length===0&&n){const t=n.protyle;Kc.push({id:t.block.showAll?t.block.id:t.block.rootID,data:{startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:t.notebookId,path:t.path},scrollTop:t.contentElement.scrollTop,callback:t.block.action,zoomId:t.block.showAll?t.block.id:void 0})}const e=window.siyuan.backStack.pop();Kc.push(e),Vw(e)},Ji=(n,e,t)=>{if(!n){e.innerHTML="";return}_("/api/template/render",{id:t,path:n},a=>{e.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},ip=(n,e,t=!0)=>{if(!n.getAttribute("data-type")||!e.getAttribute("data-type"))return!1;n.setAttribute("data-type",n.getAttribute("data-type").replace("search-mark","").trim()),e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim());const a=n.attributes;let i=!0;for(let s=0;s<a.length;s++)e.getAttribute(a[s].name)!==a[s].value&&(i=!1);return i&&(t?n.innerHTML=n.innerHTML+e.innerHTML:n.innerHTML=e.innerHTML+n.innerHTML,e.remove()),i},sp=n=>{let e=n.previousSibling;for(;e&&e.nodeType!==3&&ip(n,e,!1);)e=n.previousSibling;let t=n.nextSibling;for(;t&&t.nodeType!==3&&ip(n,t);)t=n.nextSibling;(n.getAttribute("data-type")||"").includes("search-mark")&&n.setAttribute("data-type",n.getAttribute("data-type").replace("search-mark","").trim())},Zc=(n,e)=>{const t=n.getAttribute("data-type").split(" ");if(t.length===1){const a=n.parentElement;n.outerHTML=n.innerHTML.replace(p.Constants.ZWSP,"")+"<wbr>",e&&_e(a,e)}else t.find((a,i)=>{if(a==="a")return t.splice(i,1),!0}),n.setAttribute("data-type",t.join(" ")),n.removeAttribute("data-href"),e&&(e.selectNodeContents(n),e.collapse(!1),ee(e))},op=n=>{n.element.querySelector(".wysiwygLoading")||(os(n),ne(["toolbar"],n),_("/api/format/netImg2LocalAssets",{id:n.block.rootID},()=>{Ye().editor.forEach(e=>{e.editor.protyle.block.rootID===n.block.rootID&&zn(e.editor.protyle,e.editor.protyle.element.isSameNode(n.element))})}))},kl=(n,e)=>{var t,a;setTimeout(()=>{Oi(["gutter"])},p.Constants.TIMEOUT_TRANSITION);const i=n.className.includes("fullscreen");if(i?(n.classList.remove("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&((t=document.getElementById("drag"))==null||t.classList.remove("fn__hidden"))):(n.classList.add("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&((a=document.getElementById("drag"))==null||a.classList.add("fn__hidden"))),e){i?e.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):e.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const s=$(n,"layout--float");s&&(i?(s.setAttribute("data-temp",s.style.transform),s.style.transform="none"):(s.style.transform=s.getAttribute("data-temp"),s.removeAttribute("data-temp")));return}n.classList.contains("protyle")&&(window.siyuan.editorIsFullscreen=!i),Ye().editor.forEach(s=>{n.isSameNode(s.element)||(window.siyuan.editorIsFullscreen,s.element.classList.contains("fullscreen")&&(s.element.classList.remove("fullscreen"),Bt(s.editor.protyle)))})},lp=(n,e,t,a)=>{const i=e.target;if(U(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return _("/api/filetree/getHPathByID",{id:n.block.rootID},o=>{O(o.data)}),e.preventDefault(),e.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,e))return op(n),e.preventDefault(),e.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,e))return _("/api/format/autoSpace",{id:n.block.rootID}),e.preventDefault(),e.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)||U(window.siyuan.config.keymap.general.dailyNote.custom,e))return e.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e)){const o=t?t.getAttribute("data-node-id"):n.block.rootID;return _("/api/block/getRefText",{id:o},l=>{O(`[${l.data}](siyuan://blocks/${o})`)}),e.preventDefault(),e.stopPropagation(),!0}if(U(window.siyuan.config.keymap.editor.general.backlinks.custom,e)){if(e.preventDefault(),e.stopPropagation(),a){const o=S(a.startContainer,"data-type","block-ref");if(o)return Cl({app:n.app,blockId:o.dataset.id}),!0}return Cl({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||"Untitled":null}),!0}if(U(window.siyuan.config.keymap.editor.general.graphView.custom,e)){if(e.preventDefault(),e.stopPropagation(),a){const o=S(a.startContainer,"data-type","block-ref");if(o)return xl({app:n.app,blockId:o.dataset.id}),!0}return xl({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||"Untitled":null}),!0}if(U(window.siyuan.config.keymap.editor.general.outline.custom,e)){e.preventDefault(),e.stopPropagation();const o=Et(i);return $p(n),Fn(i,o.start,o.end),!0}let s=!1;if(n.app.plugins.find(o=>{if(o.commands.find(l=>{if(l.editorCallback&&U(l.customHotkey,e))return s=!0,l.editorCallback(n),!0}),s)return!0}),s)return!0},rp=n=>{const e=n.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)n.event.stopPropagation(),n.event.preventDefault();else if(Et(n.nodeElement,n.editorElement,n.range).start!==0){const a=J(n.nodeElement);if(a.tagName==="TABLE"){const i=te(n.range.startContainer,"TH")||te(n.range.startContainer,"TD")||a.querySelector("th, td");if(Et(i,i,n.range).start!==0){ar(i,n.range),n.event.stopPropagation(),n.event.preventDefault();return}}else return}n.range.collapse(!0),ne(["toolbar"],n.protyle),e.length===0?n.nodeElement.classList.add("protyle-wysiwyg--select"):n.cb(e);const t=[];n.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{t.push(a.getAttribute("data-node-id"))}),zt(t,n.protyle.block.rootID),n.event.stopPropagation(),n.event.preventDefault()},cp=n=>{const e=n.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)n.event.stopPropagation(),n.event.preventDefault();else if(Et(n.nodeElement,n.editorElement,n.range).end<J(n.nodeElement).textContent.length)return;n.range.collapse(!1),ne(["toolbar"],n.protyle),e.length===0?n.nodeElement.classList.add("protyle-wysiwyg--select"):n.cb(e);const t=[];n.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{t.push(a.getAttribute("data-node-id"))}),zt(t,n.protyle.block.rootID),n.event.stopPropagation(),n.event.preventDefault()},Sl=n=>{let e,t;return n.forEach(a=>{a.getAttribute("select-start")&&(e=a),a.getAttribute("select-end")&&(t=a)}),e||(e=n[0],e.setAttribute("select-start","true")),t||(t=n[n.length-1],t.setAttribute("select-end","true")),{startElement:e,endElement:t}},Xc=(n,e)=>{let t;const a=[],i=[];n.reverse().forEach((s,o)=>{const l=s.cloneNode(!0);o===0&&(t=l);const r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.querySelectorAll("[data-node-id]").forEach(c=>{c.setAttribute("data-node-id",Lute.NewNodeID())}),s.classList.remove("protyle-wysiwyg--select"),n[0].after(l),a.push({action:"insert",data:l.outerHTML,id:r,previousID:n[0].getAttribute("data-node-id")}),i.push({action:"delete",id:r})}),G(e,a,i),we(t),Ge(e)},dp=n=>{n.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||n.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||n.options.backlinkData?(we(n.wysiwyg.element.firstElementChild),n.contentElement.scrollTop=0,n.scroll.lastScrollTop=1):_("/api/filetree/getDoc",{id:n.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{dt({data:e,protyle:n,action:[p.Constants.CB_GET_FOCUS]})})},up=n=>{!n.scroll.element.classList.contains("fn__none")&&n.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?_("/api/filetree/getDoc",{id:n.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{dt({data:e,protyle:n,action:[p.Constants.CB_GET_FOCUS]})}):(n.contentElement.scrollTop=n.contentElement.scrollHeight,n.scroll.lastScrollTop=n.contentElement.scrollTop,we(n.wysiwyg.element.lastElementChild,void 0,!1))},fp=(n,e,t,a,i)=>{e.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),t.forEach(s=>{s.style.display="block";let o=s.nextSibling;for(;o;)if(o.textContent==="")o=o.nextSibling;else if(o.textContent===p.Constants.ZWSP){o.textContent="";break}else break;let l=s.previousSibling;for(;l;)if(l.textContent==="")l=l.previousSibling;else if(l.textContent===p.Constants.ZWSP){l.textContent="";break}else break}),ie(n,a,e.outerHTML,i)},pp=(n,e,t,a,i)=>{e.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),t.forEach(s=>{s.style.display="",rt(s)||s.insertAdjacentText("afterend",p.Constants.ZWSP),ot(s)||s.insertAdjacentText("beforebegin",p.Constants.ZWSP)}),ie(n,a,e.outerHTML,i)};var Ww=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Jc=(n,e)=>{var t;const a=M(e);if(!a)return;ne(["util","toolbar","hint"],n);const i=a.getAttribute("data-node-id"),s=a.outerHTML;window.siyuan.menus.menu.remove();let o;window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" value="${e.getAttribute("data-id")||""}" readonly placeholder="ID">`}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" data-type="anchor" placeholder="${window.siyuan.languages.anchor}">`,bind(r){o=r.querySelector("input"),o.value=e.textContent;const c=()=>{o.value?e.innerHTML=Lute.EscapeHTMLStr(o.value):e.innerHTML="*"};o.addEventListener("input",u=>{u.isComposing||(c(),u.stopPropagation())}),o.addEventListener("compositionend",u=>{u.isComposing||(c(),u.stopPropagation())}),o.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(Ma(u))return}})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.outerHTML=e.textContent+"<wbr>"}}).element),window.siyuan.menus.menu.append(new I({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){const r=a.outerHTML;Zc(e,n.toolbar.range),ie(n,i,a.outerHTML,r)}}).element),(t=n==null?void 0:n.app)!=null&&t.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:n,element:e},separatorPosition:"top"});const l=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26}),o.select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==s&&(a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,i,a.outerHTML,s));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!n.element.contains(r.startContainer)&&(e.parentElement?(n.toolbar.range.selectNodeContents(e),n.toolbar.range.collapse(!1),ee(n.toolbar.range)):_e(a,n.toolbar.range))}},Qc=(n,e)=>{var t;const a=M(e);if(!a)return;ne(["util","toolbar","hint"],n);const i=e.getAttribute("data-id"),s=a.getAttribute("data-node-id");let o=a.outerHTML;if(window.siyuan.menus.menu.remove(),n.disabled||(window.siyuan.menus.menu.append(new I({label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const c=r.querySelector("input");c.value=e.getAttribute("data-subtype")==="d"?"":e.textContent,c.addEventListener("input",()=>{c.value?e.innerHTML=Lute.EscapeHTMLStr(c.value):_("/api/block/getRefText",{id:i},u=>{e.innerHTML=u.data}),e.setAttribute("data-subtype",c.value?"s":"d")}),c.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(Ma(u))return}})}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element)),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.openBy,accelerator:window.siyuan.config.keymap.editor.general.openBy.custom+"/Click",click(){_("/api/block/checkBlockFold",{id:i},r=>{be({app:n.app,id:i,action:r.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:r.data})})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.refTab,accelerator:window.siyuan.config.keymap.editor.general.refTab.custom+"/\u2318Click",click(){_("/api/block/checkBlockFold",{id:i},r=>{be({app:n.app,id:i,action:r.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:r.data})})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.insertRight,icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.editor.general.insertRight.custom+"/\u2325Click",click(){_("/api/block/checkBlockFold",{id:i},r=>{be({app:n.app,id:i,position:"right",action:r.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:r.data})})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.insertBottom,icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.editor.general.insertBottom.custom+(window.siyuan.config.keymap.editor.general.insertBottom.custom?"/":"")+"\u21E7Click",click(){_("/api/block/checkBlockFold",{id:i},r=>{be({app:n.app,id:i,position:"bottom",action:r.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:r.data})})}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{Cl({app:n.app,blockId:i})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{xl({app:n.app,blockId:i})}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),!n.disabled){let r=[];e.getAttribute("data-subtype")==="s"?r.push({label:window.siyuan.languages.turnToDynamic,click(){e.setAttribute("data-subtype","d"),_("/api/block/getRefText",{id:i},c=>{e.innerHTML=c.data,a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o)}),ee(n.toolbar.range)}}):r.push({label:window.siyuan.languages.turnToStatic,click(){e.setAttribute("data-subtype","s"),a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),ee(n.toolbar.range)}}),r=r.concat([{label:window.siyuan.languages.text,click(){e.outerHTML=`${e.innerHTML}<wbr>`,a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),_e(a,n.toolbar.range)}},{label:"*",click(){e.setAttribute("data-subtype","s"),e.textContent="*",a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),ee(n.toolbar.range)}},{label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.setAttribute("data-subtype","s"),e.textContent="*",a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),ee(n.toolbar.range)}},{label:window.siyuan.languages.link,icon:"iconLink",click(){e.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${e.getAttribute("data-id")}">${e.innerHTML}</span><wbr>`,a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),_e(a,n.toolbar.range)}}]),e.parentElement.textContent.trim()===e.textContent.trim()&&e.parentElement.tagName==="DIV"&&r.push({label:window.siyuan.languages.blockEmbed,icon:"iconSQL",click(){const c=`<div data-content="select * from blocks where id='${i}'" data-node-id="${s}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${ue().format("YYYYMMDDHHmmss")}">${a.querySelector(".protyle-attr").outerHTML}</div>`;a.outerHTML=c,ie(n,s,c,o),Ke(n,n.wysiwyg.element)}}),r.push({label:window.siyuan.languages.defBlock,click(){_("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!1})}}),r.push({label:window.siyuan.languages.defBlockChildren,click(){_("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!0})}}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:r}).element)}window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=e.getAttribute("data-subtype")==="s"?'"':"'";O(`((${i} ${r}${e.textContent}${r}))`)}}).element),n.disabled||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),_e(a,n.toolbar.range)}}).element),(t=n==null?void 0:n.app)!=null&&t.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-blockref",detail:{protyle:n,element:e},separatorPosition:"top"});const l=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26}),n.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==o&&(a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,a.outerHTML,o),o=a.outerHTML);const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!n.element.contains(r.startContainer)&&(n.toolbar.range.selectNodeContents(e),n.toolbar.range.collapse(!1),ee(n.toolbar.range))})},Yw=(n,e)=>{var t,a,i;const s=he(e);if(window.siyuan.menus.menu.remove(),s.toString()!==""||(a=(t=s.cloneContents().childNodes[0])==null?void 0:t.classList)!=null&&a.contains("emoji")){if(window.siyuan.menus.menu.append(new I({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){ee(he(e)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){ee(he(e));const o=getSelection().getRangeAt(0).cloneContents();o.querySelectorAll('[data-type="backslash"]').forEach(l=>{l.firstElementChild.remove()}),Y(o.textContent)}}).element),n.disabled)return;window.siyuan.menus.menu.append(new I({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){ee(he(e)),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click(){const o=he(e);o.insertNode(document.createElement("wbr"));const l=e.outerHTML;o.extractContents(),_e(e,o),ee(o),ie(n,e.getAttribute("data-node-id"),e.outerHTML,l)}}).element)}if(!n.disabled){let o;window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",click(){return Ww(this,null,function*(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const l=yield R();Oc(n,l,e)}catch(l){console.log(l)}})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click(){ee(he(e)),Bc(n)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.pasteEscaped,click(){Bf(n,e)}}).element)}if(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click(){mo(n,e,s)}}).element),e.classList.contains("table")){const o=te(s.startContainer,"TD")||te(s.startContainer,"TH");o&&window.siyuan.menus.menu.append(new I({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:gp(n,e,o,s)}).element)}(i=n==null?void 0:n.app)!=null&&i.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-content",detail:{protyle:n,range:s,element:e},separatorPosition:"top"})},ed=(n,e)=>{if(n.block.showAll)Yt({protyle:n,id:n.block.parent2ID,focusId:e});else{const t=n.path.split("/");t.length>2&&be({app:n.app,id:t[t.length-2],action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]})}},Yt=n=>{var e,t;if(n.protyle.options.backlinkData)return;typeof n.isPushBack=="undefined"&&(n.isPushBack=!0),typeof n.reload=="undefined"&&(n.reload=!1);const a=(e=n.protyle.breadcrumb)==null?void 0:e.element.querySelector(".protyle-breadcrumb__item--active");if(!n.reload&&a&&a.getAttribute("data-node-id")===n.id){if(n.id===n.protyle.block.rootID)return;const i=n.protyle.wysiwyg.element.querySelector(`[data-node-id="${n.focusId||n.id}"]`);if(i){we(i),i.scrollIntoView();return}}(t=window.siyuan.mobile)!=null&&t.editor&&(window.siyuan.storage[p.Constants.LOCAL_DOCINFO]={id:n.id},Ue(p.Constants.LOCAL_DOCINFO,window.siyuan.storage[p.Constants.LOCAL_DOCINFO]),n.isPushBack&&zw()),_("/api/filetree/getDoc",{id:n.id,size:n.id===n.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.Constants.SIZE_GET_MAX},i=>{if(n.isPushBack?dt({data:i,protyle:n.protyle,action:n.id===n.protyle.block.rootID?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_HTML],afterCB:n.callback}):dt({data:i,protyle:n.protyle,action:n.id===n.protyle.block.rootID?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_HTML,p.Constants.CB_GET_UNUNDO]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO,p.Constants.CB_GET_HTML],afterCB:n.callback}),n.focusId){const s=n.protyle.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`);if(s)we(s),s.scrollIntoView();else if(n.id===n.protyle.block.rootID){_("/api/filetree/getDoc",{id:n.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{dt({data:o,protyle:n.protyle,action:n.isPushBack?[p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO]})});return}}else n.id!==n.protyle.block.rootID&&(n.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{n.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365));if(n.protyle.model){const s=Ye();s.outline.forEach(o=>{o.blockId===n.protyle.block.rootID&&o.setCurrent(n.protyle.wysiwyg.element.querySelector(`[data-node-id="${n.focusId||n.id}"]`))}),Fd(s,n.protyle)}})},td=(n,e,t,a)=>{var i;window.siyuan.menus.menu.remove();const s=M(t);if(!s)return;ne(["util","toolbar","hint"],n);const o=s.getAttribute("data-node-id"),l=t.querySelector("img"),r=t.querySelector(".protyle-action__title"),c=s.outerHTML;window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<textarea style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.imageURL}">${l.getAttribute("src")}</textarea>`,bind(h){h.querySelector("textarea").addEventListener("input",m=>{if(m.isComposing)return;const b=m.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");if(l.setAttribute("src",b),l.setAttribute("data-src",b),b.startsWith("assets/")){const y=t.querySelector(".img__net");y&&y.remove()}else window.siyuan.config.editor.displayNetImgMark&&t.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')})}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<textarea style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.title}"></textarea>`,bind(h){const m=h.querySelector("textarea");m.value=r.textContent,m.addEventListener("input",b=>{const y=b.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");l.setAttribute("title",y),r.textContent=y,ra(r),t.style.maxWidth=l.clientWidth+10+"px"})}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<textarea style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.tooltipText}"></textarea>`,bind(h){h.querySelector("textarea").value=l.getAttribute("alt")||""}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){O(n.lute.BlockDOM2StdMd(t.outerHTML))}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy+" PNG",accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){wf(l)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){O(n.lute.BlockDOM2StdMd(t.outerHTML)),t.outerHTML="<wbr>",s.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,o,s.outerHTML,c),_e(n.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){t.outerHTML="<wbr>",s.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,o,s.outerHTML,c),_e(n.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element);const u=l.getAttribute("data-src");u.startsWith("assets/")&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.rename,click(){vc(u)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){fp(n,s,[t],o,c)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){pp(n,s,[t],o,c)}}).element);const d=parseInt(t.style.width||"0");window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.width,submenu:[oi("25%",t,l,n,o,s,c),oi("33%",t,l,n,o,s,c),oi("50%",t,l,n,o,s,c),oi("67%",t,l,n,o,s,c),oi("75%",t,l,n,o,s,c),oi("100%",t,l,n,o,s,c),{type:"separator"},{label:`<div aria-label="${d===0?window.siyuan.languages.default:d+"%"}" class="b3-tooltips b3-tooltips__n${(0,T.tq)()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${d}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(h){const m=h.querySelector("input");m.addEventListener("input",()=>{t.style.width=m.value+"%",l.style.width="10000px",t.style.maxWidth="",m.parentElement.setAttribute("aria-label",`${m.value}%`)}),m.addEventListener("change",()=>{s.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,o,s.outerHTML,c),window.siyuan.menus.menu.remove(),we(s)})}},{type:"separator"},oi(window.siyuan.languages.default,t,l,n,o,s,c)]}).element);const f=l.getAttribute("src");f&&(window.siyuan.menus.menu.append(new I({type:"separator"}).element),Js(n.app,f,!1,!1)),(i=n==null?void 0:n.app)!=null&&i.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-image",detail:{protyle:n,element:t},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const g=window.siyuan.menus.menu.element.querySelectorAll("textarea");g[0].focus(),window.siyuan.menus.menu.removeCB=()=>{const h=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');h&&_("/api/asset/setImageOCRText",{path:l.getAttribute("src"),text:h.value}),l.setAttribute("alt",g[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),s.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,o,s.outerHTML,c)}},js=(n,e,t=!1)=>{var a;window.siyuan.menus.menu.remove();const i=M(e);if(!i)return;ne(["util","toolbar","hint"],n);const s=i.getAttribute("data-node-id"),o=i.outerHTML,l=e.getAttribute("data-href");window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,T.tq)()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.link}"></textarea>`,bind(u){const d=u.querySelector("textarea");d.value=Lute.UnEscapeHTMLStr(l)||"",d.addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),u.nextElementSibling.querySelector("textarea").focus();else if(Ma(f))return})}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<textarea style="width: ${(0,T.tq)()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.anchor}"></textarea>`,bind(u){const d=u.querySelector("textarea");let f=e.textContent.replace(p.Constants.ZWSP,"");!f&&l&&(f=l.replace("https://","").replace("http://",""),f.length>24&&(f=f.substring(0,p.Constants.SIZE_LINK_TEXT_MAX)+"..."),e.innerHTML=Lute.EscapeHTMLStr(f)),d.value=f,d.addEventListener("compositionend",()=>{e.innerHTML=Lute.EscapeHTMLStr(d.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),d.addEventListener("input",g=>{g.isComposing||(e.innerHTML=Lute.EscapeHTMLStr(d.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),d.addEventListener("keydown",g=>{if((g.key==="Enter"||g.key==="Escape")&&!g.isComposing)g.preventDefault(),g.stopPropagation(),window.siyuan.menus.menu.remove();else if(g.key==="Tab"&&!g.isComposing)g.preventDefault(),g.stopPropagation(),g.shiftKey?u.previousElementSibling.querySelector("textarea").focus():u.nextElementSibling.querySelector("textarea").focus();else if(Ma(g))return})}}).element),window.siyuan.menus.menu.append(new I({iconHTML:"",label:`<textarea style="width: ${(0,T.tq)()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.title}"></textarea>`,bind(u){const d=u.querySelector("textarea");d.value=Lute.UnEscapeHTMLStr(e.getAttribute("data-title")||""),d.addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&f.shiftKey&&!f.isComposing)f.preventDefault(),f.stopPropagation(),u.previousElementSibling.querySelector("textarea").focus();else if(Ma(f))return})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const u=i.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),i.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,i.outerHTML,u),_e(i,n.toolbar.range)}}).element),window.siyuan.menus.menu.append(new I({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){Zc(e,n.toolbar.range),ie(n,s,i.outerHTML,o)}}).element),l!=null&&l.startsWith("assets/")&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.rename,click(){vc(l)}}).element),l!=null&&l.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new I({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){e.setAttribute("data-subtype","s");const u=e.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),e.setAttribute("data-type",u.join(" ")),e.setAttribute("data-id",l==null?void 0:l.replace("siyuan://blocks/","")),e.removeAttribute("data-href"),e.removeAttribute("data-title"),i.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,i.outerHTML,o),n.toolbar.range.selectNode(e),n.toolbar.range.collapse(!1),ee(n.toolbar.range)}}).element),l&&(window.siyuan.menus.menu.append(new I({type:"separator"}).element),Js(n.app,l,!1,!0)),(a=n==null?void 0:n.app)!=null&&a.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-link",detail:{protyle:n,element:e},separatorPosition:"top"});const r=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:r.left,y:r.top+26,h:26});const c=window.siyuan.menus.menu.element.querySelectorAll("textarea");t||n.lute.IsValidLinkDest(l)?c[1].select():c[0].select(),window.siyuan.menus.menu.removeCB=()=>{c[2].value?e.setAttribute("data-title",Lute.EscapeHTMLStr(c[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-title"),e.setAttribute("data-href",Lute.EscapeHTMLStr(c[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")));const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);e.textContent===""||e.textContent===p.Constants.ZWSP?Zc(e,u&&!n.element.contains(u.startContainer)?n.toolbar.range:void 0):u&&!n.element.contains(u.startContainer)&&(n.toolbar.range.selectNodeContents(e),n.toolbar.range.collapse(!1),ee(n.toolbar.range)),i.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,s,i.outerHTML,o)}},nd=(n,e)=>{var t;window.siyuan.menus.menu.remove();const a=M(e);if(!a)return;ne(["util","toolbar","hint"],n);const i=a.getAttribute("data-node-id");let s=a.outerHTML;window.siyuan.menus.menu.append(new I({label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(l){const r=l.querySelector("input");r.value=e.textContent.replace(p.Constants.ZWSP,""),r.addEventListener("change",()=>{ie(n,i,a.outerHTML,s),s=a.outerHTML}),r.addEventListener("compositionend",()=>{e.innerHTML=p.Constants.ZWSP+Lute.EscapeHTMLStr(r.value||"")}),r.addEventListener("input",c=>{c.isComposing||(e.innerHTML=p.Constants.ZWSP+Lute.EscapeHTMLStr(r.value||""))}),r.addEventListener("keydown",c=>{if((c.key==="Enter"||c.key==="Escape")&&!c.isComposing){if(c.preventDefault(),c.stopPropagation(),r.value)n.toolbar.range.selectNodeContents(e),n.toolbar.range.collapse(!1),ee(n.toolbar.range);else{const u=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,i,a.outerHTML,u),_e(a,n.toolbar.range)}window.siyuan.menus.menu.remove()}else if(Ma(c))return})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.search,accelerator:"Click",icon:"iconSearch",click(){Hn(n.app,`#${e.textContent}#`,!1)}}).element),window.siyuan.menus.menu.append(new I({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){n.toolbar.range.setStart(e.firstChild,0),n.toolbar.range.setEnd(e.lastChild,e.lastChild.textContent.length),n.toolbar.setInlineMark(n,"tag","range")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.rename,click(){Wu(e.textContent.replace(p.Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const l=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,i,a.outerHTML,l),_e(a,n.toolbar.range)}}).element),(t=n==null?void 0:n.app)!=null&&t.plugins&&Qt({plugins:n.app.plugins,type:"open-menu-tag",detail:{protyle:n,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),window.siyuan.menus.menu.element.querySelector("input").select()},oi=(n,e,t,a,i,s,o)=>({label:n,click(){s.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),n===window.siyuan.languages.default?(e.style.display==="block"?(e.style.width="",e.style.maxWidth=""):e.removeAttribute("style"),t.removeAttribute("style")):(e.style.width=n,e.style.maxWidth="",t.style.width="10000px"),ie(a,i,s.outerHTML,o),we(s)}}),Gw=(n,e)=>{const t=e.getAttribute("data-node-id"),a=e.querySelector("iframe");let i=e.outerHTML;const s=[{iconHTML:"",label:`<textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(l){l.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""),u=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||u&&u[1])){const d={bvid:(0,T.on)("bvid",c)||u&&u[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((h,m)=>{m===0&&(h=h.substr(1));const b=h.split("=");d[b[0]]=b[1]});let f="https://player.bilibili.com/player.html?";const g=Object.keys(d);g.forEach((h,m)=>{f+=`${h}=${d[h]}`,m<g.length-1&&(f+="&")}),a.setAttribute("src",f),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",c);ie(n,t,e.outerHTML,i),i=e.outerHTML,r.stopPropagation()})}}],o=a.getAttribute("src");return o?(s.push({type:"separator"}),s.concat(Js(n.app,o,!0,!1))):s},jw=(n,e,t)=>{const a=e.getAttribute("data-node-id"),i=e.querySelector(t==="NodeVideo"?"video":"audio");let s=e.outerHTML;const o=[{iconHTML:"",label:`<textarea rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(c){c.querySelector("textarea").addEventListener("change",u=>{i.setAttribute("src",u.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),ie(n,a,e.outerHTML,s),s=e.outerHTML,u.stopPropagation()})}}],l=i.getAttribute("src");l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({label:window.siyuan.languages.rename,click(){vc(l)}}));const r=i.getAttribute("src");return r&&o.push({label:window.siyuan.languages.openBy,submenu:Js(n.app,r,!0,!1)}),o},gp=(n,e,t,a)=>{var i;const s=[],o=vn(t);(t.rowSpan>1||t.colSpan>1)&&s.push({label:window.siyuan.languages.cancelMerged,click:()=>{const C=e.outerHTML;let D=t.rowSpan,x=t.parentElement;const P=t.colSpan;for(;D>0&&x;){let B=x.children[o],V=P;for(;V>0&&B;)B.classList.remove("fn__none"),B.colSpan=1,B.rowSpan=1,B=B.nextElementSibling,V--;x=x.nextElementSibling,D--}if(t.rowSpan=1,t.colSpan=1,t.tagName==="TH"){let B;if(Array.from(e.querySelectorAll("thead tr")).find(V=>{if(B=V,Array.from(V.children).forEach(X=>{(X.rowSpan!==1||X.classList.contains("fn__none"))&&(B=void 0)}),B)return!0}),B){const V=e.querySelector("tbody"),X=e.querySelector("thead");for(;!B.isSameNode(X.lastElementChild);)V.insertAdjacentElement("afterbegin",X.lastElementChild)}}ee(a),ie(n,e.getAttribute("data-node-id"),e.outerHTML,C)}});const l=e.querySelectorAll("col")[o];(l.style.width||l.style.minWidth)&&s.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const C=e.outerHTML;l.style.width="",l.style.minWidth="",ie(n,e.getAttribute("data-node-id"),e.outerHTML,C)}});const r=e.getAttribute("custom-pinthead");s.push({icon:"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const C=e.outerHTML;r?e.removeAttribute("custom-pinthead"):e.setAttribute("custom-pinthead","true"),ie(n,e.getAttribute("data-node-id"),e.outerHTML,C)}}),s.push({type:"separator"}),s.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{ca(n,[t],e,"left",a)}}),s.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{ca(n,[t],e,"center",a)}}),s.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{ca(n,[t],e,"right",a)}}),s.push({type:"separator"});const c=e.querySelector("table"),u=t.parentElement.querySelector(".fn__none");let d=!1,f=!1;Array.from(t.parentElement.children).forEach(C=>{C.colSpan>1&&(d=!0),C.rowSpan>1&&(f=!0)});let g=!1,h=!1,m=!1,b=t.parentElement.previousElementSibling;!b&&t.parentElement.parentElement.tagName==="TBODY"&&(b=c.querySelector("thead").lastElementChild),b&&(g=b.querySelector(".fn__none"),Array.from(b.children).forEach(C=>{C.colSpan>1&&(h=!0),C.rowSpan>1&&(m=!0)}));let y=!1,w=!1,E=!1,k=t.parentElement.nextElementSibling;!k&&t.parentElement.parentElement.tagName==="THEAD"&&(k=(i=c.querySelector("tbody"))==null?void 0:i.firstElementChild),k&&(y=k.querySelector(".fn__none"),Array.from(k.children).forEach(C=>{C.colSpan>1&&(w=!0),C.rowSpan>1&&(E=!0)}));let L=!0;Array.from(c.rows).find(C=>{const D=C.cells[o];if(D.classList.contains("fn__none")||D.colSpan>1||D.rowSpan>1)return L=!1,!0});let v=!0;Array.from(c.rows).find(C=>{const D=C.cells[o+1];if(D&&(D.classList.contains("fn__none")||D.colSpan>1||D.rowSpan>1))return v=!1,!0});let A=!0;return Array.from(c.rows).find(C=>{const D=C.cells[o-1];if(D&&(D.classList.contains("fn__none")||D.colSpan>1||D.rowSpan>1))return A=!1,!0}),s.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{df(n,a,t,e)}}),(!y||y&&!E&&w)&&s.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{Cc(n,a,t,e)}}),(L||A)&&s.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{gl(n,e,t,"beforebegin",a)}}),(L||v)&&s.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{gl(n,e,t,"afterend",a)}}),((!u||u&&!f&&d)&&(!g||g&&!m&&h)||(!u||u&&!f&&d)&&(!y||y&&!E&&w)||L&&A||L&&v)&&s.push({type:"separator"}),(!u||u&&!f&&d)&&(!g||g&&!m&&h)&&s.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{pf(n,a,t,e)}}),(!u||u&&!f&&d)&&(!y||y&&!E&&w)&&s.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{gf(n,a,t,e)}}),L&&A&&s.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{hf(n,a,t,e)}}),L&&v&&s.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{mf(n,a,t,e)}}),(t.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&d)||L)&&s.push({type:"separator"}),t.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&d)&&s.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{uf(n,a,t,e)}}),L&&s.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{ff(n,a,e,t)}}),s},Vt=(n,e,t,a)=>{if(e.getAttribute("data-type")==="NodeListItem"&&e.childElementCount<4||e.getAttribute("data-type")==="NodeThematicBreak")return-1;let i="0";if(e.getAttribute("fold")==="1"){if(typeof t=="boolean"&&!t)return-1;e.removeAttribute("fold"),e.querySelectorAll(".protyle-linenumber").forEach(o=>{Xs(o)})}else{if(typeof t=="boolean"&&t)return-1;if(i="1",e.setAttribute("fold","1"),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0),l=M(o.startContainer);l&&l.getBoundingClientRect().width===0&&we(e,void 0,!1)}e.querySelectorAll(".img--select, .av__cell--select, .av__row--select").forEach(o=>{o.classList.contains("av__row--select")?(o.classList.remove("av__row--select"),o.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),Wi(o)):o.classList.remove("img--select","av__cell--select")})}const s=e.getAttribute("data-node-id");return e.getAttribute("data-type")==="NodeHeading"?i==="0"?(e.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" src="/stage/loading-pure.svg"></div>'),G(n,[{action:"unfoldHeading",id:s,data:a?"remove":void 0}],[{action:"foldHeading",id:s}])):(G(n,[{action:"foldHeading",id:s}],[{action:"unfoldHeading",id:s}]),Wf(e)):G(n,[{action:"setAttrs",id:s,data:JSON.stringify({fold:i})}],[{action:"setAttrs",id:s,data:JSON.stringify({fold:i==="0"?"1":"0"})}]),cn(n),i},hp=(n,e)=>{const t=Oe(n),a=[];if(t.isSameNode(n)||(n.remove(),a.push({action:"delete",id:t.getAttribute("data-node-id")})),t.remove(),e.block.rootID===e.block.id&&e.wysiwyg.element.childElementCount===0){const i=Lute.NewNodeID(),s=Nn(!1,!1,i);a.push({action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}),e.wysiwyg.element.innerHTML=s.outerHTML}a.length>0&&G(e,a,[])},mp=()=>{if(window.siyuan.transactions.length===0)return;const n=window.siyuan.transactions[0].protyle,e=window.siyuan.transactions[0].doOperations,t=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),_("/api/transactions",{session:n.id,app:p.Constants.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:t}]},a=>{if(window.siyuan.transactions.length===0?zt([],n.block.rootID,!0):mp(),a.data[0].doOperations[0].action==="setAttrs"){const s=n.gutter.element.querySelector('[data-type="fold"]');s&&s.removeAttribute("disabled"),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${a.data[0].doOperations[0].id}"]`)&&(o.removeAttribute("data-render"),Ke(n,o))});return}let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){const o=n.gutter.element.querySelector('[data-type="fold"]');if(o&&o.removeAttribute("disabled"),s.action==="unfoldHeading"){const l=n.contentElement.scrollTop;n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(r=>{if(r.lastElementChild.classList.contains("protyle-attr")||r.lastElementChild.remove(),_p(s.retData,n),r.insertAdjacentHTML("afterend",s.retData),s.data==="remove"){const c=getSelection();c.rangeCount>0&&r.contains(c.getRangeAt(0).startContainer)&&we(r.nextElementSibling,void 0,!0),r.remove()}}),yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n),Ke(n,n.wysiwyg.element),n.contentElement.scrollTop=l,n.scroll.lastScrollTop=l;return}n.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!n.scroll.element.classList.contains("fn__none")&&n.contentElement.scrollHeight-n.contentElement.scrollTop<n.contentElement.clientHeight*2&&_("/api/filetree/getDoc",{id:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{dt({data:l,protyle:n,action:[p.Constants.CB_GET_APPEND,p.Constants.CB_GET_UNCHANGEID]})});return}if(s.action==="update"){n.options.backlinkData&&(Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(o,"data-type","NodeBlockQueryEmbed"))&&(i&&(o.isSameNode(i.startContainer)||o.contains(i.startContainer))||(o.outerHTML=s.data.replace("<wbr>","")))}),yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n),Ke(n,n.wysiwyg.element)),bp(n,s),Ks(n,s.id);return}if(s.action==="delete"||s.action==="append"){n.options.backlinkData&&Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{S(o,"data-type","NodeBlockQueryEmbed")||o.remove()}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Ke(n,o))});return}if(s.action==="move"){if(n.options.backlinkData){const o=[];Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(r,"data-type","NodeBlockQueryEmbed")){o.push(r);return}});let l=!1;s.previousID&&o.length>0?Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&(r.after(o[0].cloneNode(!0)),l=!0)}):o.length>0&&Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{var c;(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(o[0].cloneNode(!0)):r.prepend(o[0].cloneNode(!0)),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&hp(r,n)})}n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Ke(n,o))});return}if(s.action==="insert"){if(n.options.backlinkData){const o=[];s.previousID?Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(l=>{var r;((r=l.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==s.id&&!S(l,"data-node-id",s.id)&&(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(l.parentElement,"data-type","NodeBlockQueryEmbed"))&&(l.insertAdjacentHTML("afterend",s.data),o.push(l.nextElementSibling))}):Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(l=>{(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(l.parentElement,"data-type","NodeBlockQueryEmbed"))&&(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(l.firstElementChild.insertAdjacentHTML("afterend",s.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==s.id&&(l.insertAdjacentHTML("afterbegin",s.data),o.push(l.firstElementChild)))}),n.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{yt(l),Ze(l),Ct(l,n),Ke(n,l);const r=l.querySelector("wbr");r&&r.remove()})}Ks(n,s.id)}})})},bp=(n,e)=>{let t=!1;n.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${e.id}"]`).forEach(a=>{const i=document.createElement("div");i.innerHTML=e.data,i.querySelectorAll('[contenteditable="true"]').forEach(o=>{o.setAttribute("contenteditable","false")});const s=i.querySelector("wbr");s&&s.remove(),a.outerHTML=i.innerHTML,t=!0}),t&&(yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n))},wp=(n,e,t,a)=>{a&&ir(n[0]),n.forEach(i=>{i.remove()}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${e}"]`)&&(i.removeAttribute("data-render"),Ke(t,i))})},yp=(n,e,t,a)=>{n.forEach(s=>{s.outerHTML=t.data}),Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${t.id}"]`)).find(s=>{if(s.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(s,"data-type","NodeBlockQueryEmbed"))return n[0]=s,!0});const i=n[0].querySelector("wbr");if(a){const s=he(n[0]);i?_e(n[0],s):we(n[0])}else i&&i.remove();yt(n.length===1?n[0]:e.wysiwyg.element),Ze(n.length===1?n[0]:e.wysiwyg.element),Ct(n.length===1?n[0]:e.wysiwyg.element,e),Ke(e,n.length===1?n[0]:e.wysiwyg.element),bp(e,t),Ks(e,t.id)},ad=(n,e,t)=>{var a;const i=[];if(Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(s=>{S(s.parentElement,"data-type","NodeBlockQueryEmbed")||i.push(s)}),e.action==="setAttrs"){n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{JSON.parse(e.data).fold==="1"?s.setAttribute("fold","1"):s.removeAttribute("fold")});return}if(e.action==="unfoldHeading"){const s=n.contentElement.scrollTop;n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(o=>{e.retData&&(_p(e.retData,n),o.insertAdjacentHTML("afterend",e.retData)),o.removeAttribute("fold"),e.data==="remove"&&o.remove()}),e.retData&&(yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n),Ke(n,n.wysiwyg.element),n.contentElement.scrollTop=s,n.scroll.lastScrollTop=s);return}if(e.action==="foldHeading"){n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{s.setAttribute("fold","1"),e.retData||Wf(s)}),e.retData&&e.retData.forEach(s=>{n.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`).forEach(o=>{o.remove()})});return}if(e.action==="delete"){i.length>0?wp(i,e.id,n,t):t&&Yt({protyle:n,id:n.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(s=>{S(s.parentElement,"data-type","NodeBlockQueryEmbed")||i.push(s)}),wp(i,e.id,n,t)}});return}if(e.action==="update"){i.length>0?yp(i,n,e,t):t&&Yt({protyle:n,id:n.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(s=>{S(s.parentElement,"data-type","NodeBlockQueryEmbed")||i.push(s)}),yp(i,n,e,t)}});return}if(e.action==="updateAttrs"){const s=e.data,o={};let l="",r="",c="",u="";Object.keys(s.new).forEach(f=>{o[f]=s.new[f];const g=Lute.EscapeHTMLStr(s.new[f]);f==="bookmark"?l=`<div class="protyle-attr--bookmark">${g}</div>`:f==="name"?r=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${g}</div>`:f==="alias"?c=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${g}</div>`:f==="memo"?u=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${g}"><svg><use xlink:href="#iconM"></use></svg></div>`:f==="custom-avs"&&(u='<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg></div>')});let d=l+r+c+u;if(n.block.rootID===e.id){if(n.title){const f=n.title.element.querySelector(".protyle-attr--refcount");f&&(d+=f.outerHTML),s.new[p.Constants.CUSTOM_RIFF_DECKS]&&s.new[p.Constants.CUSTOM_RIFF_DECKS]!==s.old[p.Constants.CUSTOM_RIFF_DECKS]?(n.title.element.style.animation="addCard 450ms linear",n.title.element.setAttribute(p.Constants.CUSTOM_RIFF_DECKS,s.new[p.Constants.CUSTOM_RIFF_DECKS]),setTimeout(()=>{n.title.element.style.animation=""},450)):s.new[p.Constants.CUSTOM_RIFF_DECKS]||n.title.element.removeAttribute(p.Constants.CUSTOM_RIFF_DECKS),n.title.element.querySelector(".protyle-attr").innerHTML=d}if(n.wysiwyg.renderCustom(o),s.new[p.Constants.CUSTOM_SY_FULLWIDTH]!==s.old[p.Constants.CUSTOM_SY_FULLWIDTH]&&Bt(n),s.new[p.Constants.CUSTOM_SY_READONLY]!==s.old[p.Constants.CUSTOM_SY_READONLY]){let f=s.new[p.Constants.CUSTOM_SY_READONLY];f||(f=window.siyuan.config.editor.readOnly?"true":"false"),f==="true"?Yn(n):cd(n)}s.new.icon!==s.old.icon&&n.background.ial.icon!==s.new.icon&&(n.background.ial.icon=s.new.icon,n.background.render(n.background.ial,n.block.rootID),(a=n.model)==null||a.parent.setDocIcon(s.new.icon));return}n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(f=>{if(f.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(s.old).forEach(h=>{f.removeAttribute(h)}),s.new.style&&s.new[p.Constants.CUSTOM_RIFF_DECKS]&&s.new[p.Constants.CUSTOM_RIFF_DECKS]!==s.old[p.Constants.CUSTOM_RIFF_DECKS]&&(s.new.style+=";animation:addCard 450ms linear"),Object.keys(s.new).forEach(h=>{f.setAttribute(h,s.new[h]),h===p.Constants.CUSTOM_RIFF_DECKS&&s.new[p.Constants.CUSTOM_RIFF_DECKS]!==s.old[p.Constants.CUSTOM_RIFF_DECKS]&&(f.style.animation="addCard 450ms linear",setTimeout(()=>{f.style.animation=""},450))});const g=f.lastElementChild.querySelector(".protyle-attr--refcount");g&&(d+=g.outerHTML),f.lastElementChild.innerHTML=d+p.Constants.ZWSP});return}if(e.action==="move"){let s;t&&getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0),s.insertNode(document.createElement("wbr"))),i.length===0&&Ye().editor.forEach(l=>{const r=l.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.id}"]`);r&&i.push(r.cloneNode(!0))}),i.length===0&&window.siyuan.blockPanels.forEach(l=>{const r=l.element.querySelector(`[data-node-id="${e.id}"]`);r&&i.push(r.cloneNode(!0))});let o=!1;e.previousID&&i.length>0?Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(l=>{S(l.parentElement,"data-type","NodeBlockQueryEmbed")||(l.after(i[0].cloneNode(!0)),o=!0)}):i.length>0&&(!n.options.backlinkData&&e.parentID===n.block.parentID?(n.wysiwyg.element.prepend(i[0].cloneNode(!0)),o=!0):Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(l=>{var r;S(l.parentElement,"data-type","NodeBlockQueryEmbed")||((r=l.firstElementChild)!=null&&r.classList.contains("protyle-action")?l.firstElementChild.after(i[0].cloneNode(!0)):l.prepend(i[0].cloneNode(!0)),o=!0)})),i.forEach(l=>{o?l.remove():!o&&l.parentElement&&hp(l,n)}),t&&s&&(e.data==="focus"?Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(l=>{if(!S(l.parentElement,"data-type","NodeBlockQueryEmbed"))return we(l),!0}):_e(n.wysiwyg.element,s)),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${e.id}"],[data-node-id="${e.parentID}"],[data-node-id="${e.previousID}"]`)&&(l.removeAttribute("data-render"),Ke(n,l))});return}if(e.action==="insert"){const s=[];if(e.previousID?Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(o=>{const l=S(o.parentElement,"data-type","NodeBlockQueryEmbed");l?(l.removeAttribute("data-render"),Ke(n,l)):(o.insertAdjacentHTML("afterend",e.data),s.push(o.nextElementSibling))}):!n.options.backlinkData&&e.parentID===n.block.parentID?(n.wysiwyg.element.insertAdjacentHTML("afterbegin",e.data),s.push(n.wysiwyg.element.firstElementChild)):Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(o=>{var l;S(o.parentElement,"data-type","NodeBlockQueryEmbed")||((l=o.firstElementChild)!=null&&l.classList.contains("protyle-action")?(o.firstElementChild.insertAdjacentHTML("afterend",e.data),s.push(o.firstElementChild.nextElementSibling)):(o.insertAdjacentHTML("afterbegin",e.data),s.push(o.firstElementChild)))}),n.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(o=>{o.lastElementChild.getAttribute("spin")==="1"&&o.lastElementChild.remove()}),s.length===0)return;s.forEach(o=>{yt(o),Ze(o),Ct(o,n),Ke(n,o);const l=o.querySelector("wbr");if(t){const r=he(o);l?_e(o,r):we(o)}else l&&l.remove()}),Ks(n,e.id)}else e.action==="append"?zn(n,!1):["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColIcon"].includes(e.action)?Kw(n,e):e.action==="doUpdateUpdated"&&i.forEach(s=>{s.setAttribute("updated",e.data)})},id=n=>{let e;const t=Lute.NewNodeID();if(n.type==="BlocksMergeSuperBlock")e=lf(n.level,t);else if(n.type==="Blocks2Blockquote")e=document.createElement("div"),e.classList.add("bq"),e.setAttribute("data-node-id",t),e.setAttribute("data-type","NodeBlockquote"),e.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(n.type.endsWith("Ls")){e=document.createElement("div"),e.classList.add("list"),e.setAttribute("data-node-id",t),e.setAttribute("data-type","NodeList"),n.type==="Blocks2ULs"?e.setAttribute("data-subtype","u"):n.type==="Blocks2OLs"?e.setAttribute("data-subtype","o"):e.setAttribute("data-subtype","t");let r="";n.selectsElement.forEach((c,u)=>{n.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:n.type==="Blocks2OLs"?r+=`<div data-marker="${u+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${u+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),e.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=n.selectsElement[0].getAttribute("data-node-id"),i=n.selectsElement[0].parentElement.getAttribute("data-node-id")||n.protyle.block.parentID,s=[{action:"insert",id:t,data:e.outerHTML,nextID:a,parentID:i}],o=[];n.selectsElement[0].previousElementSibling?n.selectsElement[0].before(e):n.selectsElement[0].parentElement.prepend(e);let l;n.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const u=r.getAttribute("data-node-id");o.push({action:"move",id:u,previousID:l||t,parentID:i}),n.type.endsWith("Ls")?(s.push({action:"move",id:u,parentID:e.children[c].getAttribute("data-node-id")}),e.children[c].firstElementChild.after(r)):(s.push({action:"move",id:u,previousID:l,parentID:t}),e.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),c===n.selectsElement.length-1&&o.push({action:"delete",id:t}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Ke(n.protyle,r))}),G(n.protyle,s,o),we(n.protyle.wysiwyg.element.querySelector(`[data-node-id="${n.selectsElement[0].getAttribute("data-node-id")}"]`)),ne(["gutter"],n.protyle)},_p=(n,e)=>{const t=document.createElement("template");t.innerHTML=n,Array.from(t.content.children).forEach(a=>{var i;(i=e.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||i.remove()})},ua=n=>{let e=n.selectsElement,t;if(n.nodeElement){t=getSelection().getRangeAt(0),t.insertNode(document.createElement("wbr")),e=Array.from(n.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0&&(e=[n.nodeElement]);let o=!1,l=!1,r=!1;if(e.find((c,u)=>{if(c.classList.contains("li"))return r=!0,!0;if((c.classList.contains("bq")||c.classList.contains("sb")||c.classList.contains("p"))&&(l=!0),c.nextElementSibling&&e[u+1]&&c.nextElementSibling.isSameNode(e[u+1]))o=!0;else if(u!==e.length-1)return o=!1,!0}),r||l&&n.type==="Blocks2Ps")return;e.length===1&&n.type==="Blocks2Hs"&&e[0].getAttribute("data-type")==="NodeHeading"&&n.level===parseInt(e[0].getAttribute("data-subtype").substr(1))&&(n.type="Blocks2Ps"),n.isContinue=o}let a="";const i=[],s=[];e.forEach((o,l)=>{(n.type==="Blocks2Ps"||n.type==="Blocks2Hs")&&o.getAttribute("data-type")==="NodeHeading"&&o.getAttribute("fold")==="1"&&Vt(n.protyle,o),o.classList.remove("protyle-wysiwyg--select"),o.removeAttribute("select-start"),o.removeAttribute("select-end"),a+=o.outerHTML;const r=o.getAttribute("data-node-id");if(s.push({action:"update",id:r,data:o.outerHTML}),(n.type==="Blocks2Ps"||n.type==="Blocks2Hs")&&!n.isContinue)o.outerHTML=n.protyle.lute[n.type](o.outerHTML,n.level);else if(l===e.length-1){const c=document.createElement("div");c.innerHTML=n.protyle.lute[n.type](a,n.level),o.outerHTML=c.innerHTML}else o.remove()}),s.forEach(o=>{const l=n.protyle.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);i.push({action:"update",id:o.id,data:l.outerHTML})}),G(n.protyle,i,s),yt(n.protyle.wysiwyg.element),Ze(n.protyle.wysiwyg.element),Ct(n.protyle.wysiwyg.element,n.protyle),Ke(n.protyle,n.protyle.wysiwyg.element),t?_e(n.protyle.wysiwyg.element,t):we(n.protyle.wysiwyg.element.querySelector(`[data-node-id="${e[0].getAttribute("data-node-id")}"]`)),ne(["gutter"],n.protyle)},Ks=(n,e,t=0)=>{t>6||n.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${e}"]`).forEach(a=>{a.getAttribute("data-subtype")==="d"&&_("/api/block/getRefText",{id:e},i=>{a.innerHTML=i.data;const s=M(a);s&&Ks(n,s.getAttribute("data-node-id"),t+1)})})};let vp;const G=(n,e,t)=>{if(!n){_("/api/transactions",{session:p.Constants.SIYUAN_APPID,app:p.Constants.SIYUAN_APPID,transactions:[{doOperations:e}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&e.length===1&&e[0].action==="update"&&a.doOperations[0].id===e[0].id&&n.transactionTime-s<p.Constants.TIMEOUT_INPUT&&(i=!0),n.wysiwyg.lastHTMLs={},t&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.model&&n.model.headElement.classList.remove("item--unupdate"),n.updated=!0,i?n.undo.replace(e):n.undo.add(e,t)),i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=n,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=e):window.siyuan.transactions.push({protyle:n,doOperations:e,undoOperations:t}),n.transactionTime=s,window.clearTimeout(vp),vp=window.setTimeout(()=>{mp()},p.Constants.TIMEOUT_INPUT*2)},ie=(n,e,t,a)=>{t!==a&&G(n,[{id:e,data:t,action:"update"}],[{id:e,data:a,action:"update"}])},Zs=(n,e,t)=>{const a=[],i=[];n.forEach(s=>{const o=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:o,data:s.outerHTML}),t(s),a.push({action:"update",id:o,data:s.outerHTML})}),G(e,a,i)},Ep=n=>{const e=Lute.NewNodeID(),t=n.newValue.match(/^(.*) \((\d+)\)$/);t?n.newValue=`${t[1]} (${parseInt(t[2])+1})`:n.newValue=`${n.newValue} (1)`,["select","mSelect"].includes(n.type)?_("/api/av/renderAttributeView",{id:n.avID},a=>{const i=a.data;let s;i.view.columns.find(o=>{if(o.id===n.colId)return s=o.options,!0}),G(n.protyle,[{action:"addAttrViewCol",name:n.newValue,avID:n.avID,type:n.type,data:n.icon,id:e},{action:"sortAttrViewCol",avID:n.avID,previousID:n.colId,id:e},{action:"updateAttrViewColOptions",id:e,avID:n.avID,data:s}],[{action:"removeAttrViewCol",id:e,avID:n.avID}])}):G(n.protyle,[{action:"addAttrViewCol",name:n.newValue,avID:n.avID,type:n.type,data:n.icon,id:e},{action:"sortAttrViewCol",avID:n.avID,previousID:n.colId,id:e}],[{action:"removeAttrViewCol",id:e,avID:n.avID}]),fn({blockElement:n.protyle.wysiwyg.element.querySelector(`[data-av-id="${n.avID}"]`),protyle:n.protyle,type:n.type,name:n.newValue,icon:n.icon,previousId:n.colId,id:e})},fa=n=>{let e;n.data.view.columns.find(a=>{if(a.id===n.colId)return e=a,!0});let t=`<button class="b3-menu__item" data-type="nobg" data-col-id="${n.colId}">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goProperties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-col-type="${e.type}" data-icon="${e.icon}" data-type="update-icon">${e.icon?fe(e.icon):`<svg><use xlink:href="#${un(e.type)}"></use></svg>`}</span>
    <span class="b3-menu__label" style="padding: 4px"><input data-type="name" class="b3-text-field fn__block" type="text" value="${e.name}"></span>
</button>`;return e.options&&e.options.length>0&&(t+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label" style="padding: 4px"><input data-type="addOption" class="b3-text-field fn__block fn__size200" type="text" placeholder="Enter ${window.siyuan.languages.addAttr}"></span>
</button>`,e.options.forEach(a=>{t+=`<button class="b3-menu__item${t?"":" b3-menu__item--current"}" draggable="true" data-name="${a.name}" data-color="${a.color}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`})),e.type==="number"?t+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${e.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${kf(e.numberFormat)}</span>
</button>`:e.type==="template"&&(t+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <textarea rows="${e.template.split(`
`).length}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${e.template}</textarea>
</button>`),`<div class="b3-menu__items">
${t}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="${e.hidden?"showCol":"hideCol"}">
    <svg class="b3-menu__icon" style=""><use xlink:href="#icon${e.hidden?"Eye":"Eyeoff"}"></use></svg>
    <span class="b3-menu__label">${e.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
</button>
<button class="b3-menu__item" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},pa=n=>{const e=n.data.id,t=n.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=n.data.view.columns.find(l=>l.id===t),i=n.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const l=i.value;l!==a.name&&(G(n.protyle,[{action:"updateAttrViewCol",id:t,avID:e,name:l,type:a.type}],[{action:"updateAttrViewCol",id:t,avID:e,name:a.name,type:a.type}]),a.name=l,kn(n.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${t}"]`)))}),i.addEventListener("keydown",l=>{l.isComposing||(l.key==="Escape"?n.menuElement.parentElement.remove():l.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),n.menuElement.parentElement.remove()))});const s=n.menuElement.querySelector('[data-type="updateTemplate"]');s&&(s.addEventListener("blur",()=>{const l=s.value;l!==a.template&&(G(n.protyle,[{action:"updateAttrViewColTemplate",id:t,avID:e,data:l,type:a.type}],[{action:"updateAttrViewColTemplate",id:t,avID:e,data:a.template,type:a.type}]),a.template=l)}),s.addEventListener("keydown",l=>{l.isComposing||(l.key==="Escape"?n.menuElement.parentElement.remove():l.key==="Enter"&&!l.shiftKey&&(s.dispatchEvent(new CustomEvent("blur")),n.menuElement.parentElement.remove()))}));const o=n.menuElement.querySelector('[data-type="addOption"]');o&&o.addEventListener("keydown",l=>{if(!l.isComposing&&(l.key==="Escape"&&n.menuElement.parentElement.remove(),l.key==="Enter")){let r=!1;if(a.options.find(c=>{if(o.value===c.name)return r=!0,!0}),r)return;a.options.push({color:(a.options.length+1).toString(),name:o.value}),G(n.protyle,[{action:"updateAttrViewColOptions",id:t,avID:e,data:a.options}],[{action:"removeAttrViewColOption",id:t,avID:e,data:o.value}]),n.menuElement.innerHTML=fa({protyle:n.protyle,colId:t,data:n.data}),pa({protyle:n.protyle,menuElement:n.menuElement,data:n.data}),n.menuElement.querySelector('[data-type="addOption"]').focus()}})},un=n=>{switch(n){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath"}},fn=n=>{n.blockElement&&(n.blockElement.querySelectorAll(".av__row").forEach((e,t)=>{let a;n.previousId?a=e.querySelector(`[data-col-id="${n.previousId}"]`):a=e.lastElementChild.previousElementSibling;let i="";t===0?i=`<div class="av__cell" data-icon="${n.icon||""}" data-col-id="${n.id}" data-dtype="${n.type}" style="width: 200px;white-space: nowrap;">
    <div draggable="true" class="av__cellheader">
        ${n.icon?fe(n.icon,"av__cellicon",!0):`<svg class="av__cellicon"><use xlink:href="#${un(n.type)}"></use></svg>`}
        <span class="av__celltext">${n.name}</span>
    </div>
    <div class="av__widthdrag"></div>
</div>`:i='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',a.insertAdjacentHTML("afterend",i)}),window.siyuan.menus.menu.remove(),kp(n.protyle,n.blockElement,n.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${n.id}"]`)))},kp=(n,e,t)=>{const a=t.getAttribute("data-dtype"),i=t.getAttribute("data-col-id"),s=e.getAttribute("data-av-id"),o=t.querySelector(".av__celltext").textContent.trim(),l=new Kt("av-header-cell",()=>{const u=window.siyuan.menus.menu.element.querySelector(".b3-text-field").value;u!==o&&(G(n,[{action:"updateAttrViewCol",id:i,avID:s,name:u,type:a}],[{action:"updateAttrViewCol",id:i,avID:s,name:o,type:a}]),kn(t))});l.addItem({iconHTML:`<span style="align-self: center;margin-right: 8px;width: 14px;" class="block__icon block__icon--show">${t.dataset.icon?fe(t.dataset.icon):`<svg><use xlink:href="#${un(a)}"></use></svg>`}</span>`,type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block fn__size200" type="text" value="${o}">`,bind(u){const d=u.querySelector(".block__icon");d.setAttribute("data-icon",t.dataset.icon),d.addEventListener("click",f=>{const g=d.getBoundingClientRect();ls("","av",{x:g.left,y:g.bottom,h:g.height,w:g.width},h=>{G(n,[{action:"setAttrViewColIcon",id:i,avID:s,data:h}],[{action:"setAttrViewColIcon",id:i,avID:s,data:t.dataset.icon}]),d.setAttribute("data-icon",h),d.innerHTML=h?fe(h):`<svg><use xlink:href="#${un(a)}"></use></svg>`,kn(t)}),f.preventDefault(),f.stopPropagation()}),u.querySelector("input").addEventListener("keydown",f=>{f.isComposing||f.key==="Enter"&&l.close()})}}),a!=="block"&&l.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){$a({protyle:n,blockElement:e,type:"edit",colId:i})}}),l.addSeparator(),l.addItem({icon:"iconUp",label:window.siyuan.languages.asc,click(){_("/api/av/renderAttributeView",{id:s},u=>{G(n,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:i,order:"ASC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),l.addItem({icon:"iconDown",label:window.siyuan.languages.desc,click(){_("/api/av/renderAttributeView",{id:s},u=>{G(n,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:i,order:"DESC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),a!=="mAsset"&&l.addItem({icon:"iconFilter",label:window.siyuan.languages.filter,click(){_("/api/av/renderAttributeView",{id:s},u=>{const d=u.data;let f;d.view.filters.find(g=>{if(g.column===i)return f=g,!0}),f||(f={column:i,operator:Ac(a),value:Os(a,"")},d.view.filters.push(f),G(n,[{action:"setAttrViewFilters",avID:s,data:[f]}],[{action:"setAttrViewFilters",avID:s,data:[]}])),Tc({filter:f,protyle:n,data:d,target:e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),l.addSeparator(),a!=="block"&&(l.addItem({icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){G(n,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1}])}}),l.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){Ep({protyle:n,type:a,avID:s,colId:i,icon:l.element.querySelector(".block__icon").getAttribute("data-icon"),newValue:window.siyuan.menus.menu.element.querySelector(".b3-text-field").value})}}),l.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){G(n,[{action:"removeAttrViewCol",id:i,avID:s}],[{action:"addAttrViewCol",name:o,avID:s,type:a,id:i}]),Pf(e,i)}}),l.addSeparator()),l.addItem({label:`<label class="fn__flex" style="margin: 4px 0"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${t.style.whiteSpace==="nowrap"?"":" checked"}></label>`,bind(u){const d=u.querySelector("input");d.addEventListener("change",()=>{G(n,[{action:"setAttrViewColWrap",id:i,avID:s,data:d.checked}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!d.checked}])})}});const r=t.getBoundingClientRect();l.open({x:r.left,y:r.bottom,h:r.height});const c=window.siyuan.menus.menu.element.querySelector(".b3-text-field");c&&(c.select(),c.focus())},Ct=(n,e,t)=>{let a=[];n.getAttribute("data-type")==="NodeAttributeView"?a=[n]:a=Array.from(n.querySelectorAll('[data-type="NodeAttributeView"]')),a.length!==0&&a.length>0&&a.forEach(i=>{var s,o,l;if(i.getAttribute("data-render")==="true")return;let r;if(i.firstElementChild.innerHTML===""){i.style.alignSelf="",r=new Date().getTime();let h="";[1,2,3].forEach(()=>{h+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),i.firstElementChild.innerHTML=h}const c=((s=i.querySelector(".av__scroll"))==null?void 0:s.scrollLeft)||0,u=(o=i.querySelector(".av__row--header"))==null?void 0:o.style.transform,d=(l=i.querySelector(".av__row--footer"))==null?void 0:l.style.transform;let f="";const g=i.querySelector(".av__cell--select");g&&(f=g.parentElement.dataset.id+p.Constants.ZWSP+g.getAttribute("data-col-id")),_("/api/av/renderAttributeView",{id:i.getAttribute("data-av-id")},h=>{const m=h.data.view;let b='<div class="av__row av__row--header"><div class="av__firstcol"><svg style="height: 32px"><use xlink:href="#iconUncheck"></use></svg></div>',y="";m.columns.forEach(E=>{var k;E.hidden||(b+=`<div class="av__cell" data-col-id="${E.id}" data-icon="${E.icon}" data-dtype="${E.type}"  
style="width: ${E.width||"200px"};
${E.wrap?"":"white-space: nowrap;"}">
    <div draggable="true" class="av__cellheader">
        ${E.icon?fe(E.icon,"av__cellicon",!0):`<svg class="av__cellicon"><use xlink:href="#${un(E.type)}"></use></svg>`}
        <span class="av__celltext">${E.name}</span>
    </div>
    <div class="av__widthdrag"></div>
</div>`,y+=`<div class="av__calc${y?"":" av__calc--show"}${E.calc&&E.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${E.id}" data-dtype="${E.type}" data-operator="${((k=E.calc)==null?void 0:k.operator)||""}"  
style="width: ${E.width||"200px"}">${cw(E)||'<svg><use xlink:href="#iconDown"></use></svg>'+window.siyuan.languages.calc}</div>`)}),b+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-add"><svg><use xlink:href="#iconAdd"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show"  data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
</div>
</div>`,m.rows.forEach(E=>{b+=`<div class="av__row" data-id="${E.id}">
<div class="av__gutters ariaLabel" draggable="true" data-position="right" aria-label="${window.siyuan.languages.rowTip}">
    <button><svg><use xlink:href="#iconDrag"></use></svg></button>
</div>
<div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>`,E.cells.forEach((k,L)=>{var v,A,C,D,x,P,B,V,X;if(m.columns[L].hidden)return;let Q="";if(["text","template"].includes(k.valueType))Q=`<span class="av__celltext">${k.value&&k.value[k.valueType].content||""}</span>`;else if(["url","email","phone"].includes(k.valueType)){const ce=k.value?k.value[k.valueType].content:"";let Pe="";k.valueType==="url"&&(Pe=` data-href="${ce}"`),Q=`<span class="av__celltext av__celltext--url" data-type="${k.valueType}"${Pe}>${ce}</span>`}else if(k.valueType==="block")Q=`<span class="av__celltext">${k.value.block.content||""}</span>`,(v=k.value)!=null&&v.isDetached?Q+=`<span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more" >${window.siyuan.languages.more}</span>`:Q+=`<span class="b3-chip b3-chip--info b3-chip--small" data-type="block-ref" data-id="${k.value.block.id}" data-subtype="s">${window.siyuan.languages.openBy}</span>`;else if(k.valueType==="number")Q=`<span class="av__celltext" data-content="${(A=k.value)!=null&&A.number.isNotEmpty?(C=k.value)==null?void 0:C.number.content:""}">${((D=k.value)==null?void 0:D.number.formattedContent)||""}</span>`;else if(k.valueType==="mSelect"||k.valueType==="select")(P=(x=k.value)==null?void 0:x.mSelect)==null||P.forEach(ce=>{Q+=`<span class="b3-chip" style="background-color:var(--b3-font-background${ce.color});color:var(--b3-font-color${ce.color})">${ce.content}</span>`}),Q?Q=`<span class="av__celltext">${Q}</span>`:Q='<span class="av__celltext"></span>';else if(k.valueType==="date"){Q='<span class="av__celltext">';const ce=k.value?k.value.date:null;ce&&ce.isNotEmpty&&(Q+=ue(ce.content).format("YYYY-MM-DD HH:mm")),ce&&ce.hasEndDate&&ce.isNotEmpty&&ce.isNotEmpty2&&(Q+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${ue(ce.content2).format("YYYY-MM-DD HH:mm")}`),Q+="</span>"}else if(["created","updated"].includes(k.valueType)){Q='<span class="av__celltext">';const ce=k.value?k.value[k.valueType]:null;ce&&ce.isNotEmpty&&(Q+=ue(ce.content).format("YYYY-MM-DD HH:mm")),Q+="</span>"}else k.valueType==="mAsset"&&((V=(B=k.value)==null?void 0:B.mAsset)==null||V.forEach(ce=>{ce.type==="image"?Q+=`<img class="av__cellassetimg" src="${ce.content}">`:Q+=`<span class="b3-chip av__celltext--url" data-url="${ce.content}">${ce.name}</span>`}),Q?Q=`<span class="av__celltext">${Q}</span>`:Q='<span class="av__celltext"></span>');["text","template","url","email","phone","number","date","created","updated"].includes(k.valueType)&&k.value&&k.value[k.valueType].content&&(Q+=`<span data-type="copy" class="b3-tooltips b3-tooltips__n block__icon" aria-label="${window.siyuan.languages.copy}"><svg><use xlink:href="#iconCopy"></use></svg></span>`),b+=`<div class="av__cell" data-id="${k.id}" data-col-id="${m.columns[L].id}"
${k.valueType==="block"?'data-block-id="'+(k.value.block.id||"")+'"':""}  
${(X=k.value)!=null&&X.isDetached?' data-detached="true"':""} 
style="width: ${m.columns[L].width||"200px"};
${k.bgColor?`background-color:${k.bgColor};`:""}
white-space: ${m.columns[L].wrap?"pre-wrap":"nowrap"};
${k.valueType!=="number"?"":"flex-direction: row-reverse;"}
${k.color?`color:${k.color};`:""}">${Q}</div>`}),b+="<div></div></div>"});let w="";h.data.views.forEach(E=>{w+=`<div data-id="${h.data.viewID}" class="item${E.id===h.data.viewID?" item--focus":""}">
    <svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>
    <span class="item__text">${E.name}</span>
</div>`}),setTimeout(()=>{if(i.firstElementChild.outerHTML=`<div>
    <div class="av__header">
        <div class="layout-tab-bar fn__flex">
            ${w}
            <div class="fn__flex-1"></div>
            <span data-type="av-filter" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${m.filters.length>0?" block__icon--active":""}" aria-label="${window.siyuan.languages.filter}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${m.sorts.length>0?" block__icon--active":""}" aria-label="${window.siyuan.languages.sort}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.more}">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
        </div>
        <div contenteditable="${e.disabled?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title" data-title="${m.name||""}" data-tip="${window.siyuan.languages.title}">${h.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        <div style="float: left;">
            ${b}
            <div class="av__row--add">
                <svg><use xlink:href="#iconAdd"></use></svg>
                ${window.siyuan.languages.addAttr}
            </div>
            <div class="av__row--footer"><div style="width: 24px"></div>${y}</div>
        </div>
    </div>
</div>`,i.setAttribute("data-render","true"),Ln(i),c&&(i.querySelector(".av__scroll").scrollLeft=c),u&&(i.querySelector(".av__row--header").style.transform=u),d&&(i.querySelector(".av__row--footer").style.transform=d),f){const E=i.querySelector(`.av__row[data-id="${f.split(p.Constants.ZWSP)[0]}"] .av__cell[data-col-id="${f.split(p.Constants.ZWSP)[1]}"]`);E&&E.classList.add("av__cell--select"),we(i)}t&&t()},r?256-(new Date().getTime()-r):0)})})};let sd,Sp;const Kw=(n,e)=>{if(e.action==="setAttrViewName"&&Array.from(n.wysiwyg.element.querySelectorAll(`[data-av-id="${e.id}"]`)).forEach(a=>{const i=a.querySelector(".av__title");i&&(i.textContent=e.data,i.dataset.title=e.data,a.querySelector(".layout-tab-bar .item__text").textContent=e.data)}),sd===e.parentID&&n.contentElement.isSameNode(Sp))return;Sp=n.contentElement,sd=e.parentID;const t=e.avID;e.action==="setAttrViewColWidth"?Array.from(n.wysiwyg.element.querySelectorAll(`[data-av-id="${t}"]`)).forEach(a=>{const i=a.querySelector(`.av__cell[data-col-id="${e.id}"]`);!i||i.style.width===e.data||a.querySelectorAll(".av__row").forEach(s=>{s.querySelector(`[data-col-id="${e.id}"]`).style.width=e.data})}):Array.from(n.wysiwyg.element.querySelectorAll(`[data-av-id="${t}"]`)).forEach(a=>{a.removeAttribute("data-render"),Ct(a,n)}),setTimeout(()=>{sd=null},p.Constants.TIMEOUT_TRANSITION)},Lp=(n,e)=>{n.block.showAll=!0;let t="";e.forEach(a=>{t+=Ap(a.blockPaths)+xp(a.dom,a.expand)}),n.wysiwyg.element.innerHTML=t,yt(n.wysiwyg.element),Ze(n.wysiwyg.element),Ct(n.wysiwyg.element,n),Ke(n,n.wysiwyg.element),jl(n),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&Yn(n)},Cp=(n,e)=>{e.firstElementChild.classList.contains("li")?n?e.querySelectorAll(".li .li").forEach(t=>{t.childElementCount>3&&t.setAttribute("fold","1")}):e.firstElementChild.setAttribute("fold","1"):e.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(e.children).forEach((t,a)=>{(n&&a>2||!n&&a>1)&&((n&&a===3||!n&&a===2)&&t.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg><use xlink:href="#iconMore"></use></svg></div>'),t.classList.add("fn__none"))})},xp=(n,e)=>{const t=document.createElement("template");return t.innerHTML=n,Cp(e,t.content),t.innerHTML},Zw=(n,e)=>{_("/api/filetree/getDoc",{id:e.getAttribute("data-id"),size:p.Constants.SIZE_GET_MAX},t=>{e.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),e.classList.add("protyle-breadcrumb__item--active");let a=e.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const i=a;a=a.nextElementSibling,i.remove()}e.parentElement.insertAdjacentHTML("afterend",xp(t.data.content,!0)),yt(e.parentElement.parentElement),Ct(e.parentElement.parentElement,n),Ke(n,e.parentElement.parentElement),t.data.isSyncing?Ip(n):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?Yn(n):e.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&e.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},Xw=n=>{let e=n.nextElementSibling;for(;e&&!e.classList.contains("protyle-breadcrumb__bar");)e.classList.remove("fn__none"),e=e.nextElementSibling;n.remove()},Ap=(n,e=!1)=>{let t="";return n.forEach((a,i)=>{i===0&&!e||(t+=`<span class="protyle-breadcrumb__item${i===n.length-1?" protyle-breadcrumb__item--active":""}" data-id="${a.id}">
    <svg class="popover__block" data-id="${a.id}"><use xlink:href="#${ln(a.type,a.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${a.name}">${a.name}</span>
</span>`,i!==n.length-1&&(t+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${t}</div>`},Ke=(n,e,t)=>{let a=[];e.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true"),i.style.height=i.clientHeight-8+"px",i.innerHTML=`<div class="protyle-icons${S(i.parentElement,"data-type","NodeBlockQueryEmbed")?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${i.lastElementChild.outerHTML}`;const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let o=i.getAttribute("breadcrumb");o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,et(i,"sb")&&(o=!1),_("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[i.getAttribute("data-node-id"),n.block.rootID],breadcrumb:o},r=>{const c=i.querySelector(".fn__rotate");c&&c.classList.remove("fn__rotate");let u="";r.data.blocks.forEach(g=>{let h="";g.blockPaths.length!==0&&(h=Ap(g.blockPaths,!0)),u+=`<div class="protyle-wysiwyg__embed" data-id="${g.block.id}">${h}${g.block.content}</div>`}),r.data.blocks.length>0?i.lastElementChild.insertAdjacentHTML("beforebegin",u+`<div style="position: absolute;">${p.Constants.ZWSP}</div>`):i.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${p.Constants.ZWSP}</div>`),yt(i),Ze(i),Ct(i,n),t&&(n.contentElement.scrollTop=t);let d=0,f=i;for(;d<4&&f;)f=S(f.parentElement,"data-type","NodeBlockQueryEmbed"),d++;d<4&&i.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(g=>{Ke(n,g)}),i.style.height=""})})};var od=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});let tn=[],Qi=!1;const Ll=(n,e)=>od(void 0,null,function*(){ne(["gutter","toolbar","hint","util","dialog"],e.protyle);let t;if(!document.contains(e.protyle.element)){if(!(yield kt("/api/block/checkBlockExist",{id:e.protyle.block.rootID})).data)return!1;let i;const s=document.querySelector(".layout__wnd--active");if(s&&(i=St(s.getAttribute("data-id"))),i||(i=bi(window.siyuan.layout.centerLayout)),i){const o=yield kt("/api/block/getBlockInfo",{id:e.id});if(o.code===3){q(o.msg);return}const l=new ht({title:o.data.rootTitle,docIcon:o.data.rootIcon,callback(c){const u=qs(e.protyle,!0);u.rootId=e.protyle.block.rootID,u.focusId=e.id,u.focusStart=e.position.start,u.focusEnd=e.position.end;const d=new gt({app:n,tab:c,scrollAttr:u,blockId:e.zoomId||e.protyle.block.rootID,action:e.zoomId?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS]});c.addModel(d)}});if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let c;i.children.forEach(u=>{u.headElement&&u.headElement.classList.contains("item--unupdate")&&!u.headElement.classList.contains("item--pin")&&(c=u)}),i.addTab(l),c&&i.removeTab(c.id)}else i.addTab(l);i.showHeading();const r=l.model.editor.protyle;return e.protyle=r,tn.forEach(c=>{!document.contains(c.protyle.element)&&c.protyle.block.rootID===o.data.rootID&&(c.protyle=r)}),window.siyuan.backStack.forEach(c=>{!document.contains(c.protyle.element)&&c.protyle.block.rootID===o.data.rootID&&(c.protyle=r)}),o.data.rootID===e.id?Fn(r.title.editElement,e.position.start,e.position.end):(Array.from(r.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(c=>{if(!S(c,"data-type","NodeBlockQueryEmbed"))return t=c,!0}),Fn(J(t),e.position.start,e.position.end),Ge(r,t)),!0}else return!1}if(e.protyle.block.rootID===e.id)return e.protyle.title.editElement.getBoundingClientRect().height===0&&(e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),e.protyle.toolbar.range=void 0),Fn(e.protyle.title.editElement,e.position.start,e.position.end),!0;if(Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(a=>{if(!S(a,"data-type","NodeBlockQueryEmbed"))return t=a,!0}),t&&(!e.zoomId||e.zoomId&&e.zoomId===e.protyle.block.id))return t.getBoundingClientRect().height===0&&e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),Fn(J(t),e.position.start,e.position.end),Ge(e.protyle,t,!0),Ye().outline.forEach(a=>{a.blockId===e.protyle.block.rootID&&a.setCurrent(t)}),!0;if(e.protyle.element.parentElement)return(yield kt("/api/block/checkBlockExist",{id:e.id})).data?(Yt({protyle:e.protyle,id:e.zoomId||e.protyle.block.rootID,isPushBack:!1,callback:()=>{Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(!S(i,"data-type","NodeBlockQueryEmbed"))return t=i,!0}),t&&(Ye().outline.forEach(i=>{i.blockId===e.protyle.block.rootID&&i.setCurrent(t)}),Fn(J(t),e.position.start,e.position.end),Ge(e.protyle,t,!0))}}),!0):(getSelection().rangeCount>0&&ee(getSelection().getRangeAt(0)),!1)}),ld=n=>od(void 0,null,function*(){var e,t;if(window.siyuan.backStack.length===0){tn.length>0&&(yield Ll(n,tn[tn.length-1]));return}(e=document.querySelector("#barForward"))==null||e.classList.remove("toolbar__item--disabled"),!Qi&&document.contains(window.siyuan.backStack[window.siyuan.backStack.length-1].protyle.element)&&tn.push(window.siyuan.backStack.pop());let a=window.siyuan.backStack.pop();for(;a;)if(yield Ll(n,a)){tn.push(a);break}else a=window.siyuan.backStack.pop();Qi=!0,window.siyuan.backStack.length===0&&((t=document.querySelector("#barBack"))==null||t.classList.add("toolbar__item--disabled"))}),rd=n=>od(void 0,null,function*(){var e,t;if(tn.length===0){window.siyuan.backStack.length>0&&(yield Ll(n,window.siyuan.backStack[window.siyuan.backStack.length-1]));return}(e=document.querySelector("#barBack"))==null||e.classList.remove("toolbar__item--disabled"),Qi&&window.siyuan.backStack.push(tn.pop());let a=tn.pop();for(;a;)if(yield Ll(n,a)){window.siyuan.backStack.push(a);break}else a=tn.pop();Qi=!1,tn.length===0&&((t=document.querySelector("#barForward"))==null||t.classList.add("toolbar__item--disabled"))}),Wn=(n,e,t)=>{var a,i;if(!n.model||(!t&&e&&(t=M(e.startContainer)),!t))return;let s;if(t.classList.contains("protyle-title__input")?s=t:s=J(t),s){const o=Et(s,void 0,e),l=t.getAttribute("data-node-id")||n.block.rootID,r=window.siyuan.backStack[window.siyuan.backStack.length-1];r&&r.id===l&&(n.block.showAll&&r.zoomId===n.block.id||!r.zoomId&&!n.block.showAll)?r.position=o:(tn.length>0&&(Qi&&window.siyuan.backStack.push(tn.pop()),tn=[],(a=document.querySelector("#barForward"))==null||a.classList.add("toolbar__item--disabled")),window.siyuan.backStack.push({position:o,id:l,protyle:n,zoomId:n.block.showAll?n.block.id:void 0}),window.siyuan.backStack.length>p.Constants.SIZE_UNDO&&window.siyuan.backStack.shift(),Qi=!1),window.siyuan.backStack.length>1&&((i=document.querySelector("#barBack"))==null||i.classList.remove("toolbar__item--disabled"))}},dt=n=>{if(n.action||(n.action=[]),n.protyle.wysiwyg.element.removeAttribute("data-top"),n.data.code===1){n.protyle.model?n.protyle.model.parent.parent.removeTab(n.protyle.model.parent.id,!1,!1):n.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`;return}if(n.data.code!==3&&(n.protyle.notebookId=n.data.data.box,n.protyle.path=n.data.data.path,!(n.data.data.eof&&!n.scrollAttr&&(n.action.includes(p.Constants.CB_GET_BEFORE)?n.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):n.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),n.data.data.mode!==4)))){if(ne(["gutter"],n.protyle),n.protyle.block.parentID=n.data.data.parentID,n.protyle.block.parent2ID=n.data.data.parent2ID,n.protyle.block.rootID=n.data.data.rootID,n.protyle.block.showAll=!1,n.protyle.block.mode=n.data.data.mode,n.protyle.block.blockCount=n.data.data.blockCount,n.protyle.block.scroll=n.data.data.scroll,n.protyle.block.action=n.action,n.action.includes(p.Constants.CB_GET_UNCHANGEID)||(n.protyle.block.id=n.data.data.id,n.protyle.scroll.lastScrollTop=0,n.protyle.contentElement.scrollTop=0,n.protyle.wysiwyg.element.setAttribute("data-doc-type",n.data.data.type)),n.action.includes(p.Constants.CB_GET_APPEND)||n.action.includes(p.Constants.CB_GET_BEFORE)||n.action.includes(p.Constants.CB_GET_HTML)){Tp({content:n.data.data.content,expand:n.data.data.isBacklinkExpand,action:n.action,scrollAttr:n.scrollAttr,isSyncing:n.data.data.isSyncing,afterCB:n.afterCB},n.protyle),jl(n.protyle);return}_("/api/block/getDocInfo",{id:n.protyle.block.rootID},e=>{n.protyle.options.render.title?n.protyle.title.render(n.protyle,e):(n.protyle.options.render.background&&n.protyle.background.render(e.data.ial,n.protyle.block.rootID),n.protyle.wysiwyg.renderCustom(e.data.ial)),Tp({content:n.data.data.content,expand:n.data.data.isBacklinkExpand,action:n.action,scrollAttr:n.scrollAttr,isSyncing:n.data.data.isSyncing,afterCB:n.afterCB},n.protyle),n.protyle.model&&er(e.data.ial.title),jl(n.protyle)})}},Tp=(n,e)=>{if(e.contentElement.classList.contains("fn__none")&&e.wysiwyg.element.innerHTML!=="")return;e.block.showAll=n.action.includes(p.Constants.CB_GET_ALL);const t=e.contentElement.clientHeight*8;if(n.action.includes(p.Constants.CB_GET_APPEND)){if(!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad&&e.contentElement.scrollHeight>t){let a=e.wysiwyg.element.firstElementChild;const i=[];for(;e.wysiwyg.element.childElementCount>2&&i&&!e.wysiwyg.element.lastElementChild.isSameNode(a)&&e.contentElement.scrollHeight-a.offsetTop>t;){i.push(a);a=a.nextElementSibling}const s=a.getBoundingClientRect().top;i.forEach(o=>{o.remove()}),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-s),e.scroll.lastScrollTop=e.contentElement.scrollTop,ne(["toolbar"],e)}e.wysiwyg.element.insertAdjacentHTML("beforeend",n.content)}else if(n.action.includes(p.Constants.CB_GET_BEFORE)){const a=e.wysiwyg.element.firstElementChild,i=a.getBoundingClientRect().top;if(e.wysiwyg.element.insertAdjacentHTML("afterbegin",n.content),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-i),e.scroll.lastScrollTop=e.contentElement.scrollTop,!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad){const s=[];let o=e.wysiwyg.element.childElementCount,l=e.contentElement.scrollHeight,r=e.wysiwyg.element.lastElementChild;for(;o>2&&l>t&&r.getBoundingClientRect().top>window.innerHeight;)s.push(r),r=r.previousElementSibling,o--,l-=r.clientHeight+8;s.forEach(c=>{c.remove()}),ne(["toolbar"],e)}}else e.wysiwyg.element.innerHTML=n.content;if(n.action.includes(p.Constants.CB_GET_BACKLINK)&&Cp(n.expand,e.wysiwyg.element),yt(e.wysiwyg.element),Ze(e.wysiwyg.element),Ct(e.wysiwyg.element,e),Ke(e,e.wysiwyg.element),!n.action.includes(p.Constants.CB_GET_HISTORY)){if(e.options.render.scroll&&e.scroll.update(e),n.scrollAttr){if(e.contentElement.scrollTop=n.scrollAttr.scrollTop,n.action.includes(p.Constants.CB_GET_HL))yc(e,n.scrollAttr.focusId,!0);else if(n.action.includes(p.Constants.CB_GET_FOCUS))if(n.scrollAttr.focusId){const a=Fn(e.wysiwyg.element.querySelector(`[data-node-id="${n.scrollAttr.focusId}"]`),n.scrollAttr.focusStart,n.scrollAttr.focusEnd);n.action.includes(p.Constants.CB_GET_UNUNDO)||Wn(e,a||void 0)}else Dp(e,n.action);if(!e.scroll.element.classList.contains("fn__none")){e.scroll.updateIndex(e,n.scrollAttr.startId);const a=e.contentElement.getBoundingClientRect();e.wysiwyg.element.clientHeight-parseInt(e.wysiwyg.element.style.paddingBottom)<e.contentElement.clientHeight&&e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom<a.bottom&&e.wysiwyg.element.firstElementChild.getBoundingClientRect().top>a.top&&q(window.siyuan.languages.scrollGetMore)}}else if(n.action.includes(p.Constants.CB_GET_HL)){cn(e);const a=yc(e,e.block.id,!0);a&&!n.action.includes(p.Constants.CB_GET_UNUNDO)&&Wn(e,void 0,a)}else if(n.action.includes(p.Constants.CB_GET_FOCUS))Dp(e,n.action);else if(n.action.includes(p.Constants.CB_GET_FOCUSFIRST)){const a=e.wysiwyg.element.offsetTop-16;cn(e,a,256),e.contentElement.scrollTop=a,we(e.wysiwyg.element.firstElementChild),n.action.includes(p.Constants.CB_GET_UNUNDO)||Wn(e,void 0,e.wysiwyg.element.firstElementChild)}if(n.isSyncing)Ip(e);else{e.breadcrumb&&(e.breadcrumb.element.nextElementSibling.textContent=""),e.element.removeAttribute("disabled-forever");let a=window.siyuan.config.readonly?"true":"false";a==="false"&&(a=e.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_READONLY),a||(a=window.siyuan.config.editor.readOnly?"true":"false")),a==="true"?Yn(e):cd(e)}if(n.action.includes(p.Constants.CB_GET_SETID)&&(e.block.id=e.block.rootID,e.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),e.options.defId&&(e.wysiwyg.element.querySelectorAll(`[data-id="${e.options.defId}"]`).forEach(a=>{a.classList.add("def--mark")}),e.options.defId=void 0),!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("block__edit")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&e.contentElement.scrollHeight>0&&!n.action.includes(p.Constants.CB_GET_FOCUSFIRST)&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&_("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{dt({data:a,protyle:e,action:[p.Constants.CB_GET_APPEND,p.Constants.CB_GET_UNCHANGEID]})}),n.action.includes(p.Constants.CB_GET_APPEND)||n.action.includes(p.Constants.CB_GET_BEFORE)){e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle-dynamic",{protyle:e,positon:n.action.includes(p.Constants.CB_GET_APPEND)?"afterend":"beforebegin"})});return}e.options.render.breadcrumb&&(e.breadcrumb.toggleExit(!n.action.includes(p.Constants.CB_GET_ALL)),e.breadcrumb.render(e)),n.afterCB&&n.afterCB(),e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle",e)})}},Ip=n=>{Yn(n),n.breadcrumb&&!(0,T.tq)()?n.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:q(window.siyuan.languages._kernel[81]),n.element.setAttribute("disabled-forever","true")},Yn=n=>{if(window.siyuan.menus.menu.remove(),ne(["gutter","toolbar","select","hint","util"],n),n.disabled=!0,n.title){const e=n.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","false"),e.style.userSelect="text"}n.background&&(n.background.element.classList.remove("protyle-background--enable"),n.background.element.classList.remove("protyle-background--mobileshow")),n.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(e=>{e.classList.remove("protyle-icons--show")}),n.wysiwyg.element.style.userSelect="text",n.wysiwyg.element.setAttribute("contenteditable","false"),n.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(e=>{e.setAttribute("contenteditable","false")}),n.breadcrumb&&(n.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),n.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.languages.unlockEdit)),Mn()},cd=n=>{if(n.element.getAttribute("disabled-forever")!=="true"){if(n.disabled=!1,(0,T.tq)()?document.getElementById("toolbarName").removeAttribute("readonly"):(n.wysiwyg.element.setAttribute("contenteditable","true"),n.wysiwyg.element.style.userSelect=""),n.title){const e=n.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","true"),e.style.userSelect=""}n.background&&n.background.element.classList.add("protyle-background--enable"),n.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(e=>{$(e,"protyle-wysiwyg__embed")||e.setAttribute("contenteditable","true")}),n.breadcrumb&&(n.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),n.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.languages.lockEdit)),Mn()}},Dp=(n,e)=>{let t;Array.from(n.wysiwyg.element.querySelectorAll(`[data-node-id="${n.block.id}"]`)).find(a=>{if(!S(a,"data-type","block-render",!0))return t=a,!0}),n.block.mode===4&&(cn(n),t=n.wysiwyg.element.lastElementChild),t&&!n.wysiwyg.element.firstElementChild.isSameNode(t)?(we(t),e.includes(p.Constants.CB_GET_UNUNDO)||Wn(n,void 0,t),t.scrollIntoView(),setTimeout(()=>{t.scrollIntoView()},p.Constants.TIMEOUT_LOAD)):(we(n.wysiwyg.element.firstElementChild),e.includes(p.Constants.CB_GET_UNUNDO)||Wn(n,void 0,n.wysiwyg.element.firstElementChild))};class Ha extends sn{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&_("/api/block/checkBlockExist",{id:this.blockId},t=>{t.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(t){if(t)switch(t.cmd){case"transactions":this.onTransaction(t);break;case"rename":this.type==="local"&&this.blockId===t.data.id?this.parent.updateTitle(t.data.title):this.updateDocTitle({title:t.data.title,icon:p.Constants.ZWSP});break;case"unmount":this.type==="local"&&_("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)});break;case"removeDoc":t.data.ids.includes(this.blockId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.openNodes={},this.isPreview=e.isPreview,this.blockId=e.blockId,this.type=e.type,e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__outline"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconAlignCenter"></use></svg>
        ${window.siyuan.languages.outline}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.stickOpen} ${ae(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${ae(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="b3-list-item fn__none"></div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.element=e.tab.panelElement.lastElementChild,this.headerElement=e.tab.panelElement.firstElementChild,this.tree=new Bs({element:e.tab.panelElement.lastElementChild,data:null,click:t=>{const a=t.getAttribute("data-node-id");if(this.isPreview){const i=document.getElementById(a);if(i){const s=et(i,"protyle");if(s){const o=St(s.getAttribute("data-id"));o.parent.switchTab(o.headElement)}i.scrollIntoView()}else be({app:e.app,id:this.blockId,mode:"preview"})}else _("/api/attr/getBlockAttrs",{id:a},i=>{be({app:e.app,id:a,action:i.data["heading-fold"]==="1"?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SETID,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_HTML]})})},ctrlClick(t){const a=t.getAttribute("data-node-id");be({app:e.app,id:a,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML],zoomIn:!0})}}),e.tab.panelElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),e.tab.panelElement.querySelector('[data-type="expand"]').addEventListener("click",t=>{const a=$(t.target,"block__icon");a&&(a.classList.contains("block__icon--active")?a.classList.remove("block__icon--active"):a.classList.add("block__icon--active"),this.tree.expandAll())}),e.tab.panelElement.addEventListener("click",t=>{this.type==="local"?lt(e.tab.panelElement.parentElement.parentElement):lt(e.tab.panelElement);let a=t.target;for(;a&&!a.isEqualNode(e.tab.panelElement);){if(a.classList.contains("block__icon")){switch(a.getAttribute("data-type")){case"min":At("outline").toggleModel("outline");break}break}else if(a.isSameNode(this.headerElement.nextElementSibling)||a.classList.contains("block__icons")){Ye().editor.find(i=>{if(this.blockId===i.editor.protyle.block.rootID)return i.editor.protyle.scroll.element.classList.contains("fn__none")?i.editor.protyle.contentElement.scrollTop=0:_("/api/filetree/getDoc",{id:i.editor.protyle.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},s=>{dt({data:s,protyle:i.editor.protyle,action:[p.Constants.CB_GET_FOCUS]})}),!0});break}a=a.parentElement}}),this.isPreview?this.blockId&&_("/api/export/preview",{id:this.blockId},t=>{t.data=t.data.outline,this.update(t)}):_("/api/outline/getDocOutline",{id:this.blockId},t=>{this.update(t)})}updateDocTitle(e){const t=this.headerElement.nextElementSibling;if(this.type==="pin")if(e){let a=`${fe(e.icon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}`;e.icon===p.Constants.ZWSP&&t.firstElementChild&&(a=t.firstElementChild.outerHTML),t.innerHTML=`${a}
<span class="b3-list-item__text">${De(e.title)}</span>`,t.setAttribute("title",e.title),t.classList.remove("fn__none")}else t.classList.add("fn__none");else t.classList.add("fn__none")}onTransaction(e){if(this.isPreview)return;let t=!1;e.data[0].doOperations.forEach(a=>{((a.action==="update"||a.action==="insert")&&(a.data.indexOf('data-type="NodeHeading"')>-1||a.data.indexOf(`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"><wbr></div>`)>-1)||a.action==="delete"||a.action==="move")&&(t=!0)}),e.data[0].undoOperations&&e.data[0].undoOperations.forEach(a=>{a.action==="update"&&a.data.indexOf('data-type="NodeHeading"')>-1&&(t=!0)}),t&&_("/api/outline/getDocOutline",{id:this.blockId},a=>{if(this.update(a),getSelection().rangeCount>0){const i=M(getSelection().getRangeAt(0).startContainer);i&&i.getAttribute("data-type")==="NodeHeading"&&this.setCurrent(i)}})}setCurrent(e){if(e)if(e.getAttribute("data-type")==="NodeHeading")this.setCurrentById(e.getAttribute("data-node-id"));else{let t=se(e);for(;t&&t.getAttribute("data-type")!=="NodeHeading";)t=se(t);t?this.setCurrentById(t.getAttribute("data-node-id")):_("/api/block/getBlockBreadcrumb",{id:e.getAttribute("data-node-id"),excludeTypes:[]},a=>{a.data.reverse().find(i=>{if(i.type==="NodeHeading")return this.setCurrentById(i.id),!0})})}}setCurrentById(e){this.element.querySelectorAll(".b3-list-item.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")});let t=this.element.querySelector(`.b3-list-item[data-node-id="${e}"]`);for(;t&&t.clientHeight===0;)t=t.parentElement.previousElementSibling;t&&(t.classList.add("b3-list-item--focus"),this.element.scrollTop=t.offsetTop-this.element.clientHeight/2-30)}update(e,t){let a=this.element.querySelector(".b3-list-item--focus"),i;a&&(i=a.getAttribute("data-node-id")),!this.isPreview&&this.openNodes[this.blockId]&&(this.openNodes[this.blockId]=this.tree.getExpandIds()),typeof t!="undefined"&&(this.blockId=t),this.tree.updateData(e.data),!this.isPreview&&this.openNodes[this.blockId]&&!this.headerElement.querySelector('[data-type="expand"]').classList.contains("block__icon--active")?this.tree.setExpandIds(this.openNodes[this.blockId]):(this.tree.expandAll(),this.isPreview||(this.openNodes[this.blockId]=this.tree.getExpandIds())),this.isPreview&&this.tree.element.querySelectorAll(".popover__block").forEach(s=>{s.classList.remove("popover__block")}),i&&(a=this.element.querySelector(`[data-node-id="${i}"]`),a&&a.classList.add("b3-list-item--focus"))}}class Ba extends sn{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&_("/api/block/checkBlockExist",{id:this.blockId},t=>{t.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(t){if(t&&this.type==="local")switch(t.cmd){case"rename":this.rootId===t.data.id&&this.parent.updateTitle(t.data.title);break;case"unmount":this.notebookId===t.data.box&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":t.data.ids.includes(this.rootId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.editors=[],this.status={},this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element=e.tab.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__backlink"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconLink"></use></svg>
        ${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount" style="margin-left: 0"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" data-sort="3" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${ae(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${ae(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconLink"></use></svg>
        ${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount" style="margin-left: 0;"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mSort" data-sort="3" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mExpand" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.expand}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="mCollapse" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.collapse}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="layout" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.down}">
        <svg><use xlink:href="#iconDown"></use></svg>
    </span>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.inputsElement=this.element.querySelectorAll("input"),this.inputsElement.forEach(t=>{t.addEventListener("blur",a=>{a.target.classList.add("fn__none")}),t.addEventListener("keydown",a=>{!a.isComposing&&a.key==="Enter"&&this.searchBacklinks()}),t.addEventListener("input",a=>{const i=a.target;i.value===""?i.classList.remove("search__input--block"):i.classList.add("search__input--block")})}),this.tree=new Bs({element:this.element.querySelector(".backlinkList"),data:null,click:t=>{var a;this.toggleItem(t,!1),this.setFocus(),(a=this.mTree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},ctrlClick:t=>{var a;be({app:e.app,id:t.getAttribute("data-node-id"),action:[p.Constants.CB_GET_CONTEXT]}),(a=this.mTree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},altClick(t){var a;be({app:e.app,id:t.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),(a=this.mTree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},shiftClick(t){var a;be({app:e.app,id:t.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),(a=this.mTree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},toggleClick:t=>{var a;this.toggleItem(t,!1),this.setFocus(),(a=this.mTree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")}}),this.mTree=new Bs({element:this.element.querySelector(".backlinkMList"),data:null,click:t=>{var a;this.toggleItem(t,!0),this.setFocus(),(a=this.tree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},ctrlClick(t){var a;be({app:e.app,id:t.getAttribute("data-node-id"),action:[p.Constants.CB_GET_CONTEXT]}),(a=this.tree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},altClick(t){var a;be({app:e.app,id:t.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),(a=this.tree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},shiftClick(t){var a;be({app:e.app,id:t.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),(a=this.tree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},toggleClick:t=>{var a;this.toggleItem(t,!0),this.setFocus(),(a=this.tree.element.querySelector(".b3-list-item--focus"))==null||a.classList.remove("b3-list-item--focus")},blockExtHTML:`<span class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>`}),this.tree.element.addEventListener("scroll",()=>{this.tree.element.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""}),this.tree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(t=>{t.classList.remove("protyle-wysiwyg--hl")})}),this.mTree.element.addEventListener("scroll",()=>{this.mTree.element.querySelectorAll(".protyle-gutters").forEach(t=>{t.classList.add("fn__none"),t.innerHTML=""}),this.mTree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(t=>{t.classList.remove("protyle-wysiwyg--hl")})}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.element.querySelectorAll(".protyle").forEach(t=>{t.classList.add("fn__none")}),this.tree.element.querySelectorAll(".b3-list-item__arrow").forEach(t=>{t.classList.remove("b3-list-item__arrow--open")})}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{Array.from(this.tree.element.firstElementChild.children).forEach(t=>{t.tagName==="LI"&&!t.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(t,!1)})}),this.element.addEventListener("click",t=>{this.setFocus();let a=t.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("block__icon")&&a.parentElement.parentElement.isSameNode(this.element)){const i=a.getAttribute("data-type");switch(i){case"refresh":this.refresh();break;case"mExpand":Array.from(this.mTree.element.firstElementChild.children).forEach(s=>{s.tagName==="LI"&&!s.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(s,!0)});break;case"mCollapse":this.mTree.element.querySelectorAll(".protyle").forEach(s=>{s.classList.add("fn__none")}),this.mTree.element.querySelectorAll(".b3-list-item__arrow").forEach(s=>{s.classList.remove("b3-list-item__arrow--open")});break;case"min":At("backlink").toggleModel("backlink");break;case"search":a.previousElementSibling.classList.remove("fn__none"),a.previousElementSibling.select();break;case"sort":case"mSort":this.showSortMenu(i,a.getAttribute("data-sort")),window.siyuan.menus.menu.popup({x:t.clientX,y:t.clientY}),t.stopPropagation();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")):a.getAttribute("aria-label")===window.siyuan.languages.down?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.dispatchEvent(new CustomEvent("scroll")),this.mTree.element.dispatchEvent(new CustomEvent("scroll"));break}}a=a.parentElement}}),this.searchBacklinks(!0)}setFocus(){this.type==="local"?lt(this.element.parentElement.parentElement):lt(this.element)}showSortMenu(e,t){const a=i=>{(e==="sort"?this.tree:this.mTree).element.previousElementSibling.querySelector(`[data-type="${e}"]`).setAttribute("data-sort",i),this.searchBacklinks()};window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({icon:t==="0"?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{a("0")}}).element),window.siyuan.menus.menu.append(new I({icon:t==="1"?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{a("1")}}).element),window.siyuan.menus.menu.append(new I({icon:t==="4"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{a("4")}}).element),window.siyuan.menus.menu.append(new I({icon:t==="5"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{a("5")}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({icon:t==="9"?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{a("9")}}).element),window.siyuan.menus.menu.append(new I({icon:t==="10"?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{a("10")}}).element),window.siyuan.menus.menu.append(new I({icon:t==="2"?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{a("2")}}).element),window.siyuan.menus.menu.append(new I({icon:t==="3"?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{a("3")}}).element)}toggleItem(e,t){var a;const i=(a=e.firstElementChild)==null?void 0:a.firstElementChild;if(!i||i.getAttribute("disabled"))return;i.setAttribute("disabled","disabled");const s=e.getAttribute("data-node-id");i.classList.contains("b3-list-item__arrow--open")?(i.classList.remove("b3-list-item__arrow--open"),this.editors.find((o,l)=>{if(o.protyle.block.rootID===s&&e.nextElementSibling&&o.protyle.element.isSameNode(e.nextElementSibling))return o.destroy(),this.editors.splice(l,1),e.nextElementSibling.remove(),!0}),i.removeAttribute("disabled")):_(t?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:this.blockId,refTreeID:s,keyword:t?this.inputsElement[1].value:this.inputsElement[0].value},o=>{i.removeAttribute("disabled"),i.classList.add("b3-list-item__arrow--open");const l=document.createElement("div");l.style.minHeight="auto",l.setAttribute("data-defid",this.blockId),l.setAttribute("data-ismention",t?"true":"false"),e.after(l);const r=new hn(this.app,l,{blockId:s,backlinkData:t?o.data.backmentions:o.data.backlinks,render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!1}});r.protyle.notebookId=e.getAttribute("data-notebook-id"),this.editors.push(r)})}refresh(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.add("fn__rotate"),_("/api/ref/refreshBacklink",{id:this.blockId},()=>{e.classList.remove("fn__rotate"),this.searchBacklinks()})}searchBacklinks(e=!1){const t=this.element.querySelector('.block__icon[data-type="refresh"] svg');t.classList.contains("fn__rotate")||(t.classList.add("fn__rotate"),_("/api/ref/getBacklink2",{sort:this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort"),mSort:this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort"),k:this.inputsElement[0].value,mk:this.inputsElement[1].value,id:this.blockId},a=>{e||this.saveStatus(),this.render(a.data)}))}saveStatus(){this.status[this.blockId]={sort:this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort"),mSort:this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort"),scrollTop:this.tree.element.scrollTop,mScrollTop:this.mTree.element.scrollTop,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},this.tree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkMOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?this.status[this.blockId].backlinkMStatus=3:this.status[this.blockId].backlinkMStatus=0:this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]').getAttribute("aria-label")===window.siyuan.languages.down?this.status[this.blockId].backlinkMStatus=1:this.status[this.blockId].backlinkMStatus=2}render(e){e||(e={box:"",backlinks:[],backmentions:[],linkRefsCount:0,mentionsCount:0,k:"",mk:""}),this.editors.forEach(s=>{s.destroy()}),this.editors=[],this.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate"),this.notebookId=e.box,this.inputsElement[0].value=e.k,this.inputsElement[1].value=e.mk,this.tree.updateData(e.backlinks),this.mTree.updateData(e.backmentions);const t=this.element.querySelector(".listCount");e.linkRefsCount===0?t.classList.add("fn__none"):(t.classList.remove("fn__none"),t.textContent=e.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");e.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=e.mentionsCount.toString()),this.status[this.blockId]||(this.status[this.blockId]={sort:"3",mSort:"3",scrollTop:0,mScrollTop:0,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},e.mentionsCount===0?this.status[this.blockId].backlinkMStatus=3:(Array.from({length:window.siyuan.config.editor.backmentionExpandCount}).forEach((s,o)=>{e.backmentions[o]&&this.status[this.blockId].backlinkMOpenIds.push(e.backmentions[o].id)}),window.siyuan.config.editor.backmentionExpandCount===0?this.status[this.blockId].backlinkMStatus=3:e.linkRefsCount===0?this.status[this.blockId].backlinkMStatus=0:this.status[this.blockId].backlinkMStatus=1),e.linkRefsCount>0&&Array.from({length:window.siyuan.config.editor.backlinkExpandCount}).forEach((s,o)=>{e.backlinks[o]&&this.status[this.blockId].backlinkOpenIds.push(e.backlinks[o].id)})),this.status[this.blockId].backlinkOpenIds.forEach(s=>{const o=this.tree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);o&&this.toggleItem(o,!1)}),this.status[this.blockId].backlinkMOpenIds.forEach(s=>{const o=this.mTree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);o&&this.toggleItem(o,!0)});const i=this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]');this.status[this.blockId].backlinkMStatus===2||this.status[this.blockId].backlinkMStatus===1?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),this.status[this.blockId].backlinkMStatus===1?(i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")):(i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp"))):this.status[this.blockId].backlinkMStatus===3?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').setAttribute("data-sort",this.status[this.blockId].sort),this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').setAttribute("data-sort",this.status[this.blockId].mSort),setTimeout(()=>{this.tree.element.scrollTop=this.status[this.blockId].scrollTop,this.mTree.element.scrollTop=this.status[this.blockId].mScrollTop},p.Constants.TIMEOUT_LOAD)}}var dd=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Cl=n=>dd(void 0,null,function*(){if(Ye().backlink.find(s=>{if(s.blockId===n.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let t;const a=document.querySelector(".layout__wnd--active");if(a&&(t=St(a.getAttribute("data-id"))),t||(t=bi(window.siyuan.layout.centerLayout)),n.rootId){if(!n.title){const s=yield kt("api/block/getDocInfo",{id:n.blockId});if(s.code===-1)return;n.title=s.data.name||"Untitled"}}else{const s=yield kt("api/block/getDocInfo",{id:n.blockId});if(s.code===-1)return;n.rootId=s.data.rootID,n.useBlockId=s.data.rootID!==s.data.id,n.title=s.data.name||"Untitled"}t.split("lr").addTab(new ht({icon:"iconLink",title:n.title,callback(s){s.addModel(new Ba({app:n.app,type:"local",tab:s,blockId:n.useBlockId?n.blockId:n.rootId,rootId:n.rootId}))}}))}),xl=n=>dd(void 0,null,function*(){if(Ye().graph.find(s=>{if(s.blockId===n.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let t;const a=document.querySelector(".layout__wnd--active");if(a&&(t=St(a.getAttribute("data-id"))),t||(t=bi(window.siyuan.layout.centerLayout)),n.rootId){if(!n.title){const s=yield kt("api/block/getDocInfo",{id:n.blockId});if(s.code===-1)return;n.title=s.data.name||"Untitled"}}else{const s=yield kt("api/block/getDocInfo",{id:n.blockId});if(s.code===-1)return;n.rootId=s.data.rootID,n.useBlockId=s.data.rootID!==s.data.id,n.title=s.data.name||"Untitled"}t.split("lr").addTab(new ht({icon:"iconGraph",title:n.title,callback(s){s.addModel(new Kn({app:n.app,type:"local",tab:s,blockId:n.blockId,rootId:n.rootId}))}}))}),$p=n=>dd(void 0,null,function*(){if(Ye().outline.find(o=>{if(o.blockId===n.block.rootID&&o.type==="local")return o.parent.parent.removeTab(o.parent.id),!0}))return;let t;const a=document.querySelector(".layout__wnd--active");a&&(t=St(a.getAttribute("data-id"))),t||(t=bi(window.siyuan.layout.centerLayout));const i=t.split("lr");let s="";n.title?s=n.title.editElement.textContent||"Untitled":s=(yield kt("api/block/getDocInfo",{id:n.block.rootID})).data.name||"Untitled",i.addTab(new ht({icon:"iconAlignCenter",title:s,callback(o){o.addModel(new Ha({app:n.app,type:"local",tab:o,blockId:n.block.rootID,isPreview:!n.preview.element.classList.contains("fn__none")}))}})),i.element.classList.remove("fn__flex-1"),i.element.style.width="200px",nu(i,t)}),ud=()=>{!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.style.opacity==="1"&&window.siyuan.layout.leftDock.showDock(!0),!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.style.opacity==="1"&&window.siyuan.layout.rightDock.showDock(!0),!window.siyuan.layout.bottomDock.pin&&window.siyuan.layout.bottomDock.layout.element.style.opacity==="1"&&window.siyuan.layout.bottomDock.showDock(!0)},Pp=n=>{const e=n.getAttribute("xlink:href")==="#iconHideDock";e?n.setAttribute("xlink:href","#iconDock"):n.setAttribute("xlink:href","#iconHideDock"),document.querySelectorAll(".dock").forEach(t=>{e?t.classList.add("fn__none"):t.querySelectorAll(".dock__item").length>1&&t.classList.remove("fn__none")}),nn(),ud()},ut={element:void 0,genHTML:()=>`<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance4}
        <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
</label>
<div class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-center">${window.siyuan.languages.theme}</div>
        <span class="fn__space"></span>
        <a href="javascript:void(0)" ${(0,T.jU)()?" class='fn__none'":""} id="appearanceOpenTheme" class="fn__flex-center">${window.siyuan.languages.appearance9}</a>
    </div>
    <div class="fn__hr"></div>
    <label class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme11}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeLight">
          ${la(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
        </select>
    </label>
    <div class="fn__hr"></div>
    <label class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme12}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeDark">
           ${la(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
        </select>
    </label>
</div>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        <div class="fn__flex">
            ${window.siyuan.languages.icon}
            <span class="fn__space"></span>
            <a href="javascript:void(0)"${(0,T.jU)()?" class='fn__none'":""} id="appearanceOpenIcon">${window.siyuan.languages.appearance8}</a>
        </div>
        <div class="b3-label__text">${window.siyuan.languages.theme2}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="icon">
        ${la(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
    </select>
</label>
<div class="b3-label fn__flex"><div class="fn__block">
    <div>
        ${window.siyuan.languages.appearance1}
    </div>
    <div class="fn__hr"></div>
    <label class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance2}</div>
        <span class="fn__space"></span>
        <select id="codeBlockThemeLight" class="b3-select fn__size200">
            ${la(p.Constants.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE,window.siyuan.config.appearance.codeBlockThemeLight)}
        </select>
    </label>
    <div class="fn__hr"></div>
    <label class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance3}</div>
        <span class="fn__space"></span>
        <select id="codeBlockThemeDark" class="b3-select fn__size200">
            ${la(p.Constants.SIYUAN_CONFIG_APPEARANCE_DARK_CODE,window.siyuan.config.appearance.codeBlockThemeDark)}
        </select>
    </label>
</div></div>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.language}
        <div class="b3-label__text">${window.siyuan.languages.language1}</div>
    </div>
    <span class="fn__space"></span>
    <select id="lang" class="b3-select fn__flex-center fn__size200">${la(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
</label>
<label class="b3-label config__item${(0,T.jU)()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.customEmoji}
        <div class="b3-label__text">${window.siyuan.languages.customEmojiTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="appearanceRefresh">
        <svg><use xlink:href="#iconRefresh"></use></svg>
        ${window.siyuan.languages.refresh}
    </button>
</label>
<label class="b3-label fn__flex config__item">
   <div class="fn__flex-1">
        ${window.siyuan.languages.resetLayout}
        <div class="b3-label__text">${window.siyuan.languages.appearance6}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="resetLayout">
        <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.reset}
    </button>
</label>
<label class="b3-label fn__flex config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.codeSnippet}
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="codeSnippet">
        <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
    </button>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance16}
        <div class="b3-label__text">${window.siyuan.languages.appearance17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="hideStatusBar" type="checkbox"${window.siyuan.config.appearance.hideStatusBar?" checked":""}>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance10}
        <div class="b3-label__text">${window.siyuan.languages.appearance11}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeButtonBehavior" type="checkbox"${window.siyuan.config.appearance.closeButtonBehavior===0?"":" checked"}>
</label>`,_send:()=>{const n=ut.element.querySelector("#themeLight").value,e=ut.element.querySelector("#themeDark").value,t=parseInt(ut.element.querySelector("#mode").value);_("/api/setting/setAppearance",{icon:ut.element.querySelector("#icon").value,mode:t===2?window.siyuan.config.appearance.mode:t,modeOS:t===2,codeBlockThemeDark:ut.element.querySelector("#codeBlockThemeDark").value,codeBlockThemeLight:ut.element.querySelector("#codeBlockThemeLight").value,themeDark:e,themeLight:n,darkThemes:window.siyuan.config.appearance.darkThemes,lightThemes:window.siyuan.config.appearance.lightThemes,icons:window.siyuan.config.appearance.icons,lang:ut.element.querySelector("#lang").value,closeButtonBehavior:ut.element.querySelector("#closeButtonBehavior").checked?1:0,hideStatusBar:ut.element.querySelector("#hideStatusBar").checked},a=>{if(window.siyuan.config.appearance.themeJS){if(!a.data.modeOS&&(a.data.mode!==window.siyuan.config.appearance.mode||window.siyuan.config.appearance.themeLight!==a.data.themeLight||window.siyuan.config.appearance.themeDark!==a.data.themeDark)){Tt({reload:!0,onlyData:!1,errorExit:!1});return}const i=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";if(a.data.modeOS&&(a.data.mode===1&&i==="light"||a.data.mode===0&&i==="dark")){Tt({reload:!0,onlyData:!1,errorExit:!1});return}}ut.onSetappearance(a.data),a.data.hideStatusBar?document.getElementById("status").classList.add("fn__none"):document.getElementById("status").classList.remove("fn__none"),ud()})},bindEvent:()=>{ut.element.querySelector("#codeSnippet").addEventListener("click",()=>{Kb()}),ut.element.querySelector("#resetLayout").addEventListener("click",()=>{mm()}),ut.element.querySelectorAll("select").forEach(n=>{n.addEventListener("change",()=>{ut._send()})}),ut.element.querySelectorAll(".b3-switch").forEach(n=>{n.addEventListener("change",()=>{ut._send()})})},onSetappearance(n){var e;if(n.lang!==window.siyuan.config.appearance.lang){Tt({reload:!0,onlyData:!1,errorExit:!1});return}if(window.siyuan.config.appearance=n,ut.element){const t=ut.element.querySelector("#mode");t&&(n.modeOS?t.value="2":t.value=n.mode===0?"0":"1");const a=ut.element.querySelector("#themeLight");a&&(a.innerHTML=la(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight));const i=ut.element.querySelector("#themeDark");i&&(i.innerHTML=la(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark));const s=ut.element.querySelector("#icon");s&&(s.innerHTML=la(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon))}Np(n),(e=document.querySelector("#barMode use"))==null||e.setAttribute("xlink:href",`#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}`)}},Mp=(n,e)=>{(0,vt.addScript)(n,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(e.icon)){const t=document.getElementById("iconScript");t&&t.remove(),(0,vt.addScript)(`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`,"iconScript")}})},Np=n=>{const e=document.getElementsByTagName("html")[0];e.setAttribute("lang",window.siyuan.config.appearance.lang),e.setAttribute("data-theme-mode",ey()),e.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),e.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&t==="light"||window.siyuan.config.appearance.mode===0&&t==="dark")&&(_("/api/system/setAppearanceMode",{mode:t==="light"?0:1}),window.siyuan.config.appearance.mode=t==="light"?0:1);const a=document.getElementById("themeDefaultStyle");let i=`/appearance/themes/${n.mode===1?"midnight":"daylight"}/theme.css?v=${p.Constants.SIYUAN_VERSION}`;(n.mode===1&&n.themeDark!=="midnight"||n.mode===0&&n.themeLight!=="daylight")&&(i=`/appearance/themes/${n.mode===1?"midnight":"daylight"}/theme.css?v=${p.Constants.SIYUAN_VERSION}`),a?a.getAttribute("href").startsWith(i)||(a.remove(),Qa(i,"themeDefaultStyle")):Qa(i,"themeDefaultStyle");const s=document.getElementById("themeStyle");if(n.mode===1&&n.themeDark!=="midnight"||n.mode===0&&n.themeLight!=="daylight"){const d=`/appearance/themes/${n.mode===1?n.themeDark:n.themeLight}/theme.css?v=${n.themeVer}`;s?s.getAttribute("href").startsWith(d)||(s.remove(),Qa(d,"themeStyle")):Qa(d,"themeStyle")}else s&&s.remove();Ye().graph.forEach(d=>{d.searchGraph(!1)});const o=window.siyuan.config.appearance.mode===0?window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].light:window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].dark;document.querySelectorAll(".pdf__outer").forEach(d=>{const f=d.querySelector("#pdfDark"),g=d.querySelector("#pdfLight");o==="dark"?(d.classList.add("pdf__outer--dark"),g.classList.remove("toggled"),f.classList.add("toggled")):(d.classList.remove("pdf__outer--dark"),g.classList.add("toggled"),f.classList.remove("toggled"))}),Hp();const l=document.getElementById("themeScript"),r=`/appearance/themes/${n.mode===1?n.themeDark:n.themeLight}/theme.js?v=${n.themeVer}`;l?l.getAttribute("src").startsWith(r)||(l.remove(),(0,vt.addScript)(r,"themeScript")):(0,vt.addScript)(r,"themeScript");const c=document.getElementById("iconDefaultScript"),u=`/appearance/icons/${["ant","material"].includes(n.icon)?n.icon:"material"}/icon.js?v=${p.Constants.SIYUAN_VERSION}`;if(c){c.remove();let d=document.body.firstElementChild;for(;d.tagName==="svg";){const f=d;d=d.nextElementSibling,f.getAttribute("data-name")||f.remove()}Mp(u,n)}else Mp(u,n)},Jw=()=>{const n=document.getElementById("loading");n&&setTimeout(()=>{n.remove()},160),Bp(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{const t=e.matches?"dark":"light";Bp(t),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&t==="light"||window.siyuan.config.appearance.mode===1&&t==="dark"||_("/api/system/setAppearanceMode",{mode:t==="light"?0:1},a=>{if(window.siyuan.config.appearance.themeJS){Tt({reload:!0,onlyData:!1,errorExit:!1});return}window.siyuan.config.appearance=a.data.appearance,Np(a.data.appearance)}))})},Qw=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){(0,vt.addScript)("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const n=function(...t){window.dataLayer.push(arguments)};n("js",new Date),n("config","G-L7WEXVQCR9",{send_page_view:!1});const e={version:p.Constants.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(e.isLoggedIn=!0,e.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,e.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,e.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,e.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(e.syncEnabled=window.siyuan.config.sync.enabled,e.syncProvider=window.siyuan.config.sync.provider),n("event",p.Constants.ANALYTICS_EVT_ON_GET_CONFIG,e)}},fd=(n=!0)=>{const e=Math.floor(window.siyuan.config.editor.fontSize*1.625);let t=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${e+8}px;line-height: ${e+8}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${e+8}px;}
.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}
.protyle-wysiwyg [data-node-id].li:before {height: calc(100% - ${e+8}px);top:${e+8}px}
.protyle-wysiwyg [data-node-id] [spellcheck] {min-height:${e}px;}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.rtl?" direction: rtl;":""}${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${e+8}px}
.protyle-gutters button svg {height:${e}px}
.protyle-wysiwyg img.emoji, .b3-typography img.emoji {width:${e-8}px}
.protyle-wysiwyg .h1 img.emoji, .b3-typography h1 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.75*1.25)}px}
.protyle-wysiwyg .h2 img.emoji, .b3-typography h2 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.55*1.25)}px}
.protyle-wysiwyg .h3 img.emoji, .b3-typography h3 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.38*1.25)}px}
.protyle-wysiwyg .h4 img.emoji, .b3-typography h4 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25*1.25)}px}
.protyle-wysiwyg .h5 img.emoji, .b3-typography h5 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.13*1.25)}px}
.protyle-wysiwyg .h6 img.emoji, .b3-typography h6 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25)}px}`;return window.siyuan.config.editor.fontFamily&&(t+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title, .protyle-title__input{font-family: "${window.siyuan.config.editor.fontFamily}", "Helvetica Neue", "Luxi Sans", "DejaVu Sans", "Hiragino Sans GB", "Microsoft Yahei", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", "Android Emoji", "EmojiSymbols" !important;}`),"ontouchend"in document&&(t+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),n&&(document.getElementById("editorFontSize").innerHTML=t),t},Hp=(n=p.Constants.PROTYLE_CDN)=>{const e=document.getElementById("protyleHljsStyle");let t;window.siyuan.config.appearance.mode===0?(t=window.siyuan.config.appearance.codeBlockThemeLight,p.Constants.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(t)||(t="default")):(t=window.siyuan.config.appearance.codeBlockThemeDark,p.Constants.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(t)||(t="github-dark"));const a=`${n}/js/highlight.js/styles/${t}.min.css?v=11.5.0`;e?e.href.includes(a)||(e.remove(),Qa(a,"protyleHljsStyle")):Qa(a,"protyleHljsStyle")},pd=n=>{_("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:n===2?window.siyuan.config.appearance.mode:n,modeOS:n===2}),e=>{if(window.siyuan.config.appearance.themeJS){if(!e.data.modeOS&&(e.data.mode!==window.siyuan.config.appearance.mode||window.siyuan.config.appearance.themeLight!==e.data.themeLight||window.siyuan.config.appearance.themeDark!==e.data.themeDark)){Tt({reload:!0,onlyData:!1,errorExit:!1});return}const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";if(e.data.modeOS&&(e.data.mode===1&&t==="light"||e.data.mode===0&&t==="dark")){Tt({reload:!0,onlyData:!1,errorExit:!1});return}}ut.onSetappearance(e.data)})},Bp=n=>{(Rt()||Mt())&&setTimeout(()=>{const e=getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim();let t=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(n==="dark"?t=1:t=0),Rt()?window.webkit.messageHandlers.changeStatusBar.postMessage((e||(t===0?"#fff":"#1e1e1e"))+" "+t):Mt()&&window.JSAndroid.changeStatusBarColor(e,t)},500)},ey=()=>{const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?n:window.siyuan.config.appearance.mode===0?"light":"dark"},Ze=(n,e=p.Constants.PROTYLE_CDN)=>{let t,a=!1;n.classList.contains("code-block")?t=n.querySelectorAll("[spellcheck]"):n.classList.contains("item__readme")?(t=n.querySelectorAll("pre code"),t.forEach(i=>{i.parentElement.setAttribute("lineNumber","false")})):n.classList.contains("b3-typography")?(t=n.querySelectorAll(".code-block code"),a=!0):t=n.querySelectorAll(".code-block [spellcheck]"),t.length!==0&&(Hp(e),(0,vt.addScript)(`${e}/js/highlight.js/highlight.min.js?v=11.7.0`,"protyleHljsScript").then(()=>{(0,vt.addScript)(`${e}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{t.forEach(i=>{var s,o;const l=i.parentElement.querySelectorAll(".protyle-icon");if(l.length===2&&(l[0].setAttribute("aria-label",window.siyuan.languages.copy),l[1].setAttribute("aria-label",window.siyuan.languages.more)),i.getAttribute("data-render")==="true")return;const r=i.querySelector("wbr");let c=0;if(r){let b=r.previousSibling;for(;b;){for(c+=b.textContent.length;!b.previousSibling&&b.parentElement.tagName!=="DIV";)b=b.parentElement;b=b.previousSibling}r.remove()}let u;a?u=i.parentElement.getAttribute("data-language"):i.previousElementSibling?u=i.previousElementSibling.firstElementChild.textContent:u=i.className.replace("language-",""),window.hljs.getLanguage(u)||(u="plaintext"),i.classList.add("hljs"),i.setAttribute("data-render","true");const d=i.parentElement.getAttribute("linewrap"),f=i.parentElement.getAttribute("ligatures"),g=i.parentElement.getAttribute("linenumber");d==="true"||d!=="false"&&window.siyuan.config.editor.codeLineWrap?(i.style.setProperty("white-space","pre-wrap"),i.style.setProperty("word-break","break-all")):(i.style.setProperty("white-space","pre"),i.style.setProperty("word-break","initial")),f==="true"||f!=="false"&&window.siyuan.config.editor.codeLigatures?i.style.fontVariantLigatures="normal":i.style.fontVariantLigatures="none";const h=i.parentElement.querySelector(".protyle-action__language");!a&&(g==="true"||g!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(i.classList.add("protyle-linenumber"),Xs(i),h&&(h.style.marginLeft="3.6em")):(s=i.nextElementSibling)!=null&&s.classList.contains("protyle-linenumber__rows")&&(i.classList.remove("protyle-linenumber"),i.nextElementSibling.remove(),h&&(h.style.marginLeft=""));const m=$(i,"search__layout",!0);if(m&&i.parentElement.getAttribute("data-node-id")===((o=m.querySelector("#searchList > .b3-list-item--focus"))==null?void 0:o.getAttribute("data-node-id"))){const b=i.querySelector('span[data-type="search-mark"]');b&&b.scrollIntoView()}i.innerHTML=window.hljs.highlight(i.textContent+(i.textContent.endsWith(`
`)?"":`
`),{language:u,ignoreIllegals:!0}).value,r&&getSelection().rangeCount>0&&Fn(i,c,c)})})}))},Xs=n=>{var e;if(n.parentElement.getAttribute("lineNumber")==="false"||n.nextElementSibling&&n.nextElementSibling.clientHeight===n.clientHeight)return;n.classList.add("protyle-linenumber"),n.parentElement.style.lineHeight=`${((parseInt(n.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const t=document.createElement("div");t.className="hljs protyle-linenumber",t.setAttribute("style",`padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;white-space:${n.style.whiteSpace};word-break:${n.style.wordBreak};font-variant-ligatures:${n.style.fontVariantLigatures};`),t.setAttribute("contenteditable","true"),n.insertAdjacentElement("afterend",t);let a="";const i=n.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);i[i.length-1]===""&&i.length>1&&i.pop();const s=n.style.wordBreak==="break-all";i.map(l=>{let r="";s&&(t.textContent=l||`
`,r=` style="height:${t.clientHeight}px;"`),a+=`<span${r}></span>`}),t.remove();const o=n.offsetHeight;(e=n.nextElementSibling)!=null&&e.classList.contains("protyle-linenumber__rows")?(n.nextElementSibling.innerHTML=a,n.nextElementSibling.style.height=o+"px"):n.insertAdjacentHTML("afterend",`<span contenteditable="false" style="height:${o}px" class="protyle-linenumber__rows">${a}</span>`)},ik=(n,e)=>{},ty=n=>{const e=new Le({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${(0,T.tq)()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${(0,T.tq)()?"padding: 16px;margin: 16px 0":"padding: 48px;margin: 8px 0 24px"};border: 1px solid var(--b3-border-color);border-radius: var(--b3-border-radius-b);" class="export-img protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}" id="preview"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <span class="fn__flex-1"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:(0,T.tq)()?"92vw":"990px",height:"70vh"}),t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{const o=q(window.siyuan.languages.exporting,0);e.element.querySelector(".b3-dialog__container").style.height="",Ue(p.Constants.LOCAL_EXPORTIMG,window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG]),setTimeout(()=>{(0,vt.addScript)("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(a.parentElement,{useCORS:!0}).then(l=>{l.toBlob(r=>{const c=new FormData;c.append("file",r,t[1].getAttribute("data-title")),c.append("type","image/png"),_("/api/export/exportAsFile",c,u=>{z(u.data.file)}),j(o),e.destroy()})})})},p.Constants.TIMEOUT_LOAD)});const a=e.element.querySelector("#preview"),i=e.element.querySelector("#keepFold");i.addEventListener("change",()=>{t[0].setAttribute("disabled","disabled"),t[1].setAttribute("disabled","disabled"),t[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG].keepFold=i.checked,_("/api/export/exportPreviewHTML",{id:n,keepFold:i.checked,image:!0},o=>{s(o)})});const s=o=>{a.innerHTML=o.data.content,yt(a),Ze(a),a.querySelectorAll("table").forEach(l=>{l.clientWidth>l.parentElement.clientWidth&&(l.setAttribute("style",`margin-bottom:${l.parentElement.clientWidth*l.clientHeight/l.clientWidth-l.parentElement.clientHeight+1}px;transform: scale(${l.parentElement.clientWidth/l.clientWidth});transform-origin: top left;`),l.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(l=>{const r=l.firstElementChild.getAttribute("xlink:href"),c=document.querySelectorAll(r);let u="0 0 32 32";r==="#iconDot"&&(u="0 0 20 20"),l.setAttribute("viewBox",u),l.innerHTML=c[c.length-1].innerHTML}),t[0].removeAttribute("disabled"),t[1].removeAttribute("disabled"),e.element.querySelector(".fn__loading").remove()};_("/api/export/exportPreviewHTML",{id:n,keepFold:i.checked,image:!0},o=>{s(o),t[1].setAttribute("data-title",o.data.name+".png")})};var ny=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Op=(n,e)=>{n.addEventListener("change",()=>{_("/api/attr/setBlockAttrs",{id:e,attrs:{[n.dataset.name]:n.value}})})},ay=n=>{const e=n.getAttribute("data-node-id"),t=he(n),a=n.getAttribute(p.Constants.CUSTOM_REMINDER_WECHAT);let i="";a&&(i=ue(a).format("YYYY-MM-DDTHH:mm"));const s=new Le({width:(0,T.tq)()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){ee(t)}}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),_("/api/block/setBlockReminder",{id:e,timed:"0"},()=>{n.removeAttribute(p.Constants.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),o[2].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){q(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=ue(l).format("YYYYMMDDHHmmss");_("/api/block/setBlockReminder",{id:e,timed:r},()=>{n.setAttribute(p.Constants.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else q(window.siyuan.languages.notEmpty)})},iy=n=>{_("/api/block/getDocInfo",{id:n.block.rootID},e=>{const t=e.data.ial[p.Constants.CUSTOM_REMINDER_WECHAT];let a="";t&&(a=ue(t).format("YYYY-MM-DDTHH:mm"));const i=new Le({width:(0,T.tq)()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{_("/api/block/setBlockReminder",{id:n.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){q(window.siyuan.languages.reminderTip);return}_("/api/block/setBlockReminder",{id:n.block.rootID,timed:ue(o).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else q(window.siyuan.languages.notEmpty)})})},On=(n,e="bookmark",t)=>{let a="",i="",s=!1;const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(n).forEach(r=>{p.Constants.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===p.Constants.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" readonly data-name="${r}" value="${ue(n[r]).format("YYYY-MM-DDTHH:mm")}">
</label>`:r.indexOf("custom-av")>-1?s=!0:r.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" rows="1" data-name="${r}">${n[r]}</textarea>
</label>`))});const l=new Le({width:(0,T.tq)()?"92vw":"50vw",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${n.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--outline">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){ee(o)}});l.element.querySelector('.b3-text-field[data-name="bookmark"]').value=n.bookmark||"",l.element.querySelector('.b3-text-field[data-name="name"]').value=n.name||"",l.element.querySelector('.b3-text-field[data-name="alias"]').value=n.alias||"",l.element.addEventListener("click",r=>{let c=r.target;for(typeof r.detail=="string"&&(c=l.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!c.isSameNode(l.element);){const u=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),l.element.querySelectorAll(".custom-attr").forEach(d=>{d.dataset.type===c.dataset.type?(d.dataset.type==="NodeAttributeView"&&d.innerHTML===""&&ew(d,n.id,t),d.classList.remove("fn__none")):d.classList.add("fn__none")});else if(u==="remove"){_("/api/attr/setBlockAttrs",{id:n.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(u==="bookmark"){_("/api/attr/getBookmarkLabels",{},d=>{window.siyuan.menus.menu.remove(),d.data.length===0?window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.emptyContent,type:"readonly"}).element):d.data.forEach(f=>{window.siyuan.menus.menu.append(new I({label:f,click(){const g=c.parentElement.parentElement.querySelector("input");g.value=f,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(u==="addCustom"){const d=new Le({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),f=d.element.querySelector("input"),g=d.element.querySelectorAll(".b3-button");d.bindInput(f,()=>{g[1].click()}),f.focus(),f.select(),g[0].addEventListener("click",()=>{d.destroy()}),g[1].addEventListener("click",()=>{if(!(0,T.vc)(f.value))return q(window.siyuan.languages.attrName+" <b>"+f.value+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${f.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea data-name="custom-${f.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const h=c.parentElement.previousElementSibling.querySelector(".b3-text-field");h.focus(),Op(h,n.id),d.destroy()}),r.stopPropagation(),r.preventDefault();break}c=c.parentElement}}),l.element.querySelectorAll(".b3-text-field").forEach(r=>{e!=="av"&&e===r.getAttribute("data-name")&&r.focus(),Op(r,n.id)}),e==="av"&&l.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},ga=(n,e="bookmark",t)=>{if(n.getAttribute("data-type")==="NodeThematicBreak")return;const a=n.getAttribute("data-node-id");_("/api/attr/getBlockAttrs",{id:a},i=>{On(i.data,e,t)})},li=(n,e=!0,t)=>[{icon:"iconRef",accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{_("/api/block/getRefText",{id:n},a=>{O(`((${n} '${a.data}'))`)}),t&&we(t)}},{icon:"iconSQL",label:window.siyuan.languages.copyBlockEmbed,accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{O(`{{select * from blocks where id='${n}'}}`),t&&we(t)}},{icon:"iconSiYuan",label:window.siyuan.languages.copyProtocol,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{O(`siyuan://blocks/${n}`),t&&we(t)}},{label:window.siyuan.languages.copyProtocolInMd,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{_("/api/block/getRefText",{id:n},a=>{O(`[${a.data}](siyuan://blocks/${n})`)}),t&&we(t)}},{label:window.siyuan.languages.copyHPath,accelerator:e?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{_("/api/filetree/getHPathByID",{id:n},a=>{O(a.data)})}},{label:window.siyuan.languages.copyID,accelerator:e?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{O(n),t&&we(t)}}],Rp=n=>new I({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>ny(void 0,null,function*(){const e=yield kt("/api/block/getRefText",{id:n}),t=new Le({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),a=t.element.querySelector("input"),i=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{i[1].click()});let s=on(e.data);const o=32;s.length>o&&(s=s.substring(0,o)),a.value=s,a.focus(),a.select(),i[0].addEventListener("click",()=>{t.destroy()}),i[1].addEventListener("click",()=>{a.value.trim()===""?a.value="Untitled":a.value=on(a.value),s.length>o&&(s=s.substring(0,o)),_("/api/template/docSaveAsTemplate",{id:n,name:a.value,overwrite:!1},l=>{if(l.code===1){Ne(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{_("/api/template/docSaveAsTemplate",{id:n,name:a.value,overwrite:!0},r=>{r.code===0&&q(window.siyuan.languages.exportTplSucc)})});return}q(window.siyuan.languages.exportTplSucc)}),t.destroy()})})},{label:"Markdown",icon:"iconMarkdown",click:()=>{const e=q(window.siyuan.languages.exporting,-1);_("/api/export/exportMd",{id:n},t=>{j(e),z(t.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=q(window.siyuan.languages.exporting,-1);_("/api/export/exportSY",{id:n},t=>{j(e),z(t.data.zip)})}},{label:window.siyuan.languages.image,icon:"iconImage",click:()=>{ty(n)}}]}).element,Js=(n,e,t,a)=>{const i=[];if(go(e)&&p.Constants.SIYUAN_ASSETS_EXTS.includes(xe().extname(e))&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&!e.startsWith("file://"))&&i.push({icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:a?"Click":"",click(){as(n,e.trim(),parseInt((0,T.on)("page",e)),"right")}}),i.push({label:window.siyuan.languages.useBrowserView,accelerator:a?"Click":"",click:()=>{z(e)}}),t)return i;window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.openBy,submenu:i}).element)},qp=n=>new I({accelerator:window.siyuan.config.keymap.editor.general.rename.custom,label:window.siyuan.languages.rename,click:()=>{_c(n)}}).element,gd=n=>new I({label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){ya((e,t)=>{Vd(n,t[0],e[0])},n)}}).element,sy=n=>{const e=`<div class="fn__flex">${De(n.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small">${window.siyuan.languages.copy} ID</button></div>`,t=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label">
    ${window.siyuan.languages.fileTree12}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="docCreateSavePath" value="">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree5}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${n.conf.dailyNoteTemplatePath}">
</div></div>`;let a;(0,T.tq)()?Jf({title:e,icon:"iconSettings",html:`<div>${t}</div>`,bindEvent(){Fp(document.querySelector("#model"),n)}}):(a=new Le({width:"80vw",title:e,content:t}).element,Fp(a,n))},Fp=(n,e)=>{n.querySelector(".b3-button--small").addEventListener("click",()=>{O(e.box),q(window.siyuan.languages.copied)});const t=n.querySelector("#dailyNoteSavePath");t.value=e.conf.dailyNoteSavePath;const a=n.querySelector("#docCreateSavePath");a.value=e.conf.docCreateSavePath;const i=n.querySelector("#refCreateSavePath");i.value=e.conf.refCreateSavePath;const s=n.querySelector("#dailyNoteTemplatePath");s.value=e.conf.dailyNoteTemplatePath,n.querySelectorAll("input").forEach(o=>{o.addEventListener("change",()=>{_("/api/notebook/setNotebookConf",{notebook:e.box,conf:{refCreateSavePath:i.value,docCreateSavePath:a.value,dailyNoteSavePath:t.value,dailyNoteTemplatePath:s.value}})})})};var oy=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const pn=n=>oy(void 0,null,function*(){if(window.siyuan.dialogs.find(r=>{if(r.element.querySelector("#searchList")){const c=r.element.getAttribute("data-key"),u=r.element.querySelectorAll(".search__header")[1];if(c!==n.hotkey&&n.hotkey===window.siyuan.config.keymap.general.replace.custom&&u.classList.contains("fn__none"))return u.classList.remove("fn__none"),r.element.setAttribute("data-key",n.hotkey),!0;const d=r.element.querySelector("#searchPathInput");if(c!==n.hotkey&&n.hotkey===window.siyuan.config.keymap.general.globalSearch.custom){if(d.textContent!=="")return r.destroy(),!1;if(!u.classList.contains("fn__none"))return u.classList.add("fn__none"),r.element.setAttribute("data-key",n.hotkey),!0}if(c!==n.hotkey&&n.hotkey===window.siyuan.config.keymap.general.search.custom){if(d.textContent==="")return r.destroy(),!1;if(!u.classList.contains("fn__none"))return u.classList.add("fn__none"),r.element.setAttribute("data-key",n.hotkey),!0}return r.destroy(),!0}}))return;const t=window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA];let a="",i=[];if(n.notebookId){if(a=Xn(n.notebookId),i.push(n.notebookId),n.searchPath&&n.searchPath!=="/"){const r=yield kt("/api/filetree/getHPathByPath",{notebook:n.notebookId,path:n.searchPath.endsWith(".sy")?n.searchPath:n.searchPath+".sy"});a=xe().join(a,r.data),i[0]=xe().join(i[0],n.searchPath)}}else window.siyuan.config.keymap.general.globalSearch.custom===n.hotkey&&(t.removed?(a="",i=[]):(a=t.hPath,i=t.idPath));let s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0));const o=new Le({content:"",width:"80vw",height:"90vh",destroyCallback(r){s&&!r&&ee(s),l&&l.destroy()},resizeCallback(r){r!=="d"&&r!=="t"&&l&&l.resize()}});o.element.setAttribute("data-key",n.hotkey);const l=Vf(n.app,{removed:t.removed,k:n.key||t.k,r:t.r,hasReplace:n.hotkey===window.siyuan.config.keymap.general.replace.custom,method:t.method,hPath:a,idPath:i,group:t.group,sort:t.sort,types:Object.assign({},t.types),page:n.key?1:t.page},o.element.querySelector(".b3-dialog__body"),()=>{o.destroy({focus:"false"})});o.editor=l}),Up=(n,e)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){_("/api/filetree/removeDoc",{notebook:n,path:e});return}_("/api/block/getDocInfo",{id:pt(e,!0,!0)},t=>{const a=De(t.data.name);let i=`${window.siyuan.languages.confirmDelete} <b>${a}</b>?`;t.data.subFileCount>0&&(i=`${window.siyuan.languages.confirmDelete} <b>${a}</b> ${window.siyuan.languages.andSubFile.replace("x",t.data.subFileCount)}?`),Ne(window.siyuan.languages.deleteOpConfirm,i,()=>{_("/api/filetree/removeDoc",{notebook:n,path:e})})})},Al=n=>{if(n.length===1){const e=ve(n[0],"UL");if(e){const t=e.getAttribute("data-url");n[0].getAttribute("data-type")==="navigation-file"?Up(t,n[0].getAttribute("data-path")):Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${Lute.EscapeHTMLStr(Xn(t))}</b>?`,()=>{_("/api/notebook/removeNotebook",{notebook:t,callback:p.Constants.CB_MOUNT_REMOVE})})}}else{const e=[];if(n.forEach(t=>{t.getAttribute("data-path")!=="/"&&e.push(t.getAttribute("data-path"))}),e.length===0){q(window.siyuan.languages.notBatchRemove);return}Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmRemoveAll.replace("${count}",e.length),()=>{_("/api/filetree/removeDocs",{paths:e})})}},hd=n=>{let e;return e=`<div class="block__icons">
        ${n.isTab?'<div class="fn__flex-1"></div>':`<div class="block__icon block__icon--show">
            <svg><use xlink:href="#iconRiffCard"></use></svg>
        </div>
        <span class="fn__space"></span>
        <span class="fn__flex-1 fn__flex-center resize__move">${window.siyuan.languages.riffCard}</span>`}
        <span class="fn__space"></span>
        <div data-type="count" class="ft__on-surface ft__smaller fn__flex-center${n.blocks.length===0?" fn__none":""}">1/${n.blocks.length}</span></div>
        <div class="fn__space"></div>
        <div data-id="${n.id||""}" data-cardtype="${n.cardType}" data-type="filter" class="block__icon block__icon--show">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </div>
        <div class="fn__space"></div>
        <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show" aria-label="${window.siyuan.languages.fullscreen}">
            <svg><use xlink:href="#iconFullscreen"></use></svg>
        </div>
        <div class="fn__space${n.isTab?" fn__none":""}"></div>
        <div data-type="sticktab" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show${n.isTab?" fn__none":""}" aria-label="${window.siyuan.languages.openInNewTab}">
            <svg><use xlink:href="#iconLayoutRight"></use></svg>
        </div>
    </div>`,`<div class="card__main">
    ${e}
    <div class="card__block fn__flex-1 ${n.blocks.length===0?"fn__none":""} 
${window.siyuan.config.flashcard.mark?"card__block--hidemark":""} 
${window.siyuan.config.flashcard.superBlock?"card__block--hidesb":""} 
${window.siyuan.config.flashcard.heading?"card__block--hideh":""} 
${window.siyuan.config.flashcard.list?"card__block--hideli":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${n.blocks.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action${n.blocks.length===0?" fn__none":""}">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            (p)
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer} (${window.siyuan.languages.space})</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <span>${window.siyuan.languages.nextRound}</span>
            <button data-type="-3" aria-label="0" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div>\u{1F4A4}</div>
                ${window.siyuan.languages.skip} (0)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div>\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain} (1)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div>\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard} (2)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div>\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood} (3)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ;" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div>\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy} (4)
            </button>
        </div>
    </div>
</div>`},Vp=n=>{let e=0;const t=new hn(n.app,n.element.querySelector("[data-type='render']"),{blockId:"",action:[p.Constants.CB_GET_ALL],render:{background:!1,title:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=t),n.blocks.length>0&&_("/api/filetree/getDoc",{id:n.blocks[e].blockID,mode:0,size:p.Constants.SIZE_GET_MAX},l=>{dt({data:l,protyle:t.protyle,action:l.data.rootID===l.data.id?[p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]})}),n.element.setAttribute("data-key",window.siyuan.config.keymap.general.riffCard.custom);const a=n.element.querySelector('[data-type="count"]'),i=n.element.querySelectorAll(".card__action"),s=n.element.querySelector('[data-type="filter"]'),o=()=>{const l=s.getAttribute("data-cardtype");_(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:s.getAttribute("data-id"),deckID:s.getAttribute("data-id"),notebook:s.getAttribute("data-id")},r=>{e=0,n.blocks=r.data.cards,n.blocks.length>0?Tl({countElement:a,editor:t,actionElements:i,index:e,blocks:n.blocks}):zp(a,t,i)})};return n.element.addEventListener("click",l=>{const r=l.target;let c="";if(typeof l.detail=="string")l.detail==="1"||l.detail==="j"?c="1":l.detail==="2"||l.detail==="k"?c="2":l.detail==="3"||l.detail==="l"?c="3":l.detail==="4"||l.detail===";"?c="4":l.detail===" "?c="-1":l.detail==="p"?c="-2":l.detail==="0"&&(c="-3");else{if(S(r,"data-type","fullscreen")){kl(n.element.querySelector(".card__main"),n.element.querySelector('[data-type="fullscreen"]')),Bt(t.protyle),l.stopPropagation(),l.preventDefault();return}if(S(r,"data-type","sticktab")){jn({app:n.app,position:"right",custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardType:s.getAttribute("data-cardtype"),id:s.getAttribute("data-id"),title:n.title},id:"siyuan-card"}}),n.dialog&&n.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}if(S(r,"data-type","close")){n.dialog&&n.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const g=S(r,"data-type","filter");if(g){_("/api/riff/getRiffDecks",{},m=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),o()}}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.fileTree,click(){ya((y,w)=>{s.setAttribute("data-id",y[0]==="/"?w[0]:pt(y[0],!0,!0)),s.setAttribute("data-cardtype",y[0]==="/"?"notebook":"doc"),o()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(n.title||m.data.length>0)&&window.siyuan.menus.menu.append(new I({type:"separator"}).element),n.title&&(window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:De(n.title),click(){s.setAttribute("data-id",n.id),s.setAttribute("data-cardtype",n.cardType),o()}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element)),m.data.forEach(y=>{window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,label:De(y.name),click(){s.setAttribute("data-id",y.id),s.setAttribute("data-cardtype","all"),o()}}).element)});const b=g.getBoundingClientRect();window.siyuan.menus.menu.popup({x:b.left,y:b.bottom})}),l.stopPropagation(),l.preventDefault();return}if(S(r,"data-type","newround")){o(),l.stopPropagation(),l.preventDefault();return}}if(!c){const u=$(r,"b3-button");u&&(c=u.getAttribute("data-type"))}if(!(!c||!n.blocks[e])){if(l.preventDefault(),l.stopPropagation(),ne(["toolbar","hint","util"],t.protyle),c==="-1"){if(i[0].classList.contains("fn__none"))return;t.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),i[0].classList.add("fn__none"),i[1].querySelectorAll(".b3-button").forEach((u,d)=>{u.previousElementSibling.textContent=n.blocks[e].nextDues[d]}),i[1].classList.remove("fn__none");return}if(c==="-2"){if(i[0].classList.contains("fn__none"))return;e>0&&(e--,Tl({countElement:a,editor:t,actionElements:i,index:e,blocks:n.blocks}));return}["1","2","3","4","-3"].includes(c)&&i[0].classList.contains("fn__none")&&_(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:n.blocks[e].deckID,cardID:n.blocks[e].cardID,rating:parseInt(c),reviewedCards:n.blocks},()=>{if(e++,e>n.blocks.length-1){const u=s.getAttribute("data-cardtype");_(u==="all"?"/api/riff/getRiffDueCards":u==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:s.getAttribute("data-id"),deckID:s.getAttribute("data-id"),notebook:s.getAttribute("data-id"),reviewedCards:n.blocks},d=>{e=0,n.blocks=d.data.cards,n.blocks.length===0?d.data.unreviewedCount>0?ly(a,t,i,d.data.unreviewedCount):zp(a,t,i):Tl({countElement:a,editor:t,actionElements:i,index:e,blocks:n.blocks})});return}Tl({countElement:a,editor:t,actionElements:i,index:e,blocks:n.blocks})})}}),t},Qs=n=>{_("/api/riff/getRiffDueCards",{deckID:""},e=>{ri(n,e.data,"all")})},ri=(n,e,t,a,i)=>{if(window.siyuan.dialogs.find(r=>{if(r.element.getAttribute("data-key")===window.siyuan.config.keymap.general.riffCard.custom)return r.destroy(),!0}))return;const o=new Le({content:hd({id:a,cardType:t,blocks:e.cards,isTab:!1}),width:(0,T.tq)()?"100vw":"80vw",height:(0,T.tq)()?"100vh":"70vh",destroyCallback(){l&&(l.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});o.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",o.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const l=Vp({app:n,element:o.element,blocks:e.cards,title:i,id:a,cardType:t,dialog:o});o.editor=l},Tl=n=>{n.editor.protyle.element.classList.add("card__block--hide"),window.siyuan.config.flashcard.superBlock&&n.editor.protyle.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&n.editor.protyle.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&n.editor.protyle.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&n.editor.protyle.element.classList.add("card__block--hidemark"),n.actionElements[0].classList.remove("fn__none"),n.actionElements[1].classList.add("fn__none"),n.editor.protyle.element.classList.remove("fn__none"),n.editor.protyle.element.nextElementSibling.classList.add("fn__none"),n.countElement.innerHTML=`${n.index+1}/${n.blocks.length}`,n.countElement.classList.remove("fn__none"),n.index===0?n.actionElements[0].firstElementChild.setAttribute("disabled","disabled"):n.actionElements[0].firstElementChild.removeAttribute("disabled"),_("/api/filetree/getDoc",{id:n.blocks[n.index].blockID,mode:0,size:p.Constants.SIZE_GET_MAX},e=>{dt({data:e,protyle:n.editor.protyle,action:e.data.rootID===e.data.id?[p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]})})},zp=(n,e,t)=>{n.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const a=e.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),t[0].classList.add("fn__none"),t[1].classList.add("fn__none")},ly=(n,e,t,a)=>{n.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const i=e.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),t[0].classList.add("fn__none"),t[1].classList.add("fn__none")},es=(n,e,t,a,i)=>{let s=1,o;_(`/api/riff/get${a}RiffCards`,{id:e,page:s},l=>{var r;const c=new Le({content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${De(t)}</span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${(0,T.tq)()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${(0,T.tq)()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${md(l.data.blocks,t,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:(0,T.tq)()?"100vw":"80vw",height:(0,T.tq)()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});l.data.blocks.length>0&&(o=new hn(n,c.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),c.editor=o,ci(o,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const u=c.element.querySelector('[data-type="previous"]'),d=c.element.querySelector('[data-type="next"]'),f=c.element.querySelector(".b3-list--background");l.data.pageCount>1&&d.removeAttribute("disabled"),c.element.setAttribute("data-key","viewCards"),c.element.addEventListener("click",g=>{var h;if(typeof g.detail=="string"){let b=f.querySelector(".b3-list-item--focus");if(b){b.classList.remove("b3-list-item--focus"),g.detail==="arrowup"?b=b.previousElementSibling||b.parentElement.lastElementChild:g.detail==="arrowdown"&&(b=b.nextElementSibling||b.parentElement.firstElementChild);const y=b.getBoundingClientRect(),w=b.parentElement.getBoundingClientRect();(y.top<w.top||y.bottom>w.bottom)&&b.scrollIntoView(y.top<w.top),ci(o,b.getAttribute("data-id")),b.classList.add("b3-list-item--focus")}g.stopPropagation(),g.preventDefault();return}let m=g.target;for(;m&&!c.element.isSameNode(m);){const b=m.getAttribute("data-type");if(b==="close"){c.destroy(),g.stopPropagation(),g.preventDefault();break}else if(b==="previous"){if(s<=1)return;s--,s<=1&&u.setAttribute("disabled","disabled"),_(`/api/riff/get${a}RiffCards`,{id:e,page:s},y=>{var w;s===y.data.pageCount?d.setAttribute("disabled","disabled"):y.data.pageCount>1&&d.removeAttribute("disabled"),d.nextElementSibling.nextElementSibling.textContent=`${s}/${y.data.pageCount||1}`,f.innerHTML=md(y.data.blocks,t,a),f.scrollTop=0,ci(o,(w=c.element.querySelector(".b3-list-item--focus"))==null?void 0:w.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(b==="next"){if(s>=l.data.pageCount)return;s++,u.removeAttribute("disabled"),_(`/api/riff/get${a}RiffCards`,{id:e,page:s},y=>{var w;s===y.data.pageCount?d.setAttribute("disabled","disabled"):y.data.pageCount>1&&d.removeAttribute("disabled"),d.nextElementSibling.nextElementSibling.textContent=`${s}/${y.data.pageCount||1}`,f.innerHTML=md(y.data.blocks,t,a),f.scrollTop=0,ci(o,(w=c.element.querySelector(".b3-list-item--focus"))==null?void 0:w.getAttribute("data-id"))}),g.stopPropagation(),g.preventDefault();break}else if(b==="card-item"){ci(o,m.getAttribute("data-id")),(h=f.querySelector(".b3-list-item--focus"))==null||h.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus"),g.stopPropagation(),g.preventDefault();break}else if(b==="remove"){_("/api/riff/removeRiffCards",{deckID:a===""?e:p.Constants.QUICK_DECK_ID,blockIDs:[m.getAttribute("data-id")]},y=>{var w;let E=m.parentElement.nextElementSibling;E||(E=m.parentElement.previousElementSibling),!E&&m.parentElement.parentElement.childElementCount>1&&(E=m.parentElement.parentElement.firstElementChild),E?(ci(o,E.getAttribute("data-id")),(w=f.querySelector(".b3-list-item--focus"))==null||w.classList.remove("b3-list-item--focus"),E.classList.add("b3-list-item--focus"),m.parentElement.remove()):(ci(o,""),f.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),i&&i(y)}),g.stopPropagation(),g.preventDefault();break}m=m.parentElement}})})},md=(n,e,t)=>{let a="",i=!0;const s=e.split("/");return s.splice(0,1),n.forEach(o=>{if(o.type){let l;t===""?l=Xn(o.box)+pt(Lute.UnEscapeHTMLStr(o.hPath),!1):(l=pt(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+s.join("/"),""),l.startsWith("/")&&(l=l.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${(0,T.tq)()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${ln(o.type)}"></use></svg>
${fe(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||p.Constants.ZWSP}</span>
<span data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span class="${(0,T.tq)()||!l?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${ia(l)}">${De(l)}</span>
<span aria-label="${window.siyuan.languages.revisionCount}" class="b3-tooltips b3-tooltips__w counter${o.riffCardReps===0?" fn__none":""}">${o.riffCardReps}</span>
</div>`,i=!1}else a+=`<div data-type="card-item" class="b3-list-item${(0,T.tq)()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-type="remove" data-id="${o.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),n.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},ci=(n,e)=>{if(!e){n.protyle.element.classList.add("fn__none"),n.protyle.element.nextElementSibling.classList.remove("fn__none");return}n.protyle.element.classList.remove("fn__none"),n.protyle.element.nextElementSibling.classList.add("fn__none"),n.protyle.scroll.lastScrollTop=0,os(n.protyle),_("/api/filetree/getDoc",{id:e,mode:0,size:p.Constants.SIZE_GET_MAX},t=>{dt({data:t,protyle:n.protyle,action:t.data.rootID===t.data.id?[p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]})})};let Il,eo=!1;const bd=(n,e,t)=>{const a=n.querySelector('[data-type="docprevious"]'),i=n.querySelector('[data-type="docnext"]');n.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const s=n.querySelector('.b3-select[data-type="opselect"]'),o=n.querySelector(".b3-list--background");n.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),n.querySelector('.history__text[data-type="mdPanel"]').classList.remove("fn__none"),_("/api/history/searchHistory",{query:t,page:e,op:s.value,type:3},l=>{if(e<l.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),i.nextElementSibling.nextElementSibling.textContent=`${e}/${l.data.pageCount||1}`,l.data.histories.length===0){o.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let r="";l.data.histories.forEach(c=>{r+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${c}">
    <span class="b3-list-item__text">${ue(parseInt(c)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),o.innerHTML=r})},Wp=n=>{const e=`<div class="fn__flex-column" style="height: 100%;">
        <div class="block__icons">
            ${(0,T.tq)()?"":n.pathString}
            <span class="fn__space"></span>
            <div class="fn__flex-1"></div>
            <select data-type="opselect" class="b3-select">
                <option value="all" selected>${window.siyuan.languages.allOp}</option>
                <option value="clean">clean</option>
                <option value="update">update</option>
                <option value="delete">delete</option>
                <option value="format">format</option>
                <option value="sync">sync</option>
                <option value="replace">replace</option>
            </select>
            <span class="fn__space"></span>
            <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
            <span class="fn__space"></span>
            <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
            <span class="fn__space"></span>
            <span>1/1</span>
            ${(0,T.tq)()?'<span class="fn__space"></span><span data-type="close" class="block__icon block__icon--show"><svg><use xlink:href="#iconClose"></use></svg></span>':""}
        </div>
        <div class="fn__flex fn__flex-1 history__panel">
            <ul class="b3-list b3-list--background" style="overflow:auto;">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
            <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
            <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
        </div>
</div>`,t=new Le({content:e,width:(0,T.tq)()?"100vw":"90vw",height:(0,T.tq)()?"100vh":"80vh",destroyCallback(){Il=void 0}}),a=t.element.querySelector(".b3-select");a.addEventListener("change",()=>{bd(t.element,1,n.id)});const i=t.element.querySelector('.history__text[data-type="docPanel"]'),s=t.element.querySelector('.history__text[data-type="mdPanel"]');bd(t.element,1,n.id),Il=new hn(n.app,i,{blockId:"",action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yn(Il.protyle),t.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(t.element);){const r=l.getAttribute("data-type");if(r==="close")t.destroy();else if(r==="rollback"&&!eo){Yp(l.parentElement,a.value,n.id,c=>{eo=!1,Ne("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",l.parentElement.textContent.trim())}`,()=>{_("/api/history/rollbackDocHistory",{notebook:n.notebookId,historyPath:c})})}),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")&&!eo){Yp(l,a.value,n.id,c=>{var u;_("/api/history/getDocHistoryContent",{historyPath:c},d=>{d.data.isLargeDoc?(s.value=d.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),dt({data:d,protyle:Il.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]})),eo=!1}),(u=l.parentElement.querySelector(".b3-list-item--focus"))==null||u.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus")}),o.stopPropagation(),o.preventDefault();break}else if((r==="docprevious"||r==="docnext")&&l.getAttribute("disabled")!=="disabled"){const c=parseInt(t.element.getAttribute("data-page"));bd(t.element,r==="docprevious"?c-1:c+1,n.id),o.stopPropagation(),o.preventDefault();break}l=l.parentElement}})},Yp=(n,e,t,a)=>{eo=!0;const i=n.getAttribute("data-path");i&&a(i),_("/api/history/getHistoryItems",{query:t,op:e,type:3,created:n.getAttribute("data-created")},s=>{a(s.data.items[0].path)})},to=n=>`<li data-id="${n.id}" data-name="${ia(n.name)}" class="b3-list-item b3-list-item--narrow${(0,T.tq)()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${De(n.name)}</span>
    <span class="b3-list-item__meta">${n.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${(0,T.tq)()?" fn__none":""}">${n.updated}</span>
</li>`,no=(n,e)=>{window.siyuan.dialogs.find(t=>{if(t.element.getAttribute("data-key")==="makeCard")return ne(["dialog"]),!0}),_("/api/riff/getRiffDecks",{},t=>{let a="";t.data.forEach(s=>{a+=to(s)});const i=new Le({width:(0,T.tq)()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});i.element.setAttribute("data-key","makeCard"),i.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isSameNode(i.element);){const l=o.getAttribute("data-type");if(l==="create"){let r="";const c=i.element.querySelector(".b3-text-field");c.value?(r&&j(r),_("/api/riff/createRiffDeck",{name:c.value},u=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",to(u.data)),c.value=""})):(r=q(window.siyuan.languages._kernel[142]),c.focus()),s.stopPropagation(),s.preventDefault();break}else if(l==="add"){_("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=to(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="remove"){_("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=to(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="delete"){Ne(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDelete} <b>${De(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{_("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})}),s.stopPropagation(),s.preventDefault();break}else if(l==="view"){es(n,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=to(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="viewall"){es(n,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(l==="rename"){const r=new Le({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),c=r.element.querySelector("input"),u=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{u[1].click()}),c.value=o.parentElement.getAttribute("data-name"),c.focus(),c.select(),u[0].addEventListener("click",()=>{r.destroy()}),u[1].addEventListener("click",()=>{_("/api/riff/renameRiffDeck",{name:c.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,o.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}})})},ao=(n,e)=>{let t=!0;const a=[];e.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),a.push(i.getAttribute("data-node-id")),(i.getAttribute(p.Constants.CUSTOM_RIFF_DECKS)||"").indexOf(p.Constants.QUICK_DECK_ID)===-1&&(t=!1))}),t?G(n,[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}]):G(n,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}])};var Gp=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const jp=(n,e)=>{if(!Array.from(n).find(s=>{if(s.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;window.siyuan.menus.menu.append(gd(Ud(Array.from(n)))),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{Al(Array.from(n))}}).element);const a=[];if(n.forEach(s=>{const o=s.getAttribute("data-node-id");o&&a.push(o)}),a.length===0)return window.siyuan.menus.menu;window.siyuan.menus.menu.append(new I({type:"separator"}).element);const i=[{iconHTML:p.Constants.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{G(void 0,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}])}},{iconHTML:p.Constants.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{G(void 0,[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}])}}];return window.siyuan.config.flashcard.deck&&i.push({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{no(e,a)}}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:i}).element),e.plugins&&Qt({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:n,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},Dl=(n,e)=>{window.siyuan.menus.menu.remove();const t=qe(e,"DIV");if(!t)return window.siyuan.menus.menu;e.classList.contains("b3-list-item--focus")||(t.querySelectorAll(".b3-list-item--focus").forEach(o=>{o.classList.remove("b3-list-item--focus"),o.removeAttribute("select-end"),o.removeAttribute("select-start")}),e.classList.add("b3-list-item--focus"));const a=t.querySelectorAll(".b3-list-item--focus");if(a.length>1)return jp(a,n);const i=e.parentElement.getAttribute("data-url"),s=Xn(i);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(qp({path:"/",notebookId:i,name:s,type:"notebook"})),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{_("/api/notebook/getNotebookConf",{notebook:i},l=>{sy(l.data)})}}).element);const o=Kp("notebook",parseInt(e.parentElement.getAttribute("data-sortmode")),l=>(_("/api/notebook/setNotebookConf",{notebook:i,conf:{sortMode:l}},()=>{var r;e.parentElement.setAttribute("data-sortmode",l.toString());let c;c=At("file").data.file;const u=e.querySelector(".b3-list-item__arrow--open");u&&(u.classList.remove("b3-list-item__arrow--open"),(r=e.nextElementSibling)==null||r.remove(),c.getLeaf(e,i))}),!0));window.siyuan.menus.menu.append(new I({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element)}return window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{_("/api/riff/getNotebookRiffDueCards",{notebook:i},o=>{ri(n,o.data,"notebook",i,s)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{es(n,i,s,"Notebook")}}]}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){pn({app:n,hotkey:window.siyuan.config.keymap.general.search.custom,notebookId:i})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){pn({app:n,hotkey:window.siyuan.config.keymap.general.replace.custom,notebookId:i})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.close,icon:"iconClose",click:()=>{_("/api/notebook/closeNotebook",{notebook:i})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{Al(Array.from(t.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new I({type:"separator"}).element),wd(i,"/"),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:"Markdown",icon:"iconMarkdown",click:()=>{const o=q(window.siyuan.languages.exporting,-1);_("/api/export/batchExportMd",{notebook:i,path:"/"},l=>{j(o),window.open(l.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const o=q(window.siyuan.languages.exporting,-1);_("/api/export/exportNotebookSY",{id:i},l=>{j(o),window.open(l.data.zip)})}}]}).element),n.plugins&&Qt({plugins:n.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},$l=(n,e,t,a)=>{window.siyuan.menus.menu.remove();const i=qe(a,"DIV");if(!i)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(i.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const s=i.querySelectorAll(".b3-list-item--focus");if(s.length>1)return jp(s,n);const o=a.getAttribute("data-node-id");let l=a.getAttribute("data-name");if(l=pt(l,!1,!0),!window.siyuan.config.readonly){let r,c;window.siyuan.config.fileTree.sort===6&&(window.siyuan.menus.menu.append(new I({icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const d=[];Array.from(a.parentElement.children).forEach(f=>{f.tagName==="LI"&&(f.isSameNode(a)&&d.push(void 0),d.push(f.getAttribute("data-path")))}),Xa({app:n,notebookId:e,currentPath:xe().dirname(t),paths:d,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const d=[];Array.from(a.parentElement.children).forEach(f=>{f.tagName==="LI"&&(d.push(f.getAttribute("data-path")),f.isSameNode(a)&&d.push(void 0))}),Xa({app:n,notebookId:e,currentPath:xe().dirname(t),paths:d,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element)),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:li(o,!1).concat([{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){_("/api/filetree/duplicateDoc",{id:o})}}])}).element),window.siyuan.menus.menu.append(gd(Ud(Array.from(i.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{Al(Array.from(i.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(qp({path:t,notebookId:e,name:l,type:"file"})),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.attr,icon:"iconAttr",click(){_("/api/block/getDocInfo",{id:o},d=>{On(d.data.ial)})}}).element);const u=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{_("/api/riff/getTreeRiffDueCards",{rootID:o},d=>{ri(n,d.data,"doc",o,l)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{_("/api/filetree/getHPathByID",{id:o},d=>{es(n,o,xe().join(Xn(e),d.data),"Tree")})}},{iconHTML:p.Constants.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{G(void 0,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}])}},{iconHTML:p.Constants.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{G(void 0,[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}],[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}])}}];window.siyuan.config.flashcard.deck&&u.push({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{no(n,[o])}}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:u}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Gp(this,null,function*(){const d=pt(t,!1,!0);pn({app:n,hotkey:window.siyuan.config.keymap.general.search.custom,notebookId:e,searchPath:d})})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return Gp(this,null,function*(){const d=pt(t,!1,!0);pn({app:n,hotkey:window.siyuan.config.keymap.general.replace.custom,notebookId:e,searchPath:d})})}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element)}return bf(n,o,e,t),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Wp({app:n,id:o,notebookId:e,pathString:l})}}).element),wd(e,t),window.siyuan.menus.menu.append(Rp(o)),n.plugins&&Qt({plugins:n.plugins,type:"open-menu-doctree",detail:{elements:s,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu},wd=(n,e)=>{window.siyuan.config.readonly||window.siyuan.menus.menu.append(new I({icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:t=>{t.querySelector(".b3-form__upload").addEventListener("change",a=>{const i=new FormData;i.append("file",a.target.files[0]),i.append("notebook",n),i.append("toPath",e),_("/api/import/importSY",i,()=>{var s;let o;o=At("file").data.file;const l=o.element.querySelector(`[data-path="${e}"]`),r=l.querySelector(".b3-list-item__arrow--open");r&&(r.classList.remove("b3-list-item__arrow--open"),(s=l.nextElementSibling)==null||s.remove()),o.getLeaf(l,n),window.siyuan.menus.menu.remove()})})}}]}).element)},Kp=(n,e,t)=>{const a=[{icon:e===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{t(0)}},{icon:e===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{t(1)}},{icon:e===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{t(4)}},{icon:e===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{t(5)}},{type:"separator"},{icon:e===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{t(9)}},{icon:e===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{t(10)}},{icon:e===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{t(2)}},{icon:e===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{t(3)}},{type:"separator"},{icon:e===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{t(7)}},{icon:e===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{t(8)}},{type:"separator"},{icon:e===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{t(11)}},{icon:e===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{t(12)}},{type:"separator"},{icon:e===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{t(13)}},{icon:e===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{t(14)}},{type:"separator"},{icon:e===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{t(6)}}];return n==="notebook"&&a.push({icon:e===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{t(15)}}),a};var ry=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class ha extends sn{constructor(e){super({app:e.app,type:"filetree",id:e.tab.id,msgCallback(t){if(t)switch(t.cmd){case"moveDoc":this.onMove(t);break;case"reloadFiletree":_a(()=>{this.init(!1)});break;case"mount":this.onMount(t);break;case"createnotebook":_a(a=>{let i;a.find(s=>{if(!s.closed){if(s.id===t.data.box.id)return i?this.element.querySelector(`.b3-list[data-url="${i}"]`).insertAdjacentHTML("afterend",this.genNotebook(t.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(t.data.box)),!0;i=s.id}})});break;case"unmount":case"removeDoc":this.onRemove(t);break;case"createdailynote":case"create":case"heading2doc":case"li2doc":this.onMkdir(t.data);break;case"renamenotebook":this.element.querySelector(`[data-url="${t.data.box}"] .b3-list-item__text`).innerHTML=De(t.data.name);break;case"rename":this.onRename(t.data);break}}}),this.genFileHTML=t=>{let a="";t.count&&t.count>0&&(a=`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${t.count}</span>`);const i=`${pt(t.name,!0,!0)} ${t.hSize}${t.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+t.bookmark:""}${t.name1?"<br>"+window.siyuan.languages.name+" "+t.name1:""}${t.alias?"<br>"+window.siyuan.languages.alias+" "+t.alias:""}${t.memo?"<br>"+window.siyuan.languages.memo+" "+t.memo:""}${t.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",t.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${t.hMtime}<br>${window.siyuan.languages.createdAt} ${t.hCtime}`;return`<li data-node-id="${t.id}" data-name="${Lute.EscapeHTMLStr(t.name)}" draggable="true" data-count="${t.subFileCount}" 
data-type="navigation-file" 
class="b3-list-item b3-list-item--hide-action" data-path="${t.path}">
    <span style="padding-left: ${(t.path.split("/").length-2)*18+22}px" class="b3-list-item__toggle b3-list-item__toggle--hl${t.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.changeIcon}">${fe(t.icon||(t.subFileCount===0?p.Constants.SIYUAN_IMAGE_FILE:p.Constants.SIYUAN_IMAGE_FOLDER))}</span>
    <span class="b3-list-item__text ariaLabel" data-position="parentE"
aria-label="${De(i)}">${pt(t.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${a}
</li>`},e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__file"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconFiles"></use></svg>
        ${window.siyuan.languages.fileTree}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="focus" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.selectOpen1} ${ae(window.siyuan.config.keymap.general.selectOpen1.custom)}"><svg><use xlink:href='#iconFocus'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${ae(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <div class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></div>
    <div data-type="more" class="b3-tooltips b3-tooltips__sw block__icon${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1"></div>
<ul class="b3-list fn__flex-column" style="min-height: auto;transition: var(--b3-transition)">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=e.tab.panelElement.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=e.tab.panelElement.lastElementChild,this.closeElement.addEventListener("click",t=>{lt(this.element.parentElement);let a=t.target;for(;a&&!a.isEqualNode(this.closeElement);){const i=a.getAttribute("data-type");if(a.classList.contains("b3-list-item__icon")){t.preventDefault(),t.stopPropagation();const s=a.getBoundingClientRect();ls(a.parentElement.getAttribute("data-url"),"notebook",{x:s.left,y:s.bottom,h:s.height,w:s.width});break}else if(i==="toggle"){this.closeElement.classList.contains("fn__flex-1")?(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1"),a.querySelector("svg").classList.remove("b3-list-item__arrow--open")):(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1"),a.querySelector("svg").classList.add("b3-list-item__arrow--open")),window.siyuan.menus.menu.remove(),t.stopPropagation(),t.preventDefault();break}else if(i==="remove"){Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${De(a.parentElement.querySelector(".b3-list-item__text").textContent)}</b>?`,()=>{_("/api/notebook/removeNotebook",{notebook:a.getAttribute("data-url"),callback:p.Constants.CB_MOUNT_REMOVE})}),window.siyuan.menus.menu.remove(),t.stopPropagation(),t.preventDefault();break}else if(i==="open"){_("/api/notebook/openNotebook",{notebook:a.getAttribute("data-url")}),window.siyuan.menus.menu.remove(),t.stopPropagation(),t.preventDefault();break}a=a.parentElement}}),this.actionsElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{Array.from(this.element.children).forEach(t=>{const a=t.firstElementChild,i=a.querySelector(".b3-list-item__arrow");i.classList.contains("b3-list-item__arrow--open")&&(i.classList.remove("b3-list-item__arrow--open"),a.nextElementSibling.remove())})}),this.actionsElement.addEventListener("click",t=>{let a=t.target;for(;a&&!a.isEqualNode(this.actionsElement);){const i=a.getAttribute("data-type");if(i==="min"){At("file").toggleModel("file",!1,!0),t.preventDefault(),t.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(i==="focus"){const s=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus")||document.querySelector(".layout-tab-bar > .item--focus");if(s){const o=St(s.getAttribute("data-id"));o&&o.model instanceof gt&&this.selectItem(o.model.editor.protyle.notebookId,o.model.editor.protyle.path)}t.preventDefault();break}else if(i==="more"){this.initMoreMenu().popup({x:t.clientX,y:t.clientY}),t.preventDefault(),t.stopPropagation();break}a=a.parentElement}lt(this.element.parentElement)}),this.element.addEventListener("mousedown",t=>{if(t.button!==1||!window.siyuan.config.fileTree.openFilesUseCurrentTab)return;let a=t.target;for(;a&&!a.isEqualNode(this.element);){if(a.tagName==="LI"&&!a.getAttribute("data-opening")){a.setAttribute("data-opening","true"),be({app:e.app,removeCurrentTab:!1,id:a.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){a.removeAttribute("data-opening")}}),t.stopPropagation(),t.preventDefault();break}a=a.parentElement}}),this.element.addEventListener("click",t=>{var a,i;let s=t.target;const o=ve(s,"UL");let l=!0;if(o){const r=o.getAttribute("data-url");for(;s&&!s.isEqualNode(this.element);){if(!t.metaKey&&!t.ctrlKey&&s.classList.contains("b3-list-item__icon")&&window.siyuan.config.system.container!=="ios"){t.preventDefault(),t.stopPropagation();const c=s.getBoundingClientRect();s.parentElement.getAttribute("data-type")==="navigation-file"?ls(s.parentElement.getAttribute("data-node-id"),"doc",{x:c.left,y:c.bottom,h:c.height,w:c.width}):ls(s.parentElement.parentElement.getAttribute("data-url"),"notebook",{x:c.left,y:c.bottom,h:c.height,w:c.width});break}else if(!t.metaKey&&!t.ctrlKey&&s.classList.contains("b3-list-item__toggle")){this.getLeaf(s.parentElement,r),this.setCurrent(s.parentElement),t.preventDefault(),t.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(!t.metaKey&&!t.ctrlKey&&s.classList.contains("b3-list-item__action")){const c=s.getAttribute("data-type"),u=s.parentElement.getAttribute("data-path");window.siyuan.config.readonly||(c==="new"?Xa({app:e.app,notebookId:r,currentPath:u,useSavePath:!1}):c==="more-root"&&Dl(e.app,s.parentElement).popup({x:t.clientX,y:t.clientY})),c==="more-file"&&$l(e.app,r,u,s.parentElement).popup({x:t.clientX,y:t.clientY}),t.preventDefault(),t.stopPropagation();break}else if(s.tagName==="LI"){if((t.metaKey||t.ctrlKey)&&!t.altKey&&!t.shiftKey)s.classList.toggle("b3-list-item--focus");else if(this.setCurrent(s,!1),s.getAttribute("data-type")==="navigation-file"){if(l=!1,s.getAttribute("data-opening"))return;s.setAttribute("data-opening","true"),t.altKey&&!t.metaKey&&!t.ctrlKey&&!t.shiftKey?be({app:e.app,id:s.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){s.removeAttribute("data-opening")}}):!t.altKey&&!t.metaKey&&!t.ctrlKey&&t.shiftKey?be({app:e.app,id:s.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){s.removeAttribute("data-opening")}}):window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.altKey&&(t.metaKey||t.ctrlKey)&&!t.shiftKey?be({app:e.app,removeCurrentTab:!1,id:s.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){s.removeAttribute("data-opening")}}):be({app:e.app,id:s.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){s.removeAttribute("data-opening")}})}else s.getAttribute("data-type")==="navigation-root"&&this.getLeaf(s,r);(a=this.element.querySelector('[select-end="true"]'))==null||a.removeAttribute("select-end"),(i=this.element.querySelector('[select-start="true"]'))==null||i.removeAttribute("select-start"),window.siyuan.menus.menu.remove(),t.stopPropagation(),t.preventDefault();break}s=s.parentElement}}l&&lt(this.element.parentElement)}),this.element.addEventListener("dragstart",t=>{if((0,T.b1)()){t.stopPropagation(),t.preventDefault();return}window.getSelection().removeAllRanges();const a=qe(t.target,"LI");if(a){let i=Array.from(this.element.querySelectorAll(".b3-list-item--focus"));a.classList.contains("b3-list-item--focus")||(i.forEach(l=>{l.classList.remove("b3-list-item--focus")}),a.classList.add("b3-list-item--focus"),i=[a]);let s="";const o=document.createElement("ul");i.forEach((l,r)=>{o.append(l.cloneNode(!0)),l.style.opacity="0.1";const c=l.dataset.nodeId||l.dataset.path;c&&(s+=c,r<i.length-1&&(s+=","))}),o.setAttribute("style",`width: 219px;position: fixed;top:-${i.length*30}px`),o.setAttribute("class","b3-list b3-list--background"),document.body.append(o),t.dataTransfer.setDragImage(o,16,16),t.dataTransfer.setData(p.Constants.SIYUAN_DROP_FILE,s),t.dataTransfer.dropEffect="move",window.siyuan.dragElement=document.createElement("div"),window.siyuan.dragElement.innerText=s,setTimeout(()=>{o.remove()})}}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll(".b3-list-item--focus").forEach(t=>{t.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("dragover",t=>{if(window.siyuan.config.readonly)return;const a=qe(t.target,"LI");if(!a||!window.siyuan.dragElement){t.preventDefault();return}a.classList.remove("dragover__top","dragover__bottom","dragover");let i="";for(const c of t.dataTransfer.items)c.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(i=c.type);if(i){const c=i.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP);["nodelistitem","nodeheading"].includes(c[0])&&a.classList.add("dragover"),t.preventDefault();return}if(a.classList.contains("b3-list-item--focus"))return;let s=!0;Array.from(this.element.querySelectorAll(".b3-list-item--focus")).find(c=>{if(c.getAttribute("data-type")==="navigation-file")return s=!1,!0});const o=a.getAttribute("data-type");if(s&&o!=="navigation-root"){t.preventDefault();return}const l=S(a,"data-sortmode",null);if(!l)return;const r=l.getAttribute("data-sortmode");if((r==="6"||window.siyuan.config.fileTree.sort===6&&r==="15")&&!(!s&&o==="navigation-root")){const c=a.getBoundingClientRect();t.clientY>c.top+20?(a.classList.add("dragover__bottom"),t.preventDefault()):t.clientY<c.bottom-20&&(a.classList.add("dragover__top"),t.preventDefault())}if(a.classList.contains("dragover__top")||a.classList.contains("dragover__bottom")||o==="navigation-root"&&s){t.preventDefault();return}a.classList.add("dragover"),t.preventDefault()}),this.element.addEventListener("dragleave",t=>{const a=qe(t.target,"LI");a&&a.classList.remove("dragover","dragover__bottom","dragover__top")}),this.element.addEventListener("drop",t=>ry(this,null,function*(){const a=qe(t.target,"LI");if(!a)return;const i=ve(a,"UL");if(!i)return;const s=i.getAttribute("data-url"),o=a.getAttribute("data-path");let l="";for(const f of t.dataTransfer.items)f.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(l=f.type);if(l&&a.classList.contains("dragover")){const f=l.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP);["nodelistitem","nodeheading"].includes(f[0])&&(f[0]==="nodeheading"?_("/api/filetree/heading2Doc",{targetNoteBook:s,srcHeadingID:f[2].split(",")[0],targetPath:o,pushMode:0}):_("/api/filetree/li2Doc",{pushMode:0,srcListItemID:f[2].split(",")[0],targetNoteBook:s,targetPath:o})),a.classList.remove("dragover","dragover__bottom","dragover__top"),window.siyuan.dragElement=void 0;return}if(window.siyuan.dragElement=void 0,!t.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE)){a.classList.remove("dragover","dragover__bottom","dragover__top");return}const r=[],c=[],u=[];if(this.element.querySelectorAll(".b3-list-item--focus").forEach(f=>{if(f.getAttribute("data-type")==="navigation-root")r.push(f);else{const g=f.getAttribute("data-path");u.find(m=>{if(g.startsWith(m.replace(".sy","")))return!0})||(c.push(f),u.push(g))}}),a.classList.contains("dragover")){_("/api/filetree/moveDocs",{toNotebook:s,fromPaths:u,toPath:o}),a.classList.remove("dragover","dragover__bottom","dragover__top");return}const d=i.getAttribute("data-sortmode");if((a.classList.contains("dragover__bottom")||a.classList.contains("dragover__top"))&&(d==="6"||window.siyuan.config.fileTree.sort===6&&d==="15"))if(r.length>0&&a.getAttribute("data-path")==="/"){a.classList.contains("dragover__top")?r.forEach(g=>{a.parentElement.before(g.parentElement)}):r.reverse().forEach(g=>{a.parentElement.after(g.parentElement)});const f=[];Array.from(this.element.children).forEach(g=>{f.push(g.getAttribute("data-url"))}),_("/api/notebook/changeSortNotebook",{notebooks:f})}else{let f=!1;const g=xe().dirname(o);u.length>0&&(yield kt("/api/filetree/moveDocs",{toNotebook:s,fromPaths:u,toPath:g==="/"?"/":g+".sy",callback:p.Constants.CB_MOVE_NOLIST}),c.forEach(m=>{m.setAttribute("data-path",xe().join(g,m.getAttribute("data-node-id")+".sy"))}),f=!0),a.classList.contains("dragover__top")?c.forEach(m=>{let b;m.nextElementSibling&&m.nextElementSibling.tagName==="UL"&&(b=m.nextElementSibling),a.before(m),b&&m.after(b)}):a.classList.contains("dragover__bottom")&&c.reverse().forEach(m=>{let b;m.nextElementSibling&&m.nextElementSibling.tagName==="UL"&&(b=m.nextElementSibling),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"?a.nextElementSibling.after(m):a.after(m),b&&m.after(b)});const h=[];Array.from(a.parentElement.children).forEach(m=>{m.tagName==="LI"&&h.push(m.getAttribute("data-path"))}),_("/api/filetree/changeSort",{paths:h,notebook:s},()=>{f&&_("/api/filetree/listDocsByPath",{notebook:s,path:g==="/"?"/":g+".sy"},m=>{if(m.data.path==="/"&&m.data.files.length===0){q(window.siyuan.languages.emptyContent);return}this.onLsHTML(m.data)})})}a.classList.remove("dragover","dragover__bottom","dragover__top")})),this.init(),window.siyuan.config.openHelp&&El()}genNotebook(e){const t=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${fe(e.icon||p.Constants.SIYUAN_IMAGE_NOTE)}</span>`;return e.closed?`<li data-type="open" data-url="${e.id}" class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${t}
    <span class="b3-list-item__text">${De(e.name)}</span>
    <span data-type="remove" data-url="${e.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.delete}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${e.id}" data-sort="${e.sort}" data-sortmode="${e.sortMode}">
<li class="b3-list-item b3-list-item--hide-action" draggable="true" data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${t}
    <span class="b3-list-item__text">${De(e.name)}</span>
    <span data-type="more-root" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(e=!0){let t="",a="";window.siyuan.notebooks.forEach(i=>{i.closed?a+=this.genNotebook(i):t+=this.genNotebook(i)}),this.element.innerHTML=t,this.closeElement.lastElementChild.innerHTML=a,e&&(t===""?(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1")):(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1")))}onMkdir(e){let t=this.element.querySelector(`ul[data-url="${e.box.id}"]`),a=xe().dirname(e.path)+".sy";for(;a!=="/"&&(t=t.querySelector(`li[data-path="${a}"]`),!t);)t=this.element.querySelector(`ul[data-url="${e.box.id}"]`),a==="/.sy"?a="/":a=xe().dirname(a)+".sy";if(t.tagName==="UL"&&(t=t.firstElementChild),t){t.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),t.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=t.querySelector(".b3-list-item__icon");i.innerHTML===fe(p.Constants.SIYUAN_IMAGE_FILE)&&(i.innerHTML=fe(p.Constants.SIYUAN_IMAGE_FOLDER)),t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.remove(),this.getLeaf(t,e.box.id)}}onRemove(e){if(e.cmd==="unmount"){if(_a(t=>{const a=this.element.querySelector(`ul[data-url="${e.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),p.Constants.CB_MOUNT_REMOVE!==e.callback)){let i="";t.find(s=>{s.closed&&(i+=this.genNotebook(s))}),this.closeElement.lastElementChild.innerHTML=i}}),p.Constants.CB_MOUNT_REMOVE===e.callback){const t=this.closeElement.querySelector(`li[data-url="${e.data.box}"]`);t&&t.remove()}return}e.data.ids.forEach(t=>{var a;const i=this.element.querySelector(`li.b3-list-item[data-node-id="${t}"]`);if(i){((a=i.nextElementSibling)==null?void 0:a.tagName)==="UL"&&i.nextElementSibling.remove();const s=i.parentElement.previousElementSibling;if(i.parentElement.childElementCount===1){if(s){const o=s.querySelector("svg");o.classList.remove("b3-list-item__arrow--open"),o.parentElement.classList.add("fn__hidden");const l=o.parentElement.nextElementSibling;l.innerHTML===fe(p.Constants.SIYUAN_IMAGE_FOLDER)&&(l.innerHTML=fe(p.Constants.SIYUAN_IMAGE_FILE))}i.parentElement.remove()}else i.remove()}})}onMount(e){if(e.data.existed)return;const t=this.closeElement.querySelector(`li[data-url="${e.data.box.id}"]`);t&&t.remove(),_a(a=>{const i=this.genNotebook(e.data.box);if(this.element.childElementCount===0)this.element.innerHTML=i;else{let s;a.find((o,l)=>{if(o.id===e.data.box.id){for(;l>0;)if(a[l-1].closed)l--;else{s=a[l-1].id;break}return!0}}),s?this.element.querySelector(`[data-url="${s}"]`).insertAdjacentHTML("afterend",i):this.element.insertAdjacentHTML("afterbegin",i)}})}onRename(e){const t=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);t&&(t.setAttribute("data-name",Lute.EscapeHTMLStr(e.title)),t.querySelector(".b3-list-item__text").innerHTML=De(e.title))}onMove(e){const t=this.element.querySelector(`ul[data-url="${e.data.fromNotebook}"] li[data-path="${e.data.fromPath}"]`);if(t)if(t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.remove(),t.parentElement.childElementCount===1){if(t.parentElement.previousElementSibling){t.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),t.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const i=t.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");i.innerHTML===fe(p.Constants.SIYUAN_IMAGE_FOLDER)&&(i.innerHTML=fe(p.Constants.SIYUAN_IMAGE_FILE))}t.parentElement.remove()}else t.remove();const a=this.element.querySelector(`[data-url="${e.data.toNotebook}"] li[data-path="${e.data.toPath}"]`);if(a){a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=a.querySelector(".b3-list-item__icon");i.innerHTML===fe(p.Constants.SIYUAN_IMAGE_FILE)&&(i.innerHTML=fe(p.Constants.SIYUAN_IMAGE_FOLDER));const s=a.querySelector(".b3-list-item__arrow");s.classList.contains("b3-list-item__arrow--open")&&(s.classList.remove("b3-list-item__arrow--open"),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&a.nextElementSibling.remove(),e.callback!==p.Constants.CB_MOVE_NOLIST&&this.getLeaf(a,e.data.toNotebook))}}onLsHTML(e){let t="";if(e.files.forEach(s=>{t+=this.genFileHTML(s)}),t==="")return;const a=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);if(!a)return;let i=a.nextElementSibling;i&&i.tagName==="UL"&&i.remove(),a.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),a.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${t}</ul>`),i=a.nextElementSibling,setTimeout(()=>{i.setAttribute("style",`top: -1px;position: relative;height:${i.childElementCount*(a.clientHeight+1)-1}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(s=>{s.classList.remove("file-tree__sliderDown"),s.removeAttribute("style")})},120)},2)}onLsSelect(e,t){let a="";if(e.files.forEach(s=>{a+=this.genFileHTML(s),t===s.path?this.selectItem(e.box,t):t.startsWith(s.path.replace(".sy",""))&&_("/api/filetree/listDocsByPath",{notebook:e.box,path:s.path},o=>{this.selectItem(o.data.box,t,o.data)})}),a==="")return;const i=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);i.nextElementSibling&&i.nextElementSibling.tagName==="UL"&&i.nextElementSibling.remove(),i.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.insertAdjacentHTML("afterend",`<ul>${a}</ul>`),this.setCurrent(this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${t}"]`))}setCurrent(e,t=!0){if(e&&(this.element.querySelectorAll("li").forEach(a=>{a.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"),t)){let a=e.offsetTop;e.parentElement.classList.contains("file-tree__sliderDown")&&e.offsetParent&&(a=e.offsetParent.offsetTop),this.element.scrollTop=a-this.element.clientHeight/2-this.actionsElement.clientHeight}}getLeaf(e,t){var a;const i=e.querySelector(".b3-list-item__arrow");if(i.classList.contains("b3-list-item__arrow--open")){i.classList.remove("b3-list-item__arrow--open"),(a=e.nextElementSibling)==null||a.remove();return}_("/api/filetree/listDocsByPath",{notebook:t,path:e.getAttribute("data-path")},s=>{if(s.data.path==="/"&&s.data.files.length===0){q(window.siyuan.languages.emptyContent);return}this.onLsHTML(s.data)})}selectItem(e,t,a){const i=this.element.querySelector(`[data-url="${e}"]`);if(!i)return;let s=t,o;for(;!o;)if(o=i.querySelector(`[data-path="${s}"]`),!o){const l=xe().dirname(s);l==="/"?s=l:s=l+".sy"}if(o.getAttribute("data-path")===t){this.setCurrent(o);return}a&&a.path===s?this.onLsSelect(a,t):_("/api/filetree/listDocsByPath",{notebook:e,path:s},l=>{this.onLsSelect(l.data,t)})}initMoreMenu(){if(window.siyuan.menus.menu.remove(),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new I({icon:"iconFilesRoot",label:window.siyuan.languages.newNotebook,click:()=>{Gf()}}).element),window.siyuan.menus.menu.append(new I({icon:"iconRefresh",label:window.siyuan.languages.rebuildIndex,click:()=>{this.element.getAttribute("disabled")||(this.element.setAttribute("disabled","disabled"),_("/api/filetree/refreshFiletree",{},()=>{this.element.removeAttribute("disabled"),this.init(!1)}))}}).element),!window.siyuan.config.readonly){const e=Kp("notebooks",window.siyuan.config.fileTree.sort,t=>{window.siyuan.config.fileTree.sort=t,_("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{_a(()=>{this.init(!1)})})});window.siyuan.menus.menu.append(new I({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:e}).element)}return window.siyuan.menus.menu}}const io="auto",yd=1,Zp=1.1,_d=.1,vd=10,Ed=0,cy=1.25,Xp=40,Jp=5,je={INITIAL:0,RUNNING:1,PAUSED:2,FINISHED:3},Nt={UNKNOWN:0,NORMAL:1,CHANGING:2,FULLSCREEN:3},Fe={UNKNOWN:-1,NONE:0,THUMBS:1,OUTLINE:2,ATTACHMENTS:3,LAYERS:4},Pl=typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")?{CANVAS:"canvas",SVG:"svg"}:null,Ml={DISABLE:0,ENABLE:1},He={UNKNOWN:-1,VERTICAL:0,HORIZONTAL:1,WRAPPED:2,PAGE:3},ft={UNKNOWN:-1,NONE:0,ODD:1,EVEN:2},Zt={SELECT:0,HAND:1,ZOOM:2},dy=/\bprint\s*\(/;class Qp{constructor(){const e=window.devicePixelRatio||1;this.sx=e,this.sy=e}get scaled(){return this.sx!==1||this.sy!==1}}function kd(n,e,t=!1){let a=n.offsetParent;if(!a){console.error("offsetParent is not set -- cannot scroll");return}let i=n.offsetTop+n.clientTop,s=n.offsetLeft+n.clientLeft;for(;a.clientHeight===a.scrollHeight&&a.clientWidth===a.scrollWidth||t&&(a.classList.contains("markedContent")||getComputedStyle(a).overflow==="hidden");)if(i+=a.offsetTop,s+=a.offsetLeft,a=a.offsetParent,!a)return;e&&(e.top!==void 0&&(i+=e.top),e.left!==void 0&&(s+=e.left,a.scrollLeft=s)),a.scrollTop=i}function eg(n,e){const t=function(s){i||(i=window.requestAnimationFrame(function(){i=null;const l=n.scrollLeft,r=a.lastX;l!==r&&(a.right=l>r),a.lastX=l;const c=n.scrollTop,u=a.lastY;c!==u&&(a.down=c>u),a.lastY=c,e(a)}))},a={right:!0,down:!0,lastX:n.scrollLeft,lastY:n.scrollTop,_eventHandler:t};let i=null;return n.addEventListener("scroll",t,!0),a}function Nl(n){const e=new Map;for(const[t,a]of new URLSearchParams(n))e.set(t.toLowerCase(),a);return e}const uy=/[\x01-\x1F]/g;function tg(n,e=!1){return typeof n!="string"?(console.error("The argument must be a string."),n):(e&&(n=n.replaceAll(uy," ")),n.replaceAll("\0",""))}function so(n,e,t=0){let a=t,i=n.length-1;if(i<0||!e(n[i]))return n.length;if(e(n[a]))return a;for(;a<i;){const s=a+i>>1,o=n[s];e(o)?i=s:a=s+1}return a}function ng(n){if(Math.floor(n)===n)return[n,1];const e=1/n,t=8;if(e>t)return[1,t];if(Math.floor(e)===e)return[1,e];const a=n>1?e:n;let i=0,s=1,o=1,l=1;for(;;){const c=i+o,u=s+l;if(u>t)break;a<=c/u?(o=c,l=u):(i=c,s=u)}let r;return a-i/s<o/l-a?r=a===n?[i,s]:[s,i]:r=a===n?[o,l]:[l,o],r}function Hl(n,e){const t=n%e;return t===0?n:Math.round(n-t+e)}function fy({view:n,userUnit:e,rotate:t}){const[a,i,s,o]=n,l=t%180!==0,r=(s-a)/72*e,c=(o-i)/72*e;return{width:l?c:r,height:l?r:c}}function py(n,e,t){if(n<2)return n;let a=e[n].div,i=a.offsetTop+a.clientTop;i>=t&&(a=e[n-1].div,i=a.offsetTop+a.clientTop);for(let s=n-2;s>=0&&(a=e[s].div,!(a.offsetTop+a.clientTop+a.clientHeight<=i));--s)n=s;return n}function ag({scrollEl:n,views:e,sortByVisibility:t=!1,horizontal:a=!1,rtl:i=!1}){const s=n.scrollTop,o=s+n.clientHeight,l=n.scrollLeft,r=l+n.clientWidth;function c(w){const E=w.div;return E.offsetTop+E.clientTop+E.clientHeight>s}function u(w){const E=w.div,k=E.offsetLeft+E.clientLeft,L=k+E.clientWidth;return i?k<r:L>l}const d=[],f=new Set,g=e.length;let h=so(e,a?u:c);h>0&&h<g&&!a&&(h=py(h,e,s));let m=a?r:-1;for(let w=h;w<g;w++){const E=e[w],k=E.div,L=k.offsetLeft+k.clientLeft,v=k.offsetTop+k.clientTop,A=k.clientWidth,C=k.clientHeight,D=L+A,x=v+C;if(m===-1)x>=o&&(m=x);else if((a?L:v)>m)break;if(x<=s||v>=o||D<=l||L>=r)continue;const P=Math.max(0,s-v)+Math.max(0,x-o),B=Math.max(0,l-L)+Math.max(0,D-r),V=(C-P)/C,X=(A-B)/A,Q=V*X*100|0;d.push({id:E.id,x:L,y:v,view:E,percent:Q,widthPercent:X*100|0}),f.add(E.id)}const b=d[0],y=d.at(-1);return t&&d.sort(function(w,E){const k=w.percent-E.percent;return Math.abs(k)>.001?-k:w.id-E.id}),{first:b,last:y,views:d,ids:f}}function gy(n){n.preventDefault()}function ig(n){let e=Math.hypot(n.deltaX,n.deltaY);const t=Math.atan2(n.deltaY,n.deltaX);return-.25*Math.PI<t&&t<.75*Math.PI&&(e=-e),e}function hy(n){const e=n.deltaMode;let t=ig(n);const a=30,i=30;return e===WheelEvent.DOM_DELTA_PIXEL?t/=a*i:e===WheelEvent.DOM_DELTA_LINE&&(t/=i),t}function Bl(n){return Number.isInteger(n)&&n%90===0}function sg(n){return Number.isInteger(n)&&Object.values(He).includes(n)&&n!==He.UNKNOWN}function og(n){return Number.isInteger(n)&&Object.values(ft).includes(n)&&n!==ft.UNKNOWN}function Sd(n){return n.width<=n.height}const lg=new Promise(function(n){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof window=="undefined"){setTimeout(n,20);return}window.requestAnimationFrame(n)}),Ld=typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof document=="undefined"?null:document.documentElement.style;function my(n,e,t){return Math.min(Math.max(n,e),t)}class by{constructor(e){F(this,qa,null);F(this,_i,null);F(this,vi,0);F(this,hs,null);F(this,Ei,!0);pe(this,qa,e.classList),pe(this,hs,e.style)}get percent(){return N(this,vi)}set percent(e){if(pe(this,vi,my(e,0,100)),isNaN(e)){N(this,qa).add("indeterminate");return}N(this,qa).remove("indeterminate"),N(this,hs).setProperty("--progressBar-percent",`${N(this,vi)}%`)}setWidth(e){if(!e)return;const a=e.parentNode.offsetWidth-e.offsetWidth;a>0&&N(this,hs).setProperty("--progressBar-end-offset",`${a}px`)}setDisableAutoFetch(e=5e3){isNaN(N(this,vi))||(N(this,_i)&&clearTimeout(N(this,_i)),this.show(),pe(this,_i,setTimeout(()=>{pe(this,_i,null),this.hide()},e)))}hide(){N(this,Ei)&&(pe(this,Ei,!1),N(this,qa).add("fn__hidden"),Ld.setProperty("--progressBar-percent","0"))}show(){N(this,Ei)||(pe(this,Ei,!0),N(this,qa).remove("fn__hidden"))}}qa=new WeakMap,_i=new WeakMap,vi=new WeakMap,hs=new WeakMap,Ei=new WeakMap;function wy(){let n=document,e=n.activeElement||n.querySelector(":focus");for(;e!=null&&e.shadowRoot;)n=e.shadowRoot,e=n.activeElement||n.querySelector(":focus");return e}function rg(n){let e=He.VERTICAL,t=ft.NONE;switch(n){case"SinglePage":e=He.PAGE;break;case"OneColumn":break;case"TwoPageLeft":e=He.PAGE;case"TwoColumnLeft":t=ft.ODD;break;case"TwoPageRight":e=He.PAGE;case"TwoColumnRight":t=ft.EVEN;break}return{scrollMode:e,spreadMode:t}}function yy(n){switch(n){case"UseNone":return Fe.NONE;case"UseThumbs":return Fe.THUMBS;case"UseOutlines":return Fe.OUTLINE;case"UseAttachments":return Fe.ATTACHMENTS;case"UseOC":return Fe.LAYERS}return Fe.NONE}const _y="noopener noreferrer nofollow",ma={NONE:0,SELF:1,BLANK:2,PARENT:3,TOP:4};function cg(n,{url:e,target:t,rel:a,enabled:i=!0}={}){if(!e||typeof e!="string")throw new Error('A valid "url" parameter must provided.');const s=tg(e);i?n.href=n.title=s:(n.href="",n.title=`Disabled: ${s}`,n.onclick=()=>!1);let o="";switch(t){case ma.NONE:break;case ma.SELF:o="_self";break;case ma.BLANK:o="_blank";break;case ma.PARENT:o="_parent";break;case ma.TOP:o="_top";break}n.target=o,n.rel=typeof a=="string"?a:_y}const fu=class{constructor({eventBus:e,externalLinkTarget:t=null,externalLinkRel:a=null,ignoreDestinationZoom:i=!1}={}){F(this,yo);F(this,ms,new Map);this.eventBus=e,this.externalLinkTarget=t,this.externalLinkRel=a,this.externalLinkEnabled=!0,this._ignoreDestinationZoom=i,this.baseUrl=null,this.pdfDocument=null,this.pdfViewer=null,this.pdfHistory=null}setDocument(e,t=null){this.baseUrl=t,this.pdfDocument=e,N(this,ms).clear()}setViewer(e){this.pdfViewer=e}setHistory(e){this.pdfHistory=e}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfViewer.currentPageNumber}set page(e){this.pdfViewer.currentPageNumber=e}get rotation(){return this.pdfViewer.pagesRotation}set rotation(e){this.pdfViewer.pagesRotation=e}get isInPresentationMode(){return this.pdfViewer.isInPresentationMode}goToDestination(e){return oe(this,null,function*(){if(!this.pdfDocument)return;let t,a;if(typeof e=="string"?(t=e,a=yield this.pdfDocument.getDestination(e)):(t=null,a=yield e),!Array.isArray(a)){console.error(`PDFLinkService.goToDestination: "${a}" is not a valid destination array, for dest="${e}".`);return}H(this,yo,mu).call(this,e,t,a)})}goToPage(e){if(!this.pdfDocument)return;const t=typeof e=="string"&&this.pdfViewer.pageLabelToPageNumber(e)||e|0;if(!(Number.isInteger(t)&&t>0&&t<=this.pagesCount)){console.error(`PDFLinkService.goToPage: "${e}" is not a valid page.`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.pushPage(t)),this.pdfViewer.scrollPageIntoView({pageNumber:t})}addLinkAttributes(e,t,a=!1){cg(e,{url:t,target:a?ma.BLANK:this.externalLinkTarget,rel:this.externalLinkRel,enabled:this.externalLinkEnabled})}getDestinationHash(e){if(typeof e=="string"){if(e.length>0)return this.getAnchorUrl("#"+escape(e))}else if(Array.isArray(e)){const t=JSON.stringify(e);if(t.length>0)return this.getAnchorUrl("#"+escape(t))}return this.getAnchorUrl("")}getAnchorUrl(e){return this.baseUrl?this.baseUrl+e:e}setHash(e){var i;if(!this.pdfDocument)return;let t,a;if(e.includes("=")){const s=Nl(e);if(s.has("search")&&this.eventBus.dispatch("findfromurlhash",{source:this,query:s.get("search").replaceAll('"',""),phraseSearch:s.get("phrase")==="true"}),s.has("page")&&(t=s.get("page")|0||1),s.has("zoom")){const o=s.get("zoom").split(","),l=o[0],r=parseFloat(l);l.includes("Fit")?l==="Fit"||l==="FitB"?a=[null,{name:l}]:l==="FitH"||l==="FitBH"||l==="FitV"||l==="FitBV"?a=[null,{name:l},o.length>1?o[1]|0:null]:l==="FitR"?o.length!==5?console.error('PDFLinkService.setHash: Not enough parameters for "FitR".'):a=[null,{name:l},o[1]|0,o[2]|0,o[3]|0,o[4]|0]:console.error(`PDFLinkService.setHash: "${l}" is not a valid zoom value.`):a=[null,{name:"XYZ"},o.length>1?o[1]|0:null,o.length>2?o[2]|0:null,r?r/100:l]}a?this.pdfViewer.scrollPageIntoView({pageNumber:t||this.page,destArray:a,allowNegativeOffset:!0}):t&&(this.page=t),s.has("pagemode")&&this.eventBus.dispatch("pagemode",{source:this,mode:s.get("pagemode")}),s.has("nameddest")&&this.goToDestination(s.get("nameddest"))}else{a=unescape(e);try{a=JSON.parse(a),Array.isArray(a)||(a=a.toString())}catch(s){}if(typeof a=="string"||H(i=fu,rr,Vm).call(i,a)){this.goToDestination(a);return}console.error(`PDFLinkService.setHash: "${unescape(e)}" is not a valid destination.`)}}executeNamedAction(e){var t,a;switch(e){case"GoBack":(t=this.pdfHistory)==null||t.back();break;case"GoForward":(a=this.pdfHistory)==null||a.forward();break;case"NextPage":this.pdfViewer.nextPage();break;case"PrevPage":this.pdfViewer.previousPage();break;case"LastPage":this.page=this.pagesCount;break;case"FirstPage":this.page=1;break;default:break}this.eventBus.dispatch("namedaction",{source:this,action:e})}executeSetOCGState(e){return oe(this,null,function*(){const t=this.pdfDocument,a=yield this.pdfViewer.optionalContentConfigPromise;if(t!==this.pdfDocument)return;let i;for(const s of e.state){switch(s){case"ON":case"OFF":case"Toggle":i=s;continue}switch(i){case"ON":a.setVisibility(s,!0);break;case"OFF":a.setVisibility(s,!1);break;case"Toggle":const o=a.getGroup(s);o&&a.setVisibility(s,!o.visible);break}}this.pdfViewer.optionalContentConfigPromise=Promise.resolve(a)})}cachePageRef(e,t){if(!t)return;const a=t.gen===0?`${t.num}R`:`${t.num}R${t.gen}`;N(this,ms).set(a,e)}_cachedPageNumber(e){if(!e)return null;const t=e.gen===0?`${e.num}R`:`${e.num}R${e.gen}`;return N(this,ms).get(t)||null}isPageVisible(e){return this.pdfViewer.isPageVisible(e)}isPageCached(e){return this.pdfViewer.isPageCached(e)}};let Ol=fu;ms=new WeakMap,yo=new WeakSet,mu=function(e,t=null,a){const i=a[0];let s;if(typeof i=="object"&&i!==null){if(s=this._cachedPageNumber(i),!s){this.pdfDocument.getPageIndex(i).then(o=>{this.cachePageRef(o+1,i),H(this,yo,mu).call(this,e,t,a)}).catch(()=>{console.error(`PDFLinkService.#goToDestinationHelper: "${i}" is not a valid page reference, for dest="${e}".`)});return}}else if(Number.isInteger(i))s=i+1;else{console.error(`PDFLinkService.#goToDestinationHelper: "${i}" is not a valid destination reference, for dest="${e}".`);return}if(!s||s<1||s>this.pagesCount){console.error(`PDFLinkService.#goToDestinationHelper: "${s}" is not a valid page number, for dest="${e}".`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.push({namedDest:t,explicitDest:a,pageNumber:s})),this.pdfViewer.scrollPageIntoView({pageNumber:s,destArray:a,ignoreDestinationZoom:this._ignoreDestinationZoom})},rr=new WeakSet,Vm=function(e){if(!Array.isArray(e))return!1;const t=e.length;if(t<2)return!1;const a=e[0];if(!(typeof a=="object"&&Number.isInteger(a.num)&&Number.isInteger(a.gen))&&!(Number.isInteger(a)&&a>=0))return!1;const i=e[1];if(!(typeof i=="object"&&typeof i.name=="string"))return!1;let s=!0;switch(i.name){case"XYZ":if(t!==5)return!1;break;case"Fit":case"FitB":return t===2;case"FitH":case"FitBH":case"FitV":case"FitBV":if(t!==3)return!1;break;case"FitR":if(t!==6)return!1;s=!1;break;default:return!1}for(let o=2;o<t;o++){const l=e[o];if(!(typeof l=="number"||s&&l===null))return!1}return!0},F(Ol,rr);class dg{constructor(){this.externalLinkEnabled=!0}get pagesCount(){return 0}get page(){return 0}set page(e){}get rotation(){return 0}set rotation(e){}get isInPresentationMode(){return!1}goToDestination(e){return oe(this,null,function*(){})}goToPage(e){}addLinkAttributes(e,t,a=!1){cg(e,{url:t,enabled:this.externalLinkEnabled})}getDestinationHash(e){return"#"}getAnchorUrl(e){return"#"}setHash(e){}executeNamedAction(e){}executeSetOCGState(e){}cachePageRef(e,t){}isPageVisible(e){return!0}isPageCached(e){return!0}}var Z=Ae(272);const Rl=Object.create(null);if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){typeof PDFJSDev!="undefined"&&PDFJSDev.test("LIB")&&typeof navigator=="undefined"&&(globalThis.navigator=Object.create(null));const n=navigator.userAgent||"",e=navigator.platform||"",t=navigator.maxTouchPoints||1,a=/Android/.test(n),i=/\b(iPad|iPhone|iPod)(?=;)/.test(n)||e==="MacIntel"&&t>1;(function(){(i||a)&&(Rl.maxCanvasPixels=5242880)})()}const le={VIEWER:2,API:4,WORKER:8,PREFERENCE:128},Rn={annotationEditorMode:{value:0,kind:le.VIEWER+le.PREFERENCE},annotationMode:{value:2,kind:le.VIEWER+le.PREFERENCE},cursorToolOnLoad:{value:0,kind:le.VIEWER+le.PREFERENCE},defaultZoomDelay:{value:400,kind:le.VIEWER+le.PREFERENCE},defaultZoomValue:{value:"",kind:le.VIEWER+le.PREFERENCE},disableHistory:{value:!1,kind:le.VIEWER},disablePageLabels:{value:!1,kind:le.VIEWER+le.PREFERENCE},enablePermissions:{value:!1,kind:le.VIEWER+le.PREFERENCE},enablePrintAutoRotate:{value:!0,kind:le.VIEWER+le.PREFERENCE},enableScripting:{value:typeof PDFJSDev=="undefined"||!PDFJSDev.test("CHROME"),kind:le.VIEWER+le.PREFERENCE},externalLinkRel:{value:"noopener noreferrer nofollow",kind:le.VIEWER},externalLinkTarget:{value:0,kind:le.VIEWER+le.PREFERENCE},historyUpdateUrl:{value:!1,kind:le.VIEWER+le.PREFERENCE},ignoreDestinationZoom:{value:!1,kind:le.VIEWER+le.PREFERENCE},imageResourcesPath:{value:"./images/",kind:le.VIEWER},maxCanvasPixels:{value:16777216,kind:le.VIEWER},forcePageColors:{value:!1,kind:le.VIEWER+le.PREFERENCE},pageColorsBackground:{value:"Canvas",kind:le.VIEWER+le.PREFERENCE},pageColorsForeground:{value:"CanvasText",kind:le.VIEWER+le.PREFERENCE},pdfBugEnabled:{value:typeof PDFJSDev=="undefined"||!PDFJSDev.test("PRODUCTION"),kind:le.VIEWER+le.PREFERENCE},printResolution:{value:150,kind:le.VIEWER},sidebarViewOnLoad:{value:-1,kind:le.VIEWER+le.PREFERENCE},scrollModeOnLoad:{value:-1,kind:le.VIEWER+le.PREFERENCE},spreadModeOnLoad:{value:-1,kind:le.VIEWER+le.PREFERENCE},textLayerMode:{value:1,kind:le.VIEWER+le.PREFERENCE},useOnlyCssZoom:{value:!1,kind:le.VIEWER+le.PREFERENCE},viewerCssTheme:{value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")?2:0,kind:le.VIEWER+le.PREFERENCE},viewOnLoad:{value:0,kind:le.VIEWER+le.PREFERENCE},cMapPacked:{value:!0,kind:le.API},cMapUrl:{value:"cmaps/",kind:le.API},disableAutoFetch:{value:!1,kind:le.API+le.PREFERENCE},disableFontFace:{value:!1,kind:le.API+le.PREFERENCE},disableRange:{value:!1,kind:le.API+le.PREFERENCE},disableStream:{value:!1,kind:le.API+le.PREFERENCE},docBaseUrl:{value:"",kind:le.API},enableXfa:{value:!0,kind:le.API+le.PREFERENCE},fontExtraProperties:{value:!1,kind:le.API},isEvalSupported:{value:!0,kind:le.API},isOffscreenCanvasSupported:{value:!0,kind:le.API},maxImageSize:{value:-1,kind:le.API},pdfBug:{value:!1,kind:le.API},standardFontDataUrl:{value:"standard_fonts/",kind:le.API},verbosity:{value:1,kind:le.API},workerPort:{value:null,kind:le.WORKER},workerSrc:{value:`${p.Constants.PROTYLE_CDN}/js/pdf/pdf.worker.js?v=3.5.141`,kind:le.WORKER}};typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")?(Rn.defaultUrl={value:"compressed.tracemonkey-pldi-09.pdf",kind:le.VIEWER},Rn.disablePreferences={value:typeof PDFJSDev!="undefined"&&PDFJSDev.test("TESTING"),kind:le.VIEWER},Rn.locale={value:navigator.language||"en-US",kind:le.VIEWER},Rn.renderer={value:"canvas",kind:le.VIEWER+le.PREFERENCE},Rn.sandboxBundleSrc={value:typeof PDFJSDev=="undefined"||!PDFJSDev.test("PRODUCTION")?"../build/dev-sandbox/pdf.sandbox.js":"../build/pdf.sandbox.js",kind:le.VIEWER}):PDFJSDev.test("CHROME")&&(Rn.defaultUrl={value:"",kind:le.VIEWER},Rn.disableTelemetry={value:!1,kind:le.VIEWER+le.PREFERENCE},Rn.sandboxBundleSrc={value:"../build/pdf.sandbox.js",kind:le.VIEWER});const ts=Object.create(null);class Se{constructor(){throw new Error("Cannot initialize AppOptions.")}static get(e){var i;const t=ts[e];if(t!==void 0)return t;const a=Rn[e];if(a!==void 0)return(i=Rl[e])!=null?i:a.value}static getAll(e=null){var a;const t=Object.create(null);for(const i in Rn){const s=Rn[i];if(e){if(!(e&s.kind))continue;if(e===le.PREFERENCE){const l=s.value,r=typeof l;if(r==="boolean"||r==="string"||r==="number"&&Number.isInteger(l)){t[i]=l;continue}throw new Error(`Invalid type for preference: ${i}`)}}const o=ts[i];t[i]=o!==void 0?o:(a=Rl[i])!=null?a:s.value}return t}static set(e,t){ts[e]=t}static setAll(e){for(const t in e)ts[t]=e[t]}static remove(e){delete ts[e]}}(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(Se._hasUserOptions=function(){return Object.keys(ts).length>0});const ug={EVENT:"event",TIMEOUT:"timeout"};function fg({target:n,name:e,delay:t=0}){return new Promise(function(a,i){if(typeof n!="object"||!(e&&typeof e=="string")||!(Number.isInteger(t)&&t>=0))throw new Error("waitOnEventOrTimeout - invalid parameters.");function s(c){n instanceof ql?n._off(e,o):n.removeEventListener(e,o),r&&clearTimeout(r),a(c)}const o=s.bind(null,ug.EVENT);n instanceof ql?n._on(e,o):n.addEventListener(e,o);const l=s.bind(null,ug.TIMEOUT),r=setTimeout(l,t)})}class ql{constructor(){F(this,bs,Object.create(null))}on(e,t,a=null){this._on(e,t,{external:!0,once:a==null?void 0:a.once})}off(e,t,a=null){this._off(e,t,{external:!0,once:a==null?void 0:a.once})}dispatch(e,t){const a=N(this,bs)[e];if(!a||a.length===0)return;let i;for(const{listener:s,external:o,once:l}of a.slice(0)){if(l&&this._off(e,s),o){(i||(i=[])).push(s);continue}s(t)}if(i){for(const s of i)s(t);i=null}}_on(e,t,a=null){var s;((s=N(this,bs))[e]||(s[e]=[])).push({listener:t,external:(a==null?void 0:a.external)===!0,once:(a==null?void 0:a.once)===!0})}_off(e,t,a=null){const i=N(this,bs)[e];if(i){for(let s=0,o=i.length;s<o;s++)if(i[s].listener===t){i.splice(s,1);return}}}}bs=new WeakMap;class vy extends ql{dispatch(e,t){if(typeof PDFJSDev!="undefined"&&!PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: AutomationEventBus.dispatch");super.dispatch(e,t);const a=Object.create(null);if(t)for(const s in t){const o=t[s];if(s==="source"){if(o===window||o===document)return;continue}a[s]=o}const i=document.createEvent("CustomEvent");i.initCustomEvent(e,!0,!0,a),document.dispatchEvent(i)}}class Ey{constructor(e,t){F(this,cr);this.eventBus=t,H(this,cr,zm).call(this,e)}}cr=new WeakSet,zm=function({editorFreeTextFontSize:e,editorFreeTextColor:t,editorInkColor:a,editorInkThickness:i,editorInkOpacity:s}){e.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:Z.AnnotationEditorParamsType.FREETEXT_SIZE,value:e.valueAsNumber})}),t.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:Z.AnnotationEditorParamsType.FREETEXT_COLOR,value:t.value})}),a.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:Z.AnnotationEditorParamsType.INK_COLOR,value:a.value})}),i.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:Z.AnnotationEditorParamsType.INK_THICKNESS,value:i.valueAsNumber})}),s.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:Z.AnnotationEditorParamsType.INK_OPACITY,value:s.valueAsNumber})}),this.eventBus._on("annotationeditorparamschanged",o=>{for(const[l,r]of o.details)switch(l){case Z.AnnotationEditorParamsType.FREETEXT_SIZE:e.value=r;break;case Z.AnnotationEditorParamsType.FREETEXT_COLOR:t.value=r;break;case Z.AnnotationEditorParamsType.INK_COLOR:a.value=r;break;case Z.AnnotationEditorParamsType.INK_THICKNESS:i.value=r;break;case Z.AnnotationEditorParamsType.INK_OPACITY:s.value=r;break}})};class ky{constructor(){F(this,ea,new WeakMap);F(this,bn,null)}get active(){return N(this,bn)}register(e,t=!1){return oe(this,null,function*(){if(typeof e!="object")throw new Error("Not enough parameters.");if(N(this,ea).has(e))throw new Error("The overlay is already registered.");N(this,ea).set(e,{canForceClose:t}),e.addEventListener("cancel",a=>{pe(this,bn,null)})})}unregister(e){return oe(this,null,function*(){if(N(this,ea).has(e)){if(N(this,bn)===e)throw new Error("The overlay cannot be removed while it is active.")}else throw new Error("The overlay does not exist.");N(this,ea).delete(e)})}open(e){return oe(this,null,function*(){if(N(this,ea).has(e)){if(N(this,bn)){if(N(this,bn)===e)throw new Error("The overlay is already active.");if(N(this,ea).get(e).canForceClose)yield this.close();else throw new Error("Another overlay is currently active.")}}else throw new Error("The overlay does not exist.");pe(this,bn,e),e.classList.add("dialog--open")})}close(){return oe(this,arguments,function*(e=N(this,bn)){if(N(this,ea).has(e))if(N(this,bn)){if(N(this,bn)!==e)throw new Error("Another overlay is currently active.")}else throw new Error("The overlay is currently not active.");else throw new Error("The overlay does not exist.");e.classList.remove("dialog--open"),pe(this,bn,null)})}}ea=new WeakMap,bn=new WeakMap;class Sy{constructor(e,t,a,i=!1){F(this,vo);F(this,dr);F(this,Eo);F(this,ta,null);F(this,ki,null);F(this,_o,null);this.dialog=e.dialog,this.label=e.label,this.input=e.input,this.submitButton=e.submitButton,this.cancelButton=e.cancelButton,this.overlayManager=t,this.l10n=a,this._isViewerEmbedded=i,this.submitButton.addEventListener("click",H(this,vo,bu).bind(this)),this.cancelButton.addEventListener("click",this.close.bind(this)),this.input.addEventListener("keydown",s=>{s.keyCode===13&&H(this,vo,bu).call(this)}),this.overlayManager.register(this.dialog,!0),this.dialog.addEventListener("close",H(this,dr,Wm).bind(this))}open(){return oe(this,null,function*(){N(this,ta)&&(yield N(this,ta).promise),pe(this,ta,(0,Z.createPromiseCapability)());try{yield this.overlayManager.open(this.dialog)}catch(t){throw pe(this,ta,null),t}const e=N(this,_o)===Z.PasswordResponses.INCORRECT_PASSWORD;(!this._isViewerEmbedded||e)&&this.input.focus(),this.label.textContent=window.siyuan.languages[`password_${e?"invalid":"label"}`]})}close(){return oe(this,null,function*(){this.overlayManager.active===this.dialog&&this.overlayManager.close(this.dialog)})}setUpdateCallback(e,t){return oe(this,null,function*(){N(this,ta)&&(yield N(this,ta).promise),pe(this,ki,e),pe(this,_o,t)})}}ta=new WeakMap,ki=new WeakMap,_o=new WeakMap,vo=new WeakSet,bu=function(){const e=this.input.value;(e==null?void 0:e.length)>0&&H(this,Eo,wu).call(this,e)},dr=new WeakSet,Wm=function(){H(this,Eo,wu).call(this,new Error("PasswordPrompt cancelled.")),N(this,ta).resolve()},Eo=new WeakSet,wu=function(e){N(this,ki)&&(this.close(),this.input.value="",N(this,ki).call(this,e),pe(this,ki,null))};const Ly=-100,pg="selected";class oo{constructor(e){if(this.constructor===oo)throw new Error("Cannot initialize BaseTreeViewer.");this.container=e.container,this.eventBus=e.eventBus,this.reset()}reset(){this._pdfDocument=null,this._lastToggleIsShow=!0,this._currentTreeItem=null,this.container.textContent="",this.container.classList.remove("treeWithDeepNesting")}_dispatchEvent(e){throw new Error("Not implemented: _dispatchEvent")}_bindLink(e,t){throw new Error("Not implemented: _bindLink")}_normalizeTextContent(e){return tg(e,!0)||"\u2013"}_addToggleButton(e,t=!1){const a=document.createElement("div");a.innerHTML='<svg><use xlink:href="#iconDown"></use></svg>',a.className="treeItemToggler",t&&a.classList.add("treeItemsHidden"),a.onclick=i=>{if(i.stopPropagation(),a.classList.toggle("treeItemsHidden"),i.shiftKey){const s=!a.classList.contains("treeItemsHidden");this._toggleTreeItem(e,s)}},e.prepend(a)}_toggleTreeItem(e,t=!1){this._lastToggleIsShow=t;for(const a of e.querySelectorAll(".treeItemToggler"))a.classList.toggle("treeItemsHidden",!t)}_toggleAllTreeItems(){this._toggleTreeItem(this.container,!this._lastToggleIsShow)}_finishRendering(e,t,a=!1){a&&(this.container.classList.add("treeWithDeepNesting"),this._lastToggleIsShow=!e.querySelector(".treeItemsHidden")),this.container.append(e),this._dispatchEvent(t)}render(e){throw new Error("Not implemented: render")}_updateCurrentTreeItem(e=null){this._currentTreeItem&&(this._currentTreeItem.classList.remove(pg),this._currentTreeItem=null),e&&(e.classList.add(pg),this._currentTreeItem=e)}_scrollToCurrentTreeItem(e){if(!e)return;let t=e.parentNode;for(;t&&t!==this.container;){if(t.classList.contains("treeItem")){const a=t.firstElementChild;a==null||a.classList.remove("treeItemsHidden")}t=t.parentNode}this._updateCurrentTreeItem(e),this.container.scrollTo(e.offsetLeft,e.offsetTop+Ly)}}class Cy extends oo{constructor(t){super(t);F(this,ur);this.downloadManager=t.downloadManager,this.eventBus._on("fileattachmentannotation",H(this,ur,Ym).bind(this))}reset(t=!1){super.reset(),this._attachments=null,t||(this._renderedCapability=(0,Z.createPromiseCapability)()),this._pendingDispatchEvent=!1}_dispatchEvent(t){return oe(this,null,function*(){this._renderedCapability.resolve(),!(t===0&&!this._pendingDispatchEvent&&(this._pendingDispatchEvent=!0,yield fg({target:this.eventBus,name:"annotationlayerrendered",delay:1e3}),!this._pendingDispatchEvent))&&(this._pendingDispatchEvent=!1,this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:t}))})}_bindLink(t,{content:a,filename:i}){t.onclick=()=>(this.downloadManager.openOrDownloadData(t,a,i),!1)}render({attachments:t,keepRenderedCapability:a=!1}){if(this._attachments&&this.reset(a),this._attachments=t||null,!t){this._dispatchEvent(0);return}const i=Object.keys(t).sort(function(l,r){return l.toLowerCase().localeCompare(r.toLowerCase())}),s=document.createDocumentFragment();let o=0;for(const l of i){const r=t[l],c=r.content,u=(0,Z.getFilenameFromUrl)(r.filename,!0),d=document.createElement("div");d.className="treeItem";const f=document.createElement("a");this._bindLink(f,{content:c,filename:u}),f.textContent=this._normalizeTextContent(u),d.append(f),s.append(d),o++}this._finishRendering(s,o)}}ur=new WeakSet,Ym=function({filename:t,content:a}){const i=this._renderedCapability.promise;i.then(()=>{if(i!==this._renderedCapability.promise)return;const s=this._attachments||Object.create(null);for(const o in s)if(t===o)return;s[t]={filename:t,content:a},this.render({attachments:s,keepRenderedCapability:!0})})};const gg="grab-to-pan-grab";class xy{constructor(e){F(this,fr);F(this,pr);F(this,gr);this.element=e.element,this.document=e.element.ownerDocument,typeof e.ignoreTarget=="function"&&(this.ignoreTarget=e.ignoreTarget),this.onActiveChanged=e.onActiveChanged,this.activate=this.activate.bind(this),this.deactivate=this.deactivate.bind(this),this.toggle=this.toggle.bind(this),this._onMouseDown=H(this,fr,Gm).bind(this),this._onMouseMove=H(this,pr,jm).bind(this),this._endPan=H(this,gr,Km).bind(this);const t=this.overlay=document.createElement("div");t.className="grab-to-pan-grabbing"}activate(){var e;this.active||(this.active=!0,this.element.addEventListener("mousedown",this._onMouseDown,!0),this.element.classList.add(gg),(e=this.onActiveChanged)==null||e.call(this,!0))}deactivate(){var e;this.active&&(this.active=!1,this.element.removeEventListener("mousedown",this._onMouseDown,!0),this._endPan(),this.element.classList.remove(gg),(e=this.onActiveChanged)==null||e.call(this,!1))}toggle(){this.active?this.deactivate():this.activate()}ignoreTarget(e){return e.matches("a[href], a[href] *, input, textarea, button, button *, select, option")}}fr=new WeakSet,Gm=function(e){if(e.button!==0||this.ignoreTarget(e.target))return;if(e.originalTarget)try{e.originalTarget.tagName}catch(a){return}this.scrollLeftStart=this.element.scrollLeft,this.scrollTopStart=this.element.scrollTop,this.clientXStart=e.clientX,this.clientYStart=e.clientY,this.document.addEventListener("mousemove",this._onMouseMove,!0),this.document.addEventListener("mouseup",this._endPan,!0),this.element.addEventListener("scroll",this._endPan,!0),e.preventDefault(),e.stopPropagation();const t=document.activeElement;t&&!t.contains(e.target)&&t.blur()},pr=new WeakSet,jm=function(e){if(this.element.removeEventListener("scroll",this._endPan,!0),!(e.buttons&1)){this._endPan();return}const t=e.clientX-this.clientXStart,a=e.clientY-this.clientYStart,i=this.scrollTopStart-a,s=this.scrollLeftStart-t;this.element.scrollTo?this.element.scrollTo({top:i,left:s,behavior:"instant"}):(this.element.scrollTop=i,this.element.scrollLeft=s),this.overlay.parentNode||document.body.append(this.overlay)},gr=new WeakSet,Km=function(){this.element.removeEventListener("scroll",this._endPan,!0),this.document.removeEventListener("mousemove",this._onMouseMove,!0),this.document.removeEventListener("mouseup",this._endPan,!0),this.overlay.remove()};class Ay{constructor({container:e,eventBus:t,cursorToolOnLoad:a=Zt.SELECT}){F(this,hr);F(this,mr);this.container=e,this.eventBus=t,this.active=Zt.SELECT,this.previouslyActive=null,this.handTool=new xy({element:this.container}),H(this,mr,Xm).call(this),Promise.resolve().then(()=>{this.switchTool(a)})}get activeTool(){return this.active}switchTool(e){if(this.previouslyActive!==null||e===this.active)return;const t=()=>{switch(this.active){case Zt.SELECT:break;case Zt.HAND:this.handTool.deactivate();break;case Zt.ZOOM:}};switch(e){case Zt.SELECT:t();break;case Zt.HAND:t(),this.handTool.activate();break;case Zt.ZOOM:default:console.error(`switchTool: "${e}" is an unsupported value.`);return}this.active=e,H(this,hr,Zm).call(this)}}hr=new WeakSet,Zm=function(){this.eventBus.dispatch("cursortoolchanged",{source:this,tool:this.active})},mr=new WeakSet,Xm=function(){this.eventBus._on("switchcursortool",s=>{this.switchTool(s.tool)});let e=Z.AnnotationEditorType.NONE,t=Nt.NORMAL;const a=()=>{var o;const s=this.active;this.switchTool(Zt.SELECT),(o=this.previouslyActive)!=null||(this.previouslyActive=s)},i=()=>{const s=this.previouslyActive;s!==null&&e===Z.AnnotationEditorType.NONE&&t===Nt.NORMAL&&(this.previouslyActive=null,this.switchTool(s))};this.eventBus._on("secondarytoolbarreset",s=>{this.previouslyActive!==null&&(e=Z.AnnotationEditorType.NONE,t=Nt.NORMAL,i())}),this.eventBus._on("annotationeditormodechanged",({mode:s})=>{e=s,s===Z.AnnotationEditorType.NONE?i():a()}),this.eventBus._on("presentationmodechanged",({state:s})=>{t=s,s===Nt.NORMAL?i():s===Nt.FULLSCREEN&&a()})};const hg="-",sk=null,Ty={"8.5x11":"Letter","8.5x14":"Legal"},mg={"297x420":"A3","210x297":"A4"};function Cd(n,e,t){const a=e?n.width:n.height,i=e?n.height:n.width;return t[`${a}x${i}`]}class Iy{constructor({dialog:e,fields:t,closeButton:a},i,s,o,l){F(this,ko);F(this,Si);F(this,So);F(this,br);F(this,Lo);F(this,wr);F(this,Tn,null);this.dialog=e,this.fields=t,this.overlayManager=i,this.l10n=o,this._fileNameLookup=l,H(this,ko,yu).call(this),a.addEventListener("click",this.close.bind(this)),this.overlayManager.register(this.dialog),s._on("pagechanging",r=>{this._currentPageNumber=r.pageNumber}),s._on("rotationchanging",r=>{this._pagesRotation=r.pagesRotation}),this._isNonMetricLocale=!0}open(){return oe(this,null,function*(){yield Promise.all([this.overlayManager.open(this.dialog),this._dataAvailableCapability.promise]);const e=this._currentPageNumber,t=this._pagesRotation;if(N(this,Tn)&&e===N(this,Tn)._currentPageNumber&&t===N(this,Tn)._pagesRotation){H(this,Si,nl).call(this);return}const{info:a,contentLength:i}=yield this.pdfDocument.getMetadata(),[s,o,l,r,c,u]=yield Promise.all([this._fileNameLookup(),H(this,So,_u).call(this,i),H(this,Lo,vu).call(this,a.CreationDate),H(this,Lo,vu).call(this,a.ModDate),this.pdfDocument.getPage(e).then(g=>H(this,br,Jm).call(this,fy(g),t)),H(this,wr,Qm).call(this,a.IsLinearized)]);pe(this,Tn,Object.freeze({fileName:s,fileSize:o,title:a.Title,author:a.Author,subject:a.Subject,keywords:a.Keywords,creationDate:l,modificationDate:r,creator:a.Creator,producer:a.Producer,version:a.PDFFormatVersion,pageCount:this.pdfDocument.numPages,pageSize:c,linearized:u,_currentPageNumber:e,_pagesRotation:t})),H(this,Si,nl).call(this);const{length:d}=yield this.pdfDocument.getDownloadInfo();if(i===d)return;const f=Object.assign(Object.create(null),N(this,Tn));f.fileSize=yield H(this,So,_u).call(this,d),pe(this,Tn,Object.freeze(f)),H(this,Si,nl).call(this)})}close(){return oe(this,null,function*(){this.overlayManager.close(this.dialog)})}setDocument(e){this.pdfDocument&&(H(this,ko,yu).call(this),H(this,Si,nl).call(this,!0)),e&&(this.pdfDocument=e,this._dataAvailableCapability.resolve())}}Tn=new WeakMap,ko=new WeakSet,yu=function(){this.pdfDocument=null,pe(this,Tn,null),this._dataAvailableCapability=(0,Z.createPromiseCapability)(),this._currentPageNumber=1,this._pagesRotation=0},Si=new WeakSet,nl=function(e=!1){if(e||!N(this,Tn)){for(const t in this.fields)this.fields[t].textContent=hg;return}if(this.overlayManager.active===this.dialog)for(const t in this.fields){const a=N(this,Tn)[t];this.fields[t].textContent=a||a===0?a:hg}},So=new WeakSet,_u=function(e=0){return oe(this,null,function*(){const t=e/1024,a=t/1024;if(t)return a>=1?`${a>=1&&(+a.toPrecision(3)).toLocaleString()} MB ${e.toLocaleString()} bytes`:`${a<1&&(+t.toPrecision(3)).toLocaleString()} KB (${e.toLocaleString()} bytes`})},br=new WeakSet,Jm=function(e,t){return oe(this,null,function*(){if(!e)return;t%180!==0&&(e={width:e.height,height:e.width});const a=Sd(e);let i={width:Math.round(e.width*100)/100,height:Math.round(e.height*100)/100},s={width:Math.round(e.width*25.4*10)/10,height:Math.round(e.height*25.4*10)/10},o=Cd(i,a,Ty)||Cd(s,a,mg);if(!o&&!(Number.isInteger(s.width)&&Number.isInteger(s.height))){const f={width:e.width*25.4,height:e.height*25.4},g={width:Math.round(s.width),height:Math.round(s.height)};Math.abs(f.width-g.width)<.1&&Math.abs(f.height-g.height)<.1&&(o=Cd(g,a,mg),o&&(i={width:Math.round(g.width/25.4*100)/100,height:Math.round(g.height/25.4*100)/100},s=g))}const[{width:l,height:r},c,u,d]=yield Promise.all([this._isNonMetricLocale?i:s,this._isNonMetricLocale?window.siyuan.languages.unitInches:window.siyuan.languages.unitMillimeters,o&&window.siyuan.languages[`document_properties_page_size_name_${o.toLowerCase()}`],window.siyuan.languages[`document_properties_page_size_orientation_${a?"portrait":"landscape"}`]]);return u?`${l.toLocaleString()} \xD7 ${r.toLocaleString()} ${c} (${u}, ${d})`:`${l.toLocaleString()} \xD7 ${r.toLocaleString()} ${c} (${d})`})},Lo=new WeakSet,vu=function(e){return oe(this,null,function*(){const t=Z.PDFDateString.toDateObject(e);if(t)return`${t.toLocaleDateString()}, ${t.toLocaleTimeString()}`})},wr=new WeakSet,Qm=function(e){return e?"Yes":"No"};const qn={SPACE:0,ALPHA_LETTER:1,PUNCT:2,HAN_LETTER:3,KATAKANA_LETTER:4,HIRAGANA_LETTER:5,HALFWIDTH_KATAKANA_LETTER:6,THAI_LETTER:7};function Dy(n){return n<11904}function $y(n){return(n&65408)===0}function Py(n){return n>=97&&n<=122||n>=65&&n<=90}function My(n){return n>=48&&n<=57}function Ny(n){return n===32||n===9||n===13||n===10}function Hy(n){return n>=13312&&n<=40959||n>=63744&&n<=64255}function By(n){return n>=12448&&n<=12543}function Oy(n){return n>=12352&&n<=12447}function Ry(n){return n>=65376&&n<=65439}function qy(n){return(n&65408)===3584}function Fl(n){return Dy(n)?$y(n)?Ny(n)?qn.SPACE:Py(n)||My(n)||n===95?qn.ALPHA_LETTER:qn.PUNCT:qy(n)?qn.THAI_LETTER:n===160?qn.SPACE:qn.ALPHA_LETTER:Hy(n)?qn.HAN_LETTER:By(n)?qn.KATAKANA_LETTER:Oy(n)?qn.HIRAGANA_LETTER:Ry(n)?qn.HALFWIDTH_KATAKANA_LETTER:qn.ALPHA_LETTER}const Sn={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3},Fy=250,Uy=-50,Vy=-400,bg={"\u2010":"-","\u2018":"'","\u2019":"'","\u201A":"'","\u201B":"'","\u201C":'"',"\u201D":'"',"\u201E":'"',"\u201F":'"',"\xBC":"1/4","\xBD":"1/2","\xBE":"3/4"},wg=new Set([12441,12442,2381,2509,2637,2765,2893,3021,3149,3277,3387,3388,3405,3530,3642,3770,3972,4153,4154,5908,5940,6098,6752,6980,7082,7083,7154,7155,11647,43014,43052,43204,43347,43456,43766,44013,3158,3953,3954,3962,3963,3964,3965,3968,3956]);let yg;const zy=new RegExp("\\p{M}+","gu"),Wy=new RegExp("([.*+?^${}()|[\\]\\\\])|(\\p{P})|(\\s+)|(\\p{M})|(\\p{L})","gu"),Yy=new RegExp("([^\\p{M}])\\p{M}*$","u"),Gy=new RegExp("^\\p{M}*([^\\p{M}])","u"),jy=/[\uAC00-\uD7AF\uFA6C\uFACF-\uFAD1\uFAD5-\uFAD7]+/g,_g=new Map,Ky="[\\u1100-\\u1112\\ud7a4-\\ud7af\\ud84a\\ud84c\\ud850\\ud854\\ud857\\ud85f]",vg=new Map;let xd=null,Ad=null;function Eg(n){const e=[];let t;for(;(t=jy.exec(n))!==null;){let{index:g}=t;for(const h of t[0]){let m=_g.get(h);m||(m=h.normalize("NFD").length,_g.set(h,m)),e.push([m,g++])}}let a;if(e.length===0&&xd)a=xd;else if(e.length>0&&Ad)a=Ad;else{const y=`([${Object.keys(bg).join("")}])|([\u2460-\u2473\u24B6-\u24FF\u3244-\u32BF\u32D0-\u32FE\uFF00-\uFFEF])|((?:\u3099|\u309A)\\n)|(\\p{M}+(?:-\\n)?)|(\\S-\\n)|((?:\\p{Ideographic}|[\u3040-\u30FF])\\n)|(\\n)`;e.length===0?a=xd=new RegExp(y+"|(\\u0000)","gum"):a=Ad=new RegExp(y+`|(${Ky})`,"gum")}const i=[];for(;(t=zy.exec(n))!==null;)i.push([t[0].length,t.index]);let s=n.normalize("NFD");const o=[[0,0]];let l=0,r=0,c=0,u=0,d=0,f=!1;return s=s.replace(a,(g,h,m,b,y,w,E,k,L,v)=>{var A,C,D;if(v-=u,h){const x=bg[h],P=x.length;for(let B=1;B<P;B++)o.push([v-c+B,c-B]);return c-=P-1,x}if(m){let x=vg.get(m);x||(x=m.normalize("NFKC"),vg.set(m,x));const P=x.length;for(let B=1;B<P;B++)o.push([v-c+B,c-B]);return c-=P-1,x}if(b)return f=!0,v+d===((A=i[l])==null?void 0:A[1])?++l:(o.push([v-1-c+1,c-1]),c-=1,u+=1),o.push([v-c+1,c]),u+=1,d+=1,b.charAt(0);if(y){const x=y.endsWith(`
`),P=x?y.length-2:y.length;f=!0;let B=P;v+d===((C=i[l])==null?void 0:C[1])&&(B-=i[l][0],++l);for(let V=1;V<=B;V++)o.push([v-1-c+V,c-V]);return c-=B,u+=B,x?(v+=P-1,o.push([v-c+1,1+c]),c+=1,u+=1,d+=1,y.slice(0,P)):y}if(w){const x=w.length-2;return o.push([v-c+x,1+c]),c+=1,u+=1,d+=1,w.slice(0,-2)}if(E){const x=E.length-1;return o.push([v-c+x,c]),u+=1,d+=1,E.slice(0,-1)}if(k)return o.push([v-c+1,c-1]),c-=1,u+=1,d+=1," ";if(v+d===((D=e[r])==null?void 0:D[1])){const x=e[r][0]-1;++r;for(let P=1;P<=x;P++)o.push([v-(c-P),c-P]);c-=x,u+=x}return L}),o.push([s.length,c]),[s,o,f]}function Zy(n,e,t){if(!n)return[e,t];const a=e,i=e+t;let s=so(n,l=>l[0]>=a);n[s][0]>a&&--s;let o=so(n,l=>l[0]>=i,s);return n[o][0]>i&&--o,[a+n[s][1],t+n[o][1]-n[s][1]]}class Xy{constructor({linkService:e,eventBus:t,updateMatchesCountOnProgress:a=!0}){F(this,yr);F(this,Co);F(this,xo);F(this,_r);F(this,vr);F(this,Er);F(this,Ao);F(this,kr);F(this,Sr);F(this,ys);F(this,Ci);F(this,Fa);F(this,Lr);F(this,To);F(this,Io);F(this,_s);F(this,Cr);F(this,Do);F(this,$o);F(this,xi);F(this,ws,!0);F(this,Li,0);this._linkService=e,this._eventBus=t,pe(this,ws,a),H(this,Co,Eu).call(this),t._on("find",H(this,yr,eb).bind(this)),t._on("findbarclose",H(this,Cr,lb).bind(this))}get highlightMatches(){return this._highlightMatches}get pageMatches(){return this._pageMatches}get pageMatchesLength(){return this._pageMatchesLength}get selected(){return this._selected}get state(){return this._state}setDocument(e){this._pdfDocument&&H(this,Co,Eu).call(this),e&&(this._pdfDocument=e,this._firstPageCapability.resolve())}scrollMatchIntoView({element:e=null,selectedLeft:t=0,pageIndex:a=-1,matchIndex:i=-1}){if(!this._scrollMatches||!e)return;if(i===-1||i!==this._selected.matchIdx)return;if(a===-1||a!==this._selected.pageIdx)return;this._scrollMatches=!1;const s={top:Uy,left:t+Vy};kd(e,s,!0)}}ws=new WeakMap,Li=new WeakMap,yr=new WeakSet,eb=function(e){if(!e)return;const t=this._pdfDocument,{type:a}=e;(this._state===null||H(this,_r,tb).call(this,e))&&(this._dirtyMatch=!0),this._state=e,a!=="highlightallchange"&&H(this,xi,il).call(this,Sn.PENDING),this._firstPageCapability.promise.then(()=>{if(!this._pdfDocument||t&&this._pdfDocument!==t)return;H(this,Sr,sb).call(this);const i=!this._highlightMatches,s=!!this._findTimeout;this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),a?this._dirtyMatch?H(this,Fa,Ms).call(this):a==="again"?(H(this,Fa,Ms).call(this),i&&this._state.highlightAll&&H(this,Ci,al).call(this)):a==="highlightallchange"?(s?H(this,Fa,Ms).call(this):this._highlightMatches=!0,H(this,Ci,al).call(this)):H(this,Fa,Ms).call(this):this._findTimeout=setTimeout(()=>{H(this,Fa,Ms).call(this),this._findTimeout=null},Fy)})},Co=new WeakSet,Eu=function(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],pe(this,Li,0),this._state=null,this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._hasDiacritics=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=new Set,this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=(0,Z.createPromiseCapability)()},xo=new WeakSet,ku=function(){return this._state.query!==this._rawQuery&&(this._rawQuery=this._state.query,[this._normalizedQuery]=Eg(this._state.query)),this._normalizedQuery},_r=new WeakSet,tb=function(e){if(e.query!==this._state.query)return!0;switch(e.type){case"again":const t=this._selected.pageIdx+1,a=this._linkService;return t>=1&&t<=a.pagesCount&&t!==a.page&&!a.isPageVisible(t);case"highlightallchange":return!1}return!0},vr=new WeakSet,nb=function(e,t,a){let i=e.slice(0,t).match(Yy);if(i){const s=e.charCodeAt(t),o=i[1].charCodeAt(0);if(Fl(s)===Fl(o))return!1}if(i=e.slice(t+a).match(Gy),i){const s=e.charCodeAt(t+a-1),o=i[1].charCodeAt(0);if(Fl(s)===Fl(o))return!1}return!0},Er=new WeakSet,ab=function(e,t,a,i){const s=this._pageMatches[a]=[],o=this._pageMatchesLength[a]=[];if(!e)return;const l=this._pageDiffs[a];let r;for(;(r=e.exec(i))!==null;){if(t&&!H(this,vr,nb).call(this,i,r.index,r[0].length))continue;const[c,u]=Zy(l,r.index,r[0].length);u&&(s.push(c),o.push(u))}},Ao=new WeakSet,Su=function(e,t){const{matchDiacritics:a}=this._state;let i=!1;e=e.replaceAll(Wy,(o,l,r,c,u,d)=>l?`[ ]*\\${l}[ ]*`:r?`[ ]*${r}[ ]*`:c?"[ ]+":a?u||d:u?wg.has(u.charCodeAt(0))?u:"":t?(i=!0,`${d}\\p{M}*`):d);const s="[ ]*";return e.endsWith(s)&&(e=e.slice(0,e.length-s.length)),a&&t&&(yg||(yg=String.fromCharCode(...wg)),i=!0,e=`${e}(?=[${yg}]|[^\\p{M}]|$)`),[i,e]},kr=new WeakSet,ib=function(e){let t=N(this,xo,ku);if(!t)return;const{caseSensitive:a,entireWord:i,phraseSearch:s}=this._state,o=this._pageContents[e],l=this._hasDiacritics[e];let r=!1;if(s)[r,t]=H(this,Ao,Su).call(this,t,l);else{const d=t.match(/\S+/g);d&&(t=d.sort().reverse().map(f=>{const[g,h]=H(this,Ao,Su).call(this,f,l);return r||(r=g),`(${h})`}).join("|"))}const c=`g${r?"u":""}${a?"":"i"}`;t=t?new RegExp(t,c):null,H(this,Er,ab).call(this,t,i,e,o),this._state.highlightAll&&H(this,ys,rc).call(this,e),this._resumePageIdx===e&&(this._resumePageIdx=null,H(this,To,Lu).call(this));const u=this._pageMatches[e].length;this._matchesCountTotal+=u,N(this,ws)?u>0&&H(this,$o,Au).call(this):++Um(this,Li)._===this._linkService.pagesCount&&H(this,$o,Au).call(this)},Sr=new WeakSet,sb=function(){if(this._extractTextPromises.length>0)return;let e=Promise.resolve();for(let t=0,a=this._linkService.pagesCount;t<a;t++){const i=(0,Z.createPromiseCapability)();this._extractTextPromises[t]=i.promise,e=e.then(()=>this._pdfDocument.getPage(t+1).then(s=>s.getTextContent()).then(s=>{const o=[];for(const l of s.items)o.push(l.str),l.hasEOL&&o.push(`
`);[this._pageContents[t],this._pageDiffs[t],this._hasDiacritics[t]]=Eg(o.join("")),i.resolve()},s=>{console.error(`Unable to get text content for page ${t+1}`,s),this._pageContents[t]="",this._pageDiffs[t]=null,this._hasDiacritics[t]=!1,i.resolve()}))}},ys=new WeakSet,rc=function(e){this._scrollMatches&&this._selected.pageIdx===e&&(this._linkService.page=e+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:e})},Ci=new WeakSet,al=function(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})},Fa=new WeakSet,Ms=function(){const e=this._state.findPrevious,t=this._linkService.page-1,a=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=t,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,pe(this,Li,0),this._matchesCountTotal=0,H(this,Ci,al).call(this);for(let s=0;s<a;s++)this._pendingFindMatches.has(s)||(this._pendingFindMatches.add(s),this._extractTextPromises[s].then(()=>{this._pendingFindMatches.delete(s),H(this,kr,ib).call(this,s)}))}if(!N(this,xo,ku)){H(this,xi,il).call(this,Sn.FOUND);return}if(this._resumePageIdx)return;const i=this._offset;if(this._pagesToSearch=a,i.matchIdx!==null){const s=this._pageMatches[i.pageIdx].length;if(!e&&i.matchIdx+1<s||e&&i.matchIdx>0){i.matchIdx=e?i.matchIdx-1:i.matchIdx+1,H(this,_s,cc).call(this,!0);return}H(this,Io,Cu).call(this,e)}H(this,To,Lu).call(this)},Lr=new WeakSet,ob=function(e){const t=this._offset,a=e.length,i=this._state.findPrevious;return a?(t.matchIdx=i?a-1:0,H(this,_s,cc).call(this,!0),!0):(H(this,Io,Cu).call(this,i),t.wrapped&&(t.matchIdx=null,this._pagesToSearch<0)?(H(this,_s,cc).call(this,!1),!0):!1)},To=new WeakSet,Lu=function(){this._resumePageIdx!==null&&console.error("There can only be one pending page.");let e=null;do{const t=this._offset.pageIdx;if(e=this._pageMatches[t],!e){this._resumePageIdx=t;break}}while(!H(this,Lr,ob).call(this,e))},Io=new WeakSet,Cu=function(e){const t=this._offset,a=this._linkService.pagesCount;t.pageIdx=e?t.pageIdx-1:t.pageIdx+1,t.matchIdx=null,this._pagesToSearch--,(t.pageIdx>=a||t.pageIdx<0)&&(t.pageIdx=e?a-1:0,t.wrapped=!0)},_s=new WeakSet,cc=function(e=!1){let t=Sn.NOT_FOUND;const a=this._offset.wrapped;if(this._offset.wrapped=!1,e){const i=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,t=a?Sn.WRAPPED:Sn.FOUND,i!==-1&&i!==this._selected.pageIdx&&H(this,ys,rc).call(this,i)}H(this,xi,il).call(this,t,this._state.findPrevious),this._selected.pageIdx!==-1&&(this._scrollMatches=!0,H(this,ys,rc).call(this,this._selected.pageIdx))},Cr=new WeakSet,lb=function(e){const t=this._pdfDocument;this._firstPageCapability.promise.then(()=>{!this._pdfDocument||t&&this._pdfDocument!==t||(this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),this._resumePageIdx&&(this._resumePageIdx=null,this._dirtyMatch=!0),H(this,xi,il).call(this,Sn.FOUND),this._highlightMatches=!1,H(this,Ci,al).call(this))})},Do=new WeakSet,xu=function(){var s;const{pageIdx:e,matchIdx:t}=this._selected;let a=0,i=this._matchesCountTotal;if(t!==-1){for(let o=0;o<e;o++)a+=((s=this._pageMatches[o])==null?void 0:s.length)||0;a+=t+1}return(a<1||a>i)&&(a=i=0),{current:a,total:i}},$o=new WeakSet,Au=function(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:H(this,Do,xu).call(this)})},xi=new WeakSet,il=function(e,t=!1){var a,i;!N(this,ws)&&(N(this,Li)!==this._linkService.pagesCount||e===Sn.PENDING)||this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:e,previous:t,matchesCount:H(this,Do,xu).call(this),rawQuery:(i=(a=this._state)==null?void 0:a.query)!=null?i:null})};const Jy=1e3;class Qy{constructor(e,t,a){F(this,Ai);this.opened=!1,this.bar=e.bar,this.toggleButton=e.toggleButton,this.findField=e.findField,this.highlightAll=e.highlightAllCheckbox,this.caseSensitive=e.caseSensitiveCheckbox,this.matchDiacritics=e.matchDiacriticsCheckbox,this.entireWord=e.entireWordCheckbox,this.findMsg=e.findMsg,this.findResultsCount=e.findResultsCount,this.findPreviousButton=e.findPreviousButton,this.findNextButton=e.findNextButton,this.eventBus=t,this.l10n=a,this.toggleButton.addEventListener("click",()=>{this.toggle()}),this.findField.addEventListener("input",()=>{this.dispatchEvent("")}),this.bar.addEventListener("keydown",i=>{switch(i.keyCode){case 13:i.target===this.findField&&this.dispatchEvent("again",i.shiftKey);break;case 27:this.close();break}}),this.findPreviousButton.addEventListener("click",()=>{this.dispatchEvent("again",!0)}),this.findNextButton.addEventListener("click",()=>{this.dispatchEvent("again",!1)}),this.highlightAll.addEventListener("click",()=>{this.dispatchEvent("highlightallchange"),this.highlightAll.checked?this.highlightAll.parentElement.classList.remove("b3-button--outline"):this.highlightAll.parentElement.classList.add("b3-button--outline")}),this.caseSensitive.addEventListener("click",()=>{this.dispatchEvent("casesensitivitychange"),this.caseSensitive.checked?this.caseSensitive.parentElement.classList.remove("b3-button--outline"):this.caseSensitive.parentElement.classList.add("b3-button--outline")}),this.entireWord.addEventListener("click",()=>{this.dispatchEvent("entirewordchange"),this.entireWord.checked?this.entireWord.parentElement.classList.remove("b3-button--outline"):this.entireWord.parentElement.classList.add("b3-button--outline")}),this.matchDiacritics.addEventListener("click",()=>{this.dispatchEvent("diacriticmatchingchange"),this.matchDiacritics.checked?this.matchDiacritics.parentElement.classList.remove("b3-button--outline"):this.matchDiacritics.parentElement.classList.add("b3-button--outline")}),this.eventBus._on("resize",H(this,Ai,sl).bind(this))}reset(){this.updateUIState()}dispatchEvent(e,t=!1){this.eventBus.dispatch("find",{source:this,type:e,query:this.findField.value,phraseSearch:!0,caseSensitive:this.caseSensitive.checked,entireWord:this.entireWord.checked,highlightAll:this.highlightAll.checked,findPrevious:t,matchDiacritics:this.matchDiacritics.checked})}updateUIState(e,t,a){let i="",s="";switch(e){case Sn.FOUND:break;case Sn.PENDING:s="pending";break;case Sn.NOT_FOUND:i=window.siyuan.languages.find_not_found,s="notFound";break;case Sn.WRAPPED:i=window.siyuan.languages.find_not_found[`find_reached_${t?"top":"bottom"}`];break}this.findField.setAttribute("data-status",s),this.findField.setAttribute("aria-invalid",e===Sn.NOT_FOUND),this.findMsg.textContent=i,H(this,Ai,sl).call(this),this.updateResultsCount(a)}updateResultsCount({current:e=0,total:t=0}={}){const a=Jy;let i="";t>0&&(t>a?i=window.siyuan.languages.find_match_count_limit.replace("{{limit}}",a):i=window.siyuan.languages.find_match_count.replace("{{current}}",e).replace("{{total}}",t)),this.findResultsCount.textContent=i,H(this,Ai,sl).call(this)}open(){this.opened||(this.opened=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.bar.classList.remove("fn__hidden")),this.findField.select(),this.findField.focus(),H(this,Ai,sl).call(this)}close(){this.opened&&(this.opened=!1,this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"),this.bar.classList.add("fn__hidden"),this.eventBus.dispatch("findbarclose",{source:this}))}toggle(){this.opened?this.close():this.open()}}Ai=new WeakSet,sl=function(){if(!this.opened)return;this.bar.classList.remove("wrapContainers");const e=this.bar.clientHeight,t=this.bar.firstElementChild.clientHeight;e>t&&this.bar.classList.add("wrapContainers")};const e_=1e3,Td=50,kg=1e3;function Id(){return document.location.hash}class t_{constructor({linkService:e,eventBus:t}){this.linkService=e,this.eventBus=t,this._initialized=!1,this._fingerprint="",this.reset(),this._boundEvents=null,this.eventBus._on("pagesinit",()=>{this._isPagesLoaded=!1,this.eventBus._on("pagesloaded",a=>{this._isPagesLoaded=!!a.pagesCount},{once:!0})})}initialize({fingerprint:e,resetHistory:t=!1,updateUrl:a=!1}){if(!e||typeof e!="string"){console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.');return}this._initialized&&this.reset();const i=this._fingerprint!==""&&this._fingerprint!==e;this._fingerprint=e,this._updateUrl=a===!0,this._initialized=!0,this._bindEvents();const s=window.history.state;if(this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=Id(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!this._isValidState(s,!0)||t){const{hash:l,page:r,rotation:c}=this._parseCurrentHash(!0);if(!l||i||t){this._pushOrReplaceState(null,!0);return}this._pushOrReplaceState({hash:l,page:r,rotation:c},!0);return}const o=s.destination;this._updateInternalState(o,s.uid,!0),o.rotation!==void 0&&(this._initialRotation=o.rotation),o.dest?(this._initialBookmark=JSON.stringify(o.dest),this._destination.page=null):o.hash?this._initialBookmark=o.hash:o.page&&(this._initialBookmark=`page=${o.page}`)}reset(){this._initialized&&(this._pageHide(),this._initialized=!1,this._unbindEvents()),this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._initialBookmark=null,this._initialRotation=null}push({namedDest:e=null,explicitDest:t,pageNumber:a}){if(!this._initialized)return;if(e&&typeof e!="string"){console.error(`PDFHistory.push: "${e}" is not a valid namedDest parameter.`);return}else if(Array.isArray(t)){if(!this._isValidPage(a)&&(a!==null||this._destination)){console.error(`PDFHistory.push: "${a}" is not a valid pageNumber parameter.`);return}}else{console.error(`PDFHistory.push: "${t}" is not a valid explicitDest parameter.`);return}const i=e||JSON.stringify(t);if(!i)return;let s=!1;if(this._destination&&(n_(this._destination.hash,i)||a_(this._destination.dest,t))){if(this._destination.page)return;s=!0}this._popStateInProgress&&!s||(this._pushOrReplaceState({dest:t,hash:i,page:a,rotation:this.linkService.rotation},s),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1})))}pushPage(e){var t;if(this._initialized){if(!this._isValidPage(e)){console.error(`PDFHistory.pushPage: "${e}" is not a valid page number.`);return}((t=this._destination)==null?void 0:t.page)!==e&&(this._popStateInProgress||(this._pushOrReplaceState({dest:null,hash:`page=${e}`,page:e,rotation:this.linkService.rotation}),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1}))))}}pushCurrentPosition(){!this._initialized||this._popStateInProgress||this._tryPushCurrentPosition()}back(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;this._isValidState(e)&&e.uid>0&&window.history.back()}forward(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;this._isValidState(e)&&e.uid<this._maxUid&&window.history.forward()}get popStateInProgress(){return this._initialized&&(this._popStateInProgress||this._blockHashChange>0)}get initialBookmark(){return this._initialized?this._initialBookmark:null}get initialRotation(){return this._initialized?this._initialRotation:null}_pushOrReplaceState(e,t=!1){var o;const a=t||!this._destination,i={fingerprint:this._fingerprint,uid:a?this._uid:this._uid+1,destination:e};typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&((o=window.history.state)!=null&&o.chromecomState)&&(i.chromecomState=window.history.state.chromecomState),this._updateInternalState(e,i.uid);let s;if(this._updateUrl&&(e!=null&&e.hash)){const l=document.location.href.split("#")[0];l.startsWith("file://")||(s=`${l}#${e.hash}`)}a?window.history.replaceState(i,"",s):window.history.pushState(i,"",s),typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&top===window&&chrome.runtime.sendMessage("showPageAction")}_tryPushCurrentPosition(e=!1){if(!this._position)return;let t=this._position;if(e&&(t=Object.assign(Object.create(null),this._position),t.temporary=!0),!this._destination){this._pushOrReplaceState(t);return}if(this._destination.temporary){this._pushOrReplaceState(t,!0);return}if(this._destination.hash===t.hash||!this._destination.page&&(Td<=0||this._numPositionUpdates<=Td))return;let a=!1;if(this._destination.page>=t.first&&this._destination.page<=t.page){if(this._destination.dest!==void 0||!this._destination.first)return;a=!0}this._pushOrReplaceState(t,a)}_isValidPage(e){return Number.isInteger(e)&&e>0&&e<=this.linkService.pagesCount}_isValidState(e,t=!1){if(!e)return!1;if(e.fingerprint!==this._fingerprint)if(t){if(typeof e.fingerprint!="string"||e.fingerprint.length!==this._fingerprint.length)return!1;const[a]=performance.getEntriesByType("navigation");if((a==null?void 0:a.type)!=="reload")return!1}else return!1;return!(!Number.isInteger(e.uid)||e.uid<0||e.destination===null||typeof e.destination!="object")}_updateInternalState(e,t,a=!1){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),a&&(e!=null&&e.temporary)&&delete e.temporary,this._destination=e,this._uid=t,this._maxUid=Math.max(this._maxUid,t),this._numPositionUpdates=0}_parseCurrentHash(e=!1){const t=unescape(Id()).substring(1),a=Nl(t),i=a.get("nameddest")||"";let s=a.get("page")|0;return(!this._isValidPage(s)||e&&i.length>0)&&(s=null),{hash:t,page:s,rotation:this.linkService.rotation}}_updateViewarea({location:e}){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:e.pdfOpenParams.substring(1),page:this.linkService.page,first:e.pageNumber,rotation:e.rotation},!this._popStateInProgress&&(Td>0&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,kg>0&&(this._updateViewareaTimeout=setTimeout(()=>{this._popStateInProgress||this._tryPushCurrentPosition(!0),this._updateViewareaTimeout=null},kg)))}_popState({state:e}){const t=Id(),a=this._currentHash!==t;if(this._currentHash=t,typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&(e!=null&&e.chromecomState)&&!this._isValidState(e)||!e){this._uid++;const{hash:s,page:o,rotation:l}=this._parseCurrentHash();this._pushOrReplaceState({hash:s,page:o,rotation:l},!0);return}if(!this._isValidState(e))return;this._popStateInProgress=!0,a&&(this._blockHashChange++,fg({target:window,name:"hashchange",delay:e_}).then(()=>{this._blockHashChange--}));const i=e.destination;this._updateInternalState(i,e.uid,!0),Bl(i.rotation)&&(this.linkService.rotation=i.rotation),i.dest?this.linkService.goToDestination(i.dest):i.hash?this.linkService.setHash(i.hash):i.page&&(this.linkService.page=i.page),Promise.resolve().then(()=>{this._popStateInProgress=!1})}_pageHide(){(!this._destination||this._destination.temporary)&&this._tryPushCurrentPosition()}_bindEvents(){this._boundEvents||(this._boundEvents={updateViewarea:this._updateViewarea.bind(this),popState:this._popState.bind(this),pageHide:this._pageHide.bind(this)},this.eventBus._on("updateviewarea",this._boundEvents.updateViewarea),window.addEventListener("popstate",this._boundEvents.popState),window.addEventListener("pagehide",this._boundEvents.pageHide))}_unbindEvents(){this._boundEvents&&(this.eventBus._off("updateviewarea",this._boundEvents.updateViewarea),window.removeEventListener("popstate",this._boundEvents.popState),window.removeEventListener("pagehide",this._boundEvents.pageHide),this._boundEvents=null)}}function n_(n,e){return typeof n!="string"||typeof e!="string"?!1:n===e||Nl(n).get("nameddest")===e}function a_(n,e){function t(a,i){if(typeof a!=typeof i||Array.isArray(a)||Array.isArray(i))return!1;if(a!==null&&typeof a=="object"&&i!==null){if(Object.keys(a).length!==Object.keys(i).length)return!1;for(const s in a)if(!t(a[s],i[s]))return!1;return!0}return a===i||Number.isNaN(a)&&Number.isNaN(i)}if(!(Array.isArray(n)&&Array.isArray(e))||n.length!==e.length)return!1;for(let a=0,i=n.length;a<i;a++)if(!t(n[a],e[a]))return!1;return!0}class i_ extends oo{constructor(t){super(t);F(this,Po);this.l10n=t.l10n,this.eventBus._on("optionalcontentconfigchanged",a=>{H(this,Po,Tu).call(this,a.promise)}),this.eventBus._on("resetlayers",()=>{H(this,Po,Tu).call(this)}),this.eventBus._on("togglelayerstree",this._toggleAllTreeItems.bind(this))}reset(){super.reset(),this._optionalContentConfig=null,this._optionalContentHash=null}_dispatchEvent(t){this.eventBus.dispatch("layersloaded",{source:this,layersCount:t})}_bindLink(t,{groupId:a,input:i}){const s=()=>{this._optionalContentConfig.setVisibility(a,i.checked),this._optionalContentHash=this._optionalContentConfig.getHash(),this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(this._optionalContentConfig)})};t.onclick=o=>o.target===i?(s(),!0):o.target!==t?!0:(i.checked=!i.checked,s(),!1)}_setNestedName(i,s){return oe(this,arguments,function*(t,{name:a=null}){if(typeof a=="string"){t.textContent=this._normalizeTextContent(a);return}t.textContent=window.siyuan.languages.additionalLayers,t.style.fontStyle="italic"})}_addToggleButton(t,{name:a=null}){super._addToggleButton(t,a===null)}_toggleAllTreeItems(){this._optionalContentConfig&&super._toggleAllTreeItems()}render({optionalContentConfig:t,pdfDocument:a}){this._optionalContentConfig&&this.reset(),this._optionalContentConfig=t||null,this._pdfDocument=a||null;const i=t==null?void 0:t.getOrder();if(!i){this._dispatchEvent(0);return}this._optionalContentHash=t.getHash();const s=document.createDocumentFragment(),o=[{parent:s,groups:i}];let l=0,r=!1;for(;o.length>0;){const c=o.shift();for(const u of c.groups){const d=document.createElement("div");d.className="treeItem";const f=document.createElement("a");if(d.append(f),typeof u=="object"){r=!0,this._addToggleButton(d,u),this._setNestedName(f,u);const g=document.createElement("div");g.className="treeItems",d.append(g),o.push({parent:g,groups:u.order})}else{const g=t.getGroup(u),h=document.createElement("input");this._bindLink(f,{groupId:u,input:h}),h.type="checkbox",h.checked=g.visible;const m=document.createElement("label");m.textContent=this._normalizeTextContent(g.name),m.append(h),f.append(m),l++}c.parent.append(d)}}this._finishRendering(s,l,r)}}Po=new WeakSet,Tu=function(t=null){return oe(this,null,function*(){if(!this._optionalContentConfig)return;const a=this._pdfDocument,i=yield t||a.getOptionalContentConfig();if(a===this._pdfDocument){if(t){if(i.getHash()===this._optionalContentHash)return}else this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(i)});this.render({optionalContentConfig:i,pdfDocument:this._pdfDocument})}})};class s_ extends oo{constructor(e){super(e),this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.eventBus._on("toggleoutlinetree",this._toggleAllTreeItems.bind(this)),this.eventBus._on("currentoutlineitem",this._currentOutlineItem.bind(this)),this.eventBus._on("pagechanging",t=>{this._currentPageNumber=t.pageNumber}),this.eventBus._on("pagesloaded",t=>{this._isPagesLoaded=!!t.pagesCount,this._currentOutlineItemCapability&&!this._currentOutlineItemCapability.settled&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded)}),this.eventBus._on("sidebarviewchanged",t=>{this._sidebarView=t.view})}reset(){super.reset(),this._outline=null,this._pageNumberToDestHashCapability=null,this._currentPageNumber=1,this._isPagesLoaded=null,this._currentOutlineItemCapability&&!this._currentOutlineItemCapability.settled&&this._currentOutlineItemCapability.resolve(!1),this._currentOutlineItemCapability=null}_dispatchEvent(e){var t;this._currentOutlineItemCapability=(0,Z.createPromiseCapability)(),e===0||(t=this._pdfDocument)!=null&&t.loadingParams.disableAutoFetch?this._currentOutlineItemCapability.resolve(!1):this._isPagesLoaded!==null&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded),this.eventBus.dispatch("outlineloaded",{source:this,outlineCount:e,currentOutlineItemPromise:this._currentOutlineItemCapability.promise})}_bindLink(e,{url:t,newWindow:a,action:i,attachment:s,dest:o,setOCGState:l}){const{linkService:r}=this;if(t){r.addLinkAttributes(e,t,a);return}if(i){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeNamedAction(i),!1);return}if(s){e.href=r.getAnchorUrl(""),e.onclick=()=>(this.downloadManager.openOrDownloadData(e,s.content,s.filename),!1);return}if(l){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeSetOCGState(l),!1);return}e.href=r.getDestinationHash(o),e.onclick=c=>(this._updateCurrentTreeItem(c.target.parentNode),o&&r.goToDestination(o),!1)}_setStyles(e,{bold:t,italic:a}){t&&(e.style.fontWeight="bold"),a&&(e.style.fontStyle="italic")}_addToggleButton(e,{count:t,items:a}){let i=!1;if(t<0){let s=a.length;if(s>0){const o=[...a];for(;o.length>0;){const{count:l,items:r}=o.shift();l>0&&r.length>0&&(s+=r.length,o.push(...r))}}Math.abs(t)===s&&(i=!0)}super._addToggleButton(e,i)}_toggleAllTreeItems(){this._outline&&super._toggleAllTreeItems()}render({outline:e,pdfDocument:t}){if(this._outline&&this.reset(),this._outline=e||null,this._pdfDocument=t||null,!e){this._dispatchEvent(0);return}const a=document.createDocumentFragment(),i=[{parent:a,items:e}];let s=0,o=!1;for(;i.length>0;){const l=i.shift();for(const r of l.items){const c=document.createElement("div");c.className="treeItem";const u=document.createElement("a");if(this._bindLink(u,r),this._setStyles(u,r),u.textContent=this._normalizeTextContent(r.title),c.append(u),r.items.length>0){o=!0,this._addToggleButton(c,r);const d=document.createElement("div");d.className="treeItems",c.append(d),i.push({parent:d,items:r.items})}l.parent.append(c),s++}}this._finishRendering(a,s,o)}_currentOutlineItem(){return oe(this,null,function*(){if(!this._isPagesLoaded)throw new Error("_currentOutlineItem: All pages have not been loaded.");if(!this._outline||!this._pdfDocument)return;const e=yield this._getPageNumberToDestHash(this._pdfDocument);if(e&&(this._updateCurrentTreeItem(null),this._sidebarView===Fe.OUTLINE))for(let t=this._currentPageNumber;t>0;t--){const a=e.get(t);if(!a)continue;const i=this.container.querySelector(`a[href="${a}"]`);if(i){this._scrollToCurrentTreeItem(i.parentNode);break}}})}_getPageNumberToDestHash(e){return oe(this,null,function*(){if(this._pageNumberToDestHashCapability)return this._pageNumberToDestHashCapability.promise;this._pageNumberToDestHashCapability=(0,Z.createPromiseCapability)();const t=new Map,a=new Map,i=[{nesting:0,items:this._outline}];for(;i.length>0;){const s=i.shift(),o=s.nesting;for(const{dest:l,items:r}of s.items){let c,u;if(typeof l=="string"){if(c=yield e.getDestination(l),e!==this._pdfDocument)return null}else c=l;if(Array.isArray(c)){const[d]=c;if(typeof d=="object"&&d!==null){if(u=this.linkService._cachedPageNumber(d),!u)try{if(u=(yield e.getPageIndex(d))+1,e!==this._pdfDocument)return null;this.linkService.cachePageRef(u,d)}catch(f){}}else Number.isInteger(d)&&(u=d+1);if(Number.isInteger(u)&&(!t.has(u)||o>a.get(u))){const f=this.linkService.getDestinationHash(l);t.set(u,f),a.set(u,o)}}r.length>0&&i.push({nesting:o+1,items:r})}}return this._pageNumberToDestHashCapability.resolve(t.size>0?t:null),this._pageNumberToDestHashCapability.promise})}}const o_=3e3,Sg="pdfPresentationMode",Dd="pdfPresentationModeControls",l_=50,r_=.1,Lg=50,$d=Math.PI/6;class c_{constructor({container:e,pdfViewer:t,eventBus:a}){F(this,xr);F(this,Ti);F(this,Ar);F(this,Tr);F(this,Ir);F(this,Dr);F(this,Mo);F(this,$r);F(this,Ii);F(this,Pr);F(this,Mr);F(this,Nr);F(this,Hr);F(this,Br);F(this,No);F(this,vs,Nt.UNKNOWN);F(this,jt,null);this.container=e,this.pdfViewer=t,this.eventBus=a,this.contextMenuOpen=!1,this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0,this.touchSwipeState=null}request(){return oe(this,null,function*(){const{container:e,pdfViewer:t}=this;if(this.active||!t.pagesCount||!e.requestFullscreen)return!1;H(this,Br,wb).call(this),H(this,Ti,ol).call(this,Nt.CHANGING);const a=e.requestFullscreen();pe(this,jt,{pageNumber:t.currentPageNumber,scaleValue:t.currentScaleValue,scrollMode:t.scrollMode,spreadMode:null,annotationEditorMode:null}),t.spreadMode!==ft.NONE&&!(t.pageViewsReady&&t.hasEqualPageSizes)&&(console.warn("Ignoring Spread modes when entering PresentationMode, since the document may contain varying page sizes."),N(this,jt).spreadMode=t.spreadMode),t.annotationEditorMode!==Z.AnnotationEditorType.DISABLE&&(N(this,jt).annotationEditorMode=t.annotationEditorMode);try{return yield a,t.focus(),!0}catch(i){H(this,No,Du).call(this),H(this,Ti,ol).call(this,Nt.NORMAL)}return!1})}get active(){return N(this,vs)===Nt.CHANGING||N(this,vs)===Nt.FULLSCREEN}}vs=new WeakMap,jt=new WeakMap,xr=new WeakSet,rb=function(e){if(!this.active)return;e.preventDefault();const t=hy(e),a=Date.now(),i=this.mouseScrollTimeStamp;if(!(a>i&&a-i<l_)&&((this.mouseScrollDelta>0&&t<0||this.mouseScrollDelta<0&&t>0)&&H(this,Ii,ll).call(this),this.mouseScrollDelta+=t,Math.abs(this.mouseScrollDelta)>=r_)){const s=this.mouseScrollDelta;H(this,Ii,ll).call(this),(s>0?this.pdfViewer.previousPage():this.pdfViewer.nextPage())&&(this.mouseScrollTimeStamp=a)}},Ti=new WeakSet,ol=function(e){pe(this,vs,e),this.eventBus.dispatch("presentationmodechanged",{source:this,state:e})},Ar=new WeakSet,cb=function(){H(this,Ti,ol).call(this,Nt.FULLSCREEN),this.container.classList.add(Sg),setTimeout(()=>{this.pdfViewer.scrollMode=He.PAGE,N(this,jt).spreadMode!==null&&(this.pdfViewer.spreadMode=ft.NONE),this.pdfViewer.currentPageNumber=N(this,jt).pageNumber,this.pdfViewer.currentScaleValue="page-fit",N(this,jt).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode=Z.AnnotationEditorType.NONE)},0),H(this,Mr,hb).call(this),H(this,Mo,Iu).call(this),this.contextMenuOpen=!1,window.getSelection().removeAllRanges()},Tr=new WeakSet,db=function(){const e=this.pdfViewer.currentPageNumber;this.container.classList.remove(Sg),setTimeout(()=>{H(this,No,Du).call(this),H(this,Ti,ol).call(this,Nt.NORMAL),this.pdfViewer.scrollMode=N(this,jt).scrollMode,N(this,jt).spreadMode!==null&&(this.pdfViewer.spreadMode=N(this,jt).spreadMode),this.pdfViewer.currentScaleValue=N(this,jt).scaleValue,this.pdfViewer.currentPageNumber=e,N(this,jt).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode=N(this,jt).annotationEditorMode),pe(this,jt,null)},0),H(this,Nr,mb).call(this),H(this,$r,pb).call(this),H(this,Ii,ll).call(this),this.contextMenuOpen=!1},Ir=new WeakSet,ub=function(e){var t;if(this.contextMenuOpen){this.contextMenuOpen=!1,e.preventDefault();return}e.button===0&&(e.target.href&&((t=e.target.parentNode)!=null&&t.hasAttribute("data-internal-link"))||(e.preventDefault(),e.shiftKey?this.pdfViewer.previousPage():this.pdfViewer.nextPage()))},Dr=new WeakSet,fb=function(){this.contextMenuOpen=!0},Mo=new WeakSet,Iu=function(){this.controlsTimeout?clearTimeout(this.controlsTimeout):this.container.classList.add(Dd),this.controlsTimeout=setTimeout(()=>{this.container.classList.remove(Dd),delete this.controlsTimeout},o_)},$r=new WeakSet,pb=function(){this.controlsTimeout&&(clearTimeout(this.controlsTimeout),this.container.classList.remove(Dd),delete this.controlsTimeout)},Ii=new WeakSet,ll=function(){this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0},Pr=new WeakSet,gb=function(e){if(this.active){if(e.touches.length>1){this.touchSwipeState=null;return}switch(e.type){case"touchstart":this.touchSwipeState={startX:e.touches[0].pageX,startY:e.touches[0].pageY,endX:e.touches[0].pageX,endY:e.touches[0].pageY};break;case"touchmove":if(this.touchSwipeState===null)return;this.touchSwipeState.endX=e.touches[0].pageX,this.touchSwipeState.endY=e.touches[0].pageY,e.preventDefault();break;case"touchend":if(this.touchSwipeState===null)return;let t=0;const a=this.touchSwipeState.endX-this.touchSwipeState.startX,i=this.touchSwipeState.endY-this.touchSwipeState.startY,s=Math.abs(Math.atan2(i,a));Math.abs(a)>Lg&&(s<=$d||s>=Math.PI-$d)?t=a:Math.abs(i)>Lg&&Math.abs(s-Math.PI/2)<=$d&&(t=i),t>0?this.pdfViewer.previousPage():t<0&&this.pdfViewer.nextPage();break}}},Mr=new WeakSet,hb=function(){this.showControlsBind=H(this,Mo,Iu).bind(this),this.mouseDownBind=H(this,Ir,ub).bind(this),this.mouseWheelBind=H(this,xr,rb).bind(this),this.resetMouseScrollStateBind=H(this,Ii,ll).bind(this),this.contextMenuBind=H(this,Dr,fb).bind(this),this.touchSwipeBind=H(this,Pr,gb).bind(this),window.addEventListener("mousemove",this.showControlsBind),window.addEventListener("mousedown",this.mouseDownBind),window.addEventListener("wheel",this.mouseWheelBind,{passive:!1}),window.addEventListener("keydown",this.resetMouseScrollStateBind),window.addEventListener("contextmenu",this.contextMenuBind),window.addEventListener("touchstart",this.touchSwipeBind),window.addEventListener("touchmove",this.touchSwipeBind),window.addEventListener("touchend",this.touchSwipeBind)},Nr=new WeakSet,mb=function(){window.removeEventListener("mousemove",this.showControlsBind),window.removeEventListener("mousedown",this.mouseDownBind),window.removeEventListener("wheel",this.mouseWheelBind,{passive:!1}),window.removeEventListener("keydown",this.resetMouseScrollStateBind),window.removeEventListener("contextmenu",this.contextMenuBind),window.removeEventListener("touchstart",this.touchSwipeBind),window.removeEventListener("touchmove",this.touchSwipeBind),window.removeEventListener("touchend",this.touchSwipeBind),delete this.showControlsBind,delete this.mouseDownBind,delete this.mouseWheelBind,delete this.resetMouseScrollStateBind,delete this.contextMenuBind,delete this.touchSwipeBind},Hr=new WeakSet,bb=function(){document.fullscreenElement?H(this,Ar,cb).call(this):H(this,Tr,db).call(this)},Br=new WeakSet,wb=function(){this.fullscreenChangeBind=H(this,Hr,bb).bind(this),window.addEventListener("fullscreenchange",this.fullscreenChangeBind)},No=new WeakSet,Du=function(){window.removeEventListener("fullscreenchange",this.fullscreenChangeBind),delete this.fullscreenChangeBind};const d_=3e4;class Cg{constructor(){this.pdfViewer=null,this.pdfThumbnailViewer=null,this.onIdle=null,this.highestPriorityPage=null,this.idleTimeout=null,this.printing=!1,this.isThumbnailViewEnabled=!1}setViewer(e){this.pdfViewer=e}setThumbnailViewer(e){this.pdfThumbnailViewer=e}isHighestPriority(e){return this.highestPriorityPage===e.renderingId}hasViewer(){return!!this.pdfViewer}renderHighestPriority(e){var t;this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null),!this.pdfViewer.forceRendering(e)&&(this.isThumbnailViewEnabled&&((t=this.pdfThumbnailViewer)!=null&&t.forceRendering())||this.printing||this.onIdle&&(this.idleTimeout=setTimeout(this.onIdle.bind(this),d_)))}getHighestPriority(e,t,a,i=!1){const s=e.views,o=s.length;if(o===0)return null;for(let d=0;d<o;d++){const f=s[d].view;if(!this.isViewFinished(f))return f}const l=e.first.id,r=e.last.id;if(r-l+1>o){const d=e.ids;for(let f=1,g=r-l;f<g;f++){const h=a?l+f:r-f;if(d.has(h))continue;const m=t[h-1];if(!this.isViewFinished(m))return m}}let c=a?r:l-2,u=t[c];return u&&!this.isViewFinished(u)||i&&(c+=a?1:-1,u=t[c],u&&!this.isViewFinished(u))?u:null}isViewFinished(e){return e.renderingState===je.FINISHED}renderView(e){switch(e.renderingState){case je.FINISHED:return!1;case je.PAUSED:this.highestPriorityPage=e.renderingId,e.resume();break;case je.RUNNING:this.highestPriorityPage=e.renderingId;break;case je.INITIAL:this.highestPriorityPage=e.renderingId,e.draw().finally(()=>{this.renderHighestPriority()}).catch(t=>{t instanceof Z.RenderingCancelledException||console.error(`renderView: "${t}"`)});break}return!0}}class u_{constructor({eventBus:e,sandboxBundleSrc:t=null,scriptingFactory:a=null,docPropertiesLookup:i=null}){this._pdfDocument=null,this._pdfViewer=null,this._closeCapability=null,this._destroyCapability=null,this._scripting=null,this._ready=!1,this._eventBus=e,this._sandboxBundleSrc=t,this._scriptingFactory=a,this._docPropertiesLookup=i,typeof PDFJSDev!="undefined"&&PDFJSDev.test("COMPONENTS")&&!this._scriptingFactory&&window.addEventListener("updatefromsandbox",s=>{this._eventBus.dispatch("updatefromsandbox",{source:window,detail:s.detail})})}setViewer(e){this._pdfViewer=e}setDocument(e){return oe(this,null,function*(){var s;if(this._pdfDocument&&(yield this._destroyScripting()),this._pdfDocument=e,!e)return;const[t,a,i]=yield Promise.all([e.getFieldObjects(),e.getCalculationOrderIds(),e.getJSActions()]);if(!t&&!i){yield this._destroyScripting();return}if(e===this._pdfDocument){try{this._scripting=this._createScripting()}catch(o){console.error(`PDFScriptingManager.setDocument: "${o==null?void 0:o.message}".`),yield this._destroyScripting();return}this._internalEvents.set("updatefromsandbox",o=>{(o==null?void 0:o.source)===window&&this._updateFromSandbox(o.detail)}),this._internalEvents.set("dispatcheventinsandbox",o=>{var l;(l=this._scripting)==null||l.dispatchEventInSandbox(o.detail)}),this._internalEvents.set("pagechanging",({pageNumber:o,previous:l})=>{o!==l&&(this._dispatchPageClose(l),this._dispatchPageOpen(o))}),this._internalEvents.set("pagerendered",({pageNumber:o})=>{this._pageOpenPending.has(o)&&o===this._pdfViewer.currentPageNumber&&this._dispatchPageOpen(o)}),this._internalEvents.set("pagesdestroy",o=>oe(this,null,function*(){var l,r;yield this._dispatchPageClose(this._pdfViewer.currentPageNumber),yield(l=this._scripting)==null?void 0:l.dispatchEventInSandbox({id:"doc",name:"WillClose"}),(r=this._closeCapability)==null||r.resolve()}));for(const[o,l]of this._internalEvents)this._eventBus._on(o,l);try{const o=yield this._getDocProperties();if(e!==this._pdfDocument)return;yield this._scripting.createSandbox({objects:t,calculationOrder:a,appInfo:{platform:navigator.platform,language:navigator.language},docInfo:lc(na({},o),{actions:i})}),this._eventBus.dispatch("sandboxcreated",{source:this})}catch(o){console.error(`PDFScriptingManager.setDocument: "${o==null?void 0:o.message}".`),yield this._destroyScripting();return}yield(s=this._scripting)==null?void 0:s.dispatchEventInSandbox({id:"doc",name:"Open"}),yield this._dispatchPageOpen(this._pdfViewer.currentPageNumber,!0),Promise.resolve().then(()=>{e===this._pdfDocument&&(this._ready=!0)})}})}dispatchWillSave(e){return oe(this,null,function*(){var t;return(t=this._scripting)==null?void 0:t.dispatchEventInSandbox({id:"doc",name:"WillSave"})})}dispatchDidSave(e){return oe(this,null,function*(){var t;return(t=this._scripting)==null?void 0:t.dispatchEventInSandbox({id:"doc",name:"DidSave"})})}dispatchWillPrint(e){return oe(this,null,function*(){var t;return(t=this._scripting)==null?void 0:t.dispatchEventInSandbox({id:"doc",name:"WillPrint"})})}dispatchDidPrint(e){return oe(this,null,function*(){var t;return(t=this._scripting)==null?void 0:t.dispatchEventInSandbox({id:"doc",name:"DidPrint"})})}get destroyPromise(){var e;return((e=this._destroyCapability)==null?void 0:e.promise)||null}get ready(){return this._ready}get _internalEvents(){return(0,Z.shadow)(this,"_internalEvents",new Map)}get _pageOpenPending(){return(0,Z.shadow)(this,"_pageOpenPending",new Set)}get _visitedPages(){return(0,Z.shadow)(this,"_visitedPages",new Map)}_updateFromSandbox(e){return oe(this,null,function*(){var r;const t=this._pdfViewer.isInPresentationMode||this._pdfViewer.isChangingPresentationMode,{id:a,siblings:i,command:s,value:o}=e;if(!a){switch(s){case"clear":console.clear();break;case"error":console.error(o);break;case"layout":{if((typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))||t)return;const c=rg(o);this._pdfViewer.spreadMode=c.spreadMode;break}case"page-num":this._pdfViewer.currentPageNumber=o+1;break;case"print":yield this._pdfViewer.pagesPromise,this._eventBus.dispatch("print",{source:this});break;case"println":console.log(o);break;case"zoom":if(t)return;this._pdfViewer.currentScaleValue=o;break;case"SaveAs":this._eventBus.dispatch("download",{source:this});break;case"FirstPage":this._pdfViewer.currentPageNumber=1;break;case"LastPage":this._pdfViewer.currentPageNumber=this._pdfViewer.pagesCount;break;case"NextPage":this._pdfViewer.nextPage();break;case"PrevPage":this._pdfViewer.previousPage();break;case"ZoomViewIn":if(t)return;this._pdfViewer.increaseScale();break;case"ZoomViewOut":if(t)return;this._pdfViewer.decreaseScale();break}return}if(t&&e.focus)return;delete e.id,delete e.siblings;const l=i?[a,...i]:[a];for(const c of l){const u=document.querySelector(`[data-element-id="${c}"]`);u?u.dispatchEvent(new CustomEvent("updatefromsandbox",{detail:e})):(r=this._pdfDocument)==null||r.annotationStorage.setValue(c,e)}})}_dispatchPageOpen(e,t=!1){return oe(this,null,function*(){const a=this._pdfDocument,i=this._visitedPages;if(t&&(this._closeCapability=(0,Z.createPromiseCapability)()),!this._closeCapability)return;const s=this._pdfViewer.getPageView(e-1);if((s==null?void 0:s.renderingState)!==je.FINISHED){this._pageOpenPending.add(e);return}this._pageOpenPending.delete(e);const o=(()=>oe(this,null,function*(){var r,c;const l=yield i.has(e)?null:(r=s.pdfPage)==null?void 0:r.getJSActions();a===this._pdfDocument&&(yield(c=this._scripting)==null?void 0:c.dispatchEventInSandbox({id:"page",name:"PageOpen",pageNumber:e,actions:l}))}))();i.set(e,o)})}_dispatchPageClose(e){return oe(this,null,function*(){var s;const t=this._pdfDocument,a=this._visitedPages;if(!this._closeCapability||this._pageOpenPending.has(e))return;const i=a.get(e);i&&(a.set(e,null),yield i,t===this._pdfDocument&&(yield(s=this._scripting)==null?void 0:s.dispatchEventInSandbox({id:"page",name:"PageClose",pageNumber:e})))})}_getDocProperties(){return oe(this,null,function*(){if(this._docPropertiesLookup)return this._docPropertiesLookup(this._pdfDocument);if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("COMPONENTS")){const{docPropertiesLookup:e}=Ae(916);return e(this._pdfDocument)}throw new Error("_getDocProperties: Unable to lookup properties.")})}_createScripting(){if(this._destroyCapability=(0,Z.createPromiseCapability)(),this._scripting)throw new Error("_createScripting: Scripting already exists.");if(this._scriptingFactory)return this._scriptingFactory.createScripting({sandboxBundleSrc:this._sandboxBundleSrc});if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("COMPONENTS")){const{GenericScripting:e}=Ae(916);return new e(this._sandboxBundleSrc)}throw new Error("_createScripting: Cannot create scripting.")}_destroyScripting(){return oe(this,null,function*(){var e,t;if(!this._scripting){this._pdfDocument=null,(e=this._destroyCapability)==null||e.resolve();return}this._closeCapability&&(yield Promise.race([this._closeCapability.promise,new Promise(a=>{setTimeout(a,1e3)})]).catch(a=>{}),this._closeCapability=null),this._pdfDocument=null;try{yield this._scripting.destroySandbox()}catch(a){}for(const[a,i]of this._internalEvents)this._eventBus._off(a,i);this._internalEvents.clear(),this._pageOpenPending.clear(),this._visitedPages.clear(),this._scripting=null,this._ready=!1,(t=this._destroyCapability)==null||t.resolve()})}}const xg="pdfSidebarNotification";class f_{constructor({elements:e,pdfViewer:t,pdfThumbnailViewer:a,eventBus:i,l10n:s}){F(this,Ua);F(this,Es);F(this,ks);F(this,Or);F(this,Ho);F(this,Rr);this.isOpen=!1,this.active=Fe.THUMBS,this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,this.onToggled=null,this.pdfViewer=t,this.pdfThumbnailViewer=a,this.outerContainer=e.outerContainer,this.sidebarContainer=e.sidebarContainer,this.toggleButton=e.toggleButton,this.thumbnailButton=e.thumbnailButton,this.outlineButton=e.outlineButton,this.attachmentsButton=e.attachmentsButton,this.layersButton=e.layersButton,this.thumbnailView=e.thumbnailView,this.outlineView=e.outlineView,this.attachmentsView=e.attachmentsView,this.layersView=e.layersView,this._outlineOptionsContainer=e.outlineOptionsContainer,this._currentOutlineItemButton=e.currentOutlineItemButton,this.eventBus=i,this.l10n=s,H(this,Rr,_b).call(this)}reset(){this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,H(this,Ho,$u).call(this,!0),this.switchView(Fe.THUMBS),this.outlineButton.disabled=!1,this.attachmentsButton.disabled=!1,this.layersButton.disabled=!1,this._currentOutlineItemButton.disabled=!0}get visibleView(){return this.isOpen?this.active:Fe.NONE}setInitialView(e=Fe.NONE){if(!this.isInitialViewSet){if(this.isInitialViewSet=!0,e===Fe.NONE||e===Fe.UNKNOWN){H(this,Ua,Ns).call(this);return}this.switchView(e,!0),this.isInitialEventDispatched||H(this,Ua,Ns).call(this)}}switchView(e,t=!1){const a=e!==this.active;let i=!1;switch(e){case Fe.NONE:this.isOpen&&this.close();return;case Fe.THUMBS:this.isOpen&&a&&(i=!0);break;case Fe.OUTLINE:if(this.outlineButton.disabled)return;break;case Fe.ATTACHMENTS:if(this.attachmentsButton.disabled)return;break;case Fe.LAYERS:if(this.layersButton.disabled)return;break;default:console.error(`PDFSidebar.switchView: "${e}" is not a valid view.`);return}this.active=e;const s=e===Fe.THUMBS,o=e===Fe.OUTLINE,l=e===Fe.ATTACHMENTS,r=e===Fe.LAYERS;if(this.thumbnailButton.classList.toggle("toggled",s),this.outlineButton.classList.toggle("toggled",o),this.attachmentsButton.classList.toggle("toggled",l),this.layersButton.classList.toggle("toggled",r),this.thumbnailButton.setAttribute("aria-checked",s),this.outlineButton.setAttribute("aria-checked",o),this.attachmentsButton.setAttribute("aria-checked",l),this.layersButton.setAttribute("aria-checked",r),this.thumbnailView.classList.toggle("fn__hidden",!s),this.outlineView.classList.toggle("fn__hidden",!o),this.attachmentsView.classList.toggle("fn__hidden",!l),this.layersView.classList.toggle("fn__hidden",!r),this._outlineOptionsContainer.classList.toggle("fn__hidden",!o),t&&!this.isOpen){this.open();return}i&&(H(this,ks,uc).call(this),H(this,Es,dc).call(this)),a&&H(this,Ua,Ns).call(this)}open(){this.isOpen||(this.isOpen=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.outerContainer.classList.add("sidebarMoving","sidebarOpen"),this.active===Fe.THUMBS&&H(this,ks,uc).call(this),H(this,Es,dc).call(this),H(this,Ua,Ns).call(this),H(this,Ho,$u).call(this))}close(){this.isOpen&&(this.isOpen=!1,this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"),this.outerContainer.classList.add("sidebarMoving"),this.outerContainer.classList.remove("sidebarOpen"),H(this,Es,dc).call(this),H(this,Ua,Ns).call(this))}toggle(){this.isOpen?this.close():this.open()}}Ua=new WeakSet,Ns=function(){this.isInitialViewSet&&!this.isInitialEventDispatched&&(this.isInitialEventDispatched=!0),this.eventBus.dispatch("sidebarviewchanged",{source:this,view:this.visibleView})},Es=new WeakSet,dc=function(){this.onToggled?this.onToggled():(this.pdfViewer.forceRendering(),this.pdfThumbnailViewer.forceRendering())},ks=new WeakSet,uc=function(){const{pdfViewer:e,pdfThumbnailViewer:t}=this,a=e.pagesCount;for(let i=0;i<a;i++){const s=e.getPageView(i);(s==null?void 0:s.renderingState)===je.FINISHED&&t.getThumbnail(i).setImage(s)}t.scrollThumbnailIntoView(e.currentPageNumber)},Or=new WeakSet,yb=function(){this.toggleButton.title=window.siyuan.languages.toggleSidebarNotification2Title,this.isOpen||this.toggleButton.classList.add(xg)},Ho=new WeakSet,$u=function(e=!1){(this.isOpen||e)&&this.toggleButton.classList.remove(xg),e&&(this.toggleButton.title=window.siyuan.languages.toggleSidebarTitle)},Rr=new WeakSet,_b=function(){this.sidebarContainer.addEventListener("transitionend",t=>{t.target===this.sidebarContainer&&this.outerContainer.classList.remove("sidebarMoving")}),this.toggleButton.addEventListener("click",()=>{this.toggle()}),this.thumbnailButton.addEventListener("click",()=>{this.switchView(Fe.THUMBS)}),this.outlineButton.addEventListener("click",()=>{this.switchView(Fe.OUTLINE)}),this.outlineButton.addEventListener("dblclick",()=>{this.eventBus.dispatch("toggleoutlinetree",{source:this})}),this.attachmentsButton.addEventListener("click",()=>{this.switchView(Fe.ATTACHMENTS)}),this.layersButton.addEventListener("click",()=>{this.switchView(Fe.LAYERS)}),this.layersButton.addEventListener("dblclick",()=>{this.eventBus.dispatch("resetlayers",{source:this})}),this._currentOutlineItemButton.addEventListener("click",()=>{this.eventBus.dispatch("currentoutlineitem",{source:this})});const e=(t,a,i)=>{a.disabled=!t,t?H(this,Or,yb).call(this):this.active===i&&this.switchView(Fe.THUMBS)};this.eventBus._on("outlineloaded",t=>{e(t.outlineCount,this.outlineButton,Fe.OUTLINE),t.currentOutlineItemPromise.then(a=>{this.isInitialViewSet&&(this._currentOutlineItemButton.disabled=!a)})}),this.eventBus._on("attachmentsloaded",t=>{e(t.attachmentsCount,this.attachmentsButton,Fe.ATTACHMENTS)}),this.eventBus._on("layersloaded",t=>{e(t.layersCount,this.layersButton,Fe.LAYERS)}),this.eventBus._on("presentationmodechanged",t=>{t.state===Nt.NORMAL&&this.visibleView===Fe.THUMBS&&H(this,ks,uc).call(this)})};const p_="--b3-pdf-sidebar-width",Ag=200,Ul="sidebarResizing";class g_{constructor(e,t,a){this.isRTL=!1,this.sidebarOpen=!1,this._width=null,this._outerContainerWidth=null,this._boundEvents=Object.create(null),this.outerContainer=e.outerContainer,this.resizer=e.resizer,this.eventBus=t,this.isRTL=!1,this._addEventListeners()}get outerContainerWidth(){return this.outerContainer.clientWidth}_updateWidth(e=0){const t=Math.floor(this.outerContainerWidth/2);return e>t&&(e=t),e<Ag&&(e=Ag),e===this._width?!1:(this._width=e,Ld.setProperty(p_,`${e}px`),!0)}_mouseMove(e){let t=e.clientX-this.outerContainer.getBoundingClientRect().left;this.isRTL&&(t=this.outerContainerWidth-t),this._updateWidth(t)}_mouseUp(e){this.outerContainer.classList.remove(Ul),this.eventBus.dispatch("resize",{source:this});const t=this._boundEvents;window.removeEventListener("mousemove",t.mouseMove),window.removeEventListener("mouseup",t.mouseUp)}_addEventListeners(){const e=this._boundEvents;e.mouseMove=this._mouseMove.bind(this),e.mouseUp=this._mouseUp.bind(this),this.resizer.addEventListener("mousedown",t=>{t.button===0&&(this.outerContainer.classList.add(Ul),window.addEventListener("mousemove",e.mouseMove),window.addEventListener("mouseup",e.mouseUp))}),this.eventBus._on("sidebarviewchanged",t=>{this.sidebarOpen=!!(t!=null&&t.view)}),this.eventBus._on("resize",t=>{if((t==null?void 0:t.source)!==window||(this._outerContainerWidth=null,!this._width))return;if(!this.sidebarOpen){this._updateWidth(this._width);return}this.outerContainer.classList.add(Ul);const a=this._updateWidth(this._width);Promise.resolve().then(()=>{this.outerContainer.classList.remove(Ul),a&&this.eventBus.dispatch("resize",{source:this})})})}}const Tg=2,Ig=3,Dg=1,h_=98;class Pd{static getCanvas(e,t){const a=N(this,Ss)||pe(this,Ss,document.createElement("canvas"));a.width=e,a.height=t;const i=a.getContext("2d",{alpha:!1});return i.save(),i.fillStyle="rgb(255, 255, 255)",i.fillRect(0,0,e,t),i.restore(),[a,a.getContext("2d")]}static destroyCanvas(){const e=N(this,Ss);e&&(e.width=0,e.height=0),pe(this,Ss,null)}}Ss=new WeakMap,F(Pd,Ss,null);class m_{constructor({container:e,id:t,defaultViewport:a,optionalContentConfigPromise:i,linkService:s,renderingQueue:o,l10n:l,pageColors:r}){this.id=t,this.renderingId="thumbnail"+t,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=a,this.pdfPageRotate=a.rotation,this._optionalContentConfigPromise=i||null,this.pageColors=r||null,this.linkService=s,this.renderingQueue=o,this.renderTask=null,this.renderingState=je.INITIAL,this.resume=null;const c=this.viewport.width,u=this.viewport.height,d=c/u;this.canvasWidth=h_,this.canvasHeight=this.canvasWidth/d|0,this.scale=this.canvasWidth/c,this.l10n=l;const f=document.createElement("a");f.href=s.getAnchorUrl("#page="+t),f.title=this._thumbPageTitle,f.onclick=function(){return s.goToPage(t),!1},this.anchor=f;const g=document.createElement("div");g.className="thumbnail",g.setAttribute("data-page-number",this.id),this.div=g;const h=document.createElement("div");h.className="thumbnailSelectionRing";const m=2*Dg;h.style.width=this.canvasWidth+m+"px",h.style.height=this.canvasHeight+m+"px",this.ring=h,g.append(h),f.append(g),e.append(f)}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const t=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:1,rotation:t}),this.reset()}reset(){this.cancelRendering(),this.renderingState=je.INITIAL;const e=this.viewport.width,t=this.viewport.height,a=e/t;this.canvasHeight=this.canvasWidth/a|0,this.scale=this.canvasWidth/e,this.div.removeAttribute("data-loaded");const i=this.ring;i.textContent="";const s=2*Dg;i.style.width=this.canvasWidth+s+"px",i.style.height=this.canvasHeight+s+"px",this.canvas&&(this.canvas.width=0,this.canvas.height=0,delete this.canvas),this.image&&(this.image.removeAttribute("src"),delete this.image)}update({rotation:e=null}){typeof e=="number"&&(this.rotation=e);const t=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:t}),this.reset()}cancelRendering(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.resume=null}_getPageDrawContext(e=1){const t=document.createElement("canvas"),a=t.getContext("2d",{alpha:!1}),i=new Qp;t.width=e*this.canvasWidth*i.sx|0,t.height=e*this.canvasHeight*i.sy|0;const s=i.scaled?[i.sx,0,0,i.sy,0,0]:null;return{ctx:a,canvas:t,transform:s}}_convertCanvasToImage(e){if(this.renderingState!==je.FINISHED)throw new Error("_convertCanvasToImage: Rendering has not finished.");const t=this._reduceImage(e),a=document.createElement("img");a.className="thumbnailImage",a.setAttribute("aria-label",this._thumbPageCanvas),a.style.width=this.canvasWidth+"px",a.style.height=this.canvasHeight+"px",a.src=t.toDataURL(),this.image=a,this.div.setAttribute("data-loaded",!0),this.ring.append(a),t.width=0,t.height=0}draw(){if(this.renderingState!==je.INITIAL)return console.error("Must be in new state before drawing"),Promise.resolve();const{pdfPage:e}=this;if(!e)return this.renderingState=je.FINISHED,Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=je.RUNNING;const t=(d=null)=>oe(this,null,function*(){if(c===this.renderTask&&(this.renderTask=null),!(d instanceof Z.RenderingCancelledException)&&(this.renderingState=je.FINISHED,this._convertCanvasToImage(i),d))throw d}),{ctx:a,canvas:i,transform:s}=this._getPageDrawContext(Tg),o=this.viewport.clone({scale:Tg*this.scale}),l=d=>{if(!this.renderingQueue.isHighestPriority(this)){this.renderingState=je.PAUSED,this.resume=()=>{this.renderingState=je.RUNNING,d()};return}d()},r={canvasContext:a,transform:s,viewport:o,optionalContentConfigPromise:this._optionalContentConfigPromise,pageColors:this.pageColors},c=this.renderTask=e.render(r);c.onContinue=l;const u=c.promise.then(function(){return t(null)},function(d){return t(d)});return u.finally(()=>{var f;i.width=0,i.height=0,this.linkService.isPageCached(this.id)||(f=this.pdfPage)==null||f.cleanup()}),u}setImage(e){if(this.renderingState!==je.INITIAL)return;const{thumbnailCanvas:t,pdfPage:a,scale:i}=e;t&&(this.pdfPage||this.setPdfPage(a),!(i<this.scale)&&(this.renderingState=je.FINISHED,this._convertCanvasToImage(t)))}_reduceImage(e){const{ctx:t,canvas:a}=this._getPageDrawContext();if(e.width<=2*a.width)return t.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),a;let i=a.width<<Ig,s=a.height<<Ig;const[o,l]=Pd.getCanvas(i,s);for(;i>e.width||s>e.height;)i>>=1,s>>=1;for(l.drawImage(e,0,0,e.width,e.height,0,0,i,s);i>2*a.width;)l.drawImage(o,0,0,i,s,0,0,i>>1,s>>1),i>>=1,s>>=1;return t.drawImage(o,0,0,i,s,0,0,a.width,a.height),a}get _thumbPageTitle(){var e;return window.siyuan.languages.thumbPageTitle.replace("{{page}}",(e=this.pageLabel)!=null?e:this.id)}get _thumbPageCanvas(){var e;return window.siyuan.languages.thumbPage.replace("{{page}}",(e=this.pageLabel)!=null?e:this.id)}setPageLabel(e){var t;this.pageLabel=typeof e=="string"?e:null,this.anchor.title=this._thumbPageTitle,this.renderingState===je.FINISHED&&((t=this.image)==null||t.setAttribute("aria-label",this._thumbPageCanvas))}}const b_=-19,Md="selected";class w_{constructor({container:e,linkService:t,renderingQueue:a,l10n:i,pageColors:s}){F(this,qr);F(this,Fr);this.container=e,this.linkService=t,this.renderingQueue=a,this.l10n=i,this.pageColors=s||null,(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&this.pageColors&&!(CSS.supports("color",this.pageColors.background)&&CSS.supports("color",this.pageColors.foreground))&&((this.pageColors.background||this.pageColors.foreground)&&console.warn("PDFThumbnailViewer: Ignoring `pageColors`-option, since the browser doesn't support the values used."),this.pageColors=null),this.scroll=eg(this.container,this._scrollUpdated.bind(this)),this._resetView()}_scrollUpdated(){this.renderingQueue.renderHighestPriority()}getThumbnail(e){return this._thumbnails[e]}_getVisibleThumbs(){return ag({scrollEl:this.container,views:this._thumbnails})}scrollThumbnailIntoView(e){if(!this.pdfDocument)return;const t=this._thumbnails[e-1];if(!t){console.error('scrollThumbnailIntoView: Invalid "pageNumber" parameter.');return}e!==this._currentPageNumber&&(this._thumbnails[this._currentPageNumber-1].div.classList.remove(Md),t.div.classList.add(Md));const{first:a,last:i,views:s}=this._getVisibleThumbs();if(s.length>0){let o=!1;if(e<=a.id||e>=i.id)o=!0;else for(const{id:l,percent:r}of s)if(l===e){o=r<100;break}o&&kd(t.div,{top:b_})}this._currentPageNumber=e}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!Bl(e))throw new Error("Invalid thumbnails rotation angle.");if(!this.pdfDocument||this._pagesRotation===e)return;this._pagesRotation=e;const t={rotation:e};for(const a of this._thumbnails)a.update(t)}cleanup(){for(const e of this._thumbnails)e.renderingState!==je.FINISHED&&e.reset();Pd.destroyCanvas()}_resetView(){this._thumbnails=[],this._currentPageNumber=1,this._pageLabels=null,this._pagesRotation=0,this.container.textContent=""}setDocument(e){if(this.pdfDocument&&(this._cancelRendering(),this._resetView()),this.pdfDocument=e,!e)return;const t=e.getPage(1),a=e.getOptionalContentConfig();t.then(i=>{var r;const s=e.numPages,o=i.getViewport({scale:1});for(let c=1;c<=s;++c){const u=new m_({container:this.container,id:c,defaultViewport:o.clone(),optionalContentConfigPromise:a,linkService:this.linkService,renderingQueue:this.renderingQueue,l10n:this.l10n,pageColors:this.pageColors});this._thumbnails.push(u)}(r=this._thumbnails[0])==null||r.setPdfPage(i),this._thumbnails[this._currentPageNumber-1].div.classList.add(Md)}).catch(i=>{console.error("Unable to initialize thumbnail viewer",i)})}_cancelRendering(){for(const e of this._thumbnails)e.cancelRendering()}setPageLabels(e){var t,a;if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("PDFThumbnailViewer_setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let i=0,s=this._thumbnails.length;i<s;i++)this._thumbnails[i].setPageLabel((a=(t=this._pageLabels)==null?void 0:t[i])!=null?a:null)}}forceRendering(){const e=this._getVisibleThumbs(),t=H(this,Fr,Eb).call(this,e),a=this.renderingQueue.getHighestPriority(e,this._thumbnails,t);return a?(H(this,qr,vb).call(this,a).then(()=>{this.renderingQueue.renderView(a)}),!0):!1}}qr=new WeakSet,vb=function(e){return oe(this,null,function*(){if(e.pdfPage)return e.pdfPage;try{const t=yield this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(t),t}catch(t){return console.error("Unable to get page for thumb view",t),null}})},Fr=new WeakSet,Eb=function(e){var t,a;return((t=e.first)==null?void 0:t.id)===1?!0:((a=e.last)==null?void 0:a.id)===this._thumbnails.length?!1:this.scroll.down};const $g={of_pages:"of {{pagesCount}}",page_of_pages:"({{pageNumber}} of {{pagesCount}})",document_properties_kb:"{{size_kb}} KB ({{size_b}} bytes)",document_properties_mb:"{{size_mb}} MB ({{size_b}} bytes)",document_properties_date_string:"{{date}}, {{time}}",document_properties_page_size_unit_inches:"in",document_properties_page_size_unit_millimeters:"mm",document_properties_page_size_orientation_portrait:"portrait",document_properties_page_size_orientation_landscape:"landscape",document_properties_page_size_name_a3:"A3",document_properties_page_size_name_a4:"A4",document_properties_page_size_name_letter:"Letter",document_properties_page_size_name_legal:"Legal",document_properties_page_size_dimension_string:"{{width}} \xD7 {{height}} {{unit}} ({{orientation}})",document_properties_page_size_dimension_name_string:"{{width}} \xD7 {{height}} {{unit}} ({{name}}, {{orientation}})",document_properties_linearized_yes:"Yes",document_properties_linearized_no:"No",additional_layers:"Additional Layers",page_landmark:"Page {{page}}",thumb_page_title:"Page {{page}}",thumb_page_canvas:"Thumbnail of Page {{page}}",find_reached_top:"Reached top of document, continued from bottom",find_reached_bottom:"Reached end of document, continued from top","find_match_count[one]":"{{current}} of {{total}} match","find_match_count[other]":"{{current}} of {{total}} matches","find_match_count_limit[one]":"More than {{limit}} match","find_match_count_limit[other]":"More than {{limit}} matches",find_not_found:"Phrase not found",page_scale_width:"Page Width",page_scale_fit:"Page Fit",page_scale_auto:"Automatic Zoom",page_scale_actual:"Actual Size",page_scale_percent:"{{scale}}%",loading_error:"An error occurred while loading the PDF.",invalid_file_error:"Invalid or corrupted PDF file.",missing_file_error:"Missing PDF file.",unexpected_response_error:"Unexpected server response.",rendering_error:"An error occurred while rendering the page.",printing_not_supported:"Warning: Printing is not fully supported by this browser.",printing_not_ready:"Warning: The PDF is not fully loaded for printing.",web_fonts_disabled:"Web fonts are disabled: unable to use embedded PDF fonts.",free_text2_default_content:"Start typing\u2026",editor_free_text2_aria_label:"Text Editor",editor_ink2_aria_label:"Draw Editor",editor_ink_canvas_aria_label:"User-created image"};(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&($g.print_progress_percent="{{progress}}%");function y_(n,e){switch(n){case"find_match_count":n=`find_match_count[${e.total===1?"one":"other"}]`;break;case"find_match_count_limit":n=`find_match_count_limit[${e.limit===1?"one":"other"}]`;break}return $g[n]||""}const __={en:"en-US",es:"es-ES",fy:"fy-NL",ga:"ga-IE",gu:"gu-IN",hi:"hi-IN",hy:"hy-AM",nb:"nb-NO",ne:"ne-NP",nn:"nn-NO",pa:"pa-IN",pt:"pt-PT",sv:"sv-SE",zh:"zh-CN"};function ok(n){return __[n==null?void 0:n.toLowerCase()]||n}function v_(n,e){return e?n.replaceAll(/\{\{\s*(\w+)\s*\}\}/g,(t,a)=>a in e?e[a]:"{{"+a+"}}"):n}const Vl={getLanguage(){return oe(this,null,function*(){return"en-us"})},getDirection(){return oe(this,null,function*(){return"ltr"})},get(a){return oe(this,arguments,function*(n,e=null,t=y_(n,e)){return v_(t,e)})},translate(n){return oe(this,null,function*(){})}};class E_{constructor(e){F(this,Bo,void 0);this.pageDiv=e.pageDiv,this.pdfPage=e.pdfPage,this.accessibilityManager=e.accessibilityManager,this.l10n=e.l10n||Vl,this.annotationEditorLayer=null,this.div=null,this._cancelled=!1,pe(this,Bo,e.uiManager)}render(e,t="display"){return oe(this,null,function*(){if(t!=="display"||this._cancelled)return;const a=e.clone({dontFlip:!0});if(this.div){this.annotationEditorLayer.update({viewport:a}),this.show();return}const i=this.div=document.createElement("div");i.className="annotationEditorLayer",i.tabIndex=0,i.hidden=!0,this.pageDiv.append(i),this.annotationEditorLayer=new Z.AnnotationEditorLayer({uiManager:N(this,Bo),div:i,accessibilityManager:this.accessibilityManager,pageIndex:this.pdfPage.pageNumber-1,l10n:this.l10n,viewport:a});const s={viewport:a,div:i,annotations:null,intent:t};this.annotationEditorLayer.render(s),this.show()})}cancel(){this._cancelled=!0,this.div&&(this.pageDiv=null,this.annotationEditorLayer.destroy(),this.div.remove())}hide(){this.div&&(this.div.hidden=!0)}show(){!this.div||this.annotationEditorLayer.isEmpty||(this.div.hidden=!1)}}Bo=new WeakMap;class k_{constructor({pageDiv:e,pdfPage:t,linkService:a,downloadManager:i,annotationStorage:s=null,imageResourcesPath:o="",renderForms:l=!0,l10n:r=Vl,enableScripting:c=!1,hasJSActionsPromise:u=null,fieldObjectsPromise:d=null,annotationCanvasMap:f=null,accessibilityManager:g=null}){F(this,Oo);F(this,Ls,0);F(this,va,null);this.pageDiv=e,this.pdfPage=t,this.linkService=a,this.downloadManager=i,this.imageResourcesPath=o,this.renderForms=l,this.l10n=r,this.annotationStorage=s,this.enableScripting=c,this._hasJSActionsPromise=u||Promise.resolve(!1),this._fieldObjectsPromise=d||Promise.resolve(null),this._annotationCanvasMap=f,this._accessibilityManager=g,this.div=null,this._cancelled=!1,this._eventBus=a.eventBus}render(e,t="display"){return oe(this,null,function*(){var o;if(this.div){if(this._cancelled||N(this,Ls)===0)return;Z.AnnotationLayer.update({viewport:e.clone({dontFlip:!0}),div:this.div,annotationCanvasMap:this._annotationCanvasMap});return}const[a,i,s]=yield Promise.all([this.pdfPage.getAnnotations({intent:t}),this._hasJSActionsPromise,this._fieldObjectsPromise]);if(!this._cancelled){if(pe(this,Ls,a.length),this.div=document.createElement("div"),this.div.className="annotationLayer",this.pageDiv.append(this.div),N(this,Ls)===0){this.hide();return}Z.AnnotationLayer.render({viewport:e.clone({dontFlip:!0}),div:this.div,annotations:a,page:this.pdfPage,imageResourcesPath:this.imageResourcesPath,renderForms:this.renderForms,linkService:this.linkService,downloadManager:this.downloadManager,annotationStorage:this.annotationStorage,enableScripting:this.enableScripting,hasJSActions:i,fieldObjects:s,annotationCanvasMap:this._annotationCanvasMap,accessibilityManager:this._accessibilityManager}),this.linkService.isInPresentationMode&&H(this,Oo,Pu).call(this,Nt.FULLSCREEN),N(this,va)||(pe(this,va,l=>{H(this,Oo,Pu).call(this,l.state)}),(o=this._eventBus)==null||o._on("presentationmodechanged",N(this,va)))}})}cancel(){var e;this._cancelled=!0,N(this,va)&&((e=this._eventBus)==null||e._off("presentationmodechanged",N(this,va)),pe(this,va,null))}hide(){this.div&&(this.div.hidden=!0)}}Ls=new WeakMap,va=new WeakMap,Oo=new WeakSet,Pu=function(e){if(!this.div)return;let t=!1;switch(e){case Nt.FULLSCREEN:t=!0;break;case Nt.NORMAL:break;default:return}for(const a of this.div.childNodes)a.hasAttribute("data-internal-link")||(a.inert=t)};const Pg={Document:null,DocumentFragment:null,Part:"group",Sect:"group",Div:"group",Aside:"note",NonStruct:"none",P:null,H:"heading",Title:null,FENote:"note",Sub:"group",Lbl:null,Span:null,Em:null,Strong:null,Link:"link",Annot:"note",Form:"form",Ruby:null,RB:null,RT:null,RP:null,Warichu:null,WT:null,WP:null,L:"list",LI:"listitem",LBody:null,Table:"table",TR:"row",TH:"columnheader",TD:"cell",THead:"columnheader",TBody:null,TFoot:null,Caption:null,Figure:"figure",Formula:null,Artifact:null},S_=/^H(\d+)$/;class L_{constructor(){F(this,Ro);F(this,qo);F(this,In,void 0)}get renderingDone(){return N(this,In)!==void 0}render(e){if(N(this,In)!==void 0)return N(this,In);const t=H(this,qo,Nu).call(this,e);return t==null||t.classList.add("structTree"),pe(this,In,t)}hide(){N(this,In)&&!N(this,In).hidden&&(N(this,In).hidden=!0)}show(){var e;(e=N(this,In))!=null&&e.hidden&&(N(this,In).hidden=!1)}}In=new WeakMap,Ro=new WeakSet,Mu=function(e,t){e.alt!==void 0&&t.setAttribute("aria-label",e.alt),e.id!==void 0&&t.setAttribute("aria-owns",e.id),e.lang!==void 0&&t.setAttribute("lang",e.lang)},qo=new WeakSet,Nu=function(e){if(!e)return null;const t=document.createElement("span");if("role"in e){const{role:a}=e,i=a.match(S_);i?(t.setAttribute("role","heading"),t.setAttribute("aria-level",i[1])):Pg[a]&&t.setAttribute("role",Pg[a])}if(H(this,Ro,Mu).call(this,e,t),e.children)if(e.children.length===1&&"id"in e.children[0])H(this,Ro,Mu).call(this,e.children[0],t);else for(const a of e.children)t.append(H(this,qo,Nu).call(this,a));return t};const Uo=class{constructor(){F(this,Fo);F(this,Ea,!1);F(this,Dn,null);F(this,ka,new Map);F(this,Va,new Map)}setTextMapping(e){pe(this,Dn,e)}enable(){if(N(this,Ea))throw new Error("TextAccessibilityManager is already enabled.");if(!N(this,Dn))throw new Error("Text divs and strings have not been set.");if(pe(this,Ea,!0),pe(this,Dn,N(this,Dn).slice()),N(this,Dn).sort(H(Uo,Cs,fc)),N(this,ka).size>0){const e=N(this,Dn);for(const[t,a]of N(this,ka)){if(!document.getElementById(t)){N(this,ka).delete(t);continue}H(this,Fo,Hu).call(this,t,e[a])}}for(const[e,t]of N(this,Va))this.addPointerInTextLayer(e,t);N(this,Va).clear()}disable(){N(this,Ea)&&(N(this,Va).clear(),pe(this,Dn,null),pe(this,Ea,!1))}removePointerInTextLayer(e){if(!N(this,Ea)){N(this,Va).delete(e);return}const t=N(this,Dn);if(!t||t.length===0)return;const{id:a}=e,i=N(this,ka).get(a);if(i===void 0)return;const s=t[i];N(this,ka).delete(a);let o=s.getAttribute("aria-owns");o!=null&&o.includes(a)&&(o=o.split(" ").filter(l=>l!==a).join(" "),o?s.setAttribute("aria-owns",o):(s.removeAttribute("aria-owns"),s.setAttribute("role","presentation")))}addPointerInTextLayer(e,t){const{id:a}=e;if(!a)return;if(!N(this,Ea)){N(this,Va).set(e,t);return}t&&this.removePointerInTextLayer(e);const i=N(this,Dn);if(!i||i.length===0)return;const s=so(i,l=>{var r;return H(r=Uo,Cs,fc).call(r,e,l)<0}),o=Math.max(0,s-1);H(this,Fo,Hu).call(this,a,i[o]),N(this,ka).set(a,o)}moveElementInDOM(e,t,a,i){if(this.addPointerInTextLayer(a,i),!e.hasChildNodes()){e.append(t);return}const s=Array.from(e.childNodes).filter(r=>r!==t);if(s.length===0)return;const o=a||t,l=so(s,r=>{var c;return H(c=Uo,Cs,fc).call(c,o,r)<0});l===0?s[0].before(t):s[l-1].after(t)}};let zl=Uo;Ea=new WeakMap,Dn=new WeakMap,ka=new WeakMap,Va=new WeakMap,Cs=new WeakSet,fc=function(e,t){const a=e.getBoundingClientRect(),i=t.getBoundingClientRect();if(a.width===0&&a.height===0)return 1;if(i.width===0&&i.height===0)return-1;const s=a.y,o=a.y+a.height,l=a.y+a.height/2,r=i.y,c=i.y+i.height,u=i.y+i.height/2;if(l<=r&&u>=o)return-1;if(u<=s&&l>=c)return 1;const d=a.x+a.width/2,f=i.x+i.width/2;return d-f},Fo=new WeakSet,Hu=function(e,t){const a=t.getAttribute("aria-owns");a!=null&&a.includes(e)||t.setAttribute("aria-owns",a?`${a} ${e}`:e),t.removeAttribute("role")},F(zl,Cs);class C_{constructor({findController:e,eventBus:t,pageIndex:a}){this.findController=e,this.matches=[],this.eventBus=t,this.pageIdx=a,this._onUpdateTextLayerMatches=null,this.textDivs=null,this.textContentItemsStr=null,this.enabled=!1}setTextMapping(e,t){this.textDivs=e,this.textContentItemsStr=t}enable(){if(!this.textDivs||!this.textContentItemsStr)throw new Error("Text divs and strings have not been set.");if(this.enabled)throw new Error("TextHighlighter is already enabled.");this.enabled=!0,this._onUpdateTextLayerMatches||(this._onUpdateTextLayerMatches=e=>{(e.pageIndex===this.pageIdx||e.pageIndex===-1)&&this._updateMatches()},this.eventBus._on("updatetextlayermatches",this._onUpdateTextLayerMatches)),this._updateMatches()}disable(){this.enabled&&(this.enabled=!1,this._onUpdateTextLayerMatches&&(this.eventBus._off("updatetextlayermatches",this._onUpdateTextLayerMatches),this._onUpdateTextLayerMatches=null),this._updateMatches(!0))}_convertMatches(e,t){if(!e)return[];const{textContentItemsStr:a}=this;let i=0,s=0;const o=a.length-1,l=[];for(let r=0,c=e.length;r<c;r++){let u=e[r];for(;i!==o&&u>=s+a[i].length;)s+=a[i].length,i++;i===a.length&&console.error("Could not find a matching mapping");const d={begin:{divIdx:i,offset:u-s}};for(u+=t[r];i!==o&&u>s+a[i].length;)s+=a[i].length,i++;d.end={divIdx:i,offset:u-s},l.push(d)}return l}_renderMatches(e){if(e.length===0)return;const{findController:t,pageIdx:a}=this,{textContentItemsStr:i,textDivs:s}=this,o=a===t.selected.pageIdx,l=t.selected.matchIdx,r=t.state.highlightAll;let c=null;const u={divIdx:-1,offset:void 0};function d(m,b){const y=m.divIdx;return s[y].textContent="",f(y,0,m.offset,b)}function f(m,b,y,w){let E=s[m];if(E.nodeType===Node.TEXT_NODE){const v=document.createElement("span");E.before(v),v.append(E),s[m]=v,E=v}const k=i[m].substring(b,y),L=document.createTextNode(k);if(w){const v=document.createElement("span");return v.className=`${w} appended`,v.append(L),E.append(v),w.includes("selected")?v.offsetLeft:0}return E.append(L),0}let g=l,h=g+1;if(r)g=0,h=e.length;else if(!o)return;for(let m=g;m<h;m++){const b=e[m],y=b.begin,w=b.end,E=o&&m===l,k=E?" selected":"";let L=0;if(!c||y.divIdx!==c.divIdx?(c!==null&&f(c.divIdx,c.offset,u.offset),d(y)):f(c.divIdx,c.offset,y.offset),y.divIdx===w.divIdx)L=f(y.divIdx,y.offset,w.offset,"highlight"+k);else{L=f(y.divIdx,y.offset,u.offset,"highlight begin"+k);for(let v=y.divIdx+1,A=w.divIdx;v<A;v++)s[v].className="highlight middle"+k;d(w,"highlight end"+k)}c=w,E&&t.scrollMatchIntoView({element:s[y.divIdx],selectedLeft:L,pageIndex:a,matchIndex:l})}c&&f(c.divIdx,c.offset,u.offset)}_updateMatches(e=!1){if(!this.enabled&&!e)return;const{findController:t,matches:a,pageIdx:i}=this,{textContentItemsStr:s,textDivs:o}=this;let l=-1;for(const u of a){const d=Math.max(l,u.begin.divIdx);for(let f=d,g=u.end.divIdx;f<=g;f++){const h=o[f];h.textContent=s[f],h.className=""}l=u.end.divIdx+1}if(!(t!=null&&t.highlightMatches)||e)return;const r=t.pageMatches[i]||null,c=t.pageMatchesLength[i]||null;this.matches=this._convertMatches(r,c),this._renderMatches(this.matches)}}var Mg=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const x_=(n,e,t)=>{ns(e);const a=t.toolbar.rectAnno;a.addEventListener("click",()=>{a.classList.contains("toggled")?(a.classList.remove("toggled"),t.mainContainer.classList.remove("rect-to-annotation")):(e.pdfCursorTools.switchTool(0),a.classList.add("toggled"),t.mainContainer.classList.add("rect-to-annotation"),getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0),di(n))});const i=t.mainContainer.lastElementChild;return t.mainContainer.addEventListener("mousedown",s=>{if(s.button===2||!a.classList.contains("toggled"))return;let o=e.pdfViewer._getVisiblePages().first.view.canvas.getBoundingClientRect();s.clientX>o.right&&(o=e.pdfViewer._getVisiblePages().last.view.canvas.getBoundingClientRect());const l=t.mainContainer.getBoundingClientRect(),r=o.left,c=o.right,u=l.bottom;let d=s.clientX;s.clientX>c?d=c:s.clientX<r&&(d=r);const f=l.top,g=s.clientY,h=document;h.onmousemove=m=>{i.classList.remove("fn__none");let b=0,y=0,w=0,E=0;m.clientX<d?(m.clientX<r?y=r:y=m.clientX,w=d-y):m.clientX>c?(y=d,w=c-y):(y=d,w=m.clientX-d),m.clientY>g?m.clientY>u?(b=g,E=u-g):(b=g,E=m.clientY-g):(m.clientY<f?b=f:b=m.clientY,E=g-b),i.setAttribute("style",`top:${b}px;height:${E}px;left:${y}px;width:${w}px;background-color:${m.altKey?"var(--b3-pdf-background1)":""}`)},h.onmouseup=()=>{h.onmousemove=null,h.onmouseup=null,h.ondragstart=null,h.onselectstart=null,h.onselect=null,a.classList.remove("toggled"),t.mainContainer.classList.remove("rect-to-annotation");const m=A_(e,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)",i,i.style.backgroundColor?"text":"border");i.classList.add("fn__none"),m?m.forEach((b,y)=>{const w=Wl(b,e);y===0&&(xt=w,Yl(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${xt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}):xt=null}}),n.addEventListener("click",s=>{let o=!1,l=s.target;if(typeof s.detail=="string"){window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor=s.detail==="0"?window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)":`var(--b3-pdf-background${s.detail})`,Ue(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME]);const r=Hg(e,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor);r&&r.forEach((c,u)=>{const d=Wl(c,e);u===0&&(xt=d,Yl(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${xt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}),di(n);return}for(;l&&!l.classList.contains("pdf__outer");){const r=l.getAttribute("data-type");if(l.classList.contains("color__square")){const c=l.style.backgroundColor;if(window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor=c,Ue(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME]),xt){const u=ns(e),d=u[xt.getAttribute("data-node-id")];d.color=c,Array.from(xt.children).forEach(f=>{f.style.border="2px solid "+c,d.type==="text"?f.style.backgroundColor=c:f.style.backgroundColor="transparent"}),_("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(u)})}else{const u=Hg(e,c);u&&u.forEach((d,f)=>{const g=Wl(d,e);f===0&&(xt=g,Yl(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${xt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))})}di(n),o=!0,s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("pdf__rect")){Ng(n,void 0,l),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="remove"){const c=e.appConfig.file.replace(location.origin,"").substr(1),u=ns(e);delete u[xt.getAttribute("data-node-id")],xt.remove(),_("/api/asset/setFileAnnotation",{path:c+".sya",data:JSON.stringify(u)}),di(n),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="copy"){di(n),Yl(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${xt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="toggle"){const c=ns(e),u=c[xt.getAttribute("data-node-id")];u.type==="border"?u.type="text":u.type="border",Array.from(xt.children).forEach(d=>{u.type==="text"?d.style.backgroundColor=d.style.border.replace("2px solid ",""):d.style.backgroundColor=""}),_("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(c)}),s.preventDefault(),s.stopPropagation(),o=!0,di(n);break}l=l.parentElement}o||setTimeout(()=>{let r=!1;const c=window.getSelection();if(c.rangeCount>0){const u=c.getRangeAt(0);u.toString()!==""&&$(u.commonAncestorContainer,"pdfViewer")&&(Ng(n,u),r=!0)}r||di(n)})}),e},di=n=>{n.querySelector(".pdf__util").classList.add("fn__none")};let xt;const Ng=(n,e,t)=>{t&&(t.setAttribute("prevent-popover","true"),setTimeout(()=>{t.removeAttribute("prevent-popover")},620));const a=n.querySelector(".pdf__util");if(a.classList.remove("fn__none"),e){a.classList.add("pdf__util--hide");const s=e.getClientRects(),o=s[s.length-1];Ve(a,o.left,o.bottom),xt=null;return}xt=t,a.classList.remove("pdf__util--hide");const i=t.firstElementChild.getBoundingClientRect();Ve(a,i.left,i.top+i.height+4)},Hg=(n,e)=>{const t=window.getSelection().getRangeAt(0),a=$(t.startContainer,"page");if(!a)return;const i=parseInt(a.getAttribute("data-page-number"))-1,s=$(t.endContainer,"page");if(!s)return;const o=parseInt(s.getAttribute("data-page-number"))-1,l=t.cloneContents();Array.from(l.children).forEach(w=>{if(w.tagName==="BR"&&w.previousElementSibling&&w.nextElementSibling){const E=w.previousElementSibling.textContent,k=w.nextElementSibling.textContent;/^[A-Za-z]$/.test(E.substring(E.length-2,E.length-1))&&/^[A-Za-z]$/.test(k.substring(0,1))&&(E.endsWith("-")?w.previousElementSibling.textContent=E.substring(0,E.length-1):w.insertAdjacentText("afterend"," "))}});const r=Lute.EscapeHTMLStr(l.textContent.replace(/[\x00]|\n/g,"")),c=n.pdfViewer.getPageView(i),u=c.canvas.getClientRects()[0],d=c.viewport,f=t.cloneRange();if(i!==o){const w=c.textLayer.textDivs;t.setEndAfter(w[w.length-1])}const g=[];Bg(t).forEach(function(w){g.push(d.convertToPdfPoint(w.left-u.x,w.top-u.y).concat(d.convertToPdfPoint(w.right-u.x,w.bottom-u.y)))});const h=[];if(i!==o){ee(f);const w=n.pdfViewer.getPageView(o),E=w.canvas.getClientRects()[0],k=w.viewport,L=w.textLayer.textDivs;f.setStart(L[0],0),Bg(f).forEach(function(v){h.push(k.convertToPdfPoint(v.left-E.x,v.top-E.y).concat(k.convertToPdfPoint(v.right-E.x,v.bottom-E.y)))})}const m=Lute.NewNodeID(),b=[],y=[];if(g.length>0&&(b.push({index:i,positions:g}),y.push({index:i,coords:g,id:m,color:e,content:r,type:"text",mode:"text"})),h.length>0&&(b.push({index:o,positions:h}),y.push({index:o,coords:h,id:m,color:e,content:r,type:"text",mode:"text"})),b.length!==0)return qg(n,m,{pages:b,content:r,color:e,type:"text",mode:"text"}),y},A_=(n,e,t,a)=>{const i=t.getBoundingClientRect(),s=$(document.elementFromPoint(i.left,i.top-1),"page");if(!s)return;const o=parseInt(s.getAttribute("data-page-number"))-1,l=n.pdfViewer.getPageView(o),r=l.canvas.getClientRects()[0],c=l.viewport,u=c.convertToPdfPoint(i.left-r.x,i.top-r.y).concat(c.convertToPdfPoint(i.right-r.x,i.bottom-r.y)),d=[{index:l.id-1,positions:[u]}],f=Lute.NewNodeID(),g=n.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,"")+`-P${l.id}-${ue().format("YYYYMMDDHHmmss")}`,h=[{index:l.id-1,coords:[u],id:f,color:e,content:g,type:a,mode:"rect"}];let m=document.elementFromPoint(i.right,i.bottom+1);if(m=$(m,"page"),m){const b=parseInt(m.getAttribute("data-page-number"))-1;if(b!==o){const y=n.pdfViewer.getPageView(b),w=y.canvas.getClientRects()[0],E=y.viewport,k=E.convertToPdfPoint(i.left-w.x,i.top-w.y).concat(E.convertToPdfPoint(i.right-w.x,i.bottom-w.y));d.push({index:y.id-1,positions:[k]}),h.push({index:y.id-1,coords:[k],id:f,color:e,content:g,type:a,mode:"rect"})}}return qg(n,f,{pages:d,content:g,color:e,type:a,mode:"rect"}),h},Bg=n=>{const e=n.getClientRects(),t=[];let a;return Array.from(e).forEach(i=>{i.height===0||i.width===0||(typeof a=="undefined"||Math.abs(a-i.top)>4?(t.push({left:i.left,top:i.top,right:i.right,bottom:i.bottom}),a=i.top):t[t.length-1].right=i.right)}),t},Re=n=>{let e;return Ye().asset.find(t=>{if(t.pdfObject&&n&&t.element&&typeof t.element.contains!="undefined"&&t.element.contains(n))return e=t.pdfObject,!0}),e},Og=n=>{const e=Re(n);if(!e)return;const t=parseInt(n.parentElement.getAttribute("data-page-number"))-1,a=ns(e);Object.keys(a).find(i=>{const s=a[i],o=s.pages.find(l=>{if(l.index===t)return!0});o&&Wl({index:t,coords:o.positions,id:i,color:s.color,content:s.content,type:s.type,mode:s.mode||""},e,e.annoId===i)})},Wl=(n,e,t)=>{const a=n.index,i=e.pdfViewer.getPageView(a);let s=i.textLayer.div;if(!s.lastElementChild)return;const o=i.viewport;s.lastElementChild.classList.contains("endOfContent")&&s.insertAdjacentHTML("beforeend","<div></div>"),s=s.lastElementChild;let l=`<div class="pdf__rect popover__block" data-node-id="${n.id}" data-mode="${n.mode}">`;return n.coords.forEach(r=>{const c=o.convertToViewportRectangle(r),u=Math.abs(c[0]-c[2]);if(u<=0)return;let d=`border: 2px solid ${n.color};background-color: ${n.color};`;n.type==="border"&&(d=`border: 2px solid ${n.color};`),l+=`<div style="${d}
        left:${Math.min(c[0],c[2])}px;
        top:${Math.min(c[1],c[3])}px;
        width:${u}px;
        height: ${Math.abs(c[1]-c[3])}px"></div>`}),s.insertAdjacentHTML("beforeend",l+"</div>"),s.lastElementChild.setAttribute("data-content",n.content),t&&Rg(s,n.id),s.lastElementChild},Rg=(n,e)=>{const t=n.querySelector(`.pdf__rect[data-node-id="${e}"]`);if(t&&t.firstElementChild){const a=S(t,"id","viewerContainer");if(a){const i=t.firstElementChild.getBoundingClientRect(),s=a.getBoundingClientRect();i.top<s.top?a.scrollTop=a.scrollTop-(s.top-i.top)-(s.height-i.height)/2:i.bottom>s.bottom&&(a.scrollTop=a.scrollTop+(i.bottom-s.bottom)+(s.height-i.height)/2)}t.classList.add("pdf__rect--hl"),setTimeout(()=>{t.classList.remove("pdf__rect--hl")},1500)}},Yl=(n,e,t)=>{const a=xt.getAttribute("data-mode"),i=xt.getAttribute("data-content");setTimeout(()=>{a==="rect"||a===""&&xt.childElementCount===1&&i.startsWith(e)?I_(t).then(s=>{fetch(s).then(o=>o.blob()).then(o=>{const l=new FormData,r=i+".png";l.append("file[]",o,r),_(p.Constants.UPLOAD_ADDRESS,l,c=>{O(`<<${n} "${i}">>
![](${c.data.succMap[r]})`)})})}):O(`<<${n} "${i}">>`)},p.Constants.TIMEOUT_DBLCLICK)},T_=(n,e)=>Mg(void 0,null,function*(){const t=yield n.pdfDocument.getPage(e),a=t.getViewport({scale:1.5*n.pdfViewer.currentScale*window.pdfjsLib.PixelsPerInch.PDF_TO_CSS_UNITS}),i=document.createElement("canvas");return i.width=Math.floor(a.width),i.height=Math.floor(a.height),yield t.render({canvasContext:i.getContext("2d"),viewport:a}).promise,i});function I_(n){return Mg(this,null,function*(){const e=$(xt,"page");if(!e)return;const t=yield T_(n,parseInt(e.getAttribute("data-page-number"))),a=xt.firstElementChild.style,i=1.5,s=t.getContext("2d").getImageData(i*parseFloat(a.left),i*parseFloat(a.top),i*parseFloat(a.width),i*parseFloat(a.height)),o=document.createElement("canvas");return o.width=s.width,o.height=s.height,o.getContext("2d").putImageData(s,0,0),o.toDataURL()})}const qg=(n,e,t)=>{const a=n.appConfig.file.replace(location.origin,"").substr(1),i=ns(n);i[e]=t,_("/api/asset/setFileAnnotation",{path:a+".sya",data:JSON.stringify(i)})},ns=n=>{if(n.appConfig.config)return n.appConfig.config;const e=n.appConfig.file.replace(location.origin,"").substr(1)+".sya";_("/api/asset/getFileAnnotation",{path:e},t=>{let a={};t.code!==1&&(a=JSON.parse(t.data.data)),n.appConfig.config=a})};class D_{constructor({highlighter:e=null,accessibilityManager:t=null,isOffscreenCanvasSupported:a=!0}){F(this,Ur);F(this,Vr);F(this,xs,0);F(this,As,0);F(this,Ts,null);this.textContentItemsStr=[],this.renderingDone=!1,this.textDivs=[],this.textDivProperties=new WeakMap,this.textLayerRenderTask=null,this.highlighter=e,this.accessibilityManager=t,this.isOffscreenCanvasSupported=a,this.div=document.createElement("div"),this.div.className="textLayer",this.hide()}get numTextDivs(){return this.textDivs.length}render(e){return oe(this,null,function*(){var i,s,o;if(!N(this,Ts))throw new Error('No "textContentSource" parameter specified.');const t=e.scale*(globalThis.devicePixelRatio||1),{rotation:a}=e;if(this.renderingDone){const l=a!==N(this,xs),r=t!==N(this,As);(l||r)&&(this.hide(),(0,Z.updateTextLayer)({container:this.div,viewport:e,textDivs:this.textDivs,textDivProperties:this.textDivProperties,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported,mustRescale:r,mustRotate:l}),pe(this,As,t),pe(this,xs,a)),this.show(),this.div.lastElementChild.previousElementSibling&&this.div.lastElementChild.previousElementSibling.classList.contains("endOfContent")&&(this.div.lastElementChild.innerHTML=""),Og(this.div);return}this.cancel(),(i=this.highlighter)==null||i.setTextMapping(this.textDivs,this.textContentItemsStr),(s=this.accessibilityManager)==null||s.setTextMapping(this.textDivs),this.textLayerRenderTask=(0,Z.renderTextLayer)({textContentSource:N(this,Ts),container:this.div,viewport:e,textDivs:this.textDivs,textDivProperties:this.textDivProperties,textContentItemsStr:this.textContentItemsStr,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported}),yield this.textLayerRenderTask.promise,H(this,Ur,kb).call(this),pe(this,As,t),pe(this,xs,a),this.show(),Og(this.div),(o=this.accessibilityManager)==null||o.enable()})}hide(){var e;this.div.hidden||((e=this.highlighter)==null||e.disable(),this.div.hidden=!0)}show(){var e;this.div.hidden&&this.renderingDone&&(this.div.hidden=!1,(e=this.highlighter)==null||e.enable())}cancel(){var e,t;this.textLayerRenderTask&&(this.textLayerRenderTask.cancel(),this.textLayerRenderTask=null),(e=this.highlighter)==null||e.disable(),(t=this.accessibilityManager)==null||t.disable(),this.textContentItemsStr.length=0,this.textDivs.length=0,this.textDivProperties=new WeakMap}setTextContentSource(e){this.cancel(),pe(this,Ts,e)}}xs=new WeakMap,As=new WeakMap,Ts=new WeakMap,Ur=new WeakSet,kb=function(){this.renderingDone=!0;const e=document.createElement("div");e.className="endOfContent",this.div.append(e),H(this,Vr,Sb).call(this)},Vr=new WeakSet,Sb=function(){const{div:e}=this;e.addEventListener("mousedown",t=>{const a=e.querySelector(".endOfContent");if(a){if(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL")){let i=t.target!==e;if((typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&i&&(i=getComputedStyle(a).getPropertyValue("-moz-user-select")!=="none"),i){const s=e.getBoundingClientRect(),o=Math.max(0,(t.pageY-s.top)/s.height);a.style.top=(o*100).toFixed(2)+"%"}}a.classList.add("active")}}),e.addEventListener("mouseup",()=>{const t=e.querySelector(".endOfContent");t&&((typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&(t.style.top=""),t.classList.remove("active"))})};class $_{constructor({pageDiv:e,pdfPage:t,annotationStorage:a=null,linkService:i,xfaHtml:s=null}){this.pageDiv=e,this.pdfPage=t,this.annotationStorage=a,this.linkService=i,this.xfaHtml=s,this.div=null,this._cancelled=!1}render(e,t="display"){return oe(this,null,function*(){if(t==="print"){const s={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:this.xfaHtml,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:t},o=document.createElement("div");return this.pageDiv.append(o),s.div=o,Z.XfaLayer.render(s)}const a=yield this.pdfPage.getXfa();if(this._cancelled||!a)return{textDivs:[]};const i={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:a,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:t};return this.div?Z.XfaLayer.update(i):(this.div=document.createElement("div"),this.pageDiv.append(this.div),i.div=this.div,Z.XfaLayer.render(i))})}cancel(){this._cancelled=!0}hide(){this.div&&(this.div.hidden=!0)}}const P_=Rl.maxCanvasPixels||16777216,M_=()=>typeof PDFJSDev=="undefined"||!PDFJSDev.test("COMPONENTS")?null:{annotationEditorUIManager:null,annotationStorage:null,downloadManager:null,enableScripting:!1,fieldObjectsPromise:null,findController:null,hasJSActionsPromise:null,get linkService(){return new dg}};class N_{constructor(e){F(this,Ds);F(this,zo);F(this,Wo);F(this,Yo);F(this,Go);F(this,zr);F(this,Wr);F(this,za,Z.AnnotationMode.ENABLE_FORMS);F(this,Wa,null);F(this,Ya,null);F(this,Vo,null);F(this,Is,je.INITIAL);F(this,Di,{initialOptionalContent:!0,regularAnnotations:!0});var s,o,l,r;const t=e.container,a=e.defaultViewport;this.id=e.id,this.renderingId="page"+this.id,pe(this,Wa,e.layerProperties||M_),this.pdfPage=null,this.pageLabel=null,this.rotation=0,this.scale=e.scale||yd,this.viewport=a,this.pdfPageRotate=a.rotation,this._optionalContentConfigPromise=e.optionalContentConfigPromise||null,this.hasRestrictedScaling=!1,this.textLayerMode=(s=e.textLayerMode)!=null?s:Ml.ENABLE,pe(this,za,(o=e.annotationMode)!=null?o:Z.AnnotationMode.ENABLE_FORMS),this.imageResourcesPath=e.imageResourcesPath||"",this.useOnlyCssZoom=e.useOnlyCssZoom||!1,this.isOffscreenCanvasSupported=(l=e.isOffscreenCanvasSupported)!=null?l:!0,this.maxCanvasPixels=e.maxCanvasPixels||P_,this.pageColors=e.pageColors||null,this.eventBus=e.eventBus,this.renderingQueue=e.renderingQueue,(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&(this.renderer=e.renderer||Pl.CANVAS),this.l10n=e.l10n||Vl,this.paintTask=null,this.paintedViewportMap=new WeakMap,this.resume=null,this._renderError=null,(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&(this._isStandalone=!((r=this.renderingQueue)!=null&&r.hasViewer())),this._annotationCanvasMap=null,this.annotationLayer=null,this.annotationEditorLayer=null,this.textLayer=null,this.zoomLayer=null,this.xfaLayer=null,this.structTreeLayer=null;const i=document.createElement("div");if(i.className="page",i.setAttribute("data-page-number",this.id),i.setAttribute("role","region"),i.setAttribute("aria-label",window.siyuan.languages.thumbPageTitle.replace("{{page}}",this.id)),this.div=i,H(this,Ds,pc).call(this),t==null||t.append(i),(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this._isStandalone){t==null||t.style.setProperty("--scale-factor",this.scale*Z.PixelsPerInch.PDF_TO_CSS_UNITS);const{optionalContentConfigPromise:c}=e;c&&c.then(u=>{c===this._optionalContentConfigPromise&&(N(this,Di).initialOptionalContent=u.hasInitialVisibility)})}}get renderingState(){return N(this,Is)}set renderingState(e){if(e!==N(this,Is))switch(pe(this,Is,e),N(this,Ya)&&(clearTimeout(N(this,Ya)),pe(this,Ya,null)),e){case je.PAUSED:this.div.classList.remove("loading");break;case je.RUNNING:this.div.classList.add("loadingIcon"),pe(this,Ya,setTimeout(()=>{this.div.classList.add("loading"),pe(this,Ya,null)},0));break;case je.INITIAL:case je.FINISHED:this.div.classList.remove("loadingIcon","loading");break}}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const t=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:this.scale*Z.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:t}),H(this,Ds,pc).call(this),this.reset()}destroy(){var e;this.reset(),(e=this.pdfPage)==null||e.cleanup()}get _textHighlighter(){return(0,Z.shadow)(this,"_textHighlighter",new C_({pageIndex:this.id-1,eventBus:this.eventBus,findController:N(this,Wa).call(this).findController}))}_resetZoomLayer(e=!1){if(!this.zoomLayer)return;const t=this.zoomLayer.firstChild;this.paintedViewportMap.delete(t),t.width=0,t.height=0,e&&this.zoomLayer.remove(),this.zoomLayer=null}reset({keepZoomLayer:e=!1,keepAnnotationLayer:t=!1,keepAnnotationEditorLayer:a=!1,keepXfaLayer:i=!1,keepTextLayer:s=!1}={}){var g,h,m,b,y;this.cancelRendering({keepAnnotationLayer:t,keepAnnotationEditorLayer:a,keepXfaLayer:i,keepTextLayer:s}),this.renderingState=je.INITIAL;const o=this.div,l=o.childNodes,r=e&&this.zoomLayer||null,c=t&&((g=this.annotationLayer)==null?void 0:g.div)||null,u=a&&((h=this.annotationEditorLayer)==null?void 0:h.div)||null,d=i&&((m=this.xfaLayer)==null?void 0:m.div)||null,f=s&&((b=this.textLayer)==null?void 0:b.div)||null;for(let w=l.length-1;w>=0;w--){const E=l[w];switch(E){case r:case c:case u:case d:case f:continue}E.remove()}o.removeAttribute("data-loaded"),c&&this.annotationLayer.hide(),u&&this.annotationEditorLayer.hide(),d&&this.xfaLayer.hide(),f&&this.textLayer.hide(),(y=this.structTreeLayer)==null||y.hide(),r||(this.canvas&&(this.paintedViewportMap.delete(this.canvas),this.canvas.width=0,this.canvas.height=0,delete this.canvas),this._resetZoomLayer()),(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this.svg&&(this.paintedViewportMap.delete(this.svg),delete this.svg)}update({scale:e=0,rotation:t=null,optionalContentConfigPromise:a=null,drawingDelay:i=-1}){var c;this.scale=e||this.scale,typeof t=="number"&&(this.rotation=t),a instanceof Promise&&(this._optionalContentConfigPromise=a,a.then(u=>{a===this._optionalContentConfigPromise&&(N(this,Di).initialOptionalContent=u.hasInitialVisibility)}));const s=(this.rotation+this.pdfPageRotate)%360;if(this.viewport=this.viewport.clone({scale:this.scale*Z.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:s}),H(this,Ds,pc).call(this),(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this._isStandalone&&((c=this.div.parentNode)==null||c.style.setProperty("--scale-factor",this.viewport.scale)),(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this.svg){this.cssTransform({target:this.svg,redrawAnnotationLayer:!0,redrawAnnotationEditorLayer:!0,redrawXfaLayer:!0,redrawTextLayer:!0}),this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:this._renderError});return}let o=!1;if(this.canvas&&this.maxCanvasPixels>0){const u=this.outputScale;(Math.floor(this.viewport.width)*u.sx|0)*(Math.floor(this.viewport.height)*u.sy|0)>this.maxCanvasPixels&&(o=!0)}const l=this.useOnlyCssZoom||this.hasRestrictedScaling&&o,r=!l&&i>=0&&i<1e3;if(this.canvas){if(r||l){r&&this.renderingState!==je.FINISHED&&(this.cancelRendering({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0,cancelExtraDelay:i}),this.renderingState=je.FINISHED),this.cssTransform({target:this.canvas,redrawAnnotationLayer:!0,redrawAnnotationEditorLayer:!0,redrawXfaLayer:!0,redrawTextLayer:!r,hideTextLayer:r}),this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:this._renderError});return}!this.zoomLayer&&!this.canvas.hidden&&(this.zoomLayer=this.canvas.parentNode,this.zoomLayer.style.position="absolute")}this.zoomLayer&&this.cssTransform({target:this.zoomLayer.firstChild}),this.reset({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0})}cancelRendering({keepAnnotationLayer:e=!1,keepAnnotationEditorLayer:t=!1,keepXfaLayer:a=!1,keepTextLayer:i=!1,cancelExtraDelay:s=0}={}){var o;this.paintTask&&(this.paintTask.cancel(s),this.paintTask=null),this.resume=null,this.textLayer&&(!i||!this.textLayer.div)&&(this.textLayer.cancel(),this.textLayer=null),this.structTreeLayer&&!this.textLayer&&(this.structTreeLayer=null),this.annotationLayer&&(!e||!this.annotationLayer.div)&&(this.annotationLayer.cancel(),this.annotationLayer=null,this._annotationCanvasMap=null),this.annotationEditorLayer&&(!t||!this.annotationEditorLayer.div)&&(this.annotationEditorLayer.cancel(),this.annotationEditorLayer=null),this.xfaLayer&&(!a||!this.xfaLayer.div)&&(this.xfaLayer.cancel(),this.xfaLayer=null,(o=this._textHighlighter)==null||o.disable())}cssTransform({target:e,redrawAnnotationLayer:t=!1,redrawAnnotationEditorLayer:a=!1,redrawXfaLayer:i=!1,redrawTextLayer:s=!1,hideTextLayer:o=!1}){var r;if(e instanceof HTMLCanvasElement){if(!e.hasAttribute("zooming")){e.setAttribute("zooming",!0);const{style:c}=e;c.width=c.height=""}}else{const c=this.div,{width:u,height:d}=this.viewport;e.style.width=e.parentNode.style.width=c.style.width=Math.floor(u)+"px",e.style.height=e.parentNode.style.height=c.style.height=Math.floor(d)+"px"}const l=this.paintedViewportMap.get(e);if(this.viewport!==l){const c=this.viewport.rotation-l.rotation,u=Math.abs(c);let d=1,f=1;if(u===90||u===270){const{width:g,height:h}=this.viewport;d=h/g,f=g/h}e.style.transform=`rotate(${c}deg) scale(${d}, ${f})`}t&&this.annotationLayer&&H(this,zo,Bu).call(this),a&&this.annotationEditorLayer&&H(this,Wo,Ou).call(this),i&&this.xfaLayer&&H(this,Yo,Ru).call(this),this.textLayer&&(o?(this.textLayer.hide(),(r=this.structTreeLayer)==null||r.hide()):s&&H(this,Go,qu).call(this))}get width(){return this.viewport.width}get height(){return this.viewport.height}getPagePoint(e,t){return this.viewport.convertToPdfPoint(e,t)}draw(){this.renderingState!==je.INITIAL&&(console.error("Must be in new state before drawing"),this.reset());const{div:e,pdfPage:t}=this;if(!t)return this.renderingState=je.FINISHED,Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=je.RUNNING;const a=document.createElement("div");if(a.classList.add("canvasWrapper"),e.append(a),!this.textLayer&&this.textLayerMode!==Ml.DISABLE&&!t.isPureXfa&&(this._accessibilityManager||(this._accessibilityManager=new zl),this.textLayer=new D_({highlighter:this._textHighlighter,accessibilityManager:this._accessibilityManager,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported}),e.append(this.textLayer.div)),!this.annotationLayer&&N(this,za)!==Z.AnnotationMode.DISABLE){const{annotationStorage:r,downloadManager:c,enableScripting:u,fieldObjectsPromise:d,hasJSActionsPromise:f,linkService:g}=N(this,Wa).call(this);this._annotationCanvasMap||(this._annotationCanvasMap=new Map),this.annotationLayer=new k_({pageDiv:e,pdfPage:t,annotationStorage:r,imageResourcesPath:this.imageResourcesPath,renderForms:N(this,za)===Z.AnnotationMode.ENABLE_FORMS,linkService:g,downloadManager:c,l10n:this.l10n,enableScripting:u,hasJSActionsPromise:f,fieldObjectsPromise:d,annotationCanvasMap:this._annotationCanvasMap,accessibilityManager:this._accessibilityManager})}let i=null;this.renderingQueue&&(i=r=>{if(!this.renderingQueue.isHighestPriority(this)){this.renderingState=je.PAUSED,this.resume=()=>{this.renderingState=je.RUNNING,r()};return}r()});const s=(r=null)=>oe(this,null,function*(){if(o===this.paintTask&&(this.paintTask=null),r instanceof Z.RenderingCancelledException){this._renderError=null;return}if(this._renderError=r,this.renderingState=je.FINISHED,this._resetZoomLayer(!0),N(this,Di).regularAnnotations=!o.separateAnnots,this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!1,timestamp:performance.now(),error:this._renderError}),r)throw r}),o=(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this.renderer===Pl.SVG?this.paintOnSvg(a):this.paintOnCanvas(a);o.onRenderContinue=i,this.paintTask=o;const l=o.promise.then(()=>s(null).then(()=>oe(this,null,function*(){if(H(this,Go,qu).call(this),this.annotationLayer&&(yield H(this,zo,Bu).call(this)),!this.annotationEditorLayer){const{annotationEditorUIManager:r}=N(this,Wa).call(this);if(!r)return;this.annotationEditorLayer=new E_({uiManager:r,pageDiv:e,pdfPage:t,l10n:this.l10n,accessibilityManager:this._accessibilityManager})}H(this,Wo,Ou).call(this)})),function(r){return s(r)});if(t.isPureXfa){if(this.xfaLayer)this.xfaLayer.div&&e.append(this.xfaLayer.div);else{const{annotationStorage:r,linkService:c}=N(this,Wa).call(this);this.xfaLayer=new $_({pageDiv:e,pdfPage:t,annotationStorage:r,linkService:c})}H(this,Yo,Ru).call(this)}return e.setAttribute("data-loaded",!0),this.eventBus.dispatch("pagerender",{source:this,pageNumber:this.id}),l}paintOnCanvas(e){var E,k;const t=(0,Z.createPromiseCapability)(),a={promise:t.promise,onRenderContinue(L){L()},cancel(L=0){w.cancel(L)},get separateAnnots(){return w.separateAnnots}},i=this.viewport,{width:s,height:o}=i,l=document.createElement("canvas");l.setAttribute("role","presentation"),l.hidden=!0;let r=!0;const c=!!((E=this.pageColors)!=null&&E.background&&((k=this.pageColors)!=null&&k.foreground)),u=function(L){r&&(!c||L)&&(l.hidden=!1,r=!1)};e.append(l),this.canvas=l;const d=l.getContext("2d",{alpha:!1}),f=this.outputScale=new Qp;if(this.useOnlyCssZoom){const L=i.clone({scale:Z.PixelsPerInch.PDF_TO_CSS_UNITS});f.sx*=L.width/s,f.sy*=L.height/o}if(this.maxCanvasPixels>0){const L=s*o,v=Math.sqrt(this.maxCanvasPixels/L);f.sx>v||f.sy>v?(f.sx=v,f.sy=v,this.hasRestrictedScaling=!0):this.hasRestrictedScaling=!1}const g=ng(f.sx),h=ng(f.sy);l.width=Hl(i.width*f.sx,g[0]),l.height=Hl(i.height*f.sy,h[0]);const{style:m}=l;m.width=Hl(i.width,g[1])+"px",m.height=Hl(i.height,h[1])+"px",this.paintedViewportMap.set(l,i);const b=f.scaled?[f.sx,0,0,f.sy,0,0]:null,y={canvasContext:d,transform:b,viewport:i,annotationMode:N(this,za),optionalContentConfigPromise:this._optionalContentConfigPromise,annotationCanvasMap:this._annotationCanvasMap,pageColors:this.pageColors},w=this.pdfPage.render(y);return w.onContinue=function(L){u(!1),a.onRenderContinue?a.onRenderContinue(L):L()},w.promise.then(function(){u(!0),t.resolve()},function(L){L instanceof Z.RenderingCancelledException||u(!0),t.reject(L)}),a}paintOnSvg(e){if(!(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")))throw new Error("Not implemented: paintOnSvg");let t=!1;const a=()=>{if(t)throw new Z.RenderingCancelledException(`Rendering cancelled, page ${this.id}`,"svg")},i=this.pdfPage,s=this.viewport.clone({scale:Z.PixelsPerInch.PDF_TO_CSS_UNITS});return{promise:i.getOperatorList({annotationMode:N(this,za)}).then(l=>(a(),new Z.SVGGraphics(i.commonObjs,i.objs).getSVG(l,s).then(c=>{a(),this.svg=c,this.paintedViewportMap.set(c,s),c.style.width=e.style.width,c.style.height=e.style.height,this.renderingState=je.FINISHED,e.append(c)}))),onRenderContinue(l){l()},cancel(){t=!0},get separateAnnots(){return!1}}}setPageLabel(e){this.pageLabel=typeof e=="string"?e:null,this.pageLabel!==null?this.div.setAttribute("data-page-label",this.pageLabel):this.div.removeAttribute("data-page-label")}get thumbnailCanvas(){const{initialOptionalContent:e,regularAnnotations:t}=N(this,Di);return e&&t?this.canvas:null}}za=new WeakMap,Wa=new WeakMap,Ya=new WeakMap,Vo=new WeakMap,Is=new WeakMap,Di=new WeakMap,Ds=new WeakSet,pc=function(){const{viewport:e}=this;if(this.pdfPage){if(N(this,Vo)===e.rotation)return;pe(this,Vo,e.rotation)}(0,Z.setLayerDimensions)(this.div,e,!0,!1)},zo=new WeakSet,Bu=function(){return oe(this,null,function*(){let e=null;try{yield this.annotationLayer.render(this.viewport,"display")}catch(t){console.error(`#renderAnnotationLayer: "${t}".`),e=t}finally{this.eventBus.dispatch("annotationlayerrendered",{source:this,pageNumber:this.id,error:e})}})},Wo=new WeakSet,Ou=function(){return oe(this,null,function*(){let e=null;try{yield this.annotationEditorLayer.render(this.viewport,"display")}catch(t){console.error(`#renderAnnotationEditorLayer: "${t}".`),e=t}finally{this.eventBus.dispatch("annotationeditorlayerrendered",{source:this,pageNumber:this.id,error:e})}})},Yo=new WeakSet,Ru=function(){return oe(this,null,function*(){let e=null;try{const t=yield this.xfaLayer.render(this.viewport,"display");t!=null&&t.textDivs&&this._textHighlighter&&H(this,Wr,Cb).call(this,t.textDivs)}catch(t){console.error(`#renderXfaLayer: "${t}".`),e=t}finally{this.eventBus.dispatch("xfalayerrendered",{source:this,pageNumber:this.id,error:e})}})},Go=new WeakSet,qu=function(){return oe(this,null,function*(){const{pdfPage:e,textLayer:t,viewport:a}=this;if(!t)return;let i=null;try{if(!t.renderingDone){const s=e.streamTextContent({includeMarkedContent:!0});t.setTextContentSource(s)}yield t.render(a)}catch(s){if(s instanceof Z.AbortException)return;console.error(`#renderTextLayer: "${s}".`),i=s}this.eventBus.dispatch("textlayerrendered",{source:this,pageNumber:this.id,numTextDivs:t.numTextDivs,error:i}),H(this,zr,Lb).call(this)})},zr=new WeakSet,Lb=function(){return oe(this,null,function*(){var a,i,s;if(!this.textLayer)return;this.structTreeLayer||(this.structTreeLayer=new L_);const e=yield this.structTreeLayer.renderingDone?null:this.pdfPage.getStructTree(),t=(a=this.structTreeLayer)==null?void 0:a.render(e);t&&((i=this.canvas)==null||i.append(t)),(s=this.structTreeLayer)==null||s.show()})},Wr=new WeakSet,Cb=function(e){return oe(this,null,function*(){const t=yield this.pdfPage.getTextContent(),a=[];for(const i of t.items)a.push(i.str);this._textHighlighter.setTextMapping(e,a),this._textHighlighter.enable()})};const Fg=10,Ug="enablePermissions",lo={FORCE_SCROLL_MODE_PAGE:15e3,FORCE_LAZY_PAGE_INIT:7500,PAUSE_EAGER_PAGE_INIT:250};function Vg(n){return Object.values(Z.AnnotationEditorType).includes(n)&&n!==Z.AnnotationEditorType.DISABLE}class H_{constructor(e){F(this,jo);F(this,Sa,new Set);F(this,$i,0);pe(this,$i,e)}push(e){const t=N(this,Sa);t.has(e)&&t.delete(e),t.add(e),t.size>N(this,$i)&&H(this,jo,Fu).call(this)}resize(e,t=null){pe(this,$i,e);const a=N(this,Sa);if(t){const i=a.size;let s=1;for(const o of a)if(t.has(o.id)&&(a.delete(o),a.add(o)),++s>i)break}for(;a.size>N(this,$i);)H(this,jo,Fu).call(this)}has(e){return N(this,Sa).has(e)}[Symbol.iterator](){return N(this,Sa).keys()}}Sa=new WeakMap,$i=new WeakMap,jo=new WeakSet,Fu=function(){const e=N(this,Sa).keys().next().value;e==null||e.destroy(),N(this,Sa).delete(e)};class B_{constructor(e){F(this,Gr);F(this,jr);F(this,Kr);F(this,Hi);F(this,$s);F(this,Zr);F(this,Jo);F(this,Xr);F(this,Un);F(this,Qo);F(this,Jr);F(this,Qr);F(this,el);F(this,ec);F(this,Pi,null);F(this,La,Z.AnnotationEditorType.NONE);F(this,Jt,null);F(this,Mi,Z.AnnotationMode.ENABLE_FORMS);F(this,Ko,null);F(this,Zo,!1);F(this,Xo,0);F(this,Yr,new ResizeObserver(H(this,ec,Mb).bind(this)));F(this,Ni,null);F(this,wn,null);F(this,Ga,null);var t,a,i,s,o,l;if(this.container=e.container,this.viewer=e.viewer||e.container.firstElementChild,typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")){if(((t=this.container)==null?void 0:t.tagName)!=="DIV"||((a=this.viewer)==null?void 0:a.tagName)!=="DIV")throw new Error("Invalid `container` and/or `viewer` option.");if(this.container.offsetParent&&getComputedStyle(this.container).position!=="absolute")throw new Error("The `container` must be absolutely positioned.")}N(this,Yr).observe(this.container),this.eventBus=e.eventBus,this.linkService=e.linkService||new dg,this.downloadManager=e.downloadManager||null,this.findController=e.findController||null,this._scriptingManager=e.scriptingManager||null,this.textLayerMode=(i=e.textLayerMode)!=null?i:Ml.ENABLE,pe(this,Mi,(s=e.annotationMode)!=null?s:Z.AnnotationMode.ENABLE_FORMS),pe(this,La,(o=e.annotationEditorMode)!=null?o:Z.AnnotationEditorType.NONE),this.imageResourcesPath=e.imageResourcesPath||"",this.enablePrintAutoRotate=e.enablePrintAutoRotate||!1,(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&(this.removePageBorders=e.removePageBorders||!1,this.renderer=e.renderer||Pl.CANVAS),this.useOnlyCssZoom=e.useOnlyCssZoom||!1,this.isOffscreenCanvasSupported=(l=e.isOffscreenCanvasSupported)!=null?l:!0,this.maxCanvasPixels=e.maxCanvasPixels,this.l10n=e.l10n||Vl,pe(this,Zo,e.enablePermissions||!1),this.pageColors=e.pageColors||null,(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&this.pageColors&&!(CSS.supports("color",this.pageColors.background)&&CSS.supports("color",this.pageColors.foreground))&&((this.pageColors.background||this.pageColors.foreground)&&console.warn("PDFViewer: Ignoring `pageColors`-option, since the browser doesn't support the values used."),this.pageColors=null),this.defaultRenderingQueue=!e.renderingQueue,this.defaultRenderingQueue?(this.renderingQueue=new Cg,this.renderingQueue.setViewer(this)):this.renderingQueue=e.renderingQueue,this.scroll=eg(this.container,this._scrollUpdate.bind(this)),this.presentationModeState=Nt.UNKNOWN,this._onBeforeDraw=this._onAfterDraw=null,this._resetView(),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&this.viewer.classList.add("removePageBorders"),H(this,el,zu).call(this)}get pagesCount(){return this._pages.length}getPageView(e){return this._pages[e]}get pageViewsReady(){return this._pagesCapability.settled?this._pages.every(function(e){return e==null?void 0:e.pdfPage}):!1}get renderForms(){return N(this,Mi)===Z.AnnotationMode.ENABLE_FORMS}get enableScripting(){return!!this._scriptingManager}get currentPageNumber(){return this._currentPageNumber}set currentPageNumber(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&(this._setCurrentPageNumber(e,!0)||console.error(`currentPageNumber: "${e}" is not a valid page.`))}_setCurrentPageNumber(e,t=!1){var i,s;if(this._currentPageNumber===e)return t&&H(this,Qo,Vu).call(this),!0;if(!(0<e&&e<=this.pagesCount))return!1;const a=this._currentPageNumber;return this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",{source:this,pageNumber:e,pageLabel:(s=(i=this._pageLabels)==null?void 0:i[e-1])!=null?s:null,previous:a}),t&&H(this,Qo,Vu).call(this),!0}get currentPageLabel(){var e,t;return(t=(e=this._pageLabels)==null?void 0:e[this._currentPageNumber-1])!=null?t:null}set currentPageLabel(e){if(!this.pdfDocument)return;let t=e|0;if(this._pageLabels){const a=this._pageLabels.indexOf(e);a>=0&&(t=a+1)}this._setCurrentPageNumber(t,!0)||console.error(`currentPageLabel: "${e}" is not a valid page.`)}get currentScale(){return this._currentScale!==Ed?this._currentScale:yd}set currentScale(e){if(isNaN(e))throw new Error("Invalid numeric scale.");this.pdfDocument&&H(this,Un,xa).call(this,e,{noScroll:!1})}get currentScaleValue(){return this._currentScaleValue}set currentScaleValue(e){this.pdfDocument&&H(this,Un,xa).call(this,e,{noScroll:!1})}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!Bl(e))throw new Error("Invalid pages rotation angle.");if(!this.pdfDocument||(e%=360,e<0&&(e+=360),this._pagesRotation===e))return;this._pagesRotation=e;const t=this._currentPageNumber;this.refresh(!0,{rotation:e}),this._currentScaleValue&&H(this,Un,xa).call(this,this._currentScaleValue,{noScroll:!0}),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:t}),this.defaultRenderingQueue&&this.update()}get firstPagePromise(){return this.pdfDocument?this._firstPageCapability.promise:null}get onePageRendered(){return this.pdfDocument?this._onePageRenderedCapability.promise:null}get pagesPromise(){return this.pdfDocument?this._pagesCapability.promise:null}setDocument(e){var o,l;if(this.pdfDocument&&(this.eventBus.dispatch("pagesdestroy",{source:this}),this._cancelRendering(),this._resetView(),(o=this.findController)==null||o.setDocument(null),(l=this._scriptingManager)==null||l.setDocument(null),N(this,Jt)&&(N(this,Jt).destroy(),pe(this,Jt,null))),this.pdfDocument=e,!e)return;const t=e.numPages,a=e.getPage(1),i=e.getOptionalContentConfig(),s=N(this,Zo)?e.getPermissions():Promise.resolve();if(t>lo.FORCE_SCROLL_MODE_PAGE){console.warn("Forcing PAGE-scrolling for performance reasons, given the length of the document.");const r=this._scrollMode=He.PAGE;this.eventBus.dispatch("scrollmodechanged",{source:this,mode:r})}this._pagesCapability.promise.then(()=>{this.eventBus.dispatch("pagesloaded",{source:this,pagesCount:t})},()=>{}),this._onBeforeDraw=r=>{const c=this._pages[r.pageNumber-1];c&&N(this,Pi).push(c)},this.eventBus._on("pagerender",this._onBeforeDraw),this._onAfterDraw=r=>{r.cssTransform||this._onePageRenderedCapability.settled||(this._onePageRenderedCapability.resolve({timestamp:r.timestamp}),this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null,N(this,wn)&&(document.removeEventListener("visibilitychange",N(this,wn)),pe(this,wn,null)))},this.eventBus._on("pagerendered",this._onAfterDraw),Promise.all([a,s]).then(([r,c])=>{if(e!==this.pdfDocument)return;this._firstPageCapability.resolve(r),this._optionalContentConfigPromise=i;const{annotationEditorMode:u,annotationMode:d,textLayerMode:f}=H(this,jr,Ab).call(this,c);if(u!==Z.AnnotationEditorType.DISABLE){const w=u;e.isPureXfa?console.warn("Warning: XFA-editing is not implemented."):Vg(w)?(pe(this,Jt,new Z.AnnotationEditorUIManager(this.container,this.eventBus,e==null?void 0:e.annotationStorage)),w!==Z.AnnotationEditorType.NONE&&N(this,Jt).updateMode(w)):console.error(`Invalid AnnotationEditor mode: ${w}`)}const g=H(this,Gr,xb).bind(this),h=this._scrollMode===He.PAGE?null:this.viewer,m=this.currentScale,b=r.getViewport({scale:m*Z.PixelsPerInch.PDF_TO_CSS_UNITS});this.viewer.style.setProperty("--scale-factor",b.scale);for(let w=1;w<=t;++w){const E=new N_({container:h,eventBus:this.eventBus,id:w,scale:m,defaultViewport:b.clone(),optionalContentConfigPromise:i,renderingQueue:this.renderingQueue,textLayerMode:f,annotationMode:d,imageResourcesPath:this.imageResourcesPath,renderer:typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")?this.renderer:null,useOnlyCssZoom:this.useOnlyCssZoom,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported,maxCanvasPixels:this.maxCanvasPixels,pageColors:this.pageColors,l10n:this.l10n,layerProperties:g});this._pages.push(E)}const y=this._pages[0];y&&(y.setPdfPage(r),this.linkService.cachePageRef(1,r.ref)),this._scrollMode===He.PAGE?H(this,Hi,rl).call(this):this._spreadMode!==ft.NONE&&this._updateSpreadMode(),H(this,Kr,Tb).call(this).then(()=>oe(this,null,function*(){var E,k;if((E=this.findController)==null||E.setDocument(e),(k=this._scriptingManager)==null||k.setDocument(e),N(this,Jt)&&this.eventBus.dispatch("annotationeditormodechanged",{source:this,mode:N(this,La)}),e.loadingParams.disableAutoFetch||t>lo.FORCE_LAZY_PAGE_INIT){this._pagesCapability.resolve();return}let w=t-1;if(w<=0){this._pagesCapability.resolve();return}for(let L=2;L<=t;++L){const v=e.getPage(L).then(A=>{const C=this._pages[L-1];C.pdfPage||C.setPdfPage(A),this.linkService.cachePageRef(L,A.ref),--w===0&&this._pagesCapability.resolve()},A=>{console.error(`Unable to get page ${L} to initialize viewer`,A),--w===0&&this._pagesCapability.resolve()});L%lo.PAUSE_EAGER_PAGE_INIT===0&&(yield v)}})),this.eventBus.dispatch("pagesinit",{source:this}),e.getMetadata().then(({info:w})=>{e===this.pdfDocument&&w.Language&&(this.viewer.lang=w.Language)}),this.defaultRenderingQueue&&this.update()}).catch(r=>{console.error("Unable to initialize viewer",r),this._pagesCapability.reject(r)})}setPageLabels(e){var t,a;if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let i=0,s=this._pages.length;i<s;i++)this._pages[i].setPageLabel((a=(t=this._pageLabels)==null?void 0:t[i])!=null?a:null)}}_resetView(){this._pages=[],this._currentPageNumber=1,this._currentScale=Ed,this._currentScaleValue=null,this._pageLabels=null,pe(this,Pi,new H_(Fg)),this._location=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._firstPageCapability=(0,Z.createPromiseCapability)(),this._onePageRenderedCapability=(0,Z.createPromiseCapability)(),this._pagesCapability=(0,Z.createPromiseCapability)(),this._scrollMode=He.VERTICAL,this._previousScrollMode=He.UNKNOWN,this._spreadMode=ft.NONE,pe(this,Ni,{previousPageNumber:1,scrollDown:!0,pages:[]}),this._onBeforeDraw&&(this.eventBus._off("pagerender",this._onBeforeDraw),this._onBeforeDraw=null),this._onAfterDraw&&(this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null),N(this,wn)&&(document.removeEventListener("visibilitychange",N(this,wn)),pe(this,wn,null)),this.viewer.textContent="",this._updateScrollMode(),this.viewer.removeAttribute("lang"),this.viewer.classList.remove(Ug)}_scrollUpdate(){this.pagesCount!==0&&this.update()}pageLabelToPageNumber(e){if(!this._pageLabels)return null;const t=this._pageLabels.indexOf(e);return t<0?null:t+1}scrollPageIntoView({pageNumber:e,destArray:t=null,allowNegativeOffset:a=!1,ignoreDestinationZoom:i=!1}){if(!this.pdfDocument)return;const s=Number.isInteger(e)&&this._pages[e-1];if(!s){console.error(`scrollPageIntoView: "${e}" is not a valid pageNumber parameter.`);return}if(this.isInPresentationMode||!t){this._setCurrentPageNumber(e,!0);return}let o=0,l=0,r=0,c=0,u,d;const f=s.rotation%180!==0,g=(f?s.height:s.width)/s.scale/Z.PixelsPerInch.PDF_TO_CSS_UNITS,h=(f?s.width:s.height)/s.scale/Z.PixelsPerInch.PDF_TO_CSS_UNITS;let m=0;switch(t[1].name){case"XYZ":o=t[2],l=t[3],m=t[4],o=o!==null?o:0,l=l!==null?l:h;break;case"Fit":case"FitB":m="page-fit";break;case"FitH":case"FitBH":l=t[2],m="page-width",l===null&&this._location?(o=this._location.left,l=this._location.top):(typeof l!="number"||l<0)&&(l=h);break;case"FitV":case"FitBV":o=t[2],r=g,c=h,m="page-height";break;case"FitR":o=t[2],l=t[3],r=t[4]-o,c=t[5]-l;let E=Xp,k=Jp;(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&(E=k=0),u=(this.container.clientWidth-E)/r/Z.PixelsPerInch.PDF_TO_CSS_UNITS,d=(this.container.clientHeight-k)/c/Z.PixelsPerInch.PDF_TO_CSS_UNITS,m=Math.min(Math.abs(u),Math.abs(d));break;default:console.error(`scrollPageIntoView: "${t[1].name}" is not a valid destination type.`);return}if(i||(m&&m!==this._currentScale?this.currentScaleValue=m:this._currentScale===Ed&&(this.currentScaleValue=io)),m==="page-fit"&&!t[4]){H(this,$s,gc).call(this,s);return}const b=[s.viewport.convertToViewportPoint(o,l),s.viewport.convertToViewportPoint(o+r,l+c)];let y=Math.min(b[0][0],b[1][0]),w=Math.min(b[0][1],b[1][1]);a||(y=Math.max(y,0),w=Math.max(w,0)),H(this,$s,gc).call(this,s,{left:y,top:w})}_updateLocation(e){const t=this._currentScale,a=this._currentScaleValue,i=parseFloat(a)===t?Math.round(t*1e4)/100:a,s=e.id,o=this._pages[s-1],l=this.container,r=o.getPagePoint(l.scrollLeft-e.x,l.scrollTop-e.y),c=Math.round(r[0]),u=Math.round(r[1]);let d=`#page=${s}`;this.isInPresentationMode||(d+=`&zoom=${i},${c},${u}`),this._location={pageNumber:s,scale:i,top:u,left:c,rotation:this._pagesRotation,pdfOpenParams:d}}update(){const e=this._getVisiblePages(),t=e.views,a=t.length;if(a===0)return;const i=Math.max(Fg,2*a+1);N(this,Pi).resize(i,e.ids),this.renderingQueue.renderHighestPriority(e);const s=this._spreadMode===ft.NONE&&(this._scrollMode===He.PAGE||this._scrollMode===He.VERTICAL),o=this._currentPageNumber;let l=!1;for(const r of t){if(r.percent<100)break;if(r.id===o&&s){l=!0;break}}this._setCurrentPageNumber(l?o:t[0].id),this._updateLocation(e.first),this.eventBus.dispatch("updateviewarea",{source:this,location:this._location})}containsElement(e){return this.container.contains(e)}focus(){this.container.focus(),this.container.parentElement.querySelector("#sidebarToggle").focus()}get _isContainerRtl(){return getComputedStyle(this.container).direction==="rtl"}get isInPresentationMode(){return this.presentationModeState===Nt.FULLSCREEN}get isChangingPresentationMode(){return this.presentationModeState===Nt.CHANGING}get isHorizontalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollWidth>this.container.clientWidth}get isVerticalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollHeight>this.container.clientHeight}_getVisiblePages(){const e=this._scrollMode===He.PAGE?N(this,Ni).pages:this._pages,t=this._scrollMode===He.HORIZONTAL,a=t&&this._isContainerRtl;return ag({scrollEl:this.container,views:e,sortByVisibility:!0,horizontal:t,rtl:a})}isPageVisible(e){return this.pdfDocument?Number.isInteger(e)&&e>0&&e<=this.pagesCount?this._getVisiblePages().ids.has(e):(console.error(`isPageVisible: "${e}" is not a valid page.`),!1):!1}isPageCached(e){if(!this.pdfDocument)return!1;if(!(Number.isInteger(e)&&e>0&&e<=this.pagesCount))return console.error(`isPageCached: "${e}" is not a valid page.`),!1;const t=this._pages[e-1];return N(this,Pi).has(t)}cleanup(){for(const e of this._pages)e.renderingState!==je.FINISHED&&e.reset()}_cancelRendering(){for(const e of this._pages)e.cancelRendering()}forceRendering(e){const t=e||this._getVisiblePages(),a=H(this,Qr,Pb).call(this,t),i=this._spreadMode!==ft.NONE&&this._scrollMode!==He.HORIZONTAL,s=this.renderingQueue.getHighestPriority(t,this._pages,a,i);return s?(H(this,Jr,$b).call(this,s).then(()=>{this.renderingQueue.renderView(s)}),!0):!1}get hasEqualPageSizes(){const e=this._pages[0];for(let t=1,a=this._pages.length;t<a;++t){const i=this._pages[t];if(i.width!==e.width||i.height!==e.height)return!1}return!0}getPagesOverview(){return this._pages.map(e=>{const t=e.pdfPage.getViewport({scale:1});return!this.enablePrintAutoRotate||Sd(t)?{width:t.width,height:t.height,rotation:t.rotation}:{width:t.height,height:t.width,rotation:(t.rotation-90)%360}})}get optionalContentConfigPromise(){return this.pdfDocument?this._optionalContentConfigPromise?this._optionalContentConfigPromise:(console.error("optionalContentConfigPromise: Not initialized yet."),this.pdfDocument.getOptionalContentConfig()):Promise.resolve(null)}set optionalContentConfigPromise(e){if(!(e instanceof Promise))throw new Error(`Invalid optionalContentConfigPromise: ${e}`);this.pdfDocument&&this._optionalContentConfigPromise&&(this._optionalContentConfigPromise=e,this.refresh(!1,{optionalContentConfigPromise:e}),this.eventBus.dispatch("optionalcontentconfigchanged",{source:this,promise:e}))}get scrollMode(){return this._scrollMode}set scrollMode(e){if(this._scrollMode!==e){if(!sg(e))throw new Error(`Invalid scroll mode: ${e}`);this.pagesCount>lo.FORCE_SCROLL_MODE_PAGE||(this._previousScrollMode=this._scrollMode,this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber))}}_updateScrollMode(e=null){const t=this._scrollMode,a=this.viewer;a.classList.toggle("scrollHorizontal",t===He.HORIZONTAL),a.classList.toggle("scrollWrapped",t===He.WRAPPED),!(!this.pdfDocument||!e)&&(t===He.PAGE?H(this,Hi,rl).call(this):this._previousScrollMode===He.PAGE&&this._updateSpreadMode(),this._currentScaleValue&&isNaN(this._currentScaleValue)&&H(this,Un,xa).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}get spreadMode(){return this._spreadMode}set spreadMode(e){if(this._spreadMode!==e){if(!og(e))throw new Error(`Invalid spread mode: ${e}`);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}_updateSpreadMode(e=null){if(!this.pdfDocument)return;const t=this.viewer,a=this._pages;if(this._scrollMode===He.PAGE)H(this,Hi,rl).call(this);else if(t.textContent="",this._spreadMode===ft.NONE)for(const i of this._pages)t.append(i.div);else{const i=this._spreadMode-1;let s=null;for(let o=0,l=a.length;o<l;++o)s===null?(s=document.createElement("div"),s.className="spread",t.append(s)):o%2===i&&(s=s.cloneNode(!1),t.append(s)),s.append(a[o].div)}e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&H(this,Un,xa).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}_getPageAdvance(e,t=!1){switch(this._scrollMode){case He.WRAPPED:{const{views:a}=this._getVisiblePages(),i=new Map;for(const{id:s,y:o,percent:l,widthPercent:r}of a){if(l===0||r<100)continue;let c=i.get(o);c||i.set(o,c||(c=[])),c.push(s)}for(const s of i.values()){const o=s.indexOf(e);if(o===-1)continue;const l=s.length;if(l===1)break;if(t)for(let r=o-1,c=0;r>=c;r--){const u=s[r],d=s[r+1]-1;if(u<d)return e-d}else for(let r=o+1,c=l;r<c;r++){const u=s[r],d=s[r-1]+1;if(u>d)return d-e}if(t){const r=s[0];if(r<e)return e-r+1}else{const r=s[l-1];if(r>e)return r-e+1}break}break}case He.HORIZONTAL:break;case He.PAGE:case He.VERTICAL:{if(this._spreadMode===ft.NONE)break;const a=this._spreadMode-1;if(t&&e%2!==a)break;if(!t&&e%2===a)break;const{views:i}=this._getVisiblePages(),s=t?e-1:e+1;for(const{id:o,percent:l,widthPercent:r}of i)if(o===s){if(l>0&&r===100)return 2;break}break}}return 1}nextPage(){const e=this._currentPageNumber,t=this.pagesCount;if(e>=t)return!1;const a=this._getPageAdvance(e,!1)||1;return this.currentPageNumber=Math.min(e+a,t),!0}previousPage(){const e=this._currentPageNumber;if(e<=1)return!1;const t=this._getPageAdvance(e,!0)||1;return this.currentPageNumber=Math.max(e-t,1),!0}increaseScale({drawingDelay:e,scaleFactor:t,steps:a}={}){if(!this.pdfDocument)return;let i=this._currentScale;if(t>1)i=Math.round(i*t*100)/100;else{a!=null||(a=1);do i=Math.ceil((i*Zp).toFixed(2)*10)/10;while(--a>0&&i<vd)}H(this,Un,xa).call(this,Math.min(vd,i),{noScroll:!1,drawingDelay:e})}decreaseScale({drawingDelay:e,scaleFactor:t,steps:a}={}){if(!this.pdfDocument)return;let i=this._currentScale;if(t>0&&t<1)i=Math.round(i*t*100)/100;else{a!=null||(a=1);do i=Math.floor((i/Zp).toFixed(2)*10)/10;while(--a>0&&i>_d)}H(this,Un,xa).call(this,Math.max(_d,i),{noScroll:!1,drawingDelay:e})}get containerTopLeft(){return N(this,Ko)||pe(this,Ko,[this.container.offsetTop,this.container.offsetLeft])}get annotationEditorMode(){return N(this,Jt)?N(this,La):Z.AnnotationEditorType.DISABLE}set annotationEditorMode(e){if(!N(this,Jt))throw new Error("The AnnotationEditor is not enabled.");if(N(this,La)!==e){if(!Vg(e))throw new Error(`Invalid AnnotationEditor mode: ${e}`);this.pdfDocument&&(pe(this,La,e),this.eventBus.dispatch("annotationeditormodechanged",{source:this,mode:e}),N(this,Jt).updateMode(e))}}set annotationEditorParams({type:e,value:t}){if(!N(this,Jt))throw new Error("The AnnotationEditor is not enabled.");N(this,Jt).updateParams(e,t)}refresh(e=!1,t=Object.create(null)){if(this.pdfDocument){for(const a of this._pages)a.update(t);N(this,Ga)!==null&&(clearTimeout(N(this,Ga)),pe(this,Ga,null)),e||this.update()}}}Pi=new WeakMap,La=new WeakMap,Jt=new WeakMap,Mi=new WeakMap,Ko=new WeakMap,Zo=new WeakMap,Xo=new WeakMap,Yr=new WeakMap,Ni=new WeakMap,wn=new WeakMap,Ga=new WeakMap,Gr=new WeakSet,xb=function(){const e=this;return{get annotationEditorUIManager(){return N(e,Jt)},get annotationStorage(){var t;return(t=e.pdfDocument)==null?void 0:t.annotationStorage},get downloadManager(){return e.downloadManager},get enableScripting(){return!!e._scriptingManager},get fieldObjectsPromise(){var t;return(t=e.pdfDocument)==null?void 0:t.getFieldObjects()},get findController(){return e.findController},get hasJSActionsPromise(){var t;return(t=e.pdfDocument)==null?void 0:t.hasJSActions()},get linkService(){return e.linkService}}},jr=new WeakSet,Ab=function(e){const t={annotationEditorMode:N(this,La),annotationMode:N(this,Mi),textLayerMode:this.textLayerMode};return e&&(e.includes(Z.PermissionFlag.COPY)||this.viewer.classList.add(Ug),e.includes(Z.PermissionFlag.MODIFY_CONTENTS)||(t.annotationEditorMode=Z.AnnotationEditorType.DISABLE),!e.includes(Z.PermissionFlag.MODIFY_ANNOTATIONS)&&!e.includes(Z.PermissionFlag.FILL_INTERACTIVE_FORMS)&&N(this,Mi)===Z.AnnotationMode.ENABLE_FORMS&&(t.annotationMode=Z.AnnotationMode.ENABLE)),t},Kr=new WeakSet,Tb=function(){if(document.visibilityState==="hidden"||!this.container.offsetParent||this._getVisiblePages().views.length===0)return Promise.resolve();const e=new Promise(t=>{pe(this,wn,()=>{document.visibilityState==="hidden"&&(t(),document.removeEventListener("visibilitychange",N(this,wn)),pe(this,wn,null))}),document.addEventListener("visibilitychange",N(this,wn))});return Promise.race([this._onePageRenderedCapability.promise,e])},Hi=new WeakSet,rl=function(){if(this._scrollMode!==He.PAGE)throw new Error("#ensurePageViewVisible: Invalid scrollMode value.");const e=this._currentPageNumber,t=N(this,Ni),a=this.viewer;if(a.textContent="",t.pages.length=0,this._spreadMode===ft.NONE&&!this.isInPresentationMode){const i=this._pages[e-1];a.append(i.div),t.pages.push(i)}else{const i=new Set,s=this._spreadMode-1;s===-1?i.add(e-1):e%2!==s?(i.add(e-1),i.add(e)):(i.add(e-2),i.add(e-1));const o=document.createElement("div");if(o.className="spread",this.isInPresentationMode){const l=document.createElement("div");l.className="dummyPage",o.append(l)}for(const l of i){const r=this._pages[l];r&&(o.append(r.div),t.pages.push(r))}a.append(o)}t.scrollDown=e>=t.previousPageNumber,t.previousPageNumber=e},$s=new WeakSet,gc=function(e,t=null){const{div:a,id:i}=e;if(this._currentPageNumber!==i&&this._setCurrentPageNumber(i),this._scrollMode===He.PAGE&&(H(this,Hi,rl).call(this),this.update()),!t&&!this.isInPresentationMode){const s=a.offsetLeft+a.clientLeft,o=s+a.clientWidth,{scrollLeft:l,clientWidth:r}=this.container;(this._scrollMode===He.HORIZONTAL||s<l||o>l+r)&&(t={left:0,top:0})}kd(a,t),!this._currentScaleValue&&this._location&&(this._location=null)},Zr=new WeakSet,Ib=function(e){return e===this._currentScale||Math.abs(e-this._currentScale)<1e-15},Jo=new WeakSet,Uu=function(e,t,{noScroll:a=!1,preset:i=!1,drawingDelay:s=-1}){if(this._currentScaleValue=t.toString(),H(this,Zr,Ib).call(this,e)){i&&this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:t});return}this.viewer.style.setProperty("--scale-factor",e*Z.PixelsPerInch.PDF_TO_CSS_UNITS);const o=s>=0&&s<1e3;if(this.refresh(!0,{scale:e,drawingDelay:o?s:-1}),o&&pe(this,Ga,setTimeout(()=>{pe(this,Ga,null),this.refresh()},s)),this._currentScale=e,!a){let l=this._currentPageNumber,r;this._location&&!(this.isInPresentationMode||this.isChangingPresentationMode)&&(l=this._location.pageNumber,r=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:l,destArray:r,allowNegativeOffset:!0})}this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:i?t:void 0}),this.defaultRenderingQueue&&this.update()},Xr=new WeakSet,Db=function(){return this._spreadMode!==ft.NONE&&this._scrollMode!==He.HORIZONTAL?2:1},Un=new WeakSet,xa=function(e,t){let a=parseFloat(e);if(a>0)t.preset=!1,H(this,Jo,Uu).call(this,a,e,t);else{const i=this._pages[this._currentPageNumber-1];if(!i)return;let s=Xp,o=Jp;this.isInPresentationMode?(s=o=4,this._spreadMode!==ft.NONE&&(s*=2)):(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.removePageBorders?s=o=0:this._scrollMode===He.HORIZONTAL&&([s,o]=[o,s]);const l=(this.container.clientWidth-s)/i.width*i.scale/N(this,Xr,Db),r=(this.container.clientHeight-o)/i.height*i.scale;switch(e){case"page-actual":a=1;break;case"page-width":a=l;break;case"page-height":a=r;break;case"page-fit":a=Math.min(l,r);break;case"auto":const c=Sd(i)?l:Math.min(r,l);a=Math.min(cy,c);break;default:console.error(`#setScale: "${e}" is an unknown zoom value.`);return}t.preset=!0,H(this,Jo,Uu).call(this,a,e,t)}},Qo=new WeakSet,Vu=function(){const e=this._pages[this._currentPageNumber-1];this.isInPresentationMode&&H(this,Un,xa).call(this,this._currentScaleValue,{noScroll:!0}),H(this,$s,gc).call(this,e)},Jr=new WeakSet,$b=function(e){return oe(this,null,function*(){var t,a;if(e.pdfPage)return e.pdfPage;try{const i=yield this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(i),(a=(t=this.linkService)._cachedPageNumber)!=null&&a.call(t,i.ref)||this.linkService.cachePageRef(e.id,i.ref),i}catch(i){return console.error("Unable to get page for page view",i),null}})},Qr=new WeakSet,Pb=function(e){var t,a;if(((t=e.first)==null?void 0:t.id)===1)return!0;if(((a=e.last)==null?void 0:a.id)===this.pagesCount)return!1;switch(this._scrollMode){case He.PAGE:return N(this,Ni).scrollDown;case He.HORIZONTAL:return this.scroll.right}return this.scroll.down},el=new WeakSet,zu=function(e=this.container.clientHeight){e!==N(this,Xo)&&(pe(this,Xo,e),Ld.setProperty("--viewer-container-height",`${e}px`))},ec=new WeakSet,Mb=function(e){for(const t of e)if(t.target===this.container){H(this,el,zu).call(this,Math.floor(t.borderBoxSize[0].blockSize)),pe(this,Ko,null);break}};class O_{constructor(e,t,a){F(this,Ps);F(this,tc);F(this,nc);F(this,ac);F(this,ic);this.toolbar=e.toolbar,this.toggleButton=e.toggleButton,this.buttons=[{element:e.presentationModeButton,eventName:"presentationmode",close:!0},{element:e.printButton,eventName:"print",close:!0},{element:e.downloadButton,eventName:"download",close:!0},{element:e.viewBookmarkButton,eventName:null,close:!0},{element:e.firstPageButton,eventName:"firstpage",close:!0},{element:e.lastPageButton,eventName:"lastpage",close:!0},{element:e.pageRotateCwButton,eventName:"rotatecw",close:!1},{element:e.pageRotateCcwButton,eventName:"rotateccw",close:!1},{element:e.cursorSelectToolButton,eventName:"switchcursortool",eventDetails:{tool:Zt.SELECT},close:!0},{element:e.cursorHandToolButton,eventName:"switchcursortool",eventDetails:{tool:Zt.HAND},close:!0},{element:e.scrollPageButton,eventName:"switchscrollmode",eventDetails:{mode:He.PAGE},close:!0},{element:e.scrollVerticalButton,eventName:"switchscrollmode",eventDetails:{mode:He.VERTICAL},close:!0},{element:e.scrollHorizontalButton,eventName:"switchscrollmode",eventDetails:{mode:He.HORIZONTAL},close:!0},{element:e.scrollWrappedButton,eventName:"switchscrollmode",eventDetails:{mode:He.WRAPPED},close:!0},{element:e.spreadNoneButton,eventName:"switchspreadmode",eventDetails:{mode:ft.NONE},close:!0},{element:e.spreadOddButton,eventName:"switchspreadmode",eventDetails:{mode:ft.ODD},close:!0},{element:e.spreadEvenButton,eventName:"switchspreadmode",eventDetails:{mode:ft.EVEN},close:!0},{element:e.documentPropertiesButton,eventName:"documentproperties",close:!0}],this.items={firstPage:e.firstPageButton,lastPage:e.lastPageButton,pageRotateCw:e.pageRotateCwButton,pageRotateCcw:e.pageRotateCcwButton},this.eventBus=t,this.externalServices=a,this.opened=!1,H(this,tc,Nb).call(this),H(this,nc,Hb).call(this,e),H(this,ac,Bb).call(this,e),H(this,ic,Ob).call(this,e),this.reset()}get isOpen(){return this.opened}setPageNumber(e){this.pageNumber=e,H(this,Ps,hc).call(this)}setPagesCount(e){this.pagesCount=e,H(this,Ps,hc).call(this)}reset(){this.pageNumber=0,this.pagesCount=0,H(this,Ps,hc).call(this),this.eventBus.dispatch("secondarytoolbarreset",{source:this})}open(){this.opened||(this.opened=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.toolbar.classList.remove("fn__hidden"))}close(){this.opened&&(this.opened=!1,this.toolbar.classList.add("fn__hidden"),this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"))}toggle(){this.opened?this.close():this.open()}}Ps=new WeakSet,hc=function(){this.items.firstPage.disabled=this.pageNumber<=1,this.items.lastPage.disabled=this.pageNumber>=this.pagesCount,this.items.pageRotateCw.disabled=this.pagesCount===0,this.items.pageRotateCcw.disabled=this.pagesCount===0},tc=new WeakSet,Nb=function(){this.toggleButton.addEventListener("click",this.toggle.bind(this));for(const{element:e,eventName:t,close:a,eventDetails:i}of this.buttons)e.addEventListener("click",s=>{t!==null&&this.eventBus.dispatch(t,na({source:this},i)),a&&this.close(),this.externalServices.reportTelemetry({type:"buttons",data:{id:e.id}})})},nc=new WeakSet,Hb=function({cursorSelectToolButton:e,cursorHandToolButton:t}){this.eventBus._on("cursortoolchanged",function({tool:a}){const i=a===Zt.SELECT,s=a===Zt.HAND;e.classList.toggle("toggled",i),t.classList.toggle("toggled",s),e.setAttribute("aria-checked",i),t.setAttribute("aria-checked",s)})},ac=new WeakSet,Bb=function({scrollPageButton:e,scrollVerticalButton:t,scrollHorizontalButton:a,scrollWrappedButton:i,spreadNoneButton:s,spreadOddButton:o,spreadEvenButton:l}){const r=({mode:c})=>{const u=c===He.PAGE,d=c===He.VERTICAL,f=c===He.HORIZONTAL,g=c===He.WRAPPED;e.classList.toggle("toggled",u),t.classList.toggle("toggled",d),a.classList.toggle("toggled",f),i.classList.toggle("toggled",g),e.setAttribute("aria-checked",u),t.setAttribute("aria-checked",d),a.setAttribute("aria-checked",f),i.setAttribute("aria-checked",g);const h=this.pagesCount>lo.FORCE_SCROLL_MODE_PAGE;e.disabled=h,t.disabled=h,a.disabled=h,i.disabled=h,s.disabled=f,o.disabled=f,l.disabled=f};this.eventBus._on("scrollmodechanged",r),this.eventBus._on("secondarytoolbarreset",c=>{c.source===this&&r({mode:He.VERTICAL})})},ic=new WeakSet,Ob=function({spreadNoneButton:e,spreadOddButton:t,spreadEvenButton:a}){function i({mode:s}){const o=s===ft.NONE,l=s===ft.ODD,r=s===ft.EVEN;e.classList.toggle("toggled",o),t.classList.toggle("toggled",l),a.classList.toggle("toggled",r),e.setAttribute("aria-checked",o),t.setAttribute("aria-checked",l),a.setAttribute("aria-checked",r)}this.eventBus._on("spreadmodechanged",i),this.eventBus._on("secondarytoolbarreset",s=>{s.source===this&&i({mode:ft.NONE})})};const R_="visiblePageIsLoading";class q_{constructor(e,t,a){F(this,sc);F(this,pu);F(this,ja);F(this,oc);F(this,tl,!1);this.toolbar=e.container,this.eventBus=t,this.l10n=a,this.buttons=[{element:e.previous,eventName:"previouspage"},{element:e.next,eventName:"nextpage"},{element:e.zoomIn,eventName:"zoomin"},{element:e.zoomOut,eventName:"zoomout"},{element:e.print,eventName:"print"},{element:e.download,eventName:"download"},{element:e.editorFreeTextButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:i}=e.editorFreeTextButton;return i.contains("toggled")?Z.AnnotationEditorType.NONE:Z.AnnotationEditorType.FREETEXT}}},{element:e.editorInkButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:i}=e.editorInkButton;return i.contains("toggled")?Z.AnnotationEditorType.NONE:Z.AnnotationEditorType.INK}}}],(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&this.buttons.push({element:e.openFile,eventName:"openfile"}),this.items={numPages:e.numPages,pageNumber:e.pageNumber,scaleSelect:e.scaleSelect,customScaleOption:e.customScaleOption,previous:e.previous,next:e.next,zoomIn:e.zoomIn,zoomOut:e.zoomOut},H(this,sc,Rb).call(this,e),this.reset()}setPageNumber(e,t){this.pageNumber=e,this.pageLabel=t,H(this,ja,Hs).call(this,!1)}setPagesCount(e,t){this.pagesCount=e,this.hasPageLabels=t,H(this,ja,Hs).call(this,!0)}setPageScale(e,t){this.pageScaleValue=(e||t).toString(),this.pageScale=t,H(this,ja,Hs).call(this,!1)}reset(){this.pageNumber=0,this.pageLabel=null,this.hasPageLabels=!1,this.pagesCount=0,this.pageScaleValue=io,this.pageScale=yd,H(this,ja,Hs).call(this,!0),this.updateLoadingIndicatorState(),this.eventBus.dispatch("toolbarreset",{source:this})}updateLoadingIndicatorState(e=!1){const{pageNumber:t}=this.items;t.classList.toggle(R_,e)}}tl=new WeakMap,sc=new WeakSet,Rb=function(e){const{pageNumber:t,scaleSelect:a}=this.items,i=this;for(const{element:s,eventName:o,eventDetails:l}of this.buttons)s.addEventListener("click",r=>{o!==null&&this.eventBus.dispatch(o,na({source:this},l))});t.addEventListener("click",function(){this.select()}),t.addEventListener("change",function(){i.eventBus.dispatch("pagenumberchanged",{source:i,value:this.value})}),a.addEventListener("change",function(){this.value!=="custom"&&i.eventBus.dispatch("scalechanged",{source:i,value:this.value})}),a.addEventListener("click",function(s){const o=s.target;this.value===i.pageScaleValue&&o.tagName.toUpperCase()==="OPTION"&&this.blur()}),a.oncontextmenu=gy,this.eventBus._on("localized",()=>{pe(this,tl,!0),H(this,oc,qb).call(this),H(this,ja,Hs).call(this,!0)})},pu=new WeakSet,GE=function({editorFreeTextButton:e,editorFreeTextParamsToolbar:t,editorInkButton:a,editorInkParamsToolbar:i}){const s=(o,l=!1)=>{const r=[{mode:Z.AnnotationEditorType.FREETEXT,button:e,toolbar:t},{mode:Z.AnnotationEditorType.INK,button:a,toolbar:i}];for(const{mode:c,button:u,toolbar:d}of r){const f=c===o.mode;u.classList.toggle("toggled",f),u.setAttribute("aria-checked",f),u.disabled=l,d==null||d.classList.toggle("fn__hidden",!f)}};this.eventBus._on("annotationeditormodechanged",s),this.eventBus._on("toolbarreset",o=>{o.source===this&&s({mode:Z.AnnotationEditorType.NONE},!0)})},ja=new WeakSet,Hs=function(e=!1){if(!N(this,tl))return;const{pageNumber:t,pagesCount:a,pageScaleValue:i,pageScale:s,items:o}=this;e&&(this.hasPageLabels?o.pageNumber.type="text":(o.pageNumber.type="number",o.numPages.textContent="/ "+a),o.pageNumber.max=a),this.hasPageLabels?(o.pageNumber.value=this.pageLabel,o.numPages.textContent=`(${t} / ${a})`):o.pageNumber.value=t,o.previous.disabled=t<=1,o.next.disabled=t>=a,o.zoomOut.disabled=s<=_d,o.zoomIn.disabled=s>=vd;let l=!1;for(const r of o.scaleSelect.options){if(r.value!==i){r.selected=!1;continue}r.selected=!0,l=!0}l||(o.customScaleOption.textContent=`${Math.round(s*1e4)/100}%`,o.customScaleOption.selected=!0)},oc=new WeakSet,qb=function(){return oe(this,null,function*(){const{items:e,l10n:t}=this,a=[window.siyuan.languages.pageScaleAuto,window.siyuan.languages.pageScaleActual,window.siyuan.languages.pageScaleFit,window.siyuan.languages.pageScaleWidth];yield lg;const i=getComputedStyle(e.scaleSelect),s=parseFloat(i.getPropertyValue("--scale-select-width")),o=document.createElement("canvas"),l=o.getContext("2d",{alpha:!1});l.font=`${i.fontSize} ${i.fontFamily}`;let r=0;for(const c of yield a){const{width:u}=l.measureText(c);u>r&&(r=u)}r+=.3*s,r>s&&e.scaleSelect.parentNode.style.setProperty("--scale-select-width",`${r}px`),o.width=0,o.height=0})};const F_=20;class U_{constructor(e,t=F_){this.fingerprint=e,this.cacheSize=t,this._initializedPromise=this._readFromStorage().then(a=>{const i=JSON.parse(a||"{}");let s=-1;if(!Array.isArray(i.files))i.files=[];else{for(;i.files.length>=this.cacheSize;)i.files.shift();for(let o=0,l=i.files.length;o<l;o++)if(i.files[o].fingerprint===this.fingerprint){s=o;break}}s===-1&&(s=i.files.push({fingerprint:this.fingerprint})-1),this.file=i.files[s],this.database=i})}_writeToStorage(){return oe(this,null,function*(){const e=JSON.stringify(this.database);if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")){sessionStorage.setItem("pdfjs.history",e);return}window.siyuan.storage["pdfjs.history"]=e,setStorageVal("pdfjs.history",e)})}_readFromStorage(){return oe(this,null,function*(){return typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")?sessionStorage.getItem("pdfjs.history"):window.siyuan.storage["pdfjs.history"]})}set(e,t){return oe(this,null,function*(){return yield this._initializedPromise,this.file[e]=t,this._writeToStorage()})}setMultiple(e){return oe(this,null,function*(){yield this._initializedPromise;for(const t in e)this.file[t]=e[t];return this._writeToStorage()})}get(e,t){return oe(this,null,function*(){yield this._initializedPromise;const a=this.file[e];return a!==void 0?a:t})}getMultiple(e){return oe(this,null,function*(){yield this._initializedPromise;const t=Object.create(null);for(const a in e){const i=this.file[a];t[a]=i!==void 0?i:e[a]}return t})}}const gu=class{constructor(){F(this,$n,Object.freeze(typeof PDFJSDev=="undefined"||!PDFJSDev.test("PRODUCTION")?Se.getAll(le.PREFERENCE):PDFJSDev.eval("DEFAULT_PREFERENCES")));F(this,yn,Object.create(null));F(this,Ka,null);if(this.constructor===gu)throw new Error("Cannot initialize BasePreferences.");typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")&&Object.defineProperty(this,"defaults",{get(){return N(this,$n)}}),pe(this,Ka,this._readFromStorage(N(this,$n)).then(e=>{for(const t in N(this,$n)){const a=e==null?void 0:e[t];typeof a==typeof N(this,$n)[t]&&(N(this,yn)[t]=a)}}))}_writeToStorage(e){return oe(this,null,function*(){throw new Error("Not implemented: _writeToStorage")})}_readFromStorage(e){return oe(this,null,function*(){throw new Error("Not implemented: _readFromStorage")})}reset(){return oe(this,null,function*(){yield N(this,Ka);const e=N(this,yn);return pe(this,yn,Object.create(null)),this._writeToStorage(N(this,$n)).catch(t=>{throw pe(this,yn,e),t})})}set(e,t){return oe(this,null,function*(){yield N(this,Ka);const a=N(this,$n)[e],i=N(this,yn);if(a===void 0)throw new Error(`Set preference: "${e}" is undefined.`);if(t===void 0)throw new Error("Set preference: no value is specified.");const s=typeof t,o=typeof a;if(s!==o)if(s==="number"&&o==="string")t=t.toString();else throw new Error(`Set preference: "${t}" is a ${s}, expected a ${o}.`);else if(s==="number"&&!Number.isInteger(t))throw new Error(`Set preference: "${t}" must be an integer.`);return N(this,yn)[e]=t,this._writeToStorage(N(this,yn)).catch(l=>{throw pe(this,yn,i),l})})}get(e){return oe(this,null,function*(){var a;yield N(this,Ka);const t=N(this,$n)[e];if(t===void 0)throw new Error(`Get preference: "${e}" is undefined.`);return(a=N(this,yn)[e])!=null?a:t})}getAll(){return oe(this,null,function*(){var t;yield N(this,Ka);const e=Object.create(null);for(const a in N(this,$n))e[a]=(t=N(this,yn)[a])!=null?t:N(this,$n)[a];return e})}};let Nd=gu;$n=new WeakMap,yn=new WeakMap,Ka=new WeakMap;var V_=Ae(916);if(typeof PDFJSDev!="undefined"&&!PDFJSDev.test("GENERIC"))throw new Error('Module "pdfjs-web/genericcom" shall not be used outside GENERIC build.');const lk={};class z_ extends Nd{_writeToStorage(e){return oe(this,null,function*(){localStorage.setItem("pdfjs.preferences",JSON.stringify(e))})}_readFromStorage(e){return oe(this,null,function*(){return JSON.parse(localStorage.getItem("pdfjs.preferences"))})}}class W_{constructor(){throw new Error("Cannot initialize DefaultExternalServices.")}static updateFindControlState(e){}static updateFindMatchesCount(e){}static initPassiveLoading(e){}static reportTelemetry(e){}static get supportsPinchToZoom(){return(0,Z.shadow)(this,"supportsPinchToZoom",!0)}static get supportsIntegratedFind(){return(0,Z.shadow)(this,"supportsIntegratedFind",!1)}static get supportsDocumentFonts(){return(0,Z.shadow)(this,"supportsDocumentFonts",!0)}static get supportedMouseWheelZoomModifierKeys(){return(0,Z.shadow)(this,"supportedMouseWheelZoomModifierKeys",{ctrlKey:!0,metaKey:!0})}static get isInAutomation(){return(0,Z.shadow)(this,"isInAutomation",!1)}static updateEditorStates(e){throw new Error("Not implemented: updateEditorStates")}static createDownloadManager(){}static createPreferences(){return new z_}static createL10n({locale:e="en-US"}){}static createScripting({sandboxBundleSrc:e}){return new V_.GenericScripting(e)}}const Y_=1e4,G_=1e3,Hd={UNKNOWN:-1,PREVIOUS:0,INITIAL:1},Bd={AUTOMATIC:0,LIGHT:1,DARK:2};class ui{constructor(e){this.pdfId=e,this.initialBookmark=document.location.hash.substring(1),this._initializedCapability=(0,Z.createPromiseCapability)(),this.appConfig=null,this.pdfDocument=null,this.pdfLoadingTask=null,this.printService=null,this.pdfViewer=null,this.pdfThumbnailViewer=null,this.pdfRenderingQueue=null,this.pdfPresentationMode=null,this.pdfDocumentProperties=null,this.pdfLinkService=null,this.pdfHistory=null,this.pdfSidebar=null,this.pdfSidebarResizer=null,this.pdfOutlineViewer=null,this.pdfAttachmentViewer=null,this.pdfLayerViewer=null,this.pdfCursorTools=null,this.pdfScriptingManager=null,this.store=null,this.downloadManager=null,this.overlayManager=null,this.preferences=null,this.toolbar=null,this.secondaryToolbar=null,this.eventBus=null,this.l10n=null,this.annotationEditorParams=null,this.isInitialViewSet=!1,this.downloadComplete=!1,this.isViewerEmbedded=!0,this.url="",this.baseUrl="",this._downloadUrl="",this.externalServices=W_,this._boundEvents=Object.create(null),this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._wheelUnusedTicks=0,this._wheelUnusedFactor=1,this._touchUnusedTicks=0,this._touchUnusedFactor=1,this._PDFBug=null,this._hasAnnotationEditors=!1,this._title=document.title,this._printAnnotationStoragePromise=null,this._touchInfo=null,this._isCtrlKeyDown=!1}initialize(e){return oe(this,null,function*(){this.preferences=this.externalServices.createPreferences(),this.appConfig=e,yield this._initializeOptions(),this._forceCssTheme(),Se.set("ignoreDestinationZoom",!0),this.isViewerEmbedded&&Se.get("externalLinkTarget")===ma.NONE&&Se.set("externalLinkTarget",ma.TOP),yield this._initializeViewerComponents(),this.bindEvents(),this.bindWindowEvents();const t=e.appContainer||document.documentElement;this.eventBus.dispatch("localized",{source:this}),this._initializedCapability.resolve()})}_initializeOptions(){return oe(this,null,function*(){if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){if(Se.get("disablePreferences")){Se.get("pdfBugEnabled")&&(yield this._parseHashParams());return}Se._hasUserOptions()&&console.warn('_initializeOptions: The Preferences may override manually set AppOptions; please use the "disablePreferences"-option in order to prevent that.')}try{Se.setAll(yield this.preferences.getAll())}catch(e){console.error(`_initializeOptions: "${e.message}".`)}Se.get("pdfBugEnabled")&&(yield this._parseHashParams())})}_parseHashParams(){return oe(this,null,function*(){const e=document.location.hash.substring(1);if(!e)return;const{mainContainer:t,viewerContainer:a}=this.appConfig,i=Nl(e);if((typeof PDFJSDev=="undefined"||!PDFJSDev.test("PRODUCTION"))&&i.get("workermodules")==="true")Se.set("workerSrc","../src/pdf.worker.js");else if(i.get("disableworker")==="true")try{yield j_()}catch(s){console.error(`_parseHashParams: "${s.message}".`)}if(i.has("disablerange")&&Se.set("disableRange",i.get("disablerange")==="true"),i.has("disablestream")&&Se.set("disableStream",i.get("disablestream")==="true"),i.has("disableautofetch")&&Se.set("disableAutoFetch",i.get("disableautofetch")==="true"),i.has("disablefontface")&&Se.set("disableFontFace",i.get("disablefontface")==="true"),i.has("disablehistory")&&Se.set("disableHistory",i.get("disablehistory")==="true"),i.has("verbosity")&&Se.set("verbosity",i.get("verbosity")|0),i.has("textlayer"))switch(i.get("textlayer")){case"off":Se.set("textLayerMode",Ml.DISABLE);break;case"visible":case"shadow":case"hover":a.classList.add(`textLayer-${i.get("textlayer")}`);try{yield zg(this),this._PDFBug.loadCSS()}catch(s){console.error(`_parseHashParams: "${s.message}".`)}break}if(i.has("pdfbug")){Se.set("pdfBug",!0),Se.set("fontExtraProperties",!0);const s=i.get("pdfbug").split(",");try{yield zg(this),this._PDFBug.init({OPS:Z.OPS},t,s)}catch(o){console.error(`_parseHashParams: "${o.message}".`)}}(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&i.has("locale")&&Se.set("locale",i.get("locale"))})}_initializeL10n(){return oe(this,null,function*(){this.l10n=this.externalServices.createL10n(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")?{locale:Se.get("locale")}:null);const e=yield this.l10n.getDirection();document.getElementsByTagName("html")[0].dir=e})}_forceCssTheme(){var t;const e=Se.get("viewerCssTheme");if(!(e===Bd.AUTOMATIC||!Object.values(Bd).includes(e)))try{const a=document.styleSheets[0],i=(a==null?void 0:a.cssRules)||[];for(let s=0,o=i.length;s<o;s++){const l=i[s];if(l instanceof CSSMediaRule&&((t=l.media)==null?void 0:t[0])==="(prefers-color-scheme: dark)"){if(e===Bd.LIGHT){a.deleteRule(s);return}const r=/^@media \(prefers-color-scheme: dark\) {\n\s*([\w\s-.,:;/\\{}()]+)\n}$/.exec(l.cssText);r!=null&&r[1]&&(a.deleteRule(s),a.insertRule(r[1],s));return}}}catch(a){console.error(`_forceCssTheme: "${a==null?void 0:a.message}".`)}}_initializeViewerComponents(){return oe(this,null,function*(){var g,h,m,b,y,w,E;const{appConfig:e,externalServices:t}=this,a=t.isInAutomation?new vy:new ql;this.eventBus=a,this.overlayManager=new ky;const i=new Cg;i.onIdle=this._cleanup.bind(this),this.pdfRenderingQueue=i;const s=new Ol({eventBus:a,externalLinkTarget:Se.get("externalLinkTarget"),externalLinkRel:Se.get("externalLinkRel"),ignoreDestinationZoom:Se.get("ignoreDestinationZoom")});this.pdfLinkService=s;const o=t.createDownloadManager();this.downloadManager=o;const l=new Xy({linkService:s,eventBus:a,updateMatchesCountOnProgress:typeof PDFJSDev=="undefined"?!window.isGECKOVIEW:!PDFJSDev.test("GECKOVIEW")});this.findController=l;const r=new u_({eventBus:a,sandboxBundleSrc:typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC || CHROME")?Se.get("sandboxBundleSrc"):null,scriptingFactory:t,docPropertiesLookup:this._scriptingDocProperties.bind(this)});this.pdfScriptingManager=r;const c=e.mainContainer,u=e.viewerContainer,d=Se.get("annotationEditorMode"),f=Se.get("forcePageColors")||window.matchMedia("(forced-colors: active)").matches?{background:Se.get("pageColorsBackground"),foreground:Se.get("pageColorsForeground")}:null;if(this.pdfViewer=new B_({container:c,viewer:u,eventBus:a,renderingQueue:i,linkService:s,downloadManager:o,findController:l,scriptingManager:Se.get("enableScripting")&&r,renderer:typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")?Se.get("renderer"):null,l10n:this.l10n,textLayerMode:Se.get("textLayerMode"),annotationMode:Se.get("annotationMode"),annotationEditorMode:d,imageResourcesPath:Se.get("imageResourcesPath"),enablePrintAutoRotate:Se.get("enablePrintAutoRotate"),useOnlyCssZoom:Se.get("useOnlyCssZoom"),isOffscreenCanvasSupported:Se.get("isOffscreenCanvasSupported"),maxCanvasPixels:Se.get("maxCanvasPixels"),enablePermissions:Se.get("enablePermissions"),pageColors:f}),i.setViewer(this.pdfViewer),s.setViewer(this.pdfViewer),r.setViewer(this.pdfViewer),(g=e.sidebar)!=null&&g.thumbnailView&&(this.pdfThumbnailViewer=new w_({container:e.sidebar.thumbnailView,renderingQueue:i,linkService:s,l10n:this.l10n,pageColors:f}),i.setThumbnailViewer(this.pdfThumbnailViewer)),!this.isViewerEmbedded&&!Se.get("disableHistory")&&(this.pdfHistory=new t_({linkService:s,eventBus:a}),s.setHistory(this.pdfHistory)),!this.supportsIntegratedFind&&e.findBar&&(this.findBar=new Qy(e.findBar,a,this.l10n)),e.annotationEditorParams)if(d!==Z.AnnotationEditorType.DISABLE)this.annotationEditorParams=new Ey(e.annotationEditorParams,a);else for(const k of["editorModeButtons","editorModeSeparator"])(h=document.getElementById(k))==null||h.classList.add("hidden");e.documentProperties&&(this.pdfDocumentProperties=new Iy(e.documentProperties,this.overlayManager,a,this.l10n,()=>this._docFilename)),(m=e.secondaryToolbar)!=null&&m.cursorHandToolButton&&(this.pdfCursorTools=new Ay({container:c,eventBus:a,cursorToolOnLoad:Se.get("cursorToolOnLoad")})),e.toolbar&&(this.toolbar=new q_(e.toolbar,a,this.l10n)),e.secondaryToolbar&&(this.secondaryToolbar=new O_(e.secondaryToolbar,a,this.externalServices)),this.supportsFullscreen&&((b=e.secondaryToolbar)!=null&&b.presentationModeButton)&&(this.pdfPresentationMode=new c_({container:c,pdfViewer:this.pdfViewer,eventBus:a})),e.passwordOverlay&&(this.passwordPrompt=new Sy(e.passwordOverlay,this.overlayManager,this.l10n,this.isViewerEmbedded)),(y=e.sidebar)!=null&&y.outlineView&&(this.pdfOutlineViewer=new s_({container:e.sidebar.outlineView,eventBus:a,linkService:s,downloadManager:o})),(w=e.sidebar)!=null&&w.attachmentsView&&(this.pdfAttachmentViewer=new Cy({container:e.sidebar.attachmentsView,eventBus:a,downloadManager:o})),(E=e.sidebar)!=null&&E.layersView&&(this.pdfLayerViewer=new i_({container:e.sidebar.layersView,eventBus:a,l10n:this.l10n})),e.sidebar&&(this.pdfSidebar=new f_({elements:e.sidebar,pdfViewer:this.pdfViewer,pdfThumbnailViewer:this.pdfThumbnailViewer,eventBus:a,l10n:this.l10n}),this.pdfSidebar.onToggled=this.forceRendering.bind(this),this.pdfSidebarResizer=new g_(e.sidebarResizer,a,this.l10n))})}run(e){this.initialize(e).then(Z_(this))}get initialized(){return this._initializedCapability.settled}get initializedPromise(){return this._initializedCapability.promise}zoomIn(e,t){this.pdfViewer.isInPresentationMode||this.pdfViewer.increaseScale({drawingDelay:Se.get("defaultZoomDelay"),steps:e,scaleFactor:t})}zoomOut(e,t){this.pdfViewer.isInPresentationMode||this.pdfViewer.decreaseScale({drawingDelay:Se.get("defaultZoomDelay"),steps:e,scaleFactor:t})}zoomReset(){this.pdfViewer.isInPresentationMode||(this.pdfViewer.currentScaleValue=io)}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfViewer.currentPageNumber}set page(e){this.pdfViewer.currentPageNumber=e}get supportsPrinting(){return Hh.instance.supportsPrinting}get supportsFullscreen(){return(0,Z.shadow)(this,"supportsFullscreen",document.fullscreenEnabled)}get supportsPinchToZoom(){return this.externalServices.supportsPinchToZoom}get supportsIntegratedFind(){return this.externalServices.supportsIntegratedFind}get supportsDocumentFonts(){return this.externalServices.supportsDocumentFonts}get loadingBar(){const e=new by(this.appConfig.appContainer.querySelector("#loadingBar"));return(0,Z.shadow)(this,"loadingBar",e)}get supportedMouseWheelZoomModifierKeys(){return this.externalServices.supportedMouseWheelZoomModifierKeys}initPassiveLoading(){if(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL || CHROME"))throw new Error("Not implemented: initPassiveLoading");this.externalServices.initPassiveLoading({onOpenWithTransport:e=>{this.open({range:e})},onOpenWithData:(e,t)=>{(0,Z.isPdfFile)(t)&&(this._contentDispositionFilename=t),this.open({data:e})},onOpenWithURL:(e,t,a)=>{this.open({url:e,length:t,originalUrl:a})},onError:e=>{this.l10n.get("loading_error").then(t=>{this._documentError(t,e)})},onProgress:(e,t)=>{this.progress(e/t)}})}setTitleUsingUrl(e="",t=null){this.url=e,this.baseUrl=e.split("#")[0],t&&(this._downloadUrl=t===e?this.baseUrl:t.split("#")[0]),(0,Z.isDataScheme)(e)&&this._hideViewBookmark();let a=(0,Z.getPdfFilenameFromUrl)(e,"");if(!a)try{a=decodeURIComponent((0,Z.getFilenameFromUrl)(e))||e}catch(i){a=e}this.setTitle(a)}setTitle(e=this._title){if(this._title=e,this.isViewerEmbedded)return;const t=this._hasAnnotationEditors&&!this.pdfRenderingQueue.printing;document.title=`${t?"* ":""}${e}`}get _docFilename(){return this._contentDispositionFilename||(0,Z.getPdfFilenameFromUrl)(this.url)}_hideViewBookmark(){var t;const{secondaryToolbar:e}=this.appConfig;e==null||e.viewBookmarkButton.classList.add("fn__hidden"),e!=null&&e.presentationModeButton.classList.contains("fn__hidden")&&((t=document.getElementById("viewBookmarkSeparator"))==null||t.classList.add("fn__hidden"))}close(){return oe(this,null,function*(){var t,a,i,s,o,l,r,c,u,d,f,g;if(this._unblockDocumentLoadEvent(),this._hideViewBookmark(),!this.pdfLoadingTask)return;if((typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&((t=this.pdfDocument)==null?void 0:t.annotationStorage.size)>0&&this._annotationStorageModified)try{yield this.save()}catch(h){}const e=[];e.push(this.pdfLoadingTask.destroy()),this.pdfLoadingTask=null,this.pdfDocument&&(this.pdfDocument=null,(a=this.pdfThumbnailViewer)==null||a.setDocument(null),this.pdfViewer.setDocument(null),this.pdfLinkService.setDocument(null),(i=this.pdfDocumentProperties)==null||i.setDocument(null)),this.pdfLinkService.externalLinkEnabled=!0,this.store=null,this.isInitialViewSet=!1,this.downloadComplete=!1,this.url="",this.baseUrl="",this._downloadUrl="",this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._hasAnnotationEditors=!1,e.push(this.pdfScriptingManager.destroyPromise),this.setTitle(),(s=this.pdfSidebar)==null||s.reset(),(o=this.pdfOutlineViewer)==null||o.reset(),(l=this.pdfAttachmentViewer)==null||l.reset(),(r=this.pdfLayerViewer)==null||r.reset(),(c=this.pdfHistory)==null||c.reset(),(u=this.findBar)==null||u.reset(),(d=this.toolbar)==null||d.reset(),(f=this.secondaryToolbar)==null||f.reset(),(g=this._PDFBug)==null||g.cleanup(),yield Promise.all(e)})}open(e){return oe(this,null,function*(){if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")){let o=!1;typeof e=="string"?(e={url:e},o=!0):e!=null&&e.byteLength&&(e={data:e},o=!0),o&&console.error("The `PDFViewerApplication.open` signature was updated, please use an object instead.")}this.pdfLoadingTask&&(yield this.close());const t=Se.getAll(le.WORKER);Object.assign(Z.GlobalWorkerOptions,t),(typeof PDFJSDev=="undefined"||!PDFJSDev.test("MOZCENTRAL"))&&e.url&&this.setTitleUsingUrl(e.originalUrl||e.url,e.url);const a=Se.getAll(le.API),i=na(na({canvasMaxAreaInBytes:this.externalServices.canvasMaxAreaInBytes},a),e);typeof PDFJSDev=="undefined"||!PDFJSDev.test("PRODUCTION")||PDFJSDev.test("MOZCENTRAL || CHROME")&&(i.docBaseUrl||(i.docBaseUrl=this.baseUrl));const s=(0,Z.getDocument)(i);return this.pdfLoadingTask=s,s.onPassword=(o,l)=>{this.isViewerEmbedded&&this._unblockDocumentLoadEvent(),this.pdfLinkService.externalLinkEnabled=!1,this.passwordPrompt.setUpdateCallback(o,l),this.passwordPrompt.open()},s.onProgress=({loaded:o,total:l})=>{this.progress(o/l)},s.promise.then(o=>{this.load(o)},o=>{if(s!==this.pdfLoadingTask)return;let l="loadingError";throw o instanceof Z.InvalidPDFException?l="invalidFileError":o instanceof Z.MissingPDFException?l="missingFileError":o instanceof Z.UnexpectedResponseException&&(l="unexpectedResponseError"),this._documentError(window.siyuan.languages[l],{message:o==null?void 0:o.message}),o})})}_ensureDownloadComplete(){if(!(this.pdfDocument&&this.downloadComplete))throw new Error("PDF document not downloaded.")}download(){return oe(this,null,function*(){const e=this._downloadUrl,t=this._docFilename;try{this._ensureDownloadComplete();const a=yield this.pdfDocument.getData(),i=new Blob([a],{type:"application/pdf"});yield this.downloadManager.download(i,e,t)}catch(a){yield this.downloadManager.downloadUrl(e,t)}})}save(){return oe(this,null,function*(){if(this._saveInProgress)return;this._saveInProgress=!0,yield this.pdfScriptingManager.dispatchWillSave();const e=this._downloadUrl,t=this._docFilename;try{this._ensureDownloadComplete();const a=yield this.pdfDocument.saveDocument(),i=new Blob([a],{type:"application/pdf"});yield this.downloadManager.download(i,e,t)}catch(a){console.error(`Error when saving the document: ${a.message}`),yield this.download()}finally{yield this.pdfScriptingManager.dispatchDidSave(),this._saveInProgress=!1}this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"save"}})})}downloadOrSave(){var e;((e=this.pdfDocument)==null?void 0:e.annotationStorage.size)>0?this.save():this.download()}_documentError(e,t=null){var a;this._unblockDocumentLoadEvent(),this._otherError(e,t),this.eventBus.dispatch("documenterror",{source:this,message:e,reason:(a=t==null?void 0:t.message)!=null?a:null})}_otherError(e,t=null){const a=[`PDF.js v${Z.version||"?"} (build: ${Z.build||"?"})`];t&&(a.push(`Message: ${t.message}`),t.stack?a.push(`Stack: ${t.stack}`):(t.filename&&a.push(`File: ${t.filename}`),t.lineNumber&&a.push(`Line: ${t.lineNumber}`))),console.error(`${e}

${a.join(`
`)}`)}progress(e){var a,i;if(!this.loadingBar||this.downloadComplete)return;const t=Math.round(e*100);t<=this.loadingBar.percent||(this.loadingBar.percent=t,((i=(a=this.pdfDocument)==null?void 0:a.loadingParams.disableAutoFetch)!=null?i:Se.get("disableAutoFetch"))&&this.loadingBar.setDisableAutoFetch())}load(e){var u,d,f,g;this.pdfDocument=e,e.getDownloadInfo().then(({length:h})=>{var m;this._contentLength=h,this.downloadComplete=!0,(m=this.loadingBar)==null||m.hide(),o.then(()=>{this.eventBus.dispatch("documentloaded",{source:this})})});const t=e.getPageLayout().catch(function(){}),a=e.getPageMode().catch(function(){}),i=e.getOpenAction().catch(function(){});if((u=this.toolbar)==null||u.setPagesCount(e.numPages,!1),(d=this.secondaryToolbar)==null||d.setPagesCount(e.numPages),typeof PDFJSDev!="undefined"&&PDFJSDev.test("CHROME")){const h=location.href.split("#")[0];this.pdfLinkService.setDocument(e,(0,Z.isDataScheme)(h)?null:h)}else this.pdfLinkService.setDocument(e);(f=this.pdfDocumentProperties)==null||f.setDocument(e);const s=this.pdfViewer;s.setDocument(e);const{firstPagePromise:o,onePageRendered:l,pagesPromise:r}=s;(g=this.pdfThumbnailViewer)==null||g.setDocument(e);const c=(this.store=new U_(e.fingerprints[0])).getMultiple({page:null,zoom:io,scrollLeft:"0",scrollTop:"0",rotation:null,sidebarView:Fe.UNKNOWN,scrollMode:He.UNKNOWN,spreadMode:ft.UNKNOWN}).catch(()=>Object.create(null));o.then(h=>{var m;(m=this.loadingBar)==null||m.setWidth(this.appConfig.viewerContainer),this._initializeAnnotationStorageCallbacks(e),Promise.all([lg,c,t,a,i]).then(L=>oe(this,[L],function*([b,y,w,E,k]){const v=Se.get("viewOnLoad");this._initializePdfHistory({fingerprint:e.fingerprints[0],viewOnLoad:v,initialDest:k==null?void 0:k.dest});const A=this.initialBookmark,C=Se.get("defaultZoomValue");let D=C?`zoom=${C}`:null,x=null,P=Se.get("sidebarViewOnLoad"),B=Se.get("scrollModeOnLoad"),V=Se.get("spreadModeOnLoad");y.page=this.pdfId||y.page,y.page&&v!==Hd.INITIAL&&(D=`page=${y.page}&zoom=${C||y.zoom},${y.scrollLeft},${y.scrollTop}`,x=parseInt(y.rotation,10),P===Fe.UNKNOWN&&(P=y.sidebarView|0),B===He.UNKNOWN&&(B=y.scrollMode|0),V===ft.UNKNOWN&&(V=y.spreadMode|0)),D.indexOf("page=")===-1&&this.pdfId&&(D+=`&page=${this.pdfId}`),(typeof PDFJSDev=="undefined"?!window.isGECKOVIEW:!PDFJSDev.test("GECKOVIEW"))&&(E&&P===Fe.UNKNOWN&&(P=yy(E)),w&&B===He.UNKNOWN&&V===ft.UNKNOWN&&(V=rg(w).spreadMode)),this.setInitialView(D,{rotation:x,sidebarView:P,scrollMode:B,spreadMode:V}),this.eventBus.dispatch("documentinit",{source:this}),this.isViewerEmbedded||s.focus(),yield Promise.race([r,new Promise(X=>{setTimeout(X,Y_)})]),!(!A&&!D)&&(s.hasEqualPageSizes||(this.initialBookmark=A,s.currentScaleValue=s.currentScaleValue,this.setInitialView(D)))})).catch(()=>{this.setInitialView()}).then(function(){s.update();const b=$(s.container,"fn__flex-1");b&&b.removeAttribute("data-loading")})}),r.then(()=>{this._unblockDocumentLoadEvent(),this._initializeAutoPrint(e,i)},h=>{this.l10n.get("loading_error").then(m=>{this._documentError(m,{message:h==null?void 0:h.message})})}),l.then(h=>{this.externalServices.reportTelemetry({type:"pageInfo",timestamp:h.timestamp}),this.pdfOutlineViewer&&e.getOutline().then(m=>{e===this.pdfDocument&&this.pdfOutlineViewer.render({outline:m,pdfDocument:e})}),this.pdfAttachmentViewer&&e.getAttachments().then(m=>{e===this.pdfDocument&&this.pdfAttachmentViewer.render({attachments:m})}),this.pdfLayerViewer&&s.optionalContentConfigPromise.then(m=>{e===this.pdfDocument&&this.pdfLayerViewer.render({optionalContentConfig:m,pdfDocument:e})})}),this._initializePageLabels(e),this._initializeMetadata(e)}_scriptingDocProperties(e){return oe(this,null,function*(){var t,a;return!this.documentInfo&&(yield new Promise(i=>{this.eventBus._on("metadataloaded",i,{once:!0})}),e!==this.pdfDocument)||!this._contentLength&&(yield new Promise(i=>{this.eventBus._on("documentloaded",i,{once:!0})}),e!==this.pdfDocument)?null:lc(na({},this.documentInfo),{baseURL:this.baseUrl,filesize:this._contentLength,filename:this._docFilename,metadata:(t=this.metadata)==null?void 0:t.getRaw(),authors:(a=this.metadata)==null?void 0:a.get("dc:creator"),numPages:this.pagesCount,URL:this.url})})}_initializeAutoPrint(e,t){return oe(this,null,function*(){const[a,i]=yield Promise.all([t,this.pdfViewer.enableScripting?null:e.getJavaScript()]);if(e!==this.pdfDocument)return;let s=!1;if((a==null?void 0:a.action)==="Print"&&(s=!0),i&&(i.some(o=>o?(console.warn("Warning: JavaScript support is not enabled"),!0):!1),!s)){for(const o of i)if(o&&dy.test(o)){s=!0;break}}s&&this.triggerPrinting()})}_initializeMetadata(e){return oe(this,null,function*(){var r,c;const{info:t,metadata:a,contentDispositionFilename:i,contentLength:s}=yield e.getMetadata();if(e!==this.pdfDocument)return;this.documentInfo=t,this.metadata=a,(r=this._contentDispositionFilename)!=null||(this._contentDispositionFilename=i),(c=this._contentLength)!=null||(this._contentLength=s);let o=t.Title;const l=a==null?void 0:a.get("dc:title");l&&l!=="Untitled"&&!/[\uFFF0-\uFFFF]/g.test(l)&&(o=l),o?this.setTitle(`${o} - ${this._contentDispositionFilename||this._title}`):this._contentDispositionFilename&&this.setTitle(this._contentDispositionFilename),t.IsXFAPresent&&!t.IsAcroFormPresent&&!e.isPureXfa?e.loadingParams.enableXfa?console.warn("Warning: XFA Foreground documents are not supported"):console.warn("Warning: XFA support is not enabled"):(t.IsAcroFormPresent||t.IsXFAPresent)&&!this.pdfViewer.renderForms&&console.warn("Warning: Interactive form support is not enabled"),t.IsSignaturesPresent&&console.warn("Warning: Digital signatures validation is not supported"),this.eventBus.dispatch("metadataloaded",{source:this})})}_initializePageLabels(e){return oe(this,null,function*(){if(typeof PDFJSDev=="undefined"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))return;const t=yield e.getPageLabels();if(e!==this.pdfDocument||!t||Se.get("disablePageLabels"))return;const a=t.length;let i=0,s=0;for(let c=0;c<a;c++){const u=t[c];if(u===(c+1).toString())i++;else if(u==="")s++;else break}if(i>=a||s>=a)return;const{pdfViewer:o,pdfThumbnailViewer:l,toolbar:r}=this;o.setPageLabels(t),l==null||l.setPageLabels(t),r==null||r.setPagesCount(a,!0),r==null||r.setPageNumber(o.currentPageNumber,o.currentPageLabel)})}_initializePdfHistory({fingerprint:e,viewOnLoad:t,initialDest:a=null}){this.pdfHistory&&(this.pdfHistory.initialize({fingerprint:e,resetHistory:t===Hd.INITIAL,updateUrl:Se.get("historyUpdateUrl")}),this.pdfHistory.initialBookmark&&(this.initialBookmark=this.pdfHistory.initialBookmark,this.initialRotation=this.pdfHistory.initialRotation),a&&!this.initialBookmark&&t===Hd.UNKNOWN&&(this.initialBookmark=JSON.stringify(a),this.pdfHistory.push({explicitDest:a,pageNumber:null})))}_initializeAnnotationStorageCallbacks(e){if(e!==this.pdfDocument)return;const{annotationStorage:t}=e;t.onSetModified=()=>{(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(this._annotationStorageModified=!0)},t.onResetModified=()=>{(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&delete this._annotationStorageModified},t.onAnnotationEditor=a=>{this._hasAnnotationEditors=!!a,this.setTitle(),a&&this.externalServices.reportTelemetry({type:"editing",data:{type:a}})}}setInitialView(e,{rotation:t,sidebarView:a,scrollMode:i,spreadMode:s}={}){var r,c,u;const o=d=>{Bl(d)&&(this.pdfViewer.pagesRotation=d)},l=(d,f)=>{sg(d)&&(this.pdfViewer.scrollMode=d),og(f)&&(this.pdfViewer.spreadMode=f)};this.isInitialViewSet=!0,(r=this.pdfSidebar)==null||r.setInitialView(a),l(i,s),this.initialBookmark?(o(this.initialRotation),delete this.initialRotation,this.pdfLinkService.setHash(this.initialBookmark),this.initialBookmark=null):e&&(o(t),this.pdfLinkService.setHash(e)),(c=this.toolbar)==null||c.setPageNumber(this.pdfViewer.currentPageNumber,this.pdfViewer.currentPageLabel),(u=this.secondaryToolbar)==null||u.setPageNumber(this.pdfViewer.currentPageNumber),this.pdfViewer.currentScaleValue||(this.pdfViewer.currentScaleValue=io)}_cleanup(){var e;this.pdfDocument&&(this.pdfViewer.cleanup(),(e=this.pdfThumbnailViewer)==null||e.cleanup(),!this.pdfLoadingTask.destroyed&&(typeof PDFJSDev=="undefined"||PDFJSDev.test("!PRODUCTION || GENERIC")?this.pdfDocument.cleanup(this.pdfViewer.renderer===Pl.SVG):this.pdfDocument.cleanup()))}forceRendering(){var e;this.pdfRenderingQueue.printing=!!this.printService,this.pdfRenderingQueue.isThumbnailViewEnabled=((e=this.pdfSidebar)==null?void 0:e.visibleView)===Fe.THUMBS,this.pdfRenderingQueue.renderHighestPriority()}beforePrint(){if(this._printAnnotationStoragePromise=this.pdfScriptingManager.dispatchWillPrint().catch(()=>{}).then(()=>{var o;return(o=this.pdfDocument)==null?void 0:o.annotationStorage.print}),this.printService)return;if(!this.supportsPrinting){this._otherError(window.siyuan.languages.printingNotSupported);return}if(!this.pdfViewer.pageViewsReady){window.alert(window.siyuan.languages.printingNotReady);return}const e=this.pdfViewer.getPagesOverview(),t=this.appConfig.printContainer,a=Se.get("printResolution"),i=this.pdfViewer.optionalContentConfigPromise,s=Hh.instance.createPrintService(this.pdfDocument,e,t,a,i,this._printAnnotationStoragePromise,this.l10n);this.printService=s,this.forceRendering(),this.setTitle(),s.layout(),this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"print"}})}afterPrint(){var e;this._printAnnotationStoragePromise&&(this._printAnnotationStoragePromise.then(()=>{this.pdfScriptingManager.dispatchDidPrint()}),this._printAnnotationStoragePromise=null),this.printService&&(this.printService.destroy(),this.printService=null,(e=this.pdfDocument)==null||e.annotationStorage.resetModified()),this.forceRendering(),this.setTitle()}rotatePages(e){this.pdfViewer.pagesRotation+=e}requestPresentationMode(){var e;(e=this.pdfPresentationMode)==null||e.request()}triggerPrinting(){this.supportsPrinting&&window.print()}bindEvents(){const{eventBus:e,_boundEvents:t}=this;t.beforePrint=this.beforePrint.bind(this),t.afterPrint=this.afterPrint.bind(this),e._on("resize",eh),e._on("hashchange",th),e._on("beforeprint",t.beforePrint),e._on("afterprint",t.afterPrint),e._on("pagerender",Wg),e._on("pagerendered",Yg),e._on("updateviewarea",Xg),e._on("pagechanging",Ch),e._on("scalechanging",Sh),e._on("rotationchanging",Lh),e._on("sidebarviewchanged",Zg),e._on("pagemode",Gg),e._on("namedaction",jg),e._on("presentationmodechanged",Kg),e._on("presentationmode",ih),e._on("switchannotationeditormode",X_),e._on("switchannotationeditorparams",J_),e._on("print",sh),e._on("download",oh),e._on("firstpage",lh),e._on("lastpage",rh),e._on("nextpage",ch),e._on("previouspage",dh),e._on("zoomin",uh),e._on("zoomout",fh),e._on("zoomreset",ph),e._on("pagenumberchanged",Gl),e._on("scalechanged",gh),e._on("rotatecw",hh),e._on("rotateccw",mh),e._on("optionalcontentconfig",bh),e._on("switchscrollmode",wh),e._on("scrollmodechanged",Jg),e._on("switchspreadmode",yh),e._on("spreadmodechanged",Qg),e._on("documentproperties",_h),e._on("findfromurlhash",vh),e._on("updatefindmatchescount",Eh),e._on("updatefindcontrolstate",kh),Se.get("pdfBug")&&(t.reportPageStatsPDFBug=K_,e._on("pagerendered",t.reportPageStatsPDFBug),e._on("pagechanging",t.reportPageStatsPDFBug)),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(e._on("fileinputchange",nh),e._on("openfile",ah)),typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")&&e._on("annotationeditorstateschanged",ev)}bindWindowEvents(){const{eventBus:e,_boundEvents:t}=this;function a(i=null){i&&Q_(i);const s=window.matchMedia(`(resolution: ${window.devicePixelRatio||1}dppx)`);s.addEventListener("change",a,{once:!0}),!(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL"))&&(t.removeWindowResolutionChange||(t.removeWindowResolutionChange=function(){s.removeEventListener("change",a),t.removeWindowResolutionChange=null}))}a(),t.windowResize=()=>{e.dispatch("resize",{source:window})},t.windowHashChange=()=>{e.dispatch("hashchange",{source:window,hash:document.location.hash.substring(1)})},t.windowBeforePrint=()=>{e.dispatch("beforeprint",{source:window})},t.windowAfterPrint=()=>{e.dispatch("afterprint",{source:window})},t.windowUpdateFromSandbox=i=>{e.dispatch("updatefromsandbox",{source:window,detail:i.detail})},window.addEventListener("visibilitychange",xh),window.addEventListener("wheel",Th,{passive:!1}),window.addEventListener("touchstart",Ih,{passive:!1}),window.addEventListener("touchmove",Dh,{passive:!1}),window.addEventListener("touchend",$h,{passive:!1}),window.addEventListener("click",Ph),window.addEventListener("keydown",Nh),window.addEventListener("keyup",Mh),window.addEventListener("resize",t.windowResize),window.addEventListener("hashchange",t.windowHashChange),window.addEventListener("beforeprint",t.windowBeforePrint),window.addEventListener("afterprint",t.windowAfterPrint),window.addEventListener("updatefromsandbox",t.windowUpdateFromSandbox)}unbindEvents(){if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: unbindEvents");const{eventBus:e,_boundEvents:t}=this;e._off("resize",eh),e._off("hashchange",th),e._off("beforeprint",t.beforePrint),e._off("afterprint",t.afterPrint),e._off("pagerender",Wg),e._off("pagerendered",Yg),e._off("updateviewarea",Xg),e._off("pagechanging",Ch),e._off("scalechanging",Sh),e._off("rotationchanging",Lh),e._off("sidebarviewchanged",Zg),e._off("pagemode",Gg),e._off("namedaction",jg),e._off("presentationmodechanged",Kg),e._off("presentationmode",ih),e._off("print",sh),e._off("download",oh),e._off("firstpage",lh),e._off("lastpage",rh),e._off("nextpage",ch),e._off("previouspage",dh),e._off("zoomin",uh),e._off("zoomout",fh),e._off("zoomreset",ph),e._off("pagenumberchanged",Gl),e._off("scalechanged",gh),e._off("rotatecw",hh),e._off("rotateccw",mh),e._off("optionalcontentconfig",bh),e._off("switchscrollmode",wh),e._off("scrollmodechanged",Jg),e._off("switchspreadmode",yh),e._off("spreadmodechanged",Qg),e._off("documentproperties",_h),e._off("findfromurlhash",vh),e._off("updatefindmatchescount",Eh),e._off("updatefindcontrolstate",kh),t.reportPageStatsPDFBug&&(e._off("pagerendered",t.reportPageStatsPDFBug),e._off("pagechanging",t.reportPageStatsPDFBug),t.reportPageStatsPDFBug=null),(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))&&(e._off("fileinputchange",nh),e._off("openfile",ah)),t.beforePrint=null,t.afterPrint=null}unbindWindowEvents(){var t;if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: unbindWindowEvents");const{_boundEvents:e}=this;window.removeEventListener("visibilitychange",xh),window.removeEventListener("wheel",Th,{passive:!1}),window.removeEventListener("touchstart",Ih,{passive:!1}),window.removeEventListener("touchmove",Dh,{passive:!1}),window.removeEventListener("touchend",$h,{passive:!1}),window.removeEventListener("click",Ph),window.removeEventListener("keydown",Nh),window.removeEventListener("keyup",Mh),window.removeEventListener("resize",e.windowResize),window.removeEventListener("hashchange",e.windowHashChange),window.removeEventListener("beforeprint",e.windowBeforePrint),window.removeEventListener("afterprint",e.windowAfterPrint),window.removeEventListener("updatefromsandbox",e.windowUpdateFromSandbox),(t=e.removeWindowResolutionChange)==null||t.call(e),e.windowResize=null,e.windowHashChange=null,e.windowBeforePrint=null,e.windowAfterPrint=null,e.windowUpdateFromSandbox=null}_accumulateTicks(e,t){(this[t]>0&&e<0||this[t]<0&&e>0)&&(this[t]=0),this[t]+=e;const a=Math.trunc(this[t]);return this[t]-=a,a}_accumulateFactor(e,t,a){if(t===1)return 1;(this[a]>1&&t<1||this[a]<1&&t>1)&&(this[a]=1);const i=Math.floor(e*t*this[a]*100)/(100*e);return this[a]=t/i,i}_centerAtPos(e,t,a){const{pdfViewer:i}=this,s=i.currentScale/e-1;if(s!==0){const[o,l]=i.containerTopLeft;i.container.scrollLeft+=(t-l)*s,i.container.scrollTop+=(a-o)*s}}_unblockDocumentLoadEvent(){var e;(e=document.blockUnblockOnload)==null||e.call(document,!1),this._unblockDocumentLoadEvent=()=>{}}get scriptingReady(){return this.pdfScriptingManager.ready}}if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))var rk=function(e){if(e)try{const t=new URL(window.location.href).origin||"null";if(null.includes(t))return;if(new URL(e,window.location.href).origin!==t)throw new Error("file origin does not match viewer's")}catch(t){throw console.log(window.siyuan.languages.loadingError,t.message),t}};function j_(){return oe(this,null,function*(){var n;if((n=Z.GlobalWorkerOptions).workerSrc||(n.workerSrc=Se.get("workerSrc")),typeof PDFJSDev=="undefined"||!PDFJSDev.test("PRODUCTION")){window.pdfjsWorker=yield Ae(917)(`${Constants.PROTYLE_CDN}/js/pdf/pdf.worker.js`);return}yield(0,Z.loadScript)(Z.PDFWorker.workerSrc)})}function zg(n){return oe(this,null,function*(){})}function K_({pageNumber:n}){}function Z_(n){var i,s,o,l;const{appConfig:e,eventBus:t}=n,a=e.file;n.supportsDocumentFonts||(Se.set("disableFontFace",!0),console.warn("Web fonts are disabled: unable to use embedded PDF fonts.")),n.supportsPrinting||((i=e.toolbar)==null||i.print.classList.add("fn__hidden"),(s=e.secondaryToolbar)==null||s.printButton.classList.add("fn__hidden")),n.supportsFullscreen||(o=e.secondaryToolbar)==null||o.presentationModeButton.classList.add("fn__hidden"),n.supportsIntegratedFind&&((l=e.toolbar)==null||l.viewFind.classList.add("fn__hidden")),e.mainContainer.addEventListener("transitionend",function(r){r.target===this&&n.eventBus.dispatch("resize",{source:this})},!0);try{if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))a?n.open({url:a}):n._hideViewBookmark();else if(PDFJSDev.test("MOZCENTRAL || CHROME"))n.setTitleUsingUrl(a,a),n.initPassiveLoading();else throw new Error("Not implemented: webViewerInitialized")}catch(r){n._documentError(window.siyuan.languages.loadingError,r)}}function Wg({pageNumber:n,source:e}){var a;const t=Re(e.div);t&&n===t.page&&((a=t.toolbar)==null||a.updateLoadingIndicatorState(!0))}function Yg({pageNumber:n,error:e,source:t}){var i,s,o;const a=Re(t.div);if(a){if(n===a.page&&((i=a.toolbar)==null||i.updateLoadingIndicatorState(!1)),((s=a.pdfSidebar)==null?void 0:s.visibleView)===Fe.THUMBS){const l=a.pdfViewer.getPageView(n-1),r=(o=a.pdfThumbnailViewer)==null?void 0:o.getThumbnail(n-1);l&&r&&r.setImage(l)}e&&a._otherError("An error occurred while rendering the page.",e)}}function Gg({mode:n,source:e}){var i;const t=Re(e.externalLinkTarget);if(!t)return;let a;switch(n){case"thumbs":a=Fe.THUMBS;break;case"bookmarks":case"outline":a=Fe.OUTLINE;break;case"attachments":a=Fe.ATTACHMENTS;break;case"layers":a=Fe.LAYERS;break;case"none":a=Fe.NONE;break;default:console.error('Invalid "pagemode" hash parameter: '+n);return}(i=t.pdfSidebar)==null||i.switchView(a,!0)}function jg(n){var t;const e=Re(n.source.externalLinkTarget);if(e)switch(n.action){case"GoToPage":(t=e.appConfig.toolbar)==null||t.pageNumber.select();break;case"Find":e.supportsIntegratedFind||e==null||e.findBar.toggle();break;case"Print":e.triggerPrinting();break;case"SaveAs":e.downloadOrSave();break}}function Kg(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.presentationModeState=n.state)}function Zg({view:n,source:e}){var a;const t=Re(e.outerContainer);t&&(t.pdfRenderingQueue.isThumbnailViewEnabled=n===Fe.THUMBS,t.isInitialViewSet&&((a=t.store)==null||a.set("sidebarView",n).catch(()=>{})))}function Xg({location:n,source:e}){var a;const t=Re(e.container);if(t&&(t.isInitialViewSet&&((a=t.store)==null||a.setMultiple({page:n.pageNumber,zoom:n.scale,scrollLeft:n.left,scrollTop:n.top,rotation:n.rotation}).catch(()=>{})),t.appConfig.secondaryToolbar)){const i=t.pdfLinkService.getAnchorUrl(n.pdfOpenParams);t.appConfig.secondaryToolbar.viewBookmarkButton.href=i}}function Jg(n){var t;const e=Re(n.source.container);e&&e.isInitialViewSet&&!e.pdfViewer.isInPresentationMode&&((t=e.store)==null||t.set("scrollMode",n.mode).catch(()=>{}))}function Qg(n){var t;const e=Re(n.source.container);e&&e.isInitialViewSet&&!e.pdfViewer.isInPresentationMode&&((t=e.store)==null||t.set("spreadMode",n.mode).catch(()=>{}))}function eh(){}function th(n){}if(typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC"))var nh=function(n){var t;if((t=ui.pdfViewer)!=null&&t.isInPresentationMode)return;const e=n.fileInput.files[0];ui.open({url:URL.createObjectURL(e),originalUrl:e.name})},ah=function(n){ui.appConfig.openFileInput.click()};function ih({source:n}){const e=Re(n.toolbar);e&&e.requestPresentationMode()}function X_(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.annotationEditorMode=n.mode)}function J_(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.annotationEditorParams=n)}function sh(n){const e=Re(n.source.toolbar);e&&e.triggerPrinting()}function oh(n){const e=Re(n.source.toolbar);e&&e.downloadOrSave()}function lh(n){const e=Re(n.source.toolbar);e&&(e.page=1)}function rh(n){const e=Re(n.source.toolbar);e&&(e.page=e.pagesCount)}function ch(n){const e=Re(n.source.toolbar);e&&e.pdfViewer.nextPage()}function dh(n){const e=Re(n.source.toolbar);e&&e.pdfViewer.previousPage()}function uh(n){const e=Re(n.source.toolbar);e&&e.zoomIn()}function fh(n){const e=Re(n.source.toolbar);e&&e.zoomOut()}function ph(n){const e=Re(n.source.toolbar);e&&e.zoomReset()}function Gl(n){var a;let e;if(n.pdfInstance?e=n.pdfInstance:e=Re(n.source.toolbar),!e||typeof n.value=="undefined")return;const t=e.pdfViewer;n.value!==""&&e.pdfLinkService.goToPage(n.value),n.id&&Rg(e.pdfViewer.container,n.id),n.value!==t.currentPageNumber.toString()&&n.value!==t.currentPageLabel&&((a=e.toolbar)==null||a.setPageNumber(t.currentPageNumber,t.currentPageLabel))}function gh(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.currentScaleValue=n.value)}function hh(n){const e=Re(n.source.toolbar);e&&e.rotatePages(90)}function mh(n){const e=Re(n.source.toolbar);e&&e.rotatePages(-90)}function bh(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.optionalContentConfigPromise=n.promise)}function wh(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.scrollMode=n.mode)}function yh(n){const e=Re(n.source.toolbar);e&&(e.pdfViewer.spreadMode=n.mode)}function _h(n){var t;const e=Re(n.source.toolbar);e&&((t=e.pdfDocumentProperties)==null||t.open())}function vh(n){const e=Re(n.source.toolbar);e&&e.eventBus.dispatch("find",{source:n.source,type:"",query:n.query,phraseSearch:n.phraseSearch,caseSensitive:!1,entireWord:!1,highlightAll:!0,findPrevious:!1,matchDiacritics:!0})}function Eh({matchesCount:n,source:e}){const t=Re(e._linkService.pdfViewer.container);t&&(t.supportsIntegratedFind?t.externalServices.updateFindMatchesCount(n):t.findBar.updateResultsCount(n))}function kh({state:n,previous:e,matchesCount:t,rawQuery:a,source:i}){var o;const s=Re(i._linkService.pdfViewer.container);s&&(s.supportsIntegratedFind?s.externalServices.updateFindControlState({result:n,findPrevious:e,matchesCount:t,rawQuery:a}):(o=s.findBar)==null||o.updateUIState(n,e,t))}function Sh(n){var t;const e=Re(n.source.container);e&&((t=e.toolbar)==null||t.setPageScale(n.presetValue,n.scale),e.pdfViewer.update())}function Lh(n){const e=Re(n.source.container);e&&(e.pdfThumbnailViewer&&(e.pdfThumbnailViewer.pagesRotation=n.pagesRotation),e.forceRendering(),e.pdfViewer.currentPageNumber=n.pageNumber)}function Ch({pageNumber:n,pageLabel:e,source:t}){var s,o,l,r,c;const a=Re(t.container);if(!a)return;(s=a.toolbar)==null||s.setPageNumber(n,e),(o=a.secondaryToolbar)==null||o.setPageNumber(n),((l=a.pdfSidebar)==null?void 0:l.visibleView)===Fe.THUMBS&&((r=a.pdfThumbnailViewer)==null||r.scrollThumbnailIntoView(n));const i=a.pdfViewer.getPageView(n-1);(c=a.toolbar)==null||c.updateLoadingIndicatorState((i==null?void 0:i.renderingState)===je.RUNNING)}function Q_(n){const e=Re(n.source.container);e&&e.pdfViewer.refresh()}function xh(n){document.visibilityState==="visible"&&Ah()}let ro=null;function Ah(){ro&&clearTimeout(ro),ro=setTimeout(function(){ro=null},G_)}function Th(n){const e=Re(n.target);if(!e)return;const{pdfViewer:t,supportedMouseWheelZoomModifierKeys:a,supportsPinchToZoom:i}=e;if(t.isInPresentationMode)return;const s=n.deltaMode;let o=Math.exp(-n.deltaY/100);const l=typeof PDFJSDev!="undefined"&&PDFJSDev.test("MOZCENTRAL")&&Z.FeatureTest.platform.isMac,r=n.ctrlKey&&!e._isCtrlKeyDown&&s===WheelEvent.DOM_DELTA_PIXEL&&n.deltaX===0&&(Math.abs(o-1)<.05||l)&&n.deltaZ===0;if(r||n.ctrlKey&&a.ctrlKey||n.metaKey&&a.metaKey){if(n.preventDefault(),ro||document.visibilityState==="hidden")return;const c=t.currentScale;if(r&&i)if(o=e._accumulateFactor(c,o,"_wheelUnusedFactor"),o<1)e.zoomOut(null,o);else if(o>1)e.zoomIn(null,o);else return;else{const u=ig(n);let d=0;if(s===WheelEvent.DOM_DELTA_LINE||s===WheelEvent.DOM_DELTA_PAGE?Math.abs(u)>=1?d=Math.sign(u):d=e._accumulateTicks(u,"_wheelUnusedTicks"):d=e._accumulateTicks(u/30,"_wheelUnusedTicks"),d<0)e.zoomOut(-d);else if(d>0)e.zoomIn(d);else return}e._centerAtPos(c,n.clientX,n.clientY)}else Ah()}function Ih(n){const e=Re(n.target);if(!e||e.pdfViewer.isInPresentationMode||n.touches.length<2)return;if(n.preventDefault(),n.touches.length!==2){e._touchInfo=null;return}let[t,a]=n.touches;t.identifier>a.identifier&&([t,a]=[a,t]),e._touchInfo={touch0X:t.pageX,touch0Y:t.pageY,touch1X:a.pageX,touch1Y:a.pageY}}function Dh(n){const e=Re(n.target);if(!e||!e._touchInfo||n.touches.length!==2)return;const{pdfViewer:t,_touchInfo:a,supportsPinchToZoom:i}=e;let[s,o]=n.touches;s.identifier>o.identifier&&([s,o]=[o,s]);const{pageX:l,pageY:r}=s,{pageX:c,pageY:u}=o,{touch0X:d,touch0Y:f,touch1X:g,touch1Y:h}=a;if(Math.abs(d-l)<=1&&Math.abs(f-r)<=1&&Math.abs(g-c)<=1&&Math.abs(h-u)<=1)return;if(a.touch0X=l,a.touch0Y=r,a.touch1X=c,a.touch1Y=u,d===l&&f===r){const w=g-l,E=h-r,k=c-l,L=u-r,v=w*L-E*k;if(Math.abs(v)>.02*Math.hypot(w,E)*Math.hypot(k,L))return}else if(g===c&&h===u){const w=d-c,E=f-u,k=l-c,L=r-u,v=w*L-E*k;if(Math.abs(v)>.02*Math.hypot(w,E)*Math.hypot(k,L))return}else{const w=l-d,E=c-g,k=r-f,L=u-h;if(w*E+k*L>=0)return}n.preventDefault();const m=Math.hypot(l-c,r-u)||1,b=Math.hypot(d-g,f-h)||1,y=t.currentScale;if(i){const w=e._accumulateFactor(y,m/b,"_touchUnusedFactor");if(w<1)e.zoomOut(null,w);else if(w>1)e.zoomIn(null,w);else return}else{const E=e._accumulateTicks((m-b)/30,"_touchUnusedTicks");if(E<0)e.zoomOut(-E);else if(E>0)e.zoomIn(E);else return}ui._centerAtPos(y,(l+c)/2,(r+u)/2)}function $h(n){const e=Re(n.target);e&&e._touchInfo&&(n.preventDefault(),e._touchInfo=null,e._touchUnusedTicks=0,e._touchUnusedFactor=1)}function Ph(n){var a,i;const e=Re(n.target);if(!e||(["SELECT","TEXTAREA","INPUT"].includes(n.target.tagName)||e.pdfViewer.focus(),!((a=e.secondaryToolbar)!=null&&a.isOpen)))return;const t=e.appConfig;(e.pdfViewer.containsElement(n.target)||(i=t.toolbar)!=null&&i.container.contains(n.target)&&!t.secondaryToolbar.toggleButton.contains(n.target))&&e.secondaryToolbar.close()}function Mh(n){const e=Re(n.target);e&&(n.key==="Control"&&(e._isCtrlKeyDown=!1),n.keyCode===68&&e.appConfig.toolbar.rectAnno.classList.contains("toggled")&&e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")))}function Nh(n){var u,d,f,g,h,m;const e=Re(n.target);if(!e||(e._isCtrlKeyDown=n.key==="Control",e.overlayManager.active))return;const{eventBus:t,pdfViewer:a}=e,i=a.isInPresentationMode;let s=!1,o=!1;const l=(n.ctrlKey?1:0)|(n.altKey?2:0)|(n.shiftKey?4:0)|(n.metaKey?8:0);if(l===0&&[38,40].includes(n.keyCode)){document.activeElement&&document.activeElement.blur(),setTimeout(()=>{a.focus()});return}if(!n.repeat&&(l===8||l===1||l===2)&&n.keyCode===68&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")),n.preventDefault();return}if(!n.repeat&&l!==1&&l!==2&&l!==4&&l!==8&&[48,49,50,51,52,53,54,55].includes(n.keyCode)&&getSelection().rangeCount>0&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){const b=getSelection().getRangeAt(0);if(b.toString()!==""&&$(b.commonAncestorContainer,"pdfViewer")){e.appConfig.appContainer.dispatchEvent(new CustomEvent("click",{detail:(n.keyCode-48).toString()})),n.preventDefault();return}}if(l===1||l===8||l===5||l===12)switch(n.keyCode){case 70:!e.supportsIntegratedFind&&!n.shiftKey&&((u=e.findBar)==null||u.open(),s=!0);break;case 71:if(!e.supportsIntegratedFind){const{state:b}=e.findController;if(b){const y={source:window,type:"again",findPrevious:l===5||l===12};t.dispatch("find",na(na({},b),y))}s=!0}break;case 61:case 107:case 187:case 171:e.zoomIn(),s=!0;break;case 173:case 109:case 189:e.zoomOut(),s=!0;break;case 48:case 96:i||(setTimeout(function(){e.zoomReset()}),s=!1);break;case 38:(i||e.page>1)&&(e.page=1,s=!0,o=!0);break;case 40:(i||e.page<e.pagesCount)&&(ui.page=ui.pagesCount,s=!0,o=!0);break}if(l===3||l===10)switch(n.keyCode){case 80:e.requestPresentationMode(),s=!0,e.externalServices.reportTelemetry({type:"buttons",data:{id:"presentationModeKeyboard"}});break;case 71:e.appConfig.toolbar&&(e.appConfig.toolbar.pageNumber.select(),s=!0);break}if(s){o&&!i&&a.focus(),n.preventDefault();return}const r=wy(),c=r==null?void 0:r.tagName.toUpperCase();if(!((c==="INPUT"||c==="TEXTAREA"||c==="SELECT"||r!=null&&r.isContentEditable)&&n.keyCode!==27)){if(l===0){let b=0,y=!1;switch(n.keyCode){case 38:case 33:a.isVerticalScrollbarEnabled&&(y=!0),b=-1;break;case 8:i||(y=!0),b=-1;break;case 37:a.isHorizontalScrollbarEnabled&&(y=!0);case 75:case 80:b=-1;break;case 27:(d=e.secondaryToolbar)!=null&&d.isOpen&&(e.secondaryToolbar.close(),s=!0),!e.supportsIntegratedFind&&((f=e.findBar)!=null&&f.opened)&&(e.findBar.close(),s=!0);break;case 40:case 34:a.isVerticalScrollbarEnabled&&(y=!0),b=1;break;case 13:case 32:i||(y=!0),b=1;break;case 39:a.isHorizontalScrollbarEnabled&&(y=!0);case 74:case 78:b=1;break;case 36:(i||e.page>1)&&(e.page=1,s=!0,o=!0);break;case 35:(i||e.page<e.pagesCount)&&(e.page=e.pagesCount,s=!0,o=!0);break;case 83:(g=e.pdfCursorTools)==null||g.switchTool(Zt.SELECT);break;case 72:(h=e.pdfCursorTools)==null||h.switchTool(Zt.HAND);break;case 82:e.rotatePages(90);break;case 115:(m=e.pdfSidebar)==null||m.toggle();break}b!==0&&(!y||a.currentScaleValue==="page-fit")&&(b>0?a.nextPage():a.previousPage(),s=!0)}if(l===4)switch(n.keyCode){case 13:case 32:if(!i&&a.currentScaleValue!=="page-fit")break;a.previousPage(),s=!0;break;case 82:e.rotatePages(-90);break}!s&&!i&&(n.keyCode>=33&&n.keyCode<=40||n.keyCode===32&&c!=="BUTTON")&&(o=!0),o&&!a.containsElement(r)&&a.focus(),s&&n.preventDefault()}}function ck(n){return n.preventDefault(),n.returnValue="",!1}function ev(n){const e=Re(n.target);!e||e.overlayManager.active||e.externalServices.updateEditorStates(n)}const Hh={instance:{supportsPrinting:!1,createPrintService(){throw new Error("Not implemented: createPrintService")}}},dk=typeof PDFJSDev!="undefined"?PDFJSDev.eval("BUNDLE_VERSION"):void 0,uk=typeof PDFJSDev!="undefined"?PDFJSDev.eval("BUNDLE_BUILD"):void 0,fk=typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?{LinkTarget:ma,RenderingStates:je,ScrollMode:He,SpreadMode:ft}:null;function tv(n){return{appContainer:n,mainContainer:n.querySelector("#viewerContainer"),viewerContainer:n.querySelector("#viewer"),toolbar:{rectAnno:n.querySelector("#rectAnno"),container:n.querySelector("#toolbarViewer"),numPages:n.querySelector("#numPages"),pageNumber:n.querySelector("#pageNumber"),scaleSelect:n.querySelector("#scaleSelect"),customScaleOption:n.querySelector("#customScaleOption"),previous:n.querySelector("#previous"),next:n.querySelector("#next"),zoomIn:n.querySelector("#zoomIn"),zoomOut:n.querySelector("#zoomOut"),viewFind:n.querySelector("#viewFind"),openFile:typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?n.querySelector("#openFile"):null,print:n.querySelector("#print"),editorFreeTextButton:n.querySelector("#editorFreeText"),editorFreeTextParamsToolbar:n.querySelector("#editorFreeTextParamsToolbar"),editorInkButton:n.querySelector("#editorInk"),editorInkParamsToolbar:n.querySelector("#editorInkParamsToolbar"),download:n.querySelector("#download")},secondaryToolbar:{toolbar:n.querySelector("#secondaryToolbar"),toggleButton:n.querySelector("#secondaryToolbarToggle"),presentationModeButton:n.querySelector("#presentationMode"),openFileButton:typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?n.querySelector("#secondaryOpenFile"):null,printButton:n.querySelector("#secondaryPrint"),downloadButton:n.querySelector("#secondaryDownload"),viewBookmarkButton:n.querySelector("#viewBookmark"),firstPageButton:n.querySelector("#firstPage"),lastPageButton:n.querySelector("#lastPage"),pageRotateCwButton:n.querySelector("#pageRotateCw"),pageRotateCcwButton:n.querySelector("#pageRotateCcw"),cursorSelectToolButton:n.querySelector("#cursorSelectTool"),cursorHandToolButton:n.querySelector("#cursorHandTool"),scrollPageButton:n.querySelector("#scrollPage"),scrollVerticalButton:n.querySelector("#scrollVertical"),scrollHorizontalButton:n.querySelector("#scrollHorizontal"),scrollWrappedButton:n.querySelector("#scrollWrapped"),spreadNoneButton:n.querySelector("#spreadNone"),spreadOddButton:n.querySelector("#spreadOdd"),spreadEvenButton:n.querySelector("#spreadEven"),documentPropertiesButton:n.querySelector("#documentProperties")},sidebar:{outerContainer:n.querySelector("#outerContainer"),sidebarContainer:n.querySelector("#sidebarContainer"),toggleButton:n.querySelector("#sidebarToggle"),thumbnailButton:n.querySelector("#viewThumbnail"),outlineButton:n.querySelector("#viewOutline"),attachmentsButton:n.querySelector("#viewAttachments"),layersButton:n.querySelector("#viewLayers"),thumbnailView:n.querySelector("#thumbnailView"),outlineView:n.querySelector("#outlineView"),attachmentsView:n.querySelector("#attachmentsView"),layersView:n.querySelector("#layersView"),outlineOptionsContainer:n.querySelector("#outlineOptionsContainer"),currentOutlineItemButton:n.querySelector("#currentOutlineItem")},sidebarResizer:{outerContainer:n.querySelector("#outerContainer"),resizer:n.querySelector("#sidebarResizer")},findBar:{bar:n.querySelector("#findbar"),toggleButton:n.querySelector("#viewFind"),findField:n.querySelector("#findInput"),highlightAllCheckbox:n.querySelector("#findHighlightAll"),caseSensitiveCheckbox:n.querySelector("#findMatchCase"),matchDiacriticsCheckbox:n.querySelector("#findMatchDiacritics"),entireWordCheckbox:n.querySelector("#findEntireWord"),findMsg:n.querySelector("#findMsg"),findResultsCount:n.querySelector("#findResultsCount"),findPreviousButton:n.querySelector("#findPrevious"),findNextButton:n.querySelector("#findNext")},passwordOverlay:{dialog:n.querySelector("#passwordDialog"),label:n.querySelector("#passwordText"),input:n.querySelector("#password"),submitButton:n.querySelector("#passwordSubmit"),cancelButton:n.querySelector("#passwordCancel")},documentProperties:{dialog:n.querySelector("#documentPropertiesDialog"),closeButton:n.querySelector("#documentPropertiesClose"),fields:{fileName:n.querySelector("#fileNameField"),fileSize:n.querySelector("#fileSizeField"),title:n.querySelector("#titleField"),author:n.querySelector("#authorField"),subject:n.querySelector("#subjectField"),keywords:n.querySelector("#keywordsField"),creationDate:n.querySelector("#creationDateField"),modificationDate:n.querySelector("#modificationDateField"),creator:n.querySelector("#creatorField"),producer:n.querySelector("#producerField"),version:n.querySelector("#versionField"),pageCount:n.querySelector("#pageCountField"),pageSize:n.querySelector("#pageSizeField"),linearized:n.querySelector("#linearizedField")}},annotationEditorParams:{editorFreeTextFontSize:n.querySelector("#editorFreeTextFontSize"),editorFreeTextColor:n.querySelector("#editorFreeTextColor"),editorInkColor:n.querySelector("#editorInkColor"),editorInkThickness:n.querySelector("#editorInkThickness"),editorInkOpacity:n.querySelector("#editorInkOpacity")},printContainer:n.querySelector("#printContainer"),openFileInput:typeof PDFJSDev=="undefined"||PDFJSDev.test("GENERIC")?n.querySelector("#fileInput"):null,debuggerScriptPath:"./debugger.js"}}function Bh(n,e,t,a){const i=new ui(t);i.annoId=a;const s=tv(e);if(typeof PDFJSDev!="undefined"&&PDFJSDev.test("GENERIC")){const o=document.createEvent("CustomEvent");o.initCustomEvent("webviewerloaded",!0,!0,{source:window});try{parent.document.dispatchEvent(o)}catch(l){console.error(`webviewerloaded: ${l}`),document.dispatchEvent(o)}}else s.file=n;return i.run(s),x_(e,i,s),i}(Rm=document.blockUnblockOnload)==null||Rm.call(document,!0);class Gn extends sn{constructor(e){if(super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.path=e.path,this.pdfId=e.page,this.element.addEventListener("click",t=>{lt(this.element.parentElement.parentElement),this.app.plugins.forEach(a=>{a.eventBus.emit("click-pdf",{event:t})})}),typeof this.pdfId=="string"){this.getPdfId(()=>{this.render()});return}else typeof this.pdfId=="number"&&(this.pdfPage=this.pdfId);this.render()}getPdfId(e){_("/api/asset/getFileAnnotation",{path:this.path+".sya"},t=>{if(t.code!==1){const a=JSON.parse(t.data.data);a[this.pdfId]?this.pdfPage=a[this.pdfId].page?a[this.pdfId].page+1:a[this.pdfId].pages[0].index+1:this.pdfPage=void 0}e()})}goToPage(e){if(!(typeof e=="undefined"||e===null)){if(this.pdfId=e,typeof e=="string"){this.getPdfId(()=>{Gl({value:this.pdfPage,pdfInstance:this.pdfObject,id:this.pdfId})});return}typeof e=="number"&&!isNaN(e)&&Gl({value:this.pdfId,pdfInstance:this.pdfObject})}}render(){const e=this.path.substr(this.path.lastIndexOf(".")).toLowerCase();if(p.Constants.SIYUAN_ASSETS_IMAGE.includes(e))this.element.innerHTML=`<div class="asset"><img src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></div>`;else if(p.Constants.SIYUAN_ASSETS_AUDIO.includes(e))this.element.innerHTML=`<div class="asset"><audio controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></audio></div>`;else if(p.Constants.SIYUAN_ASSETS_VIDEO.includes(e))this.element.innerHTML=`<div class="asset"><video controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></video></div>`;else if(e===".pdf"){this.element.innerHTML=`<div class="pdf__outer" id="outerContainer">
      <div id="sidebarContainer">
        <div id="toolbarSidebar">
          <div id="toolbarSidebarLeft">
              <button id="viewThumbnail" class="toolbarButton toggled b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.thumbsTitle}">
                <svg><use xlink:href="#iconImage"></use></svg>
              </button>
              <button id="viewOutline" class="toolbarButton b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.outline}">
                 <svg><use xlink:href="#iconAlignCenter"></use></svg>
              </button>
              <button id="viewAttachments" class="toolbarButton fn__none" data-l10n-id="attachments">
                 <span data-l10n-id="attachments_label">Attachments</span>
              </button>
              <button id="viewLayers" class="toolbarButton fn__none" data-l10n-id="layers">
                 <span data-l10n-id="layers_label">Layers</span>
              </button>
          </div>
          <div class="fn__flex-1"></div>
          <div id="toolbarSidebarRight">
            <div id="outlineOptionsContainer" class="fn__hidden">
              <button id="currentOutlineItem" class="toolbarButton b3-tooltips b3-tooltips__nw" disabled="disabled" aria-label="${window.siyuan.languages.focusOutline}">
                <svg><use xlink:href="#iconFocus"></use></svg>
              </button>
            </div>
          </div>
        </div>
        <div id="sidebarContent">
          <div id="thumbnailView">
          </div>
          <div id="outlineView" class="fn__hidden">
          </div>
          <div id="attachmentsView" class="fn__hidden">
          </div>
          <div id="layersView" class="fn__hidden">
          </div>
        </div>
        <div id="sidebarResizer"></div>
      </div>
      <div id="mainContainer">
        <div class="findbar b3-menu fn__hidden doorHanger" id="findbar">
            <input id="findInput" class="toolbarField b3-text-field" placeholder="${window.siyuan.languages.search}">
            <div class="fn__space"></div>
            <button id="findPrevious" class="toolbarButton findPrevious b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.previous}">
                <svg><use xlink:href="#iconUp"></use></svg>
            </button>
            <button id="findNext" class="toolbarButton findNext b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.next}">
                <svg><use xlink:href="#iconDown"></use></svg>
            </button>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findHighlightAll" class="toolbarField">
                ${window.siyuan.languages.findHighlight}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchCase" class="toolbarField">
                ${window.siyuan.languages.searchCaseSensitive}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchDiacritics" class="toolbarField">
                ${window.siyuan.languages.matchDiacritics}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findEntireWord" class="toolbarField">
                ${window.siyuan.languages.findEntireWord}
            </label>
            <div class="fn__space"></div>
            <span id="findResultsCount" class="b3-button b3-button--small b3-button--cancel"></span>
            <span id="findMsg" class="b3-button b3-button--small b3-button--cancel"></span>
        </div>  <!-- findbar -->
        <div id="secondaryToolbar" class="secondaryToolbar fn__hidden doorHangerRight b3-menu">
          <div id="secondaryToolbarButtonContainer" class="b3-menu__items">
            <button id="pdfLight" class="secondaryToolbarButton b3-menu__item toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconLight"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeLight}</span>
            </button>
            <button id="pdfDark" class="secondaryToolbarButton b3-menu__item">
              <svg class="b3-menu__icon"><use xlink:href="#iconDark"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeDark}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="previous" class="secondaryToolbarButton b3-menu__item pageUp">
              <svg class="b3-menu__icon"><use xlink:href="#iconUp"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.previousLabel}</span>
              <span class="b3-menu__accelerator">${ae("P")}/${ae("K")}</span>
            </button>
            <button id="next" class="secondaryToolbarButton b3-menu__item pageDown">
              <svg class="b3-menu__icon"><use xlink:href="#iconDown"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.nextLabel}</span>
              <span class="b3-menu__accelerator">${ae("J")}/${ae("N")}</span>
            </button>
            <button id="firstPage" class="secondaryToolbarButton b3-menu__item firstPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconBack"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.firstPage}</span>
              <span class="b3-menu__accelerator">Home</span>
            </button>
            <button id="lastPage" class="secondaryToolbarButton b3-menu__item lastPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconForward"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.lastPage}</span>
              <span class="b3-menu__accelerator">End</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="zoomOut" class="secondaryToolbarButton b3-menu__item zoomOut">
               <svg class="b3-menu__icon"><use xlink:href="#iconLine"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomOut}</span>
               <span class="b3-menu__accelerator">${ae("\u2318-")}</span>
            </button>
            <button id="zoomIn" class="secondaryToolbarButton b3-menu__item zoomIn">
               <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomIn}</span>
               <span class="b3-menu__accelerator">${ae("\u2318=")}</span>
            </button>
            <button id="pageRotateCw" class="secondaryToolbarButton b3-menu__item rotateCw">
               <svg class="b3-menu__icon"><use xlink:href="#iconRedo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCw}</span>
               <span class="b3-menu__accelerator">R</span>
            </button>
            <button id="pageRotateCcw" class="secondaryToolbarButton b3-menu__item rotateCcw">
               <svg class="b3-menu__icon"><use xlink:href="#iconUndo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCcw}</span>
               <span class="b3-menu__accelerator">\u21E7R</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator"></div>

            <button id="cursorSelectTool" class="secondaryToolbarButton b3-menu__item selectTool toggled">
               <svg class="b3-menu__icon"><use xlink:href="#iconSelectText"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.cursorText}</span>
               <span class="b3-menu__accelerator">S</span>
            </button>
            <button id="cursorHandTool" class="secondaryToolbarButton b3-menu__item handTool">
              <svg class="b3-menu__icon"><use xlink:href="#iconHand"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.cursorHand}</span>
              <span class="b3-menu__accelerator">H</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="scrollVertical" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollVertical toggled">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollVert"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollVertical}</span>
            </button>
            <button id="scrollHorizontal" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollHorizontal">
              <svg class="b3-menu__icon"><use xlink:href="#iconScrollHoriz"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollHorizontal}</span>
            </button>
            <button id="scrollWrapped" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollWrapped">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollWrapped"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollWrapped}</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator scrollModeButtons"></div>

            <button id="spreadNone" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadNone toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconFile"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadNone}</span>
            </button>
            <button id="spreadOdd" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadOdd">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadOdd"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadOdd}</span>
            </button>
            <button id="spreadEven" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadEven">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadEven"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadEven}</span>
            </button>
            <button id="presentationMode" class="secondaryToolbarButton b3-menu__item presentationMode">
              <svg class="b3-menu__icon"><use xlink:href="#iconPlay"></use></svg>
              <span class="b3-menu__label">${window.siyuan.languages.presentationMode}</span>
              <span class="b3-menu__accelerator">${ae("\u2325\u2318P")}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator spreadModeButtons"></div>
            <button id="documentProperties" class="secondaryToolbarButton b3-menu__item documentProperties">
              <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
            </button>
          </div>
        </div>  <!-- secondaryToolbar -->

        <div class="pdf__toolbar">
          <div id="toolbarContainer">
            <div id="toolbarViewer">
                <button id="sidebarToggle" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="sidebarContainer" aria-label="${window.siyuan.languages.toggleSidebarNotification2Title} ${ae("F4")}">
                    <svg><use xlink:href="#iconLayoutRight"></use></svg>
                </button>
                <button id="viewFind" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.search} ${ae("\u2318F")}">
                  <svg><use xlink:href="#iconSearch"></use></svg>
                </button>
                <button id="rectAnno" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.rectAnnotation} ${ae("\u2318D")}/${ae("\u2325D")}">
                  <svg><use xlink:href="#iconLeftTop"></use></svg>
                </button>
                <input type="number" id="pageNumber" class="toolbarField pageNumber b3-text-field" value="1" size="4" min="1" autocomplete="off">
                <span id="numPages"></span>
                <div class="fn__flex-1"></div>
                <span id="scaleSelectContainer" class="dropdownToolbarButton">
                  <select id="scaleSelect" class="b3-select">
                    <option id="pageAutoOption" value="auto" selected="selected">${window.siyuan.languages.pageScaleAuto}</option>
                    <option id="pageActualOption" value="page-actual">${window.siyuan.languages.pageScaleActual}</option>
                    <option id="pageFitOption" value="page-fit">${window.siyuan.languages.pageScaleFit}</option>
                    <option id="pageWidthOption" value="page-width">${window.siyuan.languages.pageScaleWidth}</option>
                    <option id="customScaleOption" value="custom" disabled="disabled" hidden="true"></option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1">100%</option>
                    <option value="1.25">125%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                    <option value="3">300%</option>
                    <option value="4">400%</option>
                  </select>
                </span>
                <span id="scrollPage" class="fn__none"></span>
                <span id="print" class="fn__none"></span>
                <span id="secondaryPrint" class="fn__none"></span>
                <span id="viewBookmark" class="fn__none"></span>
                <span id="secondaryViewBookmark" class="fn__none"></span>
                <button id="secondaryToolbarToggle" class="toolbarButton b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.more}" aria-expanded="false" aria-controls="secondaryToolbar">
                  <svg><use xlink:href="#iconMore"></use></svg>
                </button>
            </div>
            <div id="loadingBar">
              <div class="progress">
                <div class="glimmer">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewerContainer">
          <div id="viewer" class="pdfViewer"></div>
          <div class="pdf__resize fn__none"></div>
        </div>
        <div id="errorWrapper" hidden='true'>
          <div id="errorMessageLeft">
            <span id="errorMessage"></span>
            <button id="errorShowMore" data-l10n-id="error_more_info">
              More Information
            </button>
            <button id="errorShowLess" data-l10n-id="error_less_info" hidden='true'>
              Less Information
            </button>
          </div>
          <div id="errorMessageRight">
            <button id="errorClose" data-l10n-id="error_close">
              Close
            </button>
          </div>
          <div class="clearBoth"></div>
          <textarea id="errorMoreInfo" hidden='true' readonly="readonly"></textarea>
        </div>
      </div>
      <div id="dialogContainer">
        <div class="dialog" id="passwordDialog">
            <div class="row">
              <p id="passwordText" data-l10n-id="password_label">Enter the password to open this PDF file:</p>
            </div>
            <div class="row">
              <input type="password" id="password" class="toolbarField">
            </div>
            <div class="buttonRow">
              <button id="passwordCancel" class="overlayButton"><span data-l10n-id="password_cancel">Cancel</span></button>
              <button id="passwordSubmit" class="overlayButton"><span data-l10n-id="password_ok">OK</span></button>
            </div>
        </div>
        <div class="dialog" id="documentPropertiesDialog">
            <div class="row">
              <span>${window.siyuan.languages.fileName}</span> <p id="fileNameField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.fileSize}</span> <p id="fileSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.title1}</span> <p id="titleField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.author}</span> <p id="authorField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.subject}</span> <p id="subjectField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.keywords}</span> <p id="keywordsField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creationDate}</span> <p id="creationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.modificationDate}</span> <p id="modificationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creator}</span> <p id="creatorField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.producer}</span> <p id="producerField">-</p>
            </div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.version}</span> <p id="versionField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageCount}</span> <p id="pageCountField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageSize}</span> <p id="pageSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.linearized}</span> <p id="linearizedField">-</p>
            </div>
            <div class="buttonRow">
              <button id="documentPropertiesClose" class="b3-button"><span>${window.siyuan.languages.close}</span></button>
            </div>
        </div>
        <div class="dialog" id="printServiceOverlay">
            <div class="row">
              <span data-l10n-id="print_progress_message">Preparing document for printing\u2026</span>
            </div>
            <div class="row">
              <progress value="0" max="100"></progress>
              <span data-l10n-id="print_progress_percent" data-l10n-args='{ "progress": 0 }' class="relative-progress">0%</span>
            </div>
            <div class="buttonRow">
              <button id="printCancel" class="overlayButton"><span data-l10n-id="print_progress_close">Cancel</span></button>
            </div>
        </div>
      </div>
      <div class="pdf__util b3-menu fn__none pdf__util--hide">
        <div class="fn__flex" style="padding: 0 4px">
            <button class="color__square" style="background-color:var(--b3-pdf-background1)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background2)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background3)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background4)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background5)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background6)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background7)"></button>
        </div>
        <div class="b3-menu__separator pdf__util__hide" style="margin-top: 8px"></div>
        <button class="b3-menu__item pdf__util__hide" data-type="toggle">
            <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.showHideBg}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="copy">
            <svg class="b3-menu__icon"><use xlink:href="#iconRef"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.copyAnnotation}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="remove">
            <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.remove}</span>
        </button>
      </div>
      <div class="fn__none">
        <input id="editorFreeTextFontSize">
        <input id="editorFreeTextColor">
        <input id="editorInkColor">
        <input id="editorInkThickness">
        <input id="editorInkOpacity">
        <input id="download">
        <input id="secondaryDownload">
        <input id="editorFreeText">
        <input id="openFile">
        <input id="editorInk">
      </div>
    </div> <!-- outerContainer -->
    <div id="printContainer"></div>`;const t=window.siyuan.storage[p.Constants.LOCAL_PDFTHEME],a=window.siyuan.config.appearance.mode===0?t.light:t.dark,i=this.element.querySelector("#pdfDark"),s=this.element.querySelector("#pdfLight");a==="dark"?(this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled")):(s.classList.add("toggled"),i.classList.remove("toggled")),s.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?t.light="light":t.dark="light",this.element.firstElementChild.classList.remove("pdf__outer--dark"),s.classList.add("toggled"),i.classList.remove("toggled"),Ue(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME])}),i.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?t.light="dark":t.dark="dark",this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled"),Ue(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME])}),setTimeout(()=>{if(this.element.clientWidth===0){const o=new MutationObserver(()=>{this.pdfObject=Bh(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true"),o.disconnect()});o.observe(this.element,{attributeFilter:["class"]})}else this.pdfObject=Bh(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true")},p.Constants.TIMEOUT_LOAD)}}}class Oa extends sn{constructor(e){var t;super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&((t=e.tab.headElement)==null||t.classList.add("item--unupdate")),this.element=e.tab.panelElement,this.config=e.config,this.edit=Vf(e.app,this.config,this.element),this.element.addEventListener("click",()=>{lt(this.element.parentElement.parentElement)})}updateSearch(e,t){const a=this.element.querySelector(".b3-text-field");if(e===""){a.select();return}const i=a.value;i!==e&&(t||(i.indexOf(e)>-1?e=i.replace(e+" ","").replace(" "+e,""):i!==""&&(e=i+" "+e)),a.value=e,a.select(),a.dispatchEvent(new CustomEvent("input")))}}var Oh=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const be=n=>Oh(void 0,null,function*(){const e=yield kt("/api/block/getBlockInfo",{id:n.id});if(e.code!==-1){if(e.code===3){q(e.msg);return}return jn({app:n.app,fileName:e.data.rootTitle,rootIcon:e.data.rootIcon,rootID:e.data.rootID,id:n.id,position:n.position,mode:n.mode,action:n.action,zoomIn:n.zoomIn,keepCursor:n.keepCursor,removeCurrentTab:n.removeCurrentTab,afterOpen:n.afterOpen})}}),as=(n,e,t,a)=>{const i=xe().extname(e.split("?page")[0]);p.Constants.SIYUAN_ASSETS_EXTS.includes(i)&&jn({app:n,assetPath:e,page:t,position:a,removeCurrentTab:!0})},jn=n=>Oh(void 0,null,function*(){typeof n.removeCurrentTab=="undefined"&&(n.removeCurrentTab=!0);const e=Ye();if(n.assetPath){const i=e.asset.find(s=>{if(s.path==n.assetPath)return wi(s.parent.parent.element)||(s.parent.parent.switchTab(s.parent.headElement),s.parent.parent.showHeading(),s.goToPage(n.page)),!0});if(i)return n.afterOpen&&n.afterOpen(),i.parent}else if(n.custom){const i=e.custom.find(o=>{if((0,T.MK)(o.data,n.custom.data)&&(!n.custom.id||n.custom.id===o.type))return wi(o.parent.parent.element)||(o.parent.parent.switchTab(o.parent.headElement),o.parent.parent.showHeading()),!0});if(i)return n.afterOpen&&n.afterOpen(),i.parent;const s=Od(n);if(s)return n.afterOpen&&n.afterOpen(),s}else if(n.searchData){const i=e.search.find(s=>{if((0,T.MK)(s.config,n.searchData))return wi(s.parent.parent.element)||(s.parent.parent.switchTab(s.parent.headElement),s.parent.parent.showHeading()),!0});if(i)return i.parent}else if(!n.position){let i,s;if(e.editor.find(l=>{if(l.editor.protyle.block.rootID===n.rootID&&($(l.element,"layout__wnd--active")&&(s=l),i=l),s)return!0}),s&&(i=s),i)return wi(i.parent.parent.element)||Rh(i,n,e),n.afterOpen&&n.afterOpen(),i.parent;const o=Od(n);if(o)return n.afterOpen&&n.afterOpen(),o}let t;const a=document.querySelector(".layout__wnd--active");if(a&&(t=St(a.getAttribute("data-id"))),t||(t=bi(window.siyuan.layout.centerLayout)),t){let i;if((n.position==="right"||n.position==="bottom")&&t.children[0].headElement){const s=n.position==="right"?"lr":"tb";let o;if(t.parent.children.length>1&&t.parent instanceof Te&&t.parent.direction===s&&t.parent.children.find((l,r)=>{if(l.id===t.id){let c=t.parent.children[r+1];for(c||(c=t);c instanceof Te;)c=c.children[0];return o=c,!0}}),o){if(wi(o.element)){n.afterOpen&&n.afterOpen();return}let l=o.children.find(r=>{if(r.model&&r.model instanceof gt&&r.model.editor.protyle.block.rootID===n.rootID)return Rh(r.model,n,e),!0});l||(l=Od(n),i=l),l||(i=co(n),o.addTab(i))}else i=co(n),t.split(s).addTab(i);return t.showHeading(),n.afterOpen&&n.afterOpen(),i}if(wi(t.element)){n.afterOpen&&n.afterOpen();return}if(n.keepCursor&&t.children[0].headElement)i=co(n),i.headElement.setAttribute("keep-cursor",n.id),t.addTab(i,n.keepCursor);else if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let s;t.children.find(o=>{if(o.headElement&&o.headElement.classList.contains("item--unupdate")&&!o.headElement.classList.contains("item--pin")&&(s=o,o.headElement.classList.contains("item--focus")))return!0}),i=co(n),t.addTab(i),s&&n.removeCurrentTab&&t.removeTab(s.id,!1,!0,!1)}else i=co(n),t.addTab(i);return t.showHeading(),n.afterOpen&&n.afterOpen(),i}}),Od=n=>Zn().find(e=>{var t;const a=(t=e.headElement)==null?void 0:t.getAttribute("data-initdata");if(a){const i=JSON.parse(a);if(i.instance==="Editor"&&(i.rootId===n.rootID||i.blockId===n.rootID))return i.blockId=n.id,i.mode=n.mode,n.zoomIn?i.action=[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]:i.action=n.action,delete i.scrollAttr,e.headElement.setAttribute("data-initdata",JSON.stringify(i)),e.parent.switchTab(e.headElement),!0;if(i.instance==="Custom"&&n.custom&&(0,T.MK)(i.customModelData,n.custom.data))return e.parent.switchTab(e.headElement),!0}}),Rh=(n,e,t)=>{var a,i;if(t.editor.forEach(o=>{!o.element.isSameNode(n.element)&&window.siyuan.editorIsFullscreen&&o.element.classList.contains("fullscreen")&&(o.element.classList.remove("fullscreen"),Bt(o.editor.protyle))}),window.siyuan.editorIsFullscreen&&(n.element.classList.add("fullscreen"),Bt(n.editor.protyle)),e.keepCursor)return n.parent.headElement.setAttribute("keep-cursor",e.id),!0;if(n.parent.parent.switchTab(n.parent.headElement),n.parent.parent.showHeading(),e.mode!=="preview"&&!n.editor.protyle.preview.element.classList.contains("fn__none"))return!0;if(e.zoomIn)return Yt({protyle:n.editor.protyle,id:e.id}),!0;let s;if(Array.from(n.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(o=>{if(!S(o.parentElement,"data-type","NodeBlockQueryEmbed"))return s=o,!0}),(!s||(s==null?void 0:s.clientHeight)===0)&&e.id!==e.rootID)_("/api/filetree/getDoc",{id:e.id,mode:e.action&&e.action.includes(p.Constants.CB_GET_CONTEXT)?3:0,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{dt({data:o,protyle:n.editor.protyle,action:e.action}),Fd(t,n.editor.protyle)});else{if((a=e.action)!=null&&a.includes(p.Constants.CB_GET_HL))yc(n.editor.protyle,e.id,!0);else if((i=e.action)!=null&&i.includes(p.Constants.CB_GET_FOCUS))if(s){const o=we(s);o&&(n.editor.protyle.toolbar.range=o),Ge(n.editor.protyle,s,!0)}else n.editor.protyle.block.rootID===e.id||n.editor.protyle.toolbar.range&&(s=M(n.editor.protyle.toolbar.range.startContainer),ee(n.editor.protyle.toolbar.range),s&&Ge(n.editor.protyle,s));Wn(n.editor.protyle,void 0,s||n.editor.protyle.wysiwyg.element.firstElementChild)}e.mode&&ss(n.editor.protyle,e.mode)},co=n=>{let e;if(n.assetPath){const t=xe().extname(n.assetPath.split("?page")[0]);if(p.Constants.SIYUAN_ASSETS_EXTS.includes(t)){let a="iconPDF";p.Constants.SIYUAN_ASSETS_IMAGE.includes(t)?a="iconImage":p.Constants.SIYUAN_ASSETS_AUDIO.includes(t)?a="iconRecord":p.Constants.SIYUAN_ASSETS_VIDEO.includes(t)&&(a="iconVideo"),e=new ht({icon:a,title:pt(n.assetPath),callback(i){i.addModel(new Gn({app:n.app,tab:i,path:n.assetPath,page:n.page})),lt(i.panelElement.parentElement.parentElement)}})}}else n.custom?e=new ht({icon:n.custom.icon,title:n.custom.title,callback(t){n.custom.id?n.custom.id==="siyuan-card"?t.addModel(newCardModel({app:n.app,tab:t,data:n.custom.data})):n.app.plugins.find(a=>{if(a.models[n.custom.id])return t.addModel(a.models[n.custom.id]({tab:t,data:n.custom.data})),!0}):(console.warn("0.8.3 \u5C06\u79FB\u9664 custom.fn \u53C2\u6570\uFF0C\u8BF7\u53C2\u7167 https://github.com/siyuan-note/plugin-sample/blob/91a716358941791b4269241f21db25fd22ae5ff5/src/index.ts \u5C06\u5176\u4FEE\u6539\u4E3A custom.id"),t.addModel(n.custom.fn({tab:t,data:n.custom.data}))),lt(t.panelElement.parentElement.parentElement)}}):n.searchData?e=new ht({icon:"iconSearch",title:window.siyuan.languages.search,callback(t){t.addModel(new Oa({app:n.app,tab:t,config:n.searchData})),lt(t.panelElement.parentElement.parentElement)}}):e=new ht({title:pt(n.fileName,!0,!0),docIcon:n.rootIcon,callback(t){let a;n.zoomIn?a=new gt({app:n.app,tab:t,blockId:n.id,action:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]}):a=new gt({app:n.app,tab:t,blockId:n.id,mode:n.mode,action:n.action}),t.addModel(a)}});return e},ba=n=>{var e;let t=window.siyuan.languages.siyuanNote;if(n.protyle&&n.protyle.path){if(n.protyle.element.classList.contains("fn__none")||!$(n.protyle.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active"))return;if(n.protyle.title&&(t=n.protyle.title.editElement.textContent),n.resize&&Bt(n.protyle),n.focus&&(n.protyle.toolbar.range?(ee(n.protyle.toolbar.range),cs(n.protyle.toolbar.range,n.protyle.block.rootID),n.pushBackStack&&n.protyle.preview.element.classList.contains("fn__none")&&Wn(n.protyle,n.protyle.toolbar.range)):(we(n.protyle.wysiwyg.element.firstElementChild),n.pushBackStack&&n.protyle.preview.element.classList.contains("fn__none")&&Wn(n.protyle,void 0,n.protyle.wysiwyg.element.firstElementChild),zt([],n.protyle.block.rootID))),window.siyuan.config.fileTree.alwaysSelectOpenedFile&&n.protyle){const i=(e=At("file"))==null?void 0:e.data.file;if(i instanceof ha){const s=i.element.querySelector(`li[data-path="${n.protyle.path}"]`);(!s||s&&!s.classList.contains("b3-list-item--focus"))&&i.selectItem(n.protyle.notebookId,n.protyle.path)}}}const a=Ye();qd(a,n.protyle,n.reload),Fd(a,n.protyle),er(t)},Rd=n=>{const e=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus");if(e){const t=St(e.getAttribute("data-id"));if(t instanceof ht&&t.model instanceof gt&&t.model.editor.protyle.block.rootID!==n&&t.model.editor.protyle.block.parentID!==n&&t.model.editor.protyle.block.id!==n)return!1}return!0},qd=(n,e,t=!1)=>{n.outline.find(a=>{var i;if(t||a.type==="pin"&&(!e||a.blockId!==((i=e.block)==null?void 0:i.rootID))){let s="";if(e&&e.block&&(s=e.block.rootID),s===a.blockId&&!t)return;if(e&&!e.preview.element.classList.contains("fn__none")){e.preview.render(e);return}_("/api/outline/getDocOutline",{id:s},o=>{if(!(!t&&(!Rd(s)||a.blockId===s)))if(a.isPreview=!1,a.update(o,s),e){if(a.updateDocTitle(e.background.ial),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0).startContainer;if(e.wysiwyg.element.contains(l)){const r=S(l,"data-node-id",null);r&&a.setCurrent(r)}}}else a.updateDocTitle()})}})},Fd=(n,e)=>{e&&e.element.classList.contains("fn__none")||e&&!$(e.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active")||(n.graph.forEach(t=>{var a,i;if(t.type!=="global"&&(!e||t.blockId!==((a=e.block)==null?void 0:a.id))){if(t.type==="local"&&t.rootId!==((i=e==null?void 0:e.block)==null?void 0:i.rootID))return;let s="";if(e&&e.block&&(s=e.block.showAll?e.block.id:e.block.parentID),s===t.blockId)return;t.searchGraph(!0,s)}}),n.backlink.forEach(t=>{var a;if(t.type==="local"&&t.rootId!==((a=e==null?void 0:e.block)==null?void 0:a.rootID))return;let i="";e&&e.block&&(i=e.block.showAll?e.block.id:e.block.parentID),i!==t.blockId&&(t.element.querySelector('.block__icon[data-type="refresh"] svg').classList.add("fn__rotate"),_("/api/ref/getBacklink2",{sort:t.status[i]?t.status[i].sort:"3",mSort:t.status[i]?t.status[i].mSort:"3",id:i||"",k:t.inputsElement[0].value,mk:t.inputsElement[1].value},s=>{if(!Rd(i)||t.blockId===i){t.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate");return}t.saveStatus(),t.blockId=i,t.render(s.data)}))}))},is=(n,e)=>{},ss=(n,e)=>{var t,a,i,s;if(e==="preview"){if(!n.preview.element.classList.contains("fn__none"))return;n.preview.element.classList.remove("fn__none"),n.contentElement.classList.add("fn__none"),(t=n.scroll)==null||t.element.classList.add("fn__none"),n.options.render.breadcrumb&&((a=n.breadcrumb)==null||a.element.classList.add("fn__none"),n.breadcrumb.toggleExit(!0)),n.preview.render(n)}else if(e==="wysiwyg"){if(!n.contentElement.classList.contains("fn__none"))return;n.preview.element.classList.add("fn__none"),n.contentElement.classList.remove("fn__none"),n.options.render.scroll&&((i=n.scroll)==null||i.element.classList.remove("fn__none")),n.options.render.breadcrumb&&((s=n.breadcrumb)==null||s.element.classList.remove("fn__none"),n.breadcrumb.toggleExit(!n.block.showAll)),qd(Ye(),n,!0),Bt(n)}ne(["gutter","toolbar","select","hint","util"],n)};let qh;const nv=(n,e)=>{let t=e.getBoundingClientRect();e.addEventListener("scroll",()=>{if(!n.toolbar.element.classList.contains("fn__none")){const a=n.toolbar.element.getAttribute("data-inity").split(p.Constants.ZWSP),i=parseInt(a[0])+(parseInt(a[1])-e.scrollTop);t.width===0&&(t=e.getBoundingClientRect());const s=29;i<t.top-s||i>t.bottom-s?n.toolbar.element.style.display="none":(n.toolbar.element.style.top=i+"px",n.toolbar.element.style.display="")}n.wysiwyg.element.querySelectorAll(".av").forEach(a=>{if(a.parentElement.classList.contains("protyle-wysiwyg")){const i=a.offsetTop+48,s=a.querySelector(".av__row--header");s&&(i<e.scrollTop&&i+s.parentElement.clientHeight>e.scrollTop?s.style.transform=`translateY(${e.scrollTop-i}px)`:s.style.transform="");const o=a.querySelector(".av__row--footer");if(o){const l=i+o.parentElement.clientHeight,r=e.scrollTop+e.clientHeight+5;i+42+36*2<r&&l>r?o.style.transform=`translateY(${r-l}px)`:o.style.transform=""}}}),!n.element.classList.contains("block__edit")&&!(0,T.tq)()&&n.contentElement.setAttribute("data-scrolltop",e.scrollTop.toString()),window.siyuan.dragElement||ne(["gutter"],n),n.scroll&&!n.scroll.element.classList.contains("fn__none")&&(clearTimeout(qh),qh=window.setTimeout(()=>{t=e.getBoundingClientRect();const a=document.elementFromPoint(t.left+t.width/2,t.top+10),i=M(a);if(!i){if((n.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||n.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&($(a,"protyle-background")||$(a,"protyle-title"))){const s=n.scroll.element.querySelector(".b3-slider");s.value="1",n.scroll.element.setAttribute("aria-label",`Blocks 1/${n.block.blockCount}`)}return}n.scroll.updateIndex(n,i.getAttribute("data-node-id"))},p.Constants.TIMEOUT_LOAD)),!(n.wysiwyg.element.getAttribute("data-top")||n.block.showAll||n.scroll&&n.scroll.element.classList.contains("fn__none")||!n.scroll||n.scroll.lastScrollTop===e.scrollTop||n.scroll.lastScrollTop===-1)&&(n.scroll.lastScrollTop-e.scrollTop>0?e.scrollTop<e.clientHeight&&n.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(n.contentElement.style.width=n.contentElement.clientWidth+"px",n.contentElement.style.overflow="hidden",n.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),_("/api/filetree/getDoc",{id:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{n.contentElement.style.overflow="",n.contentElement.style.width="",dt({data:a,protyle:n,action:[p.Constants.CB_GET_BEFORE,p.Constants.CB_GET_UNCHANGEID]})})):e.scrollTop>e.scrollHeight-e.clientHeight*1.8&&n.wysiwyg.element.lastElementChild&&n.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(n.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),_("/api/filetree/getDoc",{id:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{dt({data:a,protyle:n,action:[p.Constants.CB_GET_APPEND,p.Constants.CB_GET_UNCHANGEID]})})),n.scroll.lastScrollTop=Math.max(e.scrollTop,0))},{capture:!1,passive:!0,once:!1})},av=n=>{n.contentElement=document.createElement("div"),n.contentElement.className="protyle-content",n.options.render.background&&n.contentElement.appendChild(n.background.element),n.options.render.title&&n.contentElement.appendChild(n.title.element),n.contentElement.appendChild(n.wysiwyg.element),n.options.action.includes(p.Constants.CB_GET_HISTORY)||nv(n,n.contentElement),n.element.append(n.contentElement),n.element.appendChild(n.preview.element),n.upload&&n.element.appendChild(n.upload.element),n.options.render.scroll&&n.element.appendChild(n.scroll.element.parentElement),n.gutter&&n.element.appendChild(n.gutter.element),n.element.appendChild(n.hint.element),n.selectElement=document.createElement("div"),n.selectElement.className="protyle-select fn__none",n.element.appendChild(n.selectElement),n.element.appendChild(n.toolbar.element),n.element.appendChild(n.toolbar.subElement),os(n),ss(n,n.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p"),n.contentElement.addEventListener("touchstart",a=>{if(n.disabled)return;const i=a.target;if($(i,"protyle-icons")||$(i,"item")||i.classList.contains("protyle-background__icon"))return;if($(i,"protyle-background")){n.background.element.classList.toggle("protyle-background--mobileshow");return}const s=S(i,"data-type","NodeBlockQueryEmbed");s&&s.firstElementChild.classList.toggle("protyle-icons--show")});let e;const t=Ot();n.contentElement.addEventListener("mousewheel",a=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||t&&!a.metaKey||!t&&!a.ctrlKey||a.deltaX!==0)){if(a.preventDefault(),a.stopPropagation(),a.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(a.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;fd(),clearTimeout(e),e=window.setTimeout(()=>{_("/api/setting/setEditor",window.siyuan.config.editor),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&n.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(i=>{Xs(i)})},p.Constants.TIMEOUT_LOAD)}},{passive:!1})},os=(n,e)=>{n.element.removeAttribute("data-loading"),setTimeout(()=>{n.element.getAttribute("data-loading")!=="finished"&&n.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${e||""}</div>
</div>`)},p.Constants.TIMEOUT_LOAD)},jl=n=>{n.element.setAttribute("data-loading","finished"),n.element.querySelectorAll(".wysiwygLoading").forEach(e=>{e.remove()})},Fh=n=>{if(n.options.action.includes(p.Constants.CB_GET_HISTORY))return{width:0,padding:0};const e=parseInt(n.wysiwyg.element.style.paddingLeft);let t=16,a=24;if(!(0,T.tq)()){let l=n.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_FULLWIDTH);l||(l=window.siyuan.config.editor.fullWidth?"true":"false");let r=(n.element.clientWidth-p.Constants.SIZE_EDITOR_WIDTH)/2;l==="false"&&r>96?(r>p.Constants.SIZE_EDITOR_WIDTH&&(r=n.element.clientWidth*.382/1.382),r=Math.ceil(r),t=r,a=r):n.element.clientWidth>p.Constants.SIZE_EDITOR_WIDTH&&(t=96,a=96)}let i="16px";if(n.options.typewriterMode&&((0,T.tq)()?i=window.innerHeight/5+"px":i=n.element.clientHeight/2+"px"),n.options.backlinkData?n.wysiwyg.element.style.padding=`4px ${t}px 4px ${a}px`:n.wysiwyg.element.style.padding=`16px ${t}px ${i} ${a}px`,n.options.render.background&&(n.background.element.lastElementChild.setAttribute("style",`left:${t}px`),n.background.element.querySelector(".protyle-background__img .protyle-icons").setAttribute("style",`right:${t}px`)),n.options.render.title&&(n.title.element.style.margin=`16px ${t}px 0 ${a}px`),window.siyuan.config.editor.displayBookmarkIcon){const l=document.getElementById("editorAttr");l&&(l.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${n.wysiwyg.element.clientWidth-t-a}px; }`)}const s=n.wysiwyg.element.getAttribute("data-realwidth"),o=n.wysiwyg.element.clientWidth-parseInt(n.wysiwyg.element.style.paddingLeft)-parseInt(n.wysiwyg.element.style.paddingRight);return n.wysiwyg.element.setAttribute("data-realwidth",o.toString()),{width:Math.abs(parseInt(s)-o),padding:Math.abs(e-parseInt(n.wysiwyg.element.style.paddingLeft))}},Bt=n=>{ne(["gutter"],n);const e=Fh(n),t=4;setTimeout(()=>{if((e.width>t||isNaN(e.width))&&(typeof window.echarts!="undefined"&&n.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(a=>{const i=window.echarts.getInstanceById(a.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&n.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(a=>{Xs(a)}),!n.disabled&&n.toolbar.range)){let a=n.toolbar.range.getBoundingClientRect();if(a.height===0){const s=M(n.toolbar.range.startContainer);s&&(a=s.getBoundingClientRect())}if(a.height===0)return;const i=n.element.getBoundingClientRect();(i.top+30>a.top||i.bottom<a.bottom)&&n.toolbar.range.startContainer.parentElement.scrollIntoView(i.top>a.top)}(e.padding>t||e.width>t||isNaN(e.padding))&&n.wysiwyg.element.querySelectorAll(".av").forEach(a=>{Ln(a)})},p.Constants.TIMEOUT_TRANSITION)},Ln=n=>{if(!(!n.classList.contains("av")||n.getAttribute("data-render")!=="true"))if(n.style.width.endsWith("%")||n.style.margin){const e=n.firstElementChild.firstElementChild;e.style.paddingLeft="",e.style.paddingRight="";const t=n.querySelector(".av__scroll").firstElementChild;t.style.paddingLeft="",t.style.paddingRight="",n.style.alignSelf="",n.style.width.endsWith("%")||(n.style.width="",n.style.maxWidth="100%")}else{const e=n.parentElement.style.paddingLeft,t=n.parentElement.style.paddingRight,a=n.firstElementChild.firstElementChild;a.style.paddingLeft=e,a.style.paddingRight=t;const i=n.querySelector(".av__scroll").firstElementChild;i.style.paddingLeft=e,i.style.paddingRight=t,n.style.alignSelf="center",n.parentElement.clientWidth>0&&(n.style.width=n.parentElement.clientWidth+"px",n.style.maxWidth="")}};class uo{constructor(e){this.defIds=[],this.editors=[],this.id=ke(),this.targetElement=e.targetElement,this.nodeIds=e.nodeIds,this.defIds=e.defIds||[],this.app=e.app,this.x=e.x,this.y=e.y,this.isBacklink=e.isBacklink,this.element=document.createElement("div"),this.element.classList.add("block__popover");const t=$(this.targetElement,"block__popover",!0);let a=1;t?(this.element.setAttribute("data-oid",t.getAttribute("data-oid")),a=parseInt(t.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.nodeIds[0]),this.element.setAttribute("data-level",a.toString());for(let i=0;i<window.siyuan.blockPanels.length;i++){const s=window.siyuan.blockPanels[i];s.element.getAttribute("data-pin")==="false"&&s.targetElement&&parseInt(s.element.getAttribute("data-level"))>=a&&(s.destroy(),i--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",i=>{const s=i.target,o=$(s,"block__icons");if(o){const l=o.querySelector('[data-type="pin"]');l.classList.contains("block__icon--active")?(l.classList.remove("block__icon--active"),l.setAttribute("aria-label",window.siyuan.languages.pin),this.element.setAttribute("data-pin","false")):(l.classList.add("block__icon--active"),l.setAttribute("aria-label",window.siyuan.languages.unpin),this.element.setAttribute("data-pin","true")),i.preventDefault(),i.stopPropagation()}}),this.element.addEventListener("click",i=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let s=i.target;for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("block__icon")||s.classList.contains("block__logo")){const o=s.getAttribute("data-type");o==="close"?this.destroy():o==="pin"&&(s.classList.contains("block__icon--active")?(s.classList.remove("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.pin),this.element.setAttribute("data-pin","false")):(s.classList.add("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.unpin),this.element.setAttribute("data-pin","true"))),i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),me(this.element,i=>{i!=="move"&&this.editors.forEach(o=>{Bt(o.protyle)});const s=this.element.firstElementChild.querySelector('[data-type="pin"]');s.classList.add("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.unpin),this.element.setAttribute("data-pin","true")}),this.render()}initProtyle(e,t){const a=parseInt(e.getAttribute("data-index"));_("/api/block/getBlockInfo",{id:this.nodeIds[a]},i=>{if(i.code===3){q(i.msg);return}if(!this.targetElement&&typeof this.x=="undefined"&&typeof this.y=="undefined")return;const s=[];i.data.rootID!==this.nodeIds[a]?s.push(p.Constants.CB_GET_ALL):(s.push(p.Constants.CB_GET_CONTEXT),s.push(p.Constants.CB_GET_HL)),this.isBacklink&&s.push(p.Constants.CB_GET_BACKLINK);const o=new hn(this.app,e,{blockId:this.nodeIds[a],defId:this.defIds[a]||this.defIds[0]||"",action:s,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1,after:l=>{e.addEventListener("mouseleave",()=>{ne(["gutter"],l.protyle)}),i.data.rootID!==this.nodeIds[a]&&l.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),t&&t(),(l.protyle.element.nextElementSibling||l.protyle.element.previousElementSibling)&&(l.protyle.element.style.minHeight=Math.min(30+l.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),l.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(l.protyle.contentElement.clientHeight-49,200)}px;${(0,T.tq)()?"":"right:10px"}`)}});this.editors.push(o)})}destroy(){window.siyuan.blockPanels.find((e,t)=>{if(e.id===this.id)return window.siyuan.blockPanels.splice(t,1),!0}),this.editors.length>0&&(this.editors.forEach(e=>{ne(["util"],e.protyle),e.destroy()}),this.editors=[]),this.element.remove(),this.element=void 0,this.targetElement=void 0,window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let t=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.nodeIds.length===0?t+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.nodeIds.forEach((i,s)=>{t+=`<div class="block__edit fn__flex-1 protyle" data-index="${s}"></div>`}),t&&(t+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=t;const a=new IntersectionObserver(i=>{i.forEach(s=>{s.isIntersecting&&s.target.innerHTML===""&&this.initProtyle(s.target)})},{threshold:0});this.element.querySelectorAll(".block__edit").forEach((i,s)=>{s<5?this.initProtyle(i,s===0?()=>{let o;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){o=this.targetElement.getBoundingClientRect();let r=o.top;const c=$(this.targetElement,"protyle-content",!0);if(c){const u=c.getBoundingClientRect().top;o.top<u&&(r=u)}this.element.style.height=Math.min(window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT,o.height+42)+"px",Ve(this.element,o.left,Math.max(r-42,p.Constants.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?o=this.targetElement.firstElementChild.getBoundingClientRect():o=this.targetElement.getBoundingClientRect(),window.innerHeight-o.bottom-4>o.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-o.bottom-12)+"px"),Ve(this.element,o.left,o.bottom+4,o.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(Ve(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,p.Constants.SIZE_TOOLBAR_HEIGHT)-12)+"px");const l=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(l.top<o.top?this.element.style.maxHeight=Math.floor(o.top-l.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-l.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):a.observe(i)}),this.targetElement&&(this.targetElement.style.cursor="")}}class Kn extends sn{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&_("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(a){if(a)switch(a.cmd){case"mount":this.type==="global"&&a.code!==1&&this.searchGraph(!1);break;case"rename":this.graphData&&a.data.box===this.graphData.box&&this.rootId===a.data.id&&(this.searchGraph(!1),this.type==="local"&&this.parent.updateTitle(a.data.title)),this.type==="global"&&this.searchGraph(!1);break;case"unmount":this.type==="local"&&this.graphData&&this.graphData.box===a.data.box&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":this.type==="local"&&a.data.ids.includes(this.rootId)&&this.parent.parent.removeTab(this.parent.id);break}}}),this.element=e.tab.panelElement,this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element.classList.add("graph","file-tree",this.type==="global"?"sy__globalGraph":"sy__graph");let t;this.type==="global"?t=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.d3.arrow?" checked":""}/>
</label>
<label> 
    <span>${window.siyuan.languages.graphConfig2}</span>  
    <input data-type="minRefs" class="b3-slider b3-tooltips__n b3-tooltips" max="16" min="0" step="1" type="range" value="${window.siyuan.config.graph.global.minRefs}" aria-label="${window.siyuan.config.graph.global.minRefs}" />
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.global.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.linkWidth}" aria-label="${window.siyuan.config.graph.global.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.global.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.centerStrength}" aria-label="${window.siyuan.config.graph.global.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.global.d3.collideRadius}" aria-label="${window.siyuan.config.graph.global.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.collideStrength}" aria-label="${window.siyuan.config.graph.global.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.global.d3.linkDistance}" aria-label="${window.siyuan.config.graph.global.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`:t=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.d3.arrow?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.local.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.linkWidth}" aria-label="${window.siyuan.config.graph.local.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.local.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.centerStrength}" aria-label="${window.siyuan.config.graph.local.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.local.d3.collideRadius}" aria-label="${window.siyuan.config.graph.local.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.collideStrength}" aria-label="${window.siyuan.config.graph.local.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.local.d3.linkDistance}" aria-label="${window.siyuan.config.graph.local.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`,this.element.innerHTML=`
<div class="block__icons"> 
    <div class="block__logo">
        <svg><use xlink:href="#icon${this.type==="global"?"GlobalGraph":"Graph"}"></use></svg>
        ${this.type==="global"?window.siyuan.languages.globalGraph:window.siyuan.languages.graphView}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__size200 fn__none" placeholder="${window.siyuan.languages.search}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.search}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <div class="fn__space"></div>
    <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.fullscreen}">
        <svg><use xlink:href="#iconFullscreen"></use></svg>
    </div>
    <div class="fn__space"></div>
    <div data-type="menu" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min"  class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="graph__panel">
    ${t}
</div>
<div class="fn__flex-1 graph__svg"><div class="graph__loading"><div></div></div><div style="height: 100%"></div></div>`,this.graphElement=this.element.querySelector(".graph__svg"),this.inputElement=this.element.querySelector("input"),this.panelElement=this.element.querySelector(".graph__panel"),this.element.addEventListener("click",a=>{this.type==="local"?lt(this.element.parentElement.parentElement):lt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("b3-button")){this.type==="global"?_("/api/graph/resetGraph",{},s=>{this.reset(s.data.conf)}):_("/api/graph/resetLocalGraph",{},s=>{this.reset(s.data.conf)});break}else if(i.classList.contains("block__icon")){const s=i.getAttribute("data-type");s==="min"?At(this.type==="global"?"globalGraph":"graph").toggleModel(this.type==="global"?"globalGraph":"graph"):s==="menu"?i.classList.contains("ft__primary")?(i.classList.remove("ft__primary"),this.panelElement.style.right=""):(i.classList.add("ft__primary"),this.panelElement.style.right="0"):s==="search"?(i.previousElementSibling.classList.remove("fn__none"),i.previousElementSibling.select()):s==="refresh"?this.searchGraph(!1):s==="fullscreen"&&kl(this.element,i);break}else if(i.classList.contains("graph__svg")){this.element.querySelectorAll(".block__icon.ft__primary").forEach(s=>{s.classList.remove("ft__primary")}),this.panelElement.style.right="";break}i=i.parentElement}}),this.inputElement.addEventListener("compositionend",()=>{this.searchGraph(!1),this.inputElement.classList.add("search__input--block")}),this.inputElement.addEventListener("blur",a=>{a.target.classList.add("fn__none")}),this.inputElement.addEventListener("input",a=>{a.isComposing||(this.inputElement.value===""?this.inputElement.classList.remove("search__input--block"):this.inputElement.classList.add("search__input--block"),this.searchGraph(!1))}),this.element.querySelectorAll(".b3-slider").forEach(a=>{a.addEventListener("input",()=>{a.setAttribute("aria-label",a.value),this.searchGraph(!1)})}),this.element.querySelectorAll(".b3-switch").forEach(a=>{a.addEventListener("change",()=>{this.searchGraph(!1)})}),this.searchGraph(e.type!=="global")}reset(e){this.type==="global"?(window.siyuan.config.graph.global=e,this.panelElement.querySelector("[data-type='minRefs']").setAttribute("aria-label",window.siyuan.config.graph.global.minRefs.toString()),this.panelElement.querySelector("[data-type='minRefs']").value=window.siyuan.config.graph.global.minRefs.toString()):window.siyuan.config.graph.local=e,this.inputElement.value="",this.panelElement.querySelector("[data-type='nodeSize']").setAttribute("aria-label",e.d3.nodeSize.toString()),this.panelElement.querySelector("[data-type='centerStrength']").setAttribute("aria-label",e.d3.centerStrength.toString()),this.panelElement.querySelector("[data-type='collideRadius']").setAttribute("aria-label",e.d3.collideRadius.toString()),this.panelElement.querySelector("[data-type='collideStrength']").setAttribute("aria-label",e.d3.collideStrength.toString()),this.panelElement.querySelector("[data-type='lineOpacity']").setAttribute("aria-label",e.d3.lineOpacity.toString()),this.panelElement.querySelector("[data-type='linkDistance']").setAttribute("aria-label",e.d3.linkDistance.toString()),this.panelElement.querySelector("[data-type='linkWidth']").setAttribute("aria-label",e.d3.linkWidth.toString()),this.panelElement.querySelector("[data-type='nodeSize']").value=e.d3.nodeSize.toString(),this.panelElement.querySelector("[data-type='centerStrength']").value=e.d3.centerStrength.toString(),this.panelElement.querySelector("[data-type='collideRadius']").value=e.d3.collideRadius.toString(),this.panelElement.querySelector("[data-type='collideStrength']").value=e.d3.collideStrength.toString(),this.panelElement.querySelector("[data-type='lineOpacity']").value=e.d3.lineOpacity.toString(),this.panelElement.querySelector("[data-type='linkDistance']").value=e.d3.linkDistance.toString(),this.panelElement.querySelector("[data-type='linkWidth']").value=e.d3.linkWidth.toString(),this.panelElement.querySelector("[data-type='list']").checked=e.type.list,this.panelElement.querySelector("[data-type='listItem']").checked=e.type.listItem,this.panelElement.querySelector("[data-type='math']").checked=e.type.math,this.panelElement.querySelector("[data-type='paragraph']").checked=e.type.paragraph,this.panelElement.querySelector("[data-type='super']").checked=e.type.super,this.panelElement.querySelector("[data-type='table']").checked=e.type.table,this.panelElement.querySelector("[data-type='tag']").checked=e.type.tag,this.panelElement.querySelector("[data-type='dailyNote']").checked=e.dailyNote,this.panelElement.querySelector("[data-type='heading']").checked=e.type.heading,this.panelElement.querySelector("[data-type='arrow']").checked=e.d3.arrow,this.panelElement.querySelector("[data-type='blockquote']").checked=e.type.blockquote,this.panelElement.querySelector("[data-type='code']").checked=e.type.code,this.searchGraph(!1)}searchGraph(e,t){const a=this.element.querySelector('.block__icon[data-type="refresh"] svg');if(a.classList.contains("fn__rotate")&&!t)return;a.classList.add("fn__rotate");const i={list:this.panelElement.querySelector("[data-type='list']").checked,listItem:this.panelElement.querySelector("[data-type='listItem']").checked,math:this.panelElement.querySelector("[data-type='math']").checked,paragraph:this.panelElement.querySelector("[data-type='paragraph']").checked,super:this.panelElement.querySelector("[data-type='super']").checked,table:this.panelElement.querySelector("[data-type='table']").checked,tag:this.panelElement.querySelector("[data-type='tag']").checked,heading:this.panelElement.querySelector("[data-type='heading']").checked,blockquote:this.panelElement.querySelector("[data-type='blockquote']").checked,code:this.panelElement.querySelector("[data-type='code']").checked},s={arrow:this.panelElement.querySelector("[data-type='arrow']").checked,nodeSize:parseFloat(this.panelElement.querySelector("[data-type='nodeSize']").value),centerStrength:parseFloat(this.panelElement.querySelector("[data-type='centerStrength']").value),collideRadius:parseFloat(this.panelElement.querySelector("[data-type='collideRadius']").value),collideStrength:parseFloat(this.panelElement.querySelector("[data-type='collideStrength']").value),lineOpacity:parseFloat(this.panelElement.querySelector("[data-type='lineOpacity']").value),linkDistance:parseFloat(this.panelElement.querySelector("[data-type='linkDistance']").value),linkWidth:parseFloat(this.panelElement.querySelector("[data-type='linkWidth']").value)};this.type==="global"?_("/api/graph/getGraph",{k:this.inputElement.value,conf:{type:i,d3:s,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked,minRefs:parseFloat(this.panelElement.querySelector("[data-type='minRefs']").value)}},o=>{this.graphData=o.data,window.siyuan.config.graph.global=o.data.conf,this.onGraph(!1),a.classList.remove("fn__rotate")}):_("/api/graph/getLocalGraph",{type:this.type,k:this.inputElement.value,id:t||this.blockId,conf:{type:i,d3:s,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked}},o=>{a.classList.remove("fn__rotate"),t&&(this.blockId=t),!(!Rd(this.blockId)&&this.graphElement.firstElementChild.classList.contains("fn__none"))&&(this.graphData=o.data,window.siyuan.config.graph.local=o.data.conf,this.onGraph(e))})}hlNode(e){this.graphElement.clientHeight===0||!this.network||this.network.findNode(e).length===0||(this.network.focus(e,{animation:{duration:1e3,easingFunction:"easeInOutQuad"}}),this.network.selectNodes([e]))}onGraph(e){if(this.graphElement.clientHeight===0)return;if(!this.graphData||!this.graphData.nodes||this.graphData.nodes.length===0){this.network&&this.network.destroy(),this.graphElement.firstElementChild.classList.add("fn__none");return}const t=getComputedStyle(document.body);this.graphData.nodes.forEach(a=>{switch(a.type){case"NodeDocument":a.color={background:t.getPropertyValue("--b3-graph-doc-point").trim()};break;case"NodeParagraph":a.color={background:t.getPropertyValue("--b3-graph-p-point").trim()};break;case"NodeHeading":a.color={background:t.getPropertyValue("--b3-graph-heading-point").trim()};break;case"NodeMathBlock":a.color={background:t.getPropertyValue("--b3-graph-math-point").trim()};break;case"NodeCodeBlock":a.color={background:t.getPropertyValue("--b3-graph-code-point").trim()};break;case"NodeTable":a.color={background:t.getPropertyValue("--b3-graph-table-point").trim()};break;case"NodeList":a.color={background:t.getPropertyValue("--b3-graph-list-point").trim()};break;case"NodeListItem":a.color={background:t.getPropertyValue("--b3-graph-listitem-point").trim()};break;case"NodeBlockquote":a.color={background:t.getPropertyValue("--b3-graph-bq-point").trim()};break;case"NodeSuperBlock":a.color={background:t.getPropertyValue("--b3-graph-super-point").trim()};break;default:a.color={background:t.getPropertyValue("--b3-graph-p-point").trim()};break}}),this.graphData.links.forEach(a=>{a.ref?a.color={color:t.getPropertyValue("--b3-graph-ref-line").trim()}:a.color={color:t.getPropertyValue("--b3-graph-line").trim()}}),clearTimeout(this.timeout),(0,vt.addScript)(`${p.Constants.PROTYLE_CDN}/js/vis/vis-network.min.js?v=9.1.2`,"protyleVisScript").then(()=>{this.timeout=window.setTimeout(()=>{this.graphElement.firstElementChild.classList.remove("fn__none"),this.graphElement.firstElementChild.firstElementChild.setAttribute("style","width:3%");const a=window.siyuan.config.graph[this.type==="global"?"global":"local"],i={nodes:this.graphData.nodes,edges:this.graphData.links},s={autoResize:!0,interaction:{hover:!0},nodes:{borderWidth:0,borderWidthSelected:5,shape:"dot",font:{face:t.getPropertyValue("--b3-font-family-graph").trim(),size:32,color:t.getPropertyValue("--b3-theme-on-background").trim()},color:{hover:{border:t.getPropertyValue("--b3-graph-hl-point").trim(),background:t.getPropertyValue("--b3-graph-hl-point").trim()},highlight:{border:t.getPropertyValue("--b3-graph-hl-point").trim(),background:t.getPropertyValue("--b3-graph-hl-point").trim()}}},edges:{width:a.d3.linkWidth,arrowStrikethrough:!1,smooth:!1,color:{opacity:a.d3.lineOpacity,hover:t.getPropertyValue("--b3-graph-hl-line").trim(),highlight:t.getPropertyValue("--b3-graph-hl-line").trim()}},layout:{improvedLayout:!1},physics:{enabled:!0,forceAtlas2Based:{theta:.5,gravitationalConstant:-a.d3.collideRadius,centralGravity:a.d3.centerStrength,springConstant:a.d3.collideStrength,springLength:a.d3.linkDistance,damping:.4,avoidOverlap:.5},maxVelocity:50,minVelocity:.1,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:256,updateInterval:25,onlyDynamicEdges:!1,fit:!0},timestep:.5,adaptiveTimestep:!0,wind:{x:0,y:0}}},o=new vis.Network(this.graphElement.lastElementChild,i,s);this.network=o,o.on("stabilizationIterationsDone",()=>{o.physics.stopSimulation(),this.graphElement.firstElementChild.classList.add("fn__none"),e&&this.hlNode(this.blockId)}),o.on("dragEnd",()=>{setTimeout(()=>{o.physics.stopSimulation()},5e3)}),o.on("stabilizationProgress",l=>{this.graphElement.firstElementChild.firstElementChild.setAttribute("style",`width:${Math.max(5,l.iterations)/l.total*100}%`)}),o.on("click",l=>{if(l.nodes.length!==1)return;const r=this.graphData.nodes.find(c=>c.id===l.nodes[0]);if(r){if(r.type==="textmark tag"){Hn(this.app,`#${r.id}#`,!window.siyuan.ctrlIsPressed);return}window.siyuan.shiftIsPressed?be({app:this.app,id:r.id,position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]}):window.siyuan.altIsPressed?be({app:this.app,id:r.id,position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]}):window.siyuan.ctrlIsPressed?window.siyuan.blockPanels.push(new uo({app:this.app,isBacklink:!1,x:l.event.center.x,y:l.event.center.y,nodeIds:[r.id]})):be({app:this.app,id:r.id,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]})}})},1e3)})}}const Uh=(n,e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="bookmarkMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=n.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new I({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const i=n.querySelector(".b3-list-item__text").textContent,s=new Le({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()});const l=s.element.querySelector("input");s.bindInput(l,()=>{o[1].click()}),l.value=i,l.focus(),l.select(),o[1].addEventListener("click",()=>{_("/api/bookmark/renameBookmark",{oldBookmark:i,newBookmark:l.value},()=>{s.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:li(n.getAttribute("data-node-id"),!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const i=n.querySelector(".b3-list-item__text").textContent;Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${De(i)}</b>`),()=>{a?(_("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{t.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(s=>{s.setAttribute("bookmark","");const o=s.querySelector(".protyle-attr--bookmark");o&&o.remove()})):_("/api/bookmark/removeBookmark",{bookmark:i})})}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","bookmarkMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class fi extends sn{constructor(e,t){super({app:e,id:t.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('class="protyle-attr--bookmark"')>-1||i.action==="delete")&&(s=!0),s&&_("/api/bookmark/getBookmark",{},o=>{this.update(o.data)})});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&_("/api/bookmark/getBookmark",{},i=>{this.update(i.data)});break}}}),this.element=t.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__bookmark"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconBookmark"></use></svg>
        ${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${ae(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${ae(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new Bs({element:this.element.lastElementChild,data:null,click:(a,i)=>{if(i){const o=$(i.target,"b3-list-item__action");if(o){Uh(o.parentElement,i,this);return}}const s=a.getAttribute("data-node-id");s&&_("/api/block/checkBlockFold",{id:s},o=>{be({app:e,id:s,action:o.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:o.data})})},rightClick:(a,i)=>{Uh(a,i,this)},ctrlClick(a){be({app:e,id:a.getAttribute("data-node-id"),keepCursor:!0,action:[p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]})},altClick(a){be({app:e,id:a.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]})},shiftClick(a){be({app:e,id:a.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{lt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":At("bookmark").toggleModel("bookmark");break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),_("/api/bookmark/getBookmark",{},t=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(t.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}const Vh=(n,e,t)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tagMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{Wu(t)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${De(t)}</b>?`,()=>{_("/api/tag/removeTag",{label:t})})}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","tagMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class pi extends sn{constructor(e,t){super({app:e,id:t.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('data-type="tag"')>-1||i.action==="delete")&&(s=!0),s&&this.update()});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&this.update();break}}}),this.element=t.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__tag"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconTags"></use></svg>
        ${window.siyuan.languages.tag}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" class="block__icon b3-tooltips b3-tooltips__sw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.sort}">
        <svg><use xlink:href="#iconSort"></use></svg>
    </span>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${ae(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${ae(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new Bs({element:this.element.lastElementChild,data:null,click(a,i){const s=a.getAttribute("data-label");if(i){const o=$(i.target,"b3-list-item__action");if(o){Vh(o.parentElement,i,s);return}}Hn(e,`#${a.getAttribute("data-label")}#`,!window.siyuan.ctrlIsPressed)},rightClick:(a,i)=>{Vh(a,i,a.getAttribute("data-label"))},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{lt(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":At("tag").toggleModel("tag");break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new I({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new I({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new I({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new I({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new I({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),_("/api/tag/getTag",{sort:window.siyuan.config.tag.sort},t=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(t.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}class wa extends sn{constructor(e){var t;super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&((t=e.tab.headElement)==null||t.classList.add("item--unupdate")),this.element=e.tab.panelElement,this.tab=e.tab,this.data=e.data,this.type=e.type,this.init=e.init,this.destroy=e.destroy,this.beforeDestroy=e.beforeDestroy,this.resize=e.resize,this.update=e.update,this.init()}}const zh=()=>{const n=Ye(),e=[];return n.editor.forEach(t=>{e.push(t.editor)}),n.search.forEach(t=>{e.push(t.edit)}),n.custom.forEach(t=>{var a;((a=t.data)==null?void 0:a.editor)instanceof hn&&e.push(t.data.editor)}),n.backlink.forEach(t=>{t.editors.forEach(a=>{e.push(a)})}),window.siyuan.dialogs.forEach(t=>{t.editor&&e.push(t.editor)}),window.siyuan.blockPanels.forEach(t=>{t.editors.forEach(a=>{e.push(a)})}),e},Ye=()=>{const n={editor:[],graph:[],asset:[],outline:[],backlink:[],search:[],inbox:[],files:[],bookmark:[],tag:[],custom:[]},e=t=>{for(let a=0;a<t.children.length;a++){const i=t.children[a];if(i instanceof ht){const s=i.model;s instanceof gt?n.editor.push(s):s instanceof Kn?n.graph.push(s):s instanceof Ha?n.outline.push(s):s instanceof Ba?n.backlink.push(s):s instanceof Gn?n.asset.push(s):s instanceof Oa?n.search.push(s):s instanceof ha?n.files.push(s):s instanceof fi?n.bookmark.push(s):s instanceof pi?n.tag.push(s):s instanceof wa&&n.custom.push(s)}else e(i)}};return window.siyuan.layout.layout&&e(window.siyuan.layout.layout),n},Zn=()=>{const n=[],e=t=>{for(let a=0;a<t.children.length;a++){const i=t.children[a];i instanceof ht?n.push(i):e(i)}};return window.siyuan.layout.centerLayout&&e(window.siyuan.layout.centerLayout),n},Kl=()=>{const n=[];return window.siyuan.config.uiLayout.left.data.forEach(e=>{e.forEach(t=>{n.push(t)})}),window.siyuan.config.uiLayout.right.data.forEach(e=>{e.forEach(t=>{n.push(t)})}),window.siyuan.config.uiLayout.bottom.data.forEach(e=>{e.forEach(t=>{n.push(t)})}),n},Wh=()=>{const n=window.siyuan.emojis[(0,T.sZ)(0,window.siyuan.emojis.length-1)];return typeof n.items[(0,T.sZ)(0,n.items.length-1)]=="undefined"?"1f600":n.items[(0,T.sZ)(0,n.items.length-1)].unicode},fe=(n,e="",t=!1,a=!1)=>{if(!n)return"";let i="";if(n.indexOf(".")>-1)i=`<img class="${e}" ${a?"data-":""}src="/emojis/${n}"/>`;else try{n.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),t&&(i=`<span class="${e}">${i}</span>`)}catch(s){}return i},Zl=n=>{const e=new IntersectionObserver(t=>{t.forEach(a=>{const i=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(o=>{s+=`<button data-unicode="${o.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?o.description_zh_cn:o.description}">
${fe(o.unicode)}</button>`}),a.target.innerHTML=s,a.target.removeAttribute("data-index")}})});n.querySelectorAll(".emojis__content").forEach(t=>{e.observe(t)})},fo=n=>{const e=new IntersectionObserver(t=>{t.forEach(a=>{const i=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i&&(a.target.src=i,a.target.removeAttribute("data-src"))})});n.querySelectorAll("img").forEach(t=>{e.observe(t)})},po=(n="",e)=>{let t="";const a=[];n&&(t=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const o=[];window.siyuan.emojis.forEach((r,c)=>{n||(t+=`<div class="emojis__title" data-type="${c+1}">${window.siyuan.config.lang==="zh_CN"?r.title_zh_cn:r.title}</div><div style="min-height:${c===0?"28px":"336px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!n&&(t+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(u=>{if(n){if(window.siyuan.config.editor.emoji.includes(u.unicode)&&(fe(u.unicode)===n||u.keywords.toLowerCase().indexOf(n.toLowerCase())>-1||u.description.toLowerCase().indexOf(n.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(n.toLowerCase())>-1)&&a.push(u),e&&i>e)return;(fe(u.unicode)===n||u.keywords.toLowerCase().indexOf(n.toLowerCase())>-1||u.description.toLowerCase().indexOf(n.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(n.toLowerCase())>-1)&&(r.id==="custom"?o.push(u):s+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?u.description_zh_cn:u.description}">
${fe(u.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(u.unicode)&&a.push(u),c<2&&(t+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?u.description_zh_cn:u.description}">
${fe(u.unicode,void 0,!1,!0)}</button>`)}),n||(t+="</div>")}),n&&(o.sort((r,c)=>{const u=r.keywords.split("/"),d=c.keywords.split("/");return u[u.length-1].toLowerCase().indexOf(n.toLowerCase())<d[d.length-1].toLowerCase().indexOf(n.toLowerCase())?-1:0}).sort((r,c)=>{const u=r.keywords.split("/"),d=c.keywords.split("/");return u[u.length-1].toLowerCase().indexOf(n.toLowerCase())===d[d.length-1].toLowerCase().indexOf(n.toLowerCase())&&u[u.length-1].length<d[d.length-1].length?-1:0}).forEach(r=>{t+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?r.description_zh_cn:r.description}">
${fe(r.unicode,void 0,!1,!0)}</button>`}),t=t+s+"</div>");let l="";return a.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=a.filter(u=>u.unicode===r);c[0]&&(l+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?c[0].description_zh_cn:c[0].description}">
${fe(c[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+t===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+t},gi=n=>{window.siyuan.config.editor.emoji.unshift(n),window.siyuan.config.editor.emoji.length>p.Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),_("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},ls=(n,e,t,a)=>{e!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i=new Le({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:(0,T.tq)()?"80vw":"360px",height:"50vh",content:`<div class="emojis">
<div class="fn__flex">
    <span class="fn__space"></span>
    <label class="b3-form__icon fn__flex-1">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
    </label>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    <span class="fn__space"></span>
</div>
<div class="emojis__panel">${po()}</div>
<div class="fn__flex">
    <div data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${fe("2b50")}</div>
    <div data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f527")}</div>
    <div data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f60d")}</div>
    <div data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f433")}</div>
    <div data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f96a")}</div>
    <div data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f3a8")}</div>
    <div data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f3dd")}</div>
    <div data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f52e")}</div>
    <div data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("267e")}</div>
    <div data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f6a9")}</div>
</div>
</div>`});i.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const s=i.element.querySelector(".b3-dialog");s.style.justifyContent="inherit",s.style.alignItems="inherit",Ve(i.element.querySelector(".b3-dialog__container"),t.x,t.y,t.h,t.w),i.element.querySelector(".emojis__item").classList.add("emojis__item--current");const o=i.element.querySelector(".b3-text-field"),l=i.element.querySelector(".emojis__panel");o.addEventListener("compositionend",()=>{var r;l.innerHTML=po(o.value),o.value?l.nextElementSibling.classList.add("fn__none"):l.nextElementSibling.classList.remove("fn__none"),l.scrollTop=0,(r=i.element.querySelector(".emojis__item"))==null||r.classList.add("emojis__item--current"),o.value===""&&Zl(i.element),fo(i.element)}),o.addEventListener("input",r=>{var c;r.isComposing||(l.innerHTML=po(o.value),o.value?l.nextElementSibling.classList.add("fn__none"):l.nextElementSibling.classList.remove("fn__none"),l.scrollTop=0,(c=i.element.querySelector(".emojis__item"))==null||c.classList.add("emojis__item--current"),o.value===""&&Zl(i.element),fo(i.element))}),o.addEventListener("keydown",r=>{var c,u;if(r.isComposing||r.key.indexOf("Arrow")===-1&&r.key!=="Enter")return;const d=i.element.querySelector(".emojis__item--current");if(!d)return;if(r.key==="Enter"){const g=d.getAttribute("data-unicode");e==="notebook"?_("/api/notebook/setNotebookIcon",{notebook:n,icon:g},()=>{i.destroy(),gi(g),hi(g,n,"iconFilesRoot")}):e==="doc"?_("/api/attr/setBlockAttrs",{id:n,attrs:{icon:g}},()=>{i.destroy(),gi(g),hi(g,n),Xl(g,n)}):a(g),r.preventDefault(),r.stopPropagation();return}let f;if(r.key==="ArrowLeft"||r.key==="ArrowUp"?d.previousElementSibling?(d.classList.remove("emojis__item--current"),f=d.previousElementSibling,r.preventDefault(),r.stopPropagation()):(c=d.parentElement.previousElementSibling)!=null&&c.previousElementSibling&&(d.classList.remove("emojis__item--current"),f=d.parentElement.previousElementSibling.previousElementSibling.lastElementChild,r.preventDefault(),r.stopPropagation()):(r.key==="ArrowRight"||r.key==="ArrowDown")&&(d.nextElementSibling?(d.classList.remove("emojis__item--current"),f=d.nextElementSibling,r.preventDefault(),r.stopPropagation()):(u=d.parentElement.nextElementSibling)!=null&&u.nextElementSibling&&(d.classList.remove("emojis__item--current"),f=d.parentElement.nextElementSibling.nextElementSibling.firstElementChild,r.preventDefault(),r.stopPropagation())),f){f.classList.add("emojis__item--current");const g=o.clientHeight+6;f.offsetTop-g<l.scrollTop?l.scrollTop=f.offsetTop-g:f.offsetTop-g-l.clientHeight+f.clientHeight>l.scrollTop&&(l.scrollTop=f.offsetTop-g-l.clientHeight+f.clientHeight)}}),(0,T.tq)()||o.focus(),Zl(i.element),fo(i.element),i.element.addEventListener("click",r=>{const c=r.target,u=$(c,"emojis__type");if(u){const g=l.querySelector(`[data-type="${u.getAttribute("data-type")}"]`);if(g){const h=g.nextElementSibling.getAttribute("data-index");if(h){let m="";window.siyuan.emojis[parseInt(h)].items.forEach(b=>{m+=`<button data-unicode="${b.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?b.description_zh_cn:b.description}">
${fe(b.unicode)}</button>`}),g.nextElementSibling.innerHTML=m,g.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:g.offsetTop-34})}return}const d=$(c,"block__icon");if(d&&d.getAttribute("aria-label")===window.siyuan.languages.remove){e==="notebook"?_("/api/notebook/setNotebookIcon",{notebook:n,icon:""},()=>{i.destroy(),hi("",n,"iconFilesRoot")}):e==="doc"?_("/api/attr/setBlockAttrs",{id:n,attrs:{icon:""}},()=>{i.destroy(),hi("",n),Xl("",n)}):a("");return}const f=$(c,"emojis__item");if(f||d){let g="";f?(g=f.getAttribute("data-unicode"),e!=="av"&&i.destroy()):g=Wh(),e==="notebook"?_("/api/notebook/setNotebookIcon",{notebook:n,icon:g},()=>{gi(g),hi(g,n,"iconFilesRoot")}):e==="doc"?_("/api/attr/setBlockAttrs",{id:n,attrs:{icon:g}},()=>{gi(g),hi(g,n),Xl(g,n)}):a(g);return}})},Xl=(n,e)=>{Ye().outline.forEach(t=>{t.blockId===e&&(t.headerElement.nextElementSibling.firstElementChild.outerHTML=fe(n||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0))})},hi=(n,e,t="iconFile")=>{let a;const i=At("file");if(i){const s=i.data.file;t==="iconFile"?a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`):a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`)||s.element.querySelector(`[data-url="${e}"] .b3-list-item__icon`)||s.closeElement.querySelector(`[data-url="${e}"] .b3-list-item__icon`)}a&&(a.innerHTML=fe(n||(t==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?p.Constants.SIYUAN_IMAGE_FILE:p.Constants.SIYUAN_IMAGE_FOLDER:p.Constants.SIYUAN_IMAGE_NOTE))),t!=="iconFile"&&_a()},pk=n=>{},iv=()=>{const n=new URLSearchParams(window.location.search),e=n.get("url");let t="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e))t=e.substring(20,20+22),a=(0,T.on)("focus",e)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();t=Jl(i),a=(0,T.on)("focus",i)==="1"}else t=n.get("id"),a=n.get("focus")==="1";return{id:t,isZoomIn:a}},sv=n=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(n),Jl=n=>n.substring(16,16+22),ov=(n=window.location.href)=>{const e=new URL(window.location.origin);e.pathname="/check-auth",e.searchParams.set("to",n),window.location.href=e.href},lv=()=>{let n=document.getElementById("baseURL");n||(n=document.createElement("base"),n.id="baseURL"),n.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(n)},pt=(n,e=!0,t=!1)=>{let a=n;return e&&(a=xe().basename(n)),t&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},Yh=n=>n.substring(7,n.length-xe().extname(n).length-23),go=n=>!n||(n=n.trim(),1>n.length)?!1:(n=n.toLowerCase(),n.startsWith("assets/")||n.startsWith("file://")||n.startsWith("\\\\")?!0:n.indexOf(":")===1),xe=()=>bc.posix?bc.posix:bc,gk=()=>path,Ud=n=>{const e=[];return n.forEach(t=>{if(t.getAttribute("data-type")!=="navigation-root"){const a=t.getAttribute("data-path");e.find(s=>{if(a.startsWith(s.replace(".sy","")))return!0})||e.push(a)}}),e},Vd=(n,e,t)=>{_("/api/filetree/moveDocs",{toNotebook:e,fromPaths:n,toPath:t})},ya=(n,e,t,a,i=!1)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.querySelector("#foldList"))return f.destroy(),!0}))return;const o=new Le({title:`${a||window.siyuan.languages.move}
<div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${(0,T.tq)()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${(0,T.tq)()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"50vw",height:(0,T.tq)()?"80vh":"70vh",destroyCallback(){t&&ee(t)}});e&&e.length>0&&_("/api/filetree/getHPathsByPaths",{paths:e},f=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=De(f.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");_a(f=>{let g="";f.forEach(h=>{if(!h.closed){let m="";i&&(m=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${h.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${h.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${h.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${h.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${fe(h.icon||p.Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${De(h.name)}</span>
    ${m}
</li></ul>`}}),r.innerHTML=g},i);const c=o.element.querySelector(".b3-text-field");c.focus();const u=f=>{if(!(f&&f.isComposing)){if(c.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),_("/api/filetree/searchDocs",{k:c.value,flashcard:i},g=>{let h="";g.data.forEach(m=>{let b="";i&&(b=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),h+=`<li class="b3-list-item${h===""?" b3-list-item--focus":""}" data-path="${m.path}" data-box="${m.box}">
    ${fe(m.boxIcon||p.Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding:4px 0">${De(m.hPath)}</span>
    ${b}
</li>`}),l.innerHTML=h})}};u(),c.addEventListener("compositionend",f=>{u(f)}),c.addEventListener("input",f=>{u(f)});const d=28;c.addEventListener("keydown",f=>{if(f.isComposing)return;const g=l.classList.contains("fn__none")?r:l,h=g.querySelectorAll(".b3-list-item--focus");if(h.length===0)return;let m=h[0];if(f.key.startsWith("Arrow")&&h.forEach((b,y)=>{y!==0&&b.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(f.key==="ArrowRight"&&!m.querySelector(".b3-list-item__arrow--open")&&!m.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||f.key==="ArrowLeft"&&m.querySelector(".b3-list-item__arrow--open")){zd(m,i),f.preventDefault();return}if(f.key==="ArrowLeft"){let b=m.parentElement.previousElementSibling;if(b){b.tagName!=="LI"&&(b=g.querySelector(".b3-list-item")),m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const y=b.getBoundingClientRect(),w=g.getBoundingClientRect();(y.top<w.top||y.bottom>w.bottom)&&b.scrollIntoView(y.top<w.top)}return f.preventDefault(),!0}if(f.key==="ArrowDown"||f.key==="ArrowRight"){let b=m;for(;b;)if(b.nextElementSibling)if(b.nextElementSibling.classList.contains("fn__none"))b=b.nextElementSibling;else{b.nextElementSibling.tagName==="UL"?b=b.nextElementSibling.firstElementChild:b=b.nextElementSibling;break}else{if(b.parentElement.id==="foldTree")break;b=b.parentElement}if(b.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const y=b.getBoundingClientRect(),w=r.getBoundingClientRect();(y.top<w.top||y.bottom>w.bottom)&&b.scrollIntoView(y.top<w.top)}return f.preventDefault(),!0}if(f.key==="ArrowUp"){let b=m;for(;b;)if(b.previousElementSibling)if(b.previousElementSibling.classList.contains("fn__none"))b=b.previousElementSibling;else{if(b.previousElementSibling.tagName==="LI")b=b.previousElementSibling;else{const y=b.previousElementSibling.querySelectorAll(".b3-list-item");b=y[y.length-1]}break}else{if(b.parentElement.id==="foldTree")break;b=b.parentElement}if(b.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const y=b.getBoundingClientRect(),w=r.getBoundingClientRect();(y.top<w.top||y.bottom>w.bottom)&&b.scrollIntoView(y.top<w.top)}f.preventDefault()}}else{if(f.key==="ArrowDown"){m.classList.remove("b3-list-item--focus"),m.nextElementSibling?m.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),m=g.querySelector(".b3-list-item--focus"),(g.scrollTop<m.offsetTop-g.clientHeight+d||g.scrollTop>m.offsetTop)&&(g.scrollTop=m.offsetTop-g.clientHeight+d),f.preventDefault();return}if(f.key==="ArrowUp"){if(m.classList.remove("b3-list-item--focus"),m.previousElementSibling)m.previousElementSibling.classList.add("b3-list-item--focus");else{const b=g.children.length;g.children[b-1].classList.add("b3-list-item--focus")}m=g.querySelector(".b3-list-item--focus"),(g.scrollTop<m.offsetTop-g.clientHeight+d||g.scrollTop>m.offsetTop-d*2)&&(g.scrollTop=m.offsetTop-d*2),f.preventDefault();return}}if(f.key==="Enter"){const b=g.querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const y=[],w=[];b.forEach(E=>{y.push(E.getAttribute("data-path")),w.push(E.getAttribute("data-box"))}),n(y,w),o.destroy(),f.preventDefault()}}),o.element.addEventListener("click",f=>{let g=f.target;for(;g&&!g.isEqualNode(o.element);){if(g.classList.contains("b3-list-item__toggle")){zd(g.parentElement,i),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const m=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;const b=[],y=[];m.forEach(w=>{b.push(w.getAttribute("data-path")),y.push(w.getAttribute("data-box"))}),n(b,y),o.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){o.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const m=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;a===window.siyuan.languages.specifyPath&&(f.ctrlKey||f.metaKey)?m.length===1&&m[0].isSameNode(g)||g.classList.toggle("b3-list-item--focus"):(m[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&zd(g,i),f.preventDefault(),f.stopPropagation();break}g=g.parentElement}c.focus()})},zd=(n,e)=>{const t=n.querySelector(".b3-list-item__arrow");if(t.classList.contains("b3-list-item__arrow--open")){t.classList.remove("b3-list-item__arrow--open"),n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.classList.add("fn__none");return}if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"){t.classList.add("b3-list-item__arrow--open"),n.nextElementSibling.classList.remove("fn__none");return}const a=n.getAttribute("data-box");_("/api/filetree/listDocsByPath",{notebook:a,path:n.getAttribute("data-path"),flashcard:e},i=>{if(i.data.path==="/"&&i.data.files.length===0){q(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(l=>{let r="";e?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),s+=`<li title="${pt(l.name,!0,!0)} ${l.hSize}${l.bookmark?`
`+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?`
`+window.siyuan.languages.name+" "+l.name1:""}${l.alias?`
`+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?`
`+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}
${window.siyuan.languages.modifiedAt} ${l.hMtime}
${window.siyuan.languages.createdAt} ${l.hCtime}" 
data-box="${a}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${fe(l.icon||(l.subFileCount===0?p.Constants.SIYUAN_IMAGE_FILE:p.Constants.SIYUAN_IMAGE_FOLDER),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${pt(l.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;t.classList.add("b3-list-item__arrow--open"),n.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const o=n.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*n.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},Xn=n=>{let e="";return window.siyuan.notebooks.find(t=>{if(t.id===n)return e=t.name,!0}),e},rv=n=>{let e="";return window.siyuan.notebooks.find(t=>{if(t.id===n)return e=t.icon,!0}),e},cv=(n,e)=>{window.siyuan.notebooks.find(t=>{if(t.id===n)return t.name=e,!0})},Wd=()=>{let n=0;return window.siyuan.notebooks.forEach(e=>{e.closed||n++}),n},_a=(n,e=!1)=>{_("/api/notebook/lsNotebooks",{flashcard:e},t=>{e||(window.siyuan.notebooks=t.data.notebooks),n&&n(t.data.notebooks)})},Ql=(n,e)=>{_("/api/block/getDocInfo",{id:n},t=>{e.updateTitle(t.data.name)})},Gh=(n,e)=>{j();const t=Ye();t.editor.forEach(a=>{e.upsertRootIDs.includes(a.editor.protyle.block.rootID)?(zn(a.editor.protyle,!1),Ql(a.editor.protyle.block.rootID,a.parent)):e.removeRootIDs.includes(a.editor.protyle.block.rootID)&&a.parent.parent.removeTab(a.parent.id,!1,!1,!1)}),t.graph.forEach(a=>{a.type==="local"&&e.removeRootIDs.includes(a.rootId)?a.parent.parent.removeTab(a.parent.id,!1,!1,!1):(a.type!=="local"||e.upsertRootIDs.includes(a.rootId))&&(a.searchGraph(!1),a.type==="local"&&Ql(a.rootId,a.parent))}),t.outline.forEach(a=>{a.type==="local"&&e.removeRootIDs.includes(a.blockId)?a.parent.parent.removeTab(a.parent.id,!1,!1,!1):(a.type!=="local"||e.upsertRootIDs.includes(a.blockId))&&(_("/api/outline/getDocOutline",{id:a.blockId},i=>{a.update(i)}),a.type==="local"&&Ql(a.blockId,a.parent))}),t.backlink.forEach(a=>{a.type==="local"&&e.removeRootIDs.includes(a.rootId)?a.parent.parent.removeTab(a.parent.id,!1,!1,!1):(a.refresh(),a.type==="local"&&Ql(a.rootId,a.parent))}),t.files.forEach(a=>{_a(()=>{a.init(!1)})}),t.bookmark.forEach(a=>{a.update()}),t.tag.forEach(a=>{a.update()}),t.search.forEach(a=>{a.parent.panelElement.querySelector("#searchInput").dispatchEvent(new CustomEvent("input"))}),t.custom.forEach(a=>{a.update&&a.update()})},jh=()=>{window.siyuan.config.readonly||_("/api/system/logoutAuth",{},()=>{ov()})},Kh=()=>{if(document.querySelector("#errorLog"))return;let n="";Rt()&&(n=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const e=new Le({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${p.Constants.SIYUAN_VERSION}</small>`,width:(0,T.tq)()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${n}
</div>
</div>`});e.element.id="errorLog";const t=e.element.querySelector(".b3-button");t&&t.addEventListener("click",()=>{e.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},rs=()=>{_("/api/system/exit",{force:!1},n=>{if(n.code===1){const e=q(n.msg,n.data.closeTimeout,"error"),t=document.querySelector(`#message [data-id="${e}"] button`);t&&t.addEventListener("click",()=>{_("/api/system/exit",{force:!0},()=>{(Rt()||Mt())&&(window.location.href="siyuan://api/system/exit")})})}else n.code===2?(j(),Ne(window.siyuan.languages.tip,n.msg,()=>{_("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{_("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(Rt()||Mt())&&(window.location.href="siyuan://api/system/exit")})},dv=()=>{if(document.getElementById("transactionError"))return;const n=new Le({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${p.Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),e=n.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{Tt({reload:!1,onlyData:!1,errorExit:!0,cb:rs})}),e[1].addEventListener("click",()=>{_("/api/filetree/refreshFiletree",{}),n.destroy()})},uv=n=>{const e=document.querySelector("#status");if(!e)return;if((0,T.tq)()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;e.innerHTML=n.msg,e.classList.remove("status--hide"),e.style.bottom="0";return}const t=e.querySelector(".status__msg");t&&(t.innerHTML=n.msg)},fv=n=>{let e=document.getElementById("progress");if(e||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),e=document.getElementById("progress")),n.code===2){e.remove();return}n.code===0?e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:var(--b3-theme-on-surface);">
    <div style="text-align: right">${n.data.current}/${n.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${n.data.current/n.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div>${n.msg}</div>
</div>`:n.code===1&&(e.lastElementChild?e.lastElementChild.lastElementChild.innerHTML=n.msg:e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:var(--b3-theme-on-surface);">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div>${n.msg}</div>
</div>`)},pv=n=>{const e=document.querySelector(".status__backgroundtask");e&&(n.length===0?(e.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(e.classList.remove("fn__none"),e.setAttribute("data-tasks",JSON.stringify(n)),e.innerHTML=n[0].action+"<div><div></div></div>"))},gv=()=>{_("/api/sync/getBootSync",{},n=>{if(n.code===1){const e=new Le({width:(0,T.tq)()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${n.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`}),t=e.element.querySelectorAll(".b3-button");t[0].addEventListener("click",()=>{e.destroy()}),t[1].addEventListener("click",()=>{t[1].getAttribute("disabled")||(t[1].setAttribute("disabled","disabled"),_("/api/sync/performBootSync",{},a=>{a.code===0&&e.destroy(),t[1].removeAttribute("disabled")}))})}})},er=n=>{const e=document.getElementById("drag"),t=Yu();if(n===window.siyuan.languages.siyuanNote){const a=`${n} - ${t} - v${p.Constants.SIYUAN_VERSION}`;document.title=a,e&&(e.textContent=a,e.setAttribute("title",a))}else{if(n=n||"Untitled",document.title=`${n} - ${t} - ${window.siyuan.languages.siyuanNote} v${p.Constants.SIYUAN_VERSION}`,!e)return;e.setAttribute("title",n),e.innerHTML=De(n)}},hv=n=>{const e=document.querySelector("#configBazaarReadme .item__side");if(!e||n.id!==JSON.parse(e.getAttribute("data-obj")).repoURL)return;const t=e.querySelector('[data-type="install"]');t&&(n.percent>=1?(t.parentElement.classList.add("fn__none"),t.parentElement.nextElementSibling.classList.add("fn__none")):(t.classList.add("b3-button--progress"),t.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),t.innerHTML=`<span style="width: ${n.percent*100}%"></span>`,t.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${n.percent*100}%"></span>`))},Jn=n=>{const e=document.querySelector("#barSync");if(!e)return;const t=e.querySelector("use");if(!n){e.classList.remove("toolbar__item--active"),!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&sa("")?t.setAttribute("xlink:href","#iconCloudOff"):t.setAttribute("xlink:href","#iconCloudSucc");return}e.firstElementChild.classList.remove("fn__rotate"),n.code===0?(e.classList.add("toolbar__item--active"),e.firstElementChild.classList.add("fn__rotate"),t.setAttribute("xlink:href","#iconRefresh")):n.code===2?(e.classList.remove("toolbar__item--active"),t.setAttribute("xlink:href","#iconCloudError")):n.code===1&&(e.classList.remove("toolbar__item--active"),t.setAttribute("xlink:href","#iconCloudSucc"))};var mv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const _=(n,e,t,a)=>{const i={method:"POST"};e&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(n)&&(window.siyuan.reqIds[n]=new Date().getTime(),e.type==="local"&&n==="/api/graph/getLocalGraph"||(e.reqId=window.siyuan.reqIds[n])),n==="/api/transactions"&&(e.reqId=new Date().getTime()),e instanceof FormData?i.body=e:i.body=JSON.stringify(e)),a&&(i.headers=a),fetch(n,i).then(s=>{var o;return s.status===404?{data:null,msg:s.statusText,code:s.status}:((o=s.headers.get("content-type"))==null?void 0:o.indexOf("application/json"))>-1?s.json():s.text()}).then(s=>{if(typeof s=="string"){t&&t(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(n)&&s.data.reqId&&window.siyuan.reqIds[n]&&window.siyuan.reqIds[n]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?Je(s)&&t&&t(s):t&&t(s))}).catch(s=>{if(console.warn("fetch post error",s),n==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){Kh();return}})},kt=(n,e)=>mv(void 0,null,function*(){const t={method:"POST"};e&&(t.body=JSON.stringify(e));const i=yield(yield fetch(n,t)).json();return Je(i),i}),Zh=(n,e)=>{fetch(n).then(t=>t.json()).then(t=>{e(t)})},bv=(n=!1)=>{let e="";n||(e=`<div id="barDock" class="toolbar__item ariaLabel${window.siyuan.config.readonly||n?" fn__none":""}" aria-label="${window.siyuan.languages.toggleDock} ${ae(window.siyuan.config.keymap.general.toggleDock.custom)}">
    <svg>
        <use xlink:href="#${window.siyuan.config.uiLayout.hideDock?"iconDock":"iconHideDock"}"></use>
    </svg>
</div>`),document.getElementById("status").innerHTML=`${e}
<div class="status__msg"></div>
<div class="fn__flex-1"></div>
<div class="status__backgroundtask fn__none"></div>
<div class="status__counter"></div>
<div id="statusHelp" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.help}">
    <svg><use xlink:href="#iconHelp"></use></svg>
</div>`,document.querySelector("#status").addEventListener("click",t=>{let a=t.target;for(;a.id!=="status";){if(a.id==="barDock"){Pp(a.firstElementChild.firstElementChild),t.stopPropagation();break}else if(a.classList.contains("status__backgroundtask")){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","statusBackgroundTask"),JSON.parse(a.getAttribute("data-tasks")).forEach(s=>{window.siyuan.menus.menu.append(new I({type:"readonly",iconHTML:p.Constants.ZWSP,label:s.action}).element)});const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),t.stopPropagation();break}else if(a.id==="statusHelp"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusHelp"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","statusHelp"),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.help,icon:"iconHelp",click:()=>{El()}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages._trayMenu.officialWebsite,icon:"iconSiYuan",click:()=>{window.open("https://b3log.org/siyuan")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages._trayMenu.openSource,icon:"iconGithub",click:()=>{window.open("https://github.com/siyuan-note/siyuan")}}).element);const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),t.stopPropagation();break}else if(a.classList.contains("b3-menu__item")){const i=a.getAttribute("data-type");if(At(i).toggleModel(i),i==="file"&&getSelection().rangeCount>0){const s=getSelection().getRangeAt(0),o=$(s.startContainer,"protyle-wysiwyg",!0);o&&o.blur()}a.parentElement.classList.add("fn__none"),t.stopPropagation();break}a=a.parentElement}}),window.siyuan.config.appearance.hideStatusBar&&document.getElementById("status").classList.add("fn__none")};let Ra,ho;const cs=(n,e)=>{document.getElementById("status").classList.contains("fn__none")||(clearTimeout(ho),ho=window.setTimeout(()=>{n.toString()?(_("/api/block/getContentWordCount",{content:n.toString()},a=>{tr(a.data)}),Ra=""):e&&e!==Ra&&(Ra=e,_("/api/block/getTreeStat",{id:e},a=>{tr(a.data)}))},p.Constants.TIMEOUT_COUNT))},zt=(n,e,t=!1)=>{document.getElementById("status").classList.contains("fn__none")||(clearTimeout(ho),ho=window.setTimeout(()=>{t&&(Ra=""),n.length>0?(_("/api/block/getBlocksWordCount",{ids:n},a=>{tr(a.data)}),Ra=""):e&&e!==Ra&&(Ra=e,_("/api/block/getTreeStat",{id:e},a=>{tr(a.data)}))},p.Constants.TIMEOUT_COUNT))},wv=()=>{Ra="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(ho)},tr=n=>{if(!n)return;let e=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${n.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${n.wordCount}<span class="fn__space"></span>`;0<n.linkCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${n.linkCount}<span class="fn__space"></span>`),0<n.imageCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${n.imageCount}<span class="fn__space"></span>`),0<n.refCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${n.refCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=e},yv=(n,e)=>{if(!e){if(getSelection().rangeCount===0)return!1;e=getSelection().getRangeAt(0)}const t=e.commonAncestorContainer;return n.isEqualNode(t)||n.contains(t)},Yd=n=>{const e=S(n.startContainer,"data-type","NodeTable");if(n.toString()!==""&&e&&n.commonAncestorContainer.nodeType!==3){const t=n.commonAncestorContainer.tagName;if(t!=="TH"&&t!=="TD"){const a=te(n.startContainer,"TD")||te(n.startContainer,"TH"),i=te(n.endContainer,"TD")||te(n.endContainer,"TH");if(!a&&!i){const s=e.querySelector("th")||e.querySelector("td");n.setStart(s.firstChild,0),n.setEnd(s.lastChild,s.lastChild.textContent.length)}else a&&!a.contains(n.endContainer)&&Xt(a,n,!1)}}},mo=(n,e,t)=>{const a=J(e);if(a){let o;if(a.tagName==="TABLE"){const l=te(t.startContainer,"TD")||te(t.startContainer,"TH");if(l&&(o=Et(l,e,t),o.start!==0||o.end!==l.textContent.length))return t.setStart(l.firstChild,0),t.setEndAfter(l.lastChild),n.toolbar.render(n,t),cs(t,n.block.rootID),!0}else if(o=Et(a,e,t),o.start!==0||o.end!==a.textContent.length){let l=a.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){t.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){t.setStartBefore(l);break}l=l.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){t.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){t.setEndAfter(r);break}r=r.lastChild}return ee(t),n.toolbar.render(n,t),cs(t,n.block.rootID),!0}}t.collapse(!0);const i=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(n.wysiwyg.element.childElementCount===i.length&&i[0].parentElement.isSameNode(n.wysiwyg.element))return!0;ne(["select"],n);const s=[];Array.from(n.wysiwyg.element.children).forEach(o=>{o.classList.add("protyle-wysiwyg--select"),s.push(o.getAttribute("data-node-id"))}),zt(s,n.block.rootID)},Gd=(n,e)=>{const t=document.caretRangeFromPoint(n,e),a=S(t.startContainer,"data-type","img");return a&&(t.setStart(a.nextSibling,0),t.collapse()),t},he=n=>{let e;if(getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0),n.isSameNode(e.startContainer)||n.contains(e.startContainer)))return e;n.focus({preventScroll:!0});let t;return n.classList.contains("table")?t=n.querySelector("th")||n.querySelector("td"):(t=J(n),t?t.tagName==="TABLE"&&(t=t.querySelector("th")||n.querySelector("td")):t=n),e=t.ownerDocument.createRange(),e.setStart(t||n,0),e.collapse(!0),e},Cn=(n,e)=>{var t,a;if(e||(e=he(n)),!n.contains(e.startContainer))return{left:0,top:0};let i;if(e.getClientRects().length===0)if(e.startContainer.nodeType===3){const s=(t=e.startContainer.parentElement)==null?void 0:t.getClientRects(),o=(a=e.startContainer.previousElementSibling)==null?void 0:a.getClientRects();if(s.length>0||o.length>0)s.length===0||o&&o.length>0&&s[0].top<o[o.length-1].bottom?i={left:o[o.length-1].left,top:o[o.length-1].bottom}:i=s[0];else return{left:0,top:0}}else{const s=e.startContainer.children;if(s[e.startOffset]&&s[e.startOffset].getClientRects().length>0)i=s[e.startOffset].getClientRects()[0];else if(e.startContainer.childNodes.length>0){const o=e.cloneRange();e.selectNode(e.startContainer.childNodes[Math.max(0,e.startOffset-1)]),i=e.getClientRects()[0],e.setEnd(o.endContainer,o.endOffset),e.setStart(o.startContainer,o.startOffset)}else i=e.startContainer.getClientRects()[0];if(!i){let o=e.startContainer.childNodes[e.startOffset];if(o||(o=e.startContainer.childNodes[e.startOffset-1]),!o)i=e.getBoundingClientRect();else{for(;!o.getClientRects||o.getClientRects&&o.getClientRects().length===0;)o=o.parentElement;i=o.getClientRects()[0]}}}else{const s=e.getClientRects();return{left:s[s.length-1].left,top:s[0].top}}return{left:i.left,top:i.top}},Et=(n,e,t)=>{const a={end:0,start:0};if(!t){if(getSelection().rangeCount===0)return a;t=window.getSelection().getRangeAt(0)}if(e&&!yv(e,t))return a;const i=t.cloneRange();return n.childNodes[0]&&n.childNodes[0].childNodes[0]?i.setStart(n.childNodes[0].childNodes[0],0):i.selectNodeContents(n),i.setEnd(t.startContainer,t.startOffset),a.start=i.toString().length,a.end=a.start+t.toString().length,a};function nr(n,e,t,a){if(!e)return!1;if(t(e))return!0;for(let i=0,s=e.childNodes.length;i<s;i++)if(nr(e,e.childNodes[i],t,!0))return!0;if(!a){let i=e;for(;i&&i!==n;){let s=i.nextSibling;for(;s;){if(nr(n,s,t,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const Xt=(n,e,t=!0)=>{if(!n)return e;let a=n.lastChild;for(;a&&a.nodeType!==3;)a=a.lastChild;return a?(t?e.setStart(a,a.textContent.length):e.setEnd(a,a.textContent.length),e):(e.selectNodeContents(n),e)},ar=(n,e)=>{if(!n)return e;let t=n.firstChild;for(;t&&t.nodeType!==3&&!t.classList.contains("render-node");){if(t.classList.contains("img"))return e.setStartBefore(t),e;t=t.firstChild}return t?(t.nodeType!==3&&t.classList.contains("render-node")?e.setStartBefore(t):e.setStart(t,0),e):(e.selectNodeContents(n),e)},Fn=(n,e,t)=>{if(!n)return!1;const a=J(n);if(a)n=a;else if(Me(n)||n.classList.contains("av"))return we(n);let i;nr(n,n.firstChild,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return e<=r?(i=l,!0):(e-=r,t-=r,!1)}});let s;i&&nr(n,i,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return t<=r?(s=l,!0):(t-=r,!1)}});const o=document.createRange();return i?e<i.data.length?o.setStart(i,e):o.setStartAfter(i):e===0?o.setStart(n,0):Xt(J(n),o),s?t<s.data.length?o.setEnd(s,t):o.setEndAfter(s):t===0?o.setEnd(n,0):Xt(J(n),o,!1),ee(o),o},_e=(n,e)=>{var t;const a=n.querySelectorAll("wbr");if(a.length===0)return;a.forEach((s,o)=>{o!==0&&s.remove()});const i=a[0];if(!i.previousElementSibling)i.previousSibling?e.setStart(i.previousSibling,i.previousSibling.textContent.length):i.nextSibling?i.nextSibling.nodeType===3?e.setStart(i.nextSibling,0):e.setStartAfter(i):e.setStart(i.parentElement,0);else{const s=ot(i);s&&i.previousElementSibling.isSameNode(s)?((t=i.previousElementSibling.lastChild)==null?void 0:t.nodeType)===3?e.setStart(i.previousElementSibling.lastChild,i.previousElementSibling.lastChild.textContent.length):s.nodeType!==3&&s.classList.contains("img")?e.setStartAfter(s):e.setStartBefore(i):e.setStart(i.previousSibling,i.previousSibling.textContent.length)}e.collapse(!0),i.remove(),ee(e)},ee=n=>{if(!n)return;const e=window.getSelection();e.removeAllRanges(),e.addRange(n)},we=(n,e,t=!0)=>{var a,i,s;if(!n)return!1;if(n.classList.contains("render-node")||n.classList.contains("iframe")||n.classList.contains("hr")){const l=document.createRange(),r=n.getAttribute("data-type");let c=!1;return r==="NodeThematicBreak"?(l.selectNodeContents(n.firstElementChild),c=!0):r==="NodeBlockQueryEmbed"?((a=n.lastElementChild.previousElementSibling)!=null&&a.firstChild?(l.selectNodeContents(n.lastElementChild.previousElementSibling.firstChild),l.collapse(!0)):(l.selectNodeContents(n),l.collapse(!0)),c=!0):["NodeMathBlock","NodeHTMLBlock"].includes(r)?((s=(i=n.lastElementChild.previousElementSibling)==null?void 0:i.lastElementChild)!=null&&s.firstChild?(l.selectNodeContents(n.lastElementChild.previousElementSibling.lastElementChild.firstChild),l.collapse(!0)):n.lastElementChild.previousElementSibling&&(l.selectNodeContents(n.lastElementChild.previousElementSibling),l.collapse(!0)),c=!0):r==="NodeIFrame"||r==="NodeWidget"?(l.setStart(n,0),c=!0):r==="NodeVideo"?(l.setStart(n.firstElementChild,0),c=!0):r==="NodeAudio"?(l.setStart(n.firstElementChild.lastChild,0),c=!0):r==="NodeCodeBlock"&&(l.selectNodeContents(n),l.collapse(!0),c=!0),c?(ee(l),l):(ir(n),!1)}else if(n.classList.contains("av")){const l=n.querySelector(".av__title");if(l){const r=document.createRange();return r.selectNodeContents(l),r.collapse(),ee(r),r}else return!1}let o;if(t?o=J(n):Array.from(n.querySelectorAll('[contenteditable="true"]')).reverse().find(l=>{if(l.getBoundingClientRect().width>0)return o=l,!0}),o){if(o.tagName==="TABLE")if(t)o=o.querySelector("th, td");else{const r=o.querySelectorAll("th, td");o=r[r.length-1]}let l;if(t)l=ar(o,he(o)),l.collapse(!0);else{let r=!1;if(o.classList.contains("hljs")){let c=o.lastChild;c.textContent===""&&c.nodeType===3&&(c=ot(o.lastChild)),c&&c.textContent.endsWith(`
`)&&(l=he(o),l.setStart(c,c.textContent.length-1),r=!0)}r||(l=Xt(o,he(o))),l.collapse(!1)}return ee(l),l}else e&&e.focus();return!1},ir=n=>{if(n.getAttribute("data-node-id")){let t,a;n.nextElementSibling&&!n.nextElementSibling.classList.contains("protyle-attr")?(a=!0,t=Xe(n)):n.previousElementSibling&&(a=!1,t=se(n)),t||(t=n),we(t,void 0,a);return}const e=he(n);n.nextSibling?(e.selectNodeContents(n.nextSibling),e.collapse(!0)):n.previousSibling&&(e.selectNodeContents(n.previousSibling),e.collapse(!1)),ee(e)},Gt=(n,e,t)=>{e&&(Xt(J(t[t.length-1]),n.toolbar.range),n.toolbar.range.collapse(!0),_t(e,n,!0,!0),Ke(n,n.wysiwyg.element),yt(n.wysiwyg.element),Ze(n.wysiwyg.element))},Xh=(n,e)=>{const t=[];n.forEach(i=>{t.push(i.getAttribute("data-node-id"))});const a=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiCustomAction,click(){const i=new Le({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),s=i.element.querySelector("textarea"),o=i.element.querySelectorAll(".b3-button");i.bindInput(s,()=>{o[1].click()}),s.focus(),o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{_("/api/ai/chatGPTWithAction",{ids:t,action:s.value},l=>{i.destroy(),Gt(e,l.data,n)})})}},{iconHTML:p.Constants.ZWSP,label:`${window.siyuan.languages.aiCustomAction} & ${window.siyuan.languages.save}`,click(){const i=new Le({title:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),s=i.element.querySelector("input"),o=i.element.querySelectorAll(".b3-button");i.bindInput(s,()=>{o[1].click()}),s.focus(),o[0].addEventListener("click",()=>{i.destroy()}),o[1].addEventListener("click",()=>{const l=i.element.querySelector("textarea").value;window.siyuan.storage[p.Constants.LOCAL_AI].push({name:s.value,memo:l}),Ue(p.Constants.LOCAL_AI,window.siyuan.storage[p.Constants.LOCAL_AI]),_("/api/ai/chatGPTWithAction",{ids:t,action:l},r=>{i.destroy(),Gt(e,r.data,n)}),i.destroy()})}}];window.siyuan.storage[p.Constants.LOCAL_AI].forEach(i=>{a.push({iconHTML:p.Constants.ZWSP,action:"iconCloseRound",label:`<div aria-label="${ia(i.memo)}" data-type="a">${De(i.name)}</div>`,bind:s=>{s.addEventListener("click",o=>{$(o.target,"b3-menu__action")?window.siyuan.storage[p.Constants.LOCAL_AI].find((l,r)=>{if(s.querySelector(".b3-menu__label").textContent.trim()===l.name)return window.siyuan.storage[p.Constants.LOCAL_AI].splice(r,1),Ue(p.Constants.LOCAL_AI,window.siyuan.storage[p.Constants.LOCAL_AI]),s.remove(),!0}):(_("/api/ai/chatGPTWithAction",{ids:t,action:i.memo},l=>{Gt(e,l.data,n)}),window.siyuan.menus.menu.remove()),o.preventDefault(),o.stopPropagation()})}})}),window.siyuan.menus.menu.append(new I({icon:"iconSparkles",label:window.siyuan.languages.ai,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiContinueWrite,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Continue writing"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hans,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [zh-Hans]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hant,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [zh-Hant]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ja_JP,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [ja-JP]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ko_KR,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [ko-KR]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_en_US,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [en-US]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_es_ES,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [es-ES]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_fr_FR,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [fr-FR]"},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_de_DE,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:"Translate as follows to [de-DE]"},i=>{Gt(e,i.data,n)})}}]},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiExtractSummary,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:window.siyuan.languages.aiExtractSummary},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiBrainStorm,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:window.siyuan.languages.aiBrainStorm},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiFixGrammarSpell,click(){_("/api/ai/chatGPTWithAction",{ids:t,action:window.siyuan.languages.aiFixGrammarSpell},i=>{Gt(e,i.data,n)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.custom,type:"submenu",submenu:a}]}).element)},_v=(n,e)=>{const t=new Le({title:"AI Chat",content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),a=t.element.querySelector("textarea"),i=t.element.querySelectorAll(".b3-button");t.bindInput(a,()=>{i[1].click()}),a.focus(),i[0].addEventListener("click",()=>{t.destroy()}),i[1].addEventListener("click",()=>{_("/api/ai/chatGPT",{msg:a.value},s=>{t.destroy();let o="";s.data&&s.data!==""&&(o=`

`+s.data),Gt(n,`${a.value}${o}`,[e])})})};class vv{constructor(e){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`width:${Math.max(e.element.clientWidth/2,320)}px;`),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",t=>{var a;const i=t.target;if(i.tagName==="INPUT"){t.stopPropagation();return}const s=te(i,"BUTTON");if(s&&!s.classList.contains("emojis__item")&&!s.classList.contains("emojis__type")){this.source!=="search"?this.fill(decodeURIComponent(s.getAttribute("data-value")),e,!0,ye(t)):setTimeout(()=>{this.fill(decodeURIComponent(s.getAttribute("data-value")),e)},148),ee(e.toolbar.range),t.preventDefault(),t.stopPropagation();return}const o=this.element.querySelector(".emojis__panel"),l=$(i,"emojis__type");if(l){const c=o.querySelector(`[data-type="${l.getAttribute("data-type")}"]`);if(c){const u=c.nextElementSibling.getAttribute("data-index");if(u){let d="";window.siyuan.emojis[parseInt(u)].items.forEach(f=>{d+=`<button data-unicode="${f.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?f.description_zh_cn:f.description}">
${fe(f.unicode)}</button>`}),c.nextElementSibling.innerHTML=d,c.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:c.offsetTop})}return}const r=$(i,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3?(a=u.endContainer.childNodes[u.endOffset-1])==null||a.remove():u.endContainer.textContent===":"&&(u.endContainer.textContent=""),gi(c);let d;c.indexOf(".")>-1?d=`:${c.split(".")[0]}: `:d=fe(c)+" ",_t(e.lute.SpinBlockDOM(d),e,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,e)}})}render(e){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(e.toolbar.range=getSelection().getRangeAt(0),e.toolbar.range.startContainer.nodeType===3&&e.toolbar.range.startContainer.textContent===""){const s=ot(e.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let o=s.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{s.textContent=o.textContent+s.textContent,o.remove();break}}e.toolbar.range.setStart(s,s.textContent.length),e.toolbar.range.collapse(!0)}}const t=Et(e.toolbar.range.startContainer,e.wysiwyg.element).start,a=e.toolbar.range.startContainer.textContent.substring(0,t)||"",i=this.getKey(a,e.options.hint.extend);if(typeof i=="undefined"||S(e.toolbar.range.startContainer,"data-type","code")||S(e.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=M(e.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const o=Et(e.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(e,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!(0,T.tq)()&&this.genHTML($c(i,e),e,!1,"hint");return}e.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,e,"hint"),e,!1,"hint")},e.options.hint.delay))})}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const t=Cn(e.wysiwyg.element);Ve(this.element,t.left,t.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(e,t){const a=t.querySelector('input[type="file"]');a&&a.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=he(e.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),da(e,i.target.files,i.target),ne(["hint","toolbar"],e)})}getHTMLByData(e){let t='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(t='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),e.forEach((a,i)=>{let s="";(i===1&&e[i].focus||i===0&&(e.length===1||!e[1].focus))&&(s=" b3-list-item--focus"),a.html==="separator"?t+='<div class="b3-menu__separator"></div>':t+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${t}</div>`}genHTML(e,t,a=!1,i){var s;if(this.source=i,e.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(e),this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(t.element.clientWidth/2,320)+"px",this.source==="av"){const o=$(t.toolbar.range.startContainer,"av__cell");if(o){const l=o.getBoundingClientRect();Ve(this.element,l.left,l.bottom,l.height)}}else{const o=Cn(t.wysiwyg.element);Ve(this.element,o.left,o.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(t,this.element),this.source!=="hint"){const o=this.element.querySelector("input.b3-text-field"),l=((s=this.element.querySelector("mark"))==null?void 0:s.textContent)||"";o.value=l,o.select(),o.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(En(this.element.lastElementChild,c),c.key==="Enter"?(setTimeout(()=>{this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),t)},148),ee(t.toolbar.range),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),ee(t.toolbar.range)))});const r=t.toolbar.range?M(t.toolbar.range.startContainer):!1;o.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(t,o,r,l))}),o.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(t,o,r,l)})}}genSearchHTML(e,t,a,i){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',_("/api/search/searchRefBlock",{k:t.value,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID},s=>{let o="";if(s.data.newDoc){const l=`((newFile "${i}"${p.Constants.ZWSP}'${s.data.k}${Lute.Caret}'))`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(l)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div></button>`}s.data.blocks.forEach((l,r)=>{const c=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${i}</span>`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${r===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${Pc(l)}
</button>`}),o===""&&(o=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=o})}genEmojiHTML(e,t=""){if(t&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=po(t,256),t?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),fo(a)):(this.element.innerHTML=`<div style="padding: 0" class="emojis">
<div class="emojis__panel">${po(t,256)}</div>
<div class="fn__flex${t?" fn__none":""}">
    <button data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${fe("2b50")}</button>
    <button data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f527")}</button>
    <button data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f60d")}</button>
    <button data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f433")}</button>
    <button data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f96a")}</button>
    <button data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f3a8")}</button>
    <button data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f3dd")}</button>
    <button data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f52e")}</button>
    <button data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("267e")}</button>
    <button data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${fe("1f6a9")}</button>
</div>
</div>`,Zl(this.element),fo(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(e.element.clientWidth/2,320)+"px";const s=Cn(e.wysiwyg.element);Ve(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,t,a=!0,i=!1){var s;ne(["hint","toolbar"],t),a&&this.source!=="av"&&(t.toolbar.range=he(t.wysiwyg.element));const o=t.toolbar.range;let l=M(t.toolbar.range.startContainer);if(!l)return;if(this.source==="av"){const d=$(t.toolbar.range.startContainer,"av__cell");if(!d)return;const f=d.dataset.blockId,g=l.getAttribute("data-av-id");let h=document.createElement("div");if(h.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),h=h.firstElementChild,e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const m=e.substring(11,e.length-4).split(`"${p.Constants.ZWSP}'`),b=m.length===1?m[0]:m[1];Ec(t.path,t.notebookId,y=>{_("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:xe().join(y,b),parentID:t.block.rootID,markdown:""},w=>{G(t,[{action:"replaceAttrViewBlock",avID:g,previousID:f,nextID:w.data,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:w.data,nextID:f,isDetached:!0}])})})}else{const m=h.getAttribute("data-id");G(t,[{action:"replaceAttrViewBlock",avID:g,previousID:f,nextID:m,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:m,nextID:f,isDetached:!0}])}return}this.enableExtend=!1;let r="";l&&(r=l.getAttribute("data-node-id"));const c=l.outerHTML,u=p.Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&u&&o.startContainer.nodeType===3&&o.startContainer.wholeText.indexOf(u)>-1&&o.startContainer.wholeText.indexOf(this.splitChar)>-1){let d=0,f=o.startContainer;for(;f&&d<2;){const g=f.textContent.indexOf(u),h=f.textContent.indexOf(this.splitChar);if(g>-1&&(g<h||h<0)){d=2,o.setEnd(f,g+2);break}const m=f.textContent.indexOf(u.substr(1));if(m>-1&&(d+=1),d===2){o.setEnd(f,m+1);break}f=f.nextSibling}}if(this.lastIndex>-1&&(o.setStart(o.startContainer,this.lastIndex),Pt()&&ee(o)),p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){ee(o);const d=e.substring(11,e.length-4).split(`"${p.Constants.ZWSP}'`),f=d.length===1?d[0]:d[1];Ec(t.path,t.notebookId,g=>{_("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:xe().join(g,f),parentID:t.block.rootID,markdown:""},h=>{t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${h.data}${p.Constants.ZWSP}${d.length===2||i?"s":"d"}${p.Constants.ZWSP}${(d.length===2?d[0]:f).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(e===""){const f=J(l);f.textContent===""&&(f.innerHTML="<wbr>",_e(f,o));return}let d=document.createElement("div");if(d.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),d=d.firstElementChild,i){const f=o.toString().replace(this.splitChar,"");f&&(d.setAttribute("data-subtype","s"),d.innerText=f)}t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${d.getAttribute("data-id")}${p.Constants.ZWSP}${d.getAttribute("data-subtype")}${p.Constants.ZWSP}${d.textContent}`});return}else if(this.splitChar===":"){gi(e);let d;e.indexOf(".")>-1?d=`:${e.split(".")[0]}: `:d=fe(e)+" ",_t(t.lute.SpinBlockDOM(d),t)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(e===""){const d=J(l);d.textContent===""&&(d.innerHTML="<wbr>",_e(d,o));return}_t(t.lute.SpinBlockDOM(e),t,!1,(0,T.tq)()),Ke(t,t.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,e==="(("||e==="{{"){e==="(("?ii("",t,"hint"):Yi("",t),this.splitChar=e,this.lastIndex=0,o.deleteContents();const d=document.createTextNode(e);o.insertNode(d),o.setEnd(d,e.length),o.collapse(!1);return}else if(e===p.Constants.ZWSP){o.deleteContents(),this.fixImageCursor(o),t.toolbar.showTpl(t,l,o),ie(t,r,l.outerHTML,c);return}else if(e===p.Constants.ZWSP+1){o.deleteContents(),this.fixImageCursor(o),t.toolbar.showWidget(t,l,o),ie(t,r,l.outerHTML,c);return}else if(e===p.Constants.ZWSP+2){o.deleteContents(),this.fixImageCursor(o),t.toolbar.range=o;const d=Cn(l,o);t.toolbar.showAssets(t,{x:d.left,y:d.top+26,w:0,h:26}),ie(t,r,l.outerHTML,c);return}else if(e===p.Constants.ZWSP+3){o.deleteContents();return}else if(e===p.Constants.ZWSP+4){const d=Lute.NewNodeID();_("/api/filetree/createDoc",{notebook:t.notebookId,path:xe().join(pt(t.path,!1,!0),d+".sy"),title:"Untitled",md:""},()=>{_t(`<span data-type="block-ref" data-id="${d}" data-subtype="d">Untitled</span>`,t),be({app:t.app,id:d,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})});return}else if(e===p.Constants.ZWSP+5){o.deleteContents(),_v(t,l);return}else if(p.Constants.INLINE_TYPE.includes(e)){if(o.deleteContents(),ee(o),["a","block-ref","inline-math","inline-memo","text"].includes(e)){t.toolbar.element.querySelector(`[data-type="${e}"]`).dispatchEvent(new CustomEvent("click"));return}t.toolbar.setInlineMark(t,e,"range");return}else if(e==="emoji"){o.deleteContents(),o.insertNode(document.createTextNode(":")),o.collapse(!1),this.genEmojiHTML(t);return}else if(e.indexOf("style")>-1){o.deleteContents(),this.fixImageCursor(o),l.setAttribute("style",e.split(p.Constants.ZWSP)[1]||""),ie(t,r,l.outerHTML,c);return}else if(e.startsWith("plugin")){t.app.plugins.find(d=>{const f=e.split(p.Constants.ZWSP);if(f[1]===d.name)return d.protyleSlash.find(g=>{if(g.id===f[2])return g.callback(t.getInstance()),!0}),!0});return}else{o.deleteContents(),e!=="![]()"&&this.fixImageCursor(o);let d=e;e==="```"&&(d=e+window.siyuan.storage[p.Constants.LOCAL_CODELANG]+Lute.Caret+"\n```");const f=J(l);if(e==="![]()"){let g="";o.insertNode(document.createElement("wbr")),o.insertNode(document.createTextNode(e)),g=t.lute.SpinBlockDOM(l.outerHTML),l.outerHTML=g,l=t.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),_e(l,o),ie(t,r,l.outerHTML,c);let h=o.startContainer.childNodes[o.startOffset-1]||o.startContainer;h&&h.nodeType!==3&&h.classList.contains("img")||(((s=h.previousSibling)==null?void 0:s.nodeType)!==3&&h.previousSibling.classList.contains("img")?h=h.previousSibling:Array.from(l.querySelectorAll(".img")).find(b=>{if(b.querySelector("img").getAttribute("data-src")==="")return h=b,!0}));const m=h.getBoundingClientRect();td(t,o,h,{clientX:m.left,clientY:m.top});return}else if(f.textContent===""&&l.getAttribute("data-type")==="NodeParagraph"){let g="";e==="<div>"?g=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${Ta()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(f.textContent=d,g=t.lute.SpinBlockDOM(l.outerHTML)),l.outerHTML=g,l=t.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),l.getAttribute("data-type")==="NodeTable"&&(l.querySelectorAll("colgroup col").forEach(h=>{h.style.minWidth="60px"}),g=l.outerHTML),ie(t,r,g,c)}else{let g=t.lute.SpinBlockDOM(d);e==="<div>"&&(g=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${Ta()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),l.insertAdjacentHTML("afterend",g);const h=l.outerHTML,m=g.substr(g.indexOf('data-node-id="')+14,22);l=t.wysiwyg.element.querySelector(`[data-node-id="${m}"]`),l.getAttribute("data-type")==="NodeTable"&&l.querySelectorAll("colgroup col").forEach(b=>{b.style.minWidth="60px"}),G(t,[{data:h,id:r,action:"update"},{data:l.outerHTML,id:m,previousID:r,action:"insert"}],[{id:m,action:"delete"},{data:c,id:r,action:"update"}])}if(e==="<div>"||e==="$$"||e.indexOf("```")>-1&&e.length>3)t.toolbar.showRender(t,l),yt(l);else if(e.startsWith("```"))Ze(l);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){t.gutter.renderMenu(t,l);const g=l.getBoundingClientRect();window.siyuan.menus.menu.popup({x:g.left,y:g.top,isLeft:!0});const h=window.siyuan.menus.menu.element.querySelector('[data-id="assetSubMenu"]');h.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(h.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else e==="---"?we(l):l.classList.contains("av")?Ct(l,t):_e(l,o)}}select(e,t){var a,i,s;const o=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!o)return!1;if(e.key==="Enter"){if(o){const l=this.element.querySelector(".emojis__item--current");if(!l)return!1;const r=l.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3&&((a=c.endContainer.childNodes[c.endOffset-1])==null||a.remove()),gi(r);let u;r.indexOf(".")>-1?u=`:${r.split(".")[0]}: `:u=fe(r)+" ",_t(t.lute.SpinBlockDOM(u),t),this.element.classList.add("fn__none")}else this.fill(r,t)}else{const l=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));l===p.Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(l,t,!0,ye(e))}return e.preventDefault(),e.stopPropagation(),!0}if(o){const l=this.element.querySelector(".emojis__item--current");if(!l)return!1;let r;if(e.key==="ArrowLeft"||e.key==="ArrowUp"?l.previousElementSibling?(l.classList.remove("emojis__item--current"),r=l.previousElementSibling):(i=l.parentElement.previousElementSibling)!=null&&i.previousElementSibling&&(l.classList.remove("emojis__item--current"),r=l.parentElement.previousElementSibling.previousElementSibling.lastElementChild):(e.key==="ArrowRight"||e.key==="ArrowDown")&&(l.nextElementSibling?(l.classList.remove("emojis__item--current"),r=l.nextElementSibling):(s=l.parentElement.nextElementSibling)!=null&&s.nextElementSibling&&(l.classList.remove("emojis__item--current"),r=l.parentElement.nextElementSibling.nextElementSibling.firstElementChild)),r){r.classList.add("emojis__item--current");const c=4,u=this.element.querySelector(".emojis__panel");r.offsetTop-c<u.scrollTop?u.scrollTop=r.offsetTop-c:r.offsetTop-c-u.clientHeight+r.clientHeight>u.scrollTop&&(u.scrollTop=r.offsetTop-c-u.clientHeight+r.clientHeight)}return e.preventDefault(),e.stopPropagation(),!0}else if(e.key==="ArrowDown"||e.key==="ArrowUp")return En(this.element.firstElementChild,e),e.preventDefault(),e.stopPropagation(),!0;return e.key==="ArrowLeft"||e.key==="ArrowRight"?(ne(["hint"],t),e.preventDefault(),e.stopPropagation(),!0):!1}fixImageCursor(e){const t=ot(e.startContainer);t&&t.nodeType!==3&&t.classList.contains("img")&&(rt(t)||(e.insertNode(document.createTextNode(p.Constants.ZWSP)),e.collapse(!1)))}getKey(e,t){if(this.lastIndex=-1,this.splitChar="",t.forEach(s=>{const o=e.lastIndexOf(s.key);this.lastIndex<o&&(p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&(s.key===":"||s.key==="#"||s.key==="/"||s.key==="\u3001")||this.splitChar==="#"&&(s.key==="/"||s.key==="\u3001")||(this.splitChar=s.key,this.lastIndex=o))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(e.substr(this.lastIndex-1,1))||e.substr(this.lastIndex-1,2)==="::"));const a=e.split(this.splitChar),i=a[a.length-1];if(a.length>1&&i.trim()===i&&i.length<p.Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&e.endsWith("\u3010\u3010\u3011")?"":i}}const Ev=n=>{const e=Lute.New();if(e.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.SetFileAnnotationRef(!0),e.SetTextMark(!0),e.SetHeadingID(!1),e.SetYamlFrontMatter(!1),e.PutEmojis(n.emojis),e.SetEmojiSite(n.emojiSite),e.SetHeadingAnchor(n.headingAnchor),e.SetInlineMathAllowDigitAfterOpenMarker(!0),e.SetToC(!1),e.SetIndentCodeBlock(!1),e.SetParagraphBeginningSpace(!0),e.SetSetext(!1),e.SetFootnotes(!1),e.SetLinkRef(!1),e.SetSanitize(n.sanitize),e.SetChineseParagraphBeginningSpace(n.paragraphBeginningSpace),e.SetRenderListStyle(n.listStyle),e.SetImgPathAllowSpace(!0),e.SetKramdownIAL(!0),e.SetTag(!0),e.SetSuperBlock(!0),e.SetGitConflict(!0),e.SetMark(!0),e.SetSup(!0),e.SetSub(!0),e.SetProtyleWYSIWYG(!0),n.lazyLoadImage&&e.SetImageLazyLoading(n.lazyLoadImage),e.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const t={};window.siyuan.emojis[0].items.forEach(a=>{t[a.keywords]=n.emojiSite+"/"+a.unicode}),e.PutEmojis(t)}return e},kv=(n,e)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const t='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const l=speechSynthesis.getVoices();let r,c;return l.forEach(u=>{u.lang===e.replace("_","-")&&(r=u),u.default&&(c=u)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const o=s();i.onclick=()=>{if(i.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(i.getAttribute("data-text"));l.voice=o,l.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=t},speechSynthesis.speak(l),i.className="protyle-speech protyle-speech--current",i.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=a):(speechSynthesis.pause(),i.innerHTML=t));ee(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}n.addEventListener("mouseup",s=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=t,i.style.display="block",i.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",o)})};class Sv{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const t=document.createElement("div");t.className="b3-typography",e.options.classes.preview&&t.classList.add(e.options.classes.preview),t.style.padding=e.wysiwyg.element.style.padding;const a=e.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let o=0;o<a.length;o++){const l=a[o];if(typeof l=="object"){s.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":s.push('<button type="button" class="protyle-preview__action--current" data-type="desktop">Desktop</button>');break;case"tablet":s.push('<button type="button" data-type="tablet">Tablet</button>');break;case"mobile":s.push('<button type="button" data-type="mobile">Mobile/Wechat</button>');break;case"mp-wechat":s.push('<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u516C\u4F17\u53F7"><svg><use xlink:href="#iconMp"></use></svg></button>');break;case"zhihu":s.push('<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u77E5\u4E4E"><svg><use xlink:href="#iconZhihu"></use></svg></button>');break;case"yuque":s.push('<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u8BED\u96C0"><svg><use xlink:href="#iconYuque"></use></svg></button>');break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(t),this.element.addEventListener("click",o=>{e.model&&(lt(e.model.element.parentElement.parentElement),qd(Ye(),e.model.editor.protyle));let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){const r=l.getAttribute("href");if(r.startsWith("#")){t.querySelector(r).scrollIntoView(),o.stopPropagation(),o.preventDefault();break}if((0,T.tq)()){z(r),o.stopPropagation(),o.preventDefault();break}o.stopPropagation(),o.preventDefault(),go(r)?o.metaKey||o.ctrlKey?is(r,"folder"):o.shiftKey?is(r,"app"):p.Constants.SIYUAN_ASSETS_EXTS.includes(xe().extname(r.split("?page")[0]))&&as(e.app,r.split("?page")[0],parseInt((0,T.on)("page",r))):window.open(r);break}else if(l.tagName==="IMG"){Sf(o.target.src,e.block.rootID),o.stopPropagation(),o.preventDefault();break}else if(l.tagName==="BUTTON"){const r=l.getAttribute("data-type"),c=a.find(u=>(u==null?void 0:u.key)===r);c?c.click(r):r==="mp-wechat"||r==="zhihu"||r==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),e,r):r==="desktop"?(t.style.width="",t.style.padding=e.wysiwyg.element.style.padding):r==="tablet"?(t.style.width="1024px",t.style.padding="8px 16px"):(t.style.width="360px",t.style.padding="8px"),this.render(e),i.querySelectorAll("button").forEach(u=>{u.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current")}l=l.parentElement}}),this.previewElement=t}render(e,t){if(this.element.style.display==="none")return;let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{_("/api/export/preview",{id:e.block.parentID||e.options.blockId},i=>{const s=e.preview.previewElement.scrollTop;e.preview.previewElement.innerHTML=i.data.html,yt(e.preview.previewElement),Ze(e.preview.previewElement),Ct(e.preview.previewElement,e),kv(e.preview.previewElement,e.options.lang),e.preview.previewElement.scrollTop=s,i.data=i.data.outline,Ye().outline.forEach(o=>{(o.type==="pin"||o.type==="local"&&o.blockId===e.block.rootID)&&(o.isPreview=!0,o.update(i,e.block.rootID),o.type==="pin"&&o.updateDocTitle(e.background.ial))}),a.remove()})},e.options.preview.delay)}link2online(e){sa("")||e.querySelectorAll("[href],[src]").forEach(t=>{const a=t.getAttribute("href")||t.getAttribute("src");if(a&&a.startsWith("assets/")){const i=p.Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;t.getAttribute("href")?t.setAttribute("href",i):t.setAttribute("src",i)}})}copyToX(e,t,a){if(a==="mp-wechat")this.link2online(e),e.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),e.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}\\" style="display: block; margin: 0 auto; max-width: 100%;">`}),e.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(e);else if(a==="yuque"){_("/api/lute/copyStdMarkdown",{id:t.block.rootID},o=>{O(o.data),q("\u5DF2\u590D\u5236\uFF0C\u53EF\u5230\u8BED\u96C0\u8FDB\u884C\u7C98\u8D34")});return}e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(e);const i=getSelection().getRangeAt(0).cloneRange(),s=e.ownerDocument.createRange();s.selectNodeContents(e),ee(s),document.execCommand("copy"),this.element.lastElementChild.remove(),ee(i),a&&q(`\u5DF2\u590D\u5236\uFF0C\u53EF\u5230${a==="zhihu"?"\u77E5\u4E4E":"\u5FAE\u4FE1\u516C\u4F17\u53F7\u5E73\u53F0"}\u8FDB\u884C\u7C98\u8D34`)}processZHBlockquote(e,t){Array.from(e.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,t);else if(a.tagName!=="P"||a.querySelector("img"))t.push(a);else{const i=t[t.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&t.push(document.createElement("blockquote")),t[t.length-1].append(a)}})}processZHTable(e){e.querySelectorAll("table").forEach(t=>{const a=t.querySelector("thead");if(!a)return;const i=t.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",a.firstElementChild):t.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const Jh=(...n)=>{const e={},t=a=>{for(const i in a)a.hasOwnProperty(i)&&(Object.prototype.toString.call(a[i])==="[object Object]"?e[i]=Jh(e[i],a[i]):e[i]=a[i])};for(let a=0;a<n.length;a++)t(n[a]);return e};class Lv{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},debugger:p.Constants.NODE_ENV==="development",hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:ii},{key:"\u3010\u3010",hint:ii},{key:"\uFF08\uFF08",hint:ii},{key:"[[",hint:ii},{key:"{{",hint:Yi},{key:"\u300C\u300C",hint:Yi},{key:"\u300C\u300E",hint:Yi},{key:"\u300E\u300C",hint:Yi},{key:"\u300E\u300E",hint:Yi},{key:"#",hint:pw},{key:"/",hint:$c},{key:"\u3001",hint:$c},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:1e3,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:(0,T.tq)()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],typewriterMode:!1,upload:{max:1024*1024*1024*4,url:p.Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:t=>t.replace(/[\\/:*?"'<>|]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){var e;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(e=this.options.hint)!=null&&e.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),Jh(this.defaultOptions,this.options)}mergeToolbar(e){const t=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return e.forEach(i=>{let s=i;t.find(o=>{if(typeof i=="string"&&o.name===i)return s=o,!0;if(typeof i=="object"&&o.name===i.name)return s=Object.assign({},o,i),!0}),a.push(s)}),a}}class Cv{constructor(e){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),(0,T.tq)()||(this.parentElement.style.right="10px"),this.parentElement.innerHTML=`<div class="b3-tooltips b3-tooltips__w protyle-scroll__up" aria-label="${ae("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar b3-tooltips b3-tooltips__s" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="b3-tooltips b3-tooltips__w protyle-scroll__down" aria-label="${ae("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,e.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)}),this.inputElement.addEventListener("change",()=>{this.setIndex(e)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(e)}),this.parentElement.addEventListener("click",t=>{const a=t.target;$(a,"protyle-scroll__up")?dp(e):$(a,"protyle-scroll__down")?up(e):a.classList.contains("b3-slider")&&this.setIndex(e)})}setIndex(e){e.wysiwyg.element.getAttribute("data-top")||(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),_("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},t=>{dt({data:t,protyle:e,action:[p.Constants.CB_GET_FOCUSFIRST,p.Constants.CB_GET_UNCHANGEID]})}))}updateIndex(e,t){_("/api/block/getBlockIndex",{id:t},a=>{if(!a.data)return;const i=e.scroll.element.querySelector(".b3-slider");i.value=a.data,e.scroll.element.setAttribute("aria-label",`Blocks ${a.data}/${e.block.blockCount}`)})}update(e){typeof e.block.blockCount=="number"&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.scroll?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}var sr=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Qh=(n,e,t,a,i,s,o)=>{let l;const r=t.getAttribute("data-node-id"),c=a.getAttribute("data-node-id"),u=[],d=[];return t.insertAdjacentElement(s?"afterend":"beforebegin",a),s?u.push({action:"insert",data:a.outerHTML,id:c,previousID:r}):u.push({action:"insert",data:a.outerHTML,id:c,nextID:r}),e.reverse().forEach((f,g)=>{var h;const m=f.getAttribute("data-node-id");g===e.length-1&&(l=Oe(f),l.isSameNode(f)&&(l=void 0));const b=Lute.NewNodeID();if(o?d.push({action:"delete",id:b}):d.push({action:"move",id:m,previousID:(h=f.previousElementSibling)==null?void 0:h.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||n.block.rootID}),!i&&!o){const y=n.wysiwyg.element.querySelector(`[data-node-id="${m}"]`);y&&y.remove()}if(o){const y=f.cloneNode(!0);y.setAttribute("data-node-id",b),y.querySelectorAll("[data-node-id]").forEach(w=>{const E=Lute.NewNodeID();w.setAttribute("data-node-id",E),w.setAttribute("updated",E.split("-")[0])}),a.insertAdjacentElement("afterbegin",y),u.push({action:"insert",id:b,data:y.outerHTML,parentID:c})}else a.insertAdjacentElement("afterbegin",f),u.push({action:"move",id:m,parentID:c})}),d.reverse(),a.getAttribute("data-subtype")==="o"&&(d.splice(0,0,{action:"update",id:c,data:a.outerHTML}),ct(a,1),u.push({action:"update",id:c,data:a.outerHTML})),d.push({action:"delete",id:c}),{doOperations:u,undoOperations:d,topSourceElement:l}},em=(n,e,t,a,i,s)=>sr(void 0,null,function*(){let o;const l=[],r=[],c=[],u=t.getAttribute("data-node-id");let d=t;e.reverse().forEach((f,g)=>{var h,m,b,y,w;const E=f.getAttribute("data-node-id"),k=f.parentElement.getAttribute("data-node-id")||n.block.rootID;g===e.length-1&&(o=Oe(f),o.isSameNode(f)?o=void 0:o.contains(f)&&o.contains(t)&&(o=t)),s&&f.getAttribute("data-type")==="NodeHeading"&&f.getAttribute("fold")==="1"&&(f.removeAttribute("fold"),c.push({id:E,parentID:k}));let L,v;if(s?(L=Lute.NewNodeID(),r.push({action:"delete",id:L})):r.push({action:"move",id:E,previousID:(h=f.previousElementSibling)==null?void 0:h.getAttribute("data-node-id"),parentID:k}),!a&&!s){const A=n.wysiwyg.element.querySelector(`[data-node-id="${E}"]`);A&&A.remove()}s?(v=f.cloneNode(!0),v.setAttribute("data-node-id",L),v.querySelectorAll("[data-node-id]").forEach(A=>{const C=Lute.NewNodeID();A.setAttribute("data-node-id",C),A.setAttribute("updated",C.split("-")[0])}),d.insertAdjacentElement(i,v),l.push({action:"insert",id:L,data:v.outerHTML,previousID:i==="afterend"?u:(m=v.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:((b=v.parentElement)==null?void 0:b.getAttribute("data-node-id"))||n.block.parentID||n.block.rootID})):(d.insertAdjacentElement(i,f),l.push({action:"move",id:E,previousID:i==="afterend"?u:(y=f.previousElementSibling)==null?void 0:y.getAttribute("data-node-id"),parentID:((w=f.parentElement)==null?void 0:w.getAttribute("data-node-id"))||n.block.parentID||n.block.rootID})),i!=="afterend"&&(d=s?v:f)}),r.reverse();for(let f=0;f<c.length;f++){const g=c[f];(yield kt("/api/block/getHeadingChildrenIDs",{id:g.id})).data.reverse().forEach(m=>{r.push({action:"move",id:m,previousID:g.id,parentID:g.parentID})}),r.push({action:"foldHeading",id:g.id,data:"remove"}),l.push({action:"unfoldHeading",id:g.id})}return{doOperations:l,undoOperations:r,topSourceElement:o}}),tm=(n,e,t,a,i,s)=>sr(void 0,null,function*(){var o,l,r,c,u,d;const f=n.element.contains(e[0]);let g;e[0].getAttribute("data-type")==="NodeListItem"&&t.getAttribute("data-type")!=="NodeListItem"&&(g=document.createElement("div"),g.setAttribute("data-node-id",Lute.NewNodeID()),g.setAttribute("data-type","NodeList"),g.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),g.className="list",g.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`));const h=[{action:"move",id:t.getAttribute("data-node-id"),previousID:(o=t.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:((l=t.parentElement)==null?void 0:l.getAttribute("data-node-id"))||n.block.parentID||n.block.rootID}];let m,b=e[0].parentElement;const y=lf(i);t.parentElement.replaceChild(y,t);const w=[{action:"insert",data:y.outerHTML,id:y.getAttribute("data-node-id"),nextID:(r=y.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=y.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:y.parentElement.getAttribute("data-node-id")||n.block.parentID||n.block.rootID}];if(g){const E=g.getAttribute("data-node-id");y.insertAdjacentElement("afterbegin",t),w.push({action:"move",id:t.getAttribute("data-node-id"),parentID:y.getAttribute("data-node-id")}),a?(t.insertAdjacentElement("afterend",g),w.push({action:"insert",data:g.outerHTML,id:E,previousID:t.getAttribute("data-node-id")})):(t.insertAdjacentElement("beforebegin",g),w.push({action:"insert",data:g.outerHTML,id:E,nextID:t.getAttribute("data-node-id")})),e.reverse().forEach((k,L)=>{var v;L===e.length-1&&(m=Oe(k),m.isSameNode(k)&&(m=void 0));const A=Lute.NewNodeID();if(s?h.push({action:"delete",id:A}):h.push({action:"move",id:k.getAttribute("data-node-id"),previousID:(v=k.previousElementSibling)==null?void 0:v.getAttribute("data-node-id"),parentID:k.parentElement.getAttribute("data-node-id")||n.block.rootID}),!f&&!s){const C=n.wysiwyg.element.querySelector(`[data-node-id="${k.getAttribute("data-node-id")}"]`);C&&C.remove()}if(s){const C=k.cloneNode(!0);C.setAttribute("data-node-id",A),C.querySelectorAll("[data-node-id]").forEach(D=>{const x=Lute.NewNodeID();D.setAttribute("data-node-id",x),D.setAttribute("updated",x.split("-")[0])}),g.insertAdjacentElement("afterbegin",C),w.push({action:"insert",id:A,data:C.outerHTML,parentID:E})}else g.insertAdjacentElement("afterbegin",k),w.push({action:"move",id:k.getAttribute("data-node-id"),parentID:E})}),h.reverse(),h.push({action:"delete",id:E})}else{const E=[];let k;e.reverse().forEach((L,v)=>{var A;const C=L.getAttribute("data-node-id"),D=L.parentElement.getAttribute("data-node-id")||n.block.rootID;v===e.length-1&&(m=Oe(L),m.isSameNode(L)&&(m=void 0));const x=Lute.NewNodeID();if(v===0&&(k=s?x:C),s&&L.getAttribute("data-type")==="NodeHeading"&&L.getAttribute("fold")==="1"&&(L.removeAttribute("fold"),E.push({id:C,parentID:D})),s?h.push({action:"delete",id:x}):h.push({action:"move",id:C,previousID:(A=L.previousElementSibling)==null?void 0:A.getAttribute("data-node-id"),parentID:D}),!f&&!s){const P=n.wysiwyg.element.querySelector(`[data-node-id="${C}"]`);P&&P.remove()}if(s){const P=L.cloneNode(!0);P.setAttribute("data-node-id",x),P.querySelectorAll("[data-node-id]").forEach(B=>{const V=Lute.NewNodeID();B.setAttribute("data-node-id",V),B.setAttribute("updated",V.split("-")[0])}),y.insertAdjacentElement("afterbegin",P),w.push({action:"insert",id:x,data:P.outerHTML,parentID:y.getAttribute("data-node-id")})}else y.insertAdjacentElement("afterbegin",L),w.push({action:"move",id:C,parentID:y.getAttribute("data-node-id")})}),h.reverse();for(let L=0;L<E.length;L++){const v=E[L],A=yield kt("/api/block/getHeadingChildrenIDs",{id:v.id});A.data.reverse().forEach(C=>{h.push({action:"move",id:C,previousID:v.id,parentID:v.parentID})}),L===0&&(k=A.data[0]),h.push({action:"foldHeading",id:v.id,data:"remove"}),w.push({action:"unfoldHeading",id:v.id})}a?(y.insertAdjacentElement("afterbegin",t),w.push({action:"move",id:t.getAttribute("data-node-id"),parentID:y.getAttribute("data-node-id")})):(y.lastElementChild.insertAdjacentElement("beforebegin",t),w.push({action:"move",id:t.getAttribute("data-node-id"),previousID:k}))}if(h.push({action:"delete",id:y.getAttribute("data-node-id")}),!s&&b&&b.classList.contains("list")&&b.getAttribute("data-subtype")==="o"&&!b.isSameNode(e[0].parentElement)&&b.childElementCount>1&&(Array.from(b.children).forEach(E=>{E.classList.contains("protyle-attr")||h.splice(0,0,{action:"update",id:E.getAttribute("data-node-id"),data:E.outerHTML})}),ct(b,1),Array.from(b.children).forEach(E=>{E.classList.contains("protyle-attr")||w.push({action:"update",id:E.getAttribute("data-node-id"),data:E.outerHTML})})),!s&&m){if(w.push({action:"delete",id:m.getAttribute("data-node-id")}),h.splice(0,0,{action:"insert",data:m.outerHTML,id:m.getAttribute("data-node-id"),previousID:(u=m.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:((d=m.parentElement)==null?void 0:d.getAttribute("data-node-id"))||n.block.parentID||n.block.rootID}),!f){const E=n.wysiwyg.element.querySelector(`[data-node-id="${m.getAttribute("data-node-id")}"]`);E&&E.remove()}b=m.parentElement,m.remove()}if(!s&&b&&b.classList.contains("sb")&&b.childElementCount===2){const E=Ri(n,b);w.push(E.doOperations[0],E.doOperations[1]),h.splice(0,0,E.undoOperations[0],E.undoOperations[1])}else if(!s&&b&&b.classList.contains("protyle-wysiwyg")&&b.innerHTML===""){const E=$(b,"protyle",!0);if(E&&!E.classList.contains("block__edit")){const k=St(E.getAttribute("data-id"));if(k&&k.model instanceof gt&&k.model.editor.protyle.block.id===k.model.editor.protyle.block.rootID){const L=Lute.NewNodeID();w.splice(0,0,{action:"insert",id:L,data:Nn(!1,!1,L).outerHTML,parentID:k.model.editor.protyle.block.parentID}),h.splice(0,0,{action:"delete",id:L})}}}f||s?G(n,w,h):G(n,w),we(e[0])}),nm=(n,e,t,a,i)=>sr(void 0,null,function*(){var s,o;const l=n.element.contains(e[0]),r=[],c=[];let u;e[0].getAttribute("data-type")==="NodeListItem"&&t.getAttribute("data-type")!=="NodeListItem"&&(u=document.createElement("div"),u.setAttribute("data-node-id",Lute.NewNodeID()),u.setAttribute("data-type","NodeList"),u.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),u.className="list",u.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`));let d,f=e[0].parentElement;if(a)if(u){const g=Qh(n,e,t,u,l,a,i);r.push(...g.doOperations),c.push(...g.undoOperations),d=g.topSourceElement}else{const g=yield em(n,e,t,l,"afterend",i);r.push(...g.doOperations),c.push(...g.undoOperations),d=g.topSourceElement}else if(u){const g=Qh(n,e,t,u,l,a,i);r.push(...g.doOperations),c.push(...g.undoOperations),d=g.topSourceElement}else{const g=yield em(n,e,t,l,"beforebegin",i);r.push(...g.doOperations),c.push(...g.undoOperations),d=g.topSourceElement}if(t.getAttribute("data-type")==="NodeListItem"&&t.getAttribute("data-subtype")==="o"&&(Array.from(t.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||c.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})}),ct(t.parentElement,1),Array.from(t.parentElement.children).forEach(g=>{g.classList.contains("protyle-attr")||r.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!i&&l&&f&&f.classList.contains("list")&&f.getAttribute("data-subtype")==="o"&&!f.isSameNode(e[0].parentElement)&&f.childElementCount>1&&(Array.from(f.children).forEach(g=>{g.classList.contains("protyle-attr")||(f.contains(t)?c.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}):c.splice(t.parentElement.childElementCount-1,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML}))}),ct(f,1),Array.from(f.children).forEach(g=>{g.classList.contains("protyle-attr")||r.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!i&&d&&(r.push({action:"delete",id:d.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:(s=d.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:((o=d.parentElement)==null?void 0:o.getAttribute("data-node-id"))||n.block.parentID||n.block.rootID}),f=d.parentElement,d.remove(),!l)){const g=n.wysiwyg.element.querySelector(`[data-node-id="${d.getAttribute("data-node-id")}"]`);g&&g.remove()}if(!i&&f&&f.classList.contains("sb")&&f.childElementCount===2){const g=Ri(n,f);r.push(g.doOperations[0],g.doOperations[1]),c.splice(0,0,g.undoOperations[0],g.undoOperations[1])}else if(!i&&f&&f.classList.contains("protyle-wysiwyg")&&f.childElementCount===0){const g=$(f,"protyle",!0);if(g&&!g.classList.contains("block__edit")){const h=St(g.getAttribute("data-id"));if(h&&h.model instanceof gt&&h.model.editor.protyle.block.id===h.model.editor.protyle.block.rootID){const m=Lute.NewNodeID();r.splice(0,0,{action:"insert",id:m,data:Nn(!1,!1,m).outerHTML,parentID:h.model.editor.protyle.block.parentID}),c.splice(0,0,{action:"delete",id:m})}}}l||i?G(n,r,c):G(n,r),we(e[0])}),xv=(n,e)=>{e.addEventListener("dragstart",i=>{const s=i.target;if(s.tagName==="IMG"){window.siyuan.dragElement=void 0,i.preventDefault();return}if(s.classList){if($(s,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,i.preventDefault();else if(s.classList.contains("protyle-action")){window.siyuan.dragElement=n.wysiwyg.element,i.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}NodeListItem${p.Constants.ZWSP}${s.parentElement.getAttribute("data-subtype")}${p.Constants.ZWSP}${[s.parentElement.getAttribute("data-node-id")]}`,n.wysiwyg.element.innerHTML);return}else if(s.classList.contains("av__cellheader")){window.siyuan.dragElement=s.parentElement,i.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${p.Constants.ZWSP}Col${p.Constants.ZWSP}${[s.parentElement.getAttribute("data-col-id")]}`,s.innerHTML);return}else if(s.classList.contains("av__gutters")){if(!M(s))return;const l=s.parentElement,r=[];l.classList.contains("av__row--select")?l.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(c=>{r.push(c.getAttribute("data-id"))}):r.push(l.getAttribute("data-id")),r.length===1&&i.dataTransfer.setDragImage(l,0,0),window.siyuan.dragElement=l,i.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${p.Constants.ZWSP}Row${p.Constants.ZWSP}${r}`,l.innerHTML);return}}i.dataTransfer.setData(p.Constants.SIYUAN_DROP_EDITOR,p.Constants.SIYUAN_DROP_EDITOR),n.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),e.addEventListener("drop",i=>sr(void 0,null,function*(){var s,o,l,r,c;if(n.disabled||i.dataTransfer.getData(p.Constants.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation();return}let u="";for(const f of i.dataTransfer.items)f.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(u=f.type);const d=(u.startsWith(`application/siyuan-gutternodeattributeview${p.Constants.ZWSP}col`)?$(i.target,"av__cell"):$(i.target,"av__row"))||M(i.target);if(u){const f=[],g=u.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP),h=g[2].split(",");if(i.altKey){ee(Gd(i.clientX,i.clientY));let m="";for(let b=0;b<h.length;b++){const y=yield kt("/api/block/getRefText",{id:h[b]});m+=`((${h[b]} '${y.data}')) `}_t(m,n)}else if(i.shiftKey){ee(Gd(i.clientX,i.clientY));let m="";h.forEach(b=>{m+=`{{select * from blocks where id='${b}'}}
`}),_t(n.lute.SpinBlockDOM(m),n,!0),Ke(n,n.wysiwyg.element)}else if(d&&d.className.indexOf("dragover__")>-1){let m="";if(h.forEach(w=>{m+=`[data-node-id="${w}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(m.substring(0,m.length-1)).forEach(w=>{(w.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(w,"data-type","NodeBlockQueryEmbed"))&&f.push(w)});else{const w=document.createElement("template");w.innerHTML=`<div>${i.dataTransfer.getData(u)}</div>`,w.content.querySelectorAll(m.substring(0,m.length-1)).forEach(E=>{(E.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(E,"data-type","NodeBlockQueryEmbed"))&&f.push(E)})}const b=[];f.forEach(w=>{w.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),w.removeAttribute("select-start"),w.removeAttribute("select-end"),w.querySelectorAll('[data-type="search-mark"]').forEach(E=>{E.outerHTML=E.innerHTML}),b.push(w.getAttribute("data-node-id"))}),ne(["gutter"],n);const y=d.className.split(" ");if(d.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right","protyle-wysiwyg--select"),d.classList.contains("av__cell")){const w=M(d);if(w){const E=w.getAttribute("data-av-id");G(n,[{action:"sortAttrViewCol",avID:E,previousID:(y.includes("dragover__left")?(s=d.previousElementSibling)==null?void 0:s.getAttribute("data-col-id"):d.getAttribute("data-col-id"))||"",id:g[2]}],[{action:"sortAttrViewCol",avID:E,previousID:((o=d.parentElement.querySelector(`[data-col-id="${g[2]}"`).previousElementSibling)==null?void 0:o.getAttribute("data-col-id"))||"",id:g[2]}])}}else if(d.classList.contains("av__row")){const w=M(d);if(w){let E="";y.includes("dragover__bottom")?E=d.getAttribute("data-id")||"":E=((l=d.previousElementSibling)==null?void 0:l.getAttribute("data-id"))||"";const k=w.getAttribute("data-av-id");if(g[0]==="nodeattributeview"&&g[1]==="row"){const L=[],v=[],A=w.querySelector(`[data-id="${h[0]}"]`).previousElementSibling.getAttribute("data-id")||"";h.reverse().forEach(C=>{L.push({action:"sortAttrViewRow",avID:k,previousID:E,id:C}),v.push({action:"sortAttrViewRow",avID:k,previousID:A,id:C})}),G(n,L,v)}else G(n,[{action:"insertAttrViewBlock",avID:k,previousID:E,srcIDs:b}],[{action:"removeAttrViewBlock",srcIDs:b,avID:k}]),Dc(w,b.length,E)}}else d.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&d.parentElement.getAttribute("data-sb-layout")==="col"?y.includes("dragover__left")||y.includes("dragover__right")?nm(n,f,d,y.includes("dragover__right"),i.ctrlKey):tm(n,f,d,y.includes("dragover__bottom"),"row",i.ctrlKey):y.includes("dragover__left")||y.includes("dragover__right")?tm(n,f,d,y.includes("dragover__right"),"col",i.ctrlKey):nm(n,f,d,y.includes("dragover__bottom"),i.ctrlKey),f.forEach(w=>{w.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(w.removeAttribute("data-render"),Ke(n,w))}),d.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(d.removeAttribute("data-render"),Ke(n,d))}}else if(((r=i.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE))==null?void 0:r.split("-").length)>1&&d&&!n.options.backlinkData&&d.className.indexOf("dragover__")>-1){const f=n.contentElement.scrollTop,g=i.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE).split(",");if(d.classList.contains("av__row")){const h=M(d);if(h){let m="";d.classList.contains("dragover__bottom")?m=d.getAttribute("data-id")||"":m=((c=d.previousElementSibling)==null?void 0:c.getAttribute("data-id"))||"";const b=h.getAttribute("data-av-id");G(n,[{action:"insertAttrViewBlock",avID:b,previousID:m,srcIDs:g}],[{action:"removeAttrViewBlock",srcIDs:g,avID:b}]),Dc(h,g.length,m)}}else{for(let h=0;h<g.length;h++)g[h]&&(yield kt("/api/filetree/doc2Heading",{srcID:g[h],after:d.classList.contains("dragover__bottom"),targetID:d.getAttribute("data-node-id")}));_("/api/filetree/getDoc",{id:n.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},h=>{dt({data:h,protyle:n}),ba({protyle:n,focus:!1,pushBackStack:!1,reload:!0,resize:!1}),setTimeout(()=>{n.contentElement.scrollTop=f,n.scroll.lastScrollTop=f-1},p.Constants.TIMEOUT_LOAD)})}d.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right","protyle-wysiwyg--select")}else if(!window.siyuan.dragElement&&(i.dataTransfer.types[0]==="Files"||i.dataTransfer.types.includes("text/html")))if(ee(Gd(i.clientX,i.clientY)),i.dataTransfer.types[0]==="Files"&&!(0,T.jU)()){const f=[];for(let g=0;g<i.dataTransfer.files.length;g++)f.push(i.dataTransfer.files[g].path);Hf(f,n,!i.altKey)}else Of(n,i);window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let t,a;e.addEventListener("dragover",i=>{var s,o;if(i.dataTransfer.types.includes("Files")&&i.target.classList.contains("protyle-wysiwyg")){i.preventDefault();return}let l="";for(const u of i.dataTransfer.items)u.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(l=u.type);if(!l&&!window.siyuan.dragElement){i.preventDefault();return}if(i.shiftKey||i.altKey){const u=M(i.target);u&&u.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),i.preventDefault();return}i.preventDefault();let r=$(i.target,"av__row")||M(i.target);if(l&&l.startsWith(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${p.Constants.ZWSP}Col${p.Constants.ZWSP}`.toLowerCase())?(r=$(i.target,"av__cell"),r&&!r.parentElement.isSameNode(window.siyuan.dragElement.parentElement)&&(r=!1)):r&&l&&l.startsWith(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${p.Constants.ZWSP}Row${p.Constants.ZWSP}`.toLowerCase())&&(!r.classList.contains("av__row")||!r.parentElement.isSameNode(window.siyuan.dragElement.parentElement))&&(r=!1),!r||r!=null&&r.classList.contains("av"))return;const c=i.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(r&&t&&r.isSameNode(t)){const u=r.getBoundingClientRect();if(r.classList.remove("protyle-wysiwyg--select","dragover__top","dragover__bottom","dragover__left","dragover__right"),r.getAttribute("data-type")==="NodeAttributeView"&&qe(i.target,"TD")){r.classList.add("protyle-wysiwyg--select");return}if(r.getAttribute("data-type")==="NodeListItem"||c.indexOf("-")>-1){i.clientY>u.top+u.height/2?r.classList.add("dragover__bottom","protyle-wysiwyg--select"):r.classList.contains("av__row--header")||r.classList.add("dragover__top","protyle-wysiwyg--select");return}if(r.classList.contains("av__cell")){i.clientX<u.left+u.width/2&&i.clientX>u.left&&!r.classList.contains("av__row")?r.classList.add("dragover__left","protyle-wysiwyg--select"):i.clientX>u.right-u.width/2&&i.clientX<u.right&&!r.classList.contains("av__row")&&r.classList.add("dragover__right","protyle-wysiwyg--select");return}i.clientX<u.left+32&&i.clientX>u.left&&!r.classList.contains("av__row")?r.classList.add("dragover__left","protyle-wysiwyg--select"):i.clientX>u.right-32&&i.clientX<u.right&&!r.classList.contains("av__row")?r.classList.add("dragover__right","protyle-wysiwyg--select"):i.clientY>u.top+u.height/2&&a!=="bottom"?r.classList.add("dragover__bottom","protyle-wysiwyg--select"):a!=="top"&&r.classList.add("dragover__top","protyle-wysiwyg--select");return}if(c.indexOf("-")>-1){c.split(",").includes(n.block.rootID)&&!r.classList.contains("av__row")?t=void 0:t=r;return}if(l){a="";const u=l.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP);if(u[0]==="nodeattributeview"&&u[1]==="col"&&r.getAttribute("data-id")===u[2]||u[2].split(",").find(f=>{if(f&&S(r,"data-node-id",f))return!0})||S(r.parentElement,"data-type","NodeBlockQueryEmbed")||u[0]==="nodelistitem"&&u[1]!==r.getAttribute("data-subtype")&&r.getAttribute("data-type")==="NodeListItem"||u[0]!=="nodelistitem"&&r.getAttribute("data-type")==="NodeListItem")return;u[0]==="nodelistitem"&&r.parentElement.classList.contains("li")&&((s=r.previousElementSibling)!=null&&s.classList.contains("protyle-action"))&&(a="top"),u[0]==="nodelistitem"&&((o=r.nextElementSibling)!=null&&o.classList.contains("list"))&&(a="bottom"),r&&r.classList.contains("av__row--header")&&(a="top"),t=r}}),e.addEventListener("dragleave",i=>{let s=$(i.target,"av__row")||M(i.target);if(s&&!s.classList.contains("av")){let o="";for(const l of i.dataTransfer.items)l.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(o=l.type);s.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right"),s.classList.contains("av__row")?(s.classList.remove("protyle-wysiwyg--select"),s.classList.contains("av__row--header")&&(s=$(i.target,"av__cell"),s&&s.classList.remove("protyle-wysiwyg--select","dragover__left","dragover__right"))):o.indexOf(s.getAttribute("data-node-id"))===-1&&(s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"))}})},am=(n,e,t,a)=>{a&&console.log(`${n} - ${t}: ${e}`)},Av=(n,e,t,a,i)=>{if(e!=="NodeCodeBlock"&&t.parentElement.getAttribute("data-subtype")!=="t"&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const s=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,o=a.innerHTML.substring(1,2).toLowerCase()==="x";if(t.parentElement.classList.contains("li")&&t.parentElement.childElementCount===3){if(!t.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&t.parentElement.parentElement.childElementCount===2){const l=t.parentElement.parentElement,r=l.outerHTML;return l.setAttribute("data-subtype","t"),l.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),t.parentElement.setAttribute("data-subtype","t"),o&&t.parentElement.classList.add("protyle-task--done"),t.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(s),ie(n,l.getAttribute("data-node-id"),l.outerHTML,r),_e(n.wysiwyg.element,i),!0}return!1}else{const l=t.getAttribute("data-node-id"),r=Lute.NewNodeID(),c=Lute.NewNodeID(),u=Lute.NewNodeID(),d=t.outerHTML;return a.innerHTML=a.innerHTML.substring(s),G(n,[{action:"update",id:l,data:t.outerHTML},{action:"insert",id:r,data:`<div data-subtype="t" data-node-id="${r}" updated="${r.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div><div data-node-id="${c}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:l},{action:"move",id:l,previousID:c},{action:"delete",id:c}],[{action:"update",id:l,data:d},{action:"move",id:l,previousID:r},{action:"delete",id:r}]),t.outerHTML=`<div data-subtype="t" data-node-id="${r}" data-type="NodeList" class="list" updated="${r.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>${t.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,_e(n.wysiwyg.element,i),!0}}return!1},Tv=(n,e,t,a,i)=>{if(e==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&t.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=t.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),c=t.outerHTML,u=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),G(n,[{action:"update",id:s,data:t.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${u}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:l},{action:"delete",id:l}],[{action:"update",id:s,data:c},{action:"move",id:s,previousID:o},{action:"delete",id:o}]),t.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${u}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${t.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,_e(n.wysiwyg.element,i),!0}return!1};var Iv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const jd=(n,e,t,a=!0)=>Iv(void 0,null,function*(){var i,s,o,l;if(!e.parentElement)return;if(e.classList.contains("av")){ml(n,e);return}const r=J(e),c=e.getAttribute("data-type");if(!r){c==="NodeThematicBreak"?e.innerHTML="<div><wbr></div>":c==="NodeBlockQueryEmbed"?e.lastElementChild.previousElementSibling.innerHTML="<wbr>"+p.Constants.ZWSP:c==="NodeMathBlock"||c==="NodeHTMLBlock"?e.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+p.Constants.ZWSP:c==="NodeIFrame"||c==="NodeWidget"?e.innerHTML="<wbr>"+e.firstElementChild.outerHTML+e.lastElementChild.outerHTML:c==="NodeVideo"?e.firstElementChild.innerHTML="<wbr>"+p.Constants.ZWSP+e.firstElementChild.firstElementChild.outerHTML+e.firstElementChild.lastElementChild.outerHTML:c==="NodeAudio"?e.firstElementChild.innerHTML=e.firstElementChild.firstElementChild.outerHTML+"<wbr>"+p.Constants.ZWSP:c==="NodeCodeBlock"&&(t.startContainer.textContent=p.Constants.ZWSP),_e(e,t);return}const u=document.createElement("wbr");t.insertNode(u);const d=e.getAttribute("data-node-id");if(c!=="NodeCodeBlock"&&(r.innerHTML.endsWith(`
<wbr>`)||r.innerHTML.endsWith(`
<wbr>
`))){ie(n,d,e.outerHTML,e.outerHTML.replace(`
<wbr>`,"<wbr>")),u.remove();return}if(Av(n,c,e,r,t)||Tv(n,c,e,r,t))return;const f=e.querySelector("br");f&&f.parentElement.tagName!=="TD"&&f.parentElement.tagName!=="TH"&&(f.parentElement.textContent.trim()===""||((s=(i=f.previousSibling)==null?void 0:i.previousSibling)==null?void 0:s.textContent)===`
`)&&f.remove(),e.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),(r.innerHTML==="\u300B<wbr>"||r.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(r.innerHTML=r.innerHTML.replace("\u300B<wbr>","><wbr>"));const g=r.innerHTML.trimStart();if(!((g.startsWith("````")||g.startsWith("\xB7\xB7\xB7\xB7")||g.startsWith("~~~~"))&&g.indexOf(`
`)===-1)){if((g.startsWith("```")||g.startsWith("\xB7\xB7\xB7")||g.startsWith("~~~"))&&g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){ie(n,d,e.outerHTML,n.wysiwyg.lastHTMLs[d]),u.remove();return}}(g==="\xA5\xA5<wbr>"||g==="\uFFE5\uFFE5<wbr>")&&(r.innerHTML="$$<wbr>");const h=S(t.startContainer,"data-type","block-ref");h&&h.getAttribute("data-subtype")==="d"&&(yield kt("/api/block/getRefText",{id:h.getAttribute("data-id")})).data!==h.innerHTML.replace("<wbr>","")&&h.setAttribute("data-subtype","s");let m=e.outerHTML,b=!1;if(r.textContent==="---"&&c!=="NodeCodeBlock"){m=`<div data-node-id="${d}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const w=Xe(r);w?Me(w)?b=!0:we(w):m+=pl(!1,!0)}else{if(c!=="NodeCodeBlock"&&(g.startsWith("```")||g.startsWith("~~~")||g.startsWith("\xB7\xB7\xB7")||g.indexOf("\n```")>-1||g.indexOf(`
~~~`)>-1||g.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(g.indexOf(`
`)===-1&&g.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let w=r.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();w.endsWith("\n```")||(w=w.replace("<wbr>","")+"<wbr>\n```"),r.innerHTML=w,m=e.outerHTML}m=n.lute.SpinBlockDOM(m)}ne(["util"],n,!0);const y=document.createElement("template");if(y.innerHTML=m,a&&(((o=J(y.content.firstElementChild))==null?void 0:o.innerHTML)!==J(e).innerHTML||y.content.childElementCount===1&&((l=J(y.content.firstElementChild))==null?void 0:l.innerHTML)==="<wbr>")&&!(y.content.childElementCount===1&&y.content.firstElementChild.classList.contains("code-block")&&c==="NodeCodeBlock")){am("SpinBlockDOM",e.outerHTML,"argument",n.options.debugger),am("SpinBlockDOM",m,"result",n.options.debugger);let w;e.classList.contains("table")&&(w=J(e).scrollLeft),/<span data-type="backslash"><span>\\<\/span>.<\/span><wbr>/.test(m)?e.outerHTML=m:e.outerHTML=m.replace("</span><wbr>","</span>"+p.Constants.ZWSP+"<wbr>"),n.wysiwyg.element.querySelectorAll(`[data-node-id="${d}"]`).forEach(E=>{(E.getAttribute("data-type")==="NodeBlockQueryEmbed"||!S(E,"data-type","NodeBlockQueryEmbed"))&&(e=E)}),m.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(e.querySelectorAll('[data-type="inline-math"]')).find(E=>{if(E.dataset.content.indexOf("<wbr>")>-1)return E.setAttribute("data-content",E.dataset.content.replace("<wbr>","")),n.toolbar.showRender(n,E),!0}),Array.from(y.content.children).forEach((E,k)=>{const L=E.getAttribute("data-node-id");let v;L===d?v=e:v=n.wysiwyg.element.querySelector(`[data-node-id="${L}"]`);const A=v.getAttribute("data-type");if(A==="NodeCodeBlock"){const C=v.querySelector(".protyle-action__language");C?(window.siyuan.storage[p.Constants.LOCAL_CODELANG]&&C.textContent===""&&(C.textContent=window.siyuan.storage[p.Constants.LOCAL_CODELANG]),Ze(v)):y.content.childElementCount===1&&n.toolbar.showRender(n,v)}else["NodeMathBlock","NodeHTMLBlock"].includes(A)?(A==="NodeMathBlock"&&ra(v),n.toolbar.showRender(n,v)):A==="NodeBlockQueryEmbed"?(Ke(n,v),n.toolbar.showRender(n,v),ne(["hint"],n)):A==="NodeThematicBreak"&&b?we(e):(v.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(C=>{C.textContent===""&&_("/api/block/getRefText",{id:C.getAttribute("data-id")},D=>{C.innerHTML=D.data})}),ra(v),k===y.content.childElementCount-1&&(_e(n.wysiwyg.element,t),n.hint.render(n),w>0&&(J(v).scrollLeft=w)))})}else e.getAttribute("data-type")==="NodeCodeBlock"?(r.removeAttribute("data-render"),Ze(e)):(_e(n.wysiwyg.element,t),n.hint.render(n));ne(["gutter"],n),Dv(m,n,d)}),Dv=(n,e,t)=>{const a=document.createElement("template");a.innerHTML=n;const i=[],s=[];Array.from(a.content.children).forEach((o,l)=>{var r;o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const c=o.getAttribute("data-node-id");if(c===t)i.push({id:t,data:o.outerHTML,action:"update"}),s.push({id:t,data:e.wysiwyg.lastHTMLs[t],action:"update"});else{let u;l===0&&(u=e.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),i.push({action:"insert",data:o.outerHTML,id:c,previousID:l===0?(r=u==null?void 0:u.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:(u==null?void 0:u.parentElement.getAttribute("data-node-id"))||e.block.parentID}),s.push({id:c,action:"delete"})}}),G(e,i,s)},$v=(n,e,t)=>{var a;if(!e.parentElement.previousElementSibling&&e.parentElement.nextElementSibling&&e.parentElement.nextElementSibling.classList.contains("protyle-attr")){fl(n,[e.parentElement],t);return}if(!e.parentElement.previousElementSibling&&e.parentElement.parentElement.parentElement.classList.contains("list")){t.insertNode(document.createElement("wbr"));const d=e.parentElement.parentElement,f=d.outerHTML,g=e.parentElement.parentElement.previousElementSibling.lastElementChild,h=g.parentElement.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove(),g.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),d.getAttribute("data-subtype")==="o"&&ct(d),G(n,[{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML},{action:"update",data:g.parentElement.outerHTML,id:g.parentElement.getAttribute("data-node-id")}],[{action:"update",data:h,id:g.parentElement.getAttribute("data-node-id")},{action:"update",data:f,id:d.getAttribute("data-node-id")}]),_e(g.parentElement,t);return}if(!e.parentElement.previousElementSibling){if(e.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;t.insertNode(document.createElement("wbr"));const d=e.parentElement.parentElement,f=d.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove();const g=document.createElement("div");g.innerHTML=e.parentElement.innerHTML;const h=[],m=[];Array.from(g.children).forEach((b,y)=>{var w;h.push({action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:y===0?(w=d.previousElementSibling)==null?void 0:w.getAttribute("data-node-id"):h[y-1].id,parentID:d.parentElement.getAttribute("data-node-id")||n.block.parentID}),m.push({action:"delete",id:b.getAttribute("data-node-id")})}),d.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),d.getAttribute("data-subtype")==="o"&&ct(d,parseInt(d.firstElementChild.getAttribute("data-marker"))-1),h.splice(0,0,{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML}),m.push({action:"update",data:f,id:d.getAttribute("data-node-id")}),G(n,h,m),_e(n.wysiwyg.element,t);return}const i=e.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const s=i.getAttribute("data-node-id"),o=i.parentElement;t.insertNode(document.createElement("wbr"));const l=o.outerHTML,r=[],c=[{action:"insert",id:s,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],u=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(J(e).textContent.trim()===""&&e.nextElementSibling.classList.contains("protyle-attr"))r.push({action:"delete",id:s}),c[0].data=i.outerHTML,Xt(J(i.previousElementSibling),t),t.collapse(!0),i.remove();else{Xt(J(i.previousElementSibling),t),t.collapse(!0),ee(t),(a=e.querySelector("wbr"))==null||a.remove();return}else{let d=u.previousElementSibling.getAttribute("data-node-id");Array.from(e.parentElement.children).forEach((f,g)=>{if(f.classList.contains("protyle-action")||f.classList.contains("protyle-attr"))return;const h=f.getAttribute("data-node-id");r.push({action:"move",id:h,previousID:d}),c.push({action:"move",id:h,previousID:g===1?void 0:d,parentID:s}),d=h,u.before(f)}),r.push({action:"delete",id:s}),c[0].data=i.outerHTML,i.remove()}o.classList.contains("protyle-wysiwyg")?G(n,r,c):(o.getAttribute("data-subtype")==="o"&&ct(o),ie(n,o.getAttribute("data-node-id"),o.outerHTML,l)),_e(u.parentElement,t)},gn=(n,e,t)=>{var a,i,s,o,l,r,c;cn(n);const u=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((u==null?void 0:u.length)>0){const L=[],v=[];let A=u[0].previousElementSibling||u[u.length-1].nextElementSibling,C,D;if(ne(["select"],n),u.find(x=>{const P=Oe(x);D=P.parentElement;const B=P.getAttribute("data-node-id");if(L.push({action:"delete",id:B}),A=Xe(P)||se(P)||P.parentElement||n.wysiwyg.element.firstElementChild,P.getAttribute("data-type")==="NodeHeading"&&P.getAttribute("fold")==="1"){Vt(n,P,void 0,!0),v.push({action:"insert",data:P.outerHTML,id:B,previousID:u[0].previousElementSibling?u[0].previousElementSibling.getAttribute("data-node-id"):"",parentID:P.parentElement.getAttribute("data-node-id")||n.block.parentID}),P.firstElementChild.removeAttribute("contenteditable");const V=P.nextElementSibling;if(V){const X=V.getAttribute("data-type");if(X!=="NodeHeading"||X==="NodeHeading"&&V.getAttribute("data-subtype")>P.getAttribute("data-subtype"))return!0}}else{let V=P.outerHTML;(P.classList.contains("render-node")||P.querySelector("div.render-node"))&&(V=n.lute.SpinBlockDOM(P.outerHTML)),v.push({action:"insert",data:V,id:B,previousID:P.previousElementSibling?P.previousElementSibling.getAttribute("data-node-id"):"",parentID:P.parentElement.getAttribute("data-node-id")||n.block.parentID}),P.getAttribute("data-subtype")==="o"&&P.classList.contains("li")?C=P.parentElement:C=void 0,P.remove()}}),A)if(n.block.showAll&&A.classList.contains("protyle-wysiwyg")&&n.wysiwyg.element.childElementCount===0)setTimeout(()=>{Yt({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},p.Constants.TIMEOUT_INPUT*2+100);else{if(A.classList.contains("protyle-wysiwyg")&&n.wysiwyg.element.childElementCount===0){const x=Lute.NewNodeID(),P=Nn(!1,!0,x);A.insertAdjacentElement("afterbegin",P),L.push({action:"insert",data:P.outerHTML,id:x,parentID:A.getAttribute("data-node-id")||n.block.parentID}),v.push({action:"delete",id:x}),A=void 0,_e(P,t)}we(A),Ge(n,A),C&&(v.push({action:"update",id:C.getAttribute("data-node-id"),data:C.outerHTML}),ct(C,1),L.push({action:"update",id:C.getAttribute("data-node-id"),data:C.outerHTML}))}if(L.length>0)if(D&&D.getAttribute("data-type")==="NodeSuperBlock"&&D.childElementCount===2){const x=Ri(n,D);G(n,L.concat(x.doOperations),x.undoOperations.concat(v.reverse()))}else G(n,L,v.reverse());ne(["util"],n);return}if(e.getAttribute("data-type")==="NodeCodeBlock"&&J(e).textContent.trim()===""){e.classList.add("protyle-wysiwyg--select"),gn(n,e,t);return}if(e.getAttribute("data-type")==="NodeCodeBlock"||e.getAttribute("data-type")==="NodeTable"){e.previousElementSibling&&we(e.previousElementSibling,void 0,!1);return}if(e.getAttribute("data-type")==="NodeHeading"){ua({protyle:n,selectsElement:[e],type:"Blocks2Ps"});return}if(!e.previousElementSibling&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){t.insertNode(document.createElement("wbr"));const L=e.parentElement;L.insertAdjacentElement("beforebegin",e),L.childElementCount===1?(G(n,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(a=e.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||n.block.parentID},{action:"delete",id:L.getAttribute("data-node-id")}],[{action:"insert",id:L.getAttribute("data-node-id"),data:L.outerHTML,previousID:(i=e.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||n.block.parentID},{action:"move",id:e.getAttribute("data-node-id"),parentID:L.getAttribute("data-node-id")}]),L.remove()):G(n,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(s=e.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:L.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"move",id:e.getAttribute("data-node-id"),parentID:L.getAttribute("data-node-id")}]),_e(e,t);return}if(e.parentElement.classList.contains("li")&&e.previousElementSibling.classList.contains("protyle-action")){$v(n,e,t);return}if(e.previousElementSibling&&e.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const d=se(e);if(!d){if(n.wysiwyg.element.childElementCount>1&&J(e).textContent===""){we(n.wysiwyg.element.firstElementChild.nextElementSibling);const L=Oe(e);G(n,[{action:"delete",id:L.getAttribute("data-node-id")}],[{action:"insert",data:L.outerHTML,id:L.getAttribute("data-node-id"),parentID:n.block.parentID}]),L.remove()}return}const f=e.parentElement,g=J(e),h=Ee(d);if(t.toString()===""&&(0,T.tq)()&&h&&h.classList.contains("hr")&&Et(g).start===0){G(n,[{action:"delete",id:h.getAttribute("data-node-id")}],[{action:"insert",data:h.outerHTML,id:h.getAttribute("data-node-id"),previousID:(o=h.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:h.parentElement.getAttribute("data-node-id")}]),h.remove();return}const m=h&&(h.classList.contains("table")||h.classList.contains("render-node")||h.classList.contains("iframe")||h.classList.contains("hr")||h.classList.contains("code-block")),b=h.getAttribute("data-node-id");if(m){if(h.classList.contains("code-block")){if(g.textContent.trim()===""){const L=e.getAttribute("data-node-id"),v=[{action:"delete",id:L}],A=[{action:"insert",data:e.outerHTML,id:L,previousID:(l=e.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:e.parentElement.getAttribute("data-node-id")}];if(e.remove(),f.getAttribute("data-type")==="NodeSuperBlock"&&f.childElementCount===2){const C=Ri(n,f);G(n,v.concat(C.doOperations),C.undoOperations.concat(A))}else G(n,v,A);we(n.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),void 0,!1)}else we(h,void 0,!1);return}if(g.textContent!==""){we(h,void 0,!1);return}}const y=st(e),w=y.getAttribute("data-node-id");t.insertNode(document.createElement("wbr"));const E=[{action:"update",data:h.outerHTML,id:b},{action:"insert",data:y.outerHTML,id:w,previousID:(r=e.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")}],k=[{action:"delete",id:w}];if(m)y.remove(),we(h,void 0,!1);else{const L=J(h);if(g&&g.textContent!==""&&(t.setEndAfter(g.lastChild),(((c=L==null?void 0:L.lastElementChild)==null?void 0:c.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const C=rt(L==null?void 0:L.lastElementChild);C&&C.textContent===`
`&&C.remove()}const v=n.contentElement.scrollTop,A=t.extractContents();t.selectNodeContents(L),t.collapse(!1),t.insertNode(A),y.remove(),n.contentElement.scrollTop=v,n.scroll.lastScrollTop=v-1,k.push({action:"update",data:h.outerHTML,id:b})}if(f.getAttribute("data-type")==="NodeSuperBlock"&&f.childElementCount===2){const L=Ri(n,f);G(n,k.concat(L.doOperations),L.undoOperations.concat(E))}else G(n,k,E);_e(n.wysiwyg.element,t)},Pv=(n,e,t)=>{var a,i;const s=e.parentElement,o=J(e);if(["",`
`].includes(o.textContent)&&e.previousElementSibling.classList.contains("protyle-action")&&!e.querySelector("img")){if((a=s.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return fl(n,[e.parentElement],t),!0;if(!s.parentElement.classList.contains("protyle-wysiwyg"))return Jb(n,e,t),!0}const l=Et(o,n.wysiwyg.element,t);if(t.toString()===""&&l.start===0&&!ot(t.startContainer)){if(s.parentElement.classList.contains("protyle-wysiwyg"))return!0;const g=document.createElement("wbr");t.insertNode(g);const h=s.parentElement.outerHTML;g.remove();let m=ei(s,-1,!0);if(e.previousElementSibling.classList.contains("protyle-action"))J(e).textContent===""?s.insertAdjacentElement("afterend",m):s.insertAdjacentElement("beforebegin",m);else{if(J(e).textContent!=="")return!1;e.remove(),m=ei(s,-1,!0),s.insertAdjacentElement("afterend",m)}return s.getAttribute("data-subtype")==="o"&&ct(s.parentElement),ie(n,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,h),_e(m,t),Ge(n),ds(m),!0}const r=s.querySelector(".list");let c;if(r&&s.getAttribute("fold")!=="1"&&e.nextElementSibling.isSameNode(r)){if(l.end>=o.textContent.length-(o.textContent.endsWith(p.Constants.ZWSP)?1:0)){t.insertNode(document.createElement("wbr"));const g=r.outerHTML;e.querySelector("wbr").remove(),c=ei(r.firstElementChild,-1,!0),r.firstElementChild.before(c),r.getAttribute("data-subtype")==="o"&&ct(r),ie(n,r.getAttribute("data-node-id"),r.outerHTML,g),_e(s,t),Ge(n)}else{t.insertNode(document.createElement("wbr"));const g=s.outerHTML,h=s.parentElement.outerHTML;t.toString()!==""&&(t.extractContents(),t.insertNode(document.createElement("wbr"))),t.setEndAfter(o.lastChild),c=ei(s,0,!1);const m=J(c);m.appendChild(t.extractContents()),m.parentElement.after(r),s.insertAdjacentElement("afterend",c),s.getAttribute("data-subtype")==="o"&&ct(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?G(n,[{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",data:g,id:s.getAttribute("data-node-id")}]):ie(n,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,h),_e(c,t),Ge(n)}return ds(c),!0}(t.toString()===""||t.toString()===p.Constants.ZWSP)&&t.startContainer.nodeType===3&&t.startContainer.textContent===p.Constants.ZWSP&&t.startOffset===0&&(t.setStart(t.startContainer,1),t.collapse(!1)),t.insertNode(document.createElement("wbr"));const u=s.outerHTML,d=s.parentElement.outerHTML;t.toString()!==""&&(t.extractContents(),t.insertNode(document.createElement("wbr"))),t.setEndAfter(o.lastChild),c=ei(s,0,!1);const f=t.extractContents();return f.firstChild.nodeType!==3&&f.firstChild.textContent===""&&(f.firstChild.after(document.createElement("wbr")),f.firstChild.remove()),(((i=o==null?void 0:o.lastElementChild)==null?void 0:i.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!rt(o==null?void 0:o.lastElementChild)&&o.insertAdjacentText("beforeend",`
`),J(c).appendChild(f),s.insertAdjacentElement("afterend",c),s.getAttribute("data-subtype")==="o"&&ct(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?G(n,[{action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",id:s.getAttribute("data-node-id"),data:u}]):ie(n,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,d),_e(c,t),Ge(n),ds(c),!0},Mv=(n,e,t)=>{var a,i;const s=Me(n);if(!s&&n.classList.contains("protyle-wysiwyg--select")){Xt(J(n),e,!1),e.collapse(!1),ne(["select"],t);return}if(s){if(n.parentElement.classList.contains("li")){const h=n.parentElement.parentElement.outerHTML,m=ei(n.parentElement,0,!0);n.parentElement.insertAdjacentElement("afterend",m),ie(t,n.parentElement.parentElement.getAttribute("data-node-id"),n.parentElement.parentElement.outerHTML,h),_e(m,e),ds(m),Ge(t);return}if(n.classList.contains("hr")){rn(t,"afterend");return}n.classList.contains("protyle-wysiwyg--select")&&n.classList.contains("render-node")?t.toolbar.showRender(t,n):rn(t,"afterend");return}const o=J(n);o.querySelectorAll(".img--select").forEach(h=>{h.classList.remove("img--select")});const l=o.innerHTML.trimStart();if((l.startsWith("```")||l.startsWith("\xB7\xB7\xB7")||l.startsWith("~~~")||l.indexOf("\n```")>-1||l.indexOf(`
~~~`)>-1||l.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(l.indexOf(`
`)===-1&&l.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(n.classList.contains("p")){const h=n.outerHTML;let m=o.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");m.endsWith("\n```")||(m+="<wbr>\n```"),o.innerHTML=m,n.outerHTML=t.lute.SpinBlockDOM(n.outerHTML),n=t.wysiwyg.element.querySelector(`[data-node-id="${n.getAttribute("data-node-id")}"]`);const b=n.querySelector(".protyle-action__language");return b?(window.siyuan.storage[p.Constants.LOCAL_CODELANG]&&b.textContent===""?b.textContent=window.siyuan.storage[p.Constants.LOCAL_CODELANG]:(window.siyuan.storage[p.Constants.LOCAL_CODELANG]=b.textContent,Ue(p.Constants.LOCAL_CODELANG,window.siyuan.storage[p.Constants.LOCAL_CODELANG])),Ze(n)):t.toolbar.showRender(t,n),ie(t,n.getAttribute("data-node-id"),n.outerHTML,h),!0}}if(n.getAttribute("data-type")==="NodeCodeBlock"){const h=document.createElement("wbr");e.insertNode(h);const m=n.outerHTML;return h.remove(),e.extractContents(),o.textContent.endsWith(`
`)||o.insertAdjacentText("beforeend",`
`),e.insertNode(document.createTextNode(`
`)),e.collapse(!1),e.insertNode(h),o.removeAttribute("data-render"),Ze(n),ie(t,n.getAttribute("data-node-id"),n.outerHTML,m),!0}if(o.textContent.replace(p.Constants.ZWSP,"").replace(`
`,"")===""&&n.nextElementSibling&&n.nextElementSibling.classList.contains("protyle-attr")&&n.parentElement.getAttribute("data-type")==="NodeBlockquote"){e.insertNode(document.createElement("wbr"));const h=st(n),m=n.getAttribute("data-node-id"),b=h.getAttribute("data-node-id"),y={action:"insert",id:m,data:n.outerHTML},w={action:"insert",id:b,data:h.outerHTML};return b===m?(y.previousID=n.parentElement.getAttribute("data-node-id"),w.previousID=n.previousElementSibling.getAttribute("data-node-id"),n.parentElement.after(n)):(y.previousID=h.previousElementSibling?h.previousElementSibling.getAttribute("data-node-id"):void 0,y.parentID=h.parentElement.getAttribute("data-node-id")||t.block.parentID,w.previousID=y.previousID,w.parentID=y.parentID,h.after(n),h.remove()),G(t,[{action:"delete",id:b},y],[{action:"delete",id:m},w]),_e(n,e),!0}const r=Et(o,t.wysiwyg.element,e);if(n.parentElement.getAttribute("data-type")==="NodeListItem"&&(n.nextElementSibling.classList.contains("protyle-attr")||n.nextElementSibling.classList.contains("list")&&((a=n.previousElementSibling)!=null&&a.classList.contains("protyle-action"))||r.start===0&&n.previousElementSibling.classList.contains("protyle-action")||n.parentElement.getAttribute("fold")==="1")&&Pv(t,n,e))return!0;if(o.textContent!==""&&e.toString()===""&&r.start===0){const h=Nn(!1,!0),m=h.getAttribute("data-node-id");return G(t,[{action:"insert",data:h.outerHTML,id:m,previousID:n.previousElementSibling?n.previousElementSibling.getAttribute("data-node-id"):"",parentID:n.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"delete",id:m}]),h.querySelector("wbr").remove(),n.insertAdjacentElement("beforebegin",h),ds(h),!0}e.toString()===""&&e.startContainer.nodeType===3&&e.startContainer.textContent===p.Constants.ZWSP&&e.startOffset===0&&e.setStart(e.startContainer,1),e.insertNode(document.createElement("wbr"));const c=n.outerHTML;e.toString()!==""&&(e.extractContents(),e.insertNode(document.createElement("wbr"))),o.lastChild&&e.setEndAfter(o.lastChild);const u=Nn(!1,!1),d=e.extractContents();d.firstChild&&d.firstChild.nodeType!==3&&d.firstChild.textContent===""&&(d.firstChild.after(document.createElement("wbr")),d.firstChild.remove()),(((i=o==null?void 0:o.lastElementChild)==null?void 0:i.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!rt(o==null?void 0:o.lastElementChild)&&o.insertAdjacentText("beforeend",`
`),J(u).appendChild(d);const f=n.getAttribute("data-node-id"),g=u.getAttribute("data-node-id");return n.insertAdjacentElement("afterend",u),G(t,[{action:"update",data:n.outerHTML,id:f},{action:"insert",data:u.outerHTML,id:g,previousID:f}],[{action:"delete",id:g},{action:"update",data:c,id:f}]),n.insertAdjacentElement("afterend",u),_e(u,e),Ge(t),ds(u),!0},ds=n=>{const e=J(n).childNodes;for(let t=0;t<e.length;t++)e[t].nodeType===3&&e[t].textContent.length===0&&(e[t].remove(),t--)},Nv=(n,e,t)=>{if(!e.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(n.isComposing)return!0;if(U("\u2318B",n)||U("\u2318I",n)||U("\u2318U",n))return n.preventDefault(),!0;const a=e.querySelector(".av__cell--select");if(a){if(n.key==="Escape")return a.classList.remove("av__cell--select"),Vn(a.parentElement.querySelector(".av__firstcol"),"select"),n.preventDefault(),!0;if(n.key==="Enter")return Pa(t,[a]),n.preventDefault(),!0;let s;if(n.key==="ArrowLeft"){const o=a.parentElement.previousElementSibling;return a.previousElementSibling&&a.previousElementSibling.classList.contains("av__cell")?s=a.previousElementSibling:o&&!o.classList.contains("av__row--header")&&(s=o.lastElementChild.previousElementSibling),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),ni(e,s.getBoundingClientRect())),n.preventDefault(),!0}if(n.key==="ArrowRight"){const o=a.parentElement.nextElementSibling;return a.nextElementSibling&&a.nextElementSibling.classList.contains("av__cell")?s=a.nextElementSibling:o&&!o.classList.contains("av__row--footer")&&(s=o.querySelector(".av__cell")),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),ni(e,s.getBoundingClientRect())),n.preventDefault(),!0}if(n.key==="ArrowUp"){const o=a.parentElement.previousElementSibling;return o&&!o.classList.contains("av__row--header")&&(s=o.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),ni(e,s.getBoundingClientRect())),n.preventDefault(),!0}if(n.key==="ArrowDown"){const o=a.parentElement.nextElementSibling;return o&&!o.classList.contains("av__row--footer")&&(s=o.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),ni(e,s.getBoundingClientRect())),n.preventDefault(),!0}}const i=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(i.length>0){if(U("\u2318/",n))return n.stopPropagation(),n.preventDefault(),Nc(t,i[0],{x:e.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:i[0].getBoundingClientRect().bottom}),!0;if(n.key==="Escape")return n.preventDefault(),Vn(i[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(n.key==="Enter")return Vn(i[0].querySelector(".av__firstcol"),"unselectAll"),Pa(t,[i[0].querySelector(".av__cell")]),n.preventDefault(),!0;if(n.key==="ArrowUp"){const s=i[0].previousElementSibling;return Vn(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--header")?(Vn(s.querySelector(".av__firstcol"),"select"),ni(e,s.getBoundingClientRect(),!0)):e.classList.add("protyle-wysiwyg--select"),n.preventDefault(),!0}if(n.key==="ArrowDown"){const s=i[i.length-1].nextElementSibling;return Vn(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--add")?(Vn(s.querySelector(".av__firstcol"),"select"),ni(e,s.getBoundingClientRect(),!0)):e.classList.add("protyle-wysiwyg--select"),n.preventDefault(),!0}}return!1},Kd=(n,e)=>{let t="";Array.from(n.cloneContents().childNodes).forEach(a=>{a.nodeType===3?t+=a.textContent:t+=a.outerHTML}),_("/api/block/getDOMText",{dom:t},a=>{e(a.data)})},Hv=(n,e)=>{e.addEventListener("keydown",t=>{var a,i,s,o,l,r,c,u;if(t.target.localName==="protyle-html"){t.stopPropagation();return}if(n.disabled||!n.selectElement.classList.contains("fn__none")){t.stopPropagation(),t.preventDefault();return}n.wysiwyg.preventKeyup=!1,ne(["util"],n),t.shiftKey&&t.key.indexOf("Arrow")>-1||!t.repeat&&t.code!==""&&ne(["toolbar"],n);let d=he(n.wysiwyg.element);const f=M(d.startContainer);if(!f)return;const g=M(d.endContainer);if(!U("\u2318C",t)&&g&&!f.isSameNode(g)){t.stopPropagation(),t.preventDefault();return}if(Nv(t,f,n))return;if(f.classList.contains("protyle-wysiwyg--select")&&!ye(t)&&!t.shiftKey&&!t.altKey){if(t.key.toLowerCase()==="a")return t.stopPropagation(),t.preventDefault(),n.wysiwyg.element.blur(),setTimeout(()=>{rn(n,"afterend")},100),!1;if(t.key.toLowerCase()==="b")return t.stopPropagation(),t.preventDefault(),n.wysiwyg.element.blur(),setTimeout(()=>{rn(n,"beforebegin")},100),!1}if(t.isComposing){t.stopPropagation();return}if(!ye(t)&&!t.shiftKey&&!t.altKey&&(t.code==="Slash"?n.hint.enableSlash=!0:t.code==="Backslash"&&(n.hint.enableSlash=!1,ne(["hint"],n))),t.key!=="PageUp"&&t.key!=="PageDown"&&t.key!=="Home"&&t.key!=="End"&&t.key.indexOf("Arrow")===-1&&t.key!=="Escape"&&t.key!=="Shift"&&t.key!=="Meta"&&t.key!=="Alt"&&t.key!=="Control"&&t.key!=="CapsLock"&&!Me(f)&&!/^F\d{1,2}$/.test(t.key)&&typeof n.wysiwyg.lastHTMLs[f.getAttribute("data-node-id")]=="undefined"){const b=d.cloneRange();d.insertNode(document.createElement("wbr")),n.wysiwyg.lastHTMLs[f.getAttribute("data-node-id")]=f.outerHTML,f.querySelector("wbr").remove(),d=b}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(t.code.startsWith("Arrow")||t.code==="Enter")&&!t.altKey&&!t.shiftKey&&!ye(t)){t.preventDefault();return}else t.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(t.key)&&n.options.render.breadcrumb&&n.breadcrumb.hide(),!t.altKey&&!t.shiftKey&&!ye(t)&&(t.key==="ArrowDown"||t.key==="ArrowUp")){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>0){if(t.preventDefault(),t.stopPropagation(),ne(["select"],n),t.key==="ArrowDown"){const y=b[b.length-1];let w=Xe(y);if(w)if(w.getBoundingClientRect().width===0){const k=K(w,"fold","1");k?(w=Xe(k),w?w=$e(w):w=y):w=y}else w.getAttribute("fold")==="1"&&(w.classList.contains("sb")||w.classList.contains("bq"))||(w=$e(w));else w=y;w.classList.add("protyle-wysiwyg--select"),zt([w.getAttribute("data-node-id")]);const E=w.getBoundingClientRect().bottom-n.contentElement.getBoundingClientRect().bottom;E>0&&(n.contentElement.scrollTop=n.contentElement.scrollTop+E,n.scroll.lastScrollTop=n.contentElement.scrollTop-1),we(w)}else if(t.key==="ArrowUp"){let y=se(b[0]);if(y){if(y=Ee(y),y.getBoundingClientRect().width===0){const w=K(y,"fold","1");w?y=$e(w):y=b[0]}else if(y){const w=K(y,"fold","1");w&&(w.classList.contains("sb")||w.classList.contains("bq"))&&(y=w)}}else n.title&&(n.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||n.contentElement.scrollTop===0)?n.title.editElement.focus():n.contentElement.scrollTop!==0?(n.contentElement.scrollTop=0,n.scroll.lastScrollTop=8):y=b[0];if(y){y.classList.add("protyle-wysiwyg--select"),zt([y.getAttribute("data-node-id")]);const w=y.getBoundingClientRect().top-n.contentElement.getBoundingClientRect().top;w<0&&(n.contentElement.scrollTop=n.contentElement.scrollTop+w,n.scroll.lastScrollTop=n.contentElement.scrollTop+1),we(y)}}return}}if(t.key!=="PageUp"&&t.key!=="PageDown"&&t.key!=="Home"&&t.key!=="End"&&t.key.indexOf("Arrow")===-1&&!ye(t)&&t.key!=="Escape"&&!t.shiftKey&&!t.altKey&&!/^F\d{1,2}$/.test(t.key)&&t.key!=="Enter"&&t.key!=="Tab"&&t.key!=="Backspace"&&t.key!=="Delete"&&t.key!=="ContextMenu")return t.stopPropagation(),ne(["select"],n),!1;if(U(window.siyuan.config.keymap.editor.general.collapse.custom,t)&&!t.repeat){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return b.length>0?Vt(n,b[0]):f.parentElement.getAttribute("data-type")==="NodeListItem"?f.parentElement.childElementCount>3?Vt(n,f.parentElement):Vt(n,f):f.getAttribute("data-type")==="NodeHeading"?Vt(n,f):Vt(n,Oe(f)),t.stopPropagation(),t.preventDefault(),!1}if(U(window.siyuan.config.keymap.editor.general.expand.custom,t)&&!t.repeat){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");b.length>0?Vt(n,b[0],!0):f.parentElement.getAttribute("data-type")==="NodeListItem"?f.parentElement.childElementCount>3?Vt(n,f.parentElement,!0):Vt(n,f,!0):f.getAttribute("data-type")==="NodeHeading"?Vt(n,f,!0):Vt(n,Oe(f),!0),t.stopPropagation(),t.preventDefault();return}if((U("\u21E7\u2190",t)||U("\u21E7\u2192",t))&&n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){t.stopPropagation(),t.preventDefault();return}if(U(window.siyuan.config.keymap.editor.general.expandUp.custom,t)){rp({protyle:n,event:t,nodeElement:f,editorElement:e,range:d,cb(b){const y=b[0].previousElementSibling;if(y&&y.getAttribute("data-node-id")){y.classList.add("protyle-wysiwyg--select"),b.forEach(E=>{E.removeAttribute("select-end")}),y.setAttribute("select-end","true");const w=y.getBoundingClientRect().top-n.contentElement.getBoundingClientRect().top;w<0&&(n.contentElement.scrollTop=n.contentElement.scrollTop+w,n.scroll.lastScrollTop=n.contentElement.scrollTop+1)}else b[0].parentElement.classList.contains("protyle-wysiwyg")||(ne(["select"],n),b[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(U(window.siyuan.config.keymap.editor.general.expandDown.custom,t)){cp({protyle:n,event:t,nodeElement:f,editorElement:e,range:d,cb(b){const y=b[b.length-1],w=y.nextElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),b.forEach(k=>{k.removeAttribute("select-end")}),w.setAttribute("select-end","true");const E=w.getBoundingClientRect().bottom-n.contentElement.getBoundingClientRect().bottom;E>0&&(n.contentElement.scrollTop=n.contentElement.scrollTop+E,n.scroll.lastScrollTop=n.contentElement.scrollTop-1)}else y.parentElement.classList.contains("protyle-wysiwyg")||(ne(["select"],n),y.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(U("\u21E7\u2191",t)){rp({protyle:n,event:t,nodeElement:f,editorElement:e,range:d,cb(b){const y=Sl(b);if(y.startElement.getBoundingClientRect().top>=y.endElement.getBoundingClientRect().top){const w=y.endElement.previousElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),w.setAttribute("select-end","true"),y.endElement.removeAttribute("select-end");const E=w.getBoundingClientRect().top-n.contentElement.getBoundingClientRect().top;E<0&&(n.contentElement.scrollTop=n.contentElement.scrollTop+E,n.scroll.lastScrollTop=n.contentElement.scrollTop+1)}else y.endElement.parentElement.classList.contains("protyle-wysiwyg")||(ne(["select"],n),y.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{y.endElement.classList.remove("protyle-wysiwyg--select"),y.endElement.removeAttribute("select-end");const w=se(y.endElement);w&&(w.setAttribute("select-end","true"),w.getBoundingClientRect().top<=n.contentElement.getBoundingClientRect().top&&(cn(n),w.scrollIntoView(!0)))}}});return}if(U("\u21E7\u2193",t)){cp({protyle:n,event:t,nodeElement:f,editorElement:e,range:d,cb(b){const y=Sl(b);if(y.startElement.getBoundingClientRect().top<=y.endElement.getBoundingClientRect().top){const w=y.endElement.nextElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),w.setAttribute("select-end","true"),y.endElement.removeAttribute("select-end");const E=w.getBoundingClientRect().bottom-n.contentElement.getBoundingClientRect().bottom;E>0&&(n.contentElement.scrollTop=n.contentElement.scrollTop+E,n.scroll.lastScrollTop=n.contentElement.scrollTop-1)}else y.endElement.parentElement.classList.contains("protyle-wysiwyg")||(ne(["select"],n),y.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{y.endElement.classList.remove("protyle-wysiwyg--select"),y.endElement.removeAttribute("select-end");const w=Xe(y.endElement);w&&(w.setAttribute("select-end","true"),w.getBoundingClientRect().bottom>=n.contentElement.getBoundingClientRect().bottom&&(cn(n),w.scrollIntoView(!1)))}}});return}if(U(window.siyuan.config.keymap.general.enter.custom,t)){let b=Oe(f);b.parentElement.classList.contains("li")&&b.parentElement.parentElement.classList.contains("list")&&((a=b.nextElementSibling)!=null&&a.classList.contains("list"))&&b.previousElementSibling.classList.contains("protyle-action")&&(b=b.parentElement),Yt({protyle:n,id:b.getAttribute("data-node-id")}),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.general.enterBack.custom,t)){ed(n,f.getAttribute("data-node-id")),t.preventDefault(),t.stopPropagation();return}if(t.shiftKey&&!t.altKey&&!ye(t)&&(t.key==="Home"||t.key==="End")&&Ot()||t.shiftKey&&!t.altKey&&ye(t)&&(t.key==="Home"||t.key==="End")&&!Ot()){const b=K(f,"data-node-id",null);if(b){b.querySelectorAll(".protyle-wysiwyg--select").forEach(w=>{w.classList.remove("protyle-wysiwyg--select")}),b.classList.add("protyle-wysiwyg--select");let y=t.key==="Home"?b.previousElementSibling:b.nextElementSibling;for(;y;)y.classList.add("protyle-wysiwyg--select"),y=t.key==="Home"?y.previousElementSibling:y.nextElementSibling;t.key==="Home"?n.wysiwyg.element.firstElementChild.scrollIntoView():n.wysiwyg.element.lastElementChild.scrollIntoView(!1)}t.stopPropagation(),t.preventDefault();return}if(!t.altKey&&!t.shiftKey&&ye(t)&&t.key==="Home"){dp(n),ne(["select"],n),t.stopPropagation(),t.preventDefault();return}if(!t.altKey&&!t.shiftKey&&ye(t)&&t.key==="End"){up(n),ne(["select"],n),t.stopPropagation(),t.preventDefault();return}if(!t.altKey&&!t.shiftKey&&!ye(t)&&(t.key==="PageUp"||t.key==="PageDown")){t.key==="PageUp"?(n.contentElement.scrollTop=n.contentElement.scrollTop-n.contentElement.clientHeight,n.scroll.lastScrollTop=n.contentElement.scrollTop+1):(n.contentElement.scrollTop=n.contentElement.scrollTop+n.contentElement.clientHeight,n.scroll.lastScrollTop=n.contentElement.scrollTop-1);const b=n.contentElement.getBoundingClientRect();let y=document.elementFromPoint(b.x+b.width/2,b.y+b.height/2);y.classList.contains("protyle-wysiwyg")&&(y=document.elementFromPoint(b.x+b.width/2,b.y+b.height/2+p.Constants.SIZE_TOOLBAR_HEIGHT));const w=M(y);w&&!w.isSameNode(f)&&we(w,void 0,!1),t.stopPropagation(),t.preventDefault();return}if(!t.altKey&&!t.shiftKey&&(t.key.indexOf("Arrow")>-1&&!ye(t)||t.key==="Enter")&&!n.hint.element.classList.contains("fn__none")&&n.hint.select(t,n)){t.stopPropagation(),t.preventDefault();return}if(U("\u2318/",t)){t.stopPropagation(),t.preventDefault();const b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length===0){const w=S(d.startContainer,"data-type",null);if(w&&w.tagName==="SPAN"){const E=w.getAttribute("data-type").split(" ");if(E.length>0&&(n.toolbar.range=d,sp(w)),E.includes("block-ref")){Qc(n,w);return}else if(E.includes("inline-memo")){n.toolbar.showRender(n,w);return}else if(E.includes("file-annotation-ref")){Jc(n,w);return}else if(E.includes("a")){js(n,w);return}else if(E.includes("tag")){nd(n,w);return}}if(d.startOffset===0&&d.startContainer.nodeType===3){const E=ot(d.startContainer);if(E&&E.nodeType!==3&&((i=E.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){n.toolbar.showRender(n,E);return}else if(!E&&d.startContainer.parentElement.previousSibling&&d.startContainer.parentElement.previousSibling.isSameNode(d.startContainer.parentElement.previousElementSibling)&&((s=d.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1){n.toolbar.showRender(n,d.startContainer.parentElement.previousElementSibling);return}}b.push(f)}b.length===1?n.gutter.renderMenu(n,b[0]):n.gutter.renderMultipleMenu(n,b);const y=f.getBoundingClientRect();window.siyuan.menus.menu.popup({x:y.left,y:y.top,isLeft:!0});return}if(Qb(n,t,d)){t.preventDefault();return}const h=d.toString();if(!t.altKey&&!t.shiftKey&&!ye(t)&&!t.isComposing&&t.key.indexOf("Arrow")>-1){const b=J(f)||f,y=Et(b,n.wysiwyg.element,d),w=te(d.startContainer,"TD");if(t.key==="ArrowDown"&&(b==null?void 0:b.textContent.trimRight().substr(y.start).indexOf(`
`))===-1&&(w&&!w.parentElement.nextElementSibling&&f.getAttribute("data-type")==="NodeTable"&&!Xe(f)||f.getAttribute("data-type")==="NodeCodeBlock"&&!Xe(f)||f.parentElement.getAttribute("data-type")==="NodeBlockquote"&&f.nextElementSibling.classList.contains("protyle-attr")&&!Xe(f.parentElement)))f.parentElement.getAttribute("data-type")==="NodeBlockquote"?rn(n,"afterend",f.parentElement.getAttribute("data-node-id")):rn(n,"afterend",f.getAttribute("data-node-id"));else if(t.key==="ArrowUp"){const E=J(n.wysiwyg.element.firstElementChild);if(!se(f)&&f.contains(E)||!E&&f.isSameNode(n.wysiwyg.element.firstElementChild))(Cn(f,d).top-n.wysiwyg.element.getBoundingClientRect().top<40||f.classList.contains("av"))&&(n.title&&(n.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||n.contentElement.scrollTop===0)?n.title.editElement.focus():(n.contentElement.scrollTop=0,n.scroll.lastScrollTop=8));else if((b==null?void 0:b.textContent.substr(0,y.end).indexOf(`
`))===-1){let k=se(f);if(k&&(k=Ee(k),k)){const L=S(k,"fold","1");(o=J(k))!=null&&o.textContent.endsWith(`
`)&&!L?(we(k,void 0,!1),Ge(n,k),t.stopPropagation(),t.preventDefault()):L&&L.getAttribute("data-type")!=="NodeListItem"&&(L.scrollTop=0,we(L,void 0,!0),Ge(n,L),t.stopPropagation(),t.preventDefault())}}}else if(h===""&&(t.key==="ArrowDown"||t.key==="ArrowRight")&&f.isSameNode(Ee(n.wysiwyg.element.lastElementChild))&&!te(d.startContainer,"TD")&&!te(d.startContainer,"TH")){const E=J(f);E&&E.textContent.replace(/\n$/,"").length<=Et(E,void 0,d).end&&(t.stopPropagation(),t.preventDefault(),ee(d))}else if(h===""&&t.key==="ArrowLeft"&&f.isSameNode($e(n.wysiwyg.element.firstElementChild))){const E=J(f);E&&Et(E,void 0,d).start===0&&(t.stopPropagation(),t.preventDefault(),ee(d))}if(t.key==="ArrowDown"){const E=S(d.startContainer,"fold","1");if(E){let k=Xe(E);k&&(k.getAttribute("fold")==="1"&&(k.classList.contains("sb")||k.classList.contains("bq"))||(k=$e(k)),we(k),Ge(n,k)),t.stopPropagation(),t.preventDefault()}else if((b==null?void 0:b.textContent.substr(y.end+1).indexOf(`
`))===-1){const k=Xe(f);k&&k.getAttribute("fold")==="1"&&(we(k),Ge(n,k),t.stopPropagation(),t.preventDefault())}}return}if(!t.altKey&&(t.key==="Backspace"||t.key==="Delete")){if(n.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){gn(n,f,d),t.stopPropagation(),t.preventDefault();return}if(h===""&&t.key==="Backspace"&&d.startOffset===d.startContainer.textContent.length&&d.startContainer.textContent.endsWith(`
`+p.Constants.ZWSP)){d.setStart(d.startContainer,d.startOffset-1),d.collapse(!0),t.stopPropagation(),t.preventDefault();return}const b=ot(d.startContainer);if(d.startOffset===1&&d.startContainer.textContent===p.Constants.ZWSP&&b&&b.nodeType!==3&&t.key==="Backspace"){if(b.classList.contains("img"))b.classList.add("img--select");else if(((l=b.getAttribute("data-type"))==null?void 0:l.indexOf("inline-math"))>-1){b.after(document.createElement("wbr"));const w=f.outerHTML;d.startContainer.textContent="",b.remove(),ie(n,f.getAttribute("data-node-id"),f.outerHTML,w),_e(f,d),t.stopPropagation(),t.preventDefault();return}}if(d.startOffset===0&&h===""&&b&&((r=b.parentElement.getAttribute("data-type"))==null?void 0:r.indexOf("backslash"))>-1&&b.nodeType!==3&&b.outerHTML==="<span>\\</span>"&&!ot(b.parentElement)){d.setStartBefore(b.parentElement),gn(n,f,d),t.stopPropagation(),t.preventDefault();return}if(d.startOffset===1&&d.startContainer.nodeType!==3&&((c=d.startContainer.parentElement.getAttribute("data-type"))==null?void 0:c.indexOf("backslash"))>-1&&!ot(d.startContainer.parentElement)){d.setStartBefore(d.startContainer.parentElement),gn(n,f,d),t.stopPropagation(),t.preventDefault();return}const y=n.wysiwyg.element.querySelector(".img--select");if(y){if(y.classList.remove("img--select"),f.contains(y)){y.insertAdjacentHTML("afterend","<wbr>");const w=f.outerHTML;y.remove(),ie(n,f.getAttribute("data-node-id"),f.outerHTML,w),_e(f,d),t.stopPropagation(),t.preventDefault();return}}else if(h===""){const w=J(f);if(!w){f.classList.add("protyle-wysiwyg--select"),gn(n,f,d),t.stopPropagation(),t.preventDefault();return}const E=Et(w,n.wysiwyg.element,d);if(t.key==="Delete"){if(E.end===w.textContent.length){const k=Xe(Oe(f));if(k){const L=we(k);if(L){const v=M(L.startContainer);v&&gn(n,v,L)}t.stopPropagation(),t.preventDefault();return}}else if(E.end===w.textContent.length-1&&f.getAttribute("data-type")==="NodeCodeBlock"){t.stopPropagation(),t.preventDefault();return}}else{const k=d.startContainer.childNodes[d.startOffset-1];if(E.start===0&&(d.startOffset===0||k&&k.nodeType===3&&!ot(k)&&k.textContent==="")){gn(n,f,d),t.stopPropagation(),t.preventDefault();return}if(d.startContainer.nodeType!==3&&f.getAttribute("data-type")==="NodeTable"&&((u=d.startContainer.children[d.startOffset-1])==null?void 0:u.tagName)==="TABLE"){f.classList.add("protyle-wysiwyg--select"),gn(n,f,d),t.stopPropagation(),t.preventDefault();return}if(k&&k.nodeType!==3&&k.classList.contains("img")){d.insertNode(document.createElement("wbr"));const L=f.outerHTML;k.remove(),ie(n,f.getAttribute("data-node-id"),f.outerHTML,L),_e(f,d),t.stopPropagation(),t.preventDefault();return}if(f.classList.contains("code-block")&&ye(t)&&d.startContainer.nodeType===3&&d.startContainer.textContent.substring(d.startOffset-1,d.startOffset)===`
`){t.stopPropagation(),t.preventDefault();return}}}else if(f.classList.contains("code-block")&&J(f).textContent===`
`){d.collapse(!0),t.stopPropagation(),t.preventDefault();return}}if(U("\u21E7\u21A9",t)&&h===""){let b=d.startContainer;const y=rt(b);if(y&&y.nodeType!==3&&y.classList.contains("img")){y.insertAdjacentHTML("beforebegin","<wbr>");const w=f.outerHTML;y.previousElementSibling.remove();const E=document.createTextNode(`
`);b.after(document.createTextNode(p.Constants.ZWSP)),b.after(E),d.selectNode(E),d.collapse(!1),ie(n,f.getAttribute("data-node-id"),f.outerHTML,w),t.stopPropagation(),t.preventDefault();return}if(b.nodeType===3&&(b=b.parentElement),b&&n.toolbar.getCurrentType(d).length>0&&Et(b,b,d).end===b.textContent.length){b.insertAdjacentHTML("afterend","<wbr>");const w=f.outerHTML;b.nextElementSibling.remove(),rt(b)||b.after(document.createTextNode(`
`));const E=document.createTextNode(`
`);b.after(E),d.selectNode(E),d.collapse(!1),ie(n,f.getAttribute("data-node-id"),f.outerHTML,w),t.stopPropagation(),t.preventDefault();return}if(window.siyuan.config.system.container==="ios"){b=d.startContainer;const w=rt(b);if(w&&w.textContent.trim()!==""){document.execCommand("insertHTML",!1,`
`),t.stopPropagation(),t.preventDefault();return}w||b.after(document.createTextNode(`
`));const E=document.createTextNode(`
`);b.after(E);const k=rt(E);k&&k.textContent===`
`?d.setStart(k,0):d.setStart(E,0),d.collapse(!1),ee(d),t.stopPropagation(),t.preventDefault();return}}if(!t.altKey&&!t.shiftKey&&!ye(t)&&t.key==="Enter"){t.stopPropagation(),t.preventDefault(),Mv(f,d,n);return}if(U("\u2318A",t))return t.preventDefault(),mo(n,f,d),!0;if(U(window.siyuan.config.keymap.editor.general.undo.custom,t)){n.undo.undo(n),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.redo.custom,t)){n.undo.redo(n),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.copyProtocol.custom,t)){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let y;return b.length===1?y=b[0]:y=f,O(`siyuan://blocks/${y.getAttribute("data-node-id")}`),t.preventDefault(),t.stopPropagation(),!0}if(lp(n,t,f,d))return!0;if(U(window.siyuan.config.keymap.editor.general.copyID.custom,t))return O(f.getAttribute("data-node-id")),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.copyText.custom,t))return h!==""?Kd(d,b=>{O(`${Lute.EscapeHTMLStr(b.trim())} ((${f.getAttribute("data-node-id")} "*"))`)}):(f.setAttribute("data-reftext","true"),ee(he(f)),document.execCommand("copy")),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,t)){t.preventDefault(),t.stopPropagation();const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let y;if(b.length===1)y=b[0];else{const E=f.querySelector(".img--select");if(E)return wf(E.querySelector("img")),!0;y=f}const w=y.getAttribute("data-node-id");return h!==""?Kd(d,E=>{O(`((${w} "${Lute.EscapeHTMLStr(E.trim())}"))`)}):_("/api/block/getRefText",{id:w},E=>{O(`((${w} '${E.data}'))`)}),!0}if(U(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,t)){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let y;return b.length===1?y=b[0]:y=f,O(`{{select * from blocks where id='${y.getAttribute("data-node-id")}'}}`),t.preventDefault(),t.stopPropagation(),!0}if(U(window.siyuan.config.keymap.editor.general.attr.custom,t)){const b=Oe(f);if(h===""){const y=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let w;y.length===1?w=y[0]:w=b,ga(w,"bookmark",n)}else Kd(d,y=>{const w=b.outerHTML,E=Lute.EscapeHTMLStr(y.trim()),k=b.lastElementChild.querySelector(".protyle-attr--name");k?k.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${E}`:b.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${E}</div>`),b.setAttribute("name",E),ie(n,b.getAttribute("data-node-id"),b.outerHTML,w)});return t.preventDefault(),t.stopPropagation(),!0}if(U(window.siyuan.config.keymap.editor.general.rename.custom,t)&&!n.disabled){h===""?_("/api/block/getDocInfo",{id:n.block.rootID},b=>{_c({notebookId:n.notebookId,path:n.path,name:b.data.ial.title,range:d,type:"file"})}):_("/api/filetree/renameDoc",{notebook:n.notebookId,path:n.path,title:on(h)}),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.newNameFile.custom,t)){if(!(!h.trim()&&(f.querySelector("tr")||f.querySelector("span")))){!h.trim()&&J(f).textContent&&mo(n,f,d);const b=on(h.trim()?h.trim():n.lute.BlockDOM2Content(f.outerHTML).replace(/\n/g,""))||"Untitled";_("/api/filetree/getHPathByPath",{notebook:n.notebookId,path:n.path},y=>{_("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:xe().join(y.data,b),parentID:n.block.rootID,markdown:""},w=>{_t(`<span data-type="block-ref" data-id="${w.data}" data-subtype="d">${De(b.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,n),ne(["toolbar"],n)})})}t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,t)){!h.trim()&&(f.querySelector("tr")||f.querySelector("span"))||(!h.trim()&&J(f).textContent&&mo(n,f,d),Ec(n.path,n.notebookId,b=>{const y=on(h.trim()?h.trim():n.lute.BlockDOM2Content(f.outerHTML).replace(/\n/g,""))||"Untitled";_("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:xe().join(b,y),parentID:n.block.rootID,markdown:""},w=>{_t(`<span data-type="block-ref" data-id="${w.data}" data-subtype="d">${De(y.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,n),ne(["toolbar"],n)})})),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.newContentFile.custom,t)){zb(n),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.alignLeft.custom,t)){const b=f.querySelectorAll(".img--select");if(b.length>0)pp(n,f,Array.from(b),f.getAttribute("data-node-id"),f.outerHTML);else{let y=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&(y=[f]),Zs(y,n,w=>{w.classList.contains("av")?(w.style.margin="",Ln(w)):w.style.textAlign="left"})}t.stopPropagation(),t.preventDefault();return}if(U(window.siyuan.config.keymap.editor.general.alignCenter.custom,t)){const b=f.querySelectorAll(".img--select");if(b.length>0)fp(n,f,Array.from(b),f.getAttribute("data-node-id"),f.outerHTML);else{let y=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));y.length===0&&(y=[f]),Zs(y,n,w=>{w.classList.contains("av")?(w.style.margin="0 auto",Ln(w)):w.style.textAlign="center"})}t.stopPropagation(),t.preventDefault();return}if(U(window.siyuan.config.keymap.editor.general.alignRight.custom,t)){let b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b.length===0&&(b=[f]),Zs(b,n,y=>{y.classList.contains("av")?(y.style.margin="0 0 0 auto",Ln(y)):y.style.textAlign="right"}),t.stopPropagation(),t.preventDefault();return}if(t.key==="Escape"){!n.toolbar.element.classList.contains("fn__none")||!n.hint.element.classList.contains("fn__none")||!n.toolbar.subElement.classList.contains("fn__none")?(ne(["toolbar","hint","util"],n),n.hint.enableExtend=!1):f.classList.contains("protyle-wysiwyg--select")?(ne(["select"],n),zt([],n.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(ne(["select"],n),d.collapse(!1),f.classList.add("protyle-wysiwyg--select"),zt([f.getAttribute("data-node-id")],n.block.rootID)):window.siyuan.menus.menu.remove(),t.preventDefault();return}if(U(window.siyuan.config.keymap.editor.heading.paragraph.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Ps"}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.heading.heading1.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Hs",level:1}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.heading.heading2.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Hs",level:2}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.heading.heading3.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Hs",level:3}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.heading.heading4.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Hs",level:4}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.heading.heading5.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Hs",level:5}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.heading.heading6.custom,t))return ua({protyle:n,nodeElement:f,type:"Blocks2Hs",level:6}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.insert.code.custom,t)&&!["NodeCodeBlock","NodeHeading"].includes(f.getAttribute("data-type"))){const b=f.getAttribute("data-node-id"),y=f.outerHTML,w=J(f);w.innerHTML="```"+window.siyuan.storage[p.Constants.LOCAL_CODELANG]+`
`+w.textContent+"<wbr>\n```";const E=n.lute.SpinBlockDOM(f.outerHTML);f.outerHTML=E;const k=n.wysiwyg.element.querySelector(`[data-node-id="${b}"]`);return ie(n,b,E,y),Ze(k),t.preventDefault(),t.stopPropagation(),!0}if(U(window.siyuan.config.keymap.editor.insert.lastUsed.custom,t)){n.toolbar.range=d;let b=[];h===""&&n.toolbar.getCurrentType(d).length===0&&(b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),b.length===0&&(b=[f])),Na(n,b),t.stopPropagation(),t.preventDefault();return}if(!f.classList.contains("code-block")&&!t.repeat&&!S(f,"data-type","NodeBlockQueryEmbed")){let b=!1;if(n.options.toolbar.find(y=>{if(!y.hotkey)return!1;if(U(y.hotkey,t))return n.toolbar.range=he(n.wysiwyg.element),["block-ref"].includes(y.name)&&n.toolbar.range.toString()===""||(b=!0,["a","block-ref","inline-math","inline-memo","text"].includes(y.name)?n.toolbar.element.querySelector(`[data-type="${y.name}"]`).dispatchEvent(new CustomEvent("click")):n.toolbar.setInlineMark(n,y.name,"range")),!0}),b)return t.preventDefault(),t.stopPropagation(),n.wysiwyg.preventKeyup=!0,!0}if(U(window.siyuan.config.keymap.editor.list.outdent.custom,t)){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>0&&b[0].getAttribute("data-type")==="NodeListItem")return fl(n,Array.from(b),d),t.preventDefault(),t.stopPropagation(),!0;if(f.parentElement.classList.contains("li")&&f.getAttribute("data-type")!=="NodeCodeBlock")return fl(n,[f.parentElement],d),t.preventDefault(),t.stopPropagation(),!0}if(U(window.siyuan.config.keymap.editor.list.indent.custom,t)){const b=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>0&&b[0].getAttribute("data-type")==="NodeListItem")return of(n,Array.from(b),d),t.preventDefault(),t.stopPropagation(),!0;if(f.parentElement.classList.contains("li")&&f.getAttribute("data-type")!=="NodeCodeBlock")return of(n,[f.parentElement],d),t.preventDefault(),t.stopPropagation(),!0}if(U(window.siyuan.config.keymap.editor.insert.check.custom,t)){n.hint.splitChar="/",n.hint.lastIndex=-1,n.hint.fill("* [ ] "+Lute.Caret,n),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.insert.table.custom,t)){n.hint.splitChar="/",n.hint.lastIndex=-1,n.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,n),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.list.checkToggle.custom,t)){const b=S(d.startContainer,"data-subtype","t");if(!b)return;const y=b.outerHTML;b.classList.contains("protyle-task--done")?(b.querySelector("use").setAttribute("xlink:href","#iconUncheck"),b.classList.remove("protyle-task--done")):(b.querySelector("use").setAttribute("xlink:href","#iconCheck"),b.classList.add("protyle-task--done")),b.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(n,b.getAttribute("data-node-id"),b.outerHTML,y),t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.insertBefore.custom,t))return rn(n,"beforebegin"),t.preventDefault(),!0;if(U(window.siyuan.config.keymap.editor.general.insertAfter.custom,t))return rn(n,"afterend"),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,t))return rf(n,f),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.moveToUp.custom,t)){t.preventDefault(),t.stopPropagation(),Dw(n,f,d);return}if(U(window.siyuan.config.keymap.editor.general.moveToDown.custom,t)){t.preventDefault(),t.stopPropagation(),$w(n,f,d);return}if((U("\u2318X",t)||U("\u2318C",t))&&h===""&&!f.querySelector(".img--select")&&n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length===0&&f.dataset.type!=="NodeHTMLBlock"&&f.classList.add("protyle-wysiwyg--select"),U(window.siyuan.config.keymap.editor.general.copyPlainText.custom,t)){if(h===""){const b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let y="";b.length===0&&b.push(f),b.forEach(w=>{w.querySelectorAll("[spellcheck]").forEach(E=>{const k=E.cloneNode(!0);k.querySelectorAll('[data-type="backslash"]').forEach(L=>{L.firstElementChild.remove()}),y+=k.textContent+`
`})}),Y(y.trimEnd())}else{const b=d.cloneContents();b.querySelectorAll('[data-type="backslash"]').forEach(y=>{y.firstElementChild.remove()}),O(b.textContent)}t.preventDefault(),t.stopPropagation();return}if(U(window.siyuan.config.keymap.editor.general.vLayout.custom,t)){t.preventDefault(),t.stopPropagation();const b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length<2)return;id({protyle:n,selectsElement:b,type:"BlocksMergeSuperBlock",level:"row"});return}if(U(window.siyuan.config.keymap.editor.general.hLayout.custom,t)){t.preventDefault(),t.stopPropagation();const b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length<2)return;id({protyle:n,selectsElement:b,type:"BlocksMergeSuperBlock",level:"col"});return}if(!t.repeat&&U(window.siyuan.config.keymap.editor.general.duplicate.custom,t)){t.preventDefault(),t.stopPropagation();let b=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));b.length===0&&(b=[f]),Xc(b,n);return}if(t.key==="Tab"&&!t.ctrlKey&&!ye(t)&&!t.altKey){t.preventDefault();const b=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(f.getAttribute("data-type")==="NodeCodeBlock"&&h!==""){const y=document.createElement("wbr");d.startContainer.nodeType!==3&&d.startContainer.classList.contains("protyle-action")&&d.setStart(f.querySelector(".hljs").firstChild,0),d.insertNode(y),d.setStartAfter(y);const w=f.outerHTML;let E="";t.shiftKey?d.extractContents().textContent.split(`
`).forEach(v=>{v.startsWith(b)?E+=v.replace(b,"")+`
`:E+=v+`
`}):d.extractContents().textContent.split(`
`).forEach(v=>{E+=b+v+`
`});const k=document.createElement("span");let L=f.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(L)||(L="plaintext"),k.innerHTML=window.hljs.highlight(E.substr(0,E.length-1),{language:L,ignoreIllegals:!0}).value,d.insertNode(k),ie(n,f.getAttribute("data-node-id"),f.outerHTML,w),y.remove();return}if(!t.shiftKey){const y=document.createElement("wbr");d.insertNode(y);const w=f.outerHTML;return d.extractContents(),d.insertNode(document.createTextNode(b)),d.collapse(!1),ee(d),y.remove(),ie(n,f.getAttribute("data-node-id"),f.outerHTML,w),!0}}if(t.key==="ContextMenu"){const b=Cn(f,d);n.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:f,y:b.top+8,x:b.left}})),t.preventDefault(),t.stopPropagation();return}const m=S(d.startContainer,"data-type","block-ref");if(m){const b=m.getAttribute("data-id");if(U(window.siyuan.config.keymap.editor.general.openBy.custom,t))return _("/api/block/checkBlockFold",{id:b},y=>{be({app:n.app,id:b,action:y.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:y.data})}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.refTab.custom,t))return _("/api/block/checkBlockFold",{id:b},y=>{be({app:n.app,id:b,action:y.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:y.data})}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.insertRight.custom,t))return _("/api/block/checkBlockFold",{id:b},y=>{be({app:n.app,id:b,position:"right",action:y.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:y.data})}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.insertBottom.custom,t))return _("/api/block/checkBlockFold",{id:b},y=>{be({app:n.app,id:b,position:"bottom",action:y.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:y.data})}),t.preventDefault(),t.stopPropagation(),!0;if(U(window.siyuan.config.keymap.editor.general.refPopover.custom,t))return window.siyuan.blockPanels.push(new uo({app:n.app,isBacklink:!1,targetElement:m,nodeIds:[b]})),t.preventDefault(),t.stopPropagation(),!0}if(U("\u21E7\u2318V",t)){t.returnValue=!1,t.preventDefault(),t.stopPropagation(),Bc(n);return}!ye(t)&&t.key!=="Backspace"&&t.key!=="Escape"&&t.key!=="Delete"&&!t.shiftKey&&!t.altKey&&t.key!=="Enter"&&ne(["select"],n)})},im=(n,e,t)=>{const a=(0,T.tq)(),i=$(n.target,"protyle-attr--bookmark");if(i)return!a&&(n.ctrlKey||n.metaKey)?Hn(e.app,i.textContent.trim(),!0):t?On(t,"bookmark",e):ga(i.parentElement.parentElement,"bookmark",e),n.stopPropagation(),!0;const s=$(n.target,"protyle-attr--name");if(s)return!a&&(n.ctrlKey||n.metaKey)?Hn(e.app,s.textContent.trim(),!0):t?On(t,"name",e):ga(s.parentElement.parentElement,"name",e),n.stopPropagation(),!0;const o=$(n.target,"protyle-attr--av");if(o)return t?On(t,"av",e):ga(o.parentElement.parentElement,"av",e),n.stopPropagation(),!0;const l=$(n.target,"protyle-attr--alias");if(l)return!a&&(n.ctrlKey||n.metaKey)?Hn(e.app,l.textContent.trim(),!0):t?On(t,"alias",e):ga(l.parentElement.parentElement,"alias",e),n.stopPropagation(),!0;const r=$(n.target,"protyle-attr--memo");if(r)return!a&&(n.ctrlKey||n.metaKey)?Hn(e.app,r.getAttribute("aria-label").trim(),!0):t?On(t,"memo",e):ga(r.parentElement.parentElement,"memo",e),n.stopPropagation(),!0};class Bv{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),(0,T.tq)()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),!e.options.action.includes(p.Constants.CB_GET_HISTORY)&&(this.bindEvent(e),Hv(e,this.element),xv(e,this.element))}renderCustom(e){let t=e[p.Constants.CUSTOM_SY_FULLWIDTH];t||(t=window.siyuan.config.editor.fullWidth?"true":"false"),t==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(e);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","scroll","data-realwidth"].includes(s)&&!a.includes(s)&&(this.element.removeAttribute(s),i--)}a.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth"].includes(i)||this.element.setAttribute(i,e[i])})}escapeInline(e,t,a){if(!a.data)return;const i=a.data;e.toolbar.range=t;const s=t.startContainer.parentElement,o=e.toolbar.getCurrentType();let l=i.length;if((i==="<"||i===">")&&(l=4),o.length>0&&t.toString()===""&&t.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(p.Constants.ZWSP,"")!==i&&s.textContent.replace(p.Constants.ZWSP,"").length>=i.length&&!ot(t.startContainer)&&!ot(s)){const r=s.innerHTML.replace(p.Constants.ZWSP,"");s.innerHTML=r.substr(l);const c=document.createTextNode(i);s.before(c),t.selectNodeContents(c),t.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!o.includes("search-mark")&&t.toString()===""&&t.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("text")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!rt(t.startContainer)&&t.startContainer.textContent.length===t.startOffset&&s.textContent.length>i.length){const r=Et(s,e.wysiwyg.element,t),c=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=c.substr(0,c.length-l);const u=document.createTextNode(i);s.after(u),t.selectNodeContents(u),t.collapse(!1)}}}setEmptyOutline(e,t){e.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__row--select").forEach(i=>{i.classList.contains("av__row--select")&&!$(t,"av")?(i.classList.remove("av__row--select"),i.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),Wi(i)):i.classList.remove("img--select","av__cell--select")});let a=t;if(!t.getAttribute("data-node-id")){const i=M(t);if(!i)return;a=i}e.model&&Ye().outline.forEach(i=>{i.blockId===e.block.rootID&&i.setCurrent(a)})}emojiToMd(e){e.querySelectorAll(".emoji").forEach(t=>{t.outerHTML=`:${t.getAttribute("alt")}:`})}bindCommonEvent(e){this.element.addEventListener("copy",t=>{if(window.siyuan.ctrlIsPressed=!1,t.target.tagName==="PROTYLE-HTML"){t.stopPropagation();return}t.stopPropagation(),t.preventDefault();const a=he(e.wysiwyg.element),i=M(a.startContainer);if(!i)return;const s=i.querySelector(".img--select");let o=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));o.length===0&&a.toString()===""&&!a.cloneContents().querySelector("img")&&!s&&(i.classList.add("protyle-wysiwyg--select"),zt([i.getAttribute("data-node-id")]),o=[i]);let l="",r="";if(o.length>0){const c=o[0].getAttribute("data-reftext")==="true";if(o[0].getAttribute("data-type")==="NodeListItem"&&o[0].parentElement.classList.contains("list")&&o[0].parentElement.childElementCount-1===o.length)if(c){const u=o[0].parentElement.cloneNode(!0),d=J(u);d&&d.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),l=u.outerHTML,o[0].removeAttribute("data-reftext")}else l=o[0].parentElement.outerHTML;else o.forEach((u,d)=>{if(c&&d===0){const f=u.cloneNode(!0),g=J(f);g&&g.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),l+=oa(f),o[0].removeAttribute("data-reftext")}else l+=oa(u)})}else{const c=document.createElement("div"),u=e.toolbar.getCurrentType(a);if((u.length>0||a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading")&&(a.startContainer.nodeType===3&&a.startContainer.parentElement.textContent===a.toString()||a.startContainer.nodeType!==3&&a.startContainer.textContent===a.toString()))a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading"?c.append(a.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(a.startContainer.parentElement.tagName)?(c.append(a.cloneContents()),this.emojiToMd(c)):(c.append(a.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(c)),l=c.innerHTML;else if(s)l=s.outerHTML;else if(u.length>0&&a.startContainer.nodeType===3&&a.startContainer.parentElement.tagName==="SPAN"&&a.startContainer.parentElement.isSameNode(a.endContainer.parentElement)){const d=a.startContainer.parentElement.attributes,f=document.createElement("span");for(let g=0;g<d.length;g++)f.setAttribute(d[g].name,d[g].value);f.getAttribute("data-type").indexOf("block-ref")>-1&&f.getAttribute("data-subtype")==="d"&&f.setAttribute("data-subtype","s"),f.textContent=a.toString(),l=f.outerHTML}else{c.append(a.cloneContents()),this.emojiToMd(c);const d=S(a.commonAncestorContainer,"data-type","inline-math");d?l=d.outerHTML:l=c.innerHTML,(S(a.startContainer,"data-type","NodeCodeBlock")||te(a.startContainer,"CODE"))&&(r=c.textContent.replace(p.Constants.ZWSP,""))}}e.disabled&&(l=Vb(l)),r=r||e.lute.BlockDOM2StdMd(l).trimEnd(),r=r.replace(/\u00A0/g," "),t.clipboardData.setData("text/plain",r),t.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(l)),t.clipboardData.setData("text/siyuan",l)}),this.element.addEventListener("mousedown",t=>{var a;if(t.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=M(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||ne(["select"],e);const i=t.target;if($(i,"protyle-action")||$(i,"av__gutters")||$(i,"av__cellheader"))return;const s=document,o=e.element.getBoundingClientRect(),l=o.left+parseInt(e.wysiwyg.element.style.paddingLeft)+1,r=l+(e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight))-2,c=o.bottom,u=t.clientY;if(!e.disabled&&i.classList.contains("av__widthdrag")){const w=M(i);if(!w)return;const E=w.getAttribute("data-av-id"),k=i.parentElement,L=k.clientWidth,v=k.getAttribute("data-col-id");let A;s.onmousemove=C=>{A=Math.max(L+(C.clientX-t.clientX),100)+"px",k.parentElement.parentElement.querySelectorAll(".av__row, .av__row--footer").forEach(D=>{D.querySelector(`[data-col-id="${v}"]`).style.width=A})},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,G(e,[{action:"setAttrViewColWidth",id:v,avID:E,data:A}],[{action:"setAttrViewColWidth",id:v,avID:E,data:L+"px"}])},t.stopPropagation(),t.preventDefault();return}if(!e.disabled&&i.classList.contains("protyle-action__drag")){const w=M(i);if(!w)return;let E=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(w.getAttribute("data-type"))?(w.classList.add("iframe--drag"),(w.style.textAlign==="left"||w.style.textAlign==="right")&&(E=!1)):i.parentElement.parentElement.getAttribute("data-type")==="img"&&i.parentElement.parentElement.classList.add("img--drag");const k=w.getAttribute("data-node-id"),L=w.outerHTML,v=t.clientX,A=i.previousElementSibling,C=A.clientWidth,D=A.clientHeight;s.onmousemove=x=>{A.tagName==="IMG"&&(A.parentElement.parentElement.style.width=""),x.clientX>v-C+8&&x.clientX<r&&(A.tagName==="IMG"&&A.parentElement.parentElement.style.display!=="block"||!E?A.style.width=Math.max(17,C+(x.clientX-v))+"px":A.style.width=Math.max(17,C+(x.clientX-v)*2)+"px"),A.tagName!=="IMG"?x.clientY>u-D+8&&x.clientY<c&&(A.style.height=D+(x.clientY-u)+"px"):(A.parentElement.parentElement.style.width=parseInt(A.style.width)+10+"px",A.parentElement.parentElement.style.maxWidth="")},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,i.classList.contains("protyle-action__drag")&&w&&ie(e,k,w.outerHTML,L),w.classList.remove("iframe--drag"),i.parentElement.parentElement.classList.remove("img--drag")};return}let d;if((i.tagName==="TH"||i.tagName==="TD"||((a=i.firstElementChild)==null?void 0:a.tagName)==="TABLE"||i.classList.contains("table__resize")||i.classList.contains("table__select"))&&(d=M(i),d&&(d.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),t.stopPropagation())),!e.disabled&&i.classList.contains("table__resize")){const w=M(i);if(!w)return;const E=w.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),w.firstElementChild.style.webkitUserModify="read-only",w.style.cursor="col-resize",i.removeAttribute("style");const k=w.getAttribute("data-node-id"),L=t.clientX,v=parseInt(i.getAttribute("data-col-index")),A=w.querySelectorAll("table col")[v];A.style.minWidth&&(A.style.width=w.querySelectorAll("table td, table th")[v].offsetWidth+"px",A.style.minWidth=""),w.querySelectorAll("tr").forEach(x=>{x.cells[v].style.width=""});const C=A.clientWidth,D=w.firstElementChild.clientWidth<w.firstElementChild.scrollWidth;s.onmousemove=x=>{w.style.textAlign==="center"&&!D?A.style.width=C+(x.clientX-L)*2+"px":A.style.width=C+(x.clientX-L)+"px"},s.onmouseup=()=>{w.firstElementChild.style.webkitUserModify="",w.style.cursor="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,w&&ie(e,k,w.outerHTML,E)};return}if(["IMG","VIDEO","AUDIO"].includes(i.tagName))return;let f=t.clientX;t.clientX>r?f=r:t.clientX<l&&(f=l);const g=o.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let h,m,b,y;s.onmousemove=w=>{const E=w.target;if(!e.disabled&&d&&d.contains(E)&&!$(d,"protyle-wysiwyg__embed")){if((E.tagName==="TH"||E.tagName==="TD")&&!E.isSameNode(i)&&(!m||!m.isSameNode(E))){d.firstElementChild.style.webkitUserModify="read-only";let Q=i.offsetLeft+i.clientWidth-E.offsetLeft,ce=E.offsetLeft;i.offsetLeft===E.offsetLeft?Q=Math.max(i.clientWidth,E.clientWidth):i.offsetLeft<E.offsetLeft&&(Q=E.offsetLeft+E.clientWidth-i.offsetLeft,ce=i.offsetLeft);let Pe=i.offsetTop+i.clientHeight-E.offsetTop,ge=E.offsetTop;i.offsetTop===E.offsetTop?Pe=Math.max(i.clientHeight,E.clientHeight):i.offsetTop<E.offsetTop&&(Pe=E.offsetTop+E.clientHeight-i.offsetTop,ge=i.offsetTop),Array.from(d.querySelectorAll("th, td")).find(de=>{const It=de.offsetLeft<ce+Q&&de.offsetLeft+de.clientWidth>ce+Q,Ie=de.offsetLeft<ce&&de.offsetLeft+de.clientWidth>ce;de.offsetTop<ge&&de.offsetTop+de.clientHeight>ge?((de.offsetLeft+6>ce&&de.offsetLeft+de.clientWidth-6<ce+Q||It||Ie)&&(Pe=ge+Pe-de.offsetTop,ge=de.offsetTop),It&&(Q=de.offsetLeft+de.clientWidth-ce),Ie&&(Q=ce+Q-de.offsetLeft,ce=de.offsetLeft)):de.offsetTop<ge+Pe&&de.offsetTop+de.clientHeight>ge+Pe?((de.offsetLeft+6>ce&&de.offsetLeft+de.clientWidth-6<ce+Q||It||Ie)&&(Pe=de.clientHeight+de.offsetTop-ge),It&&(Q=de.offsetLeft+de.clientWidth-ce),Ie&&(Q=ce+Q-de.offsetLeft,ce=de.offsetLeft)):Ie&&de.offsetTop+6>ge&&de.offsetTop+de.clientHeight-6<ge+Pe?(Q=ce+Q-de.offsetLeft,ce=de.offsetLeft):It&&de.offsetTop+6>ge&&de.offsetTop+de.clientHeight-6<ge+Pe&&(Q=de.offsetLeft+de.clientWidth-ce)}),d.querySelector(".table__select").setAttribute("style",`left:${ce-d.firstElementChild.scrollLeft}px;top:${ge}px;height:${Pe}px;width:${Q+1}px;`),m=E}return}e.selectElement.classList.remove("fn__none"),ne(["gutter"],e);let k=0,L=0,v=0,A=0;if(w.clientX<f?(w.clientX<l?L=l:L=w.clientX,v=f-L):w.clientX>r?(L=f,v=r-L):(L=f,v=w.clientX-f),w.clientY>u?w.clientY>c?(k=u,A=c-u):(k=u,A=w.clientY-u):(w.clientY<g?k=g:k=w.clientY,A=u-k),A<4)return;e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${k}px;height:${A}px;left:${L+2}px;width:${v-2}px;`);const C=document.elementFromPoint(w.clientX,w.clientY);if(h&&h.isSameNode(C)&&!h.classList.contains("protyle-wysiwyg")&&!h.classList.contains("list")&&!h.classList.contains("bq")&&!h.classList.contains("sb"))return;h=C,ne(["select"],e);let D;if(w.clientY>u?(D=b||document.elementFromPoint(L,k),y=void 0):(D=document.elementFromPoint(L,k),b=void 0),!D||((D.classList.contains("protyle-wysiwyg")||D.classList.contains("list")||D.classList.contains("sb")||D.classList.contains("bq"))&&(D=document.elementFromPoint(L,k+16)),!D))return;let x=M(D);w.clientY>u?b||(b=D):!x&&w.clientY<e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(x=e.wysiwyg.element.firstElementChild);let P=[],B=x,V=!1;const X=y?y.getBoundingClientRect().bottom:k+A;for(;B;)if(B&&!B.classList.contains("protyle-attr")){const Q=B.getBoundingClientRect();if(Q.height>0&&Q.top<X&&Q.left<L+v)if(V)if(B.nextElementSibling&&!B.nextElementSibling.classList.contains("protyle-attr")){const ce=B.nextElementSibling.getBoundingClientRect();if(ce.top<X&&ce.left<L+v)P=[B],B=B.nextElementSibling,V=!1;else if(B.parentElement.classList.contains("sb"))B=M(B.parentElement),V=!0;else break}else B=M(B.parentElement),V=!0;else P.push(B),B=B.nextElementSibling;else if(B.parentElement.classList.contains("sb"))B=M(B.parentElement),V=!0;else if(Q.height===0&&Q.width===0&&B.parentElement.getAttribute("fold")==="1")B=B.parentElement,P=[];else break}else B=M(B.parentElement),V=!0;w.clientY<=u&&!y&&(y=P[P.length-1]),P.length===1&&!P[0].classList.contains("list")&&!P[0].classList.contains("bq")&&!P[0].classList.contains("sb")?e.selectElement.style.backgroundColor="transparent":(P.forEach(Q=>{$(Q,"protyle-wysiwyg__embed")||Q.classList.add("protyle-wysiwyg--select")}),e.selectElement.style.backgroundColor="")},s.onmouseup=w=>{var E;if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,b=void 0,y=void 0,e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),!e.disabled&&d){d.firstElementChild.style.webkitUserModify="";const v=d.querySelector(".table__select");v.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.mergeCell,click:()=>{if(d){const A=[],C=[],D=d.querySelectorAll("th").length;let x=0;const P=d.firstElementChild.scrollLeft;let B=!1,V=!1;d.querySelectorAll("th, td").forEach((Ie,Pn)=>{Ie.classList.contains("fn__none")?(Ie.previousElementSibling&&Ie.previousElementSibling.isSameNode(A[A.length-1])||Pn<x&&C.includes((Pn+1)%D))&&(A.push(Ie),!B&&Ie.parentElement.parentElement.tagName==="THEAD"?B=!0:!V&&Ie.parentElement.parentElement.tagName==="TBODY"&&(V=!0)):Ie.offsetLeft+6>v.offsetLeft+P&&Ie.offsetLeft+Ie.clientWidth-6<v.offsetLeft+P+v.clientWidth&&Ie.offsetTop+6>v.offsetTop&&Ie.offsetTop+Ie.clientHeight-6<v.offsetTop+v.clientHeight&&(A.push(Ie),!B&&Ie.parentElement.parentElement.tagName==="THEAD"?B=!0:!V&&Ie.parentElement.parentElement.tagName==="TBODY"&&(V=!0),C.push((Pn+1)%D),x=Math.max((Ie.rowSpan-1)*D+Pn+1,x))}),v.removeAttribute("style");const X=d.outerHTML;let Q=A[0],ce=Q.colSpan,Pe=1;for(;Q.nextElementSibling&&Q.nextElementSibling.isSameNode(A[Pe]);)Q=Q.nextElementSibling,Q.classList.contains("fn__none")||(ce+=Q.colSpan),Pe++;let ge="",de=A[0].parentElement,It=A[0].rowSpan;if(A.forEach((Ie,Pn)=>{let Ca=Ie.innerHTML.trim();Ca.endsWith("<br>")&&(Ca=Ca.substr(0,Ca.length-4)),ge+=Ca+(!Ca||Pn===A.length-1?"":"<br>"),Pn!==0&&(de.isSameNode(Ie.parentElement)||(Ie.classList.contains("fn__none")||(It+=Ie.rowSpan),de=Ie.parentElement,A[0].parentElement.parentElement.tagName==="THEAD"&&Ie.parentElement.parentElement.tagName!=="THEAD"&&A[0].parentElement.parentElement.insertAdjacentElement("beforeend",Ie.parentElement)),Ie.classList.add("fn__none"),Ie.innerHTML="")}),B&&V)for(de=de.parentElement.nextElementSibling.firstElementChild;de&&de.parentElement.tagName!=="THEAD";){let Ie=0,Pn=0;if(Array.from(de.children).forEach(Ca=>{Ie+=Ca.colSpan-1,Ca.classList.contains("fn__none")&&Pn++}),Ie!==Pn)A[0].parentElement.parentElement.insertAdjacentElement("beforeend",de),de=de.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{d&&(A[0].innerHTML=ge+"<wbr>",A[0].colSpan=ce,A[0].rowSpan=It,_e(A[0],document.createRange()),ie(e,d.getAttribute("data-node-id"),d.outerHTML,X))})}}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(d){const A=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(D=>{!D.classList.contains("fn__none")&&D.offsetLeft+6>v.offsetLeft+C&&D.offsetLeft+D.clientWidth-6<v.offsetLeft+C+v.clientWidth&&D.offsetTop+6>v.offsetTop&&D.offsetTop+D.clientHeight-6<v.offsetTop+v.clientHeight&&(A.length===0||A.length>0&&D.offsetTop===A[0].offsetTop)&&A.push(D)}),v.removeAttribute("style"),ca(e,A,d,"left",he(d))}}}).element),window.siyuan.menus.menu.append(new I({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(d){const A=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(D=>{!D.classList.contains("fn__none")&&D.offsetLeft+6>v.offsetLeft+C&&D.offsetLeft+D.clientWidth-6<v.offsetLeft+C+v.clientWidth&&D.offsetTop+6>v.offsetTop&&D.offsetTop+D.clientHeight-6<v.offsetTop+v.clientHeight&&(A.length===0||A.length>0&&D.offsetTop===A[0].offsetTop)&&A.push(D)}),v.removeAttribute("style"),ca(e,A,d,"center",he(d))}}}).element),window.siyuan.menus.menu.append(new I({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(d){const A=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(D=>{!D.classList.contains("fn__none")&&D.offsetLeft+6>v.offsetLeft+C&&D.offsetLeft+D.clientWidth-6<v.offsetLeft+C+v.clientWidth&&D.offsetTop+6>v.offsetTop&&D.offsetTop+D.clientHeight-6<v.offsetTop+v.clientHeight&&(A.length===0||A.length>0&&D.offsetTop===A[0].offsetTop)&&A.push(D)}),v.removeAttribute("style"),ca(e,A,d,"right",he(d))}}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.clear,icon:"iconTrashcan",click(){if(d){const A=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(x=>{!x.classList.contains("fn__none")&&x.offsetLeft+6>v.offsetLeft+C&&x.offsetLeft+x.clientWidth-6<v.offsetLeft+C+v.clientWidth&&x.offsetTop+6>v.offsetTop&&x.offsetTop+x.clientHeight-6<v.offsetTop+v.clientHeight&&A.push(x)}),v.removeAttribute("style");const D=d.outerHTML;A.forEach(x=>{x.innerHTML=""}),ie(e,d.getAttribute("data-node-id"),d.outerHTML,D)}}}).element),window.siyuan.menus.menu.popup({x:w.clientX-8,y:w.clientY-16}))}const k=[],L=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(L.forEach(v=>{k.push(v.getAttribute("data-node-id"))}),zt(k),getSelection().rangeCount>0){const v=getSelection().getRangeAt(0);if((v.toString()===""||window.siyuan.shiftIsPressed)&&t.detail===3){let D=M(v.startContainer);if(D){if((E=D.nextElementSibling)!=null&&E.classList.contains("table"))Xt(J(D),v,!1);else if(D.classList.contains("table")){const x=D.querySelectorAll("th, td");D=x[x.length-1],D.contains(v.startContainer)&&Xt(D,v,!1)}}return}if(L.length>0){v.collapse(!0);return}const A=M(v.startContainer);let C;w.detail===3&&v.endContainer.nodeType!==3&&v.endContainer.tagName==="DIV"&&v.endOffset===0?v.endContainer.classList.contains("protyle-attr")&&Xt(v.endContainer.previousElementSibling,v,!1):C=M(v.endContainer),A&&C&&!C.isSameNode(A)&&v.collapse(!0)}}})}bindEvent(e){this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const l=getSelection().getRangeAt(0);(this.element.isSameNode(l.startContainer)||this.element.contains(l.startContainer))&&(e.toolbar.range=l)}),this.element.addEventListener("cut",l=>{var r,c;if(window.siyuan.ctrlIsPressed=!1,e.disabled)return;if(l.target.tagName==="PROTYLE-HTML"){l.stopPropagation();return}e.options.render.breadcrumb&&e.breadcrumb.hide();const u=he(e.wysiwyg.element);let d=M(u.startContainer);if(!d){l.stopPropagation(),l.preventDefault();return}if(d.classList.contains("av")){ml(e,d),l.stopPropagation();return}l.stopPropagation(),l.preventDefault();const f=d.querySelector(".img--select");let g=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));g.length===0&&u.toString()===""&&!u.cloneContents().querySelector("img")&&!f&&(d.classList.add("protyle-wysiwyg--select"),g=[d]);let h="";if(g.length>0){g[0].getAttribute("data-type")==="NodeListItem"&&g[0].parentElement.classList.contains("list")&&g[0].parentElement.childElementCount-1===g.length?h=g[0].parentElement.outerHTML:(g.forEach(y=>{const w=Oe(y);y.getAttribute("data-type")==="NodeHeading"&&y.getAttribute("fold")==="1"?h+=oa(w).replace('fold="1"',""):h+=oa(w)}),g[0].getAttribute("data-type")==="NodeListItem"&&(h=`<div data-subtype="${g[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${h}<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`));const b=Xe(g[g.length-1]);gn(e,d,u),b&&we(b)}else{const b=d.getAttribute("data-node-id"),y=d.outerHTML,w=document.createElement("div");let E=u.startContainer;if(E.nodeType===3&&E.textContent===""){const v=rt(u.startContainer);v&&(E=v)}const k=S(E,"data-type","NodeHeading");let L=!1;if(k&&u.toString()===k.firstElementChild.textContent){const v=[{action:"delete",id:k.getAttribute("data-node-id")}],A=[{action:"insert",id:k.getAttribute("data-node-id"),data:k.outerHTML,previousID:(r=k.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:((c=k.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.block.parentID}];if(k.getAttribute("fold")==="1"){L=!0;const C=k.cloneNode(!0);C.removeAttribute("fold"),w.append(C),A[0].data=C.outerHTML,Vt(e,k,void 0,!0)}else{if(k.parentElement.childElementCount===3&&k.parentElement.classList.contains("li")||k.parentElement.childElementCount===2&&(k.parentElement.classList.contains("bq")||k.parentElement.classList.contains("sb"))||k.parentElement.childElementCount===1&&k.parentElement.classList.contains("protyle-wysiwyg")){const C=Lute.NewNodeID(),D=Nn(!1,!1,C);v.push({id:C,data:D.outerHTML,action:"insert",parentID:k.parentElement.getAttribute("data-node-id")||e.block.parentID}),A.push({id:C,action:"delete"}),k.before(D)}ir(k),w.append(k)}G(e,v,A)}else if(u.toString()!==""&&E.isSameNode(u.endContainer)&&u.startContainer.nodeType===3&&u.endOffset===u.endContainer.textContent.length&&u.startOffset===0&&!["DIV","TD","TH","TR"].includes(u.startContainer.parentElement.tagName))w.append(u.startContainer.parentElement);else if(f)w.append(f);else if(u.startContainer.nodeType===3&&u.startContainer.parentElement.tagName==="SPAN"&&u.startContainer.parentElement.getAttribute("data-type")&&u.startContainer.parentElement.isSameNode(u.endContainer.parentElement)){const v=u.startContainer.parentElement,A=v.attributes,C=document.createElement("span");for(let D=0;D<A.length;D++)C.setAttribute(A[D].name,A[D].value);v.getAttribute("data-type").indexOf("block-ref")>-1&&v.getAttribute("data-subtype")==="d"&&(C.setAttribute("data-subtype","s"),v.setAttribute("data-subtype","s")),C.textContent=u.toString(),u.deleteContents(),w.append(C)}else if(u.cloneContents().querySelectorAll("td, th").length>0){const v=document.createElement("wbr");u.insertNode(v),u.setStartAfter(v),w.append(u.extractContents()),d.outerHTML=e.lute.SpinBlockDOM(d.outerHTML),d=e.wysiwyg.element.querySelector(`[data-node-id="${b}"]`),_e(d,u)}else{const v=S(u.commonAncestorContainer,"data-type","inline-math");if(v)w.append(v);else{w.append(u.extractContents());let A;d.classList.contains("table")?A=te(u.startContainer,"TD")||te(u.startContainer,"TH"):A=J(d),A&&Array.from(A.children).forEach(C=>{C.textContent===""&&C.nodeType===1&&!["BR","IMG"].includes(C.tagName)&&C.remove()})}}if(this.emojiToMd(w),h=w.innerHTML,!d.classList.contains("table")){const v=J(d);v&&v.textContent===""&&(v.innerHTML="")}d.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),d.getAttribute("data-type")==="NodeCodeBlock"&&(u.insertNode(document.createElement("wbr")),J(d).removeAttribute("data-render"),Ze(d)),d.parentElement.parentElement&&!L&&ie(e,b,d.outerHTML,y)}e.hint.render(e);let m=e.lute.BlockDOM2StdMd(h).trimEnd();m=m.replace(/\u00A0/g," "),l.clipboardData.setData("text/plain",m),l.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(h)),l.clipboardData.setData("text/siyuan",h)});let t;this.element.addEventListener("contextmenu",l=>{var r,c,u,d;if(l.shiftKey)return;l.stopPropagation(),l.preventDefault();const f=l.clientX||l.detail.x,g=l.clientY||l.detail.y,h=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(h.length>1){ne(["util"],e),e.gutter.renderMenu(e,h[0]),window.siyuan.menus.menu.popup({x:f,y:g});return}const m=l.detail.target||l.target,b=S(m,"data-type","NodeBlockQueryEmbed");if(b)return getSelection().rangeCount===0&&ir(b),e.gutter.renderMenu(e,b),window.siyuan.menus.menu.popup({x:f,y:g}),!1;if(e.toolbar.range=he(e.element),m.tagName==="SPAN"){let E=e.toolbar.getCurrentType(e.toolbar.range);if(E.length===0&&(E=(m.dataset.type||"").split(" ")),E.length>0&&sp(m),E.includes("block-ref"))return Qc(e,m),m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620),!1;if(E.includes("file-annotation-ref")&&!e.disabled)return Jc(e,m),!1;if(E.includes("tag")&&!e.disabled)return nd(e,m),!1;if(E.includes("inline-memo"))return e.toolbar.showRender(e,m),!1;if(E.includes("a")&&!e.disabled)return js(e,m),window.siyuan.config.editor.floatWindowMode===0&&((r=m.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620)),!1}if(!e.disabled&&m.tagName==="IMG"&&$(m,"img"))return td(e,e.toolbar.range,m.parentElement.parentElement,{clientX:f+4,clientY:g}),!1;const y=M(m),w=$(m,"av__row");if(w&&Nc(e,w,{x:l.clientX,y:w.getBoundingClientRect().bottom,h:w.clientHeight})){l.stopPropagation(),l.preventDefault();return}if(!y)return!1;!Me(y)&&!y.classList.contains("protyle-wysiwyg--select")&&!$(m,"protyle-action")&&((0,T.tq)()||l.detail.target||t&&y.contains(t.startContainer))?(!(0,T.tq)()||(c=e.toolbar)!=null&&c.element.classList.contains("fn__none"))&&!y.classList.contains("av")&&(Yw(e,y),window.siyuan.menus.menu.popup({x:f,y:g+13,h:26}),(u=e.toolbar)==null||u.element.classList.add("fn__none"),y.classList.contains("table")&&y.querySelector(".table__select").removeAttribute("style")):e.toolbar.range.toString()===""&&(ne(["util"],e),e.gutter&&e.gutter.renderMenu(e,y),window.siyuan.menus.menu.popup({x:f,y:g}),(d=e.toolbar)==null||d.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?t=getSelection().getRangeAt(0):t=void 0});let a=!1;this.element.addEventListener("mousewheel",l=>{if(!a&&l.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(_("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{a=!1,dt({data:c,protyle:e,action:[p.Constants.CB_GET_BEFORE,p.Constants.CB_GET_UNCHANGEID]})}),a=!0),l.deltaX===0)return;const r=$(l.target,"table");if(r){const c=r.querySelector(".table__select");c!=null&&c.style.width&&(c.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0});let i=!1;this.element.addEventListener("mouseover",l=>{const r=$(l.target,"protyle-attr");if(r){i=!0,r.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const u=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");u&&u.classList.remove("protyle-wysiwyg--hl"),i=!1}if($(l.target,"protyle-action")||!e.options.render.gutter)return;const c=M(l.target);if(!(c&&(c.classList.contains("list")||c.classList.contains("li")))&&c){const u=S(c,"data-type","NodeBlockQueryEmbed");u?e.gutter.render(e,u,this.element):e.gutter.render(e,c,this.element)}}),this.element.addEventListener("paste",l=>{if(e.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"){l.stopPropagation();return}Of(e,l)});let s=!1;this.element.addEventListener("compositionstart",l=>{const r=he(e.wysiwyg.element),c=M(r.startContainer);c&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove()),s=!0,l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),s=!1;const r=he(this.element),c=M(r.startContainer);if(!(c&&c.getAttribute("data-type")==="NodeHTMLBlock")&&c)if(l.data!=="")this.escapeInline(e,r,l),jd(e,c,r,!0);else{const u=c.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[u]&&ie(e,u,c.outerHTML,e.wysiwyg.lastHTMLs[u])}});let o;this.element.addEventListener("input",l=>{const r=l.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const c=he(this.element),u=M(c.startContainer);if(u){if(u&&u.getAttribute("data-type")==="NodeHTMLBlock"){l.stopPropagation();return}[":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(l.data)&&(e.hint.enableExtend=!0),!(l.isComposing||s||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(e,c,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"||l.data==="\u300C"?(clearTimeout(o),o=window.setTimeout(()=>{jd(e,u,c,!0)})):jd(e,u,c,!0),l.stopPropagation())}}),this.element.addEventListener("keyup",l=>{const r=he(this.element).cloneRange(),c=M(r.startContainer);if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Alt"&&l.key!=="Shift"&&l.key!=="CapsLock"&&l.key!=="Escape"&&l.key!=="Meta"&&!/^F\d{1,2}$/.test(l.key)&&(!l.isComposing||l.isComposing&&r.toString()!=="")){r.toString()===""&&c&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove());return}if(!this.preventKeyup&&((l.shiftKey||ye(l))&&!l.isComposing&&r.toString()!==""&&(e.toolbar.render(e,r,l),cs(r)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing&&(c&&(this.setEmptyOutline(e,c),r.toString()===""&&cs(r,e.block.rootID)),l.stopPropagation()),(l.key==="ArrowLeft"||l.key==="ArrowRight"||l.key==="Alt"||l.key==="Shift")&&c&&!c.classList.contains("protyle-wysiwyg--select"))){const u=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;u.find(f=>{if(f.contains(r.startContainer))return d=!0,!0}),!d&&u.length>0&&(u.forEach(f=>{f.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){Sf(l.target.src,e.block.rootID);return}}),this.element.addEventListener("click",l=>{e.app.plugins.forEach(x=>{x.eventBus.emit("click-editorcontent",{protyle:e,event:l})}),ne(["hint","util"],e);const r=l.metaKey||l.ctrlKey,c=$(l.target,"protyle-breadcrumb__item");if(c){const x=c.getAttribute("data-id");x?r?_("/api/block/checkBlockFold",{id:x},P=>{be({app:e.app,id:x,action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:P.data})}):Zw(e,c):Xw(c),l.stopPropagation();return}l.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(e,l.target);const u=$(l.target,"table");this.element.querySelectorAll(".table").forEach(x=>{(!u||!x.isSameNode(u))&&x.querySelector(".table__select").removeAttribute("style"),u&&u.isSameNode(x)&&x.querySelector(".table__select").getAttribute("style")&&l.stopPropagation()}),e.options.render.breadcrumb&&e.breadcrumb.render(e);const d=he(this.element),f=S(l.target,"data-type","block-ref"),g=S(l.target,"data-type","a")||S(l.target,"data-type","url");let h="";if(g&&(g.classList.contains("av__celltext")?h=g.textContent.trim():h=g.getAttribute("data-href")),f||h.startsWith("siyuan://blocks/")){if(l.stopPropagation(),l.preventDefault(),ne(["dialog","toolbar"],e),d.toString()!==""&&!l.shiftKey)return;let x;if(f?x=f.getAttribute("data-id"):g&&(x=h.substring(16,38)),_("/api/block/checkBlockFold",{id:x},P=>{if(g){window.open(h);return}l.shiftKey?be({app:e.app,id:x,position:"bottom",action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:P.data}):l.altKey?be({app:e.app,id:x,position:"right",action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:P.data}):be(r?{app:e.app,id:x,action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:P.data}:{app:e.app,id:x,action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:P.data})}),e.model){let P;f?P=M(f):g&&(P=M(g)),P&&Wn(e,he(this.element),P)}return}const m=S(l.target,"data-type","file-annotation-ref");if(m&&d.toString()===""){l.stopPropagation(),l.preventDefault();const x=m.getAttribute("data-id").split("/"),P=`assets/${x[1]}`;r?is(P,"folder"):l.shiftKey?is(P,"app"):as(e.app,P,x[2],"right");return}if(g&&!l.altKey){l.stopPropagation(),l.preventDefault();const x=Lute.UnEscapeHTMLStr(h);if(go(x)){const P=x.split("?page")[0];p.Constants.SIYUAN_ASSETS_EXTS.includes(xe().extname(P))&&(!P.endsWith(".pdf")||P.endsWith(".pdf")&&!x.startsWith("file://"))?r?is(x,"folder"):l.shiftKey?is(x,"app"):as(e.app,P,parseInt((0,T.on)("page",x)),"right"):z(x)}else z(x);return}const b=S(l.target,"data-type","tag");if(b&&!l.altKey){Hn(e.app,`#${b.textContent}#`,!r),ne(["dialog"]);return}const y=$(l.target,"protyle-wysiwyg__embed");if(y){const x=y.getAttribute("data-id");_("/api/block/checkBlockFold",{id:x},P=>{l.shiftKey?be({app:e.app,id:x,position:"bottom",action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:P.data}):l.altKey?be({app:e.app,id:x,position:"right",action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:P.data}):r?be({app:e.app,id:x,action:P.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:P.data,keepCursor:!0}):e.disabled||window.siyuan.blockPanels.push(new uo({app:e.app,targetElement:y,isBacklink:!1,nodeIds:[x]}))}),l.stopPropagation();return}if(im(l,e)||et(l.target,"protyle-action__copy"))return;const w=$(l.target,"protyle-action__edit");if(w&&!e.disabled){e.toolbar.showRender(e,w.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const E=$(l.target,"protyle-action__menu");if(E){e.gutter.renderMenu(e,E.parentElement.parentElement);const x=E.getBoundingClientRect();window.siyuan.menus.menu.popup({x:x.left,y:x.top,isLeft:!0}),l.stopPropagation(),l.preventDefault();return}const k=$(l.target,"protyle-action__reload");if(k){const x=S(k,"data-type","NodeBlockQueryEmbed");x&&(x.removeAttribute("data-render"),Ke(e,x)),l.stopPropagation(),l.preventDefault();return}const L=$(l.target,"protyle-action__language");if(L&&!e.disabled){e.toolbar.showCodeLanguage(e,L),l.stopPropagation(),l.preventDefault();return}const v=S(l.target,"data-subtype","math");if(!l.shiftKey&&!r&&v&&!e.disabled){e.toolbar.showRender(e,v),l.stopPropagation();return}const A=$(l.target,"protyle-action");if(A){if(A.parentElement.parentElement.getAttribute("data-type")==="img"&&!e.disabled)td(e,d,A.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY});else if(A.parentElement.classList.contains("li")){const P=A.parentElement.getAttribute("data-node-id");if(l.altKey&&!e.disabled){if(A.parentElement.parentElement.classList.contains("protyle-wysiwyg"))Vt(e,A.parentElement);else{let B=!0;const V=A.parentElement.parentElement.outerHTML;Array.from(A.parentElement.parentElement.children).find(X=>{if(X.classList.contains("li")&&X.getAttribute("fold")!=="1"&&X.childElementCount>3)return B=!1,!0}),Array.from(A.parentElement.parentElement.children).find(X=>{X.classList.contains("li")&&(B?X.removeAttribute("fold"):X.childElementCount>3&&X.setAttribute("fold","1"))}),ie(e,A.parentElement.parentElement.getAttribute("data-node-id"),A.parentElement.parentElement.outerHTML,V)}ne(["gutter"],e)}else if(l.shiftKey&&!e.disabled)ga(A.parentElement,"bookmark",e);else if(r)Yt({protyle:e,id:P});else if(A.classList.contains("protyle-action--task")){if(!e.disabled){const B=A.parentElement.outerHTML;A.parentElement.classList.contains("protyle-task--done")?(A.querySelector("use").setAttribute("xlink:href","#iconUncheck"),A.parentElement.classList.remove("protyle-task--done")):(A.querySelector("use").setAttribute("xlink:href","#iconCheck"),A.parentElement.classList.add("protyle-task--done")),A.parentElement.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(e,P,A.parentElement.outerHTML,B)}}else e.block.showAll&&e.block.id===P?ed(e,P):Yt({protyle:e,id:P})}l.stopPropagation();return}const C=$(l.target,"hr")||$(l.target,"iframe");if(!l.shiftKey&&!r&&C){C.classList.add("protyle-wysiwyg--select"),l.stopPropagation();return}const D=et(l.target,"img");if(!l.shiftKey&&!r&&D){D.classList.add("img--select"),d.setStartAfter(D),d.collapse(!0),ee(d),e.options.render.breadcrumb&&e.breadcrumb.render(e);return}if(!gw(e,l)){if(l.target.contains(this.element)&&this.element.lastElementChild&&!e.disabled){const x=this.element.lastElementChild.getBoundingClientRect();if(l.y>x.bottom){const P=J(Ee(this.element.lastElementChild));if(!P||this.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||this.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&J(P).innerHTML!==""){const B=Nn(!1,!1);this.element.insertAdjacentElement("beforeend",B),G(e,[{action:"insert",data:B.outerHTML,id:B.getAttribute("data-node-id"),previousID:B.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:B.getAttribute("data-node-id")}]);const V=J(B);d.selectNodeContents(V),d.collapse(!0),ee(d),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},p.Constants.TIMEOUT_TRANSITION)}else P&&(d.selectNodeContents(P),d.collapse(!1),ee(d))}}if(setTimeout(()=>{const x=he(this.element);x.toString().replace(p.Constants.ZWSP,"")!==""?e.toolbar.render(e,x):ne(["toolbar"],e),e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||cs(x,e.block.rootID),getSelection().rangeCount===0&&ee(x),Wn(e,x)},(0,T.tq)()||Rt()?520:0),e.hint.enableExtend=!1,l.shiftKey){l.preventDefault(),l.stopPropagation();let x=this.shiftStartElement,P=M(l.target);if(this.shiftStartElement&&P&&!this.shiftStartElement.isSameNode(P)){let B=!0;d.collapse(!0);const V=x.getBoundingClientRect(),X=P.getBoundingClientRect();let Q=V.top,ce=X.top;if(Q===ce&&(Q=V.left,ce=X.left),Q>ce){const It=P;P=x,x=It;const Ie=ce;ce=Q,Q=Ie,B=!1}let Pe=[],ge=x,de=!1;for(;ge;)if(ge&&!ge.classList.contains("protyle-attr")){const It=ge.getBoundingClientRect();if(V.top===X.top?It.left<=ce:It.top<=ce)if(de)if(ge.nextElementSibling&&!ge.nextElementSibling.classList.contains("protyle-attr")){const Ie=ge.nextElementSibling.getBoundingClientRect();if(V.top===X.top?Ie.left<=ce&&Ie.bottom<=X.bottom:Ie.top<=ce)Pe=[ge],ge=ge.nextElementSibling,de=!1;else if(ge.parentElement.classList.contains("sb"))ge=M(ge.parentElement),de=!0;else break}else ge=M(ge.parentElement),de=!0;else Pe.push(ge),ge=ge.nextElementSibling;else if(ge.parentElement.classList.contains("sb"))ge=M(ge.parentElement),de=!0;else break}else ge=M(ge.parentElement),de=!0;if(Pe.length===1&&!Pe[0].classList.contains("list")&&!Pe[0].classList.contains("bq")&&!Pe[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const It=[];!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&e.scroll&&!e.scroll.element.classList.contains("fn__none")&&!e.scroll.keepLazyLoad&&(x.getBoundingClientRect().top<-e.contentElement.clientHeight*2||P.getBoundingClientRect().bottom>e.contentElement.clientHeight*2)&&q(window.siyuan.languages.crossKeepLazyLoad),Pe.forEach(Ie=>{Ie.classList.add("protyle-wysiwyg--select"),It.push(Ie.getAttribute("data-node-id")),Ie.querySelectorAll(".protyle-wysiwyg--select").forEach(Pn=>{Pn.classList.remove("protyle-wysiwyg--select")})}),zt(It),we(B?Pe[Pe.length-1]:Pe[0],e.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&d.toString()!==""&&(d.collapse(!1),ee(d)),r&&d.toString()===""){let x=M(l.target);if(x){x=Oe(x),x.classList.contains("protyle-wysiwyg--select")?(x.classList.remove("protyle-wysiwyg--select"),x.removeAttribute("select-start"),x.removeAttribute("select-end")):x.classList.add("protyle-wysiwyg--select"),x.querySelectorAll(".protyle-wysiwyg--select").forEach(V=>{V.classList.remove("protyle-wysiwyg--select"),V.removeAttribute("select-start"),V.removeAttribute("select-end")});const P=$(x.parentElement,"protyle-wysiwyg--select");P&&(P.classList.remove("protyle-wysiwyg--select"),P.removeAttribute("select-start"),P.removeAttribute("select-end"));const B=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(V=>{B.push(V.getAttribute("data-node-id"))}),zt(B)}}}})}}class Ov{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}var Rv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class qv extends Ki{constructor(e,t){super(e,t),this.element.addEventListener("click",a=>Rv(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!M(i.startContainer))return;const o=S(i.startContainer,"data-type","a");if(o){js(e,o);return}const l=i.toString().trim().replace(p.Constants.ZWSP,"");let r="",c="";try{const u=yield R();if(e.lute.IsValidLinkDest(l))r=l;else if(e.lute.IsValidLinkDest(u))r=u;else{const d=u.lastIndexOf(" ");d>-1&&e.lute.IsValidLinkDest(u.substring(d))&&(r=u.substring(d),c=u.substring(0,d))}}catch(u){console.log(u)}e.toolbar.setInlineMark(e,"a","range",{type:"a",color:r+(c?p.Constants.ZWSP+c:"")})}))}}class Fv extends Ki{constructor(e,t){super(e,t),this.element.addEventListener("click",a=>{e.toolbar.range.toString()!==""&&(Yd(e.toolbar.range),ii(e.toolbar.range.toString(),e,"search"),e.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var Uv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class Vv extends Ki{constructor(e,t){super(e,t),this.element.addEventListener("click",a=>Uv(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!M(i.startContainer))return;let o=S(i.startContainer,"data-type","inline-math");if(!o&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const l=ot(i.startContainer.childNodes[i.startOffset]);l&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let l=!0,r=!1;if(i.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:l=!1}),l&&r){const c=rt(i.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)o=c;else{const u=ot(i.startContainer);i.startOffset===0&&u&&u.nodeType!==3&&u.getAttribute("data-type").indexOf("inline-math")>-1&&(o=u)}}}if(o){e.toolbar.showRender(e,o);return}e.toolbar.setInlineMark(e,"inline-math","range",{type:"inline-math"})}))}}var zv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class Wv extends Ki{constructor(e,t){super(e,t),this.element.addEventListener("click",a=>zv(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!M(i.startContainer))return;const o=S(i.startContainer,"data-type","inline-memo");if(o&&o.textContent===i.toString()){e.toolbar.showRender(e,o);return}i.toString()!==""&&e.toolbar.setInlineMark(e,"inline-memo","range",{type:"inline-memo"})}))}}var Yv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class Gv{constructor(e){const t=e.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none",this.toolbarHeight=29,t.toolbar.forEach(i=>{const s=this.genItem(e,i);this.element.appendChild(s)})}render(e,t,a){this.range=t;let i=M(t.startContainer);if((0,T.tq)()||!i||e.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!0,o=!0;if(Array.from(t.cloneContents().childNodes).find(f=>{if(f.nodeType!==1){if(f.textContent.length>0)return o=!1,!0}else if(!f.classList.contains("img"))return s=!1,!0}),s&&o||t.commonAncestorContainer.nodeType!==3&&t.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const l=M(t.startContainer),r=M(t.endContainer);if(l&&r&&!l.isSameNode(r)){if(a)if(a.key==="ArrowLeft")this.range=Xt(J(l),t,!1);else if(a.key==="ArrowRight")this.range=ar(J(r),t),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=ar(J(r),t),i=M(r),!i)return}else a.key==="ArrowDown"&&(this.range=Xt(J(l),t,!1));else this.range=Xt(J(i),t,!1);if(ee(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const c=Cn(i,t);this.element.classList.remove("fn__none");const u=c.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",u+p.Constants.ZWSP+e.contentElement.scrollTop.toString()),Ve(this.element,c.left-52,u),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(f=>{f.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(f=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(f))return;const g=this.element.querySelector(`[data-type="${f}"]`);g&&g.classList.add("protyle-toolbar__item--current")})}getCurrentType(e=this.range){var t,a;let i=[],s=e.startContainer;if(s.nodeType===3?s=s.parentElement:s.childElementCount>0&&((t=s.childNodes[e.startOffset])==null?void 0:t.nodeType)!==3&&(s=s.childNodes[e.startOffset]),!s||s.nodeType===3)return[];["DIV","TD","TH","TR"].includes(s.tagName)||(i=(s.getAttribute("data-type")||"").split(" "));let o=e.endContainer;return o.nodeType===3?o=o.parentElement:o.childElementCount>0&&((a=o.childNodes[e.endOffset])==null?void 0:a.nodeType)!==3&&(o=o.childNodes[e.endOffset]),!o||o.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(o.tagName)&&!s.isSameNode(o)&&(i=i.concat((o.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach(l=>{l.nodeType!==3&&(i=i.concat((l.getAttribute("data-type")||"").split(" ")))}),i=[...new Set(i)],i.find((l,r)=>{if(l==="")return i.splice(r,1),!0}),i)}genItem(e,t){let a;switch(t.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new Ki(e,t);break;case"block-ref":a=new Fv(e,t);break;case"inline-math":a=new Vv(e,t);break;case"inline-memo":a=new Wv(e,t);break;case"|":a=new Ov;break;case"text":a=new Ow(e,t);break;case"a":a=new qv(e,t);break}if(a)return a.element}mergeNode(e){for(let t=0;t<e.length;t++)e[t].nodeType!==3&&e[t].tagName==="WBR"&&(e[t].remove(),t--);for(let t=0;t<e.length;t++)e[t].nodeType===3&&(e[t].textContent===""?(e[t].remove(),t--):e[t+1]&&e[t+1].nodeType===3&&(e[t].textContent=e[t].textContent+e[t+1].textContent,e[t+1].remove(),t--))}setInlineMark(e,t,a,i){var s;const o=M(this.range.startContainer);if(!o)return;const l=M(this.range.endContainer);if(!l)return;o.isSameNode(l)||(this.range=Xt(J(o),this.range,!1));const r=this.getCurrentType(this.range),c=this.range.toString();Yd(this.range);let u,d,f,g;const h=ot(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?h&&h.nodeType!==3&&this.range.startOffset===0&&(u=h):this.range.startOffset===0&&!h?(u=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):u=this.range.startContainer.parentElement;let m=!1;const b=rt(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?b&&b.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(d=b):this.range.endOffset===this.range.endContainer.textContent.length&&!b?(d=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),c===""&&(m=!0,this.range.collapse(!1))):d=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const y=o.outerHTML,w=this.range.extractContents();if(this.mergeNode(w.childNodes),u&&d&&u.isSameNode(d)&&((s=w.firstChild)==null?void 0:s.nodeType)===3){const C=u.attributes;w.childNodes.forEach(D=>{const x=document.createElement("span");for(let P=0;P<C.length;P++)x.setAttribute(C[P].name,C[P].value);x.innerHTML=D.textContent,D.replaceWith(x)})}const E=(0,T.tq)()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,k=a==="toolbar"?E.querySelector(`[data-type="${t}"]`):void 0,L=[];if(t==="clear"||k!=null&&k.classList.contains("protyle-toolbar__item--current")||a==="range"&&r.length>0&&r.includes(t)&&!i){if(t==="clear"?E.querySelectorAll('[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="strong"]').forEach(C=>{C.classList.remove("protyle-toolbar__item--current")}):k&&k.classList.remove("protyle-toolbar__item--current"),w.childNodes.length===0)if(r.find((C,D)=>{if(t===C)return r.splice(D,1),!0}),r.length===0||t==="clear")L.push(document.createTextNode(p.Constants.ZWSP));else{let C=0;for(;C<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[C])?r.splice(C,1):++C;const D=document.createElement("span");D.setAttribute("data-type",r.join(" ")),D.textContent=p.Constants.ZWSP,L.push(D)}w.childNodes.forEach((C,D)=>{if(C.nodeType!==3&&C.tagName!=="BR"&&C.tagName!=="IMG"){const x=(C.getAttribute("data-type")||"").split(" ");if(t==="clear")for(let P=0;P<x.length;P++)i&&i.type==="text"?x[P]==="text"&&(x.splice(P,1),P--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(x[P])&&(x.splice(P,1),P--);else x.find((P,B)=>{if(t===P)return x.splice(B,1),!0});if(x.length===0)C.textContent===""&&(C.textContent=p.Constants.ZWSP),L.push(document.createTextNode(C.textContent));else{if(c&&t==="clear"&&i&&i.type==="text"&&C.style.color===""&&C.style.webkitTextFillColor===""&&C.style.webkitTextStroke===""&&C.style.textShadow===""&&C.style.backgroundColor===""&&C.style.fontSize==="")return C.setAttribute("data-type",x.join(" ")),L.push(C),!0;t==="clear"&&(C.style.color="",C.style.webkitTextFillColor="",C.style.webkitTextStroke="",C.style.textShadow="",C.style.backgroundColor="",C.style.fontSize=""),D===0&&u&&u.nodeType!==3&&(0,T.qP)(x,(u.getAttribute("data-type")||"").split(" "))&&Zi(C,u,i)?(f=u.textContent.length,u.innerHTML=u.innerHTML+C.innerHTML):D===w.childNodes.length-1&&d&&d.nodeType!==3&&(0,T.qP)(x,(d.getAttribute("data-type")||"").split(" "))&&Zi(C,d,i)?(g=C.textContent.length,d.innerHTML=C.innerHTML+d.innerHTML):(C.setAttribute("data-type",x.join(" ")),L.push(C))}}else L.push(C)})}else if(!this.element.classList.contains("fn__none")&&t!=="text"&&k&&k.classList.add("protyle-toolbar__item--current"),c===""){const C=document.createElement("span");if(r.push(t),m){let D=0;for(;D<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[D])?r.splice(D,1):++D}C.setAttribute("data-type",[...new Set(r)].join(" ")),C.textContent=p.Constants.ZWSP,Gc(C,i),L.push(C)}else{if(t==="block-ref")for(;w.childNodes.length>1;)w.childNodes[0].remove();w.childNodes.forEach((C,D)=>{var x,P;if(C.nodeType===3)if(D===0&&u&&u.nodeType!==3&&t===u.getAttribute("data-type")&&Zi(C,u,i))f=u.textContent.length,u.innerHTML=u.innerHTML+C.textContent;else if(D===w.childNodes.length-1&&d&&d.nodeType!==3&&t===d.getAttribute("data-type")&&Zi(C,d,i))g=C.textContent.length,d.innerHTML=C.textContent+d.innerHTML;else{const B=document.createElement("span");B.setAttribute("data-type",t),B.textContent=C.textContent,Gc(B,i),L.push(B)}else{let B=(C.getAttribute("data-type")||"").split(" ");for(let V=0;V<B.length;V++)["backslash","virtual-block-ref","search-mark"].includes(B[V])&&(B.splice(V,1),V--);B.push(t),t==="sub"&&B.includes("sup")?B.find((V,X)=>{if(V==="sup")return B.splice(X,1),E.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):t==="sup"&&B.includes("sub")?B.find((V,X)=>{if(V==="sub")return B.splice(X,1),E.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):t==="block-ref"&&(B.includes("a")||B.includes("file-annotation-ref"))?B.find((V,X)=>{if(V==="a"||V==="file-annotation-ref")return B.splice(X,1),!0}):t==="a"&&(B.includes("block-ref")||B.includes("file-annotation-ref"))?B.find((V,X)=>{if(V==="block-ref"||V==="file-annotation-ref")return B.splice(X,1),!0}):t==="file-annotation-ref"&&(B.includes("block-ref")||B.includes("a"))?B.find((V,X)=>{if(V==="block-ref"||V==="a")return B.splice(X,1),!0}):t==="inline-memo"&&B.includes("inline-math")?(B.find((V,X)=>{if(V==="inline-math")return B.splice(X,1),!0}),C.textContent=C.getAttribute("data-content")):t==="inline-math"&&B.includes("inline-memo")&&B.find((V,X)=>{if(V==="inline-memo")return B.splice(X,1),!0}),B=[...new Set(B)],D===0&&u&&u.nodeType!==3&&(0,T.qP)(B,(u.getAttribute("data-type")||"").split(" "))&&Zi(C,u,i)?(f=u.textContent.length,u.innerHTML=u.innerHTML+C.innerHTML):D===w.childNodes.length-1&&d&&d.nodeType!==3&&(0,T.qP)(B,(d.getAttribute("data-type")||"").split(" "))&&Zi(C,d,i)?(g=C.textContent.length,d.innerHTML=C.innerHTML+d.innerHTML):(C.tagName!=="BR"&&C.tagName!=="IMG"&&(((x=C.getAttribute("data-type"))==null?void 0:x.indexOf("backslash"))>-1&&((P=C.firstChild)==null?void 0:P.textContent)==="\\"&&C.firstChild.remove(),C.setAttribute("data-type",B.join(" ")),Gc(C,i)),L.push(C))}})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!m){const C=this.range.startContainer,D=document.createElement("span"),x=C.attributes;for(let P=0;P<x.length;P++)D.setAttribute(x[P].name,x[P].value);this.range.setEnd(C.lastChild,C.lastChild.textContent.length),D.append(this.range.extractContents()),C.after(D),this.range.setStartBefore(D),this.range.collapse(!0)}for(let C=0;C<L.length;C++){const D=L[C],x=L[C+1];if(D.nodeType!==3&&x&&x.nodeType!==3&&x.tagName===D.tagName&&(0,T.qP)((x.getAttribute("data-type")||"").split(" "),(D.getAttribute("data-type")||"").split(" "))&&D.getAttribute("data-id")===x.getAttribute("data-id")&&D.getAttribute("data-subtype")===x.getAttribute("data-subtype")&&D.style.color===x.style.color&&D.style.webkitTextFillColor===x.style.webkitTextFillColor&&D.style.webkitTextStroke===x.style.webkitTextStroke&&D.style.textShadow===x.style.textShadow&&D.style.fontSize===x.style.fontSize&&D.style.backgroundColor===x.style.backgroundColor){const P=D.getAttribute("data-type");P.indexOf("inline-math")>-1?x.setAttribute("data-content",D.getAttribute("data-content")+x.getAttribute("data-content")):(x.innerHTML=D.innerHTML+x.innerHTML,P.indexOf("inline-memo")>-1&&x.setAttribute("data-inline-memo-content",(D.getAttribute("data-inline-memo-content")||"")+(x.getAttribute("data-inline-memo-content")||""))),L.splice(C,1),C--}else{if(this.range.insertNode(D),D.nodeType!==3&&["code","tag","kbd"].includes(t)){const P=ot(D);(!P||P.textContent.endsWith(`
`))&&D.before(document.createTextNode(p.Constants.ZWSP)),D.textContent.startsWith(p.Constants.ZWSP)||(D.textContent=p.Constants.ZWSP+D.textContent);const B=rt(D);(!B||B&&(B.nodeType!==3||B.nodeType===3&&!B.textContent.startsWith(p.Constants.ZWSP)))&&D.after(document.createTextNode(p.Constants.ZWSP))}this.range.collapse(!1)}}if(u&&(u.nodeType!==3&&u.textContent===p.Constants.ZWSP?u.remove():this.mergeNode(u.childNodes)),d&&this.mergeNode(d.childNodes),f?this.range.setStart(u.firstChild,f):L.length>0?L[0].nodeType!==3&&L[0].getAttribute("data-type")==="inline-math"||(L[0].firstChild?L[0].firstChild.textContent===p.Constants.ZWSP?this.range.setStart(L[0].firstChild,1):this.range.setStart(L[0].firstChild,0):L[0].nodeType===3?this.range.setStart(L[0],0):this.range.setStartBefore(L[0])):d&&this.range.setStart(d.firstChild,0),g)this.range.setEnd(d.lastChild,g);else if(L.length>0){const C=L[L.length-1];if(C.nodeType!==3&&C.getAttribute("data-type").indexOf("inline-math")>-1){const D=ot(C);D&&D.nodeType===3?this.range.setStart(D,D.textContent.length):this.range.setStartBefore(C);const x=rt(C);x&&x.nodeType===3?this.range.setEnd(x,0):this.range.setEndAfter(C)}else C.lastChild?C.lastChild.textContent===p.Constants.ZWSP?this.range.collapse(!0):this.range.setEnd(C.lastChild,C.lastChild.textContent.length):C.nodeType===3?(this.range.setEnd(C,C.textContent.length),C.textContent===p.Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(C)}else u&&this.range.setEnd(u.firstChild,u.firstChild.textContent.length);let v=!0;if(t==="inline-math"){if(ra(o),c===""){e.toolbar.showRender(e,L[0],void 0,y);return}}else if(t==="inline-memo"){e.toolbar.showRender(e,L[0],L,y);return}else if(t==="block-ref")this.range.collapse(!1);else if(t==="a"){const C=L[0];C.textContent.replace(p.Constants.ZWSP,"")===""||!C.getAttribute("data-href")?(v=!1,js(e,C,!!C.getAttribute("data-href"))):this.range.collapse(!1)}o.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(e,o.getAttribute("data-node-id"),o.outerHTML,y);const A=o.querySelector("wbr");A&&A.remove(),v&&ee(this.range)}showRender(e,t,a,i){var s;const o=M(t);if(!o)return;ne(["hint"],e),window.siyuan.menus.menu.remove();const l=o.getAttribute("data-node-id"),r=(t.getAttribute("data-type")||"").split(" "),c=i||e.lute.SpinBlockDOM(o.outerHTML);let u="HTML",d="";const f=r.includes("inline-memo");switch(t.getAttribute("data-subtype")){case"abc":u=window.siyuan.languages.staff;break;case"echarts":u=window.siyuan.languages.chart;break;case"flowchart":u="Flow Chart";break;case"graphviz":u="Graphviz";break;case"mermaid":u="Mermaid";break;case"mindmap":d=`- foo
  - bar
- baz`,u=window.siyuan.languages.mindmap;break;case"plantuml":u="UML";break;case"math":r.includes("NodeMathBlock")?u=window.siyuan.languages.math:u=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?u=window.siyuan.languages.blockEmbed:f&&(u=window.siyuan.languages.memo);const g=(s=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:s.classList.contains("block__icon--active"),h={};if(g){const k=this.subElement.querySelector(".b3-text-field");h.styleH=k.style.height,h.styleW=k.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${g&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${u}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${g?" block__icon--active":""}" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${e.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${d}" style="${(0,T.tq)()?"":"width:"+Math.max(480,t.clientWidth*.7)+"px"};max-height:50vh;min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const m=()=>{if(w.style.height=w.scrollHeight+"px",(0,T.tq)()){Ve(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){w.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const k=E.bottom===E.top?E.bottom+26:E.bottom;this.subElement.clientHeight<=window.innerHeight-k||this.subElement.clientHeight<=E.top?r.includes("inline-math")||f?Ve(this.subElement,E.left,k,E.height||26):Ve(this.subElement,E.left+(E.width-this.subElement.clientWidth)/2,k,E.height||26):Ve(this.subElement,E.right,k)},b=this.subElement.querySelector(".block__icons");b.addEventListener("click",k=>{const L=k.target,v=$(L,"b3-tooltips");if(!v){if(k.detail===2){const A=b.querySelector('[data-type="pin"]');A.classList.contains("block__icon--active")?(A.classList.remove("block__icon--active"),A.setAttribute("aria-label",window.siyuan.languages.pin)):(A.classList.add("block__icon--active"),A.setAttribute("aria-label",window.siyuan.languages.unpin)),k.preventDefault(),k.stopPropagation()}return}switch(k.stopPropagation(),v.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),ne(["util"],e);break;case"pin":v.classList.contains("block__icon--active")?(v.classList.remove("block__icon--active"),v.setAttribute("aria-label",window.siyuan.languages.pin)):(v.classList.add("block__icon--active"),v.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":v.classList.toggle("block__icon--active");break;case"before":rn(e,"beforebegin",l),ne(["util"],e);break;case"after":rn(e,"afterend",l),ne(["util"],e);break;case"export":y();break}});const y=()=>{const k=q(window.siyuan.languages.exporting,0);if(t.getAttribute("data-subtype")==="plantuml"){fetch(t.querySelector("img").getAttribute("src")).then(function(L){return L.blob()}).then(function(L){const v=new FormData;v.append("file",L),v.append("type","image/png"),_("/api/export/exportAsFile",v,A=>{z(A.data.file),j(k)})});return}setTimeout(()=>{(0,vt.addScript)("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(t,{useCORS:!0}).then(L=>{L.toBlob(v=>{const A=new FormData;A.append("file",v),A.append("type","image/png"),_("/api/export/exportAsFile",A,C=>{z(C.data.file),j(k)})})})})},p.Constants.TIMEOUT_LOAD)};me(this.subElement,()=>{const k=b.querySelector('[data-type="pin"]');k.classList.add("block__icon--active"),k.setAttribute("aria-label",window.siyuan.languages.unpin),this.subElement.firstElementChild.setAttribute("data-drag","true")});const w=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?w.value=Lute.UnEscapeHTMLStr(t.querySelector("protyle-html").getAttribute("data-content")||""):f?w.value=Lute.UnEscapeHTMLStr(t.getAttribute("data-inline-memo-content")||""):w.value=Lute.UnEscapeHTMLStr(t.getAttribute("data-content")||""),w.addEventListener("input",k=>{if(t.parentElement&&(w.clientHeight!==w.scrollHeight&&m(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))t.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(w.value));else if(f){let L;a?L=a:L=[t],L.forEach(v=>{v.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(w.value))})}else t.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),t.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!f)&&yt(t),k.stopPropagation()}}),w.addEventListener("keydown",k=>{if(k.stopPropagation(),U(window.siyuan.config.keymap.editor.insert["inline-math"].custom,k)){k.preventDefault();return}if(!k.isComposing){if(k.key==="Escape"||U("\u2318\u21A9",k))this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),ne(["util"],e);else if(k.key==="Tab")document.execCommand("insertText",!1,"	"),k.preventDefault();else if(Ma(k))return}}),this.subElementCloseCB=()=>{var k;if(!t.parentElement||e.disabled)return;let L;if(r.includes("NodeHTMLBlock")){let A=w.value;A&&(A=A.trim().replace(/\n+/g,`
`),A.startsWith("<div>")&&A.endsWith("</div>")||(A=`<div>
${A}
</div>`)),t.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(A))}else if(f){let A;a?A=a:A=[t],A.forEach((C,D)=>{if(w.value)C.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(w.value.replace(/\n/g," ")));else{const x=C.getAttribute("data-type").split(" ");x.length===1&&x[0]==="inline-memo"?C.outerHTML=C.innerHTML+(D===A.length-1?"<wbr>":""):(x.find((P,B)=>{if(P==="inline-memo")return x.splice(B,1),!0}),C.setAttribute("data-type",x.join(" ")),C.removeAttribute("data-inline-memo-content")),D===A.length-1&&(L=C)}})}else r.includes("inline-math")?w.value?(t.setAttribute("data-content",Lute.EscapeHTMLStr(w.value.replace(/\n/g,""))),t.removeAttribute("data-render"),yt(t)):(L=t,t.outerHTML="<wbr>"):(t.setAttribute("data-content",Lute.EscapeHTMLStr(w.value)),t.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?Ke(e,t):yt(t));getSelection().rangeCount===0||getSelection().rangeCount>0&&$(getSelection().getRangeAt(0).startContainer,"protyle-util")?t.tagName==="SPAN"?L?L.parentElement?(this.range.setStartAfter(L),this.range.collapse(!0),ee(this.range)):_e(o,this.range):t.parentElement&&(this.range.setStartAfter(t),this.range.collapse(!0),ee(this.range)):(we(t),t.classList.add("protyle-wysiwyg--select")):(k=o.querySelector("wbr"))==null||k.remove(),o.setAttribute("updated",ue().format("YYYYMMDDHHmmss"));const v=e.lute.SpinBlockDOM(o.outerHTML);if(r.includes("NodeHTMLBlock")){const A=document.createElement("template");A.innerHTML=v,A.content.childElementCount>1&&q(window.siyuan.languages.htmlBlockTip)}ie(e,l,v,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const E=t.getBoundingClientRect();this.element.classList.add("fn__none"),g?(w.style.width=h.styleW,w.style.height=h.styleH):m(),e.disabled||w.select(),e.app.plugins.forEach(k=>{k.eventBus.emit("open-noneditableblock",{protyle:e,toolbar:this})})}showCodeLanguage(e,t){var a,i;const s=M(t);if(!s)return;ne(["hint"],e),window.siyuan.menus.menu.remove(),this.range=he(s);const o=s.getAttribute("data-node-id");let l=s.outerHTML,r=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const c=p.Constants.ALIAS_CODE_LANGUAGES.concat((i=(a=window.hljs)==null?void 0:a.listLanguages())!=null?i:[]).sort();c.forEach((g,h)=>{r+=`<div class="b3-list-item${h===0?" b3-list-item--focus":""}">${g}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${r}</div>
</div>`;const u=this.subElement.lastElementChild.lastElementChild,d=this.subElement.querySelector("input");d.addEventListener("keydown",g=>{if(g.stopPropagation(),!g.isComposing){if(En(u,g),g.key==="Enter"){const h=this.subElement.querySelector(".b3-list-item--focus").textContent;t.textContent=h===window.siyuan.languages.clear?"":h,window.siyuan.storage[p.Constants.LOCAL_CODELANG]=t.textContent,Ue(p.Constants.LOCAL_CODELANG,window.siyuan.storage[p.Constants.LOCAL_CODELANG]);const m=J(s),b=s.getAttribute("linenumber");b==="true"||b!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?m.classList.add("protyle-linenumber"):m.classList.remove("protyle-linenumber"),m.textContent=m.textContent,m.removeAttribute("data-render"),Ze(s),s.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(e,o,s.outerHTML,l),l=s.outerHTML,g.preventDefault(),g.stopPropagation()}(g.key==="Escape"||g.key==="Enter")&&(this.subElement.classList.add("fn__none"),ee(this.range))}}),d.addEventListener("input",g=>{const h=d.value.toLowerCase(),m=c.filter(w=>w.includes(h));let b="",y=!1;m.sort((w,E)=>w.startsWith(h)&&E.startsWith(h)?w.length<E.length?-1:w.length===E.length?0:1:w.startsWith(h)?-1:E.startsWith(h)?1:0).forEach(w=>{d.value===w&&(y=!0),b+=`<div class="b3-list-item">${w.replace(h,"<b>"+h+"</b>")}</div>`}),d.value.trim()&&!y&&(b=`<div class="b3-list-item"><b>${d.value.replace(/`| /g,"_")}</b></div>${b}`),b=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+b,u.innerHTML=b,u.firstElementChild.nextElementSibling?u.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):u.firstElementChild.classList.add("b3-list-item--focus"),g.stopPropagation()}),u.addEventListener("click",g=>{const h=g.target,m=$(h,"b3-list-item");if(!m)return;t.textContent=m.textContent===window.siyuan.languages.clear?"":m.textContent,window.siyuan.storage[p.Constants.LOCAL_CODELANG]=t.textContent,Ue(p.Constants.LOCAL_CODELANG,window.siyuan.storage[p.Constants.LOCAL_CODELANG]);const b=M(t);if(b){const y=J(b),w=b.getAttribute("linenumber");w==="true"||w!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?y.classList.add("protyle-linenumber"):y.classList.remove("protyle-linenumber"),y.textContent=y.textContent,y.removeAttribute("data-render"),Ze(b),b.setAttribute("updated",ue().format("YYYYMMDDHHmmss")),ie(e,o,b.outerHTML,l),l=b.outerHTML,this.subElement.classList.add("fn__none"),ee(this.range)}}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0;const f=t.getBoundingClientRect();Ve(this.subElement,f.left,f.bottom,f.height),this.element.classList.add("fn__none"),d.select()}showTpl(e,t,a){this.range=a,ne(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${(0,T.tq)()?"width: 100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 520px;${(0,T.tq)()||window.outerWidth<window.outerWidth/2+520?"display:none":""};overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list"),s=this.subElement.firstElementChild.lastElementChild;let o=i.firstElementChild.getAttribute("data-value");Ji(o,s,e.block.parentID),i.addEventListener("mouseover",r=>{const c=r.target,u=$(c,"b3-list-item");if(!u)return;const d=u.getAttribute("data-value");o!==d&&(o=d,Ji(o,s,e.block.parentID))});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const u=En(i,r);if(u){const d=u.getAttribute("data-value");if(o===d)return;o=d,Ji(o,s,e.block.parentID)}}r.key==="Enter"?(c?ee(this.range):If(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,t),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),ee(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),_("/api/search/searchTemplate",{k:l.value},c=>{var u;let d="";c.data.blocks.forEach((g,h)=>{d+=`<div data-value="${g.path}" class="b3-list-item${h===0?" b3-list-item--focus":""}">${g.content}</div>`}),i.innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const f=(u=c.data.blocks[0])==null?void 0:u.path;o!==f&&(o=f,Ji(o,s,e.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),ee(this.range),r.stopPropagation();return}const u=$(c,"b3-list-item__action");if(u&&u.getAttribute("data-type")==="remove"){Ne(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{_("/api/search/removeTemplate",{path:u.parentElement.getAttribute("data-value")},()=>{if(u.parentElement.parentElement.childElementCount===1)u.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Ji("",s,e.block.parentID);else{if(u.parentElement.classList.contains("b3-list-item--focus")){const h=u.parentElement.previousElementSibling||u.parentElement.nextElementSibling;h.classList.add("b3-list-item--focus");const m=h.getAttribute("data-value");if(o===m)return;o=m,Ji(o,s,e.block.parentID)}u.parentElement.remove()}})}),r.stopPropagation();return}if(S(c,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(S(c,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const g=$(c,"b3-list-item");g&&(If(decodeURIComponent(g.getAttribute("data-value")),e,t),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),_("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((d,f)=>{c+=`<div data-value="${d.path}" class="b3-list-item--hide-action b3-list-item${f===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${d.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),c===""&&(c=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.querySelector(".b3-list--background").innerHTML=c;const u=Cn(t,a);Ve(this.subElement,u.left,u.top+18,p.Constants.SIZE_TOOLBAR_HEIGHT),this.subElement.firstElementChild.style.maxHeight=Math.min(window.innerHeight*.8,window.innerHeight-this.subElement.getBoundingClientRect().top)-16+"px"})}showWidget(e,t,a){this.range=a,ne(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",o=>{o.stopPropagation(),!o.isComposing&&(En(i,o),o.key==="Enter"?(Df(this.subElement.querySelector(".b3-list-item--focus").textContent,e),this.subElement.classList.add("fn__none"),o.preventDefault()):o.key==="Escape"&&(this.subElement.classList.add("fn__none"),ee(this.range)))}),s.addEventListener("input",o=>{o.stopPropagation(),_("/api/search/searchWidget",{k:s.value},l=>{let r="";l.data.blocks.forEach((c,u)=>{r+=`<div data-value="${c.path}" class="b3-list-item${u===0?" b3-list-item--focus":""}">${c.content}</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",o=>{const l=o.target,r=$(l,"b3-list-item");r&&Df(r.textContent,e)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),_("/api/search/searchWidget",{k:""},o=>{let l="";o.data.blocks.forEach((c,u)=>{l+=`<div class="b3-list-item${u===0?" b3-list-item--focus":""}">${c.content}</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l;const r=Cn(t,a);Ve(this.subElement,r.left,r.top+18,p.Constants.SIZE_TOOLBAR_HEIGHT)})}renderAssetList(e,t,a,i){_("/api/search/searchAsset",{k:a},s=>{let o="";s.data.forEach((l,r)=>{o+=`<div data-value="${l.path}" class="b3-list-item${r===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${l.hName}</div></div>`}),e.innerHTML=o||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,s.data.length>0&&(t.innerHTML=ai(s.data[0].path)),Ve(this.subElement,i.x,i.y,i.h,i.w)})}showAssets(e,t,a){ne(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${(0,T.tq)()?"width:100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 260px;display: ${(0,T.tq)()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list"),s=this.subElement.firstElementChild.lastElementChild;i.addEventListener("mouseover",l=>{const r=l.target,c=$(r,"b3-list-item");c&&(s.innerHTML=ai(c.getAttribute("data-value")))});const o=this.subElement.querySelector("input");o.addEventListener("keydown",l=>{if(l.stopPropagation(),l.isComposing)return;const r=this.subElement.querySelector(".b3-list--empty");if(!r){const c=En(i,l);c&&(s.innerHTML=ai(c.getAttribute("data-value")))}if(l.key==="Enter"){if(r)a||ee(this.range);else{const c=this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value");a?a(c):$f(c,e)}this.subElement.classList.add("fn__none"),l.preventDefault()}else l.key==="Escape"&&(this.subElement.classList.add("fn__none"),a||ee(this.range))}),o.addEventListener("input",l=>{l.stopPropagation(),this.renderAssetList(i,s,o.value,t)}),this.subElement.lastElementChild.addEventListener("click",l=>{const r=l.target;if(S(r,"data-type","previous")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),l.stopPropagation();return}if(S(r,"data-type","next")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),l.stopPropagation();return}if(r.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),a||ee(this.range),l.stopPropagation();return}const d=$(r,"b3-list-item");if(d){l.stopPropagation();const f=d.getAttribute("data-value");a?a(f):$f(f,e)}}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),o.select(),this.renderAssetList(i,s,"",t)}showContent(e,t,a){var i,s;this.range=t,ne(["hint"],e),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let o="";const l=t.toString()!==""||((s=(i=t.cloneContents().childNodes[0])==null?void 0:i.classList)==null?void 0:s.contains("emoji"));l&&(o+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',e.disabled||(o+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),e.disabled||(o+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(l||!e.disabled)&&(o+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${o}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>Yv(this,null,function*(){const u=$(c.target,"keyboard__action");if(!u)return;const d=u.getAttribute("data-action");if(d==="copy")ee(he(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(d==="cut")ee(he(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(d==="delete"){const f=he(a);f.insertNode(document.createElement("wbr"));const g=a.outerHTML;f.extractContents(),_e(a,f),ee(f),ie(e,a.getAttribute("data-node-id"),a.outerHTML,g),this.subElement.classList.add("fn__none")}else if(d==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const f=yield R();Oc(e,f,a)}catch(f){console.log(f)}this.subElement.classList.add("fn__none")}else if(d==="select")mo(e,a,t),this.subElement.classList.add("fn__none");else if(d==="copyPlainText"){ee(he(a));const f=getSelection().getRangeAt(0).cloneContents();f.querySelectorAll('[data-type="backslash"]').forEach(g=>{g.firstElementChild.remove()}),Y(f.textContent),this.subElement.classList.add("fn__none")}else d==="pasteAsPlainText"?(ee(he(a)),Bc(e),this.subElement.classList.add("fn__none")):d==="pasteEscaped"?(Bf(e,a),this.subElement.classList.add("fn__none")):d==="back"?this.subElement.lastElementChild.innerHTML=o:d==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${l?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${l?"":" fn__none"}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,Ve(this.subElement,r.left,r.top+28,p.Constants.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=Cn(a,t);Ve(this.subElement,r.left,r.top-48,p.Constants.SIZE_TOOLBAR_HEIGHT)}}const sm=n=>{window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const e=new Le({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),t=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(t,()=>{a[1].click()}),t.focus(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{_("/api/block/transferBlockRef",{fromID:n,toID:t.value}),e.destroy()})}}).element)};var jv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())}),Kv=(n,e,t)=>(e=n[Symbol.asyncIterator],t=(a,i)=>(i=n[a])&&(e[a]=s=>new Promise((o,l,r)=>(s=i.call(n,s),r=s.done,Promise.resolve(s.value).then(c=>o({value:c,done:r}),l)))),e?e.call(n):(n=n[Symbol.iterator](),e={},t("next"),t("return"),e));class Zv{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-gutters",/Mac/.test(navigator.platform)||navigator.platform==="iPhone"?this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip):this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip.replace("\u2325\u2318A","Ctrl+Alt+A").replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+")),this.element.setAttribute("data-type","a"),this.element.setAttribute("data-position","right"),this.element.addEventListener("dragstart",t=>{Mn();let a=[t.target.getAttribute("data-node-id")];const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");i.length>0&&(a=[],i.forEach(s=>{a.push(s.getAttribute("data-node-id"))})),i.length===0&&t.dataTransfer.setDragImage(e.wysiwyg.element.querySelector(`[data-node-id="${a[0]}"]`),0,0),t.target.style.opacity="0.1",window.siyuan.dragElement=e.wysiwyg.element,t.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}${t.target.getAttribute("data-type")}${p.Constants.ZWSP}${t.target.getAttribute("data-subtype")}${p.Constants.ZWSP}${a}`,e.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(t=>{t.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",t=>{const a=qe(t.target,"BUTTON");if(!a)return;t.preventDefault(),t.stopPropagation();const i=a.getAttribute("data-node-id");if(!i){if(a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");let s;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${(a.previousElementSibling||a.nextElementSibling).getAttribute("data-node-id")}"]`)).find(o=>{if(!S(o.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(o))return s=o,!0}),!s)return;if(t.altKey){let o=!0;Array.from(s.children).find(c=>{if(c.classList.contains("list")&&Array.from(c.children).find(d=>{if(d.classList.contains("li")&&d.getAttribute("fold")!=="1"&&d.childElementCount>3)return o=!1,!0}))return!0});const l=[],r=[];Array.from(s.children).forEach(c=>{c.classList.contains("list")&&Array.from(c.children).forEach(u=>{if(u.classList.contains("li")){o?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const d=u.getAttribute("data-node-id");l.push({action:"setAttrs",id:d,data:JSON.stringify({fold:o?"0":"1"})}),r.push({action:"setAttrs",id:d,data:JSON.stringify({fold:o?"1":"0"})})}})}),G(e,l,r),a.removeAttribute("disabled")}else{const o=Vt(e,s);o==="1"?a.firstElementChild.style.transform="":o==="0"&&(a.firstElementChild.style.transform="rotate(90deg)")}ne(["select"],e),window.siyuan.menus.menu.remove();return}if(t.ctrlKey||t.metaKey)Yt({protyle:e,id:i});else if(t.altKey){let s;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(o=>{if(!S(o.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(o))return s=o,!0}),!s)return;if(a.getAttribute("data-type")==="NodeListItem"&&s.parentElement.getAttribute("data-node-id")){let o=!0;Array.from(s.parentElement.children).find(c=>{if(c.classList.contains("li")&&c.getAttribute("fold")!=="1"&&c.childElementCount>3)return o=!1,!0});const l=[],r=[];Array.from(s.parentElement.children).find(c=>{if(c.classList.contains("li")){o?c.removeAttribute("fold"):c.childElementCount>3&&c.setAttribute("fold","1");const u=c.getAttribute("data-node-id");l.push({action:"setAttrs",id:u,data:JSON.stringify({fold:o?"0":"1"})}),r.push({action:"setAttrs",id:u,data:JSON.stringify({fold:o?"1":"0"})})}}),G(e,l,r)}else Vt(e,s);s.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!e.disabled?ga(e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",e):(this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=he(e.wysiwyg.element.firstElementChild)),(0,T.tq)()?window.siyuan.menus.menu.fullscreen():(window.siyuan.menus.menu.popup({x:t.clientX-16,y:t.clientY-16,isLeft:!0}),ee(e.toolbar.range)))}),this.element.addEventListener("contextmenu",t=>{const a=qe(t.target,"BUTTON");!a||e.disabled||a.getAttribute("data-type")==="fold"||(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(e,a),window.siyuan.menus.menu.popup({x:t.clientX-16,y:t.clientY-16,isLeft:!0})),t.preventDefault(),t.stopPropagation())}),this.element.addEventListener("mouseover",t=>{const a=qe(t.target,"BUTTON");if(a){if(a.getAttribute("data-type")==="fold"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a.getAttribute("data-node-id")}"]`)).find(i=>{if(!S(i.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(i))return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(s=>{i.isSameNode(s)||s.classList.remove("protyle-wysiwyg--hl")}),i.classList.add("protyle-wysiwyg--hl"),!0}),t.preventDefault()}}),this.element.addEventListener("mouseleave",t=>{Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")}),t.preventDefault(),t.stopPropagation()})}isMatchNode(e){const t=e.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+4;return t.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(t.height-this.element.clientHeight)/2),t.top<=a&&t.bottom>=a}turnsOneInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){return jv(this,null,function*(){var t,a;if(e.nodeElement.querySelector("wbr")||(t=J(e.nodeElement))==null||t.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var i=Kv(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),s,o,l;s=!(o=yield i.next()).done;s=!1){const f=o.value,g=f.getAttribute("data-node-id");f.removeAttribute("fold");const h=yield kt("/api/transactions",{session:e.protyle.id,app:p.Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:g}],undoOperations:[{action:"foldHeading",id:g}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:g}],[{action:"foldHeading",id:g}]),f.insertAdjacentHTML("afterend",h.data[0].doOperations[0].retData)}}catch(f){l=[f]}finally{try{s&&(o=i.return)&&(yield o.call(i))}finally{if(l)throw l[0]}}const r=e.nodeElement.outerHTML,c=(a=e.nodeElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),u=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,d=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=d,e.type==="CancelList"||e.type==="CancelBlockquote"){const f=document.createElement("template");f.innerHTML=d;const g=[{action:"delete",id:e.id}],h=[];let m=c;Array.from(f.content.children).forEach(b=>{const y=b.getAttribute("data-node-id");g.push({action:"insert",data:b.outerHTML,id:y,previousID:m,parentID:u}),h.push({action:"delete",id:y}),m=y}),h.push({action:"insert",data:r,id:e.id,previousID:c,parentID:u}),G(e.protyle,g,h)}else ie(e.protyle,e.id,d,r);_e(e.protyle.wysiwyg.element,he(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(f=>{f.textContent===""&&_("/api/block/getRefText",{id:f.getAttribute("data-id")},g=>{f.innerHTML=g.data})}),Ke(e.protyle,e.protyle.wysiwyg.element),yt(e.protyle.wysiwyg.element),Ze(e.protyle.wysiwyg.element),Ct(e.protyle.wysiwyg.element,e.protyle)})}}}turnsIntoOne(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){id(e)}}}turnsInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){ua(e)}}}showMobileAppearance(e){const t=document.getElementById("keyboardToolbar"),a=t.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),t.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),t.classList.remove("fn__none");const i=e.contentElement.scrollTop+333.5;ap(e,t),jc(i)}renderMultipleMenu(e,t){var a;let i=!1,s=!1,o=!1;if(t.find((u,d)=>{if(u.classList.contains("li"))return i=!0,!0;if((u.classList.contains("bq")||u.classList.contains("sb")||u.classList.contains("p"))&&(o=!0),u.nextElementSibling&&t[d+1]&&u.nextElementSibling.isSameNode(t[d+1]))s=!0;else if(d!==t.length-1)return s=!1,!0}),!i&&!e.disabled){const u=[];s&&(u.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:t,type:"Blocks2ULs"})),u.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:t,type:"Blocks2OLs"})),u.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:t,type:"Blocks2TLs"})),u.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:t,type:"Blocks2Blockquote"}))),o||u.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:t,type:"Blocks2Ps",isContinue:s})),u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:t,level:1,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:t,level:2,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:t,level:3,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:t,level:4,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:t,level:5,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:t,level:6,type:"Blocks2Hs",isContinue:s})),window.siyuan.menus.menu.append(new I({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),s&&window.siyuan.menus.menu.append(new I({icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:t,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:t,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}e.disabled||Xh(t,e);const l=[{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){if(Me(t[0])){let u="";t.forEach(d=>{u+=oa(d)}),O(e.lute.BlockDOM2StdMd(u).trimEnd())}else ee(he(t[0])),document.execCommand("copy")}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let u="";t.forEach(d=>{d.querySelectorAll("[spellcheck]").forEach(f=>{const g=f.cloneNode(!0);g.querySelectorAll('[data-type="backslash"]').forEach(h=>{h.firstElementChild.remove()}),u+=g.textContent+`
`})}),Y(u.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){Xc(t,e)}}],r=this.genCopyTextRef(t);if(r&&l.splice(2,0,r),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:l}).element),e.disabled)return;window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var u;if(Me(t[0])){let d="";t.forEach(f=>{d+=oa(f)}),O(e.lute.BlockDOM2StdMd(d).trimEnd()),(u=e.breadcrumb)==null||u.hide(),gn(e,t[0],he(t[0]))}else ee(he(t[0])),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{ya(u=>{Mc(u[0],t,e)})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var u;(u=e.breadcrumb)==null||u.hide(),gn(e,t[0],he(t[0]))}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element);const c=new I({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Yc(e,t)),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const u=t[0].getBoundingClientRect();Ve(e.toolbar.subElement,u.left,u.top)}}).element;return window.siyuan.menus.menu.append(c),(0,T.tq)()||c.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(t,e),this.genWidths(t,e),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){ao(e,t)}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){const u=[];t.forEach(d=>{d.getAttribute("data-type")!=="NodeThematicBreak"&&u.push(d.getAttribute("data-node-id"))}),no(e.app,u)}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&Qt({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:t},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(e,t){var a,i;if(!t)return;ne(["util","toolbar","hint"],e),window.siyuan.menus.menu.remove(),(0,T.tq)()&&Gs();const s=t.getAttribute("data-node-id"),o=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(o.length>1&&Array.from(o).find(m=>{if(s===m.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(e,Array.from(o));let l;if(t.tagName==="BUTTON"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(h=>{if(!S(h.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(h))return l=h,!0}):l=t,!l)return;const r=l.getAttribute("data-type"),c=l.getAttribute("data-subtype"),u=[];ne(["select"],e),l.classList.add("protyle-wysiwyg--select"),zt([s],e.block.rootID),r==="NodeParagraph"&&!e.disabled?(u.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:[l],type:"Blocks2ULs"})),u.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:[l],type:"Blocks2OLs"})),u.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:[l],type:"Blocks2TLs"})),u.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:[l],type:"Blocks2Blockquote"})),u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[l],level:1,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[l],level:2,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[l],level:3,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[l],level:4,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[l],level:5,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!e.disabled?(u.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[l],level:6,type:"Blocks2Ps"})),c!=="h1"&&u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[l],level:1,type:"Blocks2Hs"})),c!=="h2"&&u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[l],level:2,type:"Blocks2Hs"})),c!=="h3"&&u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[l],level:3,type:"Blocks2Hs"})),c!=="h4"&&u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[l],level:4,type:"Blocks2Hs"})),c!=="h5"&&u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[l],level:5,type:"Blocks2Hs"})),c!=="h6"&&u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[l],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!e.disabled?(u.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:l,id:s,type:"CancelList"})),l.getAttribute("data-subtype")==="o"?(u.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:l,id:s,type:"OL2UL"})),u.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:l,id:s,type:"UL2TL"}))):l.getAttribute("data-subtype")==="t"?(u.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:l,id:s,type:"TL2UL"})),u.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:l,id:s,type:"TL2OL"}))):(u.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:l,id:s,type:"UL2OL"})),u.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:l,id:s,type:"OL2TL"})))):r==="NodeBlockquote"&&!e.disabled&&u.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:l,id:s,type:"CancelBlockquote"})),u.length>0&&!e.disabled&&window.siyuan.menus.menu.append(new I({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),!e.disabled&&!l.classList.contains("hr")&&Xh([l],e);const d=li(s,!0,l).concat([{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){Me(l)?O(e.lute.BlockDOM2StdMd(oa(l)).trimEnd()):(ee(he(l)),document.execCommand("copy"))}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let h="";l.querySelectorAll("[spellcheck]").forEach(m=>{const b=m.cloneNode(!0);b.querySelectorAll('[data-type="backslash"]').forEach(y=>{y.firstElementChild.remove()}),h+=b.textContent+`
`}),Y(h.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){Xc([l],e)}}]),f=this.genCopyTextRef([l]);if(f&&d.splice(d.length-1,0,f),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:d}).element),e.disabled||(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var h;Me(l)?(O(e.lute.BlockDOM2StdMd(oa(l)).trimEnd()),gn(e,l,he(l)),(h=e.breadcrumb)==null||h.hide()):(ee(he(l)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{ya(h=>{Mc(h[0],[l],e)})}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var h;(h=e.breadcrumb)==null||h.hide(),gn(e,l,he(l))}}).element)),r==="NodeSuperBlock"&&!e.disabled)window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const h=Ri(e,l);G(e,h.doOperations,h.undoOperations),we(e.wysiwyg.element.querySelector(`[data-node-id="${h.previousId}"]`)),ne(["gutter"],e)}}).element);else if(r==="NodeCodeBlock"&&!e.disabled&&!l.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new I({type:"separator"}).element);const h=l.getAttribute("linewrap"),m=l.getAttribute("ligatures"),b=l.getAttribute("linenumber");window.siyuan.menus.menu.append(new I({type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.codeLineWrap&&h!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",w=>{const E=y.querySelector("input");w.target.tagName!=="INPUT"&&(E.checked=!E.checked),l.setAttribute("linewrap",E.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),Ze(l),_("/api/attr/setBlockAttrs",{id:s,attrs:{linewrap:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.codeLigatures&&m!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",w=>{const E=y.querySelector("input");w.target.tagName!=="INPUT"&&(E.checked=!E.checked),l.setAttribute("ligatures",E.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),Ze(l),_("/api/attr/setBlockAttrs",{id:s,attrs:{ligatures:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&b!=="false"?" checked":""}></div>`,bind(y){y.addEventListener("click",w=>{const E=y.querySelector("input");w.target.tagName!=="INPUT"&&(E.checked=!E.checked),l.setAttribute("linenumber",E.checked.toString()),l.querySelector(".hljs").removeAttribute("data-render"),Ze(l),_("/api/attr/setBlockAttrs",{id:s,attrs:{linenumber:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!e.disabled&&["echarts","mindmap"].includes(l.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new I({type:"separator"}).element);const h=l.style.height;let m=l.outerHTML;window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${h?parseInt(h):"420"}">`,bind:b=>{b.querySelector("input").addEventListener("change",y=>{const w=(y.target.value||"420")+"px";l.style.height=w,l.firstElementChild.nextElementSibling.style.height=w,ie(e,s,l.outerHTML,m),m=l.outerHTML,y.stopPropagation();const E=window.echarts.getInstanceById(l.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));E&&E.resize()})}},{label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,l)}}]}).element)}else if(r==="NodeTable"&&!e.disabled){let h=he(l);const m=l.querySelector("table");m.contains(h.startContainer)||(h=he(m.querySelector("th")));const b=te(h.startContainer,"TD")||te(h.startContainer,"TH");b&&(window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:gp(e,l,b,h)}).element))}else if((r==="NodeVideo"||r==="NodeAudio")&&!e.disabled)window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({id:"assetSubMenu",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:jw(e,l,r)}).element);else if(r==="NodeIFrame"&&!e.disabled)window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({id:"assetSubMenu",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:Gw(e,l)}).element);else if(r==="NodeHTMLBlock"&&!e.disabled)window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,l)}}).element);else if(r==="NodeBlockQueryEmbed"&&!e.disabled){window.siyuan.menus.menu.append(new I({type:"separator"}).element);const h=l.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new I({id:"assetSubMenu",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){l.removeAttribute("data-render"),Ke(e,l)}},{icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,l)}},{type:"separator"},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&h!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),l.setAttribute("breadcrumb",y.checked.toString()),_("/api/attr/setBlockAttrs",{id:s,attrs:{breadcrumb:y.checked.toString()}}),l.removeAttribute("data-render"),Ke(e,l),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${l.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),l.setAttribute("custom-heading-mode",y.checked?"1":"0"),_("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":y.checked?"1":"0"}}),l.removeAttribute("data-render"),Ke(e,l),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeHeading"&&!e.disabled){window.siyuan.menus.menu.append(new I({type:"separator"}).element);const h=[];c!=="h1"&&h.push(this.genHeadingTransform(e,s,1)),c!=="h2"&&h.push(this.genHeadingTransform(e,s,2)),c!=="h3"&&h.push(this.genHeadingTransform(e,s,3)),c!=="h4"&&h.push(this.genHeadingTransform(e,s,4)),c!=="h5"&&h.push(this.genHeadingTransform(e,s,5)),c!=="h6"&&h.push(this.genHeadingTransform(e,s,6)),window.siyuan.menus.menu.append(new I({type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:h}).element),window.siyuan.menus.menu.append(new I({icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){_("/api/block/getHeadingChildrenDOM",{id:s},m=>{O(m.data+p.Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){_("/api/block/getHeadingChildrenDOM",{id:s},m=>{O(m.data+p.Constants.ZWSP),_("/api/block/getHeadingDeleteTransaction",{id:s},b=>{b.data.doOperations.forEach(y=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${y.id}"]`).forEach(w=>{w.remove()})}),G(e,b.data.doOperations,b.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){_("/api/block/getHeadingDeleteTransaction",{id:s},m=>{m.data.doOperations.forEach(b=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${b.id}"]`).forEach(y=>{y.remove()})}),G(e,m.data.doOperations,m.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new I({type:"separator"}).element),e.options.backlinkData||(window.siyuan.menus.menu.append(new I({accelerator:`${ae(window.siyuan.config.keymap.general.enter.custom)}/${ae("\u2318Click")}`,label:window.siyuan.languages.enter,click:()=>{Yt({protyle:e,id:s})}}).element),window.siyuan.menus.menu.append(new I({accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{ed(e,s)}}).element)),!e.disabled){window.siyuan.menus.menu.append(new I({icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){ne(["select"],e),zt([],e.block.rootID),rn(e,"beforebegin",s)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){ne(["select"],e),zt([],e.block.rootID),rn(e,"afterend",s)}}).element);const h=l.lastElementChild.querySelector(".protyle-attr--refcount");h&&h.textContent&&sm(s)}if(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){ne(["select"],e),rf(e,l)}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.fold,accelerator:`${ae(window.siyuan.config.keymap.editor.general.collapse.custom)}/${ae("\u2325Click")}`,click(){Vt(e,l),we(l)}}).element),e.disabled||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+ae("\u21E7Click"),click(){ga(l,"bookmark",e)}}).element)),!e.disabled){const h=new I({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Yc(e,[l])),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const m=l.getBoundingClientRect();Ve(e.toolbar.subElement,m.left,m.top)}}).element;window.siyuan.menus.menu.append(h),(0,T.tq)()||h.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([l],e),this.genWidths([l],e)}window.siyuan.menus.menu.append(new I({type:"separator"}).element),!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((a=J(l))==null?void 0:a.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!l.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){ay(l)}}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){ao(e,[l])}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){no(e.app,[l.getAttribute("data-node-id")])}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element)),(i=e==null?void 0:e.app)!=null&&i.plugins&&Qt({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:[l]},separatorPosition:"bottom"});let g=l.getAttribute("updated")||"";return g&&(g=`${window.siyuan.languages.modifiedAt} ${ue(g).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,type:"readonly",label:`${g}${window.siyuan.languages.createdAt} ${ue(s.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(e,t,a){return{iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){_("/api/block/getHeadingLevelTransaction",{id:t,level:a},i=>{i.data.doOperations.forEach((s,o)=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{l.outerHTML=s.data}),e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{ra(l)}),o===0&&we(e.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),e.wysiwyg.element,!0)}),G(e,i.data.doOperations,i.data.undoOperations)})}}}genClick(e,t,a){Zs(e,t,a),we(e[0])}genAlign(e,t){window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.layout,type:"submenu",submenu:[{label:window.siyuan.languages.alignLeft,icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,t,a=>{a.classList.contains("av")?(a.style.margin="",Ln(a)):a.style.textAlign="left"})}},{label:window.siyuan.languages.alignCenter,icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,t,a=>{a.classList.contains("av")?(a.style.margin="0 auto",Ln(a)):a.style.textAlign="center"})}},{label:window.siyuan.languages.alignRight,icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,t,a=>{a.classList.contains("av")?(a.style.margin="0 0 0 auto",Ln(a)):a.style.textAlign="right"})}},{label:window.siyuan.languages.justify,icon:"iconMenu",click:()=>{this.genClick(e,t,a=>{a.style.textAlign="justify"})}},{type:"separator"},{label:window.siyuan.languages.ltr,icon:"iconLtr",click:()=>{this.genClick(e,t,a=>{a.style.direction="ltr"})}},{label:window.siyuan.languages.rtl,icon:"iconRtl",click:()=>{this.genClick(e,t,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,t,a=>{a.classList.contains("av")?(a.style.margin="",Ln(a)):(a.style.textAlign="",a.style.direction="")})}}]}).element)}genWidths(e,t){const a=[];["25%","33%","50%","67%","75%"].forEach(s=>{a.push({label:s,click:()=>{this.genClick(e,t,o=>{o.style.width=s,o.style.flex="none",Ln(o)})}})}),a.push({type:"separator"});let i=100;if(e.length===1){const s=e[0].style.width;s.endsWith("%")&&(i=parseInt(s))}window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.width,submenu:a.concat([{label:`<div aria-label="${i}%" class="b3-tooltips b3-tooltips__n${(0,T.tq)()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${i}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(s){const o=s.querySelector("input");o.addEventListener("input",()=>{e.forEach(c=>{c.style.width=o.value+"%",c.style.flex="none"}),o.parentElement.setAttribute("aria-label",`${o.value}%`)});const l=[],r=[];e.forEach(c=>{l.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML})}),o.addEventListener("change",()=>{e.forEach(c=>{r.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML}),Ln(c)}),G(t,r,l),window.siyuan.menus.menu.remove(),we(e[0])})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,t,s=>{s.style.width&&(s.style.width="",s.style.flex="",Ln(s))})}}])}).element)}genCopyTextRef(e){return Me(e[0])?!1:{accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){e[0].setAttribute("data-reftext","true"),ee(he(e[0])),document.execCommand("copy")}}}render(e,t,a){var i;const s=a.parentElement.querySelector(".protyle-title__input");if(s&&s.getAttribute("data-render")!=="true")return;const o=a.parentElement.parentElement.querySelector(".protyle-select");if(o&&!o.classList.contains("fn__none"))return;let l="",r=t,c=0,u=0,d,f=!1;for(;r;){const w=!f||f&&r.getAttribute("fold")==="1";if(!S(r.parentElement,"data-type","NodeBlockQueryEmbed")){let L;if(w&&(L=r.getAttribute("data-type")),u===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(L))return;const A=Oe(r);d=A.querySelector(".li")||A.querySelector(".list"),S(d,"data-type","NodeBlockQueryEmbed")&&(d=void 0),!A.isSameNode(r)&&L!=="NodeHeading"&&(r=A,L=r.getAttribute("data-type"))}L==="NodeListItem"&&u===1&&!w&&(l=""),u+=1,w&&(l=`<button ${e.disabled?"":'draggable="true"'} data-type="${L}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${ln(L,r.getAttribute("data-subtype"))}"></use></svg></button>`+l);let v="";if(L==="NodeListItem"&&r.childElementCount>3||L==="NodeHeading"){const A=r.getAttribute("fold");v=`<button data-type="fold"><svg style="width:10px${A&&A==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(L==="NodeListItem"||L==="NodeList")&&(d=r,L==="NodeListItem"&&r.childElementCount>3&&(l=`<button ${e.disabled?"":'draggable="true"'} data-type="${L}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${ln(L,r.getAttribute("data-subtype"))}"></use></svg></button>${v}`)),L==="NodeHeading"&&(l=l+v),L==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(f=!0)}const k=M(r.parentElement);if(k)r=k;else break}let g=!0;const h=this.element.querySelectorAll("button");if(h.length!==l.split("</button>").length-1?g=!1:h.forEach(w=>{const E=w.getAttribute("data-node-id");E&&l.indexOf(E)===-1&&(g=!1)}),g&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";let m=t.getBoundingClientRect(),b=0;if(d?(m=d.firstElementChild.getBoundingClientRect(),c=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(m=r.getBoundingClientRect(),c=0):(m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||m.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8)&&(b=(m.height-this.element.clientHeight)/2),r.getAttribute("data-type")==="NodeAttributeView"){const w=r.querySelector(".item__graphic");w?this.element.style.top=`${Math.max(w.getBoundingClientRect().top-(window.siyuan.config.editor.fontSize*1.625-14)/2,a.parentElement.getBoundingClientRect().top)}px`:this.element.style.top=`${Math.max(m.top,a.parentElement.getBoundingClientRect().top)+8}px`}else this.element.style.top=`${Math.max(m.top,a.parentElement.getBoundingClientRect().top)+b}px`;let y=m.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?y=r.getBoundingClientRect().left-this.element.clientWidth-c:r.getAttribute("data-type")==="NodeAttributeView"&&(y=y+(parseInt((i=r.firstElementChild.firstElementChild)==null?void 0:i.style.paddingLeft)||0)),this.element.style.left=`${y}px`,y<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${m.left-this.element.clientWidth-c/2+3}px`,l="",Array.from(this.element.children).reverse().forEach((w,E)=>{E!==0&&(w.firstElementChild.style.height="14px"),l+=w.outerHTML}),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach(w=>{w.style.height=""})}}class Xv{constructor(e){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let t;if(typeof AudioContext!="undefined")t=new AudioContext;else if(webkitAudioContext)t=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=t.sampleRate;const a=t.createGain();t.createMediaStreamSource(e).connect(a),this.recorder=t.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(t.destination),this.readyFlag=!0}cloneChannelData(e,t){this.leftChannel.push(new Float32Array(e)),this.rightChannel.push(new Float32Array(t)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const e=this.mergeBuffers(this.leftChannel),t=this.mergeBuffers(this.rightChannel);let a=new Float32Array(e.length);for(let d=0;d<e.length;++d)a[d]=.5*(e[d]+t[d]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const i=44+a.length*2,s=new ArrayBuffer(i),o=new DataView(s);this.writeUTFBytes(o,0,"RIFF"),o.setUint32(4,i,!0),this.writeUTFBytes(o,8,"WAVE"),this.writeUTFBytes(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,this.SAMPLE_RATE,!0),o.setUint32(28,this.SAMPLE_RATE*2,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0);const l=a.length*2;this.writeUTFBytes(o,36,"data"),o.setUint32(40,l,!0);const r=a.length;let c=44;const u=1;for(let d=0;d<r;d++)o.setInt16(c,a[d]*(32767*u),!0),c+=2;return new Blob([o],{type:"audio/wav"})}downSampleBuffer(e,t){if(t===this.DEFAULT_SAMPLE_RATE||t>this.DEFAULT_SAMPLE_RATE)return e;const a=this.DEFAULT_SAMPLE_RATE/t,i=Math.round(e.length/a),s=new Float32Array(i);let o=0,l=0;for(;o<s.length;){const r=Math.round((o+1)*a);let c=0,u=0;for(let d=l;d<r&&d<e.length;d++)c+=e[d],u++;s[o]=c/u,o++,l=r}return s}mergeBuffers(e){const t=new Float32Array(this.recordingLength);let a=0;const i=e.length;for(let s=0;s<i;++s){const o=e[s];t.set(o,a),a+=o.length}return t}writeUTFBytes(e,t,a){const i=a.length;for(let s=0;s<i;s++)e.setUint8(t+s,a.charCodeAt(s))}}var Jv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const Zd=(n,e)=>{if(Mn(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}_("/api/block/getDocInfo",{id:n.block.rootID},t=>{var a;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:li(n.block.rootID)}).element),n.disabled||(window.siyuan.menus.menu.append(gd([n.path])),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{Up(n.notebookId,n.path)}}).element)),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({icon:"iconAlignCenter",label:window.siyuan.languages.outline,accelerator:window.siyuan.config.keymap.editor.general.outline.custom,click:()=>{$p(n)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{Cl({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||"Untitled":null})}}).element),window.siyuan.menus.menu.append(new I({icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{xl({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||"Untitled":null})}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+ae("\u21E7Click"),click(){On(t.data.ial,"bookmark",n)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){iy(n)}}).element);const i=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{_("/api/riff/getTreeRiffDueCards",{rootID:n.block.rootID},s=>{ri(n.app,s.data,"doc",n.block.rootID,s.data.name)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{_("/api/filetree/getHPathByID",{id:n.block.rootID},s=>{es(n.app,n.block.rootID,xe().join(Xn(n.notebookId),s.data),"Tree")})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var s;let o=(s=n.title)==null?void 0:s.element;o||(o=document.createElement("div"),o.setAttribute("data-node-id",n.block.rootID),o.setAttribute(p.Constants.CUSTOM_RIFF_DECKS,t.data.ial[p.Constants.CUSTOM_RIFF_DECKS])),ao(n,[o])}}];window.siyuan.config.flashcard.deck&&i.push({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{no(n.app,[n.block.rootID])}}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:i}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Jv(this,null,function*(){const s=pt(n.path,!1,!0);pn({app:n.app,hotkey:window.siyuan.config.keymap.general.search.custom,notebookId:n.notebookId,searchPath:s})})}}).element),n.disabled||sm(n.block.rootID),window.siyuan.menus.menu.append(new I({type:"separator"}).element),n.disabled||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Wp({app:n.app,id:n.block.rootID,notebookId:n.notebookId,pathString:t.data.name})}}).element),wd(n.notebookId,n.path),window.siyuan.menus.menu.append(Rp(n.block.showAll?n.block.id:n.block.rootID)),(a=n==null?void 0:n.app)!=null&&a.plugins&&Qt({plugins:n.app.plugins,type:"click-editortitleicon",detail:{protyle:n,data:t.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${ue(t.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>
${window.siyuan.languages.createdAt} ${ue(t.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.popup(e)})};var Qv=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class eE{constructor(e){const t=document.createElement("div");t.className="protyle-breadcrumb",t.innerHTML=`${(0,T.tq)()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<span class="fn__space"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="doc" aria-label="${window.siyuan.languages.gutterTip2}"><svg><use xlink:href="#iconFile"></use></svg></button>
<span class="fn__space"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon block__icon--show fn__flex-center fn__none ariaLabel" style="margin-left: 8px" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=t.firstElementChild,t.addEventListener("click",a=>{e.model&&lt(e.model.element.parentElement.parentElement);let i=a.target;for(;i&&!i.isEqualNode(t);){const s=i.getAttribute("data-node-id"),o=i.getAttribute("data-type");if(s){e.options.render.breadcrumbDocName&&window.siyuan.ctrlIsPressed?be({app:e.app,id:s,action:s===e.block.rootID?[p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]}):Yt({protyle:e,id:s}),a.preventDefault();break}else if(o==="mobile-menu"){this.genMobileMenu(e),a.preventDefault(),a.stopPropagation();break}else if(o==="doc"){if(window.siyuan.shiftIsPressed)_("/api/block/getDocInfo",{id:e.block.rootID},l=>{On(l.data.ial,"bookmark",e)});else{const l=i.getBoundingClientRect();Zd(e,{x:l.right,y:l.bottom,isLeft:!0})}a.stopPropagation(),a.preventDefault();break}else if(o==="more"){const l=i.getBoundingClientRect();this.showMenu(e,{x:l.right,y:l.bottom,isLeft:!0}),a.stopPropagation(),a.preventDefault();break}else if(o==="readonly"){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:i.querySelector("use").getAttribute("xlink:href")==="#iconUnlock"?"true":"false"}}),a.stopPropagation(),a.preventDefault();break}else if(o==="exit-focus"){Yt({protyle:e,id:e.block.rootID,focusId:e.block.id}),a.stopPropagation(),a.preventDefault();break}else if(o==="context"){a.stopPropagation(),a.preventDefault(),i.classList.contains("block__icon--active")?(Yt({protyle:e,id:e.options.blockId}),i.classList.remove("block__icon--active")):(_("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{dt({data:l,protyle:e,action:[p.Constants.CB_GET_HL]})}),i.classList.add("block__icon--active"));break}i=i.parentElement}}),t.addEventListener("mouseleave",()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mouseover",a=>{if(!e.selectElement.classList.contains("fn__none"))return;const i=a.target,s=S(i,"data-node-id",null);if(s){e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(l=>{l.classList.remove("protyle-wysiwyg--hl")});const o=e.wysiwyg.element.querySelector(`[data-node-id="${s.getAttribute("data-node-id")}"]`);o&&o.classList.add("protyle-wysiwyg--hl")}}),this.element.addEventListener("mousewheel",a=>{this.element.scrollLeft=this.element.scrollLeft+a.deltaY},{passive:!0})}startRecord(e){this.messageId=q(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),j(this.messageId);const t=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});da(e,[t])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(e){const t=new Kt("breadcrumb-mobile-path");let a;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?a=bt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:a=M(s.startContainer)}a||(a=bt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const i=a.getAttribute("data-node-id");_("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(o=>{let l=!1;(!e.block.showAll&&o.id===e.block.parentID||e.block.showAll&&o.id===e.block.id)&&(l=!0),t.addItem({current:l,icon:ln(o.type,o.subType),label:o.name,click(){Yt({protyle:e,id:o.id,focusId:i})}})}),t.fullscreen()})}toggleExit(e){const t=this.element.parentElement.querySelector('[data-type="exit-focus"]');e?t.classList.add("fn__none"):t.classList.remove("fn__none")}showMenu(e,t){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let a;const i=M(he(e.element).startContainer);i&&(a=i.getAttribute("data-node-id")),_("/api/block/getTreeStat",{id:a||(e.block.showAll?e.block.id:e.block.rootID)},s=>{var o,l,r;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!e.contentElement.classList.contains("fn__none")&&!e.disabled){let d="";d='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?d+=` accept="${e.options.upload.accept}">`:d+=">";const f=new I({icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${d}`}).element;f.querySelector("input").addEventListener("change",g=>{g.target.files.length!==0&&(da(e,g.target.files,g.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(f),Mt()||window.siyuan.menus.menu.append(new I({current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(o=this.mediaRecorder)!=null&&o.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Qv(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(g=>{this.mediaRecorder=new Xv(g),this.mediaRecorder.recorder.onaudioprocess=h=>{if(!this.mediaRecorder.isRecording)return;const m=h.inputBuffer.getChannelData(0),b=h.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(m,b)},this.startRecord(e)}).catch(()=>{q(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),j(this.messageId);const g=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});da(e,[g])}else j(this.messageId),this.startRecord(e)})}).element)}e.disabled||(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.netImg2LocalAsset,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){op(e)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){sa()||Ne("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{_("/api/asset/uploadCloud",{id:e.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){Ne("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{_("/api/export/export2Liandi",{id:e.block.parentID})})}}).element)),(l=e.scroll)!=null&&l.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new I({current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{zn(e,!(0,T.tq)())}}).element),e.disabled||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{ne(["toolbar"],e),_("/api/format/autoSpace",{id:e.block.rootID})}}).element),window.siyuan.menus.menu.append(new I({icon:e.element.className.includes("fullscreen")?"iconFullscreenExit":"iconFullscreen",accelerator:window.siyuan.config.keymap.editor.general.fullscreen.custom,label:window.siyuan.languages.fullscreen,click:()=>{kl(e.element),Bt(e)}}).element);const c=[{current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{ss(e,"wysiwyg"),e.scroll.lastScrollTop=0,_("/api/filetree/getDoc",{id:e.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{dt({data:d,protyle:e})})}}];c.push({current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{ss(e,"preview"),window.siyuan.menus.menu.remove()}}),window.siyuan.menus.menu.append(new I({icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:c}).element);const u=e.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_READONLY);if(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{iconHTML:"",current:u==="true",label:window.siyuan.languages.enable,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:"true"}})}},{iconHTML:"",current:u==="false",label:window.siyuan.languages.disable,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:"false"}})}},{iconHTML:"",current:!u,label:window.siyuan.languages.default,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:""}})}}]}).element),!e.disabled){const d=e.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_FULLWIDTH);window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.fullWidth,icon:"iconDock",type:"submenu",submenu:[{iconHTML:"",current:d==="true",label:window.siyuan.languages.enable,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_FULLWIDTH]:"true"}})}},{iconHTML:"",current:d==="false",label:window.siyuan.languages.disable,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_FULLWIDTH]:"false"}})}},{iconHTML:"",current:!d,label:window.siyuan.languages.default,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_FULLWIDTH]:""}})}}]}).element)}(r=e==null?void 0:e.app)!=null&&r.plugins&&Qt({plugins:e.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:e,data:s.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new I({type:"separator"}).element),window.siyuan.menus.menu.append(new I({iconHTML:p.Constants.ZWSP,type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.runeCount}</div>
<div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.wordCount}</div>
<div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.linkCount}</div>
<div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.imageCount}</div>
<div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.refCount}</div>`}).element),window.siyuan.menus.menu.popup(t)})}render(e,t=!1){var a;if((0,T.tq)())return;let i,s;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),!e.wysiwyg.element.isEqualNode(i.startContainer)&&!e.wysiwyg.element.contains(i.startContainer)?e.element.id==="searchPreview"?s=M(e.wysiwyg.element.querySelector('[data-type="search-mark"]')):s=bt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:s=M(i.startContainer)),s||(s=bt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const o=s.getAttribute("data-node-id");if(o===this.id&&!t){e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(c=>{c.classList.remove("protyle-breadcrumb__item--active")});const r=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);r&&r.classList.add("protyle-breadcrumb__item--active");return}this.id=o;const l=[];(a=this.element.parentElement)!=null&&a.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&l.push("NodeTextMark-mark"),_("/api/block/getBlockBreadcrumb",{id:o,excludeTypes:l},r=>{let c="";r.data.forEach((f,g)=>{let h=!1;(!e.block.showAll&&f.id===e.block.parentID||e.block.showAll&&f.id===e.block.id)&&(h=!0),g===0&&!e.options.render.breadcrumbDocName?c+=`<span class="protyle-breadcrumb__item${h?" protyle-breadcrumb__item--active":""}" data-node-id="${f.id}"${r.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${f.id}"><use xlink:href="#${ln(f.type,f.subType)}"></use></svg>
</span>`:c+=`<span class="protyle-breadcrumb__item${h?" protyle-breadcrumb__item--active":""}" data-node-id="${f.id}"${r.data.length===1||g===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${f.id}"><use xlink:href="#${ln(f.type,f.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${f.name}">${f.name}</span>
</span>`,g!==r.data.length-1&&(c+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.classList.remove("protyle-breadcrumb__bar--nowrap"),this.element.innerHTML=c;const u=Array.from(this.element.querySelectorAll(".protyle-breadcrumb__text"));if(u.length===0)return;let d=!1;for(;this.element.scrollHeight>30&&!d&&u.length>1;)u.find((f,g)=>{if(g>0){if(!f.classList.contains("protyle-breadcrumb__text--ellipsis"))return f.classList.add("protyle-breadcrumb__text--ellipsis"),!0;g===u.length-1&&f.classList.contains("protyle-breadcrumb__text--ellipsis")&&(d=!0)}});this.element.classList.add("protyle-breadcrumb__bar--nowrap"),this.element.lastElementChild&&(this.element.scrollLeft=this.element.lastElementChild.offsetLeft-this.element.clientWidth+14)})}hide(){(0,T.tq)()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}const om=n=>n.replace(/\u00a0/g," ");var tE=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class nE{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.element.innerHTML=`<span aria-label="${window.siyuan.languages.gutterTip2}" data-position="right" class="protyle-title__icon ariaLabel"><svg><use xlink:href="#iconFile"></use></svg></span>
<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}" class="protyle-title__input" data-tip="${window.siyuan.languages._kernel[16]}"> </div><div class="protyle-attr"></div>`,this.editElement=this.element.querySelector(".protyle-title__input"),this.editElement.addEventListener("paste",a=>{a.stopPropagation(),a.preventDefault(),document.execCommand("insertText",!1,on(a.clipboardData.getData("text/plain"))),this.rename(e)}),this.editElement.addEventListener("click",()=>{var a;e.model&&(lt(e.model.element.parentElement.parentElement),ba({protyle:e,focus:!1,pushBackStack:!1,reload:!1,resize:!1})),(a=e.toolbar)==null||a.element.classList.add("fn__none")}),this.editElement.addEventListener("input",a=>{a.isComposing||this.rename(e)}),this.editElement.addEventListener("compositionend",()=>{this.rename(e)}),this.editElement.addEventListener("drop",a=>{a.stopPropagation(),a.preventDefault()}),this.editElement.addEventListener("keydown",a=>{if(!a.isComposing){if(lp(e,a))return!0;if(U(window.siyuan.config.keymap.general.enterBack.custom,a)){const i=e.path.split("/");i.length>2&&be({app:e.app,id:i[i.length-2],action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}),a.preventDefault(),a.stopPropagation();return}if(!Ma(a))if(a.key==="ArrowDown"){const i=bt(e.wysiwyg.element.firstElementChild);i&&we(i,e.wysiwyg.element),a.preventDefault(),a.stopPropagation()}else if(a.key==="Enter"){const i=Lute.NewNodeID(),s=Nn(!1,!0,i);e.wysiwyg.element.insertAdjacentElement("afterbegin",s),_e(s,e.toolbar.range||he(s)),G(e,[{action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}],[{action:"delete",id:i}]),a.preventDefault(),a.stopPropagation()}else U(window.siyuan.config.keymap.editor.general.attr.custom,a)?(_("/api/block/getDocInfo",{id:e.block.rootID},i=>{On(i.data.ial,"bookmark",e)}),a.preventDefault(),a.stopPropagation()):U("\u2318A",a)?(he(this.editElement).selectNodeContents(this.editElement),a.preventDefault(),a.stopPropagation()):U(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,a)?(_("/api/block/getRefText",{id:e.block.rootID},i=>{O(`((${e.block.rootID} '${i.data}'))`)}),a.preventDefault(),a.stopPropagation()):U(window.siyuan.config.keymap.editor.general.copyID.custom,a)?(O(e.block.rootID),a.preventDefault(),a.stopPropagation()):U(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,a)?(O(`{{select * from blocks where id='${e.block.rootID}'}}`),a.preventDefault(),a.stopPropagation()):U(window.siyuan.config.keymap.editor.general.copyProtocol.custom,a)&&(O(`siyuan://blocks/${e.block.rootID}`),a.preventDefault(),a.stopPropagation())}});const t=this.element.querySelector(".protyle-title__icon");t.addEventListener("click",()=>{if(window.siyuan.shiftIsPressed)_("/api/block/getDocInfo",{id:e.block.rootID},a=>{On(a.data.ial,"bookmark",e)});else{const a=t.getBoundingClientRect();Zd(e,{x:a.left,y:a.bottom})}}),this.element.addEventListener("contextmenu",a=>{var i;if(a.shiftKey)return;if(getSelection().rangeCount===0){Zd(e,{x:a.clientX,y:a.clientY});return}(i=e.toolbar)==null||i.element.classList.add("fn__none"),window.siyuan.menus.menu.remove();const s=he(this.editElement);s.toString()!==""&&(window.siyuan.menus.menu.append(new I({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click:()=>{ee(he(this.editElement)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new I({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click:()=>{ee(he(this.editElement)),document.execCommand("cut"),setTimeout(()=>{this.rename(e)},p.Constants.TIMEOUT_INPUT)}}).element),window.siyuan.menus.menu.append(new I({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:()=>{const o=he(this.editElement);o.extractContents(),ee(o),setTimeout(()=>{this.rename(e)},p.Constants.TIMEOUT_INPUT)}}).element)),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.paste,accelerator:"\u2318V",click:()=>tE(this,null,function*(){ee(he(this.editElement));const o=yield R();document.execCommand("insertText",!1,on(o)),this.rename(e)})}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.selectAll,accelerator:"\u2318A",click:()=>{s.selectNodeContents(this.editElement),ee(s)}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY})}),this.element.querySelector(".protyle-attr").addEventListener("click",a=>{_("/api/block/getDocInfo",{id:e.block.rootID},i=>{im(a,e,i.data.ial)})})}rename(e){if(clearTimeout(this.timeout),!ul(this.editElement.textContent,this.editElement)){const t=Et(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,p.Constants.SIZE_TITLE)),Fn(this.editElement,t.start,t.end),!1}Mn(),this.timeout=window.setTimeout(()=>{const t=on(this.editElement.textContent);_("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:t}),this.setTitle(t),er(t)},p.Constants.TIMEOUT_INPUT)}setTitle(e){om(e)!==om(this.editElement.textContent)&&(this.editElement.textContent=e==="Untitled"?"":e)}render(e,t){var a;if(this.editElement.getAttribute("data-render")==="true")return!1;this.element.setAttribute("data-node-id",e.block.rootID),t.data.ial[p.Constants.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(p.Constants.CUSTOM_RIFF_DECKS,t.data.ial[p.Constants.CUSTOM_RIFF_DECKS]),(a=e.background)==null||a.render(t.data.ial,e.block.rootID),e.wysiwyg.renderCustom(t.data.ial),this.editElement.setAttribute("data-render","true"),this.setTitle(t.data.ial.title);let i="";if(t.data.ial.bookmark&&(i+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(t.data.ial.bookmark)}</div>`),t.data.ial.name&&(i+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(t.data.ial.name)}</div>`),t.data.ial.alias&&(i+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(t.data.ial.alias)}</div>`),t.data.ial.memo&&(i+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${Lute.EscapeHTMLStr(t.data.ial.memo)}"><svg><use xlink:href="#iconM"></use></svg></div>`),t.data.ial["custom-avs"]&&(i+='<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg></div>'),this.element.querySelector(".protyle-attr").innerHTML=i,t.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block" data-defids='${JSON.stringify([e.block.rootID])}' data-id='${JSON.stringify(t.data.refIDs)}'>${t.data.refCount}</div>`),new Date().getTime()-ue(t.data.id.split("-")[0]).toDate().getTime()<2e3){const s=this.editElement.ownerDocument.createRange();s.selectNodeContents(this.editElement),ee(s)}}}var lm=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class aE{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img class="fn__none">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__sw" style="position: relative" aria-label="${window.siyuan.languages.upload}"><input type="file" style="position: absolute;width: 22px;height: 100%;top: 0;left: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__sw" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="b3-chips"></div>
<div class="protyle-background__iconw">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="protyle-icons fn__flex-center">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__s" data-menu="true" data-type="tag" aria-label="${window.siyuan.languages.addTag}"><svg><use xlink:href="#iconTags"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__s" data-type="icon" aria-label="${window.siyuan.languages.randomIcon}"><svg><use xlink:href="#iconEmoji"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__s" data-type="random" aria-label="${window.siyuan.languages.titleBg}"><svg><use xlink:href="#iconImage"></use></svg></span>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.firstElementChild.firstElementChild,(0,T.b1)()?this.imgElement.addEventListener("touchstart",t=>{if(t.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=t.touches[0].clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.ontouchmove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.touches[0].clientY)/s*100+o).toFixed(2)}%`,t.preventDefault()},i.ontouchend=()=>{i.ontouchmove=null,i.ontouchstart=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}):(this.element.addEventListener("dragover",t=>lm(this,null,function*(){t.preventDefault()})),this.element.addEventListener("drop",t=>lm(this,null,function*(){t.dataTransfer.types[0]==="Files"&&t.dataTransfer.files[0].type.indexOf("image")!==-1&&da(e,[t.dataTransfer.files[0]],void 0,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})})),this.imgElement.addEventListener("mousedown",t=>{if(t.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=t.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.clientY)/s*100+o).toFixed(2)}%`,t.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}})),this.element.querySelector("input").addEventListener("change",t=>{t.target.files.length!==0&&da(e,t.target.files,t.target,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(nt(),t=>{if(e.disabled)return;let a=t.target;for(ne(["gutter"],e);a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type");if(i==="position"){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",t.preventDefault(),t.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,e.block.rootID);t.preventDefault(),t.stopPropagation();break}else if(i==="open-emoji"){const s=this.iconElement.getBoundingClientRect();ls(e.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width}),t.preventDefault(),t.stopPropagation();break}else if(i==="random"){const s=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"],o=s[(0,T.sZ)(0,s.length-1)];this.ial["title-img"]=o,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),t.preventDefault(),t.stopPropagation();break}else if(i==="remove"){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),t.preventDefault(),t.stopPropagation();break}else if(i==="icon"){const s=Wh();s&&(hi(s,e.block.rootID),Xl(s,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:s}}),e.model&&e.model.parent.setDocIcon(s)),t.preventDefault(),t.stopPropagation();break}else if(i==="tag"){this.openTag(e),t.preventDefault(),t.stopPropagation();break}else if(i==="link"){const s=new Le({title:window.siyuan.languages.link,width:(0,T.tq)()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),t.preventDefault(),t.stopPropagation();break}else if(i==="open-search"){Hn(e.app,`#${a.textContent}#`,!window.siyuan.ctrlIsPressed),t.preventDefault(),t.stopPropagation();break}else if(i==="remove-tag"){a.parentElement.remove();const s=this.getTags();_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:s.toString()}}),s.length===0?delete this.ial.tags:this.ial.tags=s.toString(),this.render(this.ial,e.block.rootID),t.preventDefault(),t.stopPropagation();break}a=a.parentElement}})}render(e,t){var a;const i=e["title-img"],s=e.icon,o=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",t),o){let l="";const r=["secondary","primary","info","success","warning","error","pink"];o.split(",").forEach((c,u)=>{l+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[u%7]}" data-type="open-search">${c}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`}),this.tagsElement.innerHTML=l}else this.tagsElement.innerHTML="";if(s?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=fe(s)):this.iconElement.classList.add("fn__none"),i)if(this.imgElement.classList.remove("fn__none"),this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(i)),i.indexOf("url(")>-1){const l=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=l,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");else this.imgElement.classList.add("fn__none");i?this.element.style.minHeight=(0,T.tq)()?"200px":"30vh":s?this.element.style.minHeight=this.tagsElement.clientHeight+56+"px":o?this.element.style.minHeight=this.tagsElement.clientHeight+"px":this.element.style.minHeight="0"}openTag(e){_("/api/search/searchTag",{k:""},t=>{let a="";t.data.tags.forEach((l,r)=>{a+=`<div class="b3-list-item${r===0?" b3-list-item--focus":""}">${l}</div>`}),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.lastElementChild.innerHTML=`<div class="fn__flex-column" style="max-height:50vh;margin: 0 -8px"><input style="margin: 0px 8px 4px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>
</div>`;const i=window.siyuan.menus.menu.element.querySelector(".b3-list--background"),s=window.siyuan.menus.menu.element.querySelector("input");s.addEventListener("keydown",l=>{if(l.stopPropagation(),!l.isComposing)if(En(i,l),l.key==="Enter"){const r=i.querySelector(".b3-list-item--focus");r?this.addTags(r.textContent,e):this.addTags(s.value,e),window.siyuan.menus.menu.remove()}else l.key==="Escape"&&window.siyuan.menus.menu.remove()}),s.addEventListener("input",l=>{l.stopPropagation(),_("/api/search/searchTag",{k:s.value},r=>{let c="",u=!1;r.data.tags.forEach(d=>{c+=`<div class="b3-list-item">${d}</div>`,d===`<mark>${r.data.k}</mark>`&&(u=!0)}),!u&&r.data.k&&(c=`<div class="b3-list-item"><mark>${r.data.k}</mark></div>`+c),i.innerHTML=c,i.firstElementChild.classList.add("b3-list-item--focus")})}),i.addEventListener("click",l=>{const r=l.target,c=$(r,"b3-list-item");c&&this.addTags(c.textContent,e)});const o=this.iconElement.nextElementSibling.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+o.height}),s.focus()})}getTags(){const e=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(t=>{e.push(t.textContent.trim())}),e}addTags(e,t){window.siyuan.menus.menu.remove();const a=this.getTags();a.includes(e)||(a.push(e),_("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,t.block.rootID))}}class hn{constructor(e,t,a){this.version=p.Constants.SIYUAN_VERSION;const s=new Lv(a).merge();if(this.protyle={getInstance:()=>this,app:e,transactionTime:new Date().getTime(),id:ke(),disabled:!1,updated:!1,element:t,options:s,block:{}},this.protyle.hint=new vv(this.protyle),s.render.breadcrumb&&(this.protyle.breadcrumb=new eE(this.protyle)),s.render.title&&(this.protyle.title=new nE(this.protyle)),s.render.background&&(this.protyle.background=new aE(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),s.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Iw,this.protyle.wysiwyg=new Bv(this.protyle),this.protyle.toolbar=new Gv(this.protyle),this.protyle.scroll=new Cv(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new Zv(this.protyle)),(s.upload.url||s.upload.handler)&&(this.protyle.upload=new hw),this.init(),s.action.includes(p.Constants.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new sn({app:e,id:this.protyle.id,type:"protyle",msgCallback:o=>{switch(o.cmd){case"reload":o.data===this.protyle.block.rootID&&zn(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${o.data.id}"]`)).forEach(l=>{l.removeAttribute("data-render"),Ct(l,this.protyle)});break;case"addLoading":o.data===this.protyle.block.rootID&&os(this.protyle,o.msg);break;case"transactions":o.data[0].doOperations.forEach(l=>{!this.protyle.preview.element.classList.contains("fn__none")&&l.action!=="updateAttrs"?this.protyle.preview.render(this.protyle):ad(this.protyle,l,!1)});break;case"readonly":this.protyle.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_READONLY)||(o.data?Yn(this.protyle):cd(this.protyle));break;case"heading2doc":case"li2doc":this.protyle.block.rootID===o.data.srcRootBlockID&&(this.protyle.block.showAll&&o.cmd==="heading2doc"&&!this.protyle.options.backlinkData?_("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{dt({data:l,protyle:this.protyle})}):zn(this.protyle,!1),o.cmd==="heading2doc"&&ba({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!0,resize:!1}));break;case"rename":this.protyle.path===o.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(o.data.title),this.protyle.background&&(this.protyle.background.ial.title=o.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===o.data.id&&(getSelection().rangeCount>0&&this.protyle.title.editElement.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(o.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${o.data.id}"]`).forEach(l=>{l.getAttribute("data-subtype")==="d"&&(l.textContent=o.data.refText)});break;case"moveDoc":this.protyle.path===o.data.fromPath&&(this.protyle.path=o.data.newPath,this.protyle.notebookId=o.data.toNotebook);break;case"unmount":this.protyle.notebookId===o.data.box&&this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1,!1);break;case"removeDoc":o.data.ids.includes(this.protyle.block.rootID)&&this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1,!1);break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,Lp(this.protyle,a.backlinkData);return}if(!a.blockId){jl(this.protyle);return}a.scrollAttr?Rc({protyle:this.protyle,scrollAttr:a.scrollAttr,mergedOptions:s,cb:()=>{this.afterOnGet(s)}}):this.protyle.options.mode!=="preview"&&(s.action.includes(p.Constants.CB_GET_SCROLL)||s.action.includes(p.Constants.CB_GET_ROOTSCROLL))?_("/api/block/getDocInfo",{id:a.blockId},o=>{if(!s.action.includes(p.Constants.CB_GET_SCROLL)&&o.data.rootID!==a.blockId&&s.action.includes(p.Constants.CB_GET_ROOTSCROLL)){this.getDoc(s);return}let l;if(o.data.ial.scroll)try{l=JSON.parse(o.data.ial.scroll.replace(/&quot;/g,'"'))}catch(r){l=void 0}l?(l.rootId=o.data.rootID,Rc({protyle:this.protyle,scrollAttr:l,mergedOptions:s,cb:()=>{this.afterOnGet(s)}})):this.getDoc(s)}):this.getDoc(s)}}getDoc(e){var t;_("/api/filetree/getDoc",{id:e.blockId,isBacklink:e.action.includes(p.Constants.CB_GET_BACKLINK),mode:e.action&&e.action.includes(p.Constants.CB_GET_CONTEXT)?3:0,size:(t=e.action)!=null&&t.includes(p.Constants.CB_GET_ALL)?p.Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{dt({data:a,protyle:this.protyle,action:e.action,afterCB:()=>{this.afterOnGet(e)}})})}afterOnGet(e){var t;this.protyle.model&&((t=e.action)!=null&&t.includes(p.Constants.CB_GET_FOCUS)&&lt(this.protyle.model.element.parentElement.parentElement),ba({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})),Bt(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{if(this.protyle&&this.protyle.model){let a=!0;if(this.protyle.model.element.parentElement.parentElement.classList.contains("layout__wnd--active")&&this.protyle.model.headElement.classList.contains("item--focus")&&(a=!1),!a)return;lt(this.protyle.model.element.parentElement.parentElement),ba({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})}else document.querySelectorAll(".layout__tab--active").forEach(a=>{a.classList.remove("layout__tab--active")}),document.querySelectorAll(".layout__wnd--active").forEach(a=>{a.classList.remove("layout__wnd--active")})}),e.after&&e.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=Ev({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Sv(this.protyle),av(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){Mf(this.protyle)}resize(){Bt(this.protyle)}reload(e){zn(this.protyle,e)}insert(e,t=!1,a=!1){_t(e,this.protyle,t,a)}transaction(e,t){G(this.protyle,e,t)}}class gt extends sn{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.headElement=e.tab.headElement,this.element=e.tab.panelElement,this.initProtyle(e)}initProtyle(e){this.editor=new hn(this.app,this.element,{action:e.action||[],blockId:e.blockId,mode:e.mode,render:{title:!0,background:!0,scroll:!0},scrollAttr:e.scrollAttr,typewriterMode:!0,after:t=>{window.siyuan.editorIsFullscreen&&(t.protyle.element.classList.add("fullscreen"),Fh(t.protyle),Ye().editor.forEach(a=>{!t.protyle.element.isSameNode(a.element)&&a.element.classList.contains("fullscreen")&&(a.element.classList.remove("fullscreen"),Bt(a.editor.protyle))})),zt([],t.protyle.block.rootID)}}),this.editor.protyle.model=this}}class mi{constructor(e,t,a){this.children=[],this.removeTabAction=(l,r=!1,c=!0,u=!0)=>{if(wv(),this.children.find((d,f)=>{if(d.id===l){if(d.model instanceof wa&&d.model.beforeDestroy&&d.model.beforeDestroy(),d.model instanceof gt&&c&&qs(d.model.editor.protyle),this.children.length===1){this.destroyModel(this.children[0].model),this.children=[],["bottom","left","right"].includes(this.parent.type)?d.panelElement.remove():this.remove();const g=Ye().editor;g.length===0?ba({protyle:void 0,focus:!0,pushBackStack:!1,reload:!1,resize:!0}):g.forEach(h=>{if(!h.element.classList.contains("fn__none")){lt(h.parent.parent.headersElement.parentElement.parentElement),ba({protyle:h.editor.protyle,focus:!0,pushBackStack:!0,reload:!1,resize:!0});return}});return}if(d.headElement){if(d.headElement.classList.contains("item--focus")){let g;Array.from(d.headElement.parentElement.children).forEach(h=>{!h.isSameNode(d.headElement)&&h.style.maxWidth!=="0px"&&(g?h.getAttribute("data-activetime")>g.getAttribute("data-activetime")&&(g=h):g=h)}),g&&!r&&this.switchTab(g,!0,!0,!1)}u?(d.headElement.setAttribute("style","max-width: 0px;"),setTimeout(()=>{d.headElement.remove()},200)):d.headElement.remove()}return d.panelElement.remove(),this.destroyModel(d.model),this.children.splice(f,1),nn(),!0}}),window.siyuan.layout.centerLayout&&!bi(window.siyuan.layout.centerLayout)){const f=new mi(this.app);window.siyuan.layout.centerLayout.addWnd(f),f.addTab(vm(this.app))}},this.id=ke(),this.app=e,this.resize=t,this.element=document.createElement("div"),this.element.classList.add("fn__flex-1","fn__flex");let i='<div class="layout-tab-container__drag fn__none"></div>';(a==="left"||a==="right"||a==="bottom")&&(i=""),this.element.innerHTML=`<div data-type="wnd" data-id="${this.id}" class="fn__flex-column fn__flex fn__flex-1">
    <div class="fn__flex fn__none">
        <ul class="fn__flex layout-tab-bar"></ul>
        <ul class="layout-tab-bar layout-tab-bar--readonly fn__flex-1">
            <li class="item item--readonly">
                <span data-type="new" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newFile}"><svg><use xlink:href="#iconAdd"></use></svg></span>
                <span class="fn__flex-1"></span>
                <span data-type="more" data-menu="true" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.switchTab}"><svg><use xlink:href="#iconDown"></use></svg></span>
            </li>
        </ul>
    </div>
    <div class="layout-tab-container fn__flex-1">${i}</div>
</div>`,this.headersElement=this.element.querySelector(".layout-tab-bar");const s=this.element.querySelector(".layout-tab-container__drag");if(!s)return;this.headersElement.addEventListener("mousedown",l=>{if(l.button!==1)return;let r=l.target;for(;r&&!r.isEqualNode(this.headersElement);){if(r.tagName==="LI"){this.removeTab(r.getAttribute("data-id")),window.siyuan.menus.menu.remove(),l.stopPropagation(),l.preventDefault();break}r=r.parentElement}}),this.headersElement.addEventListener("mousewheel",l=>{this.headersElement.scrollLeft=this.headersElement.scrollLeft+l.deltaY},{passive:!0}),this.headersElement.parentElement.addEventListener("click",l=>{let r=l.target;for(;r&&!r.isEqualNode(this.headersElement);){if(r.classList.contains("block__icon")&&r.getAttribute("data-type")==="new"){lt(this.headersElement.parentElement.parentElement),Xa({app:e,useSavePath:!0});break}else if(r.classList.contains("block__icon")&&r.getAttribute("data-type")==="more"){this.renderTabList(r);break}else if(r.tagName==="LI"&&r.getAttribute("data-id")&&!wi(this.element)){this.switchTab(r,!0);break}r=r.parentElement}}),this.headersElement.parentElement.addEventListener("dblclick",l=>{let r=l.target;for(;r&&!r.isEqualNode(this.headersElement);){if(window.siyuan.config.fileTree.openFilesUseCurrentTab&&r.getAttribute("data-type")==="tab-header"){r.classList.remove("item--unupdate");break}r=r.parentElement}}),this.headersElement.parentElement.addEventListener("dragover",function(l){const r=this;if(l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_FILE)){l.preventDefault(),r.classList.add("layout-tab-bars--drag");return}if(!l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_TAB))return;l.preventDefault();let c=window.siyuan.dragElement,u=!1;if(Array.from(r.firstElementChild.childNodes).find(f=>{if(f.style.opacity==="0.1")return c=f,u=!0,!0}),!u&&c){if(c.classList.contains("item--pin"))return;c=c.cloneNode(!0),c.setAttribute("data-clone","true"),r.firstElementChild.append(c);return}else!u&&!c&&(c=document.createElement("li"),c.style.opacity="0.1",c.innerHTML='<svg class="svg"><use xlink:href="#iconFile"></use></svg>',c.setAttribute("data-clone","true"),r.firstElementChild.append(c));const d=S(l.target,"data-type","tab-header");if(!d){c.classList.contains("item--pin")||r.classList.add("layout-tab-bars--drag");return}if(!d.isSameNode(c)&&(c.classList.contains("item--pin")&&d.classList.contains("item--pin")||!c.classList.contains("item--pin")&&!d.classList.contains("item--pin"))){const f=d.getClientRects()[0];l.clientX>f.left+f.width/2?d.after(c):d.before(c)}});let o;this.headersElement.parentElement.addEventListener("dragleave",function(){clearTimeout(o),o=window.setTimeout(()=>{document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(r=>{r.remove()})},1e3),this.classList.remove("layout-tab-bars--drag")}),this.headersElement.parentElement.addEventListener("drop",function(l){var r;const c=this;if(l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_FILE)){lt(c.parentElement),l.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE).split(",").forEach(m=>{m&&be({app:e,id:m,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]})}),window.siyuan.dragElement=void 0,c.classList.remove("layout-tab-bars--drag");return}const u=JSON.parse(l.dataTransfer.getData(p.Constants.SIYUAN_DROP_TAB));let d=St(u.id);const f=St(c.parentElement.getAttribute("data-id"));if(c.classList.remove("layout-tab-bars--drag"),!d)return;const g=(r=Array.from(c.firstElementChild.childNodes).find(m=>{if(m.style.opacity==="0.1")return!0}))==null?void 0:r.nextElementSibling;if(!c.contains(d.headElement)){const m=c.querySelector("[data-clone='true']");if(!m)return;if(m.before(d.headElement),m.remove(),d.model instanceof Gn){const b=d.model.element.querySelector("#viewerContainer");b&&b.setAttribute("data-scrolltop",b.scrollTop.toString())}f.moveTab(d,g?g.getAttribute("data-id"):void 0),nn();return}let h;d.parent.children.find((m,b)=>{if(m.id===d.id)return h=d.parent.children.splice(b,1)[0],!0}),g?d.parent.children.find((m,b)=>{if(m.id===g.getAttribute("data-id"))return d.parent.children.splice(b,0,h),!0}):d.parent.children.push(h)}),this.element.addEventListener("dragenter",l=>{if(l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_TAB)){if($(l.target,"layout-tab-bar"))return;$(l.target,"layout-tab-container",!0)&&(s.classList.remove("fn__none"),s.setAttribute("style","height:100%;width:100%;right:auto;bottom:auto"))}}),s.addEventListener("dragover",l=>{if(l.preventDefault(),!s.nextElementSibling)return;const r=s.parentElement.getBoundingClientRect(),c=r.height,u=r.width,d=l.clientX-r.left,f=l.clientY-r.top;d<=u/3&&(f<=c/8||f>=c*7/8)||d<=u/8&&(f>c/8||f<c*7/8)?s.setAttribute("style","height:100%;width:50%;right:50%;bottom:0;left:0;top:0"):d>u*2/3&&(f<=c/8||f>=c*7/8)||d>=u*7/8&&(f>c/8||f<c*7/8)?s.setAttribute("style","height:100%;width:50%;right:0;bottom:0;left:50%;top:0"):d>u/3&&d<u*2/3&&f<=c/8?s.setAttribute("style","height:50%;width:100%;right:0;bottom:50%;left:0;top:0"):d>u/3&&d<u*2/3&&f>=c*7/8?s.setAttribute("style","height:50%;width:100%;right:0;bottom:0;left:0;top:50%"):s.setAttribute("style","height:100%;width:100%;right:0;bottom:0;top:0;left:0")}),s.addEventListener("dragleave",()=>{s.classList.add("fn__none")}),s.addEventListener("drop",l=>{s.classList.add("fn__none");const r=l.target.parentElement.parentElement,c=St(r.getAttribute("data-id")),u=JSON.parse(l.dataTransfer.getData(p.Constants.SIYUAN_DROP_TAB));let d=St(u.id);if(d){if(d.model instanceof Gn){const f=d.model.element.querySelector("#viewerContainer");f&&f.setAttribute("data-scrolltop",f.scrollTop.toString())}if(s.style.height==="50%"||s.style.width==="50%"){if(s.style.height==="50%"){const f=c.split("tb");f.headersElement.append(d.headElement),f.headersElement.parentElement.classList.remove("fn__none"),f.moveTab(d),s.style.bottom==="50%"&&f.element.previousElementSibling&&c.element.parentElement&&nu(f,c)}else if(s.style.width==="50%"){const f=c.split("lr");f.headersElement.append(d.headElement),f.headersElement.parentElement.classList.remove("fn__none"),f.moveTab(d),s.style.right==="50%"&&f.element.previousElementSibling&&c.element.parentElement&&nu(f,c)}nn();return}r.contains(document.querySelector(`[data-id="${u.id}"]`))||c&&(c.headersElement.append(d.headElement),c.headersElement.parentElement.classList.remove("fn__none"),c.moveTab(d),nn())}})}showHeading(){const e=this.headersElement.querySelector(".item--focus");e&&(e.offsetLeft+e.clientWidth>this.headersElement.scrollLeft+this.headersElement.clientWidth?this.headersElement.scrollLeft=e.offsetLeft+e.clientWidth-this.headersElement.clientWidth:e.offsetLeft<this.headersElement.scrollLeft&&(this.headersElement.scrollLeft=e.offsetLeft))}switchTab(e,t=!1,a=!0,i=!0){lt(this.headersElement.parentElement.parentElement);let s;if(this.children.forEach(o=>{var l;e===o.headElement?(o.headElement&&o.headElement.classList.contains("fn__none")||(o.headElement&&(o.headElement.classList.add("item--focus"),o.headElement.setAttribute("data-activetime",new Date().getTime().toString())),o.panelElement.classList.remove("fn__none")),s=o):((l=o.headElement)==null||l.classList.remove("item--focus"),o.panelElement.classList.contains("fn__none")||o.panelElement.classList.add("fn__none"))}),s&&s.headElement){const o=s.headElement.getAttribute("data-initdata");if(o){s.addModel(ym(this.app,s,JSON.parse(o))),s.headElement.removeAttribute("data-initdata");return}}if(s&&e===s.headElement&&(s.model instanceof Kn?s.model.onGraph(!1):s.model instanceof Gn&&s.model.pdfObject&&s.model.pdfObject.pdfViewer&&s.model.pdfObject.pdfViewer.container.focus()),s&&s.model instanceof gt){const o=s.headElement.getAttribute("keep-cursor");if(o){let l;if(Array.from(s.model.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${o}"]`)).find(r=>{if(!S(r,"data-type","NodeBlockQueryEmbed",!0))return l=r,!0}),l){if(!s.model.editor.protyle.toolbar.range){const r=document.createRange();r.selectNodeContents(l),r.collapse(),s.model.editor.protyle.toolbar.range=r}Ge(s.model.editor.protyle,l,!0)}else be({app:this.app,id:o,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL]});s.headElement.removeAttribute("keep-cursor")}a&&ba({protyle:s.model.editor.protyle,focus:!0,pushBackStack:t,reload:!1,resize:i})}else ba({protyle:void 0,focus:!1,pushBackStack:!1,reload:!1,resize:i})}addTab(e,t=!1){var a;t&&((a=e.headElement)==null||a.classList.remove("item--focus"),e.panelElement.classList.add("fn__none"));let i=0;this.children.forEach((o,l)=>{var r;if(o.headElement&&o.headElement.classList.contains("item--focus")){i=l;let c=o.headElement.nextElementSibling;for(;c&&c.classList.contains("item--pin");)i++,c=c.nextElementSibling}t||((r=o.headElement)==null||r.classList.remove("item--focus"),o.panelElement.classList.add("fn__none"))}),this.children.splice(i+1,0,e),e.headElement&&(this.headersElement.parentElement.classList.remove("fn__none"),this.headersElement.childElementCount===0?this.headersElement.append(e.headElement):this.headersElement.children[i].after(e.headElement),e.headElement.querySelector(".item__close").addEventListener("click",o=>{e.headElement.classList.contains("item--pin")?e.unpin():e.parent.removeTab(e.id),window.siyuan.menus.menu.remove(),o.stopPropagation(),o.preventDefault()}),e.headElement.setAttribute("data-activetime",new Date().getTime().toString()));const s=this.element.querySelector(".layout-tab-container");s.querySelector(".fn__flex-1")?s.querySelector(".layout-tab-container__drag")?s.children[i+1].after(e.panelElement):s.children[i].after(e.panelElement):s.append(e.panelElement),e.parent=this,e.callback&&e.callback(e),this.parent.type==="center"&&this.children.length===2&&!this.children[0].headElement?this.removeTab(this.children[0].id):this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(i)}renderTabList(e){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tabList"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),Array.from(this.headersElement.children).forEach(a=>{var i;const s=a.querySelector(".item__icon"),o=a.querySelector(".item__graphic");let l;s?((i=s.firstElementChild)==null?void 0:i.tagName)==="IMG"?l=`<img src="${s.firstElementChild.getAttribute("src")}"  class="b3-menu__icon">`:l=`<span class="b3-menu__icon">${s.innerHTML}</span>`:o||(l=fe(p.Constants.SIYUAN_IMAGE_FILE,"b3-menu__icon",!0)),window.siyuan.menus.menu.append(new I({label:De(a.querySelector(".item__text").textContent),action:"iconCloseRound",iconHTML:l,icon:o?o.firstElementChild.getAttribute("xlink:href").substring(1):"",bind:r=>{r.addEventListener("click",c=>{$(c.target,"b3-menu__action")?(this.removeTab(a.getAttribute("data-id")),r.previousElementSibling||r.nextElementSibling?r.remove():window.siyuan.menus.menu.remove()):(this.switchTab(a,!0),this.showHeading(),window.siyuan.menus.menu.remove()),c.preventDefault(),c.stopPropagation()})},current:a.classList.contains("item--focus")}).element)}),window.siyuan.menus.menu.element.setAttribute("data-name","tabList");const t=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:t.left+t.width,y:t.top+t.height,isLeft:!0})}removeOverCounter(e){typeof e=="undefined"&&this.children.forEach((i,s)=>{i.headElement&&i.headElement.classList.contains("item--focus")&&(e=s)});let t,a;this.children.forEach((i,s)=>{i.headElement.classList.contains("item--pin")||i.headElement.classList.contains("item--focus")||s===e||(a?i.headElement.getAttribute("data-activetime")<a&&(a=i.headElement.getAttribute("data-activetime"),t=this.children[s].id):(a=i.headElement.getAttribute("data-activetime"),t=this.children[s].id))}),t&&this.removeTab(t)}destroyModel(e){if(e){if(e instanceof gt&&e.editor){window.siyuan.blockPanels.forEach(t=>{t.element&&e.editor.protyle.wysiwyg.element.contains(t.element)&&t.destroy()}),e.editor.destroy();return}if(e instanceof Oa){e.edit&&e.edit.destroy();return}e instanceof Gn&&e.pdfObject&&e.pdfObject.pdfLoadingTask&&e.pdfObject.pdfLoadingTask.destroy(),e instanceof wa&&e.destroy&&e.destroy(),e.send("closews",{})}}removeTab(e,t=!1,a=!0,i=!0){var s;for(let o=0;o<this.children.length;o++){const l=this.children[o];if(l.id===e){if(l.model instanceof gt&&((s=l.model.editor)!=null&&s.protyle)){if(l.model.editor.protyle.upload.isUploading){q(window.siyuan.languages.uploading);return}this.removeTabAction(e,t,a,i)}else this.removeTabAction(e,t,a,i);return}}}moveTab(e,t){let a;if(e.model instanceof gt&&e.model.editor.protyle.toolbar.range){const s=M(e.model.editor.protyle.toolbar.range.startContainer);if(s){const o=Et(s,void 0,e.model.editor.protyle.toolbar.range);a={id:s.getAttribute("data-node-id"),start:o.start,end:o.end}}}if(this.element.querySelector(".layout-tab-container").append(e.panelElement),a&&e.model instanceof gt){const s=Fn(e.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${a.id}"]`),a.start,a.end);s&&(e.model.editor.protyle.toolbar.range=s)}t?this.children.find((s,o)=>{if(s.id===t)return this.children.splice(o,0,e),!0}):this.children.push(e),this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(),this.switchTab(e.headElement);const i=e.parent;if(i.children.length===1)i.children=[],i.remove();else if(i.children.find((s,o)=>{if(s.id===e.id)return i.children.splice(o,1),nn(),!0}),!i.headersElement.querySelector(".item--focus")){let s;Array.from(i.headersElement.children).forEach(o=>{s?o.getAttribute("data-activetime")>s.getAttribute("data-activetime")&&(s=o):s=o}),s&&i.switchTab(s,!0)}e.parent=this,Oi(["toolbar"])}split(e){if(this.children.length===1&&!this.children[0].headElement)return this;const t=new mi(this.app,e);return e===this.parent.direction?this.parent.addWnd(t,this.id):this.parent.children.length===1?(this.parent.direction=e,e==="tb"?(this.parent.element.classList.add("fn__flex-column"),this.parent.element.classList.remove("fn__flex")):(this.parent.element.classList.remove("fn__flex-column"),this.parent.element.classList.add("fn__flex")),this.parent.addWnd(t,this.id)):this.parent.children.find((a,i)=>{if(a.id===this.id){const s=new Te({resize:a.resize,direction:e});this.parent.addLayout(s,a.id);const o=this.parent.children.splice(i,1)[0];return o.resize&&(o.element.previousElementSibling.remove(),o.resize=void 0),s.addWnd.call(s,o),s.addWnd.call(s,t),e==="tb"&&o.element.style.width?(s.element.style.width=o.element.style.width,s.element.classList.remove("fn__flex-1"),o.element.style.width="",o.element.classList.add("fn__flex-1")):e==="lr"&&o.element.style.height&&(s.element.style.height=o.element.style.height,s.element.classList.remove("fn__flex-1"),o.element.style.height="",o.element.classList.add("fn__flex-1")),!0}}),t}remove(){let e=this.parent,t=this.element,a=this.id;for(;e&&e.children.length===1&&e.type!=="center";)a=e.id,t=e.element,e=e.parent;e.children.find((i,s)=>{if(i.id===a){if(e.children.length>1){let o=e.children[s-1];s===0&&(o=e.children[1]),e.children.length===2?(e.direction==="lr"?o.element.style.width="":o.element.style.height="",o.resize=void 0,o.element.classList.add("fn__flex-1")):o.element.classList.contains("fn__flex-1")||(e.direction==="lr"?o.element.style.width=o.element.clientWidth+t.clientWidth+"px":o.element.style.height=o.element.clientHeight+t.clientHeight+"px"),e.children.length>2&&s===0&&(e.children[1].resize=void 0)}return e.children.splice(s,1),!0}}),t.previousElementSibling&&t.previousElementSibling.classList.contains("layout__resize")?t.previousElementSibling.remove():t.nextElementSibling&&t.nextElementSibling.classList.contains("layout__resize")&&t.nextElementSibling.remove(),t.remove(),nn()}}class iE extends sn{constructor(e,t){super({app:e,id:t.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},t instanceof Element?this.element=t:this.element=t.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__inbox"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconInbox"></use></svg>
        ${window.siyuan.languages.inbox}&nbsp;
         <span class="inboxSelectCount"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="block__icon" data-type="selectall" type="checkbox">  
    <span class="fn__space"></span>
    <span data-type="previous" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="next" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="more" data-menu="true" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href='#iconMore'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.min} ${ae(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),i=this.element.querySelector(".inboxDetails"),s=this.element.firstElementChild.querySelector("input");this.element.addEventListener("click",o=>{lt(this.element);let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){o.stopPropagation();break}const r=l.getAttribute("data-type");if(r==="min"){At("inbox").toggleModel("inbox"),o.preventDefault();break}else if(r==="selectall"){l.checked?this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("input").checked=!0,this.selectIds.push(c.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}):this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("input").checked=!1,this.selectIds.splice(this.selectIds.indexOf(c.getAttribute("data-id")),1)}),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="select"){l.firstElementChild.nextElementSibling.checked?(this.selectIds.push(l.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]):this.selectIds.splice(this.selectIds.indexOf(l.parentElement.getAttribute("data-id")),1),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,s.checked=this.element.lastElementChild.querySelectorAll("input:checked").length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length,window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="previous"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),o.preventDefault();break}else if(r==="next"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),o.preventDefault();break}else if(r==="back"){this.back(),o.preventDefault();break}else if(r==="more"){this.more(o),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")){const c=this.data[l.getAttribute("data-id")];s.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),i.innerHTML=this.genDetail(c),i.setAttribute("data-id",c.oId),i.classList.remove("fn__none"),i.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),o.preventDefault();break}l=l.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector("input").classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(e){let t="";return e.shorthandURL&&(t=`<span class="fn__space"></span><a href="${e.shorthandURL}" target="_blank" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.link}">
        <svg><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="block__icons">
    <div class="block__logo fn__pointer fn__flex-1" data-type="back">
        <svg><use xlink:href="#iconLeft"></use></svg><span class="ft__breakword">${e.shorthandTitle}</span>
    </div>
    ${t}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px;user-select: text">
${Lute.New().MarkdownStr("",e.shorthandContent)}
</div>`}more(e){const t=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{t.classList.contains("fn__none")?(this.currentPage=1,this.update()):_("/api/inbox/getShorthand",{id:t.getAttribute("data-id")},i=>{t.innerHTML=this.genDetail(i.data),t.scrollTop=0})}}).element);let a=[];t.classList.contains("fn__none")?a=this.selectIds:a=[t.getAttribute("data-id")],a.length>0&&(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(a)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete+"?",()=>{t.classList.contains("fn__none")?this.remove():this.remove(t.getAttribute("data-id"))})}}).element)),window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}remove(e){let t;e?t=[e]:t=this.selectIds,_("/api/inbox/removeShorthands",{ids:t},()=>{e?(this.back(),this.selectIds.find((a,i)=>{if(a===e)return this.selectIds.splice(i,1),!0})):this.selectIds=[],this.currentPage=1,this.update()})}move(e){ya((t,a)=>{e.forEach(i=>{_("/api/filetree/createDoc",{notebook:a[0],path:xe().join(pt(t[0],!1,!0),Lute.NewNodeID()+".sy"),title:on(this.data[i].shorthandTitle),md:this.data[i].shorthandContent},()=>{this.remove(i)})})})}update(){const e=this.element.querySelector(".fn__loading");if(sa("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",qt("subscribe/siyuan"))}
    </li>
</ul>`,e.classList.add("fn__none");return}e.classList.contains("fn__none")&&(e.classList.remove("fn__none"),_("/api/inbox/getShorthands",{page:this.currentPage},t=>{e.classList.add("fn__none");let a="";t.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',t.data.data.shorthands.forEach(l=>{a+=`<li style="padding-left: 0" data-id="${l.oId}" class="b3-list-item">
    <label data-type="select" class="fn__flex">
        <span class="fn__space"></span>
        <input class="fn__flex-center" type="checkbox"${this.selectIds.includes(l.oId)?" checked":""}>
        <span class="fn__space"></span>
    </label>
    <span class="b3-list-item__text" title="${l.shorthandTitle}${l.shorthandTitle===l.shorthandDesc?"":`
`+l.shorthandDesc}">${l.shorthandTitle}</span>
    <span class="b3-list-item__meta">${l.hCreated}</span>
</li>`,this.data[l.oId]=l}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=t.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const i=this.element.querySelector('[data-type="previous"]'),s=this.element.querySelector('[data-type="next"]');t.data.data.pagination.paginationPageCount>this.currentPage?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),this.currentPage===1?i.setAttribute("disabled","disabled"):i.removeAttribute("disabled");const o=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector("input").checked=this.element.lastElementChild.querySelectorAll("input:checked").length===o&&o!==0,this.element.lastElementChild.scrollTop=0}))}}const Xd=["file","outline","inbox","bookmark","tag","graph","globalGraph","backlink"];class Jd{constructor(e){switch(this.pin=!0,e.position){case"Left":this.layout=window.siyuan.layout.layout.children[0].children[0],this.resizeElement=this.layout.element.nextElementSibling,this.layout.element.classList.add("layout__dockl"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Right":this.layout=window.siyuan.layout.layout.children[0].children[2],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockr"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Bottom":this.layout=window.siyuan.layout.layout.children[1],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockb"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize"></div>');break}this.app=e.app,this.element=document.getElementById("dock"+e.position);const t=e.position==="Bottom"?' class="fn__flex"':"";this.element.innerHTML=`<div${t}></div><div class="fn__flex-1"></div><div${t}></div>`,this.position=e.position,this.pin=e.data.pin,this.data={};let a=!1;e.data.data.length!==0&&(a||e.data.data[0].find(s=>{if(Xd.includes(s.type))return a=!0,!0}),!a&&e.data.data[1]&&e.data.data[1].find(s=>{if(Xd.includes(s.type))return a=!0,!0})),a?(this.genButton(e.data.data[0],0),e.data.data[1]&&this.genButton(e.data.data[1],1),this.element.classList.remove("fn__none")):(this.element.firstElementChild.innerHTML=`<span class="dock__item dock__item--pin b3-tooltips b3-tooltips__${this.getClassDirect(0)}" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#iconPin"></use></svg>
</span>`,this.element.classList.add("fn__none"));const i=this.element.querySelectorAll(".dock__item--active");this.element.querySelectorAll(".dock__item").forEach(s=>{s.getAttribute("data-type")==="file"&&!s.classList.contains("dock__item--active")&&(this.toggleModel("file",!0),this.toggleModel("file"))}),i.length===0?this.resizeElement.classList.add("fn__none"):i.forEach(s=>{this.toggleModel(s.getAttribute("data-type"),!0)}),this.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isEqualNode(this.element);){const l=o.getAttribute("data-type");if(l){this.toggleModel(l,!1,!0),s.preventDefault();break}else if(o.classList.contains("dock__item")){this.togglePin(),o.setAttribute("aria-label",this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin),s.preventDefault();break}o=o.parentElement}}),this.layout.element.addEventListener("mouseleave",s=>{var o;s.buttons!==0||this.pin||(o=s.toElement)!=null&&o.classList.contains("b3-menu")||this.position==="Left"&&s.clientX<43||this.position==="Right"&&s.clientX>window.innerWidth-43||this.position==="Bottom"&&s.clientY>window.innerHeight-73||this.hideDock()}),this.layout.element.querySelector(".layout__dockresize").addEventListener("mousedown",s=>{const o=document,l=this.position==="Bottom"?"tb":"lr",r=s[l==="lr"?"clientX":"clientY"],c=l==="lr"?this.layout.element.clientWidth:this.layout.element.clientHeight;o.onmousemove=u=>{u.preventDefault(),u.stopPropagation();let d;this.position==="Left"?d=c+(u.clientX-r):this.position==="Right"?d=c+(r-u.clientX):d=c+(r-u.clientY);let f=227;Array.from(this.layout.element.querySelectorAll(".file-tree")).find(g=>{if((g.classList.contains("sy__backlink")||g.classList.contains("sy__graph")||g.classList.contains("sy__globalGraph")||g.classList.contains("sy__inbox"))&&!g.classList.contains("fn__none")&&!$(g,"fn__none"))return f=320,!0}),!(d<f&&l==="lr")&&(d<64&&l==="tb"||(this.layout.element.style[l==="lr"?"width":"height"]=d+"px"))},o.onmouseup=()=>{o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,this.setSize()}}),window.siyuan.config.uiLayout.hideDock&&this.element.classList.add("fn__none"),this.pin||setTimeout(()=>{this.resetDockPosition(!1),this.hideDock(!0),this.layout.element.classList.add("layout--float"),this.resizeElement.classList.add("fn__none")})}togglePin(){this.pin=!this.pin;const e=this.element.querySelector(".dock__item--active");this.pin?(this.layout.element.style.opacity="",this.layout.element.style.transform="",this.layout.element.style.zIndex="",e&&this.resizeElement.classList.remove("fn__none")):(this.resetDockPosition(!!e),this.resizeElement.classList.add("fn__none"),e?this.showDock(!0):this.hideDock(!0)),this.layout.element.classList.toggle("layout--float"),nn()}resetDockPosition(e){this.position==="Left"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.position==="Right"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.layout.element.setAttribute("style",`height:${this.layout.element.clientHeight}px;opacity:${e?1:0};`)}showDock(e=!1){!e&&(this.pin||!this.element.querySelector(".dock__item--active")||this.layout.element.style.opacity==="1")||!e&&(this.position==="Left"||this.position==="Right")&&this.layout.element.clientWidth===0&&this.layout.element.style.width.startsWith("0")||!e&&this.position==="Bottom"&&this.layout.element.clientHeight===0&&this.layout.element.style.height.startsWith("0")||(e||(this.layout.element.style.opacity="1"),this.layout.element.style.transform="",this.layout.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.position==="Left"?this.layout.element.style.left=`${this.element.clientWidth}px`:this.position==="Right"?this.layout.element.style.right=`${this.element.clientWidth}px`:this.position==="Bottom"&&(this.layout.element.style.bottom=`${this.element.offsetHeight+document.getElementById("status").offsetHeight}px`))}hideDock(e=!1){var t,a;!e&&(this.layout.element.style.opacity==="0"||this.pin)||this.layout.element.querySelector(".fullscreen")||document.activeElement&&this.layout.element.contains(document.activeElement)&&document.activeElement.classList.contains("b3-text-field")||(this.position==="Left"?(this.layout.element.style.transform=`translateX(-${this.layout.element.clientWidth+8}px)`,this.layout.element.style.left=""):this.position==="Right"?(this.layout.element.style.transform=`translateX(${this.layout.element.clientWidth+8}px)`,this.layout.element.style.right=""):this.position==="Bottom"&&(this.layout.element.style.transform=`translateY(${this.layout.element.clientHeight+8}px)`,this.layout.element.style.bottom=""),!e&&(this.layout.element.style.opacity="0",(t=this.element.querySelector(".dock__item--activefocus"))==null||t.classList.remove("dock__item--activefocus"),(a=this.layout.element.querySelector(".layout__tab--active"))==null||a.classList.remove("layout__tab--active")))}toggleModel(e,t=!1,a=!1,i=!1){if(!e)return;const s=this.element.querySelector(`[data-type="${e}"]`);t&&s.classList.contains("dock__item--active")&&s.classList.remove("dock__item--active","dock__item--activefocus");const o=parseInt(s.getAttribute("data-index")),l=this.layout.children[o];if(s.classList.contains("dock__item--active")||i){if(!a){let f=!1;if(Array.from(l.element.querySelector(".layout-tab-container").children).find(g=>{if(g.getAttribute("data-id")===s.getAttribute("data-id"))return g.classList.contains("layout__tab--active")||(lt(g),f=!0),!0}),f){document.activeElement&&document.activeElement.blur(),this.showDock();return}}if(s.classList.remove("dock__item--active","dock__item--activefocus"),this.element.querySelectorAll(".dock__item--active").length===0&&(this.position==="Left"||this.position==="Right"?this.layout.element.style.width="0px":this.layout.element.style.height="0px",document.querySelector("body").classList.contains("body--win32")&&document.getElementById("drag").classList.remove("fn__hidden"),this.resizeElement.classList.add("fn__none"),this.hideDock()),!document.querySelector(".layout__center .layout__wnd--active")){const f=document.querySelector(".layout__center .layout-tab-bar .item--focus");f&&Zn().find(g=>{if(g.id===f.getAttribute("data-id"))return g.parent.switchTab(g.headElement),!0})}}else{if(this.element.querySelectorAll(`.dock__item--active[data-index="${o}"]`).forEach(f=>{f.classList.remove("dock__item--active","dock__item--activefocus")}),s.classList.add("dock__item--active","dock__item--activefocus"),s.getAttribute("data-id"))Array.from(l.element.querySelector(".layout-tab-container").children).forEach(f=>{f.getAttribute("data-id")===s.getAttribute("data-id")?(f.classList.remove("fn__none"),lt(f)):f.classList.add("fn__none")});else{let f;Ye().editor.find(m=>{var b,y;if(m.parent.headElement.classList.contains("item--focus")&&((y=(b=m.editor)==null?void 0:b.protyle)!=null&&y.path))return f=m.editor,!0});let h;switch(e){case"file":h=new ht({callback:m=>{m.addModel(new ha({tab:m,app:this.app}))}});break;case"bookmark":h=new ht({callback:m=>{m.addModel(new fi(this.app,m))}});break;case"tag":h=new ht({callback:m=>{m.addModel(new pi(this.app,m))}});break;case"outline":h=new ht({callback:m=>{var b,y,w,E,k,L,v,A;const C=new Ha({app:this.app,type:"pin",tab:m,blockId:(y=(b=f==null?void 0:f.protyle)==null?void 0:b.block)==null?void 0:y.rootID,isPreview:!((E=(w=f==null?void 0:f.protyle)==null?void 0:w.preview)!=null&&E.element.classList.contains("fn__none"))});(L=(k=f==null?void 0:f.protyle)==null?void 0:k.title)!=null&&L.editElement&&C.updateDocTitle((A=(v=f.protyle)==null?void 0:v.background)==null?void 0:A.ial),m.addModel(C)}});break;case"graph":h=new ht({callback:m=>{var b,y;m.addModel(new Kn({app:this.app,tab:m,blockId:(y=(b=f==null?void 0:f.protyle)==null?void 0:b.block)==null?void 0:y.rootID,type:"pin"}))}});break;case"globalGraph":h=new ht({callback:m=>{m.addModel(new Kn({app:this.app,tab:m,type:"global"}))}});break;case"backlink":h=new ht({callback:m=>{var b,y;m.addModel(new Ba({app:this.app,type:"pin",tab:m,blockId:(y=(b=f==null?void 0:f.protyle)==null?void 0:b.block)==null?void 0:y.rootID}))}});break;case"inbox":h=new ht({callback:m=>{m.addModel(new iE(this.app,m))}});break;default:h=new ht({callback:m=>{let b;this.app.plugins.find(y=>{if(y.docks[e])return b=y.docks[e].model({tab:m}),!0}),b&&m.addModel(b)}});break}l.addTab(h),s.setAttribute("data-id",h.id),this.data[e]=h.model,lt(h.panelElement)}this.position==="Left"||this.position==="Right"?this.layout.element.style.width=this.getMaxSize()+"px":this.layout.element.style.height=this.getMaxSize()+"px",(e==="graph"||e==="globalGraph")&&document.querySelector("body").classList.contains("body--win32")&&this.layout.element.querySelector(".fullscreen")&&document.getElementById("drag").classList.add("fn__hidden"),this.pin&&(this.layout.element.style.opacity="",setTimeout(()=>{this.resizeElement.classList.remove("fn__none")},200)),document.activeElement&&document.activeElement.blur()}const r=o===0?1:0,c=this.layout.children[r],u=this.element.querySelectorAll(`.dock__item--active[data-index="${r}"]`).length>0,d=this.element.querySelectorAll(`.dock__item--active[data-index="${o}"]`).length>0;if(d&&u){let f=l;r===0?c.element.nextElementSibling.classList.remove("fn__none"):(f=c,c.element.previousElementSibling.classList.remove("fn__none"));const g=this.element.querySelector('.dock__item--active[data-index="1"]');if(this.position==="Left"||this.position==="Right"){const h=parseInt(g.getAttribute("data-height"));h!==0&&!isNaN(h)&&(f.element.style.height=h+"px",f.element.classList.remove("fn__flex-1"))}else{const h=parseInt(g.getAttribute("data-width"));h!==0&&!isNaN(h)&&(f.element.style.width=h+"px",f.element.classList.remove("fn__flex-1"))}}else r===0?c.element.nextElementSibling.classList.add("fn__none"):c.element.previousElementSibling.classList.add("fn__none");u?c.element.classList.remove("fn__none"):c.element.classList.add("fn__none"),d?l.element.classList.remove("fn__none"):l.element.classList.add("fn__none"),d&&!u?(l.element.classList.add("fn__flex-1"),l.element.style.height="",l.element.style.width=""):!d&&u&&(c.element.classList.add("fn__flex-1"),c.element.style.height="",c.element.style.width=""),nn(),this.showDock()}add(e,t){t.setAttribute("data-height",""),t.setAttribute("data-width","");const a=t.getAttribute("data-type"),i=At(a);i.element.querySelectorAll(".dock__item").length===2&&i.element.classList.add("fn__none");const s=i.layout.children[parseInt(t.getAttribute("data-index"))];t.getAttribute("data-id")&&(s.removeTab(t.getAttribute("data-id")),t.removeAttribute("data-id"));const l=t.classList.contains("dock__item--active");l&&i.toggleModel(a),delete i.data[a],t.classList.remove("b3-tooltips__n","b3-tooltips__ne","b3-tooltips__nw","b3-tooltips__s","b3-tooltips__se","b3-tooltips__sw","b3-tooltips__e","b3-tooltips__w"),t.classList.add(`b3-tooltips__${this.getClassDirect(e)}`),t.setAttribute("data-index",e.toString()),e===0?this.element.firstElementChild.insertAdjacentElement("afterbegin",t):this.element.lastElementChild.insertAdjacentElement("afterbegin",t),this.element.classList.remove("fn__none"),ud(),this.data[a]=!0,l&&this.toggleModel(a,!0)}remove(e){this.toggleModel(e,!1,!0,!0),this.element.querySelector(`[data-type="${e}"]`).remove();const t=this.data[e];t.parent&&t.parent.parent.removeTab(t.parent.id),delete this.data[e]}getClassDirect(e){let t="e";switch(this.position){case"Right":t="w";break;case"Bottom":e===0?t="ne":t="nw";break}return t}setSize(){const e=this.element.querySelectorAll(".dock__item--active");e.forEach(t=>{this.position==="Left"||this.position==="Right"?(t.getAttribute("data-index")==="1"&&e.length>1&&t.setAttribute("data-height",this.data[t.getAttribute("data-type")].parent.parent.element.clientHeight.toString()),t.setAttribute("data-width",this.layout.element.clientWidth.toString())):(t.getAttribute("data-index")==="1"&&e.length>1&&t.setAttribute("data-width",this.data[t.getAttribute("data-type")].parent.parent.element.clientWidth.toString()),t.setAttribute("data-height",this.layout.element.clientHeight.toString()))})}getMaxSize(){let e=0;return this.element.querySelectorAll(".dock__item--active").forEach(t=>{let a;this.position==="Left"||this.position==="Right"?a=parseInt(t.getAttribute("data-width"))||(["graph","globalGraph","backlink"].includes(t.getAttribute("data-type"))?320:227):a=parseInt(t.getAttribute("data-height"))||227,a>e&&(e=a)}),e}genButton(e,t,a){let i="";e.forEach(s=>{typeof a=="undefined"&&!Xd.includes(s.type)||(i+=`<span data-height="${s.size.height}" data-width="${s.size.width}" data-type="${s.type}" data-index="${t}" data-hotkey="${s.hotkey||""}" data-hotkeyLangId="${s.hotkeyLangId||""}" data-title="${s.title}" class="dock__item${s.show?" dock__item--active":""} b3-tooltips b3-tooltips__${this.getClassDirect(t)}" aria-label="${s.title} ${s.hotkey?ae(s.hotkey):""}${window.siyuan.languages.dockTip}">
    <svg><use xlink:href="#${s.icon}"></use></svg>
</span>`,this.data[s.type]=!0)}),t===0?typeof a=="number"?this.element.firstElementChild.children[a]?this.element.firstElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.lastElementChild.insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.innerHTML=`${i}<span class="dock__item dock__item--pin b3-tooltips b3-tooltips__${this.getClassDirect(t)}" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#iconPin"></use></svg>
</span>`:typeof a=="number"?this.element.lastElementChild.children[a]?this.element.lastElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.lastElementChild.insertAdjacentHTML("beforeend",i):this.element.lastElementChild.innerHTML=i,typeof a=="number"&&(window.siyuan.config.uiLayout.hideDock||this.element.classList.remove("fn__none"),e[0].show&&this.toggleModel(e[0].type,!0))}}const rm=n=>{let e;const t=new wa({app:n.app,type:"siyuan-card",tab:n.tab,data:n.data,init(){_(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},a=>{this.element.innerHTML=hd({id:this.data.id,cardType:this.data.cardType,blocks:a.data.cards,isTab:!0}),e=Vp({app:n.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,blocks:a.data.cards}),t.data.editor=e})},destroy(){e&&e.destroy()},resize(){e&&e.resize()},update(){_(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},a=>{this.element.innerHTML=hd({id:this.data.id,cardType:this.data.cardType,blocks:a.data.cards,isTab:!0})})}});return t.element.addEventListener("click",()=>{lt(t.element.parentElement.parentElement)}),t},cm=()=>{_("/api/storage/getRecentDocs",{},n=>{let e;getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0));let t="";n.data.forEach((s,o)=>{t+=`<li data-index="${o}" data-node-id="${s.rootID}" class="b3-list-item${o===0?" b3-list-item--focus":""}">
${fe(s.icon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${De(s.title)}</span>
</li>`});let a="";(0,T.FJ)()||(a=`<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">
<li data-type="riffCard" data-index="0" class="b3-list-item${t?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${ae(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,Kl().forEach((s,o)=>{a+=`<li data-type="${s.type}" data-index="${o+1}" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#${s.icon}"></use></svg>
    <span class="b3-list-item__text">${s.title}</span>
    <span class="b3-list-item__meta">${ae(s.hotkey||"")}</span>
</li>`}),a=a+"</ul>");const i=new Le({title:window.siyuan.languages.recentDocs,content:`<div class="fn__flex-column switch-doc">
    <div class="fn__hr"><input style="opacity: 0;height: 1px;box-sizing: border-box"></div>
    <div class="fn__flex" style="overflow:auto;">${a}
        <ul${(0,T.FJ)()?' style="border-left:0"':""} class="b3-list b3-list--background fn__flex-1">${t}</ul>
    </div>
    <div class="switch-doc__path"></div>
</div>`,destroyCallback:()=>{e&&e.getBoundingClientRect().height!==0&&ee(e)}});n.data.length>0?_("/api/filetree/getFullHPathByID",{id:n.data[0].rootID},s=>{i.element.querySelector(".switch-doc__path").innerHTML=De(s.data)}):i.element.querySelector(".switch-doc__path").innerHTML=i.element.querySelector(".b3-list-item--focus").textContent,i.element.querySelector("input").focus(),i.element.setAttribute("data-key",window.siyuan.config.keymap.general.recentDocs.custom),i.element.addEventListener("click",s=>{const o=$(s.target,"b3-list-item");o&&(i.element.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),window.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter"})),s.stopPropagation(),s.preventDefault())})})};class dm{constructor(e){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=t=>{window.siyuan.blockPanels.push(new uo({app:this.app,targetElement:t.targetElement,isBacklink:t.isBacklink,x:t.x,y:t.y,nodeIds:t.ids,defIds:t.defIds}))},this.app=e.app,this.i18n=e.i18n,this.name=e.name,this.displayName=e.displayName,this.eventBus=new uw(e.name)}onload(){}onunload(){}onLayoutReady(){}addCommand(e){this.commands.push(e)}addIcons(e){document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${e}</defs></svg>`)}addTopBar(e){if(!e.icon.startsWith("icon")&&!e.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const t=document.createElement("div");return t.setAttribute("data-menu","true"),t.addEventListener("click",e.callback),t.id=`plugin_${this.name}_${this.topBarIcons.length}`,(0,T.tq)()?(t.className="b3-menu__item",t.innerHTML=(e.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${e.icon}"></use></svg>`:e.icon)+`<span class="b3-menu__label">${e.title}</span>`):(0,T.FJ)()||(t.className="toolbar__item ariaLabel",t.setAttribute("aria-label",e.title),t.innerHTML=e.icon.startsWith("icon")?`<svg><use xlink:href="#${e.icon}"></use></svg>`:e.icon,t.addEventListener("click",e.callback),t.setAttribute("data-position",e.position||"right")),this.topBarIcons.push(t),t}addStatusBar(e){return e.element.setAttribute("data-position",e.position||"right"),this.statusBarIcons.push(e.element),e.element}openSetting(){this.setting&&this.setting.open(this.name)}loadData(e){return typeof this.data[e]=="undefined"&&(this.data[e]=""),new Promise(t=>{_("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{a.code!==404&&(this.data[e]=a),t(this.data[e])})})}saveData(e,t){return new Promise(a=>{const i=`/data/storage/petal/${this.name}/${e}`;let s;typeof t=="object"?s=new File([new Blob([JSON.stringify(t)],{type:"application/json"})],i.split("/").pop()):s=new File([new Blob([t])],i.split("/").pop());const o=new FormData;o.append("path",i),o.append("file",s),o.append("isDir","false"),_("/api/file/putFile",o,l=>{this.data[e]=t,a(l)})})}removeData(e){return new Promise(t=>{this.data||(this.data={}),_("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{delete this.data[e],t(a)})})}getOpenedTab(){const e={},t=Object.keys(this.models);return t.forEach(a=>{e[a.replace(this.name,"")]=[]}),Ye().custom.find(a=>{t.includes(a.type)&&e[a.type.replace(this.name,"")].push(a)}),e}addTab(e){const t=this.name+e.type;return this.models[t]=a=>{const i=new wa({app:this.app,tab:a.tab,type:t,data:a.data,init:e.init,beforeDestroy:e.beforeDestroy,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",()=>{lt(i.element.parentElement.parentElement)}),i},this.models[t]}addDock(e){const t=this.name+e.type;return typeof e.config.index=="undefined"&&(e.config.index=1e3),this.docks[t]={config:e.config,model:a=>{const i=new wa({app:this.app,tab:a.tab,type:t,data:e.data,init:e.init,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",s=>{lt(i.element),S(s.target,"data-type","min")&&At(t).toggleModel(t)}),i.element.classList.add("sy__"+t),i}},this.docks[t]}}const sE=(n,e={})=>{us(n,{}),n.parent.removeTab(n.id)},oE=(n,e={})=>{_("/api/block/getBlockInfo",{id:n},t=>{if(t.code===3){q(t.msg);return}const a={title:t.data.rootTitle,docIcon:t.data.rootIcon,pin:!1,active:!0,instance:"Tab",action:"Tab",children:{notebookId:t.data.box,blockId:n,rootId:t.data.rootID,mode:"wysiwyg",instance:"Editor"}};t.data.rootID===n?_("/api/attr/getBlockAttrs",{id:n},i=>{i.data.scroll&&(a.children.scrollAttr=JSON.parse(i.data.scroll),a.children.scrollAttr.rootId=t.data.rootID)}):(a.children.action=p.Constants.CB_GET_ALL,a.children.scrollAttr={zoomInId:n})})};class lE{constructor(e){this.items=[],this.confirmCallback=e.confirmCallback,this.width=e.width||((0,T.tq)()?"92vw":"768px"),this.height=e.height||"80vh"}addItem(e){this.items.push(e)}open(e){var t;const a=new Le({title:e,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),i=a.element.querySelector(".b3-dialog__content");this.items.forEach(o=>{let l="",r=o.actionElement;!o.actionElement&&o.createActionElement&&(r=o.createActionElement()),r&&r.tagName==="TEXTAREA"?l=`<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${o.title}
        ${o.description?`<div class="b3-label__text">${o.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</label>`:l=`<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${o.title}
        ${o.description?`<div class="b3-label__text">${o.description}</div>`:""}
    </div>
    <span class="fn__space${r?"":" fn__none"}"></span>
</label>`,i.insertAdjacentHTML("beforeend",l),r&&(["INPUT","TEXTAREA"].includes(r.tagName)&&a.bindInput(r,()=>{s[1].dispatchEvent(new CustomEvent("click"))}),r.tagName==="TEXTAREA"?i.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",r):i.lastElementChild.insertAdjacentElement("beforeend",r))}),(t=i.querySelector("input"))==null||t.focus();const s=a.element.querySelectorAll(".b3-dialog__action .b3-button");s[0].addEventListener("click",()=>{a.destroy()}),s[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),a.destroy()})}}let um,fm;fm=n=>{if(n.doc&&n.doc.id){oE(n.doc.id,{position:n.position,width:n.width,height:n.height});return}if(n.tab){sE(n.tab,{position:n.position,width:n.width,height:n.height});return}},um=n=>{if(n.doc)return n.doc.zoomIn&&(n.doc.action&&!n.doc.action.includes(p.Constants.CB_GET_ALL)?n.doc.action.push(p.Constants.CB_GET_ALL):n.doc.action=[p.Constants.CB_GET_ALL]),n.doc.action||(n.doc.action=[]),be({app:n.app,keepCursor:n.keepCursor,removeCurrentTab:n.removeCurrentTab,position:n.position,afterOpen:n.afterOpen,id:n.doc.id,action:n.doc.action,zoomIn:n.doc.zoomIn});if(n.asset)return jn({app:n.app,keepCursor:n.keepCursor,removeCurrentTab:n.removeCurrentTab,position:n.position,afterOpen:n.afterOpen,assetPath:n.asset.path});if(n.pdf)return jn({app:n.app,keepCursor:n.keepCursor,removeCurrentTab:n.removeCurrentTab,position:n.position,afterOpen:n.afterOpen,assetPath:n.pdf.path,page:n.pdf.id||n.pdf.page});if(n.search)return n.search.idPath||(n.search.idPath=[]),n.search.hPath||(n.search.hPath=""),jn({app:n.app,keepCursor:n.keepCursor,removeCurrentTab:n.removeCurrentTab,position:n.position,afterOpen:n.afterOpen,searchData:n.search});if(n.card)return jn({app:n.app,keepCursor:n.keepCursor,removeCurrentTab:n.removeCurrentTab,position:n.position,afterOpen:n.afterOpen,custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardType:n.card.type,id:n.card.id||"",title:n.card.title},id:"siyuan-card"}});if(n.custom)return jn(n)};const rE={confirm:Ne,showMessage:q,adaptHotkey:ae,fetchPost:_,fetchSyncPost:kt,fetchGet:Zh,getFrontend:T.UP,getBackend:T.N_,openTab:um,openWindow:fm,Protyle:hn,Plugin:dm,Dialog:Le,Menu:Kt,Setting:lE};var Qd=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const cE=n=>({siyuan:rE})[n],dE=(n,e)=>window.eval("(function anonymous(require, module, exports){".concat(n,`
})
//# sourceURL=`).concat(e,`
`)),pm=n=>Qd(void 0,null,function*(){const e=yield kt("/api/petal/loadPetals",{frontend:(0,T.UP)()});let t="";e.data.forEach(i=>{gm(n,i),t+=i.css||`
`});const a=document.createElement("style");a.id="pluginsStyle",a.textContent=t,document.head.append(a)}),gm=(n,e)=>Qd(void 0,null,function*(){const t={},a={exports:t};try{dE(e.js,"plugin:"+encodeURIComponent(e.name))(cE,a,t)}catch(o){console.error(`plugin ${e.name} run error:`,o);return}const i=(a.exports||t).default||a.exports;if(typeof i!="function"){console.error(`plugin ${e.name} has no export`);return}if(!(i.prototype instanceof dm)){console.error(`plugin ${e.name} does not extends Plugin`);return}const s=new i({app:n,displayName:e.displayName,name:e.name,i18n:e.i18n});n.plugins.push(s);try{yield s.onload()}catch(o){console.error(`plugin ${e.name} onload error:`,o)}return s}),hm=(n,e)=>Qd(void 0,null,function*(){const t=yield gm(n,e),a=document.createElement("style");return a.textContent=e.css,document.head.append(a),tu(t),Tt({reload:!1,onlyData:!1,errorExit:!1}),t}),eu=(n,e,t,a)=>{const i=Object.keys(t.docks);n.forEach((s,o)=>{i.includes(s.type)&&(a==="Left"?t.docks[s.type].config.position=e===0?"LeftTop":"LeftBottom":a==="Right"?t.docks[s.type].config.position=e===0?"RightTop":"RightBottom":a==="Bottom"&&(t.docks[s.type].config.position=e===0?"BottomLeft":"BottomRight"),t.docks[s.type].config.index=o,t.docks[s.type].config.show=s.show,t.docks[s.type].config.size=s.size)})},uE=n=>{window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),n.commands.forEach(e=>{if(!window.siyuan.config.keymap.plugin[n.name]){e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[n.name]={[e.langKey]:{default:e.hotkey,custom:e.hotkey}};return}if(!window.siyuan.config.keymap.plugin[n.name][e.langKey]){e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[n.name][e.langKey]={default:e.hotkey,custom:e.hotkey};return}window.siyuan.config.keymap.plugin[n.name][e.langKey]&&(e.customHotkey=window.siyuan.config.keymap.plugin[n.name][e.langKey].custom||e.hotkey,window.siyuan.config.keymap.plugin[n.name][e.langKey].default=e.hotkey)})},tu=n=>{try{n.onLayoutReady()}catch(e){console.error(`plugin ${n.name} onLayoutReady error:`,e)}if(!(0,T.FJ)()||(0,T.tq)()){const e=[];if(n.topBarIcons.forEach(t=>{(0,T.tq)()?window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].includes(t.id)?e.push({iconHTML:t.firstElementChild.outerHTML,label:t.textContent.trim(),click(){t.dispatchEvent(new CustomEvent("click"))}}):document.querySelector("#menuAbout").after(t):(0,T.FJ)()||(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].includes(t.id)&&t.classList.add("fn__none"),document.querySelector("#"+(t.getAttribute("data-position")==="right"?"barPlugins":"drag")).before(t))}),(0,T.tq)()&&e.length>0){const t=document.createElement("div");t.classList.add("b3-menu__item"),t.setAttribute("data-menu","true"),t.innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconPlugin"></use></svg><span class="b3-menu__label">${window.siyuan.languages.plugin}</span>`,t.addEventListener("click",()=>{const a=new Kt;e.forEach(i=>{a.addItem(i)}),a.fullscreen()}),document.querySelector("#menuAbout").after(t)}}or(),uE(n),n.statusBarIcons.forEach(e=>{const t=document.getElementById("status");e.getAttribute("data-position")==="right"?t.insertAdjacentElement("beforeend",e):t.insertAdjacentElement("afterbegin",e)}),!(0,T.FJ)()&&(window.siyuan.config.uiLayout.left.data.forEach((e,t)=>{eu(e,t,n,"Left")}),window.siyuan.config.uiLayout.right.data.forEach((e,t)=>{eu(e,t,n,"Right")}),window.siyuan.config.uiLayout.bottom.data.forEach((e,t)=>{eu(e,t,n,"Bottom")}),Object.keys(n.docks).forEach(e=>{const t=n.docks[e];t.config.position.startsWith("Left")?window.siyuan.layout.leftDock.genButton([{type:e,size:t.config.size,show:t.config.show,icon:t.config.icon,title:t.config.title,hotkey:t.config.hotkey}],t.config.position==="LeftBottom"?1:0,t.config.index):t.config.position.startsWith("Bottom")?window.siyuan.layout.bottomDock.genButton([{type:e,size:t.config.size,show:t.config.show,icon:t.config.icon,title:t.config.title,hotkey:t.config.hotkey}],t.config.position==="BottomRight"?1:0,t.config.index):t.config.position.startsWith("Right")&&window.siyuan.layout.rightDock.genButton([{type:e,size:t.config.size,show:t.config.show,icon:t.config.icon,title:t.config.title,hotkey:t.config.hotkey}],t.config.position==="RightBottom"?1:0,t.config.index)}))},lt=n=>{if(!(n.classList.contains("layout__tab--active")||n.classList.contains("layout__wnd--active")))if(document.querySelectorAll(".layout__tab--active").forEach(e=>{e.classList.remove("layout__tab--active")}),document.querySelectorAll(".dock__item--activefocus").forEach(e=>{e.classList.remove("dock__item--activefocus")}),document.querySelectorAll(".layout__wnd--active").forEach(e=>{e.classList.remove("layout__wnd--active")}),n.getAttribute("data-type")==="wnd")n.classList.add("layout__wnd--active");else{n.classList.add("layout__tab--active"),Array.from(n.classList).find(t=>{if(t.startsWith("sy__"))return document.querySelector(`.dock__item[data-type="${t.substring(4)}"]`).classList.add("dock__item--activefocus"),!0});const e=M(document.activeElement);if(e){const t=J(e);t&&t.blur()}}},At=n=>{if(window.siyuan.layout.leftDock){if(window.siyuan.layout.leftDock.data[n])return window.siyuan.layout.leftDock;if(window.siyuan.layout.rightDock.data[n])return window.siyuan.layout.rightDock;if(window.siyuan.layout.bottomDock.data[n])return window.siyuan.layout.bottomDock}},nu=(n,e)=>{const t=[];e.children.forEach(a=>{if(a.model instanceof gt&&a.model.editor.protyle.toolbar.range){const i=M(a.model.editor.protyle.toolbar.range.startContainer);if(i){const s=Et(i,void 0,a.model.editor.protyle.toolbar.range);t.push({id:i.getAttribute("data-node-id"),start:s.start,end:s.end})}}}),n.element.after(e.element),e.children.forEach(a=>{if(a.model instanceof gt){const i=t.splice(0,1)[0];if(!i)return;const s=Fn(a.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),i.start,i.end);s&&(a.model.editor.protyle.toolbar.range=s)}}),n.element.after(n.element.previousElementSibling),n.parent.children.find((a,i)=>{if(a.id===n.id){const s=n.parent.children[i].resize;n.parent.children[i].resize=n.parent.children[i-1].resize,n.parent.children[i-1].resize=s;const o=a;return n.parent.children[i]=n.parent.children[i-1],n.parent.children[i-1]=o,!0}})},bi=n=>{for(let e=0;e<n.children.length;e++){const t=n.children[e];return t instanceof mi?t:bi(t)}},au=n=>{const e=[],t=s=>{const o=[];return n.element.querySelectorAll(`span[data-index="${s}"]`).forEach(l=>{o.push({type:l.getAttribute("data-type"),size:{height:parseInt(l.getAttribute("data-height")),width:parseInt(l.getAttribute("data-width"))},title:l.getAttribute("data-title"),show:l.classList.contains("dock__item--active"),icon:l.querySelector("use").getAttribute("xlink:href").substring(1),hotkey:l.getAttribute("data-hotkey")||"",hotkeyLangId:l.getAttribute("data-hotkeyLangId")||""})}),o},a=t(0),i=t(1);return(a.length>0||i.length>0)&&e.push(a),i.length>0&&e.push(i),{pin:n.pin,data:e}},mm=()=>{_("/api/system/setUILayout",{layout:{}},()=>{window.location.reload()})},Tt=n=>{if((0,T.FJ)()){const a={layout:{}};if(us(window.siyuan.layout.layout,a.layout,!!n.dropEditScroll),n.onlyData)return a;sessionStorage.setItem("layout",JSON.stringify(a)),n.reload?window.location.reload():n.cb&&n.cb();return}const e=document.querySelector("#barDock use");if(!e)return;const t={hideDock:e.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:au(window.siyuan.layout.bottomDock),left:au(window.siyuan.layout.leftDock),right:au(window.siyuan.layout.rightDock)};if(us(window.siyuan.layout.layout,t.layout,!!n.dropEditScroll),n.onlyData)return t;_("/api/system/setUILayout",{layout:t,errorExit:n.errorExit},()=>{n.reload?window.location.reload():n.cb&&n.cb()})},iu=n=>{n.forEach(e=>{e.hotkeyLangId&&(e.title=window.siyuan.languages[e.hotkeyLangId],e.hotkey=window.siyuan.config.keymap.general[e.hotkeyLangId].custom)})},fE=(n,e)=>{n.left.data.forEach(t=>{iu(t)}),n.right.data.forEach(t=>{iu(t)}),n.bottom.data.forEach(t=>{iu(t)}),window.siyuan.layout.centerLayout=window.siyuan.layout.layout.children[0].children[1],window.siyuan.layout.leftDock=new Jd({position:"Left",data:n.left,app:e}),window.siyuan.layout.rightDock=new Jd({position:"Right",data:n.right,app:e}),window.siyuan.layout.bottomDock=new Jd({position:"Bottom",data:n.bottom,app:e})},su=(n,e,t)=>{let a;if(e.instance==="Layout")t?(a=new Te({direction:e.direction,size:e.size,type:e.type,resize:e.resize}),t.addLayout(a)):window.siyuan.layout.layout=new Te({element:document.getElementById("layouts"),direction:e.direction,size:e.size,type:e.type,resize:e.resize});else if(e.instance==="Wnd")a=new mi(n,e.resize,t.type),t.addWnd(a),e.width&&(a.element.classList.remove("fn__flex-1"),a.element.style.width=e.width),e.height&&(a.element.classList.remove("fn__flex-1"),a.element.style.height=e.height);else if(e.instance==="Tab"){if(!e.title)a=vm(n);else{let i=e.title;e.lang&&(i=window.siyuan.languages[e.lang]),a=new ht({icon:e.icon,docIcon:e.docIcon,title:i})}e.pin&&(a.headElement.classList.add("item--pin"),(e.docIcon||e.icon)&&a.headElement.querySelector(".item__text").classList.add("fn__none")),e.active&&a.headElement.setAttribute("data-init-active","true"),t.addTab(a),t.showHeading()}else e.instance==="Editor"&&e.blockId?(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.headElement.classList.add("item--unupdate"),e.scrollAttr&&(e.scrollAttr.rootId=e.rootId),t.headElement.setAttribute("data-initdata",JSON.stringify(e))):e.instance==="Asset"?t.addModel(new Gn({app:n,tab:t,path:e.path,page:e.page})):e.instance==="Backlink"?t.addModel(new Ba({app:n,tab:t,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Bookmark"?t.addModel(new fi(n,t)):e.instance==="Files"?t.addModel(new ha({app:n,tab:t})):e.instance==="Graph"?t.addModel(new Kn({app:n,tab:t,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Outline"?t.addModel(new Ha({app:n,tab:t,blockId:e.blockId,type:e.type,isPreview:e.isPreview})):e.instance==="Tag"?t.addModel(new pi(n,t)):e.instance==="Search"?t.addModel(new Oa({app:n,tab:t,config:e.config})):e.instance==="Custom"&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.headElement.classList.add("item--unupdate"),t.headElement.setAttribute("data-initdata",JSON.stringify(e)));e.children&&(Array.isArray(e.children)?e.children.forEach(i=>{su(n,i,t?a:window.siyuan.layout.layout)}):su(n,e.children,a))},pE=(n,e)=>{su(n,window.siyuan.config.uiLayout.layout,void 0),fE(window.siyuan.config.uiLayout,n),window.siyuan.config.fileTree.closeTabsOnStart&&e&&Zn().forEach(a=>{a.headElement&&!a.headElement.classList.contains("item--pin")&&a.parent.removeTab(a.id,!1,!1,!1)}),n.plugins.forEach(a=>{tu(a)}),document.querySelectorAll('li[data-type="tab-header"]').forEach(a=>{const i=a.getAttribute("data-initdata");if(i){const s=JSON.parse(i);if(s.instance==="Custom"&&s.customModelType!=="siyuan-card"){let o=!1;if(n.plugins.find(l=>{if(Object.keys(l.models).includes(s.customModelType))return o=!0,!0}),!o){const l=a.getAttribute("data-id"),r=St(l);r&&r.parent.removeTab(l,!1,!1,!1)}}}});const t=iv();t.id?be({app:n,id:t.id,action:t.isZoomIn?[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:t.isZoomIn}):document.querySelectorAll('li[data-type="tab-header"][data-init-active="true"]').forEach(a=>{a.removeAttribute("data-init-active"),St(a.getAttribute("data-id")).parent.switchTab(a,!1,!1)}),or()},us=(n,e,t=!1)=>{n instanceof Te?(e.direction=n.direction,n.parent&&(n.element.classList.contains("fn__flex-1")?e.size="auto":e.size=(n.parent.direction==="tb"?n.element.clientHeight:n.element.clientWidth)+"px"),e.resize=n.resize,e.type=n.type,e.instance="Layout"):n instanceof mi?(e.resize=n.resize,e.height=n.element.style.height,e.width=n.element.style.width,e.instance="Wnd"):n instanceof ht?(n.headElement&&(e.title=n.title,e.icon=n.icon,e.docIcon=n.docIcon,e.pin=n.headElement.classList.contains("item--pin"),n.model instanceof ha?e.lang="fileTree":n.model instanceof Ba&&n.model.type==="pin"?e.lang="backlinks":n.model instanceof fi?e.lang="bookmark":n.model instanceof Kn&&n.model.type!=="local"?e.lang="graphView":n.model instanceof Ha&&n.model.type!=="local"?e.lang="outline":n.model instanceof pi&&(e.lang="tag"),n.headElement.classList.contains("item--focus")&&(e.active=!0)),e.instance="Tab"):n instanceof gt?(e.notebookId=n.editor.protyle.notebookId,e.blockId=n.editor.protyle.block.id,e.rootId=n.editor.protyle.block.rootID,e.mode=n.editor.protyle.preview.element.classList.contains("fn__none")?"wysiwyg":"preview",e.action=n.editor.protyle.block.showAll?p.Constants.CB_GET_ALL:"",e.instance="Editor",t||(e.scrollAttr=qs(n.editor.protyle,!0))):n instanceof Gn?(e.path=n.path,n.pdfObject&&(e.page=n.pdfObject.page),e.instance="Asset"):n instanceof Ba?(e.blockId=n.blockId,e.rootId=n.rootId,e.type=n.type,e.instance="Backlink"):n instanceof fi?e.instance="Bookmark":n instanceof ha?e.instance="Files":n instanceof Kn?(e.blockId=n.blockId,e.rootId=n.rootId,e.type=n.type,e.instance="Graph"):n instanceof Ha?(e.blockId=n.blockId,e.type=n.type,e.isPreview=n.isPreview,e.instance="Outline"):n instanceof pi?e.instance="Tag":n instanceof Oa?(e.instance="Search",e.config=n.config):n instanceof wa&&(e.instance="Custom",e.customModelType=n.type,e.customModelData=Object.assign({},n.data),delete e.customModelData.editor),n instanceof Te||n instanceof mi?n instanceof Te&&(n.type==="bottom"||n.type==="left"||n.type==="right")?n.type==="bottom"?e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]:e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]:(e.children=[],n.children.forEach(a=>{const i={};e.children.push(i),us(a,i,t)})):n instanceof ht&&(n.model?(e.children={},us(n.model,e.children,t)):n.headElement?e.children=JSON.parse(n.headElement.getAttribute("data-initdata")||"{}"):e.children={})},or=()=>{const n=document.querySelector("#toolbar");if(!n)return;const e=n.querySelector("#drag");e.style.padding="";const t=n.querySelector("#barMore");t.classList.remove("fn__none"),t.removeAttribute("data-hideids"),Array.from(n.querySelectorAll('[data-hide="true"]')).forEach(u=>{u.classList.remove("fn__none"),u.removeAttribute("data-hide")});let a=e.nextElementSibling;const i=[];for(;n.scrollWidth>n.clientWidth+2&&(i.push(a.id),a.classList.add("fn__none"),a.setAttribute("data-hide","true"),a=a.nextElementSibling,a.id!=="barMore"););let s=e.previousElementSibling;for(;n.scrollWidth>n.clientWidth+2&&(i.push(s.id),s.classList.add("fn__none"),s.setAttribute("data-hide","true"),s=s.previousElementSibling,s.id!=="barWorkspace"););i.length>0?t.classList.remove("fn__none"):t.classList.add("fn__none"),t.setAttribute("data-hideids",i.join(","));const o=e.clientWidth,l=e.getBoundingClientRect(),r=l.left,c=window.innerWidth-l.right;r>c&&r-c<o/3?e.style.paddingRight=r-c+"px":r<c&&c-r<o/3&&(e.style.paddingLeft=c-r+"px"),window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].forEach(u=>{var d;(d=n.querySelector("#"+u))==null||d.classList.add("fn__none")})};let bm;const nn=()=>{clearTimeout(bm),bm=window.setTimeout(()=>{const n=Ye();n.editor.forEach(e=>{e.editor&&e.editor.protyle&&e.element.parentElement&&!e.element.classList.contains("fn__none")&&e.editor.resize()}),n.backlink.forEach(e=>{const t=e.element.querySelector(".backlinkMList");t.style.height&&t.style.height!=="0px"&&e.element.clientHeight!==0&&(t.style.height=e.element.clientHeight-t.previousElementSibling.clientHeight*2+"px"),e.editors.forEach(a=>{ne(["gutter"],a.protyle),a.resize()})}),n.search.forEach(e=>{e.edit.resize()}),n.custom.forEach(e=>{e.resize&&e.resize()}),fw(),Oi(["gutter"])},200)},wm=(n,e)=>new ht({icon:e.icon,docIcon:e.docIcon,title:e.title,callback(t){let a;if(e.model instanceof gt)a=new gt({app:n,tab:t,blockId:e.model.editor.protyle.block.id,scrollAttr:qs(e.model.editor.protyle,!0)});else if(e.model instanceof Gn)a=new Gn({app:n,tab:t,path:e.model.path});else if(e.model instanceof Kn)a=new Kn({app:n,tab:t,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof ha)a=new ha({app:n,tab:t});else if(e.model instanceof Ha)a=new Ha({app:n,tab:t,blockId:e.model.blockId,type:e.model.type,isPreview:e.model.isPreview});else if(e.model instanceof Ba)a=new Ba({app:n,tab:t,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof fi)a=new fi(n,t);else if(e.model instanceof pi)a=new pi(n,t);else if(e.model instanceof Oa)a=new Oa({app:n,tab:t,config:e.model.config});else if(e.model instanceof wa){const i=e.model;i.type==="siyuan-card"?a=rm({app:n,tab:t,data:i.data}):n.plugins.find(s=>{if(s.models[i.type])return a=s.models[i.type]({tab:t,data:i.data}),!0})}else if(!e.model&&e.headElement){const i=JSON.parse(e.headElement.getAttribute("data-initdata")||"{}");i&&(i.scrollAttr&&(i.scrollAttr.rootId=i.rootId),a=ym(n,t,i))}t.addModel(a)}}),ym=(n,e,t)=>{let a;return t.instance==="Custom"?t.customModelType==="siyuan-card"?a=rm({app:n,tab:e,data:t.customModelData}):n.plugins.find(i=>{if(i.models[t.customModelType])return a=i.models[t.customModelType]({tab:e,data:t.customModelData}),!0}):t.instance==="Editor"&&(a=new gt({app:n,tab:e,blockId:t.blockId,mode:t.mode,action:typeof t.action=="string"?[t.action]:t.action,scrollAttr:t.scrollAttr})),a},wi=n=>{const e=!!n.querySelector('.layout-tab-container > [data-loading="true"]');return e&&q(window.siyuan.languages.pdfIsLoading),e},St=(n,e=window.siyuan.layout.centerLayout)=>{const t=(a,i)=>{if(a.id===i)return a;if(!a.children)return;let s;for(let o=0;o<a.children.length;o++)if(s=t(a.children[o],i),s)return s};return t(e,n)},_m=n=>{if(!n.resize)return;const e=i=>{let s=227;return Array.from(i.querySelectorAll(".file-tree")).find(o=>{if((o.classList.contains("sy__backlink")||o.classList.contains("sy__graph")||o.classList.contains("sy__globalGraph")||o.classList.contains("sy__inbox"))&&!o.classList.contains("fn__none")&&!$(o,"fn__none"))return s=320,!0}),s},t=(i,s)=>{const o=(r,c)=>{r.classList.contains("fn__flex-1")&&(c==="lr"?r.style.width=r.clientWidth+"px":r.style.height=r.clientHeight+"px",r.classList.remove("fn__flex-1"))};let l;i.addEventListener("mousedown",r=>{Ye().editor.forEach(m=>{m.editor&&m.editor.protyle&&m.element.parentElement&&ne(["gutter"],m.editor.protyle)}),getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));const c=document,u=i.nextElementSibling,d=i.previousElementSibling;u.style.overflow="auto",d.style.overflow="auto",!u.nextElementSibling||u.nextElementSibling.classList.contains("layout__dockresize")?o(u,s):o(d,s);const f=r[s==="lr"?"clientX":"clientY"],g=s==="lr"?d.clientWidth:d.clientHeight,h=s==="lr"?u.clientWidth:u.clientHeight;c.ondragstart=()=>(document.querySelectorAll(".sy__file .b3-list-item").forEach(m=>{m.style.opacity==="0.1"&&(m.style.opacity="")}),!1),c.onmousemove=m=>{var b,y,w;m.preventDefault(),m.stopPropagation();const E=g+(m[s==="lr"?"clientX":"clientY"]-f),k=h-(m[s==="lr"?"clientX":"clientY"]-f);E<8||k<8||(b=window.siyuan.layout.leftDock)!=null&&b.layout.element.isSameNode(d)&&E<e(d)||(y=window.siyuan.layout.rightDock)!=null&&y.layout.element.isSameNode(u)&&k<e(u)||(w=window.siyuan.layout.bottomDock)!=null&&w.layout.element.isSameNode(u)&&k<64||(d.classList.contains("fn__flex-1")||(d.style[s==="lr"?"width":"height"]=E+"px"),u.classList.contains("fn__flex-1")||(u.style[s==="lr"?"width":"height"]=k+"px"))},c.onmouseup=()=>{c.onmousemove=null,c.onmouseup=null,c.ondragstart=null,c.onselectstart=null,c.onselect=null,nn(),(0,T.FJ)()||(window.siyuan.layout.leftDock.setSize(),window.siyuan.layout.bottomDock.setSize(),window.siyuan.layout.rightDock.setSize()),l&&ee(l),u.style.overflow="",d.style.overflow=""}})},a=document.createElement("div");n.resize==="lr"&&a.classList.add("layout__resize--lr"),a.classList.add("layout__resize"),n.element.insertAdjacentElement("beforebegin",a),t(a,n.resize)},vm=n=>new ht({panel:`<div class="layout__empty b3-list">
    <div class="${window.siyuan.config.readonly?"":" fn__none"}">
        <div class="config-about__logo">
            <img src="/stage/icon.png">
            ${window.siyuan.languages.siyuanNote}
        </div>
        <div class="b3-label__text">${window.siyuan.languages.slogan}</div>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list-item" id="editorEmptySearch">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg>
        <span>${window.siyuan.languages.search}</span>
        <span class="b3-list-item__meta">${ae(window.siyuan.config.keymap.general.globalSearch.custom)}</span>
    </div>
    <div id="editorEmptyRecent" class="b3-list-item">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg>
        <span>${window.siyuan.languages.recentDocs}</span>
        <span class="b3-list-item__meta">${ae(window.siyuan.config.keymap.general.recentDocs.custom)}</span>
    </div>
    <div id="editorEmptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg>
        <span>${window.siyuan.languages.dataHistory}</span>
        <span class="b3-list-item__meta">${ae(window.siyuan.config.keymap.general.dataHistory.custom)}</span>
    </div>
    <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyFile">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
        <span>${window.siyuan.languages.newFile}</span>
        <span class="b3-list-item__meta">${ae(window.siyuan.config.keymap.general.newFile.custom)}</span>
    </div>
    <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyNewNotebook">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg>
        <span>${window.siyuan.languages.newNotebook}</span>
    </div>
    <div class="b3-list-item" id="editorEmptyHelp">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg>
        <span>${window.siyuan.languages.help}</span>
    </div>
</div>`,callback(e){e.panelElement.addEventListener("click",t=>{let a=t.target;for(;a&&!a.isEqualNode(e.panelElement);){if(a.id==="editorEmptySearch"){pn({app:n,hotkey:window.siyuan.config.keymap.general.globalSearch.custom}),t.stopPropagation(),t.preventDefault();break}else if(a.id==="editorEmptyRecent"){if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===window.siyuan.config.keymap.general.recentDocs.custom)return!0})){ne(["dialog"]);return}cm(),t.stopPropagation(),t.preventDefault();break}else if(a.id==="editorEmptyHistory"){zc(n),t.stopPropagation(),t.preventDefault();break}else if(a.id==="editorEmptyFile"){Xa({app:n,useSavePath:!0}),t.stopPropagation(),t.preventDefault();break}else if(a.id==="editorEmptyNewNotebook"){Gf(),t.stopPropagation(),t.preventDefault();break}else if(a.id==="editorEmptyHelp"){El(),t.stopPropagation(),t.preventDefault();break}a=a.parentElement}})}}),gE=n=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,type:"submenu",submenu:li(n,!1)}).element),window.siyuan.menus.menu),fs=(n,e)=>new I({label:window.siyuan.languages[n],icon:n.replace("moveTo","icon"),click:()=>{n.indexOf("moveToLeft")>-1?window.siyuan.layout.leftDock.add(n.endsWith("Top")?0:1,e):n.indexOf("moveToRight")>-1?window.siyuan.layout.rightDock.add(n.endsWith("Top")?0:1,e):n.indexOf("moveToBottom")>-1&&window.siyuan.layout.bottomDock.add(n.endsWith("Left")?0:1,e)}}),Em=n=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(fs("moveToLeftTop",n).element),window.siyuan.menus.menu.append(fs("moveToLeftBottom",n).element),window.siyuan.menus.menu.append(fs("moveToRightTop",n).element),window.siyuan.menus.menu.append(fs("moveToRightBottom",n).element),window.siyuan.menus.menu.append(fs("moveToBottomLeft",n).element),window.siyuan.menus.menu.append(fs("moveToBottomRight",n).element),window.siyuan.menus.menu);var lr=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const hE=n=>{const e=[],t=[],a=[],i=[];let s=-1;n.parent.children.forEach((o,l)=>{var r,c;const u=o.model;(!u||(r=u.editor)!=null&&r.protyle&&!((c=u.editor)!=null&&c.protyle.updated))&&t.push(o),o.id===n.id&&(s=l),s===-1?a.push(o):l>s&&i.push(o),e.push(o)}),window.siyuan.menus.menu.append(new I({icon:"iconClose",label:window.siyuan.languages.close,accelerator:window.siyuan.config.keymap.general.closeTab.custom,click:()=>{n.parent.removeTab(n.id)}}).element),e.length>1&&(window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.closeOthers,click(){for(let o=0;o<e.length;o++)e[o].id!==n.id&&!e[o].headElement.classList.contains("item--pin")&&e[o].parent.removeTab(e[o].id,!0,!0,!1);n.headElement.parentElement.querySelector(".item--focus")||n.parent.switchTab(n.headElement,!0)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.closeAll,click:()=>lr(void 0,null,function*(){for(let o=0;o<e.length;o++)e[o].headElement.classList.contains("item--pin")||(yield e[o].parent.removeTab(e[o].id,!0));e[0].headElement.parentElement&&e[0].parent.switchTab(e[0].headElement,!0)})}).element),t.length>0&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.closeUnmodified,click:()=>lr(void 0,null,function*(){for(let o=0;o<t.length;o++)t[o].headElement.classList.contains("item--pin")||(yield t[o].parent.removeTab(t[o].id));n.headElement.parentElement&&!n.headElement.parentElement.querySelector(".item--focus")?n.parent.switchTab(n.headElement,!0):e[0].headElement.parentElement&&e[0].parent.switchTab(e[0].headElement,!0)})}).element),a.length>0&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.closeLeft,click:()=>lr(void 0,null,function*(){for(let o=0;o<a.length;o++)a[o].headElement.classList.contains("item--pin")||(yield a[o].parent.removeTab(a[o].id));n.headElement.parentElement.querySelector(".item--focus")||n.parent.switchTab(n.headElement,!0)})}).element),i.length>0&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.closeRight,click:()=>lr(void 0,null,function*(){for(let o=0;o<i.length;o++)i[o].headElement.classList.contains("item--pin")||(yield i[o].parent.removeTab(i[o].id));n.headElement.parentElement.querySelector(".item--focus")||n.parent.switchTab(n.headElement,!0)})}).element)),window.siyuan.menus.menu.append(new I({type:"separator"}).element)},mE=(n,e)=>{const t=[{icon:"iconSplitLR",label:window.siyuan.languages.splitLR,click:()=>{e.parent.split("lr").addTab(wm(n,e))}}];return e.parent.children.length>1&&t.push({icon:"iconLayoutRight",label:window.siyuan.languages.splitMoveR,click:()=>{const a=e.parent.split("lr");a.headersElement.append(e.headElement),a.headersElement.parentElement.classList.remove("fn__none"),a.moveTab(e),nn()}}),t.push({icon:"iconSplitTB",label:window.siyuan.languages.splitTB,click:()=>{e.parent.split("tb").addTab(wm(n,e))}}),e.parent.children.length>1&&t.push({icon:"iconLayoutBottom",label:window.siyuan.languages.splitMoveB,click:()=>{const a=e.parent.split("tb");a.headersElement.append(e.headElement),a.headersElement.parentElement.classList.remove("fn__none"),a.moveTab(e),nn()}}),t},km=(n,e)=>{window.siyuan.menus.menu.remove(),hE(e),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.split,submenu:mE(n,e)}).element);const t=e.model;let a;if(t&&t instanceof gt)a=t.editor.protyle.block.rootID;else{const i=e.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s&&s.instance==="Editor"&&(a=s.rootId||s.blockId)}}return a&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:li(a,!1)}).element),e.headElement.classList.contains("item--pin")?window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.unpin,icon:"iconPin",click:()=>{e.unpin()}}).element):window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.pin,icon:"iconPin",click:()=>{e.pin()}}).element),window.siyuan.menus.menu};class bE{constructor(e){this.menu=new Yb,window.addEventListener("contextmenu",t=>{if(t.shiftKey)return;let a=t.target;for(;a&&!a.parentElement.isEqualNode(document.querySelector("body"));){t.preventDefault();const i=a.getAttribute("data-type");if(i==="tab-header"){this.unselect(),km(e,St(a.getAttribute("data-id"))).popup({x:t.clientX,y:t.clientY}),t.stopPropagation();break}if(i==="navigation-root"&&!window.siyuan.config.readonly){if(a.querySelector(".b3-list-item__text").classList.contains("ft__on-surface"))return;this.unselect(),Dl(e,a).popup({x:t.clientX,y:t.clientY}),t.stopPropagation();break}if(i==="navigation-file"){this.unselect(),$l(e,this.getDir(a),a.getAttribute("data-path"),a).popup({x:t.clientX,y:t.clientY}),t.stopPropagation();break}if(i==="search-item"){const s=a.getAttribute("data-node-id");s&&gE(s).popup({x:t.clientX,y:t.clientY}),t.stopPropagation();break}if(a.classList.contains("dock__item")&&a.getAttribute("data-type")){Em(a).popup({x:t.clientX,y:t.clientY}),t.stopPropagation();break}a=a.parentElement}},!1)}getDir(e){const t=ve(e,"UL");if(t)return t.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}const We={element:void 0,setReadonly:n=>{window.siyuan.config.editor.readOnly=n,_("/api/setting/setEditor",window.siyuan.config.editor)},genHTML:()=>{let n="";return n='<select id="fontFamily" class="b3-select fn__flex-center fn__size200"></select>',`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fullWidth}
        <div class="b3-label__text">${window.siyuan.languages.fullWidthTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fullWidth" type="checkbox"${window.siyuan.config.editor.fullWidth?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly} 
        <code class="fn__code">${ae(window.siyuan.config.keymap.general.editReadonly.custom)}</code>
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.floatWindowMode}
        <div class="b3-label__text">${window.siyuan.languages.floatWindowModeTip.replace("${hotkey}",ae("\u2318"))}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="floatWindowMode" type="checkbox"${window.siyuan.config.editor.floatWindowMode===0?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.onlySearchForDoc?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md9}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="virtualBlockRefInclude" value="${window.siyuan.config.editor.virtualBlockRefInclude}" />
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md35}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
        <div class="b3-label__text">${window.siyuan.languages.md41}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="virtualBlockRefExclude" value="${window.siyuan.config.editor.virtualBlockRefExclude}" />
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md39}
        <div class="b3-label__text">${window.siyuan.languages.md40}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.dynamicLoadBlocks}
        <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="dynamicLoadBlocks" type="number" min="48" max="1024" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md37}
        <div class="b3-label__text">${window.siyuan.languages.md38}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkExpand}
        <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backmentionExpand}
        <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backmentionExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateHistory}
        <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.historyRetentionDays} 
        <a href="javascript:void(0)" id="clearHistory">${window.siyuan.languages.clearHistory}</a>
        <div class="b3-label__text">${window.siyuan.languages.historyRetentionDaysTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="historyRetentionDays" type="number" min="0" value="${window.siyuan.config.editor.historyRetentionDays}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.font}
        <div class="b3-label__text">${window.siyuan.languages.font1}</div>
    </div>
    <span class="fn__space"></span>
    ${n}
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSizeScrollZoom}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeScrollZoomTip.replace("Ctrl",ae("\u2318"))}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fontSizeScrollZoom" type="checkbox"${window.siyuan.config.editor.fontSizeScrollZoom?" checked":""}/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSize}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.fontSize}">   
        <input class="b3-slider fn__size200" id="fontSize" max="72" min="9" step="1" type="range" value="${window.siyuan.config.editor.fontSize}">
    </div>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md29}
        <div class="b3-label__text">${window.siyuan.languages.md30}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.codeTabSpaces}">   
        <input class="b3-slider fn__size200" id="codeTabSpaces" max="8" min="0" step="2" type="range" value="${window.siyuan.config.editor.codeTabSpaces}">
    </div>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.katexMacros}
        <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" id="katexMacros" spellcheck="false">${window.siyuan.config.editor.katexMacros}</textarea>
    </div>
</label>`},bindEvent:()=>{const n=We.element.querySelector("#fontFamily");if(n.tagName==="SELECT"){let t=`<option value="">${window.siyuan.languages.default}</option>`;_("/api/system/getSysFonts",{},a=>{a.data.forEach(i=>{t+=`<option value="${i}"${window.siyuan.config.editor.fontFamily===i?" selected":""}>${i}</option>`}),n.innerHTML=t})}We.element.querySelector("#clearHistory").addEventListener("click",()=>{Ne(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{_("/api/history/clearWorkspaceHistory",{})})});const e=()=>{let t=parseInt(We.element.querySelector("#dynamicLoadBlocks").value);48>t&&(t=48,We.element.querySelector("#dynamicLoadBlocks").value="48"),1024<t&&(t=1024,We.element.querySelector("#dynamicLoadBlocks").value="1024"),_("/api/setting/setEditor",{fullWidth:We.element.querySelector("#fullWidth").checked,justify:We.element.querySelector("#justify").checked,rtl:We.element.querySelector("#rtl").checked,readOnly:We.element.querySelector("#readOnly").checked,displayBookmarkIcon:We.element.querySelector("#displayBookmarkIcon").checked,displayNetImgMark:We.element.querySelector("#displayNetImgMark").checked,codeSyntaxHighlightLineNum:We.element.querySelector("#codeSyntaxHighlightLineNum").checked,embedBlockBreadcrumb:We.element.querySelector("#embedBlockBreadcrumb").checked,listLogicalOutdent:We.element.querySelector("#listLogicalOutdent").checked,spellcheck:We.element.querySelector("#spellcheck").checked,onlySearchForDoc:We.element.querySelector("#onlySearchForDoc").checked,floatWindowMode:We.element.querySelector("#floatWindowMode").checked?0:1,plantUMLServePath:We.element.querySelector("#plantUMLServePath").value,katexMacros:We.element.querySelector("#katexMacros").value,codeLineWrap:We.element.querySelector("#codeLineWrap").checked,virtualBlockRef:We.element.querySelector("#virtualBlockRef").checked,virtualBlockRefInclude:We.element.querySelector("#virtualBlockRefInclude").value,virtualBlockRefExclude:We.element.querySelector("#virtualBlockRefExclude").value,blockRefDynamicAnchorTextMaxLen:parseInt(We.element.querySelector("#blockRefDynamicAnchorTextMaxLen").value),backlinkExpandCount:parseInt(We.element.querySelector("#backlinkExpandCount").value),backmentionExpandCount:parseInt(We.element.querySelector("#backmentionExpandCount").value),dynamicLoadBlocks:t,codeLigatures:We.element.querySelector("#codeLigatures").checked,codeTabSpaces:parseInt(We.element.querySelector("#codeTabSpaces").value),fontSize:parseInt(We.element.querySelector("#fontSize").value),fontSizeScrollZoom:We.element.querySelector("#fontSizeScrollZoom").checked,generateHistoryInterval:parseInt(We.element.querySelector("#generateHistoryInterval").value),historyRetentionDays:parseInt(We.element.querySelector("#historyRetentionDays").value),fontFamily:n.value,emoji:window.siyuan.config.editor.emoji},a=>{We.onSetEditor(a.data)})};We.element.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(t=>{t.addEventListener("change",()=>{e()})}),We.element.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(t=>{t.addEventListener("blur",()=>{e()})}),We.element.querySelectorAll("input.b3-slider").forEach(t=>{t.addEventListener("input",a=>{const i=a.target;i.parentElement.setAttribute("aria-label",i.value)})})},onSetEditor:n=>{n.readOnly!==window.siyuan.config.editor.readOnly&&We.setReadonly(n.readOnly),window.siyuan.config.editor=n,Ye().editor.forEach(e=>{zn(e.editor.protyle,!1);let t=e.editor.protyle.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_FULLWIDTH);t||(t=window.siyuan.config.editor.fullWidth?"true":"false"),!(t==="true"&&e.editor.protyle.contentElement.getAttribute("data-fullwidth")==="true")&&(Bt(e.editor.protyle),t==="true"?e.editor.protyle.contentElement.setAttribute("data-fullwidth","true"):e.editor.protyle.contentElement.removeAttribute("data-fullwidth"))}),fd()}},Lt={element:void 0,genHTML:()=>`<label class="fn__flex b3-label${(0,T.jU)()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"||window.siyuan.config.system.os==="linux"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoLaunch}
        <div class="b3-label__text">${window.siyuan.languages.autoLaunchTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="autoLaunch" type="checkbox"${window.siyuan.config.system.autoLaunch?" checked":""}>
</label>
<label class="fn__flex b3-label${(0,T.jU)()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoDownloadUpdatePkg}
        <div class="b3-label__text">${window.siyuan.languages.autoDownloadUpdatePkgTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="downloadInstallPkg" type="checkbox"${window.siyuan.config.system.downloadInstallPkg?" checked":""}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.googleAnalytics}
        <div class="b3-label__text">${window.siyuan.languages.googleAnalyticsTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="googleAnalytics" type="checkbox"${window.siyuan.config.system.disableGoogleAnalytics?"":" checked"}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about9}
        <div class="b3-label__text">${window.siyuan.languages.about10}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="uploadErrLog" type="checkbox"${window.siyuan.config.system.uploadErrLog?" checked":""}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</label>
<div class="b3-label${window.siyuan.config.readonly||(0,T.jU)()&&!Rt()&&!Mt()&&!_n()?" fn__none":""}">
    <label class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about5}
            <div class="b3-label__text">${window.siyuan.languages.about6}</div>
        </div>
        <div class="fn__space"></div>
        <button class="fn__flex-center b3-button b3-button--outline fn__size200" id="authCode">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
        </button>
    </label>
    <label class="b3-label fn__flex${!window.siyuan.config.accessAuthCode||(0,T.jU)()?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about7}
            <div class="b3-label__text">${window.siyuan.languages.about8}</div>
        </div>
        <div class="fn__space"></div>
        <input class="b3-switch fn__flex-center" id="lockScreenMode" type="checkbox"${window.siyuan.config.system.lockScreenMode===1?" checked":""}>
    </label>
</div>
<label class="b3-label config__item${(0,T.jU)()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
       ${window.siyuan.languages.about2}
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(n=>!(n.startsWith("[")&&n.endsWith("]"))).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(n=>n.startsWith("[")&&n.endsWith("]")).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
    </div>
    <div class="fn__space"></div>
    <button data-type="open" data-url="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.about4}
    </button>
</label>
<div class="b3-label fn__flex config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.dataRepoKey}
        <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
        <div class="b3-label__text"><span class="ft__error">${window.siyuan.languages.dataRepoKeyTip2}</span></div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?" fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            <svg><use xlink:href="#iconHand"></use></svg>${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?"":" fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="resetRepo">
            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
</div>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.dataRepoPurge}
        <div class="b3-label__text">${window.siyuan.languages.dataRepoPurgeTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="purgeRepo" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.purge}
    </button>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.systemLog}
        <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="exportLog" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.currentVer} v${p.Constants.SIYUAN_VERSION}
        <span id="isInsider"></span>
        <div class="b3-label__text">${window.siyuan.languages.downloadLatestVer}</div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__flex-center fn__size200 config__item-line">
        <button id="checkUpdateBtn" class="b3-button b3-button--outline fn__block">
            <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}
        </button>
    </div>
</label>
<label class="fn__flex config__item  b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about13}
         <div class="b3-label__text">${window.siyuan.languages.about14}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="token" value="${window.siyuan.config.api.token}" readonly="readonly">
</label>
<div class="b3-label${window.siyuan.config.system.container==="std"||window.siyuan.config.system.container==="docker"?"":" fn__none"}">
    ${window.siyuan.languages.networkProxy}
    <div class="b3-label__text">
        ${window.siyuan.languages.about17}
    </div>
    <div class="b3-label__text fn__flex config__item" style="padding: 4px 0 4px 4px;">
        <select id="aboutScheme" class="b3-select">
            <option value="" ${window.siyuan.config.system.networkProxy.scheme===""?"selected":""}>${window.siyuan.languages.directConnection}</option>
            <option value="socks5" ${window.siyuan.config.system.networkProxy.scheme==="socks5"?"selected":""}>SOCKS5</option>
            <option value="https" ${window.siyuan.config.system.networkProxy.scheme==="https"?"selected":""}>HTTPS</option>
            <option value="http" ${window.siyuan.config.system.networkProxy.scheme==="http"?"selected":""}>HTTP</option>
        </select>
        <span class="fn__space"></span>
        <input id="aboutHost" placeholder="Host/IP" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.host}"/>
        <span class="fn__space"></span>
        <input id="aboutPort" placeholder="Port" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.port}" type="number"/>
        <span class="fn__space"></span>
        <button id="aboutConfirm" class="b3-button fn__size200 b3-button--outline">${window.siyuan.languages.confirm}</button>
    </div>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span>${window.siyuan.languages.siyuanNote}</span>
        <span class="fn__space"></span>
        <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        <span class="fn__space"></span>
        <span style="color:var(--b3-theme-background);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</span>
    </div>
    <div class='fn__hr'></div>
    ${window.siyuan.languages.about1}
</div>`,bindEvent:()=>{window.siyuan.config.system.isInsider&&(Lt.element.querySelector("#isInsider").innerHTML="<span class='ft__secondary'>Insider Preview</span>");const n=Lt.element.querySelector("#token");n.addEventListener("click",()=>{n.select()}),Lt.element.querySelector("#exportLog").addEventListener("click",()=>{_("/api/system/exportLog",{},r=>{z(r.data.zip)})});const e=Lt.element.querySelector("#checkUpdateBtn");e.addEventListener("click",()=>{e.firstElementChild.classList.contains("fn__rotate")||(e.innerHTML=`<svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`,_("/api/system/checkUpdate",{showMsg:!0},()=>{e.innerHTML=`<svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`}))}),Lt.element.querySelector("#authCode").addEventListener("click",()=>{Fb()});const t=Lt.element.querySelector("#importKey");t.addEventListener("click",()=>{const r=new Le({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),c=r.element.querySelector("textarea");c.focus();const u=r.element.querySelectorAll(".b3-button");u[0].addEventListener("click",()=>{r.destroy()}),u[1].addEventListener("click",()=>{_("/api/repo/importRepoKey",{key:c.value},()=>{window.siyuan.config.repo.key=c.value,t.parentElement.classList.add("fn__none"),t.parentElement.nextElementSibling.classList.remove("fn__none"),r.destroy()})})}),Lt.element.querySelector("#initKey").addEventListener("click",()=>{Ne("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{_("/api/repo/initRepoKey",{},r=>{window.siyuan.config.repo.key=r.data.key,t.parentElement.classList.add("fn__none"),t.parentElement.nextElementSibling.classList.remove("fn__none")})})}),Lt.element.querySelector("#initKeyByPW").addEventListener("click",()=>{Hm(!1,()=>{t.parentElement.classList.add("fn__none"),t.parentElement.nextElementSibling.classList.remove("fn__none")})}),Lt.element.querySelector("#copyKey").addEventListener("click",()=>{q(window.siyuan.languages.copied),O(window.siyuan.config.repo.key)}),Lt.element.querySelector("#resetRepo").addEventListener("click",()=>{Ne("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{_("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,Jn(),t.parentElement.classList.remove("fn__none"),t.parentElement.nextElementSibling.classList.add("fn__none")})})}),Lt.element.querySelector("#purgeRepo").addEventListener("click",()=>{Ne("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{_("/api/repo/purgeRepo")})});const a=Lt.element.querySelector("#networkServe");a.addEventListener("change",()=>{_("/api/system/setNetworkServe",{networkServe:a.checked},()=>{Tt({reload:!1,onlyData:!1,errorExit:!0,cb:rs})})});const i=Lt.element.querySelector("#lockScreenMode");i.addEventListener("change",()=>{_("/api/system/setFollowSystemLockScreen",{lockScreenMode:i.checked?1:0},()=>{window.siyuan.config.system.lockScreenMode=i.checked?1:0})});const s=Lt.element.querySelector("#googleAnalytics");s.addEventListener("change",()=>{_("/api/system/setGoogleAnalytics",{googleAnalytics:s.checked},()=>{Tt({reload:!0,onlyData:!1,errorExit:!1})})});const o=Lt.element.querySelector("#uploadErrLog");o.addEventListener("change",()=>{_("/api/system/setUploadErrLog",{uploadErrLog:o.checked},()=>{Tt({reload:!1,onlyData:!1,errorExit:!0,cb:rs})})});const l=Lt.element.querySelector("#downloadInstallPkg");l.addEventListener("change",()=>{_("/api/system/setDownloadInstallPkg",{downloadInstallPkg:l.checked},()=>{window.siyuan.config.system.downloadInstallPkg=l.checked})}),Lt.element.querySelector("#aboutConfirm").addEventListener("click",()=>{const r=Lt.element.querySelector("#aboutScheme").value,c=Lt.element.querySelector("#aboutHost").value,u=Lt.element.querySelector("#aboutPort").value;_("/api/system/setNetworkProxy",{scheme:r,host:c,port:u},()=>{window.siyuan.config.system.networkProxy.scheme=r,window.siyuan.config.system.networkProxy.host=c,window.siyuan.config.system.networkProxy.port=u,Gu()})})}},xn={element:void 0,genHTML:()=>`<div class="fn__flex-column" style="height: 100%">
    <div class="layout-tab-bar fn__flex">
        <div class="item item--full item--focus" data-type="remove">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.unreferencedAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="missing">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.missingAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="config-assets" data-type="remove" data-init="true">
            <div class="fn__hr--b"></div>
            <label class="fn__flex">
                <div class="fn__space"></div>
                <button id="removeAll" class="b3-button b3-button--outline fn__flex-center fn__size200">
                    <svg class="svg"><use xlink:href="#iconTrashcan"></use></svg>
                    ${window.siyuan.languages.delete}
                </button>
            </label>
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="config-assets__preview"></div>
        </div>
        <div class="fn__none config-assets" data-type="missing">
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="fn__hr"></div>
        </div>
    </div>
</div>`,bindEvent:()=>{const n=xn.element.querySelector(".config-assets__list");xn.element.addEventListener("click",e=>{let t=e.target;for(;t&&!t.isEqualNode(xn.element);){const a=t.getAttribute("data-type");if(t.id==="removeAll")Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.clearAll}`,()=>{_("/api/asset/removeUnusedAssets",{},i=>{Ye().asset.forEach(s=>{i.data.paths.includes(s.path)&&s.parent.close()}),n.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,xn.element.querySelector(".config-assets__preview").innerHTML=""})});else if(t.classList.contains("item")&&!t.classList.contains("item--focus")){xn.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),t.classList.add("item--focus"),xn.element.querySelectorAll(".config-assets").forEach(i=>{a===i.getAttribute("data-type")?(i.classList.remove("fn__none"),i.getAttribute("data-init")||(_("/api/asset/getMissingAssets",{},s=>{xn._renderList(s.data.missingAssets,i.querySelector(".config-assets__list"),!1)}),i.setAttribute("data-init","true"))):i.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(a==="copy")O(t.parentElement.querySelector(".b3-list-item__text").textContent.trim());else if(a!=="open"){if(a==="clear"){const i=t.parentElement.getAttribute("data-path");Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.delete} <b>${xe().basename(i)}</b>`,()=>{_("/api/asset/removeUnusedAsset",{path:i},s=>{Ye().asset.forEach(l=>{s.data.path===l.path&&l.parent.parent.removeTab(l.parent.id)});const o=t.parentElement;o.parentElement.querySelectorAll("li").length===1?o.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`:o.remove(),xn.element.querySelector(".config-assets__preview").innerHTML=""})}),e.preventDefault(),e.stopPropagation();break}}t=t.parentElement}}),n.addEventListener("mouseover",e=>{const t=$(e.target,"b3-list-item");if(t&&t.getAttribute("data-path")!==n.nextElementSibling.getAttribute("data-path")){const a=t.getAttribute("data-path");n.nextElementSibling.setAttribute("data-path",a),n.nextElementSibling.innerHTML=ai(a)}}),_("/api/asset/getUnusedAssets",{},e=>{xn._renderList(e.data.unusedAssets,n)})},_renderList:(n,e,t=!0)=>{let a="",i="";!(0,T.jU)()&&t&&(i=`<span data-type="open" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`);let s="";t?s=`<span data-type="clear" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`:s=`<span data-type="copy" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.copy}">
    <svg><use xlink:href="#iconCopy"></use></svg>
</span>`,n.forEach(o=>{const l=o.indexOf("assets/"),r=o.substr(l);a+=`<li data-path="${r}"  class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__text">${De(o)}</span>
    ${i}
    ${s}
</li>`}),e.innerHTML=a||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`}};var wE=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});let ze;const yE=n=>{let e,t;document.addEventListener("mouseover",a=>{if(!window.siyuan.config)return;const i=S(a.target,"data-type","a",!0)||S(a.target,"data-type","tab-header")||$(a.target,"av__celltext")||$(a.target,"ariaLabel")||S(a.target,"data-type","inline-memo");if(i){let s=i.getAttribute("aria-label")||i.getAttribute("data-inline-memo-content");if(S(a.target,"data-type","fold",!0)&&(s=window.siyuan.languages.fold),i.classList.contains("av__celltext"))if(i.scrollWidth>i.parentElement.clientWidth-11)s=i.textContent;else return;if(!s){s=i.getAttribute("data-href");const o=i.getAttribute("data-title");o&&(s+="<br>"+o)}if(s&&!s.startsWith("siyuan://blocks")&&!i.classList.contains("b3-tooltips")){dl(s,i),a.stopPropagation();return}}else if(!i){const s=S(a.target,"id","tooltip",!0);(!s||s&&s.clientHeight>=s.scrollHeight&&s.clientWidth>=s.scrollWidth)&&Mn()}if(window.siyuan.config.editor.floatWindowMode===1||window.siyuan.shiftIsPressed){if(clearTimeout(t),t=window.setTimeout(()=>{Sm(a)},200),!Lm(a,i)||a.relatedTarget&&!document.contains(a.relatedTarget))return;window.siyuan.ctrlIsPressed?(clearTimeout(t),bo(n)):window.siyuan.shiftIsPressed&&(clearTimeout(t),bo(n,!0));return}clearTimeout(e),clearTimeout(t),t=window.setTimeout(()=>{Sm(a)&&!ze&&!i&&clearTimeout(e)},200),e=window.setTimeout(()=>{Lm(a,i)&&(clearTimeout(t),bo(n))},620)})},Sm=n=>{var e;if($(n.target,"b3-menu")||n.target.id&&n.target.tagName!=="svg"&&(n.target.id.startsWith("minder_node")||n.target.id.startsWith("kity_")||n.target.id.startsWith("node_"))||n.target.classList.contains("counter")||n.target.tagName==="circle")return!1;ze=S(n.target,"data-type","block-ref")||S(n.target,"data-type","virtual-block-ref"),ze&&ze.classList.contains("b3-tooltips")&&(ze=void 0),ze||(ze=$(n.target,"popover__block"));const t=S(n.target,"data-type","a",!0);if(!ze&&t&&((e=t.getAttribute("data-href"))!=null&&e.startsWith("siyuan://blocks"))&&(ze=t),!ze){let a=n.target;!a.parentElement&&n.path&&n.path[1]&&(a=n.path[1]);const i=$(a,"block__popover",!0),s={oid:0};if(window.siyuan.blockPanels.forEach(o=>{if((o.targetElement||typeof o.x=="number")&&o.element.getAttribute("data-pin")==="true"){const l=parseInt(o.element.getAttribute("data-level")),r=o.element.getAttribute("data-oid");s[r]?l>s[r]&&(s[r]=l):s[r]=l}}),i)for(let o=0;o<window.siyuan.blockPanels.length;o++){const l=window.siyuan.blockPanels[o];(l.targetElement||typeof l.x=="number")&&parseInt(l.element.getAttribute("data-level"))>(s[l.element.getAttribute("data-oid")]||0)&&l.element.getAttribute("data-pin")==="false"&&parseInt(l.element.getAttribute("data-level"))>parseInt(i.getAttribute("data-level"))&&(l.destroy(),o--)}else for(let o=0;o<window.siyuan.blockPanels.length;o++){const l=window.siyuan.blockPanels[o];(l.targetElement||typeof l.x=="number")&&l.element.getAttribute("data-pin")==="false"&&parseInt(l.element.getAttribute("data-level"))>(s[l.element.getAttribute("data-oid")]||0)&&(l.destroy(),o--)}}},Lm=(n,e)=>{var t;if($(n.target,"history__repo",!0)||(ze=S(n.target,"data-type","block-ref")||S(n.target,"data-type","virtual-block-ref"),ze&&ze.classList.contains("b3-tooltips")&&(ze=void 0),ze||(ze=$(n.target,"popover__block")),!ze&&e&&((t=e.getAttribute("data-href"))!=null&&t.startsWith("siyuan://blocks")&&e.getAttribute("prevent-popover")!=="true"||e.classList.contains("av__celltext")&&e.dataset.type==="url")&&(ze=e),!ze||window.siyuan.altIsPressed||window.siyuan.config.editor.floatWindowMode===0&&window.siyuan.ctrlIsPressed||ze&&ze.getAttribute("prevent-popover")==="true"))return!1;if(ze&&getSelection().rangeCount>0){const a=getSelection().getRangeAt(0);if(a.toString()!==""&&ze.contains(a.startContainer))return!1}return!0},bo=(n,e=!1)=>wE(void 0,null,function*(){var t,a;if(!ze)return;let i,s;const o=ze.getAttribute("data-id");if(o)if(e){const r=yield kt("/api/block/getRefIDs",{id:o});i=r.data.refIDs,s=r.data.defIDs}else o.startsWith("[")?i=JSON.parse(o):i=[o],s=JSON.parse(ze.getAttribute("data-defids")||"[]");else if(((t=ze.getAttribute("data-type"))==null?void 0:t.indexOf("virtual-block-ref"))>-1){const r=M(ze);r&&(i=(yield kt("/api/block/getBlockDefIDsByRefText",{anchor:ze.textContent,excludeIDs:[r.getAttribute("data-node-id")]})).data)}else if((a=ze.getAttribute("data-type"))!=null&&a.split(" ").includes("a"))i=[Jl(ze.getAttribute("data-href"))];else if(ze.dataset.type==="url")i=[Jl(ze.textContent.trim())];else{let r,c="/api/block/getRefIDs";ze.classList.contains("protyle-attr--refcount")?r=ze.parentElement.parentElement.getAttribute("data-node-id"):ze.classList.contains("pdf__rect")?(r=ze.getAttribute("data-node-id"),c="/api/block/getRefIDsByFileAnnotationID"):r||(r=ze.parentElement.getAttribute("data-node-id"));const u=yield kt(c,{id:r});i=u.data.refIDs,s=u.data.defIDs}let l=!1;window.siyuan.blockPanels.find(r=>{if((r.targetElement||typeof r.x=="number")&&r.element.getAttribute("data-pin")==="true"&&JSON.stringify(i)===JSON.stringify(r.nodeIds))return l=!0,!0}),!l&&ze.parentElement&&ze.parentElement.style.opacity!=="0.1"&&window.siyuan.blockPanels.push(new uo({app:n,targetElement:ze,isBacklink:e||ze.classList.contains("protyle-attr--refcount")||ze.classList.contains("counter"),nodeIds:i,defIds:s}))}),Cm=n=>{const e=new Le({width:"80vw",height:"70vh",content:`<div class="fn__flex-column" style="border-radius: var(--b3-border-radius-b);overflow:hidden;">
    <div class="b3-form__icon search__header">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-text-field b3-text-field--text" style="padding-left: 32px !important;">
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1" id="commands"></ul>
    <div class="fn__hr"></div>
</div>`}),t=e.element.querySelector("#commands");if(n.plugins.forEach(i=>{i.commands.forEach(s=>{const o=document.createElement("li");o.classList.add("b3-list-item"),o.innerHTML=`<span class="b3-list-item__text">${i.displayName}: ${s.langText||i.i18n[s.langKey]}</span>
<span class="b3-list-item__meta">${ae(s.customHotkey)}</span>`,o.addEventListener("click",()=>{s.callback?s.callback():s.globalCallback&&s.globalCallback(),e.destroy()}),t.insertAdjacentElement("beforeend",o)})}),t.childElementCount===0){const i=document.createElement("li");i.classList.add("b3-list-item"),i.innerHTML=`<span class="b3-list-item__text">${window.siyuan.languages.commandEmpty}</span>`,i.addEventListener("click",()=>{e.destroy(),yi(n).element.querySelector('.b3-tab-bar [data-name="bazaar"]').dispatchEvent(new CustomEvent("click"))}),t.insertAdjacentElement("beforeend",i)}else t.firstElementChild.classList.add("b3-list-item--focus");const a=e.element.querySelector(".b3-text-field");a.focus(),a.addEventListener("keydown",i=>{if(i.stopPropagation(),!i.isComposing)if(En(t,i),i.key==="Enter"){const s=t.querySelector(".b3-list-item--focus");s&&s.dispatchEvent(new CustomEvent("click")),e.destroy()}else i.key==="Escape"&&e.destroy()}),a.addEventListener("compositionend",()=>{xm(a,t)}),a.addEventListener("input",i=>{i.isComposing||(i.stopPropagation(),xm(a,t))})},xm=(n,e)=>{const t=n.value.toLowerCase();Array.from(e.children).forEach(a=>{const i=a.querySelector(".b3-list-item__text").textContent.toLowerCase();t.indexOf(i)>-1||i.indexOf(t)>-1?a.classList.remove("fn__none"):a.classList.add("fn__none")})},ou=(n,e)=>({label:`${n.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}`,icon:e,current:!n.pin,click(){n.togglePin()}}),Am=(n,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barWorkspace"){window.siyuan.menus.menu.remove();return}_("/api/system/getWorkspaces",{},t=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barWorkspace"),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.config,icon:"iconSettings",accelerator:window.siyuan.config.keymap.general.config.custom,click:()=>{yi(n)}}).element);const a=[];if(Kl().forEach(s=>{a.push({icon:s.icon,accelerator:s.hotkey,label:s.title,click(){At(s.type).toggleModel(s.type)}})}),window.siyuan.config.readonly||(a.push({type:"separator"}),a.push(ou(window.siyuan.layout.leftDock,"iconLeftTop")),a.push(ou(window.siyuan.layout.rightDock,"iconRightTop")),a.push(ou(window.siyuan.layout.bottomDock,"iconBottomLeft"))),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.panels,icon:"iconDock",type:"submenu",submenu:a}).element),!window.siyuan.config.readonly){let s;s=[{label:window.siyuan.languages.new,iconHTML:"",click(){const o=new Le({title:window.siyuan.languages.new,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),l=o.element.querySelector("input");l.focus();const r=o.element.querySelectorAll(".b3-button");r[0].addEventListener("click",()=>{o.destroy()}),r[1].addEventListener("click",()=>{_("/api/system/createWorkspaceDir",{path:xe().join(xe().dirname(window.siyuan.config.system.workspaceDir),l.value)},()=>{o.destroy()})})}},{label:`${window.siyuan.languages.openBy}...`,iconHTML:"",click(){_("/api/system/getMobileWorkspaces",{},o=>{let l="";o.data.forEach((u,d)=>{l+=`<option value="${u}"${d===0?' selected="selected"':""}>${xe().basename(u)}</option>`});const r=new Le({title:window.siyuan.languages.openBy,content:`<div class="b3-dialog__content">
    <select class="b3-text-field fn__block">${l}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),c=r.element.querySelectorAll(".b3-button");c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{const u=r.element.querySelector("select").value;if(u===window.siyuan.config.system.workspaceDir){r.destroy();return}Ne(window.siyuan.languages.confirm,`${xe().basename(window.siyuan.config.system.workspaceDir)} -> ${xe().basename(u)}?`,()=>{_("/api/system/setWorkspaceDir",{path:u},()=>{rs()})})})})}}],s.push({type:"separator"}),t.data.forEach(o=>{s.push({iconHTML:p.Constants.ZWSP,action:"iconCloseRound",current:window.siyuan.config.system.workspaceDir===o.path,label:xe().basename(o.path),bind(l){l.addEventListener("click",r=>{if($(r.target,"b3-menu__action")){r.preventDefault(),r.stopPropagation(),_("/api/system/removeWorkspaceDir",{path:o.path},()=>{Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeWorkspacePhysically.replace("${x}",o.path),()=>{_("/api/system/removeWorkspaceDirPhysically",{path:o.path})})});return}Ne(window.siyuan.languages.confirm,`${xe().basename(window.siyuan.config.system.workspaceDir)} -> ${xe().basename(o.path)}?`,()=>{_("/api/system/setWorkspaceDir",{path:o.path},()=>{rs()})})})}})}),(!(0,T.jU)()||Rt()||Mt())&&window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.workspaceList,icon:"iconWorkspace",type:"submenu",submenu:s}).element)}const i=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.save,click(){const s=new Le({title:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),o=s.element.querySelectorAll(".b3-button");s.bindInput(s.element.querySelector("input"),()=>{o[1].dispatchEvent(new CustomEvent("click"))}),o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(!l){q(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].find(c=>{if(c.name===l)return s.destroy(),Ne(window.siyuan.languages.save,window.siyuan.languages.exportTplTip,()=>{c.layout=Tt({reload:!1,onlyData:!0,errorExit:!1}),Ue(p.Constants.LOCAL_LAYOUTS,window.siyuan.storage[p.Constants.LOCAL_LAYOUTS])}),!0})||(window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].push({name:l,layout:Tt({reload:!1,onlyData:!0,errorExit:!1})}),Ue(p.Constants.LOCAL_LAYOUTS,window.siyuan.storage[p.Constants.LOCAL_LAYOUTS]),s.destroy())})}}];if(window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].forEach(s=>{i.push({iconHTML:p.Constants.ZWSP,action:"iconCloseRound",label:s.name,bind(o){o.addEventListener("click",l=>{if($(l.target,"b3-menu__action")){l.preventDefault(),l.stopPropagation(),window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].find((r,c)=>{if(r.name===s.name)return o.remove(),window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].splice(c,1),Ue(p.Constants.LOCAL_LAYOUTS,window.siyuan.storage[p.Constants.LOCAL_LAYOUTS]),!0});return}_("/api/system/setUILayout",{layout:s.layout},()=>{window.location.reload()})})}})}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.layout,icon:"iconLayout",type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element),!window.siyuan.config.readonly){if(Wd()<2)window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.dailyNote,icon:"iconCalendar",accelerator:window.siyuan.config.keymap.general.dailyNote.custom,click:()=>{Yf()}}).element);else{const s=[];window.siyuan.notebooks.forEach(o=>{o.closed||s.push({label:De(o.name),iconHTML:fe(o.icon||p.Constants.SIYUAN_IMAGE_NOTE,"b3-menu__icon",!0),accelerator:window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]===o.id?window.siyuan.config.keymap.general.dailyNote.custom:"",click:()=>{_("/api/filetree/createDailyNote",{notebook:o.id,app:p.Constants.SIYUAN_APPID}),window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]=o.id,Ue(p.Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID])}})}),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.dailyNote,icon:"iconCalendar",type:"submenu",submenu:s}).element)}window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.general.riffCard.custom,click:()=>{Qs(n)}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{es(n,"",window.siyuan.languages.all,"")}}]}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.lockScreen,icon:"iconLock",accelerator:window.siyuan.config.keymap.general.lockScreen.custom,click:()=>{jh()}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.dataHistory,icon:"iconHistory",accelerator:window.siyuan.config.keymap.general.dataHistory.custom,click:()=>{zc(n)}}).element),window.siyuan.menus.menu.append(new I({type:"separator"}).element)}window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.help,icon:"iconHelp",click:()=>{El()}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.popup({x:e.left,y:e.bottom})})},hk=n=>{},mk=n=>{},Tm=(n,e)=>{e.preventDefault();let t=e.target;for(;!t.isSameNode(An.element);){if(t.classList.contains("b3-list-item")){const a=t.getAttribute("data-type");if(a)a==="riffCard"?Qs(n):At(a).toggleModel(a,!0);else{const i=t.getAttribute("data-id");Zn().find(s=>{if(s.id===i)return s.parent.switchTab(s.headElement),s.parent.showHeading(),!0})}An.destroy(),An=void 0;break}t=t.parentElement}},Im=(n,e,t)=>{let a=e.querySelector(".b3-list-item--focus");if(a){if(a.classList.remove("b3-list-item--focus"),t.key==="ArrowUp")a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus");else if(t.key==="ArrowDown")a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus");else if(t.key==="ArrowLeft"||t.key==="ArrowRight")if((0,T.FJ)())a.classList.add("b3-list-item--focus");else{const l=a.parentElement.previousElementSibling||a.parentElement.nextElementSibling;(l.querySelector(`[data-index="${a.getAttribute("data-index")}"]`)||l.lastElementChild).classList.add("b3-list-item--focus")}else if(t.key==="Enter"){const l=a.getAttribute("data-type");l?l==="riffCard"?Qs(n):At(l).toggleModel(l,!0):be({app:n,id:a.getAttribute("data-node-id"),action:[p.Constants.CB_GET_SCROLL]}),ne(["dialog"]);return}a=e.querySelector(".b3-list-item--focus");const i=a.getAttribute("data-node-id");i?_("/api/filetree/getFullHPathByID",{id:i},l=>{a.parentElement.parentElement.nextElementSibling.innerHTML=De(l.data)}):a.parentElement.parentElement.nextElementSibling.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const s=a.getBoundingClientRect(),o=a.parentElement.getBoundingClientRect();s.top<o.top?a.scrollIntoView(!0):s.bottom>o.bottom&&a.scrollIntoView(!1)}},_E=(n,e)=>{var t,a,i;const s=document.querySelector(".layout__wnd--active .item--focus");let o,l;getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));const r=document.querySelector(".layout__tab--active");let c=!1;if(r&&r.classList.contains("sy__file")&&(c=!0),l&&window.siyuan.dialogs.find(f=>{if(f.editor&&f.editor.protyle.element.contains(l.startContainer))return o=f.editor.protyle,c=!1,!0}),!o&&s){const f=St(s.getAttribute("data-id"));if(f.model instanceof gt)o=f.model.editor.protyle;else if(f.model instanceof Oa)o=f.model.edit.protyle;else if(f.model instanceof wa&&((t=f.model.data)==null?void 0:t.editor)instanceof hn)o=f.model.data.editor.protyle;else return!1}else if(!o){!o&&l&&window.siyuan.blockPanels.find(g=>{if(g.editors.find(h=>{if(h.protyle.element.contains(l.startContainer))return o=h.protyle,!0}),o)return!0});const f=Ye();if(o||f.backlink.find(g=>{if(g.element.classList.contains("layout__tab--active"))return l&&g.editors.find(h=>{if(h.protyle.element.contains(l.startContainer))return o=h.protyle,!0}),o||(o=g.editors[0].protyle),!0}),o||f.editor.find(g=>{if(g.parent.headElement.classList.contains("item--focus"))return o=g.editor.protyle,!0}),!o)return!1}let u="";if(U(window.siyuan.config.keymap.general.replace.custom,e)?u=window.siyuan.config.keymap.general.replace.custom:U(window.siyuan.config.keymap.general.search.custom,e)&&(u=window.siyuan.config.keymap.general.search.custom),!c&&u)return l&&o.element.contains(l.startContainer)?pn({app:n,hotkey:u,key:l.toString(),notebookId:o.notebookId,searchPath:o.path}):pn({app:n,hotkey:u}),e.preventDefault(),!0;if(!c&&U(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e)){if((a=o.title)!=null&&a.editElement.contains(l.startContainer))ao(o,[o.title.element]);else{const f=[];if(o.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(g=>{f.push(g)}),f.length===0){const g=M(l.startContainer);g&&f.push(g)}ao(o,f)}return e.preventDefault(),!0}if(!c&&U(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e))return _("/api/riff/getTreeRiffDueCards",{rootID:o.block.rootID},f=>{ri(n,f.data,"doc",o.block.rootID,o.title.editElement.textContent||"Untitled")}),e.preventDefault(),!0;if(!c&&U(window.siyuan.config.keymap.general.move.custom,e)){let f,g;if(getSelection().rangeCount>0&&(f=getSelection().getRangeAt(0),g=M(f.startContainer)),(i=o.title)!=null&&i.editElement.contains(f.startContainer))ya((h,m)=>{Vd([o.path],m[0],h[0])},[o.path],f);else if(g&&f&&o.element.contains(f.startContainer)){let h=Array.from(o.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[g]),ya(m=>{Mc(m[0],h,o)})}return e.preventDefault(),!0}const d=e.target;return d.tagName!=="TABLE"&&(d.tagName==="INPUT"||d.tagName==="TEXTAREA")?!1:U(window.siyuan.config.keymap.editor.general.refresh.custom,e)?(zn(o,!0),e.preventDefault(),!0):U(window.siyuan.config.keymap.editor.general.fullscreen.custom,e)?(kl(o.element),Bt(o),e.preventDefault(),!0):U(window.siyuan.config.keymap.editor.general.preview.custom,e)?(ss(o,"preview"),e.preventDefault(),!0):U(window.siyuan.config.keymap.editor.general.wysiwyg.custom,e)&&!o.options.backlinkData?(ss(o,"wysiwyg"),o.scroll.lastScrollTop=0,_("/api/filetree/getDoc",{id:o.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},f=>{dt({data:f,protyle:o})}),e.preventDefault(),!0):$(d,"protyle-title__input")?!1:U(window.siyuan.config.keymap.editor.general.undo.custom,e)?(o.undo.undo(o),e.preventDefault(),!0):U(window.siyuan.config.keymap.editor.general.redo.custom,e)?(o.undo.redo(o),e.preventDefault(),!0):!1},vE=(n,e)=>{var t,a;const i=At("file");if(!i)return!1;const s=i.data.file;if(U(window.siyuan.config.keymap.general.selectOpen1.custom,e)){e.preventDefault();const h=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus")||document.querySelector(".layout-tab-bar > .item--focus");if(h){const m=St(h.getAttribute("data-id"));m&&m.model instanceof gt&&(m.model.editor.protyle.wysiwyg.element.blur(),m.model.editor.protyle.title.editElement.blur(),s.selectItem(m.model.editor.protyle.notebookId,m.model.editor.protyle.path))}i.toggleModel("file",!0);return}if(!s.element.parentElement.classList.contains("layout__tab--active"))return!1;let o=!1;if(n.plugins.find(h=>{if(h.commands.find(m=>{if(m.fileTreeCallback&&U(m.customHotkey,e))return o=!0,m.fileTreeCallback(s),!0}),o)return!0}),o)return!0;const l=Array.from(s.element.querySelectorAll(".b3-list-item--focus"));if(l.length===0){if(e.key.startsWith("Arrow")&&!ye(e)){const h=s.element.querySelector(".b3-list-item");h&&h.classList.add("b3-list-item--focus"),e.preventDefault()}return!1}const r=ve(l[0],"UL");if(!r)return!1;const c=r.getAttribute("data-url"),u=l[0].getAttribute("data-path"),d=l[0].getAttribute("data-type")==="navigation-file";if(U(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e))if(d){const h=l[0].getAttribute("data-node-id");_("/api/riff/getTreeRiffDueCards",{rootID:h},m=>{ri(n,m.data,"doc",h,pt(l[0].getAttribute("data-name"),!1,!0))})}else _("/api/riff/getNotebookRiffDueCards",{notebook:c},h=>{ri(n,h.data,"notebook",c,Xn(c))});if(U(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e)){const h=[];return l.forEach(m=>{const b=m.getAttribute("data-node-id");b&&h.push(b)}),h.length>0&&G(void 0,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:h}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:h}]),e.preventDefault(),!0}if(U(window.siyuan.config.keymap.editor.general.rename.custom,e))return window.siyuan.menus.menu.remove(),_c({notebookId:c,path:u,name:d?pt(l[0].getAttribute("data-name"),!1,!0):Xn(c),type:d?"file":"notebook"}),e.preventDefault(),!0;if(U("\u2318/",e)){const h=l[0].getBoundingClientRect();return d?$l(n,c,u,l[0]).popup({x:h.right-15,y:h.top+15}):Dl(n,l[0]).popup({x:h.right-15,y:h.top+15}),!0}if(d&&U(window.siyuan.config.keymap.general.move.custom,e)){window.siyuan.menus.menu.remove();const h=Ud(l);return ya((m,b)=>{Vd(h,b[0],m[0])},h),e.preventDefault(),!0}if(d&&U(window.siyuan.config.keymap.editor.general.insertRight.custom,e))return window.siyuan.menus.menu.remove(),be({app:n,id:l[0].getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS],position:"right"}),e.preventDefault(),!0;let f="";if(U(window.siyuan.config.keymap.general.replace.custom,e)?f=window.siyuan.config.keymap.general.replace.custom:U(window.siyuan.config.keymap.general.search.custom,e)&&(f=window.siyuan.config.keymap.general.search.custom),f)return window.siyuan.menus.menu.remove(),pn(d?{app:n,hotkey:f,notebookId:c,searchPath:pt(u,!1,!0)}:{app:n,hotkey:f,notebookId:c}),e.preventDefault(),!0;const g=e.target;if(g.tagName==="INPUT"||g.tagName==="TEXTAREA"||S(g,"contenteditable",null)||$(g,"protyle",!0))return!1;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(e.code.startsWith("Arrow")||e.code==="Enter")&&!e.altKey&&!e.shiftKey&&!ye(e))return e.preventDefault(),!0;if(e.shiftKey){if(e.key==="ArrowUp"){const h=Sl(l);let m;if(h.startElement.getBoundingClientRect().top>=h.endElement.getBoundingClientRect().top?(m=aa(h.endElement),m&&(m.classList.add("b3-list-item--focus"),m.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end"))):(h.endElement.classList.remove("b3-list-item--focus"),h.endElement.removeAttribute("select-end"),m=aa(h.endElement),m&&m.setAttribute("select-end","true")),m){const b=m.getBoundingClientRect(),y=s.element.getBoundingClientRect();(b.top<y.top||b.bottom>y.bottom)&&m.scrollIntoView(b.top<y.top)}}else if(e.key==="ArrowDown"){const h=Sl(l);let m;if(h.startElement.getBoundingClientRect().top<=h.endElement.getBoundingClientRect().top?(m=Aa(h.endElement),m&&(m.classList.add("b3-list-item--focus"),m.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end"))):(h.endElement.classList.remove("b3-list-item--focus"),h.endElement.removeAttribute("select-end"),m=Aa(h.endElement),m&&m.setAttribute("select-end","true")),m){const b=m.getBoundingClientRect(),y=s.element.getBoundingClientRect();(b.top<y.top||b.bottom>y.bottom)&&m.scrollIntoView(b.top<y.top)}}return}else if(!ye(e)){if((t=s.element.querySelector('[select-end="true"]'))==null||t.removeAttribute("select-end"),(a=s.element.querySelector('[select-start="true"]'))==null||a.removeAttribute("select-start"),e.key==="ArrowRight"&&!l[0].querySelector(".b3-list-item__arrow--open")&&!l[0].querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||e.key==="ArrowLeft"&&l[0].querySelector(".b3-list-item__arrow--open"))return s.getLeaf(l[0],c),l.forEach((h,m)=>{m!==0&&h.classList.remove("b3-list-item--focus")}),e.preventDefault(),!0;if(e.key==="ArrowLeft"){let h=l[0].parentElement.previousElementSibling;if(h){h.tagName!=="LI"&&(h=s.element.querySelector(".b3-list-item")),l.forEach(y=>{y.classList.remove("b3-list-item--focus")}),h.classList.add("b3-list-item--focus");const m=h.getBoundingClientRect(),b=s.element.getBoundingClientRect();(m.top<b.top||m.bottom>b.bottom)&&h.scrollIntoView(m.top<b.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let h=l[0];for(;h;)if(h.nextElementSibling){h.nextElementSibling.tagName==="UL"?h=h.nextElementSibling.firstElementChild:h=h.nextElementSibling;break}else{if(h.parentElement.classList.contains("fn__flex-1"))break;h=h.parentElement}if(h.classList.contains("b3-list-item")){l.forEach(y=>{y.classList.remove("b3-list-item--focus")}),h.classList.add("b3-list-item--focus");const m=h.getBoundingClientRect(),b=s.element.getBoundingClientRect();(m.top<b.top||m.bottom>b.bottom)&&h.scrollIntoView(m.top<b.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let h=l[0];for(;h;)if(h.previousElementSibling){if(h.previousElementSibling.tagName==="LI")h=h.previousElementSibling;else{const m=h.previousElementSibling.querySelectorAll(".b3-list-item");h=m[m.length-1]}break}else{if(h.parentElement.classList.contains("fn__flex-1"))break;h=h.parentElement}if(h.classList.contains("b3-list-item")){l.forEach(y=>{y.classList.remove("b3-list-item--focus")}),h.classList.add("b3-list-item--focus");const m=h.getBoundingClientRect(),b=s.element.getBoundingClientRect();(m.top<b.top||m.bottom>b.bottom)&&h.scrollIntoView(m.top<b.top)}return e.preventDefault(),!0}}if(e.key==="Delete"||e.key==="Backspace"&&Ot())return window.siyuan.menus.menu.remove(),Al(l),!0;if(e.key==="Enter")return window.siyuan.menus.menu.remove(),l.forEach(h=>{if(h.getAttribute("data-type")==="navigation-file")be({app:n,id:h.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS]});else{const m=ve(h,"UL");m&&s.getLeaf(h,m.getAttribute("data-url"))}}),!0},EE=(n,e)=>{var t;const a=e.target;if(a.tagName==="INPUT"||a.tagName==="TEXTAREA"||S(a,"contenteditable",null)||$(a,"protyle",!0))return!1;let i=document.querySelector(".layout__tab--active");if(i||Array.from(document.querySelectorAll(".layout__wnd--active .layout-tab-container > div")).find(d=>{if(!d.classList.contains("fn__none")&&d.className.indexOf("sy__")>-1)return i=d,!0}),!i||i.className.indexOf("sy__")===-1)return!1;let s=!1;if(n.plugins.find(d=>{if(d.commands.find(f=>{if(f.dockCallback&&U(f.customHotkey,e))return s=!0,f.dockCallback(i),!0}),s)return!0}),s)return!0;if(!U(window.siyuan.config.keymap.editor.general.collapse.custom,e)&&!U(window.siyuan.config.keymap.editor.general.expand.custom,e)&&!e.key.startsWith("Arrow")&&e.key!=="Enter")return!1;if(!e.repeat&&U(window.siyuan.config.keymap.editor.general.collapse.custom,e)){const d=i.querySelector('.block__icon[data-type="collapse"]');if(d)return d.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(!e.repeat&&U(window.siyuan.config.keymap.editor.general.expand.custom,e)){const d=i.querySelector('.block__icon[data-type="expand"]');if(d)return d.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(i.classList.contains("sy__inbox")||i.classList.contains("sy__globalGraph")||i.classList.contains("sy__graph"))return!1;const o=(t=St(i.getAttribute("data-id"),window.siyuan.layout.layout))==null?void 0:t.model;if(!o)return!1;let l=i.querySelector(".b3-list-item--focus");if(!l)return l=i.querySelector(".b3-list .b3-list-item"),l&&l.classList.add("b3-list-item--focus"),!1;let r=o.tree;if(l.parentElement.parentElement.classList.contains("backlinkMList")&&(r=o.mTree),!r)return!1;if(e.key==="Enter")return r.click(l),e.preventDefault(),!0;const c=l.querySelector(".b3-list-item__arrow");if(e.key==="ArrowRight"&&!c.classList.contains("b3-list-item__arrow--open")&&!c.parentElement.classList.contains("fn__hidden")||e.key==="ArrowLeft"&&c.classList.contains("b3-list-item__arrow--open")&&!c.parentElement.classList.contains("fn__hidden"))return r.toggleBlocks(l),e.preventDefault(),!0;const u=$(l,"b3-list");if(!u)return!1;if(e.key==="ArrowLeft"){let d=l.parentElement.previousElementSibling;if(d){d.tagName!=="LI"&&(d=u.querySelector(".b3-list-item")),l.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus");const f=d.getBoundingClientRect(),g=u.parentElement.getBoundingClientRect();(f.top<g.top||f.bottom>g.bottom)&&d.scrollIntoView(f.top<g.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let d=l;for(;d;)if(d.nextElementSibling){d.nextElementSibling.tagName==="UL"?d.nextElementSibling.classList.contains("fn__none")?d.nextElementSibling.nextElementSibling&&(d=d.nextElementSibling.nextElementSibling):d=d.nextElementSibling.firstElementChild:d.nextElementSibling.classList.contains("protyle")?d.nextElementSibling.nextElementSibling&&(d=d.nextElementSibling.nextElementSibling):d=d.nextElementSibling;break}else{if(d.parentElement.classList.contains("fn__flex-1"))break;d=d.parentElement}if(d.classList.contains("b3-list-item")&&!d.classList.contains("b3-list-item--focus")){l.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus");const f=d.getBoundingClientRect(),g=u.parentElement.getBoundingClientRect();(f.top<g.top||f.bottom>g.bottom)&&d.scrollIntoView(f.top<g.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let d=l;for(;d;)if(d.previousElementSibling){if(d.previousElementSibling.tagName==="LI")d=d.previousElementSibling;else if(d.previousElementSibling.classList.contains("protyle"))d.previousElementSibling.previousElementSibling&&(d=d.previousElementSibling.previousElementSibling);else if(d.previousElementSibling.tagName==="UL"&&d.previousElementSibling.classList.contains("fn__none"))d.previousElementSibling.previousElementSibling&&(d=d.previousElementSibling.previousElementSibling);else{const f=d.previousElementSibling.querySelectorAll(".b3-list-item");d=f[f.length-1]}break}else{if(d.parentElement.classList.contains("fn__flex-1"))break;d=d.parentElement}if(d.classList.contains("b3-list-item")&&!d.classList.contains("b3-list-item--focus")){l.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus");const f=d.getBoundingClientRect(),g=u.parentElement.getBoundingClientRect();(f.top<g.top||f.bottom>g.bottom)&&d.scrollIntoView(f.top<g.top)}return e.preventDefault(),!0}return!1};let An;const kE=(n,e)=>{var t;if(document.querySelector(".av__mask")||document.getElementById("errorLog")||e.isComposing)return;const a=e.target;if(!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&!["INPUT","TEXTAREA"].includes(a.tagName)&&["0","1","2","3","4","j","k","l",";","s"," ","p"].includes(e.key.toLowerCase())){let c;if(window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===window.siyuan.config.keymap.general.riffCard.custom)return c=u.element,!0}),c||(c=document.querySelector(`.layout__wnd--active div[data-key="${window.siyuan.config.keymap.general.riffCard.custom}"]:not(.fn__none)`)),c){e.preventDefault(),c.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()}));return}}if(!e.ctrlKey&&!ye(e)&&e.key!=="Escape"&&!e.shiftKey&&!e.altKey&&!/^F\d{1,2}$/.test(e.key)&&e.key.indexOf("Arrow")===-1&&e.key!=="Enter"&&e.key!=="Backspace"&&e.key!=="Delete")return;if(!e.altKey&&!e.shiftKey&&ye(e)&&(e.key==="Meta"||e.key==="Control"||e.ctrlKey||e.metaKey?(window.siyuan.ctrlIsPressed=!0,(e.key==="Meta"||e.key==="Control")&&window.siyuan.config.editor.floatWindowMode===1&&!e.repeat&&bo(n)):window.siyuan.ctrlIsPressed=!1),!e.altKey&&e.shiftKey&&!ye(e)&&(e.key==="Shift"?(window.siyuan.shiftIsPressed=!0,e.repeat||bo(n,!0)):window.siyuan.shiftIsPressed=!1),e.altKey&&!e.shiftKey&&!ye(e)&&(e.key==="Alt"?window.siyuan.altIsPressed=!0:window.siyuan.altIsPressed=!1),An&&e.ctrlKey&&!e.metaKey&&e.key.startsWith("Arrow")){Im(n,An.element,e);return}const i=(0,T.FJ)();if(e.ctrlKey&&!e.metaKey&&e.key==="Tab"){if(An&&An.element.parentElement)return;let c="",u=document.querySelector(".layout__wnd--active .layout-tab-bar > .item--focus");if(u||(u=document.querySelector(".layout-tab-bar > .item--focus")),u){const f=u.getAttribute("data-id");Zn().sort((g,h)=>g.headElement.getAttribute("data-activetime")>h.headElement.getAttribute("data-activetime")?-1:1).forEach((g,h)=>{let m=`<svg class="b3-list-item__graphic"><use xlink:href="#${g.icon}"></use></svg>`,b="";const y=g.headElement.getAttribute("data-initdata");if(g.model instanceof gt)b=` data-node-id="${g.model.editor.protyle.block.rootID}"`,m=fe(g.docIcon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0);else if(y){const w=JSON.parse(y);w.instance==="Editor"&&(b=` data-node-id="${w.rootId}"`,m=fe(g.docIcon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0))}c+=`<li data-index="${h}" data-id="${g.id}"${b} class="b3-list-item${f===g.id?" b3-list-item--focus":""}"${f===g.id?' data-original="true"':""}>${m}<span class="b3-list-item__text">${De(g.title)}</span></li>`})}let d="";i||(d=`<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">
<li data-type="riffCard" data-index="0" class="b3-list-item${c?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${ae(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,Kl().forEach((f,g)=>{d+=`<li data-type="${f.type}" data-index="${g+1}" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#${f.icon}"></use></svg>
    <span class="b3-list-item__text">${f.title}</span>
    <span class="b3-list-item__meta">${ae(f.hotkey||"")}</span>
</li>`}),d=d+"</ul>"),ne(["dialog"]),An=new Le({title:window.siyuan.languages.switchTab,content:`<div class="fn__flex-column switch-doc">
    <div class="fn__hr"><input style="opacity: 0;height: 1px;box-sizing: border-box"></div>
    <div class="fn__flex" style="overflow:auto;">${d}
        <ul${i?' style="border-left:0"':""} class="b3-list b3-list--background fn__flex-1">${c}</ul>
    </div>
    <div class="switch-doc__path"></div>
</div>`}),An.element.setAttribute("data-key","\u2303\u21E5"),An.element.querySelector("input").focus(),Ot()&&An.element.addEventListener("contextmenu",f=>{Tm(n,f)}),An.element.addEventListener("click",f=>{Tm(n,f)});return}if(!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&!e.altKey&&(e.key.startsWith("Arrow")||e.key==="Enter")){const c=window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===window.siyuan.config.keymap.general.recentDocs.custom)return!0});if(c){e.preventDefault(),Im(n,c.element,e);return}}if(U(window.siyuan.config.keymap.general.recentDocs.custom,e)){if(window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")===window.siyuan.config.keymap.general.recentDocs.custom)return!0})){ne(["dialog"]);return}cm(),e.preventDefault();return}if(Gb(e)){e.preventDefault();return}if(e.key==="ArrowUp"||e.key==="ArrowDown"){const c=window.siyuan.dialogs.find(u=>{if(u.element.getAttribute("data-key")==="viewCards")return!0});if(c){c.element.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()})),e.preventDefault();return}}if(!i&&U(window.siyuan.config.keymap.general.syncNow.custom,e)){e.preventDefault(),cu(n);return}if(U(window.siyuan.config.keymap.general.commandPanel.custom,e)){e.preventDefault(),Cm(n);return}if(U(window.siyuan.config.keymap.general.editReadonly.custom,e)){e.preventDefault(),We.setReadonly(!window.siyuan.config.editor.readOnly);return}if(U(window.siyuan.config.keymap.general.lockScreen.custom,e)){jh(),e.preventDefault();return}if(!i&&U(window.siyuan.config.keymap.general.dataHistory.custom,e)){window.siyuan.config.readonly||zc(n),e.preventDefault();return}if(!i&&U(window.siyuan.config.keymap.general.toggleDock.custom,e)){Pp(document.querySelector("#barDock use")),e.preventDefault();return}if(!i&&!window.siyuan.config.readonly&&U(window.siyuan.config.keymap.general.config.custom,e)){yi(n),e.preventDefault();return}if(U("\u2318A",e)&&a.tagName!=="INPUT"&&a.tagName!=="TEXTAREA"){e.preventDefault();return}if(Kl().find(c=>{if(U(c.hotkey,e))return At(c.type).toggleModel(c.type),e.preventDefault(),!0}))return;if(!i&&U(window.siyuan.config.keymap.general.riffCard.custom,e)){Qs(n),document.activeElement&&document.activeElement.blur(),e.preventDefault();return}if(!i&&U(window.siyuan.config.keymap.general.dailyNote.custom,e)){Yf(),e.stopPropagation(),e.preventDefault();return}if(U(window.siyuan.config.keymap.general.newFile.custom,e)){Xa({app:n,useSavePath:!0}),e.preventDefault();return}const o=document.querySelector("#confirmDialogConfirmBtn");if(o){if(e.key==="Enter"){o.dispatchEvent(new CustomEvent("click")),e.preventDefault();return}else if(e.key==="Escape"){o.previousElementSibling.previousElementSibling.dispatchEvent(new CustomEvent("click")),e.preventDefault();return}}if(e.key==="Escape"&&!e.isComposing){const c=document.querySelector(".protyle-img");if(c){c.remove();return}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&!(window.siyuan.dialogs.length>0&&window.siyuan.menus.menu.element.style.zIndex<window.siyuan.dialogs[0].element.querySelector(".b3-dialog").style.zIndex)){window.siyuan.menus.menu.remove();return}if(window.siyuan.dialogs.length>0){ne(["dialog"]);return}const u={oid:0};window.siyuan.blockPanels.forEach(h=>{if((h.targetElement||typeof h.x=="number")&&h.element.getAttribute("data-pin")==="true"){const m=parseInt(h.element.getAttribute("data-level")),b=h.element.getAttribute("data-oid");u[b]?m>u[b]&&(u[b]=m):u[b]=1}});let d=!1;for(let h=0;h<window.siyuan.blockPanels.length;h++){const m=window.siyuan.blockPanels[h];(m.targetElement||typeof m.x=="number")&&m.element.getAttribute("data-pin")==="false"&&parseInt(m.element.getAttribute("data-level"))>(u[m.element.getAttribute("data-oid")]||0)&&(m.destroy(),d=!0,h--)}if(d)return;let f;if(getSelection().rangeCount>0){if(f=getSelection().getRangeAt(0),$(f.startContainer,"protyle-content",!0)){ee(f);return}}else f=document.createRange();const g=window.siyuan.backStack[window.siyuan.backStack.length-1];if(g&&g.protyle.toolbar.range)ee(g.protyle.toolbar.range);else{const h=Ye().editor[0];h&&we(h.editor.protyle.wysiwyg.element.firstElementChild)}e.preventDefault();return}if(!i&&U(window.siyuan.config.keymap.general.mainMenu.custom,e)){Am(n,document.querySelector("#barWorkspace").getBoundingClientRect()),e.preventDefault();return}if(U(window.siyuan.config.keymap.general.goForward.custom,e)){rd(n),e.preventDefault();return}if(U(window.siyuan.config.keymap.general.goBack.custom,e)){ld(n),e.preventDefault();return}if(U(window.siyuan.config.keymap.general.closeTab.custom,e)&&!e.repeat){e.preventDefault();let c=document.querySelector(".layout__tab--active");if(c&&c.getBoundingClientRect().width>0){let u="";Array.from(c.classList).find(d=>{if(d.startsWith("sy__"))return u=d.replace("sy__",""),!0}),u&&((t=At(u))==null||t.toggleModel(u,!1,!0));return}if(c=document.querySelector(".layout__wnd--active .item--focus"),c){const u=St(c.getAttribute("data-id"));u.parent.removeTab(u.id);return}Zn().find(u=>{var d;if((d=u.headElement)!=null&&d.classList.contains("item--focus"))return u.parent.removeTab(u.id),!0});return}if(U(window.siyuan.config.keymap.general.stickSearch.custom,e)){if(getSelection().rangeCount>0){const c=getSelection().getRangeAt(0);Hn(n,c.toString(),!1)}else Hn(n,"",!1);e.preventDefault();return}if(_E(n,e)||!i&&vE(n,e)||!i&&EE(n,e))return;let l=!1;if(n.plugins.find(c=>{if(c.commands.find(u=>{if(u.callback&&!u.fileTreeCallback&&!u.editorCallback&&!u.dockCallback&&!u.globalCallback&&U(u.customHotkey,e))return l=!0,u.callback(),!0}),l)return!0}),l)return e.stopPropagation(),e.preventDefault(),!0;let r="";if(U(window.siyuan.config.keymap.general.replace.custom,e)?r=window.siyuan.config.keymap.general.replace.custom:!$(a,"pdf__outer")&&U(window.siyuan.config.keymap.general.search.custom,e)?r=window.siyuan.config.keymap.general.search.custom:U(window.siyuan.config.keymap.general.globalSearch.custom,e)&&(r=window.siyuan.config.keymap.general.globalSearch.custom),r){if(getSelection().rangeCount>0){const c=getSelection().getRangeAt(0);pn({app:n,hotkey:r,key:c.toString()})}else pn({app:n,hotkey:r});e.preventDefault();return}if(U("\u2318S",e))return e.preventDefault(),!0},lu=n=>{},tt={element:void 0,_genItem(n,e){let t="";return Object.keys(n).forEach(a=>{if(window.siyuan.languages[a]){const i=ae(n[a].custom);t+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${window.siyuan.languages[a]}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${i}</span>
    <input data-key="${e+p.Constants.ZWSP+a}" data-value="${n[a].custom}" data-default="${n[a].default}" class="b3-text-field fn__none" value="${i}" spellcheck="false">
</label>`}}),t},genHTML(n){let e="";return n.plugins.forEach(t=>{let a="";t.commands.forEach(i=>{const s=ae(i.customHotkey);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${i.langText||t.i18n[i.langKey]||i.langKey}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${s}</span>
    <input data-key="plugin${p.Constants.ZWSP}${t.name}${p.Constants.ZWSP}${i.langKey}" data-value="${i.customHotkey}" data-default="${i.hotkey}" class="b3-text-field fn__none" value="${s}" spellcheck="false">
</label>`}),a&&(e+=`<div class="b3-list-item b3-list-item--narrow toggle">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__text ft__on-surface">${t.displayName}</span>
</div>
<div class="fn__none b3-list__panel">
    ${a}
</div>`)}),e&&(e=`<div class="b3-list b3-list--border b3-list--background">
    <div class="b3-list-item b3-list-item--narrow toggle">
        <span class="b3-list-item__toggle b3-list-item__toggle--hl">
            <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.plugin}</span>
    </div>
    <div class="b3-list__panel">
        ${e}
    </div>
</div>`),`<label class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip}</span>
    <span class="fn__flex-1"></span>
    <button id="keymapRefreshBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconRefresh"></use></svg>
        ${window.siyuan.languages.refresh}
    </button>
</label>
<label class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip2}</span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <button id="keymapResetBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconUndo"></use></svg>
        ${window.siyuan.languages.reset}
    </button>
</label>
<div class="b3-label file-tree config-keymap" id="keymapList">
    <div class="fn__flex config__item">
        <label class="b3-form__icon fn__block">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="keymapInput" class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
        </label>
        <div class="fn__space"></div>
        <label class="b3-form__icon fn__block searchByKeyLabel">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconKeymap"></use></svg>
            <input id="searchByKey" class="b3-form__icon-input b3-text-field fn__block" spellcheck="false" placeholder="${window.siyuan.languages.keymap}">
        </label>
        <div class="fn__space"></div>
        <button id="clearSearchBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
            <svg style="height: 14px"><use xlink:href="#iconClose"></use></svg>
            ${window.siyuan.languages.clear}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
        </div>
        <div class="fn__none b3-list__panel">${tt._genItem(window.siyuan.config.keymap.general,"general")}</div>
    </div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
            </span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.editor}</span>
        </div>
        <div class="b3-list__panel">
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
            </div>
            <div class="fn__none b3-list__panel">${tt._genItem(window.siyuan.config.keymap.editor.general,"editor"+p.Constants.ZWSP+"general")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.insert}</span>
            </div>
            <div class="fn__none b3-list__panel">${tt._genItem(window.siyuan.config.keymap.editor.insert,"editor"+p.Constants.ZWSP+"insert")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.headings}</span>
            </div>
            <div class="fn__none b3-list__panel">${tt._genItem(window.siyuan.config.keymap.editor.heading,"editor"+p.Constants.ZWSP+"heading")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.list1}</span>
            </div>
            <div class="fn__none b3-list__panel">${tt._genItem(window.siyuan.config.keymap.editor.list,"editor"+p.Constants.ZWSP+"list")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.table}</span>
            </div>
            <div class="fn__none b3-list__panel">${tt._genItem(window.siyuan.config.keymap.editor.table,"editor"+p.Constants.ZWSP+"table")}</div>
        </div>
    </div>
    ${e}
</div>`},_setkeymap(n){const e=JSON.parse(JSON.stringify(p.Constants.SIYUAN_KEYMAP));tt.element.querySelectorAll("label.b3-list-item input").forEach(t=>{const a=t.getAttribute("data-key").split(p.Constants.ZWSP),i=t.getAttribute("data-value");a[0]==="plugin"?(window.siyuan.config.keymap.plugin[a[1]][a[2]].custom=i,e.plugin=window.siyuan.config.keymap.plugin,n.plugins.forEach(s=>{s.name===a[1]&&s.commands.forEach(o=>{o.langKey===a[2]&&(o.customHotkey=i)})})):a[0]==="general"?e[a[0]][a[1]].custom=i:a[0]==="editor"&&(a[1]==="general"||a[1]==="insert"||a[1]==="heading"||a[1]==="list"||a[1]==="table")&&(e[a[0]][a[1]][a[2]].custom=i)}),window.siyuan.config.keymap=e,_("/api/setting/setKeymap",{data:e},()=>{lu(n)})},search(n,e){tt.element.querySelectorAll("#keymapList .b3-list-item--hide-action > .b3-list-item__text").forEach(a=>{const i=a.parentElement;let s=!1;if((e===""||i.querySelector(".b3-text-field").value.indexOf(ae(e))>-1)&&(s=!0),(a.textContent.toLowerCase().indexOf(n.toLowerCase())>-1||n.toLowerCase().indexOf(a.textContent.toLowerCase())>-1||n==="")&&s?(i.classList.remove("fn__none"),i.parentElement.classList.remove("fn__none"),i.parentElement.parentElement.classList.remove("fn__none")):i.classList.add("fn__none"),!i.nextElementSibling){const o=i.parentElement.previousElementSibling,l=o.querySelector(".b3-list-item__arrow");n===""&&e===""&&(l.classList.contains("b3-list-item__arrow--open")?i.parentElement.classList.remove("fn__none"):i.parentElement.classList.add("fn__none")),i.parentElement.childElementCount===i.parentElement.querySelectorAll(".b3-list-item.fn__none").length?o.classList.add("fn__none"):o.classList.remove("fn__none")}});const t=tt.element.querySelector("#keymapList").lastElementChild;n===""&&e===""&&(t.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")?t.lastElementChild.classList.remove("fn__none"):t.lastElementChild.classList.add("fn__none")),t.querySelectorAll(".b3-list-item--hide-action.fn__none").length===t.querySelectorAll(".b3-list-item--hide-action").length?t.firstElementChild.classList.add("fn__none"):t.firstElementChild.classList.remove("fn__none")},_getTip(n){const e=n.parentElement;let t=e.querySelector(".b3-list-item__text").textContent.trim();const a=e.parentElement.previousElementSibling;t=a.textContent.trim()+"-"+t;const i=a.parentElement.previousElementSibling;return i.classList.contains("b3-list-item")&&(t=i.textContent.trim()+"-"+t),t},bindEvent(n){tt.element.querySelector("#keymapRefreshBtn").addEventListener("click",()=>{Tt({reload:!0,onlyData:!1,errorExit:!1})});const e=tt.element.querySelector("#keymapInput"),t=tt.element.querySelector("#searchByKey");e.addEventListener("compositionend",()=>{tt.search(e.value,t.value)}),e.addEventListener("input",s=>{s.isComposing||tt.search(e.value,t.value)}),t.addEventListener("keydown",function(s){s.stopPropagation(),s.preventDefault();const o=tt._getKeymapString(s,this);tt.search(e.value,o)}),tt.element.querySelector("#clearSearchBtn").addEventListener("click",()=>{e.value="",t.value="",tt.search("","")}),tt.element.querySelector("#keymapResetBtn").addEventListener("click",()=>{Ne(window.siyuan.languages.reset,window.siyuan.languages.confirmReset,()=>{_("/api/setting/setKeymap",{data:p.Constants.SIYUAN_KEYMAP},()=>{window.location.reload(),lu(n)})})});const a=tt.element.querySelector("#keymapList");a.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isEqualNode(a);){const l=o.getAttribute("data-type");if(l==="reset"){const r=o.parentElement.querySelector(".b3-text-field");r.value=ae(r.getAttribute("data-default")),r.setAttribute("data-value",r.getAttribute("data-default")),r.previousElementSibling.textContent=r.value,tt._setkeymap(n),s.preventDefault(),s.stopPropagation();break}else if(l==="clear"){const r=o.parentElement.querySelector(".b3-text-field");r.value="",r.previousElementSibling.textContent="",r.setAttribute("data-value",""),tt._setkeymap(n),s.preventDefault(),s.stopPropagation();break}else if(l==="update"){o.classList.add("fn__none");const r=o.nextElementSibling;r.classList.remove("fn__none"),r.focus(),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item--hide-action")){const r=o.querySelector(".b3-text-field");r.classList.remove("fn__none"),r.focus(),r.previousElementSibling.classList.add("fn__none"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("toggle")){o.nextElementSibling.classList.contains("fn__none")?(o.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open"),o.nextElementSibling.classList.remove("fn__none")):(o.firstElementChild.firstElementChild.classList.remove("b3-list-item__arrow--open"),o.nextElementSibling.classList.add("fn__none")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}});let i;a.querySelectorAll("label.b3-list-item input").forEach(s=>{s.addEventListener("keydown",function(o){o.stopPropagation(),o.preventDefault();const l=tt._getKeymapString(o,this);clearTimeout(i),i=window.setTimeout(()=>{const r=this.getAttribute("data-key").split(p.Constants.ZWSP);if(r[1]==="list"&&(r[1]="list1"),r[1]==="heading"&&(r[1]="headings"),["\u2318","\u21E7","\u2325","\u2303"].includes(l.substr(l.length-1,1))||["\u2318A","\u2318X","\u2318C","\u2318V","\u2318-","\u2318=","\u23180","\u21E7\u2318V","\u2318/","\u21E7\u2191","\u21E7\u2193","\u21E7\u2192","\u21E7\u2190","\u21E7\u21E5","\u21E7\u2318\u21E5","\u2303\u21E5","\u2318\u21E5","\u2303\u2318\u21E5","\u21E7\u2318\u2192","\u21E7\u2318\u2190","\u2318Home","\u2318End","\u21E7\u21A9","\u21A9","PageUp","PageDown","\u232B","\u2326"].includes(l)){q(`${window.siyuan.languages.keymap} [${tt._getTip(this)}] ${window.siyuan.languages.invalid}`);return}Array.from(tt.element.querySelectorAll("label.b3-list-item input")).find(u=>{if(!u.isSameNode(this)&&u.getAttribute("data-value")===l){const d=u.getAttribute("data-key").split(p.Constants.ZWSP);return d[1]==="list"&&(d[1]="list1"),d[1]==="heading"&&(d[1]="headings"),q(`${window.siyuan.languages.keymap} [${tt._getTip(this)}] [${tt._getTip(u)}] ${window.siyuan.languages.conflict}`),!0}})||tt._setkeymap(n)},1e3)}),s.addEventListener("blur",function(){setTimeout(()=>{this.classList.add("fn__none"),this.previousElementSibling.textContent=this.value,this.previousElementSibling.classList.remove("fn__none")},p.Constants.TIMEOUT_INPUT)})})},_getKeymapString(n,e){let t="";return n.ctrlKey&&!n.metaKey&&Ot()&&(t+="\u2303"),n.altKey&&(t+="\u2325"),n.shiftKey&&(t+="\u21E7"),ye(n)&&(t+="\u2318"),n.key!=="Shift"&&n.key!=="Alt"&&n.key!=="Meta"&&n.key!=="Control"&&n.key!=="Unidentified"&&(n.keyCode===229?n.code==="Minus"?t+="-":n.code==="Semicolon"?t+=";":n.code==="Quote"?t+="'":n.code==="Comma"?t+=",":n.code==="Period"?t+=".":n.code==="Slash"&&(t+="/"):t+=p.Constants.KEYCODELIST[n.keyCode]||(n.key.length>1?n.key:n.key.toUpperCase())),e.setAttribute("data-value",t),setTimeout(()=>{e.value=ae(t)}),t}},mn=n=>{const e=[];return n.forEach(t=>{e.push(window.siyuan.languages[t])}),e},SE=(n,e)=>{const t=[mn(["config","fullWidth","md7","md8","md37","md38","editor","md2","md3","md12","md16","md27","md28","md29","md30","md31","md32","md33","md34","md39","md40","fontSizeTip","fontSize","font","font1","generateHistory","generateHistoryInterval","historyRetentionDays","historyRetentionDaysTip","clearHistory","katexMacros","katexMacrosTip","editReadonly","editReadonlyTip","embedBlockBreadcrumb","embedBlockBreadcrumbTip","outlineOutdentTip","outdent","floatWindowMode","floatWindowModeTip","justify","justifyTip","rtl","rtlTip","spellcheck","spellcheckTip","backlinkExpand","backlinkExpandTip","onlySearchForDoc","onlySearchForDocTip","dynamicLoadBlocks","dynamicLoadBlocksTip","fontSizeScrollZoom","fontSizeScrollZoomTip"]),mn(["selectOpen","tabLimit","fileTree","fileTree2","fileTree3","fileTree4","fileTree5","fileTree6","fileTree7","fileTree8","fileTree9","fileTree10","fileTree12","fileTree13","fileTree15","fileTree16","fileTree17","fileTree21"]),mn(["riffCard","flashcardNewCardLimit","flashcardNewCardLimitTip","flashcardReviewCardLimit","flashcardNewCardLimit","flashcardReviewCardLimitTip","flashcardMark","flashcardMarkTip","flashcardList","flashcardSuperBlock","flashcardHeading","flashcardDeck","flashcardDeckTip","flashcardFSRSParamRequestRetention","flashcardFSRSParamRequestRetentionTip","flashcardFSRSParamMaximumInterval","flashcardFSRSParamMaximumIntervalTip","flashcardFSRSParamWeights","flashcardFSRSParamWeightsTip"]),["AI"].concat(mn(["ai","apiTimeout","apiTimeoutTip","apiMaxTokens","apiMaxTokensTip","apiKey","apiKeyTip","apiProxy","apiProxyTip","apiBaseURL","apiBaseURLTip"])),mn(["assets","unreferencedAssets","missingAssets"]),mn(["paragraphBeginningSpace","md4","export","export1","export2","export5","export11","export13","export14","export15","export19","export20","ref","blockEmbed","export17","export18","export23","export24"]),mn(["language","language1","appearance","appearance1","appearance2","appearance3","appearance4","appearance5","appearance6","appearance8","appearance9","appearance10","appearance11","appearance16","appearance17","resetLayout","reset","icon","themeLight","themeDark","close","themeOS","theme","theme2","theme11","theme12","customEmoji","customEmojiTip","refresh"]),mn(["bazaar","theme","template","icon","widget"]),mn(["search","searchLimit","searchLimit1","memo","name","alias","keywordsLimit","doc","headings","list1","listItem","code","math","table","quote","superBlock","paragraph","indexAssetPath","embedBlock","database"]),mn(["keymap","keymapTip2"].concat(Object.keys(p.Constants.SIYUAN_KEYMAP.general)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.general)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.heading)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.insert)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.list)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.table))),mn(["cloudStorage","trafficStat","sync","backup","cdn","total","sizeLimit","cloudBackup","cloudBackupTip","updatePath","cloudSync","upload","download","syncMode","syncModeTip","generateConflictDoc","generateConflictDocTip","syncProvider","syncProviderTip","syncMode1","syncMode2","reposTip","openSyncTip1","openSyncTip2","cloudSyncDir","config"]),mn(["accountTip","accountName","password","captcha","forgetPassword","login","register","twoFactorCaptcha","account1","account2","account5"]),mn(["autoLaunch","autoLaunchTip","about","about1","about2","about3","about4","about5","about6","about7","about8","about9","about10","about11","about12","about13","about14","about17","config","dataRepoKey","dataRepoKeyTip1","dataRepoKeyTip2","slogan","currentVer","checkUpdate","updatePath","systemLog","importKey","genKey","genKeyByPW","copyKey","resetRepo","systemLogTip","export","downloadLatestVer","safeQuit","directConnection","siyuanNote","key","password","copied","resetRepoTip","autoDownloadUpdatePkg","autoDownloadUpdatePkgTip","networkProxy","keyPlaceholder","initRepoKeyTip","googleAnalytics","googleAnalyticsTip"])],a=n.querySelector(".b3-form__icon input"),i=()=>{const s=[],o=a.value;t.map((c,u)=>{c.map(d=>{d||console.warn("Search config miss language: ",c,u),d&&(o.toLowerCase().indexOf(d.toLowerCase())>-1||d.toLowerCase().indexOf(o.toLowerCase())>-1)&&s.push(u)})});let l;n.querySelectorAll(".b3-tab-bar li").forEach((c,u)=>{if(s.includes(u)){l||(l=c);const d=c.getAttribute("data-name");if(c.style.display="",["image","bazaar","account"].includes(d))return;const f=n.querySelector(`.config__tab-container[data-name="${d}"]`);if(f.innerHTML===""&&Pm(d,f,e),d==="keymap"){const g=tt.element.querySelector("#keymapInput"),h=tt.element.querySelector("#searchByKey");g.value=o,h.value="",tt.search(g.value,h.value)}else f.querySelectorAll(`.config__tab-container[data-name="${d}"] .b3-label`).forEach(g=>{if(!g.classList.contains("fn__none")){const h=g.textContent.toLowerCase();h.indexOf(o.toLowerCase())>-1||o.toLowerCase().indexOf(h)>-1?g.style.display="":g.style.display="none"}})}else c.style.display="none"});const r=n.querySelectorAll(".config__tab-container");l?l.click():r.forEach(c=>{c.classList.add("fn__none")}),a.focus()};a.addEventListener("compositionend",()=>{i()}),a.addEventListener("input",s=>{s.isComposing||i()})},$t={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.selectOpen}
        <div class="b3-label__text">${window.siyuan.languages.fileTree2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="alwaysSelectOpenedFile" type="checkbox"${window.siyuan.config.fileTree.alwaysSelectOpenedFile?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree7}
        <div class="b3-label__text">${window.siyuan.languages.fileTree8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="openFilesUseCurrentTab" type="checkbox"${window.siyuan.config.fileTree.openFilesUseCurrentTab?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree9}
        <div class="b3-label__text">${window.siyuan.languages.fileTree10}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeTabsOnStart" type="checkbox"${window.siyuan.config.fileTree.closeTabsOnStart?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree18}
        <div class="b3-label__text">${window.siyuan.languages.fileTree19}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowCreateDeeper" type="checkbox"${window.siyuan.config.fileTree.allowCreateDeeper?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree3}
        <div class="b3-label__text">${window.siyuan.languages.fileTree4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="removeDocWithoutConfirm" type="checkbox"${window.siyuan.config.fileTree.removeDocWithoutConfirm?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree20}
        <div class="b3-label__text">${window.siyuan.languages.fileTree21}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="useSingleLineSave" type="checkbox"${window.siyuan.config.fileTree.useSingleLineSave?" checked":""}/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree12}
        <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="docCreateSavePath" value="">
</label>
<label class="b3-label fn__flex config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree5}
        <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree16}
        <div class="b3-label__text">${window.siyuan.languages.fileTree17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxListCount" type="number" min="1" max="10240" value="${window.siyuan.config.fileTree.maxListCount}">
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.tabLimit}
        <div class="b3-label__text">${window.siyuan.languages.tabLimit1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxOpenTabCount" type="number" min="1" max="32" value="${window.siyuan.config.fileTree.maxOpenTabCount}">
</label>`,_send(){let n=parseInt($t.element.querySelector("#maxOpenTabCount").value);32<n&&(n=32,$t.element.querySelector("#maxOpenTabCount").value="32"),1>n&&(n=1,$t.element.querySelector("#maxOpenTabCount").value="1"),_("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:$t.element.querySelector("#alwaysSelectOpenedFile").checked,refCreateSavePath:$t.element.querySelector("#refCreateSavePath").value,docCreateSavePath:$t.element.querySelector("#docCreateSavePath").value,openFilesUseCurrentTab:$t.element.querySelector("#openFilesUseCurrentTab").checked,closeTabsOnStart:$t.element.querySelector("#closeTabsOnStart").checked,allowCreateDeeper:$t.element.querySelector("#allowCreateDeeper").checked,removeDocWithoutConfirm:$t.element.querySelector("#removeDocWithoutConfirm").checked,useSingleLineSave:$t.element.querySelector("#useSingleLineSave").checked,maxListCount:parseInt($t.element.querySelector("#maxListCount").value),maxOpenTabCount:n},e=>{$t.onSetfiletree(e.data)})},bindEvent:()=>{$t.element.querySelector("#docCreateSavePath").value=window.siyuan.config.fileTree.docCreateSavePath,$t.element.querySelector("#refCreateSavePath").value=window.siyuan.config.fileTree.refCreateSavePath,$t.element.querySelectorAll("input").forEach(n=>{n.addEventListener("change",()=>{$t._send()})})},onSetfiletree:n=>{window.siyuan.config.fileTree=n}};var LE=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const mt={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.paragraphBeginningSpace}
        <div class="b3-label__text">${window.siyuan.languages.md4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="paragraphBeginningSpace" type="checkbox"${window.siyuan.config.export.paragraphBeginningSpace?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export17}
        <div class="b3-label__text">${window.siyuan.languages.export18}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="addTitle" type="checkbox"${window.siyuan.config.export.addTitle?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export23}
        <div class="b3-label__text">${window.siyuan.languages.export24}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="markdownYFM" type="checkbox"${window.siyuan.config.export.markdownYFM?" checked":""}/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.ref}
        <div class="b3-label__text">${window.siyuan.languages.export11}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="2" ${window.siyuan.config.export.blockRefMode===2?"selected":""}>${window.siyuan.languages.export2}</option>
        <option value="3" ${window.siyuan.config.export.blockRefMode===3?"selected":""}>${window.siyuan.languages.export3}</option>
        <option value="4" ${window.siyuan.config.export.blockRefMode===4?"selected":""}>${window.siyuan.languages.export4}</option>
    </select>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.blockEmbed}
        <div class="b3-label__text">${window.siyuan.languages.export12}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockEmbedMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.blockEmbedMode===0?"selected":""}>${window.siyuan.languages.export0}</option>
        <option value="1" ${window.siyuan.config.export.blockEmbedMode===1?"selected":""}>${window.siyuan.languages.export1}</option>
    </select>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export5}
        <div class="b3-label__text">${window.siyuan.languages.export6}</div>
    </div>
    <span class="fn__space"></span>
    <select id="fileAnnotationRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.fileAnnotationRefMode===0?"selected":""}>${window.siyuan.languages.export7}</option>
        <option value="1" ${window.siyuan.config.export.fileAnnotationRefMode===1?"selected":""}>${window.siyuan.languages.export8}</option>
    </select>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export21}
        <div class="b3-label__text">${window.siyuan.languages.export22}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="pdfFooter">
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export25}
        <div class="b3-label__text">${window.siyuan.languages.export26}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="docxTemplate" placeholder="F:\\template.docx">
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export13}
        <div class="b3-label__text">${window.siyuan.languages.export14}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextLeft">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextRight">
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export15}
        <div class="b3-label__text">${window.siyuan.languages.export16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagOpenMarker">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagCloseMarker">
</label>
<label class="fn__flex b3-label config__item${(0,T.jU)()?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export19}
        <span class="fn__space"></span>
        <a href="javascript:void(0)" id="pandocBinPath" style="word-break: break-all">${window.siyuan.config.export.pandocBin}</a>
        <div class="b3-label__text">${window.siyuan.languages.export20}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="pandocBin"><svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}</button>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.export} Data
        <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="exportData"><svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}</button>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.import} Data
        <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
</label>`,bindEvent:()=>{mt.element.querySelector("#docxTemplate").value=window.siyuan.config.export.docxTemplate,mt.element.querySelector("#pdfFooter").value=window.siyuan.config.export.pdfFooter,mt.element.querySelector("#blockRefTextLeft").value=window.siyuan.config.export.blockRefTextLeft,mt.element.querySelector("#blockRefTextRight").value=window.siyuan.config.export.blockRefTextRight,mt.element.querySelector("#tagOpenMarker").value=window.siyuan.config.export.tagOpenMarker,mt.element.querySelector("#tagCloseMarker").value=window.siyuan.config.export.tagCloseMarker;const n=mt.element.querySelector("#pandocBinPath"),e=t=>{_("/api/setting/setExport",{paragraphBeginningSpace:mt.element.querySelector("#paragraphBeginningSpace").checked,addTitle:mt.element.querySelector("#addTitle").checked,markdownYFM:mt.element.querySelector("#markdownYFM").checked,blockRefMode:parseInt(mt.element.querySelector("#blockRefMode").value,10),blockEmbedMode:parseInt(mt.element.querySelector("#blockEmbedMode").value,10),fileAnnotationRefMode:parseInt(mt.element.querySelector("#fileAnnotationRefMode").value,10),pdfFooter:mt.element.querySelector("#pdfFooter").value,docxTemplate:mt.element.querySelector("#docxTemplate").value,blockRefTextLeft:mt.element.querySelector("#blockRefTextLeft").value,blockRefTextRight:mt.element.querySelector("#blockRefTextRight").value,tagOpenMarker:mt.element.querySelector("#tagOpenMarker").value,tagCloseMarker:mt.element.querySelector("#tagCloseMarker").value,pandocBin:t||window.siyuan.config.export.pandocBin},a=>{mt.onSetexport(a.data),n.textContent=a.data.pandocBin})};mt.element.querySelectorAll("select").forEach(t=>{t.addEventListener("change",()=>{e()})}),mt.element.querySelectorAll("input").forEach(t=>{t.id=="importData"?t.addEventListener("change",a=>{const i=new FormData;i.append("file",a.target.files[0]),_("/api/import/importData",i)}):t.addEventListener("change",()=>{e()})}),mt.element.querySelector("#exportData").addEventListener("click",()=>LE(void 0,null,function*(){_("/api/export/exportData",{},t=>{window.location.href=t.data.zip})}))},onSetexport:n=>{window.siyuan.config.export=n}};var CE=Ae(970);const Dm=n=>n===0?sa("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",qt("subscribe/siyuan"))}</div>
<div class="b3-label b3-label--noborder">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--noborder">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:mc("")?`<div class="b3-label b3-label--inner">${window.siyuan.languages.needLogin}</div>`:n===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.featureBetaStage}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon"><use xlink:href="#iconEye"></use></svg>
    </div>
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Region</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
    </select>
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</label>`:n===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.featureBetaStage}</em>
    <div class="fn__hr"></div>    
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon"><use xlink:href="#iconEye"></use></svg>
    </div>
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</label>`:"",$m=()=>{const n=Ht.element.querySelector("#reposData"),e=Ht.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(sa("")){e.classList.add("fn__none");let i=n;for(;i;)i.classList.add("fn__none"),i=i.nextElementSibling;return}_("/api/cloud/getCloudSpace",{},i=>{if(e.classList.add("fn__none"),i.code===1){n.innerHTML=i.msg;return}else n.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${i.data.sync?i.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${i.data.backup?i.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${qt("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${i.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${i.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${i.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${qt("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${i.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),n.classList.remove("fn__none");return}e.classList.add("fn__none");let t=n.nextElementSibling;for(;t;)mc("")?t.classList.add("fn__none"):t.classList.remove("fn__none"),t=t.nextElementSibling;n.classList.add("fn__none");const a=Ht.element.querySelector("#syncProviderPanel");a.querySelectorAll(".b3-text-field, .b3-select").forEach(i=>{i.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let s=parseInt(a.querySelector("#timeout").value,10);7>s&&(1>s?s=30:s=7),300<s&&(s=300),a.querySelector("#timeout").value=s.toString();const o={endpoint:a.querySelector("#endpoint").value,accessKey:a.querySelector("#accessKey").value,secretKey:a.querySelector("#secretKey").value,bucket:a.querySelector("#bucket").value,pathStyle:a.querySelector("#pathStyle").value==="true",region:a.querySelector("#region").value,skipTlsVerify:a.querySelector("#s3SkipTlsVerify").value==="true",timeout:s};_("/api/sync/setSyncProviderS3",{s3:o},()=>{window.siyuan.config.sync.s3=o})}else if(window.siyuan.config.sync.provider===3){let s=parseInt(a.querySelector("#timeout").value,10);7>s&&(s=7),300<s&&(s=300),a.querySelector("#timeout").value=s.toString();const o={endpoint:a.querySelector("#endpoint").value,username:a.querySelector("#username").value,password:a.querySelector("#password").value,skipTlsVerify:a.querySelector("#webdavSkipTlsVerify").value==="true",timeout:s};_("/api/sync/setSyncProviderWebDAV",{webdav:o},()=>{window.siyuan.config.sync.webdav=o})}})})},Ht={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.sync.provider===0?"selected":""}>SiYuan</option>
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
    </select>
</label>
<div id="syncProviderPanel" class="b3-label">
    ${Dm(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <label class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </label>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <label class="fn__flex config__item">
        <div class="fn__flex-center">${window.siyuan.languages.cloudSyncDir}</div>
        <div class="fn__flex-1"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-type="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </label>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{$m();const n=Ht.element.querySelector("#reposCloudSyncSwitch");n.addEventListener("change",()=>{if(n.checked&&window.siyuan.config.sync.cloudName===""){n.checked=!1,q(window.siyuan.languages._kernel[123]);return}_("/api/sync/setSyncEnable",{enabled:n.checked},()=>{window.siyuan.config.sync.enabled=n.checked,Jn()})});const e=Ht.element.querySelector("#syncPerception");e.addEventListener("change",()=>{_("/api/sync/setSyncPerception",{enabled:e.checked},()=>{window.siyuan.config.sync.perception=e.checked,Jn()})});const t=Ht.element.querySelector("#generateConflictDoc");t.addEventListener("change",()=>{_("/api/sync/setSyncGenerateConflictDoc",{enabled:t.checked},()=>{window.siyuan.config.sync.generateConflictDoc=t.checked})});const a=Ht.element.querySelector("#syncMode");a.addEventListener("change",()=>{_("/api/sync/setSyncMode",{mode:parseInt(a.value,10)},()=>{a.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?e.parentElement.classList.remove("fn__none"):e.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(a.value,10)})});const i=Ht.element.querySelector("#reposCloudSyncList"),s=Ht.element.querySelector("#syncProvider");s.addEventListener("change",()=>{_("/api/sync/setSyncProvider",{provider:parseInt(s.value,10)},l=>{l.code===1?(q(l.msg),s.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(s.value,10),Ht.element.querySelector("#syncProviderPanel").innerHTML=Dm(window.siyuan.config.sync.provider),$m(),i.innerHTML="",i.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?e.parentElement.classList.add("fn__none"):e.parentElement.classList.remove("fn__none")})});const o=Ht.element.querySelector("#reposLoading");o.style.width=Ht.element.clientWidth+"px",o.style.height=Ht.element.clientHeight+"px",Mm(i),Ht.element.firstElementChild.addEventListener("click",l=>{const r=l.target;if(r.getAttribute("data-type")==="config"){i.classList.contains("fn__none")?(wo(i,!0),i.classList.remove("fn__none")):i.classList.add("fn__none");return}const c=$(r,"b3-form__icona-icon");if(c){const u=c.firstElementChild.getAttribute("xlink:href")==="#iconEye";c.firstElementChild.setAttribute("xlink:href",u?"#iconEyeoff":"#iconEye"),c.previousElementSibling.setAttribute("type",u?"text":"password")}})}},Dt={element:void 0,genHTML:(n=!1)=>{const e=`<div>${window.siyuan.languages.account2}</div>
<div class="fn__hr--b"></div>
<a class="b3-button b3-button--big" href="${qt("subscribe/siyuan")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account1}
</a>
<div class="fn__hr--b"></div>
<span class="b3-chip b3-chip--primary b3-chip--hover${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}" id="trialSub">
    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>
    ${window.siyuan.languages.freeSub}
</span>
<div class="fn__hr${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}"></div>
<a href="${qt("sponsor")}" target="_blank" class="b3-chip b3-chip--pink b3-chip--hover">
    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>
    ${window.siyuan.languages.sponsor}
</a>`;if(n)return`<div class="ft__center">${e}</div>`;if(window.siyuan.user){let t="";window.siyuan.user.userTitles.length>0&&(t='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(s=>{t+=`<div class="b3-chip b3-chip--middle">${s.icon} ${s.name}</div>`}),t+="</div>");let a="",i=`<div class="b3-form__icon fn__block">
   <svg class="ft__secondary b3-form__icon-icon"><use xlink:href="#iconVIP"></use></svg>
   <input class="b3-text-field fn__block b3-form__icon-input" style="padding-right: 44px;" placeholder="${window.siyuan.languages.activationCodePlaceholder}">
   <button id="activationCode" class="b3-button b3-button--text" style="position: absolute;right: 0;top: 0;">${window.siyuan.languages.confirm}</button>
</div>`;if(window.siyuan.user.userSiYuanProExpireTime===-1)i="",a=`<div class="b3-chip b3-chip--secondary">${p.Constants.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`;else if(window.siyuan.user.userSiYuanProExpireTime>0){const s=`<div class="fn__hr--b"></div>
<div class="ft__on-surface ft__smaller">
    ${window.siyuan.languages.account6} 
    ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-new Date().getTime())/1e3/60/60/24))} 
    ${window.siyuan.languages.day} 
    <a href="${qt("subscribe/siyuan")}" target="_blank">${window.siyuan.languages.clickMeToRenew}</a>
</div>`;window.siyuan.user.userSiYuanOneTimePayStatus===1&&(a=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>`),window.siyuan.user.userSiYuanSubscriptionPlan===2?a+=`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>
${s}
<div class="fn__hr--b"></div>`:a+=`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}</div>${s}`}else window.siyuan.user.userSiYuanOneTimePayStatus===1?a=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>${e}`:a=e;return`<div class="fn__flex config-account">
<div class="config-account__center">
    <div class="config-account__bg">
        <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
        <a href="${qt("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
        <h1 class="config-account__name">
            <a target="_blank" class="fn__a" href="${qt("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
            <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
        </h1>
        ${t}
    </div>
    <div class="config-account__info">
        <div class="fn__flex">
            <a class="b3-button b3-button--text" href="${qt("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel" id="logout">
                ${window.siyuan.languages.logout}
            </button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?"":" fn__none"}" id="deactivateUser">
                ${window.siyuan.languages.deactivateUser}
            </button>
            <span class="fn__flex-1"></span>
            <button class="b3-button b3-button--cancel b3-tooltips b3-tooltips__n" id="refresh" aria-label="${window.siyuan.languages.refresh}">
                <svg><use xlink:href="#iconRefresh"></use></svg>
            </button>
        </div>
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <label>
                ${window.siyuan.languages.accountDisplayTitle}
                <input class="b3-switch fn__flex-center" id="displayTitle" type="checkbox"${window.siyuan.config.account.displayTitle?" checked":""}/>
            </label>
            <div class="fn__flex-1"></div>
            <label>
                ${window.siyuan.languages.accountDisplayVIP}
                <input class="b3-switch fn__flex-center" id="displayVIP" type="checkbox"${window.siyuan.config.account.displayVIP?" checked":""}/>
            </label>
        </div>
    </div>
</div>
<div class="config-account__center config-account__center--text${window.siyuan.config.system.container==="ios"?" fn__none":""}">
    <div class="fn__flex-1 fn__hr"></div>
    <div class="ft__center">${a}</div>
    <div class="fn__flex-1 fn__hr"></div>
    ${i}
</div></div>`}return`<div class="fn__flex config-account">
<div class="b3-form__space config-account__center">
    <div class="config-account__form" id="form1">
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>
            <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
            <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconFocus"></use></svg>
            <select class="b3-select b3-form__icon-input fn__block" id="cloudRegion">
                <option value="0"${window.siyuan.config.cloudRegion===0?" selected":""}>${window.siyuan.languages.cloudRegionChina}</option>
                <option value="1"${window.siyuan.config.cloudRegion===1?" selected":""}>${window.siyuan.languages.cloudRegionNorthAmerica}</option>
            </select>
        </div>
        <div class="b3-form__img fn__none">
            <div class="fn__hr--b"></div>
            <img id="captchaImg" class="fn__pointer" style="top: 17px">
            <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
        </div>
        <div class="fn__hr--b"></div>
        <label class="ft__smaller ft__on-surface fn__flex">
            <span class="fn__space"></span>
            <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">
            <span class="fn__space"></span>
            <span>${window.siyuan.languages.accountTip}</span>
        </label>
        <div class="fn__hr--b"></div>
        <button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>
        <div class="fn__hr--b"></div>
        <div class="ft__center">
            <a href="${qt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
            <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
            <a href="${qt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>
        </div>
    </div>
    <div class="fn__none config-account__form" id="form2">
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
            <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">
        </div>
        <div class="fn__hr--b"></div>
        <button id="login2" class="b3-button fn__block">${window.siyuan.languages.login}</button>
    </div>
</div>
<div class="config-account__center config-account__center--text${window.siyuan.config.system.container==="ios"?" fn__none":""}">
    <div class="ft__center">
        ${e}
    </div>
</div>
</div>`},bindEvent:n=>{const e=n.querySelector("#trialSub");e&&e.addEventListener("click",()=>{_("/api/account/startFreeTrial",{},()=>{n.querySelector("#refresh").dispatchEvent(new Event("click"))})});const t=n.querySelector("#agreeLogin"),a=n.querySelector("#userName");if(!a){const g=n.querySelector("#refresh");g.addEventListener("click",()=>{const m=g.firstElementChild;m.classList.contains("fn__rotate")||(m.classList.add("fn__rotate"),_("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},b=>{window.siyuan.user=b.data,n.innerHTML=Dt.genHTML(),Dt.bindEvent(n),q(window.siyuan.languages.refreshUser,3e3),Dt.onSetaccount(),Jn()}))}),n.querySelector("#logout").addEventListener("click",()=>{_("/api/setting/logoutCloudUser",{},()=>{_("/api/setting/getCloudUser",{},m=>{window.siyuan.user=m.data,n.innerHTML=Dt.genHTML(),Dt.bindEvent(n),Dt.onSetaccount(),Jn()})})}),n.querySelector("#deactivateUser").addEventListener(nt(),()=>{Ne("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{_("/api/account/deactivate",{},()=>{window.siyuan.user=null,n.innerHTML=Dt.genHTML(),Dt.bindEvent(n),Dt.onSetaccount(),Jn()})})}),n.querySelectorAll("input[type='checkbox']").forEach(m=>{m.addEventListener("change",()=>{_("/api/setting/setAccount",{displayTitle:n.querySelector("#displayTitle").checked,displayVIP:n.querySelector("#displayVIP").checked},b=>{window.siyuan.config.account.displayTitle=b.data.displayTitle,window.siyuan.config.account.displayVIP=b.data.displayVIP,Dt.onSetaccount()})})});const h=n.querySelector("#activationCode");h.addEventListener("click",()=>{const m=h.previousElementSibling;_("/api/account/checkActivationcode",{data:m.value},b=>{b.code!==0&&(m.value=""),Ne(window.siyuan.languages.activationCode,b.msg,()=>{b.code===0&&_("/api/account/useActivationcode",{data:h.previousElementSibling.value},()=>{g.dispatchEvent(new CustomEvent("click"))})})})});return}const i=n.querySelector("#userPassword"),s=n.querySelector("#captchaImg"),o=n.querySelector("#captcha"),l=n.querySelector("#twofactorAuthCode"),r=n.querySelector("#login"),c=n.querySelector("#login2");t.addEventListener("click",()=>{t.checked?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")}),a.focus(),a.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(r.click(),g.preventDefault())}),l.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(c.click(),g.preventDefault())}),o.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(r.click(),g.preventDefault())}),i.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(r.click(),g.preventDefault())});let u,d;s.addEventListener("click",()=>{s.setAttribute("src",qt("captcha")+`/login?needCaptcha=${d}&t=${new Date().getTime()}`)});const f=n.querySelector("#cloudRegion");f.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(f.value),n.querySelector(".config-account__center--text").innerHTML=Dt.genHTML(!0),n.querySelector("#form1").lastElementChild.innerHTML=`<a href="${qt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
<span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
<a href="${qt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),r.addEventListener("click",()=>{_("/api/account/login",{userName:a.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:CE(i.value),captcha:o.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},g=>{let h;if(g.code===1){if(h=q(g.msg),g.data.needCaptcha){d=g.data.needCaptcha,o.parentElement.classList.remove("fn__none"),o.previousElementSibling.setAttribute("src",qt("captcha")+`/login?needCaptcha=${g.data.needCaptcha}`),o.value="";return}return}if(g.code===10){n.querySelector("#form1").classList.add("fn__none"),n.querySelector("#form2").classList.remove("fn__none"),l.focus(),u=g.data.token;return}j(h),_("/api/setting/getCloudUser",{token:g.data.token},m=>{Dt._afterLogin(m,n)})})}),c.addEventListener("click",()=>{_("/api/setting/login2faCloudUser",{code:l.value,token:u},g=>{_("/api/setting/getCloudUser",{token:g.data.token},h=>{Dt._afterLogin(h,n)})})})},_afterLogin(n,e){if(window.siyuan.user=n.data,Jn(),e.innerHTML=Dt.genHTML(),Dt.bindEvent(e),Dt.onSetaccount(),e.getAttribute("data-action")==="go-repos")if(sa("")&&window.siyuan.config.sync.provider===0){const t=$(e,"b3-dialog--open");t&&(t.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")),e.removeAttribute("data-action"))}else ne(["dialog"]),cu()},onSetaccount(){if(Ht.element&&(Ht.element.innerHTML=""),window.siyuan.config.system.container==="ios")return;let n="";window.siyuan.config.account.displayVIP&&window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1?n=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account12}">${p.Constants.SIYUAN_IMAGE_VIP}</div>`:window.siyuan.user.userSiYuanProExpireTime>0&&(window.siyuan.user.userSiYuanSubscriptionPlan===2?n=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account3}"><svg><use xlink:href="#iconVIP"></use></svg></div>`:n=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account10}"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.user.userSiYuanOneTimePayStatus===1&&(n+=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.onepay}"><svg><use xlink:href="#iconVIP"></use></svg></div>`)),(!window.siyuan.user||window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===-1)&&(n=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.freeSub}"><svg class="ft__error"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.config.account.displayTitle&&window.siyuan.user&&window.siyuan.user.userTitles.forEach(e=>{n+=`<div class="toolbar__item ariaLabel" aria-label="${e.name}\uFF1A${e.desc}">${e.icon}</div>`}),document.getElementById("toolbarVIP").innerHTML=n}},ru=(n,e)=>{n.plugins.find((t,a)=>{if(t.name===e){try{t.onunload()}catch(o){console.error(`plugin ${t.name} onunload error:`,o)}const i=Object.keys(t.models);return Ye().custom.forEach(o=>{i.includes(o.type)&&o.parent.parent.removeTab(o.parent.id)}),t.topBarIcons.forEach(o=>{o.remove()}),or(),t.statusBarIcons.forEach(o=>{o.remove()}),Object.keys(t.docks).forEach(o=>{Object.keys(window.siyuan.layout.leftDock.data).includes(o)?window.siyuan.layout.leftDock.remove(o):Object.keys(window.siyuan.layout.rightDock.data).includes(o)?window.siyuan.layout.rightDock.remove(o):Object.keys(window.siyuan.layout.bottomDock.data).includes(o)&&window.siyuan.layout.bottomDock.remove(o)}),Array.from(document.childNodes).find(o=>{if(o.nodeType===8&&o.textContent===e)return o.remove(),!0}),n.plugins.splice(a,1),setTimeout(()=>{Tt({reload:!1,onlyData:!1,errorExit:!1})},p.Constants.TIMEOUT_LOAD),!0}})},Be={element:void 0,genHTML(){if(!window.siyuan.config.bazaar.trust)return`<div class="fn__flex-column">
<div class="fn__flex-1"></div>
<div class="b3-label">
    <div>${window.siyuan.languages.bazaarTrust}</div>
    <div class="fn__hr--b"></div>
    <div>${window.siyuan.languages.bazaarTrust3}</div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconEye"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustCodeReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustCodeReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconGithub"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustOpenSource}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustOpenSourceTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconUsers"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarCommunityReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarPeerReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconInfo"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarUserReport}
        <div class="b3-label__text">${window.siyuan.languages.bazaarUserReportTip}</div>
    </div>
</div>
<div class="b3-label b3-label--noborder">
    <div>${window.siyuan.languages.bazaarTrust1}</div>
    <div class="fn__hr--b"></div>
    <diiv>${window.siyuan.languages.bazaarTrust2}</diiv>
</div>
<div class="ft__center b3-label b3-label--noborder">
    <button class="b3-button fn__size200">${window.siyuan.languages.trust}</button>
</div>
<div class="fn__flex-1"></div>
</div>`;const n=window.siyuan.storage[p.Constants.LOCAL_BAZAAR],e=`<div style="height: ${Be.element.clientHeight-80}px;display: flex;align-items: center;justify-content: center;"><img src="/stage/loading-pure.svg"></div>`;return`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="downloaded" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.downloaded}</span><span class="fn__flex-1"></span></div>
    <div data-type="plugin" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.plugin}</span><span class="fn__flex-1"></span></div>
    <div data-type="theme" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.theme}</span><span class="fn__flex-1"></span></div>
    <div data-type="icon" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.icon}</span><span class="fn__flex-1"></span></div>
    <div data-type="template" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.template}</span><span class="fn__flex-1"></span></div>
    <div data-type="widget" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.widget}</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div class="bazaarPanel" data-type="downloaded" data-init="true">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <button data-type="myPlugin" class="b3-button">${window.siyuan.languages.plugin}</button>
            <div class="fn__space"></div>
            <button data-type="myTheme" class="b3-button b3-button--outline">${window.siyuan.languages.theme}</button>
            <div class="fn__space"></div>
            <button data-type="myIcon" class="b3-button b3-button--outline">${window.siyuan.languages.icon}</button>
            <div class="fn__space"></div>
            <button data-type="myTemplate" class="b3-button b3-button--outline">${window.siyuan.languages.template}</button>
            <div class="fn__space"></div>
            <button data-type="myWidget" class="b3-button b3-button--outline">${window.siyuan.languages.widget}</button>
        </div>
        <div id="configBazaarDownloaded">
            ${e}
        </div>
    </div>
    <div data-type="theme" class="bazaarPanel fn__none">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${n.theme==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${n.theme==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${n.theme==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${n.theme==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__flex-1"></div>
            <select id="bazaarSelect" class="b3-select">
                <option selected value="2">${window.siyuan.languages.all}</option>
                <option value="0">${window.siyuan.languages.themeLight}</option>
                <option value="1">${window.siyuan.languages.themeDark}</option>
            </select>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarTheme">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="template">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${n.template==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${n.template==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${n.template==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${n.template==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
        </div>
        <div id="configBazaarTemplate">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="plugin">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${n.plugin==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${n.plugin==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${n.plugin==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${n.plugin==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
        </div>
        <div id="configBazaarPlugin">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="icon">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${n.icon==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${n.icon==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${n.icon==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${n.icon==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
        </div>
        <div id="configBazaarIcon">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="widget">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${n.widget==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${n.widget==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${n.widget==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${n.widget==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
        </div>
        <div id="configBazaarWidget">
            ${e}
        </div>
    </div>
</div>
<div id="configBazaarReadme" class="config-bazaar__readme"></div>
</div>`},_genCardHTML(n,e){let t=!1,a="";if(e==="themes"){const o=Be.element.querySelector("#bazaarSelect").value;(o==="0"&&n.modes.includes("dark")||o==="1"&&n.modes.includes("light"))&&(t=!0),a=n.modes.toString()}let i=!1;["icons","themes"].includes(e)&&(i=!0);const s={bazaarType:e,themeMode:a,updated:n.updated,name:n.name,repoURL:n.repoURL,repoHash:n.repoHash,downloads:n.downloads,downloaded:!1};return`<div data-obj='${JSON.stringify(s)}' class="b3-card b3-card--wrap${t?" fn__none":""}${n.current?" b3-card--current":""}">
    <div class="b3-card__img">
        <img src="${n.iconURL}" onerror="this.src='${n.previewURLThumb}'"/>
    </div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info fn__flex-1">
            ${n.preferredName} <span class="ft__on-surface ft__smaller">${n.name}</span>
            <div class="b3-card__desc" title="${ia(n.preferredDesc)||""}">
                ${n.preferredDesc||""}
            </div>
        </div>
        <div class="b3-card__actions">
            <span class="block__icon block__icon--show ft__primary">
                <svg><use xlink:href="#iconDownload"></use></svg>
                <span class="fn__space"></span>
                ${n.downloads}
            </span>
            <span class="fn__space"></span>
            ${n.preferredFunding?`<a target="_blank" href="${n.preferredFunding}" data-type="a" class="block__icon block__icon--show" aria-label="${window.siyuan.languages.sponsor} ${n.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a><span class="fn__space"></span>`:""}
            <div class="fn__flex-1"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${n.installed?"":" fn__none"}" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
                <svg><use xlink:href="#iconTrashcan"></use></svg>
            </span>
            <div class="fn__space${!n.current&&n.installed&&i?"":" fn__none"}"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!n.current&&n.installed&&i?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
                <svg><use xlink:href="#iconSelect"></use></svg>
            </span>
            <div class="fn__space${n.outdated?"":" fn__none"}"></div>
            <span data-type="install-t" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${n.outdated?"":" fn__none"}" aria-label="${window.siyuan.languages.update}">
                <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
            </span>
        </div>
    </div>
</div>`},_genMyHTML(n,e){const t=Be.element.querySelector("#configBazaarDownloaded");if(t.getAttribute("data-loading")==="true"||t.previousElementSibling.querySelector(`[data-type="my${n.replace(n[0],n[0].toUpperCase()).substring(0,n.length-1)}"]`).classList.contains("b3-button--outline"))return;t.setAttribute("data-loading","true");let a="/api/bazaar/getInstalledTheme";n==="icons"?a="/api/bazaar/getInstalledIcon":n==="widgets"?a="/api/bazaar/getInstalledWidget":n==="templates"?a="/api/bazaar/getInstalledTemplate":n==="plugins"&&(a="/api/bazaar/getInstalledPlugin"),_(a,{frontend:(0,T.UP)()},i=>{t.removeAttribute("data-loading");let s="",o=!1;["icons","themes"].includes(n)&&(o=!0),i.data.packages.forEach(l=>{var r;const c={bazaarType:n,themeMode:(r=l.modes)==null?void 0:r.toString(),updated:l.updated,name:l.name,repoURL:l.repoURL,repoHash:l.repoHash,downloaded:!0};let u=!1;n==="plugins"&&e.plugins.find(d=>{if(d.name===c.name)return u=d.setting||d.__proto__.hasOwnProperty("openSetting"),!0}),s+=`<div data-obj='${JSON.stringify(c)}' class="b3-card${l.current?" b3-card--current":""}${window.siyuan.config.bazaar.petalDisabled&&n==="plugins"?" b3-card--disabled":""}">
    <div class="b3-card__img"><img src="${l.iconURL}" onerror="this.src='${l.previewURLThumb}'"/></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info b3-card__info--left fn__flex-1">
            ${l.preferredName} <span class="ft__on-surface ft__smaller">${l.name}</span>
            <div class="b3-card__desc" title="${ia(l.preferredDesc)||""}">${l.preferredDesc||""}</div>
        </div>
    </div>
    <div class="b3-card__actions b3-card__actions--right">
        ${l.incompatible?`<span class="fn__space"></span><span class="fn__flex-center b3-tooltips b3-tooltips__nw b3-chip b3-chip--error b3-chip--small" aria-label="${window.siyuan.languages.incompatiblePluginTip}">${window.siyuan.languages.incompatible}</span>`:""}
        ${l.preferredFunding?`<a target="_blank" href="${l.preferredFunding}" data-type="a" class="block__icon block__icon--show" aria-label="${window.siyuan.languages.sponsor} ${l.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:""}
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${u?"":" fn__none"}" data-type="setting" aria-label="${window.siyuan.languages.config}">
            <svg><use xlink:href="#iconSettings"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${(0,T.jU)()?" fn__none":""}" data-type="open" aria-label="${window.siyuan.languages.showInFolder}">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!l.current&&o?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
            <svg><use xlink:href="#iconSelect"></use></svg>
        </span>
        <span data-type="install-t" aria-label="${window.siyuan.languages.update}" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${l.outdated?"":" fn__none"}">
            <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space${n==="plugins"?"":" fn__none"}"></span>
        <span class="fn__space${n==="plugins"?"":" fn__none"}"></span>
        <input class="b3-switch fn__flex-center${n==="plugins"?"":" fn__none"}" ${l.enabled?"checked":""} data-type="plugin-enable" type="checkbox" ${l.incompatible?" disabled":""}>
    </div>
</div>`}),Be._data.downloaded=i.data.packages,n==="plugins"&&(s=`<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <input ${window.siyuan.config.bazaar.petalDisabled?"":" checked"} data-type="plugins-enable" type="checkbox" class="b3-switch" style="margin: 8px 32px">
</div>${s}`),t.innerHTML=s||`<div class="fn__hr"></div><ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`})},_data:{themes:[],templates:[],icons:[],widgets:[],plugins:[],downloaded:[]},_renderReadme(n,e){var t;const a=JSON.parse(n.getAttribute("data-obj"));let i;(a.downloaded?Be._data.downloaded:Be._data[e]).find(c=>{if(c.repoURL===a.repoURL)return i=c,!0});const s=Be.element.querySelector("#configBazaarReadme"),o=i.repoURL.split("/");o.pop();let l=window.siyuan.languages.icon;e==="themes"?l=window.siyuan.languages.theme:e==="widgets"?l=window.siyuan.languages.widget:e==="templates"?l=window.siyuan.languages.template:e==="plugins"&&(l=window.siyuan.languages.plugin);const r={bazaarType:e,themeMode:(t=i.modes)==null?void 0:t.toString(),name:i.name,repoURL:i.repoURL,repoHash:i.repoHash,downloaded:!0};if(s.innerHTML=` <div class="item__side" data-obj='${JSON.stringify(r)}'>
    <div class="fn__flex">
        <div style="padding-right: 8px" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" data-type="goBack" aria-label="${window.siyuan.languages.back}">
            <svg><use xlink:href="#iconLeft"></use></svg>
            <span class="fn__space"></span>
            ${l}
        </div>
    </div>
    <div class="fn__flex-1"></div>
    <img class="item__img" src="${i.iconURL}" onerror="this.src='${i.previewURLThumb}'">
    <a href="${i.repoURL}" target="_blank" class="item__title" title="GitHub Repo">${i.preferredName}</a>
    <br>
    <a href="${i.repoURL}" target="_blank" class="ft__on-surface ft__smaller" title="GitHub Repo">${i.name}</a>
    <div class="block__icons">
        <span class="fn__flex-1"></span>
        ${i.preferredFunding?`<a target="_blank" href="${i.preferredFunding}" data-type="a" class="block__icon block__icon--show" aria-label="${window.siyuan.languages.sponsor} ${i.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:`<span class="b3-tooltips b3-tooltips__ne block__icon block__icon--show ft__primary" aria-label="${window.siyuan.languages.author}"><svg><use xlink:href="#iconAccount"></use></svg></span>`}
        <span class="fn__space"></span>
        <a href="${o.join("/")}" target="_blank" title="Creator">${i.author}</a>
        <span class="fn__flex-1"></span>
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${window.siyuan.languages.currentVer}<br>v${i.version}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${a.downloaded?window.siyuan.languages.installDate:window.siyuan.languages.releaseDate}<br>${a.downloaded?i.hInstallDate:i.hUpdated}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${a.downloaded?window.siyuan.languages.installSize:window.siyuan.languages.pkgSize}<br>${a.downloaded?i.hInstallSize:i.hSize}</div>
    <div class="fn__hr--b${i.installed||a.downloaded?" fn__none":""}"></div>
    <div class="fn__hr--b${i.installed||a.downloaded?" fn__none":""}"></div>
    <div${i.installed||a.downloaded?' class="fn__none"':""}>
        <button class="b3-button" style="width: 168px"  data-type="install">${window.siyuan.languages.download}</button>
    </div>
    <div${i.outdated&&(i.installed||a.downloaded)?"":' class="fn__none"'}>
        <button class="b3-button" style="width: 168px" data-type="install-t">${window.siyuan.languages.update}</button>
    </div>
    <div class="fn__hr--b${a.downloaded?" fn__none":""}"></div>
    <div class="fn__hr--b${a.downloaded?" fn__none":""}"></div>
    <div class="fn__flex${a.downloaded?" fn__none":""}" style="justify-content: center;">
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGithub"></use></svg>
        <span class="fn__space"></span>
        <a href="${i.repoURL}" target="_blank" title="GitHub Repo">Repo</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconStar"></use></svg>
        <span class="fn__space"></span>
        <a href="${i.repoURL}/stargazers" target="_blank" title="Starts">${i.stars}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGitHubI"></use></svg>
        <span class="fn__space"></span>
        <a href="${i.repoURL}/issues" target="_blank" title="Open issues">${i.openIssues}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconDownload"></use></svg>
        <span class="fn__space"></span>
        ${i.downloads}
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__flex-1"></div>
</div>
<div class="item__main">
    <div class="item__preview" style="background-image: url(${i.previewURL})"></div>
    <div class="b3-typography${i.preferredDesc?"":" fn__none"}">
        <div data-type="NodeBlockquote" class="bq" data-node-id>
            <div data-type="NodeParagraph" class="p" data-node-id>
                ${i.preferredDesc||""}
            </div>
         </div>
    </div>
    <div class="item__readme b3-typography b3-typography--default"">
        <img data-type="img-loading" style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 48px;box-sizing: border-box;" src="/stage/loading-pure.svg">
    </div>
</div>`,a.downloaded){const c=s.querySelector(".item__readme");c.innerHTML=i.preferredReadme,Ze(c)}else _("/api/bazaar/getBazaarPackageREAME",{repoURL:i.repoURL,repoHash:i.repoHash,packageType:e},c=>{const u=s.querySelector(".item__readme");u.innerHTML=c.data.html,Ze(u)});s.classList.add("config-bazaar__readme--show")},bindEvent(n){if(!window.siyuan.config.bazaar.trust){Be.element.querySelector("button").addEventListener("click",()=>{_("/api/setting/setBazaar",{trust:!0,petalDisabled:window.siyuan.config.bazaar.petalDisabled},()=>{window.siyuan.config.bazaar.trust=!0,Be.element.innerHTML=Be.genHTML(),Be.bindEvent(n)})});return}this._genMyHTML("plugins",n),Be.element.firstElementChild.addEventListener("click",e=>{let t=e.target;const a=S(t,"data-obj",null);let i;for(a&&(i=JSON.parse(a.getAttribute("data-obj")));t&&!t.isEqualNode(Be.element);){const s=t.getAttribute("data-type");if(t.tagName==="A")break;if(s==="open"&&i){e.preventDefault(),e.stopPropagation();break}else if(["myTheme","myTemplate","myIcon","myWidget","myPlugin"].includes(s)){t.classList.contains("b3-button--outline")&&!Be.element.querySelector("#configBazaarDownloaded").getAttribute("data-loading")&&(t.parentElement.childNodes.forEach(o=>{o.nodeType!==3&&o.classList.contains("b3-button")&&o.classList.add("b3-button--outline")}),t.classList.remove("b3-button--outline"),this._genMyHTML(s.replace("my","").toLowerCase()+"s",n)),e.preventDefault(),e.stopPropagation();break}else if(s==="goBack"){Be.element.querySelector("#configBazaarReadme").classList.remove("config-bazaar__readme--show"),e.preventDefault(),e.stopPropagation();break}else if(s==="install"){if(!t.classList.contains("b3-button--progress")){const o=i.bazaarType;let l="/api/bazaar/installBazaarTemplate";o==="themes"?l="/api/bazaar/installBazaarTheme":o==="icons"?l="/api/bazaar/installBazaarIcon":o==="widgets"?l="/api/bazaar/installBazaarWidget":o==="plugins"&&(l="/api/bazaar/installBazaarPlugin"),_(l,{repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,frontend:(0,T.UP)()},r=>{if(window.siyuan.config.appearance.themeJS&&o==="themes"){Tt({reload:!0,onlyData:!1,errorExit:!1});return}Be._onBazaar(r,o,["themes","icons"].includes(o)),Be._genMyHTML(o,n),o==="plugins"&&Ne(window.siyuan.languages.confirm,window.siyuan.languages.enablePluginTip,()=>{_("/api/petal/setPetalEnabled",{packageName:i.name,enabled:!0,frontend:(0,T.UP)()},c=>{hm(n,c.data),Be._genMyHTML(o,n)})})})}e.preventDefault(),e.stopPropagation();break}else if(s==="install-t"){t.classList.contains("b3-button--progress")||Ne(window.siyuan.languages.update,window.siyuan.languages.exportTplTip,()=>{const o=i.bazaarType;let l="/api/bazaar/installBazaarTemplate";o==="themes"?l="/api/bazaar/installBazaarTheme":o==="icons"?l="/api/bazaar/installBazaarIcon":o==="widgets"?l="/api/bazaar/installBazaarWidget":o==="plugins"&&(l="/api/bazaar/installBazaarPlugin"),t.classList.contains("b3-button")||t.parentElement.insertAdjacentHTML("afterend",'<img data-type="img-loading" style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 48px;box-sizing: border-box;" src="/stage/loading-pure.svg">'),_(l,{repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,update:!0,frontend:(0,T.UP)()},r=>{if(this._genMyHTML(o,n),Be._onBazaar(r,o,["icons"].includes(o)),o==="themes"&&(window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight===i.name||window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark===i.name))if(window.siyuan.config.appearance.themeJS)Tt({reload:!0,onlyData:!1,errorExit:!1});else{const c=document.getElementById("themeDefaultStyle");c.href=c.href+"1"}})}),e.preventDefault(),e.stopPropagation();break}else if(s==="uninstall"){const o=i.bazaarType;let l="/api/bazaar/uninstallBazaarTemplate";o==="themes"?l="/api/bazaar/uninstallBazaarTheme":o==="icons"?l="/api/bazaar/uninstallBazaarIcon":o==="widgets"?l="/api/bazaar/uninstallBazaarWidget":o==="plugins"&&(l="/api/bazaar/uninstallBazaarPlugin");const r=i.name;window.siyuan.config.appearance.themeDark===r||window.siyuan.config.appearance.themeLight===r||window.siyuan.config.appearance.icon===r?q(window.siyuan.languages.uninstallTip):Ne(window.siyuan.languages.uninstall,window.siyuan.languages.confirmUninstall.replace("${name}",r),()=>{_(l,{packageName:r,frontend:(0,T.UP)()},c=>{this._genMyHTML(o,n),Be._onBazaar(c,o,["themes","icons"].includes(o)),o==="plugins"&&ru(n,r)})}),e.preventDefault(),e.stopPropagation();break}else if(s==="switch"){const o=i.bazaarType,l=i.name,r=i.themeMode==="dark"?1:0;o==="icons"?_("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:l}),c=>{this._genMyHTML(o,n),_("/api/bazaar/getBazaarIcon",{},u=>{u.data.appearance=c.data,Be._onBazaar(u,"icons",!0),Be._data.icons=u.data.packages})}):o==="themes"&&_("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:r,modeOS:!1,themeDark:r===1?l:window.siyuan.config.appearance.themeDark,themeLight:r===0?l:window.siyuan.config.appearance.themeLight}),c=>{(r!==window.siyuan.config.appearance.mode||r===1&&window.siyuan.config.appearance.themeDark!==l||r===0&&window.siyuan.config.appearance.themeLight!==l)&&window.siyuan.config.appearance.themeJS?Tt({reload:!0,onlyData:!1,errorExit:!1}):(this._genMyHTML("themes",n),_("/api/bazaar/getBazaarTheme",{},u=>{u.data.appearance=c.data,Be._onBazaar(u,"themes",!0),Be._data.themes=u.data.packages}))}),e.preventDefault(),e.stopPropagation();break}else if(s==="setting"){n.plugins.find(o=>{if(o.name===i.name)return o.openSetting(),!0}),e.preventDefault(),e.stopPropagation();break}else if(s==="plugins-enable"){t.getAttribute("disabled")||(t.setAttribute("disabled","disabled"),window.siyuan.config.bazaar.petalDisabled=!t.checked,_("/api/setting/setBazaar",window.siyuan.config.bazaar,()=>{t.removeAttribute("disabled"),window.siyuan.config.bazaar.petalDisabled?Be.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(o=>{o.classList.add("b3-card--disabled"),ru(n,JSON.parse(o.getAttribute("data-obj")).name)}):(Be.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(o=>{o.classList.remove("b3-card--disabled")}),pm(n).then(()=>{n.plugins.forEach(o=>{tu(o)})}))})),e.stopPropagation();break}else if(s==="plugin-enable"){if(!t.getAttribute("disabled")){t.setAttribute("disabled","disabled");const o=t.checked;_("/api/petal/setPetalEnabled",{packageName:i.name,enabled:o,frontend:(0,T.UP)()},l=>{t.removeAttribute("disabled"),o?hm(n,l.data).then(r=>{r.setting||r.__proto__.hasOwnProperty("openSetting")?t.parentElement.querySelector('[data-type="setting"]').classList.remove("fn__none"):t.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none")}):(ru(n,i.name),t.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none"))})}e.stopPropagation();break}else if(t.classList.contains("b3-card")){$(e.target,"b3-card__actions--right")||Be._renderReadme(t,i.bazaarType),e.preventDefault(),e.stopPropagation();break}else if(t.classList.contains("item")&&!t.classList.contains("item--focus")){Be.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),t.classList.add("item--focus"),Be.element.querySelectorAll(".bazaarPanel").forEach(o=>{s===o.getAttribute("data-type")?(o.classList.remove("fn__none"),o.getAttribute("data-init")||(s==="template"?_("/api/bazaar/getBazaarTemplate",{},l=>{Be._onBazaar(l,"templates",!1),Be._data.templates=l.data.packages}):s==="icon"?_("/api/bazaar/getBazaarIcon",{},l=>{Be._onBazaar(l,"icons",!1),Be._data.icons=l.data.packages}):s==="widget"?_("/api/bazaar/getBazaarWidget",{},l=>{Be._onBazaar(l,"widgets",!1),Be._data.widgets=l.data.packages}):s==="theme"?_("/api/bazaar/getBazaarTheme",{},l=>{Be._onBazaar(l,"themes",!1),Be._data.themes=l.data.packages}):s==="plugin"&&_("/api/bazaar/getBazaarPlugin",{frontend:(0,T.UP)()},l=>{Be._onBazaar(l,"plugins",!1),Be._data.plugins=l.data.packages}),o.setAttribute("data-init","true"))):o.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(t.classList.contains("item__preview")){t.classList.toggle("item__preview--fullscreen"),e.preventDefault(),e.stopPropagation();break}t=t.parentElement}}),Be.element.querySelectorAll(".b3-select").forEach(e=>{e.addEventListener("change",()=>{if(e.id==="bazaarSelect")Be.element.querySelectorAll("#configBazaarTheme .b3-card").forEach(t=>{const a=JSON.parse(t.getAttribute("data-obj"));e.value==="0"?a.themeMode.indexOf("light")>-1?t.classList.remove("fn__none"):t.classList.add("fn__none"):e.value==="1"?a.themeMode.indexOf("dark")>-1?t.classList.remove("fn__none"):t.classList.add("fn__none"):t.classList.remove("fn__none")});else{const t=window.siyuan.storage[p.Constants.LOCAL_BAZAAR],a=e.parentElement.parentElement;let i="";const s=Array.from(a.querySelectorAll(".b3-card"));e.value==="0"?s.sort((o,l)=>JSON.parse(l.getAttribute("data-obj")).updated<JSON.parse(o.getAttribute("data-obj")).updated?-1:1).forEach(o=>{i+=o.outerHTML}):e.value==="1"?s.sort((o,l)=>JSON.parse(l.getAttribute("data-obj")).updated<JSON.parse(o.getAttribute("data-obj")).updated?1:-1).forEach(o=>{i+=o.outerHTML}):e.value==="2"?s.sort((o,l)=>JSON.parse(l.getAttribute("data-obj")).downloads<JSON.parse(o.getAttribute("data-obj")).downloads?-1:1).forEach(o=>{i+=o.outerHTML}):e.value==="3"&&s.sort((o,l)=>JSON.parse(l.getAttribute("data-obj")).downloads<JSON.parse(o.getAttribute("data-obj")).downloads?1:-1).forEach(o=>{i+=o.outerHTML}),t[e.parentElement.parentElement.getAttribute("data-type")]=e.value,Ue(p.Constants.LOCAL_BAZAAR,window.siyuan.storage[p.Constants.LOCAL_BAZAAR]),s.length>1&&(i+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),a.querySelector(".b3-cards").innerHTML=i}})})},_onBazaar(n,e,t){let a="#configBazaarTemplate";e==="themes"?a="#configBazaarTheme":e==="icons"?a="#configBazaarIcon":e==="widgets"?a="#configBazaarWidget":e==="plugins"&&(a="#configBazaarPlugin");const i=Be.element.querySelector(a);n.code===1&&(q(n.msg),i.querySelectorAll("img[data-type='img-loading']").forEach(l=>{l.remove()}));let s="";n.data.packages.forEach(l=>{s+=this._genCardHTML(l,e)}),Be._data[e]=n.data.packages,i.innerHTML=`<div class="b3-cards">${s}</div>`;const o=window.siyuan.storage[p.Constants.LOCAL_BAZAAR];o[e.replace("s","")]==="1"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?1:-1).forEach(l=>{s+=l.outerHTML})):o[e.replace("s","")]==="2"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?-1:1).forEach(l=>{s+=l.outerHTML})):o[e.replace("s","")]==="3"&&(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?1:-1).forEach(l=>{s+=l.outerHTML})),n.data.packages.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.innerHTML=`<div class="b3-cards">${s}</div>`,t&&ut.onSetappearance(n.data.appearance)}},at={element:void 0,genHTML:()=>`<div class="b3-label">
 ${window.siyuan.languages.searchBlockType}
    <div class="fn__flex config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconMath"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.math}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="mathBlock" type="checkbox"${window.siyuan.config.search.mathBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconTable"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.table}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="table" type="checkbox"${window.siyuan.config.search.table?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconQuote"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.quote}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="blockquote" type="checkbox"${window.siyuan.config.search.blockquote?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSuper"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.superBlock}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="superBlock" type="checkbox"${window.siyuan.config.search.superBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconParagraph"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.paragraph}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="paragraph" type="checkbox"${window.siyuan.config.search.paragraph?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconFile"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.doc}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="document" type="checkbox"${window.siyuan.config.search.document?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHeadings"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.headings}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="heading" type="checkbox"${window.siyuan.config.search.heading?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconList"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.list1}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="list" type="checkbox"${window.siyuan.config.search.list?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconListItem"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.listItem}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="listItem" type="checkbox"${window.siyuan.config.search.listItem?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconCode"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.code}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="codeBlock" type="checkbox"${window.siyuan.config.search.codeBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHTML5"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                HTML
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="htmlBlock" type="checkbox"${window.siyuan.config.search.htmlBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSQL"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.embedBlock}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="embedBlock" type="checkbox"${window.siyuan.config.search.embedBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconDatabase"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.database}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="databaseBlock" type="checkbox"${window.siyuan.config.search.databaseBlock?" checked":""}/>
        </label>        
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchBlockAttr}
    <div class="config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconN"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="name" type="checkbox"${window.siyuan.config.search.name?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconA"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="alias" type="checkbox"${window.siyuan.config.search.alias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconM"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.memo}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="memo" type="checkbox"${window.siyuan.config.search.memo?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.allAttrs}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="ial" type="checkbox"${window.siyuan.config.search.ial?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchBackmention}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionName" type="checkbox"${window.siyuan.config.search.backlinkMentionName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAlias" type="checkbox"${window.siyuan.config.search.backlinkMentionAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAnchor" type="checkbox"${window.siyuan.config.search.backlinkMentionAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionDoc" type="checkbox"${window.siyuan.config.search.backlinkMentionDoc?" checked":""}/>
        </label>
        <label class="fn__flex" style="flex: 2">
            <div class=>
                ${window.siyuan.languages.keywordsLimit}
            </div>
            <span class="fn__space"></span>
            <input class="b3-text-field" id="backlinkMentionKeywordsLimit" type="number" min="1" max="10240" value="${window.siyuan.config.search.backlinkMentionKeywordsLimit}">
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchVirtualRef}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefName" type="checkbox"${window.siyuan.config.search.virtualRefName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAlias" type="checkbox"${window.siyuan.config.search.virtualRefAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAnchor" type="checkbox"${window.siyuan.config.search.virtualRefAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefDoc" type="checkbox"${window.siyuan.config.search.virtualRefDoc?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchIndex}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.indexAssetPath}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="indexAssetPath" type="checkbox"${window.siyuan.config.search.indexAssetPath?" checked":""}/>
        </label>
    </div>
</div>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchLimit}
         <div class="b3-label__text">${window.siyuan.languages.searchLimit1}</div>
         <div class="b3-label__text">${window.siyuan.languages.searchLimit2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="limit" type="number" min="32" max="10240" value="${window.siyuan.config.search.limit}">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchCaseSensitive}
         <div class="b3-label__text">${window.siyuan.languages.searchCaseSensitive1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="caseSensitive" type="checkbox"${window.siyuan.config.search.caseSensitive?" checked":""}/>
</label>`,bindEvent:()=>{at.element.querySelectorAll("input").forEach(n=>{n.addEventListener("change",()=>{_("/api/setting/setSearch",{document:at.element.querySelector("#document").checked,heading:at.element.querySelector("#heading").checked,list:at.element.querySelector("#list").checked,listItem:at.element.querySelector("#listItem").checked,codeBlock:at.element.querySelector("#codeBlock").checked,htmlBlock:at.element.querySelector("#htmlBlock").checked,embedBlock:at.element.querySelector("#embedBlock").checked,databaseBlock:at.element.querySelector("#databaseBlock").checked,mathBlock:at.element.querySelector("#mathBlock").checked,table:at.element.querySelector("#table").checked,blockquote:at.element.querySelector("#blockquote").checked,superBlock:at.element.querySelector("#superBlock").checked,paragraph:at.element.querySelector("#paragraph").checked,name:at.element.querySelector("#name").checked,alias:at.element.querySelector("#alias").checked,memo:at.element.querySelector("#memo").checked,ial:at.element.querySelector("#ial").checked,indexAssetPath:at.element.querySelector("#indexAssetPath").checked,limit:parseInt(at.element.querySelector("#limit").value),caseSensitive:at.element.querySelector("#caseSensitive").checked,backlinkMentionName:at.element.querySelector("#backlinkMentionName").checked,backlinkMentionAlias:at.element.querySelector("#backlinkMentionAlias").checked,backlinkMentionAnchor:at.element.querySelector("#backlinkMentionAnchor").checked,backlinkMentionDoc:at.element.querySelector("#backlinkMentionDoc").checked,backlinkMentionKeywordsLimit:parseInt(at.element.querySelector("#backlinkMentionKeywordsLimit").value),virtualRefName:at.element.querySelector("#virtualRefName").checked,virtualRefAlias:at.element.querySelector("#virtualRefAlias").checked,virtualRefAnchor:at.element.querySelector("#virtualRefAnchor").checked,virtualRefDoc:at.element.querySelector("#virtualRefDoc").checked},e=>{window.siyuan.config.search=e.data})})})}},Qn={element:void 0,genHTML:()=>{let n="";return n=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiTimeout}
        <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>
</label>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiModel}
        <div class="b3-label__text">${window.siyuan.languages.apiModelTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="apiModel" class="b3-select fn__flex-center fn__size200">
        <option value="gpt-4" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4"?"selected":""}>gpt-4</option>
        <option value="gpt-4-32k" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4-32k"?"selected":""}>gpt-4-32k</option>
        <option value="gpt-3.5-turbo" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo"?"selected":""}>gpt-3.5-turbo</option>
        <option value="gpt-3.5-turbo-16k" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo-16k"?"selected":""}>gpt-3.5-turbo-16k</option>
    </select>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiMaxTokens}
        <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiKey}
        <div class="b3-label__text">${window.siyuan.languages.apiKeyTip}</div>
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" id="apiKey" value="${window.siyuan.config.ai.openAI.apiKey}"/>
    </div>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiProxy}
        <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    </div>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiBaseURL}
        <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}"/>
    </div>
</label>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">OpenAI</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${n}
    </div>
</div>
</div>`},bindEvent:()=>{Qn.element.querySelectorAll("input,select").forEach(n=>{n.addEventListener("change",()=>{_("/api/setting/setAI",{openAI:{apiBaseURL:Qn.element.querySelector("#apiBaseURL").value,apiKey:Qn.element.querySelector("#apiKey").value,apiModel:Qn.element.querySelector("#apiModel").value,apiMaxTokens:parseInt(Qn.element.querySelector("#apiMaxTokens").value),apiProxy:Qn.element.querySelector("#apiProxy").value,apiTimeout:parseInt(Qn.element.querySelector("#apiTimeout").value)}},e=>{window.siyuan.config.ai=e.data})})})}},an={element:void 0,genHTML:()=>{let n=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>`;return n=`${n}<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardNewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardReviewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamWeights}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    </div>
</label>`,n},bindEvent:()=>{an.element.querySelectorAll("input").forEach(n=>{n.addEventListener("change",()=>{_("/api/setting/setFlashcard",{newCardLimit:parseInt(an.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(an.element.querySelector("#reviewCardLimit").value),mark:an.element.querySelector("#mark").checked,list:an.element.querySelector("#list").checked,superBlock:an.element.querySelector("#superBlock").checked,heading:an.element.querySelector("#heading").checked,deck:an.element.querySelector("#deck").checked,requestRetention:parseFloat(an.element.querySelector("#requestRetention").value),maximumInterval:parseInt(an.element.querySelector("#maximumInterval").value),weights:an.element.querySelector("#weights").value},e=>{window.siyuan.config.flashcard=e.data})})})}},Pm=(n,e,t)=>{switch(n){case"filetree":e.innerHTML=$t.genHTML(),$t.element=e,$t.bindEvent();break;case"AI":e.innerHTML=Qn.genHTML(),Qn.element=e,Qn.bindEvent();break;case"card":e.innerHTML=an.genHTML(),an.element=e,an.bindEvent();break;case"image":e.innerHTML=xn.genHTML(),xn.element=e,xn.bindEvent();break;case"export":e.innerHTML=mt.genHTML(),mt.element=e,mt.bindEvent();break;case"appearance":e.innerHTML=ut.genHTML(),ut.element=e,ut.bindEvent();break;case"keymap":e.innerHTML=tt.genHTML(t),tt.element=e,tt.bindEvent(t);break;case"bazaar":Be.element=e,e.innerHTML=Be.genHTML(),Be.bindEvent(t);break;case"account":e.innerHTML=Dt.genHTML(),Dt.element=e,Dt.bindEvent(Dt.element);break;case"repos":e.innerHTML=Ht.genHTML(),Ht.element=e,Ht.bindEvent();break;case"about":e.innerHTML=Lt.genHTML(),Lt.element=e,Lt.bindEvent();break;case"search":e.innerHTML=at.genHTML(),at.element=e,at.bindEvent();break;default:break}},yi=n=>{const e=window.siyuan.dialogs.find(a=>{if(a.element.querySelector(".config__tab-container"))return a.destroy(),!0});if(e)return e;const t=new Le({content:`<div class="fn__flex-1 fn__flex config__panel" style="overflow: hidden;position: relative">
  <ul class="b3-tab-bar b3-list b3-list--background">
    <div class="config__tab-title">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSettings"></use></svg>
        <span class="b3-list-item__text">${window.siyuan.languages.config}</span>
    </div>
    <div class="b3-form__icon"><svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg><input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input"></div>
    <div class="config__tab-hr"></div>
    <li data-name="editor" class="b3-list-item--focus b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconEdit"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.editor}</span></li>
    <li data-name="filetree" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconFiles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.fileTree}</span></li>
    <li data-name="card" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span></li>
    <li data-name="AI" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI</span></li>
    <li data-name="image" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></li>
    <li data-name="export" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconUpload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.export}</span></li>
    <li data-name="appearance" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconTheme"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.appearance}</span></li>
    <li data-name="bazaar" class="b3-list-item${wt()?" fn__none":""}"><svg class="b3-list-item__graphic"><use xlink:href="#iconBazaar"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bazaar}</span></li>
    <li data-name="search" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.search}</span></li>
    <li data-name="keymap" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.keymap}</span></li>
    <li data-name="account" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.account}</span></li>
    <li data-name="repos" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconCloud"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.cloud}</span></li>
    <li data-name="about" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconInfo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.about}</span></li>
  </ul>
  <div class="config__tab-wrap"> 
      <div class="config__tab-container" data-name="editor">${We.genHTML()}</div>
      <div class="config__tab-container fn__none" data-name="filetree"></div>
      <div class="config__tab-container fn__none" data-name="card"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="AI"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="image"></div>
      <div class="config__tab-container fn__none" data-name="export"></div>
      <div class="config__tab-container fn__none" data-name="appearance"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="bazaar"></div>
      <div class="config__tab-container fn__none" data-name="search"></div>
      <div class="config__tab-container fn__none" style="overflow: scroll" data-name="keymap"></div>
      <div class="config__tab-container config__tab-container--full fn__none" data-name="account"></div>
      <div class="config__tab-container fn__none" data-name="repos"></div>
      <div class="config__tab-container fn__none" data-name="about"></div>
  </div>
</div>`,width:"90vw",height:"90vh"});return SE(t.element,n),t.element.querySelector(".b3-dialog__container").style.maxWidth="1280px",t.element.querySelectorAll(".b3-tab-bar .b3-list-item").forEach(a=>{a.addEventListener("click",()=>{const i=a.getAttribute("data-name"),s=t.element.querySelector(`.config__tab-container[data-name="${i}"]`);t.element.querySelectorAll(".config__tab-container").forEach(o=>{o.classList.add("fn__none")}),t.element.querySelector(".b3-tab-bar .b3-list-item.b3-list-item--focus").classList.remove("b3-list-item--focus"),a.classList.add("b3-list-item--focus"),s.classList.remove("fn__none"),(s.innerHTML===""||i==="repos"||i==="bazaar")&&Pm(i,s,n)})}),We.element=t.element.querySelector('.config__tab-container[data-name="editor"]'),We.bindEvent(),t},xE=n=>{const e=new Le({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),t=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(t,()=>{a[1].click()}),t.focus(),t.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{n.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',_("/api/sync/createCloudSyncDir",{name:t.value},()=>{e.destroy(),wo(n,!0)})})},Mm=(n,e)=>{n.addEventListener("click",t=>{let a=t.target;for(;a&&!a.isEqualNode(n);){const i=a.getAttribute("data-type");if(i){switch(i){case"addCloud":xE(n);break;case"removeCloud":Ne(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{n.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',_("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},s=>{window.siyuan.config.sync.cloudName=s.data,wo(n,!0,e)})});break;case"selectCloud":n.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',_("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),wo(n,!0,e)});break}t.preventDefault(),t.stopPropagation();break}a=a.parentElement}})},wo=(n,e=!1,t)=>{!e&&n.firstElementChild.tagName!=="IMG"||_("/api/sync/listCloudSyncDir",{},a=>{let i=`<div class="fn__hr"></div><ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?i=`<div class="fn__hr"></div>
<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(i='<div class="fn__hr"></div><ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(s=>{i+=`<li data-type="selectCloud" data-name="${s.cloudName}" class="b3-list-item b3-list-item--hide-action">
<input type="radio" name="cloudName"${s.cloudName===a.data.checkedSyncDir?" checked":""}/>
<span class="fn__space"></span>
<span>${s.cloudName}</span>
<span class="fn__space"></span>
<span class="ft__on-surface">${s.hSize}</span>
<span class="b3-list-item__meta">${s.updated}</span>
<span class="fn__flex-1 fn__space"></span>
<span data-type="removeCloud" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></li>`}),i+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),n.innerHTML=i,t&&t()})},cu=n=>{var e;if(!window.siyuan.config.readonly&&!((e=document.querySelector("#barSync"))!=null&&e.classList.contains("toolbar__item--active"))){if(window.siyuan.config.sync.provider===0&&sa("")&&n){const t=yi(n);window.siyuan.user?t.element.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")):(t.element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),t.element.querySelector('.config__tab-container[data-name="account"]').setAttribute("data-action","go-repos"));return}if(window.siyuan.config.sync.provider!==0&&mc("")&&n){const t=yi(n);t.element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),t.element.querySelector('.config__tab-container[data-name="account"]').setAttribute("data-action","go-repos");return}if(!window.siyuan.config.repo.key){Hm(!0);return}if(!window.siyuan.config.sync.enabled){Nm();return}du()}},du=()=>{if(window.siyuan.config.sync.mode!==3){_("/api/sync/performSync",{});return}const n=new Le({title:window.siyuan.languages.chooseSyncDirection,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="true">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.uploadData2Cloud}
            <div class="b3-label__text">${window.siyuan.languages.uploadData2CloudTip}</div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="false">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.downloadDataFromCloud}
            <div class="b3-label__text">${window.siyuan.languages.downloadDataFromCloudTip}</div>
        </div>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,T.tq)()?"92vw":"520px"}),e=n.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{n.destroy()}),e[1].addEventListener("click",()=>{const t=n.element.querySelector("input[name=upload]:checked");if(!t){q(window.siyuan.languages.plsChoose);return}_("/api/sync/performSync",{upload:t.value==="true"}),n.destroy()})},Nm=(n,e)=>{if(n&&(window.siyuan.config.repo.key=n),window.siyuan.config.sync.enabled)e&&e.destroy(),Ne(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{du()});else{const t=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;e?(e.element.querySelector(".b3-dialog__header").innerHTML=window.siyuan.languages.cloudSyncDir,e.element.querySelector(".b3-dialog__body").innerHTML=t):e=new Le({title:window.siyuan.languages.cloudSyncDir,content:t,width:(0,T.tq)()?"92vw":"520px"});const a=e.element.querySelector(".b3-dialog__content").lastElementChild,i=e.element.querySelector(".b3-button");Mm(a,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),wo(a,!1,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{e.destroy(),_("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,Jn(),Ne(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{du()})})})}},Hm=(n,e)=>{const t=new Le({title:window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">
    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>
    <div class="fn__hr--b"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.duplicate} ${window.siyuan.languages.passphrase}">
</div>
<div class="b3-dialog__action">
    <label>
        <input type="checkbox" class="b3-switch fn__flex-center">
        <span class="fn__space"></span>
        ${window.siyuan.languages.confirmPassword}
    </label>
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--text" id="initKeyByPW" disabled>
        ${window.siyuan.languages.confirm}
    </button>
</div>`,width:(0,T.tq)()?"92vw":"520px"});t.element.querySelector(".b3-button--cancel").addEventListener("click",()=>{t.destroy()});const a=t.element.querySelector("#initKeyByPW");t.element.querySelector(".b3-switch").addEventListener("change",function(){this.checked?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});const i=t.element.querySelectorAll(".b3-text-field");a.addEventListener("click",()=>{if(!i[0].value||!i[1].value){q(window.siyuan.languages._kernel[142]);return}if(i[0].value!==i[1].value){q(window.siyuan.languages.passwordNoMatch);return}Ne("\u{1F511} "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,()=>{n||t.destroy(),_("/api/repo/initRepoKeyFromPassphrase",{pass:i[0].value},s=>{window.siyuan.config.repo.key=s.data.key,e&&e(),n&&Nm(s.data.key,t)})})}),i[0].focus()},AE=n=>{const e=document.getElementById("toolbar");e.innerHTML=`
<div id="barWorkspace" aria-label="${window.siyuan.languages.mainMenu} ${ae(window.siyuan.config.keymap.general.mainMenu.custom)}" class="ariaLabel toolbar__item toolbar__item--active">
    <span class="toolbar__text">${Yu()}</span>
    <svg class="toolbar__svg"><use xlink:href="#iconDown"></use></svg>
</div>
<div id="barSync" class="ariaLabel toolbar__item${window.siyuan.config.readonly?" fn__none":""}">
    <svg><use xlink:href="#iconCloudSucc"></use></svg>
</div>
<button id="barBack" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goBack} ${ae(window.siyuan.config.keymap.general.goBack.custom)}">
    <svg><use xlink:href="#iconBack"></use></svg>
</button>
<button id="barForward" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goForward} ${ae(window.siyuan.config.keymap.general.goForward.custom)}">
    <svg><use xlink:href="#iconForward"></use></svg>
</button>
<div class="fn__flex-1 fn__ellipsis" id="drag"><span class="fn__none">\u5F00\u53D1\u7248\uFF0C\u4F7F\u7528\u524D\u8BF7\u8FDB\u884C\u5907\u4EFD Development version, please backup before use</span></div>
<div id="toolbarVIP" class="fn__flex${window.siyuan.config.readonly?" fn__none":""}"></div>
<div id="barPlugins" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.plugin}">
    <svg><use xlink:href="#iconPlugin"></use></svg>
</div>
<div id="barSearch" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.globalSearch} ${ae(window.siyuan.config.keymap.general.globalSearch.custom)}">
    <svg><use xlink:href="#iconSearch"></use></svg>
</div>
<div id="barZoom" class="toolbar__item ariaLabel${window.siyuan.storage[p.Constants.LOCAL_ZOOM]===1||(0,T.jU)()?" fn__none":""}" aria-label="${window.siyuan.languages.zoom}">
    <svg><use xlink:href="#iconZoom${window.siyuan.storage[p.Constants.LOCAL_ZOOM]>1?"In":"Out"}"></use></svg>
</div>
<div id="barMode" class="toolbar__item ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.appearanceMode}">
    <svg><use xlink:href="#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}"></use></svg>
</div>
<div id="barExit" class="toolbar__item ariaLabel${Rt()||Mt()?"":" fn__none"}" aria-label="${window.siyuan.languages.safeQuit}">
    <svg><use xlink:href="#iconQuit"></use></svg>
</div>
<div id="barMore" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.more}">
    <svg><use xlink:href="#iconMore"></use></svg>
</div>
<div class="fn__flex" id="windowControls"></div>`,Jn(),e.addEventListener("click",a=>{let i=a.target;for(typeof a.detail=="string"&&(i=e.querySelector("#"+a.detail));!i.classList.contains("toolbar");){const s=typeof a.detail=="string"?a.detail:i.id;if(s==="barBack"){ld(n),a.stopPropagation();break}else if(s==="barMore"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barmore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barmore"),(i.getAttribute("data-hideids")||"").split(",").forEach(l=>{const r=e.querySelector("#"+l),c=r.querySelector("use"),u={label:l==="toolbarVIP"?window.siyuan.languages.account:r.getAttribute("aria-label"),icon:l==="toolbarVIP"?"iconAccount":c?c.getAttribute("xlink:href").substring(1):void 0,click:()=>{l.startsWith("plugin")?r.dispatchEvent(new CustomEvent("click")):e.dispatchEvent(new CustomEvent("click",{detail:l}))}};if(!c){const d=r.querySelector("svg").cloneNode(!0);d.classList.add("b3-menu__icon"),u.iconHTML=d.outerHTML}window.siyuan.menus.menu.append(new I(u).element)});const o=i.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="barForward"){rd(n),a.stopPropagation();break}else if(s==="barSync"){cu(n),a.stopPropagation();break}else if(s==="barWorkspace"){Am(n,i.getBoundingClientRect()),a.stopPropagation();break}else if(s==="barExit"){Tt({reload:!1,onlyData:!1,errorExit:!0,cb:rs}),a.stopPropagation();break}else if(s==="barMode"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barmode"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barmode"),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.themeLight,icon:"iconLight",current:window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS,click:()=>{pd(0)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.themeDark,current:window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS,icon:"iconDark",click:()=>{pd(1)}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.themeOS,current:window.siyuan.config.appearance.modeOS,icon:"iconMode",click:()=>{pd(2)}}).element);let o=i.getBoundingClientRect();o.width===0&&(o=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="toolbarVIP"){window.siyuan.config.readonly||yi(n).element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),a.stopPropagation();break}else if(s==="barSearch"){pn({app:n,hotkey:window.siyuan.config.keymap.general.globalSearch.custom}),a.stopPropagation();break}else if(s==="barPlugins"){TE(n,i),a.stopPropagation();break}else if(s==="barZoom"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barZoom"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barZoom"),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.zoomIn,icon:"iconZoomIn",accelerator:"\u2318=",click:()=>{uu("zoomIn")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.zoomOut,accelerator:"\u2318-",icon:"iconZoomOut",click:()=>{uu("zoomOut")}}).element),window.siyuan.menus.menu.append(new I({label:window.siyuan.languages.reset,accelerator:"\u23180",click:()=>{uu("restore")}}).element);let o=i.getBoundingClientRect();o.width===0&&(o=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}i=i.parentElement}});const t=e.querySelector("#barSync");t.addEventListener("mouseenter",a=>{a.stopPropagation(),a.preventDefault(),_("/api/sync/getSyncInfo",{},i=>{let s="";!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&sa("")?s=i.data.stat:(s=window.siyuan.languages._kernel[82].replace("%s",ue(i.data.synced).format("YYYY-MM-DD HH:mm"))+"<br>",s+="&emsp;"+i.data.stat,i.data.kernels.length>0&&(s+="<br>",s+=window.siyuan.languages.currentKernel+"<br>",s+="&emsp;"+i.data.kernel+"/"+window.siyuan.config.system.kernelVersion+" ("+window.siyuan.config.system.os+"/"+window.siyuan.config.system.name+")<br>",s+=window.siyuan.languages.otherOnlineKernels+"<br>",i.data.kernels.forEach(o=>{s+=`&emsp;${o.id}/${o.ver} (${o.os}/${o.hostname}) <br>`}))),t.setAttribute("aria-label",s)})}),t.setAttribute("aria-label",window.siyuan.config.sync.stat||window.siyuan.languages.syncNow+" "+ae(window.siyuan.config.keymap.general.syncNow.custom))},uu=n=>{},TE=(n,e)=>{const t=new Kt("topBarPlugin");wt()||t.addItem({icon:"iconSettings",label:window.siyuan.languages.config,click(){yi(n).element.querySelector('.b3-tab-bar [data-name="bazaar"]').dispatchEvent(new CustomEvent("click"))}}),t.addItem({icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.general.commandPanel.custom,label:window.siyuan.languages.commandPanel,click(){Cm(n)}}),t.addSeparator();let a=!1;n.plugins.forEach(s=>{const o=s.setting||s.__proto__.hasOwnProperty("openSetting");let l=!1;s.topBarIcons.forEach(r=>{const c=window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].includes(r.id),u=[{icon:"iconPin",label:c?window.siyuan.languages.pin:window.siyuan.languages.unpin,click(){c?(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].splice(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].indexOf(r.id),1),r.classList.remove("fn__none")):(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].push(r.id),window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN]=Array.from(new Set(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN])),r.classList.add("fn__none")),Ue(p.Constants.LOCAL_PLUGINTOPUNPIN,window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN])}}];o&&u.push({icon:"iconSettings",label:window.siyuan.languages.config,click(){s.openSetting()}});const d={icon:"iconInfo",label:r.getAttribute("aria-label"),click(){r.dispatchEvent(new CustomEvent("click"))},type:"submenu",submenu:u};if(r.querySelector("use"))d.icon=r.querySelector("use").getAttribute("xlink:href").replace("#","");else{const f=r.querySelector("svg").cloneNode(!0);f.classList.add("b3-menu__icon"),d.iconHTML=f.outerHTML}t.addItem(d),a=!0,l=!0}),!l&&o&&(a=!0,t.addItem({icon:"iconSettings",label:s.displayName,click(){s.openSetting()}}))}),a||window.siyuan.menus.menu.element.querySelector(".b3-menu__separator").remove();let i=e.getBoundingClientRect();i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),t.open({x:i.right,y:i.bottom,isLeft:!0})},IE=()=>{_("/api/system/getChangelog",{},n=>{if(!n.data.show)return;const e=new Le({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:(0,T.tq)()?"92vw":"768px",height:(0,T.tq)()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${n.data.html}</div>`});Ze(e.element)})},Bm=(n,e,t)=>{let a=1,i=n;for(;i&&(i.classList.contains("list")||i.classList.contains("li"));)i=document.elementFromPoint(e+73*a,t),i=M(i),a++;return i},DE=(n,e)=>{var t;if(document.body.classList.contains("body--blur"))return;const a=(t=window.siyuan.coordinates)!=null?t:window.siyuan.coordinates={pageX:0,pageY:0,clientX:0,clientY:0,screenX:0,screenY:0};a.pageX=n.pageX,a.pageY=n.pageY,a.clientX=n.clientX,a.clientY=n.clientY,a.screenX=n.screenX,a.screenY=n.screenY,window.siyuan.hideBreadcrumb&&(window.siyuan.hideBreadcrumb=!1,zh().forEach(l=>{var r;(r=l.protyle.breadcrumb)!=null&&r.element.classList.contains("protyle-breadcrumb__bar--hide")&&(l.protyle.breadcrumb.element.classList.remove("protyle-breadcrumb__bar--hide"),l.protyle.breadcrumb.render(l.protyle,!0))})),!e&&n.buttons===0&&window.siyuan.layout.bottomDock&&!(0,T.FJ)()&&!$(n.target,"b3-dialog")&&!$(n.target,"b3-menu")&&(n.clientX<43?!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.clientWidth>0&&(window.siyuan.layout.leftDock.element.clientWidth>0||window.siyuan.layout.leftDock.element.clientWidth===0&&n.clientX<8)&&(n.clientY>document.getElementById("toolbar").clientHeight&&n.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?!$(n.target,"b3-menu")&&!$(n.target,"layout--float")&&window.siyuan.layout.leftDock.showDock():window.siyuan.layout.leftDock.hideDock()):n.clientX>window.innerWidth-41&&!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.clientWidth>0&&(window.siyuan.layout.rightDock.element.clientWidth>0||window.siyuan.layout.rightDock.element.clientWidth===0&&n.clientX>window.innerWidth-8)&&(n.clientY>document.getElementById("toolbar").clientHeight&&n.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?$(n.target,"layout--float")||window.siyuan.layout.rightDock.showDock():window.siyuan.layout.rightDock.hideDock()),n.clientY>window.innerHeight-73&&window.siyuan.layout.bottomDock.showDock());const i=n.composedPath()[0];if(i&&i.nodeType!==3&&i.classList.contains("protyle-wysiwyg")&&i.style.paddingLeft){const l=document.elementFromPoint(i.getBoundingClientRect().left+parseInt(i.style.paddingLeft)+13,n.clientY),r=M(l);if(r){const c=Bm(r,r.getBoundingClientRect().left+1,n.clientY);if(!c)return;const u=Ye();let d=!1;u.editor.find(f=>{if(f.editor.protyle.wysiwyg.element.isSameNode(i))return f.editor.protyle.gutter.render(f.editor.protyle,c,f.editor.protyle.wysiwyg.element),d=!0,!0}),d||window.siyuan.blockPanels.find(f=>{if(f.editors.find(g=>{if(g.protyle.wysiwyg.element.contains(i))return g.protyle.gutter.render(g.protyle,c,g.protyle.wysiwyg.element),d=!0,!0}),d)return!0}),d||u.backlink.find(f=>{if(f.editors.find(g=>{if(g.protyle.wysiwyg.element.isSameNode(i))return g.protyle.gutter.render(g.protyle,c,g.protyle.wysiwyg.element),d=!0,!0}),d)return!0})}return}if(i&&i.nodeType!==3&&(i.classList.contains("li")||i.classList.contains("list"))){const l=Bm(i,i.getBoundingClientRect().left+1,n.clientY);if(!l)return;const r=Ye();let c=!1;r.editor.find(u=>{if(u.editor.protyle.wysiwyg.element.contains(i))return u.editor.protyle.gutter.render(u.editor.protyle,l,u.editor.protyle.wysiwyg.element),c=!0,!0}),c||window.siyuan.blockPanels.find(u=>{if(u.editors.find(d=>{if(d.protyle.wysiwyg.element.contains(i))return d.protyle.gutter.render(d.protyle,l,d.protyle.wysiwyg.element),c=!0,!0}),c)return!0}),c||r.backlink.find(u=>{if(u.editors.find(d=>{if(d.protyle.wysiwyg.element.contains(i))return d.protyle.gutter.render(d.protyle,l,d.protyle.wysiwyg.element),c=!0,!0}),c)return!0});return}const s=n.target,o=$(s,"table");if(o&&o.style.cursor!=="col-resize"&&!$(o,"protyle-wysiwyg__embed")){const l=te(s,"TH")||te(s,"TD");if(l){const r=o.querySelector("table"),c=o.querySelector("table").clientHeight,u=o.querySelector(".table__resize");o.style.textAlign==="center"||o.style.textAlign==="right"?u.parentElement.style.left=r.offsetLeft+"px":u.parentElement.style.left="";const d=l.getBoundingClientRect();d.right-n.clientX<3&&d.right-n.clientX>0?(u.setAttribute("data-col-index",(vn(l)+l.colSpan-1).toString()),u.setAttribute("style",`height:${c}px;left: ${Math.round(l.offsetWidth+l.offsetLeft-o.firstElementChild.scrollLeft-3)}px;display:block`)):n.clientX-d.left<3&&n.clientX-d.left>0&&l.previousElementSibling&&(u.setAttribute("data-col-index",(vn(l)-1).toString()),u.setAttribute("style",`height:${c}px;left: ${Math.round(l.offsetLeft-o.firstElementChild.scrollLeft-3)}px;display:block`))}}},$E=(n,e)=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1;const t=window.siyuan.dialogs.find(a=>{if(a.element.getAttribute("data-key")==="\u2303\u21E5")return!0});if(t&&t.element.parentElement){if(e.key==="Tab"){let a=t.element.querySelector(".b3-list-item--focus");if(a.classList.remove("b3-list-item--focus"),e.shiftKey?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.getAttribute("data-original")?(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.lastElementChild?a.parentElement.nextElementSibling.lastElementChild.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus"):a.parentElement.previousElementSibling&&a.parentElement.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.getAttribute("data-original")?(a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.firstElementChild?a.parentElement.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"):a.parentElement.previousElementSibling&&a.parentElement.previousElementSibling.firstElementChild.classList.add("b3-list-item--focus"),a=t.element.querySelector(".b3-list-item--focus"),a){const s=a.getAttribute("data-node-id");s?_("/api/filetree/getFullHPathByID",{id:s},r=>{a.parentElement.parentElement.nextElementSibling.innerHTML=De(r.data)}):a.parentElement.parentElement.nextElementSibling.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const o=a.getBoundingClientRect(),l=a.parentElement.getBoundingClientRect();o.top<l.top?a.scrollIntoView(!0):o.bottom>l.bottom&&a.scrollIntoView(!1)}const i=t.element.querySelector('[data-original="true"]');i&&i.removeAttribute("data-original")}else if(e.key==="Control"){let a=t.element.querySelector(".b3-list-item--focus");a.getAttribute("data-original")&&(a.classList.remove("b3-list-item--focus"),e.shiftKey?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original"),a=t.element.querySelector(".b3-list-item--focus"));const i=a.getAttribute("data-type");if(i)i==="riffCard"?Qs(n):At(i).toggleModel(i,!0),document.activeElement&&document.activeElement.blur();else{const s=a.getAttribute("data-id");Zn().find(o=>{if(o.id===s)return o.parent.switchTab(o.headElement),o.parent.showHeading(),!0})}t.destroy()}}},PE=n=>{!window.siyuan.menus.menu.element.contains(n.target)&&!S(n.target,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove()),$(n.target,"protyle-toolbar")||Oi(["toolbar"]),$(n.target,"pdf__outer")||Oi(["pdfutil"]);const e=$(n.target,"layout--float",!0);e&&window.siyuan.layout.leftDock?(e.isSameNode(window.siyuan.layout.bottomDock.layout.element)||window.siyuan.layout.bottomDock.hideDock(),e.isSameNode(window.siyuan.layout.leftDock.layout.element)||window.siyuan.layout.leftDock.hideDock(),e.isSameNode(window.siyuan.layout.rightDock.layout.element)||window.siyuan.layout.rightDock.hideDock()):!$(n.target,"dock")&&!(0,T.FJ)()&&window.siyuan.layout.leftDock&&(window.siyuan.layout.bottomDock.hideDock(),window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock());const t=et(n.target,"protyle-action__copy");if(t){let i=t.parentElement.nextElementSibling.textContent.trimEnd();i=i.replace(/\u00A0/g," "),O(i),q(window.siyuan.languages.copied,2e3),n.preventDefault();return}if(S(n.target,"id","secondaryToolbarToggle")||S(n.target,"id","viewFind")||S(n.target,"id","findbar"))return;let a;Ye().asset.find(i=>{if(i.pdfObject&&!i.pdfObject.appConfig.appContainer.classList.contains("fn__none"))return a=i.pdfObject,!0}),a&&(a.secondaryToolbar.isOpen&&a.secondaryToolbar.close(),!a.supportsIntegratedFind&&a.findBar.opened&&a.findBar.close())},ME=(n,e,t,a)=>{const i=n.target,s=_n();if(typeof e=="undefined"&&new Date().getTime()-t>900){const o=S(i,"data-type","navigation-root")||S(i,"data-type","navigation-file");if(o){if(!window.siyuan.config.readonly&&o.dataset.type==="navigation-root"){const l=Dl(a,o);if(s){const r=o.getBoundingClientRect();l.popup({x:r.right-52,y:r.bottom,h:r.height}),Mn()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(o.dataset.type==="navigation-file"){const l=ve(o,"UL");if(l){const r=$l(a,l.dataset.url,o.dataset.path,o);if(s){const c=o.getBoundingClientRect();r.popup({x:c.right-52,y:c.bottom,h:c.height}),Mn()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(i.tagName==="SPAN"&&!S(i,"data-type","NodeBlockQueryEmbed")){let l;const r=$(i,"protyle",!0);if(r){const u=St(r.dataset.id);u instanceof ht&&u.model instanceof gt&&(l=u.model.editor)}if(!l)return!1;const c=(i.getAttribute("data-type")||"").split(" ");if(c.includes("inline-memo")&&l.protyle.toolbar.showRender(l.protyle,i),l.protyle.disabled)return n.stopImmediatePropagation(),n.preventDefault(),!0;if(c.includes("block-ref"))return Qc(l.protyle,i),!0;if(c.includes("file-annotation-ref"))return Jc(l.protyle,i),!0;if(c.includes("tag"))return nd(l.protyle,i),!0;if(c.includes("a"))return js(l.protyle,i),!0}}return!1},NE=n=>{document.body.addEventListener("mouseleave",()=>{window.siyuan.layout.leftDock&&(window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock(),window.siyuan.layout.bottomDock.hideDock()),Mn()});let e=!1;if(document.body.addEventListener("mouseenter",()=>{window.siyuan.layout.leftDock&&(e=!0,setTimeout(()=>{e=!1},p.Constants.TIMEOUT_TRANSITION))}),window.addEventListener("mousemove",t=>{DE(t,e)}),window.addEventListener("mouseup",t=>{t.button===3?(t.preventDefault(),ld(n)):t.button===4&&(t.preventDefault(),rd(n))}),window.addEventListener("keyup",t=>{$E(n,t)}),window.addEventListener("keydown",t=>{kE(n,t)}),window.addEventListener("blur",()=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1}),window.addEventListener("click",t=>{PE(t)}),_n()){let t=0;document.addEventListener("touchstart",()=>{t=new Date().getTime()},!1),document.addEventListener("touchend",a=>{if(ME(a,void 0,t,n)){a.stopImmediatePropagation(),a.preventDefault();return}if(new Date().getTime()-t<=900)return;const i=a.target,s=$(i,"dock__item");if(s&&s.getAttribute("data-type")){const l=s.getBoundingClientRect();Em(s).popup({x:l.right,y:l.top}),a.stopImmediatePropagation(),a.preventDefault();return}const o=S(i,"data-type","tab-header");if(o){const l=o.getBoundingClientRect();km(n,St(o.getAttribute("data-id"))).popup({x:l.left,y:l.bottom}),Mn(),a.stopImmediatePropagation(),a.preventDefault();return}},!1)}};var Om=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});const ps=(n,e,t)=>{if(e==="general"){if(!window.siyuan.config.keymap[e])return window.siyuan.config.keymap[e]=n,!1}else{if(!window.siyuan.config.keymap[e])return window.siyuan.config.keymap[e]=JSON.parse(JSON.stringify(p.Constants.SIYUAN_KEYMAP.editor)),!1;if(!window.siyuan.config.keymap[e][t])return window.siyuan.config.keymap[e][t]=n,!1}let a=!0;return Object.keys(n).forEach(i=>{e==="general"?(!window.siyuan.config.keymap[e][i]||window.siyuan.config.keymap[e][i].default!==n[i].default)&&(a=!1,window.siyuan.config.keymap[e][i]=n[i]):(!window.siyuan.config.keymap[e][t][i]||window.siyuan.config.keymap[e][t][i].default!==n[i].default)&&(a=!1,window.siyuan.config.keymap[e][t][i]=n[i])}),a},gs=(n,e,t)=>{let a=!0;return e==="editor"?Object.keys(window.siyuan.config.keymap[e][t]).length!==Object.keys(p.Constants.SIYUAN_KEYMAP[e][t]).length&&Object.keys(window.siyuan.config.keymap[e][t]).forEach(i=>{p.Constants.SIYUAN_KEYMAP[e][t][i]||(a=!1,delete window.siyuan.config.keymap[e][t][i])}):Object.keys(window.siyuan.config.keymap[e]).length!==Object.keys(p.Constants.SIYUAN_KEYMAP[e]).length&&Object.keys(window.siyuan.config.keymap[e]).forEach(i=>{p.Constants.SIYUAN_KEYMAP[e][i]||(a=!1,delete window.siyuan.config.keymap[e][i])}),a},HE=(n,e)=>{const t=ps(p.Constants.SIYUAN_KEYMAP.general,"general"),a=ps(p.Constants.SIYUAN_KEYMAP.editor.general,"editor","general"),i=ps(p.Constants.SIYUAN_KEYMAP.editor.insert,"editor","insert"),s=ps(p.Constants.SIYUAN_KEYMAP.editor.heading,"editor","heading"),o=ps(p.Constants.SIYUAN_KEYMAP.editor.list,"editor","list"),l=ps(p.Constants.SIYUAN_KEYMAP.editor.table,"editor","table"),r=gs(p.Constants.SIYUAN_KEYMAP.general,"general"),c=gs(p.Constants.SIYUAN_KEYMAP.editor.general,"editor","general"),u=gs(p.Constants.SIYUAN_KEYMAP.editor.insert,"editor","insert"),d=gs(p.Constants.SIYUAN_KEYMAP.editor.heading,"editor","heading"),f=gs(p.Constants.SIYUAN_KEYMAP.editor.list,"editor","list"),g=gs(p.Constants.SIYUAN_KEYMAP.editor.table,"editor","table");!window.siyuan.config.readonly&&(!t||!a||!i||!s||!o||!l||!r||!c||!u||!d||!f||!g)&&_("/api/setting/setKeymap",{data:window.siyuan.config.keymap},()=>{lu(e)}),(!window.siyuan.config.uiLayout||window.siyuan.config.uiLayout&&!window.siyuan.config.uiLayout.left)&&(window.siyuan.config.uiLayout=p.Constants.SIYUAN_EMPTY_LAYOUT),NE(e),_("/api/system/getEmojiConf",{},m=>{window.siyuan.emojis=m.data;try{pE(e,n),IE()}catch(b){mm()}}),AE(e),Gu(),bv(),BE(e),ut.onSetappearance(window.siyuan.config.appearance),Jw(),ju(),fd();let h=0;window.addEventListener("resize",()=>{window.clearTimeout(h),h=window.setTimeout(()=>{nn(),or()},200)}),Qw()},bk=()=>Om(void 0,null,function*(){}),BE=n=>Om(void 0,null,function*(){(0,T.FJ)()||document.querySelector(".toolbar").classList.add("toolbar--browser"),window.addEventListener("beforeunload",()=>{Tt({reload:!1,onlyData:!1,errorExit:!1})},!1),window.addEventListener("pagehide",()=>{Tt({reload:!1,onlyData:!1,errorExit:!1})},!1)}),OE=(n,e="/",t="module")=>{!("serviceWorker"in navigator)||typeof navigator.serviceWorker=="undefined"||!("caches"in window)||!("fetch"in window)||window.navigator.serviceWorker.register(n,{scope:e,type:t}).then(a=>{a.update()}).catch(a=>{console.debug(`Registration failed with ${a}`)})};var RE=(n,e,t)=>new Promise((a,i)=>{var s=r=>{try{l(t.next(r))}catch(c){i(c)}},o=r=>{try{l(t.throw(r))}catch(c){i(c)}},l=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,o);l((t=t.apply(n,e)).next())});class qE{constructor(){this.plugins=[],OE(`${p.Constants.SERVICE_WORKER_PATH}?v=${p.Constants.SIYUAN_VERSION}`),(0,vt.addScriptSync)(`${p.Constants.PROTYLE_CDN}/js/lute/lute.min.js?v=${p.Constants.SIYUAN_VERSION}`,"protyleLuteScript"),(0,vt.addScript)(`${p.Constants.PROTYLE_CDN}/js/protyle-html.js?v=${p.Constants.SIYUAN_VERSION}`,"protyleWcHtmlScript"),lv(),window.siyuan={zIndex:10,transactions:[],reqIds:{},backStack:[],layout:{},dialogs:[],blockPanels:[],ctrlIsPressed:!1,altIsPressed:!1,ws:new sn({app:this,id:ke(),type:"main",msgCallback:e=>{if(this.plugins.forEach(t=>{t.eventBus.emit("ws-main",e)}),e)switch(e.cmd){case"syncMergeResult":Gh(this,e.data);break;case"readonly":window.siyuan.config.editor.readOnly=e.data,Oi(["util"]);break;case"progress":fv(e);break;case"setLocalStorageVal":window.siyuan.storage[e.data.key]=e.data.val;break;case"rename":Zn().forEach(t=>{if(t.headElement){const a=t.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&i.rootId===e.data.id&&t.updateTitle(e.data.title)}}});break;case"unmount":Zn().forEach(t=>{if(t.headElement){const a=t.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&e.data.box===i.notebookId&&t.parent.removeTab(t.id)}}});break;case"removeDoc":Zn().forEach(t=>{if(t.headElement){const a=t.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&e.data.ids.includes(i.rootId)&&t.parent.removeTab(t.id)}}});break;case"statusbar":uv(e);break;case"downloadProgress":hv(e.data);break;case"txerr":dv();break;case"syncing":Jn(e);break;case"backgroundtask":pv(e.data.tasks);break;case"refreshtheme":window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark!=="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight!=="daylight"?document.getElementById("themeStyle").href=e.data.theme:document.getElementById("themeDefaultStyle").href=e.data.theme;break;case"createdailynote":be({app:this,id:e.data.id,action:[p.Constants.CB_GET_FOCUS]});break;case"openFileById":be({app:this,id:e.data.id,action:[p.Constants.CB_GET_FOCUS]});break}}})},_("/api/system/getConf",{},e=>RE(this,null,function*(){window.siyuan.config=e.data.conf,window.siyuan.config.uiLayout.left&&!window.siyuan.config.uiLayout.left.data&&(window.siyuan.config.uiLayout.left={pin:!0,data:e.data.conf.uiLayout.left},window.siyuan.config.uiLayout.right={pin:!0,data:e.data.conf.uiLayout.right},window.siyuan.config.uiLayout.bottom={pin:!0,data:e.data.conf.uiLayout.bottom}),yield pm(this),Wt(()=>{Zh(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${p.Constants.SIYUAN_VERSION}`,t=>{window.siyuan.languages=t,window.siyuan.menus=new bE(this),gv(),_("/api/setting/getCloudUser",{},a=>{window.siyuan.user=a.data,HE(e.data.start,this),Dt.onSetaccount(),er(window.siyuan.languages.siyuanNote),W()})})})})),_a(),yE(this)}}const FE=new qE;window.openFileByURL=n=>{if(n&&sv(n)){const e=(0,T.on)("focus",n)==="1";return be({app:FE,id:Jl(n),action:e?[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:e}),!0}return!1},window.showKeyboardToolbar=()=>{}})()})();})();
