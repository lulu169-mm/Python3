(()=>{(()=>{var tr={970:function(We,fe,H){var qt;(function(rt){"use strict";function _e(A,I){var R=(A&65535)+(I&65535),N=(A>>16)+(I>>16)+(R>>16);return N<<16|R&65535}function W(A,I){return A<<I|A>>>32-I}function U(A,I,R,N,ie,G){return _e(W(_e(_e(I,A),_e(N,G)),ie),R)}function X(A,I,R,N,ie,G,V){return U(I&R|~I&N,A,I,ie,G,V)}function ne(A,I,R,N,ie,G,V){return U(I&N|R&~N,A,I,ie,G,V)}function se(A,I,R,N,ie,G,V){return U(I^R^N,A,I,ie,G,V)}function Q(A,I,R,N,ie,G,V){return U(R^(I|~N),A,I,ie,G,V)}function ge(A,I){A[I>>5]|=128<<I%32,A[(I+64>>>9<<4)+14]=I;var R,N,ie,G,V,B=1732584193,M=-271733879,$=-1732584194,q=271733878;for(R=0;R<A.length;R+=16)N=B,ie=M,G=$,V=q,B=X(B,M,$,q,A[R],7,-680876936),q=X(q,B,M,$,A[R+1],12,-389564586),$=X($,q,B,M,A[R+2],17,606105819),M=X(M,$,q,B,A[R+3],22,-1044525330),B=X(B,M,$,q,A[R+4],7,-176418897),q=X(q,B,M,$,A[R+5],12,1200080426),$=X($,q,B,M,A[R+6],17,-1473231341),M=X(M,$,q,B,A[R+7],22,-45705983),B=X(B,M,$,q,A[R+8],7,1770035416),q=X(q,B,M,$,A[R+9],12,-1958414417),$=X($,q,B,M,A[R+10],17,-42063),M=X(M,$,q,B,A[R+11],22,-1990404162),B=X(B,M,$,q,A[R+12],7,1804603682),q=X(q,B,M,$,A[R+13],12,-40341101),$=X($,q,B,M,A[R+14],17,-1502002290),M=X(M,$,q,B,A[R+15],22,1236535329),B=ne(B,M,$,q,A[R+1],5,-165796510),q=ne(q,B,M,$,A[R+6],9,-1069501632),$=ne($,q,B,M,A[R+11],14,643717713),M=ne(M,$,q,B,A[R],20,-373897302),B=ne(B,M,$,q,A[R+5],5,-701558691),q=ne(q,B,M,$,A[R+10],9,38016083),$=ne($,q,B,M,A[R+15],14,-660478335),M=ne(M,$,q,B,A[R+4],20,-405537848),B=ne(B,M,$,q,A[R+9],5,568446438),q=ne(q,B,M,$,A[R+14],9,-1019803690),$=ne($,q,B,M,A[R+3],14,-187363961),M=ne(M,$,q,B,A[R+8],20,1163531501),B=ne(B,M,$,q,A[R+13],5,-1444681467),q=ne(q,B,M,$,A[R+2],9,-51403784),$=ne($,q,B,M,A[R+7],14,1735328473),M=ne(M,$,q,B,A[R+12],20,-1926607734),B=se(B,M,$,q,A[R+5],4,-378558),q=se(q,B,M,$,A[R+8],11,-2022574463),$=se($,q,B,M,A[R+11],16,1839030562),M=se(M,$,q,B,A[R+14],23,-35309556),B=se(B,M,$,q,A[R+1],4,-1530992060),q=se(q,B,M,$,A[R+4],11,1272893353),$=se($,q,B,M,A[R+7],16,-155497632),M=se(M,$,q,B,A[R+10],23,-1094730640),B=se(B,M,$,q,A[R+13],4,681279174),q=se(q,B,M,$,A[R],11,-358537222),$=se($,q,B,M,A[R+3],16,-722521979),M=se(M,$,q,B,A[R+6],23,76029189),B=se(B,M,$,q,A[R+9],4,-640364487),q=se(q,B,M,$,A[R+12],11,-421815835),$=se($,q,B,M,A[R+15],16,530742520),M=se(M,$,q,B,A[R+2],23,-995338651),B=Q(B,M,$,q,A[R],6,-198630844),q=Q(q,B,M,$,A[R+7],10,1126891415),$=Q($,q,B,M,A[R+14],15,-1416354905),M=Q(M,$,q,B,A[R+5],21,-57434055),B=Q(B,M,$,q,A[R+12],6,1700485571),q=Q(q,B,M,$,A[R+3],10,-1894986606),$=Q($,q,B,M,A[R+10],15,-1051523),M=Q(M,$,q,B,A[R+1],21,-2054922799),B=Q(B,M,$,q,A[R+8],6,1873313359),q=Q(q,B,M,$,A[R+15],10,-30611744),$=Q($,q,B,M,A[R+6],15,-1560198380),M=Q(M,$,q,B,A[R+13],21,1309151649),B=Q(B,M,$,q,A[R+4],6,-145523070),q=Q(q,B,M,$,A[R+11],10,-1120210379),$=Q($,q,B,M,A[R+2],15,718787259),M=Q(M,$,q,B,A[R+9],21,-343485551),B=_e(B,N),M=_e(M,ie),$=_e($,G),q=_e(q,V);return[B,M,$,q]}function ke(A){var I,R="",N=A.length*32;for(I=0;I<N;I+=8)R+=String.fromCharCode(A[I>>5]>>>I%32&255);return R}function Xe(A){var I,R=[];for(R[(A.length>>2)-1]=void 0,I=0;I<R.length;I+=1)R[I]=0;var N=A.length*8;for(I=0;I<N;I+=8)R[I>>5]|=(A.charCodeAt(I/8)&255)<<I%32;return R}function Ue(A){return ke(ge(Xe(A),A.length*8))}function He(A,I){var R,N=Xe(A),ie=[],G=[],V;for(ie[15]=G[15]=void 0,N.length>16&&(N=ge(N,A.length*8)),R=0;R<16;R+=1)ie[R]=N[R]^909522486,G[R]=N[R]^1549556828;return V=ge(ie.concat(Xe(I)),512+I.length*8),ke(ge(G.concat(V),640))}function Zt(A){var I="0123456789abcdef",R="",N,ie;for(ie=0;ie<A.length;ie+=1)N=A.charCodeAt(ie),R+=I.charAt(N>>>4&15)+I.charAt(N&15);return R}function ct(A){return unescape(encodeURIComponent(A))}function g(A){return Ue(ct(A))}function Je(A){return Zt(g(A))}function tt(A,I){return He(ct(A),ct(I))}function wt(A,I){return Zt(tt(A,I))}function Ht(A,I,R){return I?R?tt(I,A):wt(I,A):R?g(A):Je(A)}qt=function(){return Ht}.call(fe,H,fe,We),qt!==void 0&&(We.exports=qt)})(this)},680:function(We){(function(fe,H){We.exports=H()})(this,function(){"use strict";var fe=1e3,H=6e4,qt=36e5,rt="millisecond",_e="second",W="minute",U="hour",X="day",ne="week",se="month",Q="quarter",ge="year",ke="date",Xe="Invalid Date",Ue=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,He=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Zt={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},ct=function(ie,G,V){var B=String(ie);return!B||B.length>=G?ie:""+Array(G+1-B.length).join(V)+ie},g={s:ct,z:function(ie){var G=-ie.utcOffset(),V=Math.abs(G),B=Math.floor(V/60),M=V%60;return(G<=0?"+":"-")+ct(B,2,"0")+":"+ct(M,2,"0")},m:function ie(G,V){if(G.date()<V.date())return-ie(V,G);var B=12*(V.year()-G.year())+(V.month()-G.month()),M=G.clone().add(B,se),$=V-M<0,q=G.clone().add(B+($?-1:1),se);return+(-(B+(V-M)/($?M-q:q-M))||0)},a:function(ie){return ie<0?Math.ceil(ie)||0:Math.floor(ie)},p:function(ie){return{M:se,y:ge,w:ne,d:X,D:ke,h:U,m:W,s:_e,ms:rt,Q}[ie]||String(ie||"").toLowerCase().replace(/s$/,"")},u:function(ie){return ie===void 0}},Je="en",tt={};tt[Je]=Zt;var wt=function(ie){return ie instanceof R},Ht=function ie(G,V,B){var M;if(!G)return Je;if(typeof G=="string"){var $=G.toLowerCase();tt[$]&&(M=$),V&&(tt[$]=V,M=$);var q=G.split("-");if(!M&&q.length>1)return ie(q[0])}else{var Me=G.name;tt[Me]=G,M=Me}return!B&&M&&(Je=M),M||!B&&Je},A=function(ie,G){if(wt(ie))return ie.clone();var V=typeof G=="object"?G:{};return V.date=ie,V.args=arguments,new R(V)},I=g;I.l=Ht,I.i=wt,I.w=function(ie,G){return A(ie,{locale:G.$L,utc:G.$u,x:G.$x,$offset:G.$offset})};var R=function(){function ie(V){this.$L=Ht(V.locale,null,!0),this.parse(V)}var G=ie.prototype;return G.parse=function(V){this.$d=function(B){var M=B.date,$=B.utc;if(M===null)return new Date(NaN);if(I.u(M))return new Date;if(M instanceof Date)return new Date(M);if(typeof M=="string"&&!/Z$/i.test(M)){var q=M.match(Ue);if(q){var Me=q[2]-1||0,he=(q[7]||"0").substring(0,3);return $?new Date(Date.UTC(q[1],Me,q[3]||1,q[4]||0,q[5]||0,q[6]||0,he)):new Date(q[1],Me,q[3]||1,q[4]||0,q[5]||0,q[6]||0,he)}}return new Date(M)}(V),this.$x=V.x||{},this.init()},G.init=function(){var V=this.$d;this.$y=V.getFullYear(),this.$M=V.getMonth(),this.$D=V.getDate(),this.$W=V.getDay(),this.$H=V.getHours(),this.$m=V.getMinutes(),this.$s=V.getSeconds(),this.$ms=V.getMilliseconds()},G.$utils=function(){return I},G.isValid=function(){return this.$d.toString()!==Xe},G.isSame=function(V,B){var M=A(V);return this.startOf(B)<=M&&M<=this.endOf(B)},G.isAfter=function(V,B){return A(V)<this.startOf(B)},G.isBefore=function(V,B){return this.endOf(B)<A(V)},G.$g=function(V,B,M){return I.u(V)?this[B]:this.set(M,V)},G.unix=function(){return Math.floor(this.valueOf()/1e3)},G.valueOf=function(){return this.$d.getTime()},G.startOf=function(V,B){var M=this,$=!!I.u(B)||B,q=I.p(V),Me=function(gn,Ge){var Fe=I.w(M.$u?Date.UTC(M.$y,Ge,gn):new Date(M.$y,Ge,gn),M);return $?Fe:Fe.endOf(X)},he=function(gn,Ge){return I.w(M.toDate()[gn].apply(M.toDate("s"),($?[0,0,0,0]:[23,59,59,999]).slice(Ge)),M)},Ee=this.$W,xe=this.$M,Xt=this.$D,Ot="set"+(this.$u?"UTC":"");switch(q){case ge:return $?Me(1,0):Me(31,11);case se:return $?Me(1,xe):Me(0,xe+1);case ne:var Pn=this.$locale().weekStart||0,En=(Ee<Pn?Ee+7:Ee)-Pn;return Me($?Xt-En:Xt+(6-En),xe);case X:case ke:return he(Ot+"Hours",0);case U:return he(Ot+"Minutes",1);case W:return he(Ot+"Seconds",2);case _e:return he(Ot+"Milliseconds",3);default:return this.clone()}},G.endOf=function(V){return this.startOf(V,!1)},G.$set=function(V,B){var M,$=I.p(V),q="set"+(this.$u?"UTC":""),Me=(M={},M[X]=q+"Date",M[ke]=q+"Date",M[se]=q+"Month",M[ge]=q+"FullYear",M[U]=q+"Hours",M[W]=q+"Minutes",M[_e]=q+"Seconds",M[rt]=q+"Milliseconds",M)[$],he=$===X?this.$D+(B-this.$W):B;if($===se||$===ge){var Ee=this.clone().set(ke,1);Ee.$d[Me](he),Ee.init(),this.$d=Ee.set(ke,Math.min(this.$D,Ee.daysInMonth())).$d}else Me&&this.$d[Me](he);return this.init(),this},G.set=function(V,B){return this.clone().$set(V,B)},G.get=function(V){return this[I.p(V)]()},G.add=function(V,B){var M,$=this;V=Number(V);var q=I.p(B),Me=function(xe){var Xt=A($);return I.w(Xt.date(Xt.date()+Math.round(xe*V)),$)};if(q===se)return this.set(se,this.$M+V);if(q===ge)return this.set(ge,this.$y+V);if(q===X)return Me(1);if(q===ne)return Me(7);var he=(M={},M[W]=H,M[U]=qt,M[_e]=fe,M)[q]||1,Ee=this.$d.getTime()+V*he;return I.w(Ee,this)},G.subtract=function(V,B){return this.add(-1*V,B)},G.format=function(V){var B=this,M=this.$locale();if(!this.isValid())return M.invalidDate||Xe;var $=V||"YYYY-MM-DDTHH:mm:ssZ",q=I.z(this),Me=this.$H,he=this.$m,Ee=this.$M,xe=M.weekdays,Xt=M.months,Ot=function(Ge,Fe,Pa,la){return Ge&&(Ge[Fe]||Ge(B,$))||Pa[Fe].slice(0,la)},Pn=function(Ge){return I.s(Me%12||12,Ge,"0")},En=M.meridiem||function(Ge,Fe,Pa){var la=Ge<12?"AM":"PM";return Pa?la.toLowerCase():la},gn={YY:String(this.$y).slice(-2),YYYY:this.$y,M:Ee+1,MM:I.s(Ee+1,2,"0"),MMM:Ot(M.monthsShort,Ee,Xt,3),MMMM:Ot(Xt,Ee),D:this.$D,DD:I.s(this.$D,2,"0"),d:String(this.$W),dd:Ot(M.weekdaysMin,this.$W,xe,2),ddd:Ot(M.weekdaysShort,this.$W,xe,3),dddd:xe[this.$W],H:String(Me),HH:I.s(Me,2,"0"),h:Pn(1),hh:Pn(2),a:En(Me,he,!0),A:En(Me,he,!1),m:String(he),mm:I.s(he,2,"0"),s:String(this.$s),ss:I.s(this.$s,2,"0"),SSS:I.s(this.$ms,3,"0"),Z:q};return $.replace(He,function(Ge,Fe){return Fe||gn[Ge]||q.replace(":","")})},G.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},G.diff=function(V,B,M){var $,q=I.p(B),Me=A(V),he=(Me.utcOffset()-this.utcOffset())*H,Ee=this-Me,xe=I.m(this,Me);return xe=($={},$[ge]=xe/12,$[se]=xe,$[Q]=xe/3,$[ne]=(Ee-he)/6048e5,$[X]=(Ee-he)/864e5,$[U]=Ee/qt,$[W]=Ee/H,$[_e]=Ee/fe,$)[q]||Ee,M?xe:I.a(xe)},G.daysInMonth=function(){return this.endOf(se).$D},G.$locale=function(){return tt[this.$L]},G.locale=function(V,B){if(!V)return this.$L;var M=this.clone(),$=Ht(V,B,!0);return $&&(M.$L=$),M},G.clone=function(){return I.w(this.$d,this)},G.toDate=function(){return new Date(this.valueOf())},G.toJSON=function(){return this.isValid()?this.toISOString():null},G.toISOString=function(){return this.$d.toISOString()},G.toString=function(){return this.$d.toUTCString()},ie}(),N=R.prototype;return A.prototype=N,[["$ms",rt],["$s",_e],["$m",W],["$H",U],["$W",X],["$M",se],["$y",ge],["$D",ke]].forEach(function(ie){N[ie[1]]=function(G){return this.$g(G,ie[0],ie[1])}}),A.extend=function(ie,G){return ie.$i||(ie(G,R,A),ie.$i=!0),A},A.locale=Ht,A.isDayjs=wt,A.unix=function(ie){return A(1e3*ie)},A.en=tt[Je],A.Ls=tt,A.p={},A})},5:We=>{"use strict";function fe(_e){if(typeof _e!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(_e))}function H(_e,W){for(var U="",X=0,ne=-1,se=0,Q,ge=0;ge<=_e.length;++ge){if(ge<_e.length)Q=_e.charCodeAt(ge);else{if(Q===47)break;Q=47}if(Q===47){if(!(ne===ge-1||se===1))if(ne!==ge-1&&se===2){if(U.length<2||X!==2||U.charCodeAt(U.length-1)!==46||U.charCodeAt(U.length-2)!==46){if(U.length>2){var ke=U.lastIndexOf("/");if(ke!==U.length-1){ke===-1?(U="",X=0):(U=U.slice(0,ke),X=U.length-1-U.lastIndexOf("/")),ne=ge,se=0;continue}}else if(U.length===2||U.length===1){U="",X=0,ne=ge,se=0;continue}}W&&(U.length>0?U+="/..":U="..",X=2)}else U.length>0?U+="/"+_e.slice(ne+1,ge):U=_e.slice(ne+1,ge),X=ge-ne-1;ne=ge,se=0}else Q===46&&se!==-1?++se:se=-1}return U}function qt(_e,W){var U=W.dir||W.root,X=W.base||(W.name||"")+(W.ext||"");return U?U===W.root?U+X:U+_e+X:X}var rt={resolve:function(){for(var W="",U=!1,X,ne=arguments.length-1;ne>=-1&&!U;ne--){var se;ne>=0?se=arguments[ne]:(X===void 0&&(X=process.cwd()),se=X),fe(se),se.length!==0&&(W=se+"/"+W,U=se.charCodeAt(0)===47)}return W=H(W,!U),U?W.length>0?"/"+W:"/":W.length>0?W:"."},normalize:function(W){if(fe(W),W.length===0)return".";var U=W.charCodeAt(0)===47,X=W.charCodeAt(W.length-1)===47;return W=H(W,!U),W.length===0&&!U&&(W="."),W.length>0&&X&&(W+="/"),U?"/"+W:W},isAbsolute:function(W){return fe(W),W.length>0&&W.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var W,U=0;U<arguments.length;++U){var X=arguments[U];fe(X),X.length>0&&(W===void 0?W=X:W+="/"+X)}return W===void 0?".":rt.normalize(W)},relative:function(W,U){if(fe(W),fe(U),W===U||(W=rt.resolve(W),U=rt.resolve(U),W===U))return"";for(var X=1;X<W.length&&W.charCodeAt(X)===47;++X);for(var ne=W.length,se=ne-X,Q=1;Q<U.length&&U.charCodeAt(Q)===47;++Q);for(var ge=U.length,ke=ge-Q,Xe=se<ke?se:ke,Ue=-1,He=0;He<=Xe;++He){if(He===Xe){if(ke>Xe){if(U.charCodeAt(Q+He)===47)return U.slice(Q+He+1);if(He===0)return U.slice(Q+He)}else se>Xe&&(W.charCodeAt(X+He)===47?Ue=He:He===0&&(Ue=0));break}var Zt=W.charCodeAt(X+He),ct=U.charCodeAt(Q+He);if(Zt!==ct)break;Zt===47&&(Ue=He)}var g="";for(He=X+Ue+1;He<=ne;++He)(He===ne||W.charCodeAt(He)===47)&&(g.length===0?g+="..":g+="/..");return g.length>0?g+U.slice(Q+Ue):(Q+=Ue,U.charCodeAt(Q)===47&&++Q,U.slice(Q))},_makeLong:function(W){return W},dirname:function(W){if(fe(W),W.length===0)return".";for(var U=W.charCodeAt(0),X=U===47,ne=-1,se=!0,Q=W.length-1;Q>=1;--Q)if(U=W.charCodeAt(Q),U===47){if(!se){ne=Q;break}}else se=!1;return ne===-1?X?"/":".":X&&ne===1?"//":W.slice(0,ne)},basename:function(W,U){if(U!==void 0&&typeof U!="string")throw new TypeError('"ext" argument must be a string');fe(W);var X=0,ne=-1,se=!0,Q;if(U!==void 0&&U.length>0&&U.length<=W.length){if(U.length===W.length&&U===W)return"";var ge=U.length-1,ke=-1;for(Q=W.length-1;Q>=0;--Q){var Xe=W.charCodeAt(Q);if(Xe===47){if(!se){X=Q+1;break}}else ke===-1&&(se=!1,ke=Q+1),ge>=0&&(Xe===U.charCodeAt(ge)?--ge===-1&&(ne=Q):(ge=-1,ne=ke))}return X===ne?ne=ke:ne===-1&&(ne=W.length),W.slice(X,ne)}else{for(Q=W.length-1;Q>=0;--Q)if(W.charCodeAt(Q)===47){if(!se){X=Q+1;break}}else ne===-1&&(se=!1,ne=Q+1);return ne===-1?"":W.slice(X,ne)}},extname:function(W){fe(W);for(var U=-1,X=0,ne=-1,se=!0,Q=0,ge=W.length-1;ge>=0;--ge){var ke=W.charCodeAt(ge);if(ke===47){if(!se){X=ge+1;break}continue}ne===-1&&(se=!1,ne=ge+1),ke===46?U===-1?U=ge:Q!==1&&(Q=1):U!==-1&&(Q=-1)}return U===-1||ne===-1||Q===0||Q===1&&U===ne-1&&U===X+1?"":W.slice(U,ne)},format:function(W){if(W===null||typeof W!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof W);return qt("/",W)},parse:function(W){fe(W);var U={root:"",dir:"",base:"",ext:"",name:""};if(W.length===0)return U;var X=W.charCodeAt(0),ne=X===47,se;ne?(U.root="/",se=1):se=0;for(var Q=-1,ge=0,ke=-1,Xe=!0,Ue=W.length-1,He=0;Ue>=se;--Ue){if(X=W.charCodeAt(Ue),X===47){if(!Xe){ge=Ue+1;break}continue}ke===-1&&(Xe=!1,ke=Ue+1),X===46?Q===-1?Q=Ue:He!==1&&(He=1):Q!==-1&&(He=-1)}return Q===-1||ke===-1||He===0||He===1&&Q===ke-1&&Q===ge+1?ke!==-1&&(ge===0&&ne?U.base=U.name=W.slice(1,ke):U.base=U.name=W.slice(ge,ke)):(ge===0&&ne?(U.name=W.slice(1,Q),U.base=W.slice(1,ke)):(U.name=W.slice(ge,Q),U.base=W.slice(ge,ke)),U.ext=W.slice(Q,ke)),ge>0?U.dir=W.slice(0,ge-1):ne&&(U.dir="/"),U},sep:"/",delimiter:":",win32:null,posix:null};rt.posix=rt,We.exports=rt}},gs={};function Mt(We){var fe=gs[We];if(fe!==void 0)return fe.exports;var H=gs[We]={exports:{}};return tr[We].call(H.exports,H,H.exports,Mt),H.exports}Mt.n=We=>{var fe=We&&We.__esModule?()=>We.default:()=>We;return Mt.d(fe,{a:fe}),fe},Mt.d=(We,fe)=>{for(var H in fe)Mt.o(fe,H)&&!Mt.o(We,H)&&Object.defineProperty(We,H,{enumerable:!0,get:fe[H]})},Mt.o=(We,fe)=>Object.prototype.hasOwnProperty.call(We,fe);var fu={};(()=>{"use strict";const We=(t,e)=>{if(document.getElementById(e))return!1;const n=new XMLHttpRequest;n.open("GET",t,!1),n.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),n.send("");const a=document.createElement("script");a.type="text/javascript",a.text=n.responseText,a.id=e,document.head.appendChild(a)},fe=(t,e)=>new Promise(n=>{if(document.getElementById(e))return n(!1),!1;const a=document.createElement("script");a.src=t,a.async=!0,document.head.appendChild(a),a.onload=()=>{if(document.getElementById(e))return a.remove(),n(!1),!1;a.id=e,n(!0)}}),H=()=>!!document.getElementById("sidebar"),qt=()=>["docker","ios","android"].includes(window.siyuan.config.system.container)?window.siyuan.config.system.container:window.siyuan.config.system.os,rt=()=>window.navigator.userAgent.startsWith("SiYuan/")?"mobile":"browser-mobile",_e=()=>!document.getElementById("toolbar"),W=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,U=(t,e)=>t.length===e.length&&t.every(n=>e.includes(n)),X=(t,e)=>Math.floor(Math.random()*(e-t+1))+t,ne=(t,e=window.location.search)=>{const n=e.substring(e.indexOf("?")),a=n.indexOf("#");return new URLSearchParams(n.substring(0,a>=0?a:void 0)).get(t)},se=()=>!0,Q=t=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(t),ge=t=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(t),ke=t=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(t),Xe=t=>Function(`"use strict";return (${t})`)(),Ue=(t,e)=>{if(t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e))return!0;if(t instanceof Date&&e instanceof Date)return t.getTime()===e.getTime();if(!t||!e||typeof t!="object"&&typeof e!="object")return t===e;if(t.prototype!==e.prototype)return!1;const n=Object.keys(t);return n.length!==Object.keys(e).length?!1:n.every(a=>Ue(t[a],e[a]))},He="2.10.11",Zt="production",ct=class{};let g=ct;g.SIYUAN_VERSION=He,g.NODE_ENV=Zt,g.SIYUAN_APPID=Math.random().toString(36).substring(8),g.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",g.PROTYLE_CDN="/stage/protyle",g.UPLOAD_ADDRESS="/upload",g.SERVICE_WORKER_PATH="/service-worker.js",g.SIYUAN_DROP_FILE="application/siyuan-file",g.SIYUAN_DROP_GUTTER="application/siyuan-gutter",g.SIYUAN_DROP_TAB="application/siyuan-tab",g.SIYUAN_DROP_EDITOR="application/siyuan-editor",g.SIYUAN_CMD="siyuan-cmd",g.SIYUAN_GET="siyuan-get",g.SIYUAN_EVENT="siyuan-event",g.SIYUAN_CONFIG_TRAY="siyuan-config-tray",g.SIYUAN_QUIT="siyuan-quit",g.SIYUAN_HOTKEY="siyuan-hotkey",g.SIYUAN_INIT="siyuan-init",g.SIYUAN_SEND_WINDOWS="siyuan-send-windows",g.SIYUAN_SAVE_CLOSE="siyuan-save-close",g.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",g.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",g.SIYUAN_OPEN_URL="siyuan-open-url",g.SIYUAN_OPEN_WINDOW="siyuan-open-window",g.SIYUAN_OPEN_FOLDER="siyuan-open-folder",g.SIYUAN_OPEN_FILE="siyuan-open-file",g.SIYUAN_EXPORT_PDF="siyuan-export-pdf",g.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",g.CUSTOM_SY_READONLY="custom-sy-readonly",g.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",g.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",g.CUSTOM_RIFF_DECKS="custom-riff-decks",g.SIZE_LINK_TEXT_MAX=24,g.SIZE_TOOLBAR_HEIGHT=H()?0:32,g.SIZE_GET_MAX=102400,g.SIZE_UNDO=64,g.SIZE_TITLE=512,g.SIZE_EDITOR_WIDTH=760,g.SIZE_ZOOM=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3],g.CB_MOVE_NOLIST="cb-move-nolist",g.CB_MOUNT_REMOVE="cb-mount-remove",g.CB_GET_APPEND="cb-get-append",g.CB_GET_BEFORE="cb-get-before",g.CB_GET_UNCHANGEID="cb-get-unchangeid",g.CB_GET_HL="cb-get-hl",g.CB_GET_FOCUS="cb-get-focus",g.CB_GET_FOCUSFIRST="cb-get-focusfirst",g.CB_GET_SETID="cb-get-setid",g.CB_GET_ALL="cb-get-all",g.CB_GET_BACKLINK="cb-get-backlink",g.CB_GET_UNUNDO="cb-get-unundo",g.CB_GET_SCROLL="cb-get-scroll",g.CB_GET_CONTEXT="cb-get-context",g.CB_GET_ROOTSCROLL="cb-get-rootscroll",g.CB_GET_HTML="cb-get-html",g.CB_GET_HISTORY="cb-get-history",g.LOCAL_ZOOM="local-zoom",g.LOCAL_SEARCHDATA="local-searchdata",g.LOCAL_SEARCHKEYS="local-searchkeys",g.LOCAL_SEARCHASSET="local-searchasset",g.LOCAL_DOCINFO="local-docinfo",g.LOCAL_DAILYNOTEID="local-dailynoteid",g.LOCAL_HISTORYNOTEID="local-historynoteid",g.LOCAL_CODELANG="local-codelang",g.LOCAL_FONTSTYLES="local-fontstyles",g.LOCAL_EXPORTPDF="local-exportpdf",g.LOCAL_EXPORTWORD="local-exportword",g.LOCAL_EXPORTIMG="local-exportimg",g.LOCAL_BAZAAR="local-bazaar",g.LOCAL_PDFTHEME="local-pdftheme",g.LOCAL_LAYOUTS="local-layouts",g.LOCAL_AI="local-ai",g.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",g.TIMEOUT_DBLCLICK=190,g.TIMEOUT_INPUT=256,g.TIMEOUT_LOAD=300,g.TIMEOUT_TRANSITION=300,g.TIMEOUT_COUNT=1e3,g.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr"},g.QUICK_DECK_ID="20230218211946-2kw8jgx",g.KEYCODELIST={8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2318",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},g.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:"\u23251",custom:"\u23251"},outline:{default:"\u23252",custom:"\u23252"},bookmark:{default:"\u23253",custom:"\u23253"},tag:{default:"\u23254",custom:"\u23254"},dailyNote:{default:"\u23255",custom:"\u23255"},inbox:{default:"\u23256",custom:"\u23256"},backlinks:{default:"\u23257",custom:"\u23257"},graphView:{default:"\u23258",custom:"\u23258"},globalGraph:{default:"\u23259",custom:"\u23259"},riffCard:{default:"\u23250",custom:"\u23250"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},g.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:227,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:227,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:227,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:227,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},g.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,g.SIYUAN_IMAGE_FILE="1f4c4",g.SIYUAN_IMAGE_NOTE="1f5c3",g.SIYUAN_IMAGE_FOLDER="1f4d1",g.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],g.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a"],g.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],g.SIYUAN_ASSETS_EXTS=[".pdf"].concat(ct.SIYUAN_ASSETS_IMAGE).concat(ct.SIYUAN_ASSETS_AUDIO).concat(ct.SIYUAN_ASSETS_VIDEO),g.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],g.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],g.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],g.ZWSP="\u200B",g.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo"],g.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],g.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},g.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],g.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig";const Je=(t,e)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("b3-typography");)n.nodeName.indexOf(e)===0?a=!0:n=n.parentElement;return a&&n},tt=(t,e,n=!1)=>{let a=N(t,e,n),i=!1,s=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!s;)i=N(a.parentElement,e,n),i?a=i:s=!0;return a||!1},wt=(t,e)=>{let n=Je(t,e),a=!1,i=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!i;)a=Je(n.parentElement,e),a?n=a:i=!0;return n||!1},Ht=(t,e,n,a=!1)=>{let i=A(t,e,n,a),s=!1,l=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!l;)s=A(i.parentElement,e,n,a),s?i=s:l=!0;return i||!1},A=(t,e,n,a=!1)=>{var i;if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let s=t,l=!1;for(;s&&!l&&(a?s.tagName!=="BODY":!s.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&((i=s.getAttribute(e))!=null&&i.split(" ").includes(n))||typeof n!="string"&&s.hasAttribute(e)?l=!0:s=s.parentElement;return l&&s},I=t=>{var e;const n=A(t,"data-node-id",null);return n&&n.tagName!=="BUTTON"&&((e=n.getAttribute("data-type"))!=null&&e.startsWith("Node"))?n:!1},R=(t,e)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===e?a=!0:n=n.parentElement;return a&&n},N=(t,e,n=!1)=>{var a;if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let i=t,s=!1;for(;i&&!s&&(n?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)(a=i.classList)!=null&&a.contains(e)?s=!0:i=i.parentElement;return s&&i},ie=t=>{let e=t;for(;e;){if(e.previousElementSibling&&e.previousElementSibling.getAttribute("data-node-id"))return e.previousElementSibling;const n=I(e.parentElement);if(n)e=n;else return!1}},G=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!A(n.parentElement,"data-type","NodeBlockQueryEmbed"))return e=n,!0}),e||t},V=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).find(n=>{if(!A(n.parentElement,"data-type","NodeBlockQueryEmbed")&&!n.classList.contains("li")&&!n.classList.contains("sb"))return e=n,!0}),e||t},B=t=>{let e=t;for(;e;){if(e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr"))return e.nextElementSibling;const n=I(e.parentElement);if(n)e=n;else return!1}return!1},M=t=>{let e=t;for(;e;)if(e.classList.contains("list")||e.classList.contains("li")||e.classList.contains("bq")||e.classList.contains("sb"))e=e.querySelector("[data-node-id]");else return e;return!1},$=t=>!t||t.getAttribute("contenteditable")==="true"&&!t.classList.contains("protyle-wysiwyg")?t:t.querySelector('[contenteditable="true"]'),q=t=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(t.getAttribute("data-type"))||t.getAttribute("data-type")==="NodeCodeBlock"&&t.classList.contains("render-node"),Me=t=>{var e,n;let a=t;for(;a.parentElement&&!a.parentElement.classList.contains("protyle-wysiwyg");)if(!a.parentElement.getAttribute("data-node-id"))a=a.parentElement;else{let i=!1;if(Array.from(a.parentElement.querySelectorAll('[contenteditable="true"]')).find(s=>{if(s.textContent.replace(g.ZWSP,"").replace(`
`,"")!=="")return i=!0,!0}),i||(e=a.previousElementSibling)!=null&&e.getAttribute("data-node-id")||(n=a.nextElementSibling)!=null&&n.getAttribute("data-node-id"))break;a=a.parentElement}return a},he=t=>{if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=he(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=he(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=he(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else{t=he(t);break}return t},Ee=t=>{let e=t.nextSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.nextSibling;else return e;return!1},xe=t=>{let e=t.previousSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.previousSibling;else return e;return!1},Xt=t=>{let e=t.nextElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.firstElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.nextElementSibling)e=e.parentElement;else{if(e.nextElementSibling.tagName==="LI")return e.nextElementSibling;if(e.nextElementSibling.tagName==="UL")return e.nextElementSibling.firstElementChild}return!1},Ot=t=>{let e=t.previousElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.lastElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.previousElementSibling)e=e.parentElement;else{if(e.previousElementSibling.tagName==="LI")return e.previousElementSibling;if(e.previousElementSibling.tagName==="UL"){const n=e.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},Pn=(t=!1)=>{};let En,gn;const Ge=(t,e)=>{},Fe=(t,e,n=!1)=>{},Pa=()=>{En="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(gn)},la=t=>{if(!t)return;let e=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${t.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${t.wordCount}<span class="fn__space"></span>`;0<t.linkCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${t.linkCount}<span class="fn__space"></span>`),0<t.imageCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${t.imageCount}<span class="fn__space"></span>`),0<t.refCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${t.refCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=e},Y=(t,e,n=!1)=>{if(!e){if(t.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(t.includes("hint")&&(clearTimeout(e.hint.timeId),e.hint.element.classList.add("fn__none")),e.gutter&&t.includes("gutter")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML="",e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),e.toolbar&&t.includes("toolbar")&&(e.toolbar.element.classList.add("fn__none"),e.toolbar.element.style.display=""),e.toolbar&&t.includes("util")){const a=e.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&!a.classList.contains("block__icon--active"))&&(e.toolbar.subElement.classList.add("fn__none"),e.toolbar.subElementCloseCB&&(e.toolbar.subElementCloseCB(),e.toolbar.subElementCloseCB=void 0))}t.includes("select")&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},nr=t=>{if(t.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(e=>{e.classList.add("fn__none"),e.style.display=""}),t.includes("util")){const e=St();e.protyle.toolbar.subElement.classList.add("fn__none"),e.protyle.toolbar.subElementCloseCB&&(e.protyle.toolbar.subElementCloseCB(),e.protyle.toolbar.subElementCloseCB=void 0)}t.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(e=>{e.classList.add("fn__none")}),t.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(e=>{e.classList.add("fn__none"),e.innerHTML=""})},ar=(t,e)=>{if(!e){if(getSelection().rangeCount===0)return!1;e=getSelection().getRangeAt(0)}const n=e.commonAncestorContainer;return t.isEqualNode(n)||t.contains(n)},gi=t=>{const e=A(t.startContainer,"data-type","NodeTable");if(t.toString()!==""&&e&&t.commonAncestorContainer.nodeType!==3){const n=t.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=R(t.startContainer,"TD")||R(t.startContainer,"TH"),i=R(t.endContainer,"TD")||R(t.endContainer,"TH");if(!a&&!i){const s=e.querySelector("th")||e.querySelector("td");t.setStart(s.firstChild,0),t.setEnd(s.lastChild,s.lastChild.textContent.length)}else a&&!a.contains(t.endContainer)&&ot(a,t,!1)}}},Ba=(t,e,n)=>{const a=$(e);if(a){let l;if(a.tagName==="TABLE"){const o=R(n.startContainer,"TD")||R(n.startContainer,"TH");if(o&&(l=Qe(o,e,n),l.start!==0||l.end!==o.textContent.length))return n.setStart(o.firstChild,0),n.setEndAfter(o.lastChild),t.toolbar.render(t,n),Ge(n,t.block.rootID),!0}else if(l=Qe(a,e,n),l.start!==0||l.end!==a.textContent.length){let o=a.firstChild;for(;o;)if(o.nodeType===3){if(o.textContent!==""){n.setStart(o,0);break}o=o.nextSibling}else{if(o.classList.contains("render-node")||o.classList.contains("img")){n.setStartBefore(o);break}o=o.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return z(n),t.toolbar.render(t,n),Ge(n,t.block.rootID),!0}}n.collapse(!0);const i=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.wysiwyg.element.childElementCount===i.length&&i[0].parentElement.isSameNode(t.wysiwyg.element))return!0;Y(["select"],t);const s=[];Array.from(t.wysiwyg.element.children).forEach(l=>{l.classList.add("protyle-wysiwyg--select"),s.push(l.getAttribute("data-node-id"))}),Fe(s,t.block.rootID)},pi=(t,e)=>{const n=document.caretRangeFromPoint(t,e),a=A(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},de=t=>{let e;if(getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0),t.isSameNode(e.startContainer)||t.contains(e.startContainer)))return e;t.focus({preventScroll:!0});let n;return t.classList.contains("table")?n=t.querySelector("th")||t.querySelector("td"):(n=$(t),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||t.querySelector("td")):n=t),e=n.ownerDocument.createRange(),e.setStart(n||t,0),e.collapse(!0),e},Rt=(t,e)=>{var n,a;if(e||(e=de(t)),!t.contains(e.startContainer))return{left:0,top:0};let i;if(e.getClientRects().length===0)if(e.startContainer.nodeType===3){const s=(n=e.startContainer.parentElement)==null?void 0:n.getClientRects(),l=(a=e.startContainer.previousElementSibling)==null?void 0:a.getClientRects();if(s.length>0||l.length>0)s.length===0||l&&l.length>0&&s[0].top<l[l.length-1].bottom?i={left:l[l.length-1].left,top:l[l.length-1].bottom}:i=s[0];else return{left:0,top:0}}else{const s=e.startContainer.children;if(s[e.startOffset]&&s[e.startOffset].getClientRects().length>0)i=s[e.startOffset].getClientRects()[0];else if(e.startContainer.childNodes.length>0){const l=e.cloneRange();e.selectNode(e.startContainer.childNodes[Math.max(0,e.startOffset-1)]),i=e.getClientRects()[0],e.setEnd(l.endContainer,l.endOffset),e.setStart(l.startContainer,l.startOffset)}else i=e.startContainer.getClientRects()[0];if(!i){let l=e.startContainer.childNodes[e.startOffset];if(l||(l=e.startContainer.childNodes[e.startOffset-1]),!l)i=e.getBoundingClientRect();else{for(;!l.getClientRects||l.getClientRects&&l.getClientRects().length===0;)l=l.parentElement;i=l.getClientRects()[0]}}}else{const s=e.getClientRects();return{left:s[s.length-1].left,top:s[0].top}}return{left:i.left,top:i.top}},Qe=(t,e,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(e&&!ar(e,n))return a;const i=n.cloneRange();return t.childNodes[0]&&t.childNodes[0].childNodes[0]?i.setStart(t.childNodes[0].childNodes[0],0):i.selectNodeContents(t),i.setEnd(n.startContainer,n.startOffset),a.start=i.toString().length,a.end=a.start+n.toString().length,a};function qa(t,e,n,a){if(!e)return!1;if(n(e))return!0;for(let i=0,s=e.childNodes.length;i<s;i++)if(qa(e,e.childNodes[i],n,!0))return!0;if(!a){let i=e;for(;i&&i!==t;){let s=i.nextSibling;for(;s;){if(qa(t,s,n,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const ot=(t,e,n=!0)=>{if(!t)return e;let a=t.lastChild;for(;a&&a.nodeType!==3;)a=a.lastChild;return a?(n?e.setStart(a,a.textContent.length):e.setEnd(a,a.textContent.length),e):(e.selectNodeContents(t),e)},Oa=(t,e)=>{if(!t)return e;let n=t.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return e.setStartBefore(n),e;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?e.setStartBefore(n):e.setStart(n,0),e):(e.selectNodeContents(t),e)},ps=(t,e,n)=>{if(!t)return!1;const a=$(t);if(a)t=a;else if(q(t)||t.classList.contains("av"))return ce(t);let i;qa(t,t.firstChild,o=>{if(o.nodeType===Node.TEXT_NODE){const r=o.data.length;return e<=r?(i=o,!0):(e-=r,n-=r,!1)}});let s;i&&qa(t,i,o=>{if(o.nodeType===Node.TEXT_NODE){const r=o.data.length;return n<=r?(s=o,!0):(n-=r,!1)}});const l=document.createRange();return i?e<i.data.length?l.setStart(i,e):l.setStartAfter(i):e===0?l.setStart(t,0):ot($(t),l),s?n<s.data.length?l.setEnd(s,n):l.setEndAfter(s):n===0?l.setEnd(t,0):ot($(t),l,!1),z(l),l},re=(t,e)=>{var n;const a=t.querySelectorAll("wbr");if(a.length===0)return;a.forEach((s,l)=>{l!==0&&s.remove()});const i=a[0];if(!i.previousElementSibling)i.previousSibling?e.setStart(i.previousSibling,i.previousSibling.textContent.length):i.nextSibling?i.nextSibling.nodeType===3?e.setStart(i.nextSibling,0):e.setStartAfter(i):e.setStart(i.parentElement,0);else{const s=xe(i);s&&i.previousElementSibling.isSameNode(s)?((n=i.previousElementSibling.lastChild)==null?void 0:n.nodeType)===3?e.setStart(i.previousElementSibling.lastChild,i.previousElementSibling.lastChild.textContent.length):s.nodeType!==3&&s.classList.contains("img")?e.setStartAfter(s):e.setStartBefore(i):e.setStart(i.previousSibling,i.previousSibling.textContent.length)}e.collapse(!0),i.remove(),z(e)},z=t=>{if(!t)return;const e=window.getSelection();e.removeAllRanges(),e.addRange(t)},ce=(t,e,n=!0)=>{var a,i,s;if(!t)return!1;if(t.classList.contains("render-node")||t.classList.contains("iframe")||t.classList.contains("hr")){const o=document.createRange(),r=t.getAttribute("data-type");let c=!1;return r==="NodeThematicBreak"?(o.selectNodeContents(t.firstElementChild),c=!0):r==="NodeBlockQueryEmbed"?((a=t.lastElementChild.previousElementSibling)!=null&&a.firstChild?(o.selectNodeContents(t.lastElementChild.previousElementSibling.firstChild),o.collapse(!0)):(o.selectNodeContents(t),o.collapse(!0)),c=!0):["NodeMathBlock","NodeHTMLBlock"].includes(r)?((s=(i=t.lastElementChild.previousElementSibling)==null?void 0:i.lastElementChild)!=null&&s.firstChild?(o.selectNodeContents(t.lastElementChild.previousElementSibling.lastElementChild.firstChild),o.collapse(!0)):t.lastElementChild.previousElementSibling&&(o.selectNodeContents(t.lastElementChild.previousElementSibling),o.collapse(!0)),c=!0):r==="NodeIFrame"||r==="NodeWidget"?(o.setStart(t,0),c=!0):r==="NodeVideo"?(o.setStart(t.firstElementChild,0),c=!0):r==="NodeAudio"?(o.setStart(t.firstElementChild.lastChild,0),c=!0):r==="NodeCodeBlock"&&(o.selectNodeContents(t),o.collapse(!0),c=!0),c?(z(o),o):(Ra(t),!1)}else if(t.classList.contains("av")){const o=t.querySelector(".av__title");if(o){const r=document.createRange();return r.selectNodeContents(o),r.collapse(),z(r),r}else return!1}let l;if(n?l=$(t):Array.from(t.querySelectorAll('[contenteditable="true"]')).reverse().find(o=>{if(o.getBoundingClientRect().width>0)return l=o,!0}),l){if(l.tagName==="TABLE")if(n)l=l.querySelector("th, td");else{const r=l.querySelectorAll("th, td");l=r[r.length-1]}let o;if(n)o=Oa(l,de(l)),o.collapse(!0);else{let r=!1;if(l.classList.contains("hljs")){let c=l.lastChild;c.textContent===""&&c.nodeType===3&&(c=xe(l.lastChild)),c&&c.textContent.endsWith(`
`)&&(o=de(l),o.setStart(c,c.textContent.length-1),r=!0)}r||(o=ot(l,de(l))),o.collapse(!1)}return z(o),o}else e&&e.focus();return!1},Ra=t=>{if(t.getAttribute("data-node-id")){let n,a;t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=B(t)):t.previousElementSibling&&(a=!1,n=ie(t)),n||(n=t),ce(n,void 0,a);return}const e=de(t);t.nextSibling?(e.selectNodeContents(t.nextSibling),e.collapse(!0)):t.previousSibling&&(e.selectNodeContents(t.previousSibling),e.collapse(!1)),z(e)},Bn=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(parseInt(t,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(t,10)/4).toString(16)),ir=()=>{const t=document.getElementById("message");t.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button--cancel b3-button b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.clearMessage}"><svg style="margin-right: 0"><use xlink:href="#iconSelect"></use></svg></button>`,t.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(t);){if(n.classList.contains("b3-snackbar__close")){je(n.parentElement.getAttribute("data-id")),e.preventDefault();break}else if(n.isSameNode(t.lastElementChild)){n.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{n.parentElement.firstElementChild.innerHTML=""},g.TIMEOUT_INPUT),e.preventDefault();break}else{if(n.tagName==="A"||n.tagName==="BUTTON")break;if(n.classList.contains("b3-snackbar")){je(n.getAttribute("data-id")),e.preventDefault(),e.stopPropagation();break}}n=n.parentElement}})},oe=(t,e=6e3,n="info",a)=>{const i=document.getElementById("message").firstElementChild;if(!i){alert(t);return}const s=a||Bn(),l=i.querySelector(`.b3-snackbar[data-id="${s}"]`),o=t+(n==="error"?" v"+g.SIYUAN_VERSION:"");if(l){if(window.clearTimeout(parseInt(l.getAttribute("data-timeoutid"))),l.innerHTML=`<div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${o}</div>${e===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?l.classList.add("b3-snackbar--error"):l.classList.remove("b3-snackbar--error"),e>0){const c=window.setTimeout(()=>{je(s)},e);l.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${o}</div>`;if(e===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(e!==-1){const c=window.setTimeout(()=>{je(s)},e);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},je=t=>{const e=document.getElementById("message").firstElementChild;if(e)if(t){const n=e.querySelector(`[data-id="${t}"]`);n&&(n.classList.add("b3-snackbar--hide"),setTimeout(()=>{n.remove(),e.childElementCount===0&&je()},g.TIMEOUT_INPUT));let a=!1;Array.from(e.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?e.parentElement.classList.add("b3-snackbars--show"):e.parentElement.classList.remove("b3-snackbars--show")}else e.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{e.innerHTML=""},g.TIMEOUT_INPUT)},mi=t=>{if(t.cmd==="msg")return oe(t.msg,t.data.closeTimeout,t.code===0?"info":"error",t.data.id),!1;if(t.cmd==="cmsg")return je(t.data.id),!1;if(t.cmd==="cprogress"){const e=document.getElementById("progress");return e&&e.remove(),!1}return t.cmd==="reloadui"?(window.location.reload(),!1):t.code<0?(oe(t.msg,t.data&&t.data.closeTimeout||0,t.code===-1?"error":"info"),!1):t};var sr=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Nt=t=>{t&&(window.siyuan.config.system.container==="ios"?window.location.href=t:yt()?window.JSAndroid.openExternal(t):window.open(t))},Fa=()=>yt()?window.JSAndroid.readClipboard():navigator.clipboard.readText(),Pe=t=>{let e;getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0).cloneRange());try{if(yt()){window.JSAndroid.writeClipboard(t);return}if(Pt()){window.webkit.messageHandlers.setClipboard.postMessage(t);return}navigator.clipboard.writeText(t)}catch(n){if(Pt())window.webkit.messageHandlers.setClipboard.postMessage(t);else if(yt())window.JSAndroid.writeClipboard(t);else{const a=document.createElement("textarea");a.value=t,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),e&&z(e)}}},Ua=t=>sr(void 0,null,function*(){t=t.replace(new RegExp(g.ZWSP,"g"),""),yield Pe(t)}),qn=()=>Wa()?"touchstart":"click",Ce=t=>Ya()?!!(t.metaKey&&!t.ctrlKey):!!(!t.metaKey&&t.ctrlKey),lr=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,Wa=()=>navigator.userAgent.indexOf("iPhone")>-1,ms=()=>navigator.userAgent.indexOf("iPad")>-1,Ya=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,yt=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Pt=()=>{var t;return window.siyuan.config.system.container==="ios"&&((t=window.webkit)==null?void 0:t.messageHandlers)},De=t=>{if(/Mac/.test(navigator.platform)||navigator.platform==="iPhone")return t;const e=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];t.indexOf("\u2318")>-1&&n.push(e.get("\u2318")),t.indexOf("\u21E7")>-1&&n.push(e.get("\u21E7")),t.indexOf("\u2325")>-1&&n.push(e.get("\u2325"));const a=t.replace(/⌘|⇧|⌥/g,"");return a&&n.push(e.get(a)||a),n.join("+")},or=t=>{_("/api/storage/getLocalStorage",void 0,e=>{window.siyuan.storage=e.data;const n={};n[g.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},g.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[g.LOCAL_SEARCHASSET].types[a]=!0}),n[g.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[g.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[g.LOCAL_LAYOUTS]=[],n[g.LOCAL_AI]=[],n[g.LOCAL_PLUGINTOPUNPIN]=[],n[g.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[g.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[g.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1},n[g.LOCAL_EXPORTIMG]={keepFold:!1},n[g.LOCAL_DOCINFO]={id:""},n[g.LOCAL_FONTSTYLES]=[],n[g.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock}},n[g.LOCAL_ZOOM]=1,[g.LOCAL_EXPORTIMG,g.LOCAL_SEARCHKEYS,g.LOCAL_PDFTHEME,g.LOCAL_BAZAAR,g.LOCAL_EXPORTWORD,g.LOCAL_EXPORTPDF,g.LOCAL_DOCINFO,g.LOCAL_FONTSTYLES,g.LOCAL_SEARCHDATA,g.LOCAL_ZOOM,g.LOCAL_LAYOUTS,g.LOCAL_AI,g.LOCAL_PLUGINTOPUNPIN,g.LOCAL_SEARCHASSET].forEach(a=>{if(typeof e.data[a]=="string")try{const i=JSON.parse(e.data[a]);typeof i=="number"?window.siyuan.storage[a]=i:window.siyuan.storage[a]=Object.assign(n[a],i)}catch(i){window.siyuan.storage[a]=n[a]}else typeof e.data[a]=="undefined"&&(window.siyuan.storage[a]=n[a])}),t(),_("/api/storage/removeLocalStorageVals",{app:g.SIYUAN_APPID,keys:["leftColumn","local-searchkey","local-searchedata","local-searchekeys","local-searchetabdata","rightColumn","topBar"]})})},et=(t,e)=>{_("/api/storage/setLocalStorageVal",{app:g.SIYUAN_APPID,key:t,val:e})};class be{constructor(e){this.disableClose=e.disableClose,this.id=Bn(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div"),this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};">
<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container" style="width:${e.width||"auto"};height:${e.height||"auto"}">
  <svg ${H()&&e.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||e.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>
  <div class="b3-dialog__body">${e.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",n=>{this.disableClose||this.destroy(),n.preventDefault(),n.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",n=>{this.destroy(),n.preventDefault(),n.stopPropagation()}),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")})}destroy(e){this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(e),window.siyuan.dialogs.find((n,a)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(a,1),!0})}bindInput(e,n){e.focus(),e.addEventListener("keydown",a=>{if(a.isComposing){a.preventDefault();return}const i=document.querySelector("#confirmDialogConfirmBtn");if(a.key==="Escape"){i?i.previousElementSibling.previousElementSibling.dispatchEvent(new CustomEvent("click")):this.destroy(),a.preventDefault(),a.stopPropagation();return}!a.shiftKey&&!Ce(a)&&a.key==="Enter"&&n&&(i?i.dispatchEvent(new CustomEvent("click")):n(),a.preventDefault(),a.stopPropagation())})}}const Te=(t,e,n,a)=>{const i=new be({title:t,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{a&&a(i),i.destroy()}),s[1].addEventListener("click",()=>{n&&n(i),i.destroy()})},$e=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;"),bs=t=>t.replace(/</g,"&lt;"),On=t=>t.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),ja=t=>t.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;"),hs=t=>{const e=new be({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${t}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()});const a=e.element.querySelector("input");e.bindInput(a,()=>{n[1].click()}),a.focus(),a.select(),n[1].addEventListener("click",()=>{_("/api/tag/renameTag",{oldLabel:t,newLabel:a.value})})},rr=()=>window.siyuan.config.system.workspaceDir.replace(/^.*[\\\/]/,""),gu=()=>{},cr=()=>{const t=new be({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),e=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(e,()=>{n[1].click()}),e.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{_("/api/system/setAccessAuthCode",{accessAuthCode:e.value})})},dt=t=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${t}`,oa=(t=window.siyuan.languages.needLogin)=>window.siyuan.user?!1:(t&&oe(t),!0),Qt=(t=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(t&&(t===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?oe(window.siyuan.languages._kernel[122]):(t===window.siyuan.languages._kernel[29]&&(t=window.siyuan.languages._kernel[29].replace("${url}",dt("subscribe/siyuan"))),oe(t))),!0),dr=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1);var bi=Mt(5);const Le=(t,e,n,a=0,i=0)=>{t.style.top=n+"px",t.style.left=e+"px";const s=t.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<g.SIZE_TOOLBAR_HEIGHT){const l=n-s.height-a;l>g.SIZE_TOOLBAR_HEIGHT&&l+s.height<window.innerHeight?t.style.top=l+"px":l<=g.SIZE_TOOLBAR_HEIGHT?t.style.top=g.SIZE_TOOLBAR_HEIGHT+"px":t.style.top=Math.max(g.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?t.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(t.style.left="0")},ws=()=>{const t=window.siyuan.emojis[X(0,window.siyuan.emojis.length-1)];return typeof t.items[X(0,t.items.length-1)]=="undefined"?"1f600":t.items[X(0,t.items.length-1)].unicode},le=(t,e="",n=!1,a=!1)=>{if(!t)return"";let i="";if(t.indexOf(".")>-1)i=`<img class="${e}" ${a?"data-":""}src="/emojis/${t}"/>`;else try{t.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),n&&(i=`<span class="${e}">${i}</span>`)}catch(s){}return i},za=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-index");if((typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(l=>{s+=`<button data-unicode="${l.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?l.description_zh_cn:l.description}">
${le(l.unicode)}</button>`}),a.target.innerHTML=s,a.target.removeAttribute("data-index")}})});t.querySelectorAll(".emojis__content").forEach(n=>{e.observe(n)})},ra=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-src");(typeof a.isIntersecting=="undefined"?a.intersectionRatio!==0:a.isIntersecting)&&i&&(a.target.src=i,a.target.removeAttribute("data-src"))})});t.querySelectorAll("img").forEach(n=>{e.observe(n)})},ca=(t="",e)=>{let n="";const a=[];t&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const l=[];window.siyuan.emojis.forEach((r,c)=>{t||(n+=`<div class="emojis__title" data-type="${c+1}">${window.siyuan.config.lang==="zh_CN"?r.title_zh_cn:r.title}</div><div style="min-height:${c===0?"28px":"336px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!t&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(u=>{if(t){if(window.siyuan.config.editor.emoji.includes(u.unicode)&&(le(u.unicode)===t||u.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||u.description.toLowerCase().indexOf(t.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1)&&a.push(u),e&&i>e)return;(le(u.unicode)===t||u.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||u.description.toLowerCase().indexOf(t.toLowerCase())>-1||u.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1)&&(r.id==="custom"?l.push(u):s+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?u.description_zh_cn:u.description}">
${le(u.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(u.unicode)&&a.push(u),c<2&&(n+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?u.description_zh_cn:u.description}">
${le(u.unicode,void 0,!1,!0)}</button>`)}),t||(n+="</div>")}),t&&(l.sort((r,c)=>{const u=r.keywords.split("/"),d=c.keywords.split("/");return u[u.length-1].toLowerCase().indexOf(t.toLowerCase())<d[d.length-1].toLowerCase().indexOf(t.toLowerCase())?-1:0}).sort((r,c)=>{const u=r.keywords.split("/"),d=c.keywords.split("/");return u[u.length-1].toLowerCase().indexOf(t.toLowerCase())===d[d.length-1].toLowerCase().indexOf(t.toLowerCase())&&u[u.length-1].length<d[d.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?r.description_zh_cn:r.description}">
${le(r.unicode,void 0,!1,!0)}</button>`}),n=n+s+"</div>");let o="";return a.length>0&&(o=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=a.filter(u=>u.unicode===r);c[0]&&(o+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?c[0].description_zh_cn:c[0].description}">
${le(c[0].unicode,void 0,!1,!0)}
</button>`)}),o+="</div>"),o+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:o+n},kn=t=>{window.siyuan.config.editor.emoji.unshift(t),window.siyuan.config.editor.emoji.length>g.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),_("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},hi=(t,e,n,a)=>{e!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i=new be({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:H()?"80vw":"360px",height:"50vh",content:`<div class="emojis">
<div class="fn__flex">
    <span class="fn__space"></span>
    <label class="b3-form__icon fn__flex-1">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
    </label>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    <span class="fn__space"></span>
</div>
<div class="emojis__panel">${ca()}</div>
<div class="fn__flex">
    <div data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${le("2b50")}</div>
    <div data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f527")}</div>
    <div data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f60d")}</div>
    <div data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f433")}</div>
    <div data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f96a")}</div>
    <div data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f3a8")}</div>
    <div data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f3dd")}</div>
    <div data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f52e")}</div>
    <div data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("267e")}</div>
    <div data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f6a9")}</div>
</div>
</div>`});i.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const s=i.element.querySelector(".b3-dialog");s.style.justifyContent="inherit",s.style.alignItems="inherit",Le(i.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),i.element.querySelector(".emojis__item").classList.add("emojis__item--current");const l=i.element.querySelector(".b3-text-field"),o=i.element.querySelector(".emojis__panel");l.addEventListener("compositionend",()=>{var r;o.innerHTML=ca(l.value),l.value?o.nextElementSibling.classList.add("fn__none"):o.nextElementSibling.classList.remove("fn__none"),o.scrollTop=0,(r=i.element.querySelector(".emojis__item"))==null||r.classList.add("emojis__item--current"),l.value===""&&za(i.element),ra(i.element)}),l.addEventListener("input",r=>{var c;r.isComposing||(o.innerHTML=ca(l.value),l.value?o.nextElementSibling.classList.add("fn__none"):o.nextElementSibling.classList.remove("fn__none"),o.scrollTop=0,(c=i.element.querySelector(".emojis__item"))==null||c.classList.add("emojis__item--current"),l.value===""&&za(i.element),ra(i.element))}),l.addEventListener("keydown",r=>{var c,u;if(r.isComposing||r.key.indexOf("Arrow")===-1&&r.key!=="Enter")return;const d=i.element.querySelector(".emojis__item--current");if(!d)return;if(r.key==="Enter"){const p=d.getAttribute("data-unicode");e==="notebook"?_("/api/notebook/setNotebookIcon",{notebook:t,icon:p},()=>{i.destroy(),kn(p),Ln(p,t,"iconFilesRoot")}):e==="doc"?_("/api/attr/setBlockAttrs",{id:t,attrs:{icon:p}},()=>{i.destroy(),kn(p),Ln(p,t),Va(p,t)}):a(p),r.preventDefault(),r.stopPropagation();return}let f;if(r.key==="ArrowLeft"||r.key==="ArrowUp"?d.previousElementSibling?(d.classList.remove("emojis__item--current"),f=d.previousElementSibling,r.preventDefault(),r.stopPropagation()):(c=d.parentElement.previousElementSibling)!=null&&c.previousElementSibling&&(d.classList.remove("emojis__item--current"),f=d.parentElement.previousElementSibling.previousElementSibling.lastElementChild,r.preventDefault(),r.stopPropagation()):(r.key==="ArrowRight"||r.key==="ArrowDown")&&(d.nextElementSibling?(d.classList.remove("emojis__item--current"),f=d.nextElementSibling,r.preventDefault(),r.stopPropagation()):(u=d.parentElement.nextElementSibling)!=null&&u.nextElementSibling&&(d.classList.remove("emojis__item--current"),f=d.parentElement.nextElementSibling.nextElementSibling.firstElementChild,r.preventDefault(),r.stopPropagation())),f){f.classList.add("emojis__item--current");const p=l.clientHeight+6;f.offsetTop-p<o.scrollTop?o.scrollTop=f.offsetTop-p:f.offsetTop-p-o.clientHeight+f.clientHeight>o.scrollTop&&(o.scrollTop=f.offsetTop-p-o.clientHeight+f.clientHeight)}}),H()||l.focus(),za(i.element),ra(i.element),i.element.addEventListener("click",r=>{const c=r.target,u=N(c,"emojis__type");if(u){const p=o.querySelector(`[data-type="${u.getAttribute("data-type")}"]`);if(p){const b=p.nextElementSibling.getAttribute("data-index");if(b){let m="";window.siyuan.emojis[parseInt(b)].items.forEach(h=>{m+=`<button data-unicode="${h.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?h.description_zh_cn:h.description}">
${le(h.unicode)}</button>`}),p.nextElementSibling.innerHTML=m,p.nextElementSibling.removeAttribute("data-index")}o.scrollTo({top:p.offsetTop-34})}return}const d=N(c,"block__icon");if(d&&d.getAttribute("aria-label")===window.siyuan.languages.remove){e==="notebook"?_("/api/notebook/setNotebookIcon",{notebook:t,icon:""},()=>{i.destroy(),Ln("",t,"iconFilesRoot")}):e==="doc"?_("/api/attr/setBlockAttrs",{id:t,attrs:{icon:""}},()=>{i.destroy(),Ln("",t),Va("",t)}):a("");return}const f=N(c,"emojis__item");if(f||d){let p="";f?(p=f.getAttribute("data-unicode"),e!=="av"&&i.destroy()):p=ws(),e==="notebook"?_("/api/notebook/setNotebookIcon",{notebook:t,icon:p},()=>{kn(p),Ln(p,t,"iconFilesRoot")}):e==="doc"?_("/api/attr/setBlockAttrs",{id:t,attrs:{icon:p}},()=>{kn(p),Ln(p,t),Va(p,t)}):a(p);return}})},Va=(t,e)=>{},Ln=(t,e,n="iconFile")=>{let a;a=document.querySelector(`#sidebar [data-type="sidebar-file"] [data-node-id="${e}"] .b3-list-item__icon`),a&&(a.innerHTML=le(t||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?g.SIYUAN_IMAGE_FILE:g.SIYUAN_IMAGE_FOLDER:g.SIYUAN_IMAGE_NOTE))),n!=="iconFile"&&Jt()},pu=t=>{},ur=()=>{const t=new URLSearchParams(window.location.search),e=t.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e))n=e.substring(20,20+22),a=ne("focus",e)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();n=ys(i),a=ne("focus",i)==="1"}else n=t.get("id"),a=t.get("focus")==="1";return{id:n,isZoomIn:a}},fr=t=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t),ys=t=>t.substring(16,16+22),gr=(t=window.location.href)=>{const e=new URL(window.location.origin);e.pathname="/check-auth",e.searchParams.set("to",t),window.location.href=e.href},pr=()=>{let t=document.getElementById("baseURL");t||(t=document.createElement("base"),t.id="baseURL"),t.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(t)},ze=(t,e=!0,n=!1)=>{let a=t;return e&&(a=we().basename(t)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},_s=t=>t.substring(7,t.length-we().extname(t).length-23),vs=t=>!t||(t=t.trim(),1>t.length)?!1:(t=t.toLowerCase(),t.startsWith("assets/")||t.startsWith("file://")||t.startsWith("\\\\")?!0:t.indexOf(":")===1),we=()=>bi.posix?bi.posix:bi,mu=()=>path,Es=t=>{const e=[];return t.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");e.find(s=>{if(a.startsWith(s.replace(".sy","")))return!0})||e.push(a)}}),e},mr=(t,e,n)=>{_("/api/filetree/moveDocs",{toNotebook:e,fromPaths:t,toPath:n})},Rn=(t,e,n,a,i=!1)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.querySelector("#foldList"))return f.destroy(),!0}))return;const l=new be({title:`${a||window.siyuan.languages.move}
<div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${H()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${H()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"50vw",height:H()?"80vh":"70vh",destroyCallback(){n&&z(n)}});e&&e.length>0&&_("/api/filetree/getHPathsByPaths",{paths:e},f=>{l.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=$e(f.data.join(" "))});const o=l.element.querySelector("#foldList"),r=l.element.querySelector("#foldTree");Jt(f=>{let p="";f.forEach(b=>{if(!b.closed){let m="";i&&(m=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${b.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${b.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${b.flashcardCount}</span>`),p+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${p===""?" b3-list-item--focus":""}" data-path="/" data-box="${b.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${le(b.icon||g.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${$e(b.name)}</span>
    ${m}
</li></ul>`}}),r.innerHTML=p},i);const c=l.element.querySelector(".b3-text-field");c.focus();const u=f=>{if(!(f&&f.isComposing)){if(c.value.trim()===""){o.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),o.classList.remove("fn__none"),o.scrollTo(0,0),_("/api/filetree/searchDocs",{k:c.value,flashcard:i},p=>{let b="";p.data.forEach(m=>{let h="";i&&(h=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),b+=`<li class="b3-list-item${b===""?" b3-list-item--focus":""}" data-path="${m.path}" data-box="${m.box}">
    ${le(m.boxIcon||g.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding:4px 0">${$e(m.hPath)}</span>
    ${h}
</li>`}),o.innerHTML=b})}};u(),c.addEventListener("compositionend",f=>{u(f)}),c.addEventListener("input",f=>{u(f)});const d=28;c.addEventListener("keydown",f=>{if(f.isComposing)return;const p=o.classList.contains("fn__none")?r:o,b=p.querySelectorAll(".b3-list-item--focus");if(b.length===0)return;let m=b[0];if(f.key.startsWith("Arrow")&&b.forEach((h,w)=>{w!==0&&h.classList.remove("b3-list-item--focus")}),o.classList.contains("fn__none")){if(f.key==="ArrowRight"&&!m.querySelector(".b3-list-item__arrow--open")&&!m.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||f.key==="ArrowLeft"&&m.querySelector(".b3-list-item__arrow--open")){wi(m,i),f.preventDefault();return}if(f.key==="ArrowLeft"){let h=m.parentElement.previousElementSibling;if(h){h.tagName!=="LI"&&(h=p.querySelector(".b3-list-item")),m.classList.remove("b3-list-item--focus"),h.classList.add("b3-list-item--focus");const w=h.getBoundingClientRect(),y=p.getBoundingClientRect();(w.top<y.top||w.bottom>y.bottom)&&h.scrollIntoView(w.top<y.top)}return f.preventDefault(),!0}if(f.key==="ArrowDown"||f.key==="ArrowRight"){let h=m;for(;h;)if(h.nextElementSibling)if(h.nextElementSibling.classList.contains("fn__none"))h=h.nextElementSibling;else{h.nextElementSibling.tagName==="UL"?h=h.nextElementSibling.firstElementChild:h=h.nextElementSibling;break}else{if(h.parentElement.id==="foldTree")break;h=h.parentElement}if(h.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),h.classList.add("b3-list-item--focus");const w=h.getBoundingClientRect(),y=r.getBoundingClientRect();(w.top<y.top||w.bottom>y.bottom)&&h.scrollIntoView(w.top<y.top)}return f.preventDefault(),!0}if(f.key==="ArrowUp"){let h=m;for(;h;)if(h.previousElementSibling)if(h.previousElementSibling.classList.contains("fn__none"))h=h.previousElementSibling;else{if(h.previousElementSibling.tagName==="LI")h=h.previousElementSibling;else{const w=h.previousElementSibling.querySelectorAll(".b3-list-item");h=w[w.length-1]}break}else{if(h.parentElement.id==="foldTree")break;h=h.parentElement}if(h.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),h.classList.add("b3-list-item--focus");const w=h.getBoundingClientRect(),y=r.getBoundingClientRect();(w.top<y.top||w.bottom>y.bottom)&&h.scrollIntoView(w.top<y.top)}f.preventDefault()}}else{if(f.key==="ArrowDown"){m.classList.remove("b3-list-item--focus"),m.nextElementSibling?m.nextElementSibling.classList.add("b3-list-item--focus"):p.children[0].classList.add("b3-list-item--focus"),m=p.querySelector(".b3-list-item--focus"),(p.scrollTop<m.offsetTop-p.clientHeight+d||p.scrollTop>m.offsetTop)&&(p.scrollTop=m.offsetTop-p.clientHeight+d),f.preventDefault();return}if(f.key==="ArrowUp"){if(m.classList.remove("b3-list-item--focus"),m.previousElementSibling)m.previousElementSibling.classList.add("b3-list-item--focus");else{const h=p.children.length;p.children[h-1].classList.add("b3-list-item--focus")}m=p.querySelector(".b3-list-item--focus"),(p.scrollTop<m.offsetTop-p.clientHeight+d||p.scrollTop>m.offsetTop-d*2)&&(p.scrollTop=m.offsetTop-d*2),f.preventDefault();return}}if(f.key==="Enter"){const h=p.querySelectorAll(".b3-list-item--focus");if(h.length===0)return;const w=[],y=[];h.forEach(E=>{w.push(E.getAttribute("data-path")),y.push(E.getAttribute("data-box"))}),t(w,y),l.destroy(),f.preventDefault()}}),l.element.addEventListener("click",f=>{let p=f.target;for(;p&&!p.isEqualNode(l.element);){if(p.classList.contains("b3-list-item__toggle")){wi(p.parentElement,i),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-button--text")){const m=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;const h=[],w=[];m.forEach(y=>{h.push(y.getAttribute("data-path")),w.push(y.getAttribute("data-box"))}),t(h,w),l.destroy(),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-button--cancel")){l.destroy(),f.preventDefault(),f.stopPropagation();break}else if(p.classList.contains("b3-list-item")){const m=(o.classList.contains("fn__none")?r:o).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;a===window.siyuan.languages.specifyPath&&(f.ctrlKey||f.metaKey)?m.length===1&&m[0].isSameNode(p)||p.classList.toggle("b3-list-item--focus"):(m[0].classList.remove("b3-list-item--focus"),p.classList.add("b3-list-item--focus")),p.getAttribute("data-path")==="/"&&wi(p,i),f.preventDefault(),f.stopPropagation();break}p=p.parentElement}c.focus()})},wi=(t,e)=>{const n=t.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.classList.add("fn__none");return}if(t.nextElementSibling&&t.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none");return}const a=t.getAttribute("data-box");_("/api/filetree/listDocsByPath",{notebook:a,path:t.getAttribute("data-path"),flashcard:e},i=>{if(i.data.path==="/"&&i.data.files.length===0){oe(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(o=>{let r="";e?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${o.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${o.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${o.flashcardCount}</span>`:o.count&&o.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${o.count}</span>`),s+=`<li title="${ze(o.name,!0,!0)} ${o.hSize}${o.bookmark?`
`+window.siyuan.languages.bookmark+" "+o.bookmark:""}${o.name1?`
`+window.siyuan.languages.name+" "+o.name1:""}${o.alias?`
`+window.siyuan.languages.alias+" "+o.alias:""}${o.memo?`
`+window.siyuan.languages.memo+" "+o.memo:""}${o.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",o.subFileCount):""}
${window.siyuan.languages.modifiedAt} ${o.hMtime}
${window.siyuan.languages.createdAt} ${o.hCtime}" 
data-box="${a}" class="b3-list-item" data-path="${o.path}">
    <span style="padding-left: ${o.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${o.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${le(o.icon||(o.subFileCount===0?g.SIYUAN_IMAGE_FILE:g.SIYUAN_IMAGE_FOLDER),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${ze(o.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;n.classList.add("b3-list-item__arrow--open"),t.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const l=t.nextElementSibling;setTimeout(()=>{l.setAttribute("style",`height:${l.childElementCount*t.clientHeight}px;`),setTimeout(()=>{l.classList.remove("file-tree__sliderDown"),l.removeAttribute("style")},120)},2)})},At=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.name,!0}),e},br=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.icon,!0}),e},hr=(t,e)=>{window.siyuan.notebooks.find(n=>{if(n.id===t)return n.name=e,!0})},Ga=()=>{let t=0;return window.siyuan.notebooks.forEach(e=>{e.closed||t++}),t},Jt=(t,e=!1)=>{_("/api/notebook/lsNotebooks",{flashcard:e},n=>{e||(window.siyuan.notebooks=n.data.notebooks),t&&t(n.data.notebooks)})},xn=(t,e)=>{if(!document.getElementById(e)){const n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href=t,document.getElementsByTagName("head")[0].appendChild(n)}},ks=(t,e)=>{fe(t,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(e.icon)){const n=document.getElementById("iconScript");n&&n.remove(),fe(`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`,"iconScript")}})},Ls=t=>{const e=document.getElementsByTagName("html")[0];e.setAttribute("lang",window.siyuan.config.appearance.lang),e.setAttribute("data-theme-mode",_r()),e.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),e.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(_("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const a=document.getElementById("themeDefaultStyle");let i=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${g.SIYUAN_VERSION}`;(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight")&&(i=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${g.SIYUAN_VERSION}`),a?a.getAttribute("href").startsWith(i)||(a.remove(),xn(i,"themeDefaultStyle")):xn(i,"themeDefaultStyle");const s=document.getElementById("themeStyle");if(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight"){const u=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.css?v=${t.themeVer}`;s?s.getAttribute("href").startsWith(u)||(s.remove(),xn(u,"themeStyle")):xn(u,"themeStyle")}else s&&s.remove();xs();const l=document.getElementById("themeScript"),o=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.js?v=${t.themeVer}`;l?l.getAttribute("src").startsWith(o)||(l.remove(),fe(o,"themeScript")):fe(o,"themeScript");const r=document.getElementById("iconDefaultScript"),c=`/appearance/icons/${["ant","material"].includes(t.icon)?t.icon:"material"}/icon.js?v=${g.SIYUAN_VERSION}`;if(r){r.remove();let u=document.body.firstElementChild;for(;u.tagName==="svg";){const d=u;u=u.nextElementSibling,d.getAttribute("data-name")||d.remove()}ks(c,t)}else ks(c,t)},wr=()=>{const t=document.getElementById("loading");t&&setTimeout(()=>{t.remove()},160),Ss(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{const n=e.matches?"dark":"light";Ss(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||_("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>{if(window.siyuan.config.appearance.themeJS){window.location.reload();return}window.siyuan.config.appearance=a.data.appearance,Ls(a.data.appearance)}))})},yr=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){fe("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const t=function(...n){window.dataLayer.push(arguments)};t("js",new Date),t("config","G-L7WEXVQCR9",{send_page_view:!1});const e={version:g.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(e.isLoggedIn=!0,e.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,e.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,e.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,e.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(e.syncEnabled=window.siyuan.config.sync.enabled,e.syncProvider=window.siyuan.config.sync.provider),t("event",g.ANALYTICS_EVT_ON_GET_CONFIG,e)}},yi=(t=!0)=>{const e=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${e+8}px;line-height: ${e+8}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${e+8}px;}
.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}
.protyle-wysiwyg [data-node-id].li:before {height: calc(100% - ${e+8}px);top:${e+8}px}
.protyle-wysiwyg [data-node-id] [spellcheck] {min-height:${e}px;}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.rtl?" direction: rtl;":""}${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${e+8}px}
.protyle-gutters button svg {height:${e}px}
.protyle-wysiwyg img.emoji, .b3-typography img.emoji {width:${e-8}px}
.protyle-wysiwyg .h1 img.emoji, .b3-typography h1 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.75*1.25)}px}
.protyle-wysiwyg .h2 img.emoji, .b3-typography h2 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.55*1.25)}px}
.protyle-wysiwyg .h3 img.emoji, .b3-typography h3 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.38*1.25)}px}
.protyle-wysiwyg .h4 img.emoji, .b3-typography h4 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25*1.25)}px}
.protyle-wysiwyg .h5 img.emoji, .b3-typography h5 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.13*1.25)}px}
.protyle-wysiwyg .h6 img.emoji, .b3-typography h6 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25)}px}`;return window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title, .protyle-title__input{font-family: "${window.siyuan.config.editor.fontFamily}", "Helvetica Neue", "Luxi Sans", "DejaVu Sans", "Hiragino Sans GB", "Microsoft Yahei", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "Segoe UI Symbol", "Android Emoji", "EmojiSymbols" !important;}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),t&&(document.getElementById("editorFontSize").innerHTML=n),n},xs=(t=g.PROTYLE_CDN)=>{const e=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,g.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,g.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${t}/js/highlight.js/styles/${n}.min.css?v=11.5.0`;e?e.href.includes(a)||(e.remove(),xn(a,"protyleHljsStyle")):xn(a,"protyleHljsStyle")},bu=t=>{},Ss=t=>{(Pt()||yt())&&setTimeout(()=>{const e=getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim();let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(t==="dark"?n=1:n=0),Pt()?window.webkit.messageHandlers.changeStatusBar.postMessage((e||(n===0?"#fff":"#1e1e1e"))+" "+n):yt()&&window.JSAndroid.changeStatusBarColor(e,n)},500)},_r=()=>{const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?t:window.siyuan.config.appearance.mode===0?"light":"dark"},Ae=(t,e=g.PROTYLE_CDN)=>{let n,a=!1;t.classList.contains("code-block")?n=t.querySelectorAll("[spellcheck]"):t.classList.contains("item__readme")?(n=t.querySelectorAll("pre code"),n.forEach(i=>{i.parentElement.setAttribute("lineNumber","false")})):t.classList.contains("b3-typography")?(n=t.querySelectorAll(".code-block code"),a=!0):n=t.querySelectorAll(".code-block [spellcheck]"),n.length!==0&&(xs(e),fe(`${e}/js/highlight.js/highlight.min.js?v=11.7.0`,"protyleHljsScript").then(()=>{fe(`${e}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(i=>{var s,l;const o=i.parentElement.querySelectorAll(".protyle-icon");if(o.length===2&&(o[0].setAttribute("aria-label",window.siyuan.languages.copy),o[1].setAttribute("aria-label",window.siyuan.languages.more)),i.getAttribute("data-render")==="true")return;const r=i.querySelector("wbr");let c=0;if(r){let h=r.previousSibling;for(;h;){for(c+=h.textContent.length;!h.previousSibling&&h.parentElement.tagName!=="DIV";)h=h.parentElement;h=h.previousSibling}r.remove()}let u;a?u=i.parentElement.getAttribute("data-language"):i.previousElementSibling?u=i.previousElementSibling.firstElementChild.textContent:u=i.className.replace("language-",""),window.hljs.getLanguage(u)||(u="plaintext"),i.classList.add("hljs"),i.setAttribute("data-render","true");const d=i.parentElement.getAttribute("linewrap"),f=i.parentElement.getAttribute("ligatures"),p=i.parentElement.getAttribute("linenumber");d==="true"||d!=="false"&&window.siyuan.config.editor.codeLineWrap?(i.style.setProperty("white-space","pre-wrap"),i.style.setProperty("word-break","break-all")):(i.style.setProperty("white-space","pre"),i.style.setProperty("word-break","initial")),f==="true"||f!=="false"&&window.siyuan.config.editor.codeLigatures?i.style.fontVariantLigatures="normal":i.style.fontVariantLigatures="none";const b=i.parentElement.querySelector(".protyle-action__language");!a&&(p==="true"||p!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(i.classList.add("protyle-linenumber"),da(i),b&&(b.style.marginLeft="3.6em")):(s=i.nextElementSibling)!=null&&s.classList.contains("protyle-linenumber__rows")&&(i.classList.remove("protyle-linenumber"),i.nextElementSibling.remove(),b&&(b.style.marginLeft=""));const m=N(i,"search__layout",!0);if(m&&i.parentElement.getAttribute("data-node-id")===((l=m.querySelector("#searchList > .b3-list-item--focus"))==null?void 0:l.getAttribute("data-node-id"))){const h=i.querySelector('span[data-type="search-mark"]');h&&h.scrollIntoView()}i.innerHTML=window.hljs.highlight(i.textContent+(i.textContent.endsWith(`
`)?"":`
`),{language:u,ignoreIllegals:!0}).value,r&&getSelection().rangeCount>0&&ps(i,c,c)})})}))},da=t=>{var e;if(t.parentElement.getAttribute("lineNumber")==="false"||t.nextElementSibling&&t.nextElementSibling.clientHeight===t.clientHeight)return;t.classList.add("protyle-linenumber"),t.parentElement.style.lineHeight=`${((parseInt(t.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const n=document.createElement("div");n.className="hljs protyle-linenumber",n.setAttribute("style",`padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;white-space:${t.style.whiteSpace};word-break:${t.style.wordBreak};font-variant-ligatures:${t.style.fontVariantLigatures};`),n.setAttribute("contenteditable","true"),t.insertAdjacentElement("afterend",n);let a="";const i=t.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);i[i.length-1]===""&&i.length>1&&i.pop();const s=t.style.wordBreak==="break-all";i.map(o=>{let r="";s&&(n.textContent=o||`
`,r=` style="height:${n.clientHeight}px;"`),a+=`<span${r}></span>`}),n.remove();const l=t.offsetHeight;(e=t.nextElementSibling)!=null&&e.classList.contains("protyle-linenumber__rows")?(t.nextElementSibling.innerHTML=a,t.nextElementSibling.style.height=l+"px"):t.insertAdjacentHTML("afterend",`<span contenteditable="false" style="height:${l}px" class="protyle-linenumber__rows">${a}</span>`)},ua=t=>{Y(["gutter"],t);const e=uc(t),n=4;setTimeout(()=>{if((e.width>n||isNaN(e.width))&&(typeof window.echarts!="undefined"&&t.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(a=>{const i=window.echarts.getInstanceById(a.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(a=>{da(a)}),!t.disabled&&t.toolbar.range)){let a=t.toolbar.range.getBoundingClientRect();if(a.height===0){const s=I(t.toolbar.range.startContainer);s&&(a=s.getBoundingClientRect())}if(a.height===0)return;const i=t.element.getBoundingClientRect();(i.top+30>a.top||i.bottom<a.bottom)&&t.toolbar.range.startContainer.parentElement.scrollIntoView(i.top>a.top)}(e.padding>n||e.width>n||isNaN(e.padding))&&t.wysiwyg.element.querySelectorAll(".av").forEach(a=>{Ct(a)})},g.TIMEOUT_TRANSITION)},Ct=t=>{if(!(!t.classList.contains("av")||t.getAttribute("data-render")!=="true"))if(t.style.width.endsWith("%")||t.style.margin){const e=t.firstElementChild.firstElementChild;e.style.paddingLeft="",e.style.paddingRight="";const n=t.querySelector(".av__scroll").firstElementChild;n.style.paddingLeft="",n.style.paddingRight="",t.style.alignSelf="",t.style.width.endsWith("%")||(t.style.width="",t.style.maxWidth="100%")}else{const e=t.parentElement.style.paddingLeft,n=t.parentElement.style.paddingRight,a=t.firstElementChild.firstElementChild;a.style.paddingLeft=e,a.style.paddingRight=n;const i=t.querySelector(".av__scroll").firstElementChild;i.style.paddingLeft=e,i.style.paddingRight=n,t.style.alignSelf="center",t.parentElement.clientWidth>0&&(t.style.width=t.parentElement.clientWidth+"px",t.style.maxWidth="")}},fa=(t,e)=>{var n,a,i,s;if(e==="preview"){if(!t.preview.element.classList.contains("fn__none"))return;t.preview.element.classList.remove("fn__none"),t.contentElement.classList.add("fn__none"),(n=t.scroll)==null||n.element.classList.add("fn__none"),t.options.render.breadcrumb&&((a=t.breadcrumb)==null||a.element.classList.add("fn__none"),t.breadcrumb.toggleExit(!0)),t.preview.render(t)}else if(e==="wysiwyg"){if(!t.contentElement.classList.contains("fn__none"))return;t.preview.element.classList.add("fn__none"),t.contentElement.classList.remove("fn__none"),t.options.render.scroll&&((i=t.scroll)==null||i.element.classList.remove("fn__none")),t.options.render.breadcrumb&&((s=t.breadcrumb)==null||s.element.classList.remove("fn__none"),t.breadcrumb.toggleExit(!t.block.showAll)),ua(t)}Y(["gutter","toolbar","select","hint","util"],t)},pn=()=>`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`,As=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="abc"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&fe(`${e}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",pn()),a.childElementCount<4&&a.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${g.ZWSP}</span>`);const i=a.firstElementChild.nextElementSibling;window.ABCJS.renderAbc(i,Lute.UnEscapeHTMLStr(a.getAttribute("data-content")),{responsive:"resize"}),i.setAttribute("contenteditable","false"),a.setAttribute("data-render","true")})})};var vr=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Cs=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="echarts"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&fe(`${e}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{fe(`${e}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const i=N(n[0],"layout-tab-container",!0);i&&Array.from(i.children).find(s=>{if(s.classList.contains("protyle")&&!s.classList.contains("fn__none"))return a=s.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(i=>vr(void 0,null,function*(){if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",pn());const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height;const l=yield Xe(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption(l),i.setAttribute("data-render","true"),s.classList.remove("ft__error"),s.textContent.endsWith(g.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",g.ZWSP)}catch(l){window.echarts.dispose(s),s.classList.add("ft__error"),s.innerHTML=`echarts render error: <br>${l}`}}))})})},Ts=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="graphviz"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&fe(`${e}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",pn());const i=a.firstElementChild.nextElementSibling;try{const s=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),o=(window.URL||window.webkitURL).createObjectURL(s),r=new Worker(o);new Viz({worker:r}).renderSVGElement(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))).then(c=>{i.innerHTML=c.outerHTML,i.classList.remove("ft__error"),i.setAttribute("contenteditable","false"),a.textContent.endsWith(g.ZWSP)||a.insertAdjacentHTML("beforeend",`<span style="position: absolute">${g.ZWSP}</span>`)}).catch(c=>{i.innerHTML=`graphviz render error: <br>${c}`,i.classList.add("ft__error")})}catch(s){console.error("Graphviz error",s)}a.setAttribute("data-render","true")})})},en=(t,e=g.PROTYLE_CDN,n=!1)=>{let a=[];t.getAttribute("data-subtype")==="math"?a=[t]:a=Array.from(t.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(xn(`${e}/js/katex/katex.min.css?v=0.16.0`,"protyleKatexStyle"),fe(`${e}/js/katex/katex.min.js?v=0.16.0`,"protyleKatexScript").then(()=>{fe(`${e}/js/katex/mhchem.min.js?v=0.16.0`,"protyleKatexMhchemScript").then(()=>{a.forEach(i=>{var s,l;if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let o=i;i.tagName==="DIV"&&(o=i.firstElementChild);let r={};try{r=JSON.parse(window.siyuan.config.editor.katexMacros||"{}")}catch(c){console.warn("KaTex macros is not JSON",c)}try{o.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:i.tagName==="DIV",output:"html",macros:r,trust:!0,strict:u=>u==="unicodeTextInMathMode"?"ignore":"warn"}),o.classList.remove("ft__error");const c=I(i);if(i.tagName==="DIV"){o.firstElementChild.setAttribute("contenteditable","false"),o.childElementCount<2&&o.insertAdjacentHTML("beforeend",`<span style="position: absolute">${g.ZWSP}</span>`);const u=o.querySelectorAll(".base");u.length>0&&u[u.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const d=o.querySelector(".katex-html > .newline");d&&(d.parentElement.style.display="block")}else{c&&i.getBoundingClientRect().width>c.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const u=Ee(i);u?u&&u.nodeType!==3&&((s=u.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1?i.after(document.createTextNode(g.ZWSP)):u&&!u.textContent.startsWith(`
`)&&u.textContent!==g.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",g.ZWSP),(l=i.previousSibling)!=null&&l.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",g.ZWSP):!xe(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",g.ZWSP)}n&&setTimeout(()=>{if(i.tagName==="DIV"){const u=i.querySelector(".katex-display");u.clientWidth<u.scrollWidth&&u.firstElementChild.setAttribute("style",`font-size:${u.clientWidth*100/u.scrollWidth}%`)}else c&&i.offsetWidth>c.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${c.clientWidth*100/i.offsetWidth}%`)})}catch(c){o.innerHTML=c.message,o.classList.add("ft__error")}})})}))},$s=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mermaid"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&fe(`${e}/js/mermaid/mermaid.min.js?v=10.3.0`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const i=A(n[0],"fold","1");if(!i)return;const s=new MutationObserver(()=>{Is(n),s.disconnect()});s.observe(i,{attributeFilter:["fold"]})}else Is(n)})},Is=t=>{t.forEach((e,n)=>{if(e.getAttribute("data-render")==="true")return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`);const a=e.firstElementChild.nextElementSibling;a.removeAttribute("data-processed"),a.textContent=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),setTimeout(()=>{window.mermaid.init(void 0,a)},g.TIMEOUT_LOAD*n),e.setAttribute("data-render","true"),a.setAttribute("contenteditable","false"),e.textContent.endsWith(g.ZWSP)||e.insertAdjacentHTML("beforeend",`<span style="position: absolute">${g.ZWSP}</span>`)})},Ds=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mindmap"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&fe(`${e}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const i=N(n[0],"layout-tab-container",!0);i&&Array.from(i.children).find(s=>{if(s.classList.contains("protyle")&&!s.classList.contains("fn__none")&&s.querySelector(".protyle-wysiwyg").firstElementChild)return a=s.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",pn());const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height,window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(l,o)=>{var r;return(r=o==null?void 0:o.data)!=null&&r.children?"circle":"path://"},type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),i.setAttribute("data-render","true"),s.textContent.endsWith(g.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",g.ZWSP),s.classList.remove("ft__error")}catch(l){s.classList.add("ft__error"),s.innerHTML=`Mindmap render error: <br>${l}`}})})},Ms=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="flowchart"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&fe(`${e}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=A(n[0],"fold","1");if(!a)return;const i=new MutationObserver(()=>{Hs(n),i.disconnect()});i.observe(a,{attributeFilter:["fold"]})}else Hs(n)})},Hs=t=>{t.forEach(e=>{if(e.getAttribute("data-render")==="true")return;e.getAttribute("data-node-id")&&(e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",pn()),e.childElementCount<4&&e.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${g.ZWSP}</span>`));const n=e.firstElementChild.nextElementSibling||e.firstElementChild,a=flowchart.parse(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")));n.innerHTML="";try{a.drawSVG(n)}catch(i){n.classList.add("ft__error"),n.innerHTML=`Flow Chart render error: <br>${i}`}n.setAttribute("contenteditable","false"),e.setAttribute("data-render","true")})},Ns=(t,e=g.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="plantuml"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&fe(`${e}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",pn());const i=a.firstElementChild.nextElementSibling;try{i.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(a.getAttribute("data-content")))}">`,i.classList.remove("ft__error"),a.setAttribute("data-render","true")}catch(s){i.classList.add("ft__error"),i.innerHTML=`plantuml render error: <br>${s}`}})})},Ps=t=>{let e=[];t.getAttribute("data-type")==="NodeHTMLBlock"?e=[t]:e=Array.from(t.querySelectorAll('[data-type="NodeHTMLBlock"]')),e.length!==0&&e.length>0&&e.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Er=(t,e)=>{const n=document.createElement("div");n.innerHTML=t;let a=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||t.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(a=!0),a){let i=e||t;return/\n/.test(i)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[g.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${i.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${g.ZWSP}</div></div>`:(i=i.replace("<","&lt;").replace(">","&gt;"),"`"+i+"`")}return!1},Oe=t=>{const e=t.getAttribute("data-subtype");if(!["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"].includes(e)||t.getAttribute("data-type")!=="NodeHTMLBlock"){As(t),Ps(t),Ns(t),$s(t),Ms(t),Cs(t),Ds(t),Ts(t),en(t);return}e==="abc"?As(t):e==="plantuml"?Ns(t):e==="mermaid"?$s(t):e==="flowchart"?Ms(t):e==="echarts"?Cs(t):e==="mindmap"?Ds(t):e==="graphviz"?Ts(t):e==="math"?en(t):t.getAttribute("data-type")==="NodeHTMLBlock"&&Ps(t)},_t=(t,e)=>{let n="";switch(t){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":e?n="icon"+e.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":e==="t"?n="iconCheck":e==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n};class ut{constructor(e,n){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,e){const a=this.menu.element.getAttribute("data-name");a&&a===e&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(this.menu.element.setAttribute("data-name",e),this.menu.removeCB=n)}showSubMenu(e){this.menu.showSubMenu(e)}addItem(e){if(!this.isOpen)return this.menu.addItem(e)}addSeparator(e){this.isOpen||this.menu.addSeparator(e)}open(e){this.isOpen||this.menu.popup(e)}fullscreen(e="all"){this.isOpen||this.menu.fullscreen(e)}close(){this.menu.remove()}}class kr{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener(H()?"click":"mouseover",e=>{const n=e.target;if(H()&&(N(n,"b3-menu__title")||typeof e.detail=="string"&&e.detail==="back")){const l=this.element.querySelectorAll(".b3-menu__item--show");l.length>0?l[l.length-1].classList.remove("b3-menu__item--show"):this.remove();return}const a=N(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const i=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(a)&&!s.isSameNode(a)&&!a.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),i&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(e){const n=e.parentElement.getBoundingClientRect();e.style.top=n.top-8+"px",e.style.left=n.right+8+"px",e.style.bottom="auto";const a=e.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?e.style.left=n.left-8-a.width+"px":e.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(e.style.top="auto",e.style.bottom="8px")}preventDefault(e){!N(e.target,"b3-menu")&&!N(e.target,"keyboard__bar")&&e.preventDefault()}addSeparator(e){this.addItem({type:"separator",index:e})}addItem(e){const n=new T(e);return this.append(n.element,e.index),n.element}removeScrollEvent(){window.removeEventListener(H()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),window.siyuan.menus.menu.element.removeAttribute("data-name")}append(e,n){if(e){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(e);return}}this.element.lastElementChild.append(e)}}popup(e){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener(H()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),Le(this.element,e.x-(e.isLeft?window.siyuan.menus.menu.element.clientWidth:0),e.y,e.h,e.w))}fullscreen(e="all"){this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{e==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0}}class T{constructor(e){if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),e.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=e.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),e.id&&this.element.setAttribute("data-id",e.id),e.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),e.element)this.element.append(e.element);else{let n=`<span class="b3-menu__label">${e.label}</span>`;typeof e.iconHTML=="string"?n=e.iconHTML+n:n=`<svg class="b3-menu__icon ${e.iconClass||""}" style="${e.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${n}`,e.accelerator&&(n+=`<span class="b3-menu__accelerator">${De(e.accelerator)}</span>`),e.action&&(n+=`<svg class="b3-menu__action"><use xlink:href="#${e.action}"></use></svg>`),this.element.innerHTML=n}if(e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',e.submenu.forEach(a=>{n.firstElementChild.append(new T(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}const Sn=(t,e)=>{let n=t;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly"));)e?n=n.nextElementSibling:n=n.previousElementSibling;return n},hu=t=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||t.altKey||t.shiftKey||isCtrl(t))return!1;const e=t.target;if(window.siyuan.menus.menu.element.contains(e)&&(e.tagName==="INPUT"||e.tagName==="TEXTAREA"))return!1;if(t.code==="ArrowDown"||t.code==="ArrowUp"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let a;if(n?(n.classList.remove("b3-menu__item--current","b3-menu__item--show"),t.code==="ArrowUp"?(a=Sn(n.previousElementSibling,!1),a||(a=Sn(n.parentElement.lastElementChild,!1))):(a=Sn(n.nextElementSibling,!0),a||(a=Sn(n.parentElement.firstElementChild,!0)))):t.code==="ArrowUp"?a=Sn(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):a=Sn(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),a){a.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--show");const i=a.parentElement.getBoundingClientRect(),s=a.getBoundingClientRect();(i.top>s.top||i.bottom<s.bottom)&&a.scrollIntoView(i.top>s.top)}return!0}else if(t.code==="ArrowRight"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!n)return!0;const a=n.querySelector(".b3-menu__submenu");if(!a)return!0;n.classList.remove("b3-menu__item--current"),n.classList.add("b3-menu__item--show");const i=Sn(a.firstElementChild.firstElementChild,!0);return i&&i.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(a),!0}else if(t.code==="ArrowLeft"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!n)return!0;const a=hasClosestByClassName(n,"b3-menu__item--show");return a&&(a.classList.remove("b3-menu__item--show"),a.classList.add("b3-menu__item--current"),n.classList.remove("b3-menu__item--current")),!0}else if(t.code==="Enter"){const n=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(n){const a=n.querySelector(".b3-text-field"),i=n.querySelector(".b3-switch");if(a)return a.focus(),!0;i?i.click():n.dispatchEvent(new CustomEvent(getEventName())),window.siyuan.menus.menu.remove()}else return!1;return!0}};class Lr{constructor(){this.menus=[]}addSeparator(e){typeof e=="number"?this.menus.splice(e,0,{type:"separator"}):this.menus.push({type:"separator"})}addItem(e){typeof e.index=="number"?this.menus.splice(e.index,0,e):this.menus.push(e)}}const J=(t,e)=>{if(!t)return!1;if(t.indexOf("\u21E7")===-1&&t.indexOf("\u2318")===-1&&t.indexOf("\u2325")===-1&&t.indexOf("\u2303")===-1)return!e.ctrlKey&&!Ce(e)&&!e.altKey&&!e.shiftKey&&t===g.KEYCODELIST[e.keyCode];const n=t.split("");if(t.indexOf("F")>-1&&n.forEach((i,s)=>{i==="F"&&(n[s]="F"+n.splice(s+1,1),n[s+1]&&(n[s+1]+=n.splice(s+1,1)))}),t.startsWith("\u21E7")&&n.length===2)return!!(!e.ctrlKey&&!Ce(e)&&!e.altKey&&e.shiftKey&&n[1]===g.KEYCODELIST[e.keyCode]);if(t.startsWith("\u2325")){let i=n.length===3?n[2]:n[1];n.length===4&&(i=n[3]);const s=i===g.KEYCODELIST[e.keyCode];return!!(s&&e.altKey&&!e.shiftKey&&(n.length===3?Ce(e)&&t.startsWith("\u2325\u2318"):!Ce(e))||s&&t.startsWith("\u2325\u21E7\u2318")&&n.length===4&&e.altKey&&e.shiftKey&&Ce(e)||s&&t.startsWith("\u2325\u21E7")&&n.length===3&&e.altKey&&e.shiftKey&&!Ce(e))}if(t.startsWith("\u2303")){let i=n.length===3?n[2]:n[1];n.length===4&&(i=n[3]);const s=i===g.KEYCODELIST[e.keyCode];return!!(s&&n.length===2&&e.ctrlKey&&!e.altKey&&!e.shiftKey&&!e.metaKey||s&&t.startsWith("\u2303\u21E7")&&n.length===3&&e.ctrlKey&&!e.altKey&&e.shiftKey&&!e.metaKey||s&&t.startsWith("\u2303\u2325")&&n.length===3&&e.ctrlKey&&e.altKey&&!e.shiftKey&&!e.metaKey||s&&t.startsWith("\u2303\u2325\u21E7")&&n.length===4&&e.ctrlKey&&e.altKey&&e.shiftKey&&!e.metaKey)}const a=n.length>2&&n[0]==="\u21E7";return Ce(e)&&!e.altKey&&(!a&&!e.shiftKey||a&&e.shiftKey)?(a?n[2]:n[1])===g.KEYCODELIST[e.keyCode]:!1},_i=t=>{t.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){t.classList.remove("protyle-wysiwyg--hl")},1024)},Bs=(t,e,n=!1)=>{let a;const i=t.wysiwyg.element;if(!t.preview.element.classList.contains("fn__none")){a=document.getElementById(e),a&&(t.preview.element.scrollTop=a.offsetTop,_i(a));return}if(Array.from(i.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!A(s,"data-type","block-render",!0))return a=s,!0}),a)return Ie(t,a,n),_i(a),a;if(e===t.block.rootID&&t.options.render.title)return _i(t.title.editElement),t.title.editElement},Ie=(t,e,n=!1,a="auto")=>{if(!n&&getSelection().rangeCount>0&&I(getSelection().getRangeAt(0).startContainer)){const r=t.contentElement,c=Rt(r).top-r.getBoundingClientRect().top;let u=0;c<0?u=r.scrollTop+c:c>r.clientHeight-74&&(u=r.scrollTop+(c+74-r.clientHeight)),u!==0&&r.scroll({top:u,behavior:a});return}if(e||(e=I(de(t.wysiwyg.element).startContainer)),!e)return;let i=0,s=e;for(;!s.classList.contains("protyle-wysiwyg");)i+=s.offsetTop,s=s.parentElement;let l=0,o=t.element.firstElementChild;for(;o&&!o.classList.contains("protyle-content");)l+=o.clientHeight,o=o.nextElementSibling;if(n){t.contentElement.scroll({top:i-l,behavior:a});return}t.contentElement.scrollTop>i-32?t.contentElement.scroll({top:i-l,behavior:a}):t.contentElement.scrollTop+t.contentElement.clientHeight<i+e.clientHeight-l&&t.contentElement.scroll({top:i+e.clientHeight-l-t.contentElement.clientHeight,behavior:a})};var ee=Mt(680);const Ne=(t,e)=>{if(t.getAttribute("data-subtype")!=="o")return;let n;Array.from(t.children).forEach((a,i)=>{i===0?e?(n=e,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+".")})},An=(t,e=0,n=!1)=>{const a=document.createElement("template"),i=t.getAttribute("data-subtype");if(i==="o"){const s=parseInt(t.getAttribute("data-marker"))+e;a.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${Ka(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${Ka(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${Ka(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},vi=(t,e,n)=>{const a=e[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr")),e.forEach(s=>{s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end")});const i=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=a.lastElementChild.previousElementSibling.outerHTML,l=[],o=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");e.forEach((u,d)=>{l.push({action:"move",id:u.getAttribute("data-node-id"),previousID:c}),o.push({action:"move",id:u.getAttribute("data-node-id"),previousID:d===0?a.getAttribute("data-node-id"):c}),c=u.getAttribute("data-node-id"),u.setAttribute("data-subtype",r);const f=u.querySelector(".protyle-action");r==="o"?(f.classList.add("protyle-action--order"),f.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(u)):r==="t"?(u.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconUncheck"></use></svg>',f.classList.remove("protyle-action--order"),f.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(u)):(u.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',f.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(u))}),r==="o"?(Ne(a.lastElementChild.previousElementSibling),Ne(a.parentElement)):a.getAttribute("data-subtype")==="o"&&Ne(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(l.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),o.push({action:"update",data:s,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),F(t,l,o))}else{const s=a.outerHTML,l=e[0].getAttribute("data-subtype"),o=document.createElement("div"),r=Lute.NewNodeID();o.setAttribute("data-node-id",r),o.setAttribute("data-type","NodeList"),o.setAttribute("class","list"),o.setAttribute("data-subtype",l),o.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:o.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(o);const u=[];let d;e.forEach((f,p)=>{c.push({action:"move",id:f.getAttribute("data-node-id"),parentID:r,previousID:d}),u.push({action:"move",id:f.getAttribute("data-node-id"),previousID:p===0?a.getAttribute("data-node-id"):d}),d=f.getAttribute("data-node-id"),o.lastElementChild.before(f)}),u.push({action:"delete",id:r}),l==="o"&&(Ne(o,1),Ne(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),u.push({action:"update",data:s,id:a.getAttribute("data-node-id")}),F(t,c,u))}a.parentElement.classList.contains("protyle-wysiwyg")||j(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,i),re(a,n)},xr=(t,e,n)=>{var a,i;const s=e.parentElement,l=s.getAttribute("data-node-id"),o=[],r=[];n.insertNode(document.createElement("wbr"));const c=Lute.NewNodeID();let u="",d=0;Array.from(s.parentElement.children).forEach(p=>{!d&&p.isSameNode(s)?d=1:d&&!p.classList.contains("protyle-attr")&&(r.push({id:p.getAttribute("data-node-id"),action:"move",previousID:l}),o.push({id:p.getAttribute("data-node-id"),action:"delete"}),p.getAttribute("data-subtype")==="o"&&(r.push({id:p.getAttribute("data-node-id"),action:"update",data:p.outerHTML}),p.setAttribute("data-marker",d+"."),p.firstElementChild.innerHTML=d+"."),u+=p.outerHTML,p.remove(),d++)}),r.reverse(),u=`<div data-subtype="${s.getAttribute("data-subtype")}" data-node-id="${c}" data-type="NodeList" class="list" updated="${ee().format("YYYYMMDDHHmmss")}">${u}<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div></div>`,s.parentElement.insertAdjacentHTML("afterend",u),o.push({id:c,action:"insert",previousID:s.parentElement.getAttribute("data-node-id"),data:u}),r.push({id:c,action:"delete"}),Array.from(s.children).reverse().forEach(p=>{!p.classList.contains("protyle-action")&&!p.classList.contains("protyle-attr")&&(o.push({id:p.getAttribute("data-node-id"),action:"move",previousID:s.parentElement.getAttribute("data-node-id")}),r.push({id:p.getAttribute("data-node-id"),action:"move",parentID:l}),s.parentElement.after(p))});const f=s.parentElement.getAttribute("data-node-id");s.parentElement.childElementCount===2?(r.splice(0,0,{id:f,action:"insert",data:s.parentElement.outerHTML,previousID:(a=s.parentElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:s.parentElement.parentElement.getAttribute("data-node-id")||t.block.rootID}),s.parentElement.remove(),o.push({id:f,action:"delete"})):(r.splice(0,0,{id:l,action:"insert",data:s.outerHTML,previousID:(i=s.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:f}),s.remove(),o.push({id:l,action:"delete"})),F(t,o,r),re(t.wysiwyg.element,n)},ga=(t,e,n)=>{var a,i,s,l,o,r,c,u;const d=e[0].parentElement,f=d.getAttribute("data-node-id");if(!f)return;const p=d.parentElement,b=p.parentElement;if((a=d.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&!b.getAttribute("data-node-id"))return;if(p.classList.contains("protyle-wysiwyg")||p.classList.contains("sb")||p.classList.contains("bq")){const k=[],C=[];n.collapse(!1),n.insertNode(document.createElement("wbr"));let v;!e[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(v=parseInt(e[0].getAttribute("data-marker")));let L=f,D=d,O=e[e.length-1].nextElementSibling,P=e[e.length-1].lastElementChild.previousElementSibling;if(e.forEach(pe=>{pe.classList.remove("protyle-wysiwyg--select"),pe.removeAttribute("select-start"),pe.removeAttribute("select-end"),Array.from(pe.children).forEach((K,te)=>{const ue=K.getAttribute("data-node-id");ue&&(k.push({action:"move",id:ue,previousID:L,parentID:p.getAttribute("data-node-id")||t.block.parentID}),C.push({action:"move",id:ue,previousID:te===1?void 0:L,parentID:pe.getAttribute("data-node-id"),data:K.contains(n.startContainer)?"focus":""}),L=ue,D.after(K),D=K)})}),!window.siyuan.config.editor.listLogicalOutdent&&!O.classList.contains("protyle-attr")){let pe;P.getAttribute("data-subtype")!==O.getAttribute("data-subtype")&&(pe=Lute.NewNodeID(),P=document.createElement("div"),P.classList.add("list"),P.setAttribute("data-subtype",O.getAttribute("data-subtype")),P.setAttribute("data-node-id",pe),P.setAttribute("data-type","NodeList"),P.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),P.innerHTML=`<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div>`,D.after(P),k.push({action:"insert",id:pe,data:P.outerHTML,previousID:D.getAttribute("data-node-id")}));let K;for(;O&&!O.classList.contains("protyle-attr");){k.push({action:"move",id:O.getAttribute("data-node-id"),previousID:K||((i=P.lastElementChild.previousElementSibling)==null?void 0:i.getAttribute("data-node-id")),parentID:P.getAttribute("data-node-id")}),C.push({action:"move",id:O.getAttribute("data-node-id"),parentID:P.getAttribute("data-node-id"),previousID:K||((s=O.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"))}),K=O.getAttribute("data-node-id");const te=O;O=O.nextElementSibling,P.lastElementChild.before(te)}P.getAttribute("data-subtype")==="o"&&(Array.from(P.children).forEach(te=>{const ue=te.getAttribute("data-node-id");ue&&C.push({action:"update",id:ue,data:te.outerHTML})}),Ne(P,1),Array.from(P.children).forEach(te=>{const ue=te.getAttribute("data-node-id");ue&&k.push({action:"update",id:ue,data:te.outerHTML})})),pe&&C.push({action:"delete",id:pe})}const Z=d.outerHTML;e.forEach(pe=>{pe.remove()}),d.childElementCount===1?(k.push({action:"delete",id:f}),f===t.block.id&&(t.block.id=t.block.parentID),C.splice(0,0,{action:"insert",data:Z,id:f,previousID:(l=d.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:p.getAttribute("data-node-id")||t.block.parentID}),d.remove()):(d.getAttribute("data-subtype")==="o"&&Ne(d,v),k.push({action:"update",id:f,data:d.outerHTML}),C.splice(0,0,{action:"update",id:f,data:Z})),F(t,k,C),re(p,n);return}if(d.childElementCount===2&&p.childElementCount===3){n.collapse(!1),n.insertNode(document.createElement("wbr"));const k=p.outerHTML;e[0].firstElementChild.remove(),e[0].lastElementChild.remove(),d.outerHTML=e[0].innerHTML,j(t,p.getAttribute("data-node-id"),p.outerHTML,k),re(p,n);return}n.collapse(!1),n.insertNode(document.createElement("wbr"));const m=[],h=[],w=(o=e[0].previousElementSibling)==null?void 0:o.getAttribute("data-node-id");e.forEach(k=>{k.classList.remove("protyle-wysiwyg--select"),k.removeAttribute("select-start"),k.removeAttribute("select-end")});let y;!e[0].previousElementSibling&&d.getAttribute("data-subtype")==="o"&&(y=parseInt(e[0].getAttribute("data-marker")));const E=p.parentElement.outerHTML;let S=e[e.length-1].nextElementSibling,x=e[e.length-1].lastElementChild.previousElementSibling;if(e.reverse().forEach(k=>{const C=k.getAttribute("data-node-id");m.push({action:"move",id:C,previousID:p.getAttribute("data-node-id")}),h.push({action:"move",id:C,previousID:w,parentID:d.getAttribute("data-node-id")}),p.after(k),(k.getAttribute("data-subtype")==="o"||k.getAttribute("data-subtype")==="t")&&p.getAttribute("data-subtype")==="u"?(h.push({action:"update",id:C,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',k.setAttribute("data-subtype","u"),k.setAttribute("data-marker","*"),m.push({action:"update",id:C,data:k.outerHTML})):(k.getAttribute("data-subtype")==="u"||k.getAttribute("data-subtype")==="t")&&p.getAttribute("data-subtype")==="o"?(h.push({action:"update",id:C,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',k.setAttribute("data-subtype","o"),k.setAttribute("data-marker","1."),m.push({action:"update",id:C,data:k.outerHTML})):(k.getAttribute("data-subtype")==="u"||k.getAttribute("data-subtype")==="0")&&p.getAttribute("data-subtype")==="t"&&(h.push({action:"update",id:C,data:k.outerHTML}),k.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',k.setAttribute("data-subtype","t"),k.setAttribute("data-marker","*"),m.push({action:"update",id:C,data:k.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!S.classList.contains("protyle-attr")){let k;x.classList.contains("list")||(k=Lute.NewNodeID(),x=document.createElement("div"),x.classList.add("list"),x.setAttribute("data-subtype",S.getAttribute("data-subtype")),x.setAttribute("data-node-id",k),x.setAttribute("data-type","NodeList"),x.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),x.innerHTML=`<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div>`,m.push({action:"insert",id:k,data:x.outerHTML,previousID:e[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),e[0].lastElementChild.before(x));let C;for(;S&&!S.classList.contains("protyle-attr");){const v=S.getAttribute("data-node-id");S.getAttribute("data-subtype")!==x.getAttribute("data-subtype")&&(h.push({action:"update",id:v,data:S.outerHTML}),S.querySelector(".protyle-action").outerHTML=x.querySelector(".protyle-action").outerHTML,S.setAttribute("data-subtype",x.getAttribute("data-subtype")),S.setAttribute("data-marker",x.getAttribute("data-marker")),m.push({action:"update",id:v,data:S.outerHTML})),m.push({action:"move",id:v,previousID:C||((r=x.lastElementChild.previousElementSibling)==null?void 0:r.getAttribute("data-node-id")),parentID:x.getAttribute("data-node-id")}),h.push({action:"move",id:v,previousID:C||((c=x.parentElement)==null?void 0:c.getAttribute("data-node-id"))}),C=v;const L=S;S=S.nextElementSibling,x.lastElementChild.before(L)}x.getAttribute("data-subtype")==="o"&&(Array.from(x.children).forEach(v=>{const L=v.getAttribute("data-node-id");L&&h.push({action:"update",id:L,data:v.outerHTML})}),Ne(x,1),Array.from(x.children).forEach(v=>{const L=v.getAttribute("data-node-id");L&&m.push({action:"update",id:L,data:v.outerHTML})})),k&&h.push({action:"delete",id:k})}if(!window.siyuan.config.editor.listLogicalOutdent&&d.nextElementSibling){S=d.nextElementSibling;let k;for(;S&&!S.classList.contains("protyle-attr");){const C=S.getAttribute("data-node-id");m.push({action:"move",id:C,previousID:k||x.getAttribute("data-node-id")}),h.push({action:"move",id:C,previousID:k||d.getAttribute("data-node-id")}),k=C;const v=S;S=S.nextElementSibling,x.after(v),x=v}}d.childElementCount===1&&p.childElementCount===3?(m.push({action:"delete",id:p.getAttribute("data-node-id")}),h.splice(0,0,{action:"insert",id:p.getAttribute("data-node-id"),data:p.outerHTML,previousID:(u=p.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:p.parentElement.getAttribute("data-node-id")}),p.remove()):d.childElementCount===1?(m.push({action:"delete",id:d.getAttribute("data-node-id")}),h.splice(0,0,{action:"insert",id:d.getAttribute("data-node-id"),data:d.outerHTML,previousID:d.previousElementSibling.getAttribute("data-node-id")}),d.remove()):d.getAttribute("data-subtype")==="o"&&(h.splice(0,0,{action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")}),Ne(d,y),m.push({action:"update",data:d.outerHTML,id:d.getAttribute("data-node-id")})),b.classList.contains("protyle-wysiwyg")?F(t,m,h):(p&&p.getAttribute("data-subtype")==="o"&&Ne(b),j(t,b.getAttribute("data-node-id"),b.outerHTML,E)),re(b,n)},Fn=(t,e)=>{const n=[],a=[];let i=e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0;e.classList.remove("protyle-wysiwyg--select"),e.removeAttribute("select-start"),e.removeAttribute("select-end");const s=e.getAttribute("data-node-id"),l=e.cloneNode();return l.innerHTML=e.lastElementChild.outerHTML,a.push({action:"insert",id:s,data:l.outerHTML,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),Array.from(e.children).forEach((o,r)=>{if(r===e.childElementCount-1){n.push({action:"delete",id:s}),e.lastElementChild.remove(),e.outerHTML=e.innerHTML;return}n.push({action:"move",id:o.getAttribute("data-node-id"),previousID:i,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),a.push({action:"move",id:o.getAttribute("data-node-id"),previousID:o.previousElementSibling?o.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:s}),i=o.getAttribute("data-node-id")}),n.forEach(o=>{const r=t.wysiwyg.element.querySelector(`[data-node-id="${o.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Se(t,r))}),{doOperations:n,undoOperations:a,previousId:i}},qs=(t,e,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",e||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",t),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div>`,a},Os=(t,e)=>{const n=he(e);if(n){const a=N(n,"list")||N(n,"bq")||N(n,"sb")||n,i=B(a);i&&(ce(i),Ie(t,i))}},vt=(t,e,n)=>{const a=de(t.wysiwyg.element);let i;if(n)i=t.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const c=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(e==="beforebegin"?i=c[0]:i=c[c.length-1],Y(["select"],t)):(i=I(a.startContainer),i=he(i))}if(!i)return;let s=mn(!1,!0),l=1;i.getAttribute("data-type")==="NodeListItem"&&(s=An(i,0,!0),l=parseInt(i.parentElement.firstElementChild.getAttribute("data-marker")));const o=i.parentElement.outerHTML,r=s.getAttribute("data-node-id");if(i.insertAdjacentElement(e,s),i.getAttribute("data-type")==="NodeListItem"&&i.getAttribute("data-subtype")==="o"&&!s.parentElement.classList.contains("protyle-wysiwyg"))Ne(s.parentElement,l),j(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,o);else{let c;e==="beforebegin"?c=[{action:"insert",data:s.outerHTML,id:r,nextID:i.getAttribute("data-node-id")}]:c=[{action:"insert",data:s.outerHTML,id:r,previousID:i.getAttribute("data-node-id")}],F(t,c,[{action:"delete",id:r}])}re(t.wysiwyg.element,a),Ie(t)},Ka=(t=!0,e=!0,n)=>{let a="";return t&&(a=g.ZWSP),e&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${g.ZWSP}</div></div>`},mn=(t=!0,e=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${t?g.ZWSP:""}${e?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${g.ZWSP}</div>`,a},Ei=(t,e,n)=>{if(t.getAttribute("custom-pinthead")==="true"){const a=t.querySelector("table");a.clientHeight+a.scrollTop<e.offsetTop+e.clientHeight?a.scrollTop=e.offsetTop-a.clientHeight+e.clientHeight+1:a.scrollTop>e.offsetTop-e.clientHeight&&(a.scrollTop=e.offsetTop-e.clientHeight+1)}else Ie(n,e)},Ft=t=>{let e=t.previousElementSibling,n=0;for(;e;)n++,e=e.previousElementSibling;return n},Rs=(t,e,n=!0)=>{let a=t.previousElementSibling;return a||(t.parentElement.previousElementSibling?a=t.parentElement.previousElementSibling.lastElementChild:t.parentElement.parentElement.tagName==="TBODY"&&t.parentElement.parentElement.previousElementSibling?a=t.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(e.selectNodeContents(a),n||e.collapse(!1),z(e)),a},tn=(t,e,n,a,i)=>{i.insertNode(document.createElement("wbr"));const s=n.outerHTML,l=n.querySelector("table"),o=l.rows[0].cells.length,r=l.rows.length,c=[];for(let u=0;u<r;u++){for(let d=0;d<o;d++)l.rows[u].cells[d].isSameNode(e[c.length])&&c.push(d);if(c.length>0)break}for(let u=0;u<r;u++)c.forEach(d=>{l.rows[u].cells[d].setAttribute("align",a)});j(t,n.getAttribute("data-node-id"),n.outerHTML,s),re(l,i)},ki=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let l="";for(let r=0;r<n.parentElement.childElementCount;r++)l+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let o;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${l}</tr>`),o=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${l}</tr></tbody>`),o=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${l}</tr>`),o=n.parentElement.nextElementSibling;e.selectNodeContents(o.cells[Ft(n)]),e.collapse(!0),z(e),j(t,a.getAttribute("data-node-id"),a.outerHTML,s),Ei(a,o,t)},Fs=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let l="",o=!1;for(let c=0;c<n.parentElement.childElementCount;c++){const u=n.parentElement.children[c];u.className==="fn__none"&&(o=!0),n.tagName==="TH"?l+=`<th class="${u.className}" colspan="${u.colSpan}" align="${u.getAttribute("align")}"></th>`:l+=`<td class="${u.className}" colspan="${u.colSpan}" align="${u.getAttribute("align")}"></td>`}if(o){let c=n.parentElement.previousElementSibling,u=1;for(;c;)u++,Array.from(c.children).forEach(d=>{d.rowSpan>=u&&d.rowSpan>1&&(d.rowSpan=d.rowSpan+1)}),c=c.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${l}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${l}</tr>`),r=n.parentElement.previousElementSibling),e.selectNodeContents(r.cells[Ft(n)]),e.collapse(!0),z(e),j(t,a.getAttribute("data-node-id"),a.outerHTML,s),Ei(a,r,t)},Za=(t,e,n,a,i)=>{const s=document.createElement("wbr");i.insertNode(s);const l=e.outerHTML;s.remove();const o=Ft(n),r=e.querySelector("table");for(let c=0;c<r.rows.length;c++){const u=r.rows[c].cells[o],d=document.createElement(u.tagName);u.insertAdjacentElement(a,d),u.isSameNode(n)?(d.innerHTML="<wbr> ",d.offsetLeft+d.clientWidth>e.firstElementChild.scrollLeft+e.firstElementChild.clientWidth&&(e.firstElementChild.scrollLeft=d.offsetLeft+d.clientWidth-e.firstElementChild.clientWidth)):d.textContent=" "}r.querySelectorAll("col")[o].insertAdjacentHTML(a,"<col>"),re(e,i),j(t,e.getAttribute("data-node-id"),e.outerHTML,l)},Us=(t,e,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();const l=Ft(n),o=n.parentElement.parentElement;let r=o.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),o.childElementCount===1?o.remove():n.parentElement.remove(),e.selectNodeContents(r.cells[l]),e.collapse(!0),z(e),Ei(a,r,t),j(t,a.getAttribute("data-node-id"),a.outerHTML,s)}},Ws=(t,e,n,a)=>{var i;const s=document.createElement("wbr");e.insertNode(s);const l=n.outerHTML;s.remove();const o=Ft(a),r=a.previousElementSibling||a.nextElementSibling;r&&(e.selectNodeContents(r),e.collapse(!0),r.offsetLeft+r.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=r.offsetLeft+r.clientWidth-n.firstElementChild.clientWidth));const c=n.querySelector("table");for(let u=0;u<c.rows.length;u++){const d=c.rows[u].cells;if(d.length===1){c.remove();break}d[o].remove()}(i=n.querySelectorAll("col")[o])==null||i.remove(),j(t,n.getAttribute("data-node-id"),n.outerHTML,l),z(e)},Ys=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="THEAD")return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const l=i.parentElement.previousElementSibling.firstElementChild;l.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.after(l),i.parentElement.previousElementSibling.append(i)}j(t,a.getAttribute("data-node-id"),a.outerHTML,s),re(a,e),Ie(t,i)},js=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const l=i.parentElement.nextElementSibling.firstElementChild;l.querySelectorAll("td").forEach(o=>{const r=document.createElement("th");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.querySelectorAll("th").forEach(o=>{const r=document.createElement("td");r.innerHTML=o.innerHTML,o.parentNode.replaceChild(r,o)}),i.after(l),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}j(t,a.getAttribute("data-node-id"),a.outerHTML,s),re(a,e),Ie(t,i)},zs=(t,e,n,a)=>{if(!n.previousElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((o,r)=>{if(n.isSameNode(o))return s=r,!0}),a.querySelectorAll("tr").forEach(o=>{o.cells[s].after(o.cells[s-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const l=a.querySelectorAll("col");l[s].after(l[s-1]),j(t,a.getAttribute("data-node-id"),a.outerHTML,i),re(a,e)},Vs=(t,e,n,a)=>{if(!n.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((o,r)=>{if(n.isSameNode(o))return s=r,!0}),a.querySelectorAll("tr").forEach(o=>{o.cells[s].before(o.cells[s+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const l=a.querySelectorAll("col");l[s].before(l[s+1]),j(t,a.getAttribute("data-node-id"),a.outerHTML,i),re(a,e)},Sr=(t,e,n)=>{var a,i,s;const l=R(n.startContainer,"TD")||R(n.startContainer,"TH"),o=I(n.startContainer);if(!l||!o||o.classList.contains("protyle-wysiwyg--select"))return!1;if(e.key==="Enter"&&e.shiftKey&&!Ce(e)&&!e.altKey){const v=document.createElement("wbr");n.insertNode(v);const L=o.outerHTML;if(v.remove(),l&&!l.innerHTML.endsWith("<br>")&&l.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),t.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const O=document.createElement("br");n.startContainer.after(O),n.setStartAfter(O)}else n.insertNode(document.createElement("br"));return n.collapse(!1),Ie(t),j(t,o.getAttribute("data-node-id"),o.outerHTML,L),e.preventDefault(),!0}if(!Ce(e)&&!e.shiftKey&&!e.altKey&&e.key==="Enter"){e.preventDefault();const v=l.parentElement;if(!v.nextElementSibling&&v.parentElement.tagName==="TBODY"||v.parentElement.tagName==="THEAD"&&!v.parentElement.nextElementSibling)return!0;let L=v.nextElementSibling;return L||(L=v.parentElement.nextElementSibling.firstChild),L&&(n.selectNodeContents(L.cells[Ft(l)]),n.collapse(!0),Ie(t)),!0}if(e.key==="ArrowRight"&&n.toString()===""&&!o.nextElementSibling&&l.isSameNode(o.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&Qe(l,t.wysiwyg.element,n).start===l.textContent.length)return e.preventDefault(),vt(t,"afterend",o.getAttribute("data-node-id")),!0;if(e.key==="Tab"&&!e.ctrlKey){if(e.shiftKey)return Rs(l,n),e.preventDefault(),!0;let v=l.nextElementSibling;return v||(l.parentElement.nextElementSibling?v=l.parentElement.nextElementSibling.firstElementChild:l.parentElement.parentElement.tagName==="THEAD"&&l.parentElement.parentElement.nextElementSibling?v=l.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:v=null),v?n.selectNodeContents(v):(ki(t,n,l,o),n.selectNodeContents(o.querySelector("tbody").lastElementChild.firstElementChild)),e.preventDefault(),!0}if(e.key==="ArrowUp"&&!Ce(e)&&!e.shiftKey&&!e.altKey){const v=n.startContainer;let L;for(v.nodeType!==3&&(v.tagName==="TH"||v.tagName==="TD")?L=(a=v.childNodes[Math.max(0,n.startOffset-1)])==null?void 0:a.previousElementSibling:v.parentElement.tagName==="SPAN"?L=v.parentElement.previousElementSibling:L=v.previousElementSibling;L;){if(L.tagName==="BR")return!1;L=L.previousElementSibling}const D=l.parentElement;let O=D.previousElementSibling;return O||(O=D.parentElement.previousElementSibling.lastElementChild),!O||(O==null?void 0:O.tagName)==="COL"?!1:(n.selectNodeContents(O.cells[Ft(l)]),n.collapse(!1),Ie(t),e.preventDefault(),!0)}if(e.key==="ArrowDown"&&!Ce(e)&&!e.shiftKey&&!e.altKey){const v=n.endContainer;let L;for(v.nodeType!==3&&(v.tagName==="TH"||v.tagName==="TD")?L=(i=v.childNodes[Math.max(0,n.endOffset-1)])==null?void 0:i.nextElementSibling:v.parentElement.tagName==="SPAN"?L=v.parentElement.nextElementSibling:L=v.nextElementSibling;L;){if(L.tagName==="BR"&&L.nextSibling)return!1;L=L.nextElementSibling}const D=l.parentElement;if(!D.nextElementSibling&&D.parentElement.tagName==="TBODY"||D.parentElement.tagName==="THEAD"&&!D.parentElement.nextElementSibling)return!1;let O=D.nextElementSibling;return O||(O=D.parentElement.nextElementSibling.firstChild),O?(n.selectNodeContents(O.cells[Ft(l)]),n.collapse(!0),Ie(t),e.preventDefault(),!0):!1}if(!Ce(e)&&!e.shiftKey&&!e.altKey&&e.key==="Backspace"&&Qe(l,t.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&l.querySelectorAll("br").length===1))return!Rs(l,n,!1)&&o.previousElementSibling&&ce(o.previousElementSibling,void 0,!1),Ie(t),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.general.alignLeft.custom,e))return tn(t,[l],o,"left",n),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.general.alignCenter.custom,e))return tn(t,[l],o,"center",n),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.general.alignRight.custom,e))return tn(t,[l],o,"right",n),e.preventDefault(),!0;const r=o.querySelector("table"),c=l.parentElement.querySelector(".fn__none");let u=!1,d=!1;Array.from(l.parentElement.children).forEach(v=>{v.colSpan>1&&(u=!0),v.rowSpan>1&&(d=!0)});let f=!1,p=!1,b=!1,m=l.parentElement.previousElementSibling;!m&&l.parentElement.parentElement.tagName==="TBODY"&&(m=r.querySelector("thead").lastElementChild),m&&(f=m.querySelector(".fn__none"),Array.from(m.children).forEach(v=>{v.colSpan>1&&(p=!0),v.rowSpan>1&&(b=!0)}));let h=!1,w=!1,y=!1,E=l.parentElement.nextElementSibling;!E&&l.parentElement.parentElement.tagName==="THEAD"&&(E=(s=r.querySelector("tbody"))==null?void 0:s.firstElementChild),E&&(h=E.querySelector(".fn__none"),Array.from(E.children).forEach(v=>{v.colSpan>1&&(w=!0),v.rowSpan>1&&(y=!0)}));const S=Ft(l);let x=!0;Array.from(r.rows).find(v=>{const L=v.cells[S];if(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1)return x=!1,!0});let k=!0;Array.from(r.rows).find(v=>{const L=v.cells[S+1];if(L&&(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1))return k=!1,!0});let C=!0;if(Array.from(r.rows).find(v=>{const L=v.cells[S-1];if(L&&(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1))return C=!1,!0}),J(window.siyuan.config.keymap.editor.table.moveToUp.custom,e))return(!c||c&&!d&&u)&&(!f||f&&!b&&p)&&Ys(t,n,l,o),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table.moveToDown.custom,e))return(!c||c&&!d&&u)&&(!h||h&&!y&&w)&&js(t,n,l,o),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table.moveToLeft.custom,e))return x&&C&&zs(t,n,l,o),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table.moveToRight.custom,e))return x&&k&&Vs(t,n,l,o),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,e))return Fs(t,n,l,o),e.preventDefault(),e.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,e))return(!h||h&&!y&&w)&&ki(t,n,l,o),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,e))return(x||C)&&Za(t,o,l,"beforebegin",n),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,e))return(x||k)&&Za(t,o,l,"afterend",n),e.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.table["delete-row"].custom,e))return(!c&&!d||c&&!d&&u)&&Us(t,n,l,o),e.preventDefault(),e.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.table["delete-column"].custom,e))return x&&Ws(t,n,o,l),e.preventDefault(),!0},nn=(t,e="outerHTML")=>{if(!t.querySelector("[data-type='block-render']"))return t[e];const n=t.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),n[e]},Ar=t=>{const e=document.createElement("template");return e.innerHTML=t,e.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{N(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.innerHTML},Gs=(t,e,n=!1)=>{if(H())return;const a=e.getBoundingClientRect();if(a.height===0||!t){Cn();return}let i=document.getElementById("tooltip");i?i.innerHTML=t:(document.body.insertAdjacentHTML("beforeend",`<div class="tooltip" id="tooltip">${t}</div>`),i=document.getElementById("tooltip")),n?i.classList.add("tooltip--error"):i.classList.remove("tooltip--error"),e.getAttribute("data-inline-memo-content")?i.classList.add("tooltip--memo"):i.classList.remove("tooltip--memo");let s=a.left,l=a.bottom;const o=e.getAttribute("data-position"),r=e.parentElement.getBoundingClientRect();o==="right"?s=a.right-i.clientWidth:o==="parentE"&&(l=r.top,s=r.right+8);const c=o==="parentE"?l:a.top,u=window.innerHeight-l;i.style.maxHeight=Math.max(c,u)+"px",l+i.clientHeight>window.innerHeight&&c>u?i.style.top=(o==="parentE"?r.bottom:a.top)-i.clientHeight+"px":i.style.top=l+"px",s+i.clientWidth>window.innerWidth?o==="parentE"?i.style.left=r.left-8-i.clientWidth+"px":i.style.left=window.innerWidth-i.clientWidth+"px":i.style.left=Math.max(0,s)+"px"},Cn=()=>{const t=document.getElementById("tooltip");t&&t.remove()},Xa=(t,e)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(t)?(e?Gs(window.siyuan.languages.fileNameRule,e,!0):oe(window.siyuan.languages.fileNameRule),!1):t.length>g.SIZE_TITLE?(e?Gs(window.siyuan.languages._kernel[106],e,!0):oe(window.siyuan.languages._kernel[106]),!1):!0,Ut=t=>t.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,g.SIZE_TITLE),wu=t=>t.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),Ks=t=>{if(window.siyuan.config.readonly)return;const e=new be({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px",destroyCallback(){t.range&&z(t.range)}}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(t.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(!Xa(n.value))return!1;if(n.value===t.name)return e.destroy(),!1;n.value.trim()===""?n.value="Untitled":n.value=Ut(n.value),t.type==="notebook"?_("/api/notebook/renameNotebook",{notebook:t.notebookId,name:n.value},()=>{hr(t.notebookId,n.value)}):_("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n.value}),e.destroy()})},Li=t=>{const e=new be({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()});const i=_s(t);n.value=i,n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(n.value===i||!n.value)return e.destroy(),!1;_("/api/asset/renameAsset",{oldPath:t,newName:n.value})})},Cr=t=>{if(getSelection().rangeCount===0)return;const e=getSelection().getRangeAt(0),n=I(e.startContainer);if(!n)return;let a=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let i="",s=e.toString();if(s===""){if(s=a[0].textContent,a.forEach(l=>{i+=nn(l)}),!s)return}else{const l=document.createElement("div");l.appendChild(e.cloneContents()),i=l.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=Ut(s),_("/api/filetree/createDoc",{notebook:t.notebookId,path:we().join(ze(t.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:t.lute.BlockDOM2StdMd(i)})},yu=(t,e)=>{},Tr=t=>{const e=new be({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${H()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${H()?"padding: 16px;margin: 16px 0":"padding: 48px;margin: 8px 0 24px"};border: 1px solid var(--b3-border-color);border-radius: var(--b3-border-radius-b);" class="export-img protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}" id="preview"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[g.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <span class="fn__flex-1"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:H()?"92vw":"990px",height:"70vh"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{const l=oe(window.siyuan.languages.exporting,0);e.element.querySelector(".b3-dialog__container").style.height="",et(g.LOCAL_EXPORTIMG,window.siyuan.storage[g.LOCAL_EXPORTIMG]),setTimeout(()=>{fe("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(a.parentElement,{useCORS:!0}).then(o=>{o.toBlob(r=>{const c=new FormData;c.append("file",r,n[1].getAttribute("data-title")),c.append("type","image/png"),_("/api/export/exportAsFile",c,u=>{Nt(u.data.file)}),je(l),e.destroy()})})})},g.TIMEOUT_LOAD)});const a=e.element.querySelector("#preview"),i=e.element.querySelector("#keepFold");i.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[g.LOCAL_EXPORTIMG].keepFold=i.checked,_("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},l=>{s(l)})});const s=l=>{a.innerHTML=l.data.content,Oe(a),Ae(a),a.querySelectorAll("table").forEach(o=>{o.clientWidth>o.parentElement.clientWidth&&(o.setAttribute("style",`margin-bottom:${o.parentElement.clientWidth*o.clientHeight/o.clientWidth-o.parentElement.clientHeight+1}px;transform: scale(${o.parentElement.clientWidth/o.clientWidth});transform-origin: top left;`),o.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(o=>{const r=o.firstElementChild.getAttribute("xlink:href"),c=document.querySelectorAll(r);let u="0 0 32 32";r==="#iconDot"&&(u="0 0 20 20"),o.setAttribute("viewBox",u),o.innerHTML=c[c.length-1].innerHTML}),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),e.element.querySelector(".fn__loading").remove()};_("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},l=>{s(l),n[1].setAttribute("data-title",l.data.name+".png")})},Zs=(t,e)=>{const n=new ut("av-header-add"),a=e.getAttribute("data-av-id");return n.addItem({icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:a,type:"text",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"text",name:window.siyuan.languages.text,id:i})}}),n.addItem({icon:"iconNumber",label:window.siyuan.languages.number,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:a,type:"number",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"number",name:window.siyuan.languages.number,id:i})}}),n.addItem({icon:"iconListItem",label:window.siyuan.languages.select,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:a,type:"select",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"select",name:window.siyuan.languages.select,id:i})}}),n.addItem({icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:a,type:"mSelect",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"mSelect",name:window.siyuan.languages.multiSelect,id:i})}}),n.addItem({icon:"iconCalendar",label:window.siyuan.languages.date,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:a,type:"date",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"date",name:window.siyuan.languages.date,id:i})}}),n.addItem({icon:"iconImage",label:window.siyuan.languages.assets,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:a,type:"mAsset",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"mAsset",name:window.siyuan.languages.assets,id:i})}}),n.addItem({icon:"iconLink",label:window.siyuan.languages.link,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:a,type:"url",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"url",name:window.siyuan.languages.link,id:i})}}),n.addItem({icon:"iconEmail",label:window.siyuan.languages.email,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:a,type:"email",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"email",name:window.siyuan.languages.email,id:i})}}),n.addItem({icon:"iconPhone",label:window.siyuan.languages.phone,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:a,type:"phone",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"phone",name:window.siyuan.languages.phone,id:i})}}),n.addItem({icon:"iconMath",label:window.siyuan.languages.template,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:a,type:"template",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"template",name:window.siyuan.languages.template,id:i})}}),n.addItem({icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:a,type:"created",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"created",name:window.siyuan.languages.createdTime,id:i})}}),n.addItem({icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const i=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:a,type:"updated",id:i}],[{action:"removeAttrViewCol",id:i,avID:a}]),xt({blockElement:e,protyle:t,type:"updated",name:window.siyuan.languages.updatedTime,id:i})}}),n},bn=(t,e,n="b3-list-item--focus")=>{var a;let i=t.querySelector("."+n);const s=n.split("--")[0];if(e.key==="ArrowDown")return e.preventDefault(),e.stopPropagation(),i.classList.remove(n),i.nextElementSibling?i.nextElementSibling.classList.contains(s)?i.nextElementSibling.classList.add(n):i.nextElementSibling.nextElementSibling.classList.add(n):t.children[0].classList.add(n),i=t.querySelector("."+n),(t.scrollTop<i.offsetTop-t.clientHeight+i.clientHeight||t.scrollTop>i.offsetTop)&&i.scrollIntoView(t.scrollTop>i.offsetTop),i;if(e.key==="ArrowUp"){if(e.preventDefault(),e.stopPropagation(),i.classList.remove(n),i.previousElementSibling)i.previousElementSibling.classList.contains(s)?i.previousElementSibling.classList.add(n):i.previousElementSibling.previousElementSibling.classList.add(n);else{const o=t.children.length;t.children[o-1].classList.add(n)}i=t.querySelector("."+n);const l=t.scrollTop>i.offsetTop-(((a=i.previousElementSibling)==null?void 0:a.clientHeight)||0);return(t.scrollTop<i.offsetTop-t.clientHeight+i.clientHeight||l)&&i.scrollIntoView(l),i}},_u=t=>{},Xs=(t,e,n,a)=>{},Qs=t=>{if(yt()){window.JSAndroid.writeImageClipboard(t.getAttribute("src"));return}else{const e=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{e.width=a.target.width,e.height=a.target.height,e.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),e.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:i})])},"image/png",1)},n.src=t.getAttribute("src")}},Wt=(t,e)=>{const n=t.parentElement,a=t.querySelector("use");n.classList.contains("av__row--header")||e==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"?n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck"),i.parentElement.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck"),i.parentElement.classList.add("av__row--select")}):e==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&e==="toggle"?(t.parentElement.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(e==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&e==="toggle")&&(t.parentElement.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),ce(I(n)),Un(n)},Un=t=>{const e=I(t);if(!e)return;const n=t.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=t.parentElement.childElementCount-3-n,i=t.parentElement.firstElementChild,s=i.querySelector("use"),l=e.querySelector(".av__counter"),o=e.querySelector(".av__header");if(a===0&&t.parentElement.childElementCount-3!==0)i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck");else if(a===t.parentElement.childElementCount-3){i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck"),l.classList.add("fn__none"),o.style.position="";return}else a>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));l.classList.remove("fn__none"),l.innerHTML=`${n} selected`,o.style.position="sticky"},xi=(t,e,n,a)=>{const i=t.querySelector(`.av__row[data-id="${n}"]`)||t.querySelector(".av__row--header");let s="";i.querySelectorAll(".av__cell").forEach(o=>{s+=`<div class="av__cell" style="width: ${o.style.width}" ${o.getAttribute("data-block-id")?' data-detached="true"':""}><span class="av__pulse"></span></div>`});let l="";new Array(e).fill(1).forEach(()=>{l+=`<div class="av__row" data-avid="${a}">
    <div style="width: 24px"></div>
    ${s}
</div>`}),i.insertAdjacentHTML("afterend",l)};class $r{constructor(e=""){this.eventTarget=document.appendChild(document.createComment(e))}on(e,n){this.eventTarget.addEventListener(e,n)}once(e,n){this.eventTarget.addEventListener(e,n,{once:!0})}off(e,n){this.eventTarget.removeEventListener(e,n)}emit(e,n){return this.eventTarget.dispatchEvent(new CustomEvent(e,{detail:n}))}}const ft=t=>{const e=new Lr;t.detail.menu=e,t.plugins.forEach(n=>{n.eventBus.emit(t.type,t.detail)}),e.menus.length>0&&(t.separatorPosition==="top"&&window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:e.menus}).element),t.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new T({type:"separator"}).element))},Si=t=>{fe(`${g.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{const e=document.createElement("ul");e.innerHTML=`<li><img src="${t}"></li>`,window.siyuan.viewer=new Viewer(e,{title:[1,(n,a)=>{let i=n.alt;return i||(i=n.src.substring(n.src.lastIndexOf("/")+1)),i=i.substring(0,i.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${i} [${a.naturalWidth} \xD7 ${a.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},Js=(t,e)=>{fe(`${g.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{_("/api/asset/getDocImageAssets",{id:e},n=>{const a=document.createElement("ul");let i="",s=-1;n.data.forEach((l,o)=>{l&&(i+=`<li><img src="${l}"></li>`,s===-1&&(t.endsWith(encodeURI(l))||t.endsWith(l))&&(s=o))}),a.innerHTML=i,window.siyuan.viewer=new Viewer(a,{title:[1,(l,o)=>{let r=l.alt;return r||(r=l.src.substring(l.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${o.naturalWidth} \xD7 ${o.naturalHeight}]`}],button:!1,initialViewIndex:s,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},Ir=(t,e)=>{const n=I(e.target);if(!n)return!1;if(e.shiftKey){const y=N(e.target,"av__row");if(y&&!y.classList.contains("av__row--header"))return Wt(y.querySelector(".av__firstcol"),"toggle"),!0}const a=A(e.target,"data-type","copy");if(a)return Pe(a.previousElementSibling.textContent.trim()),oe(window.siyuan.languages.copied),e.preventDefault(),e.stopPropagation(),!0;if(t.disabled)return!1;const i=A(e.target,"data-type","av-header-add");if(i){const y=Zs(t,n),E=i.getBoundingClientRect();return y.open({x:E.left,y:E.bottom,h:E.height}),e.preventDefault(),e.stopPropagation(),!0}const s=N(e.target,"av__gutters");if(s){const y=s.getBoundingClientRect();return Ai(t,s.parentElement,{x:y.left,y:y.bottom,w:y.width,h:y.height}),e.preventDefault(),e.stopPropagation(),!0}const l=N(e.target,"av__firstcol");if(l)return window.siyuan.menus.menu.remove(),Wt(l,"toggle"),e.preventDefault(),e.stopPropagation(),!0;if(A(e.target,"data-type","av-header-more"))return wn({protyle:t,blockElement:n,type:"properties"}),e.preventDefault(),e.stopPropagation(),!0;if(A(e.target,"data-type","av-more"))return wn({protyle:t,blockElement:n,type:"config"}),e.preventDefault(),e.stopPropagation(),!0;if(A(e.target,"data-type","av-sort"))return wn({protyle:t,blockElement:n,type:"sorts"}),e.preventDefault(),e.stopPropagation(),!0;if(A(e.target,"data-type","av-filter"))return wn({protyle:t,blockElement:n,type:"filters"}),e.preventDefault(),e.stopPropagation(),!0;const d=N(e.target,"av__celltext--url");if(d){let y=d.textContent.trim();return d.dataset.type==="phone"?y="tel:"+y:d.dataset.type==="email"?y="mailto:"+y:d.classList.contains("b3-chip")&&(y=d.dataset.url),window.open(y),e.preventDefault(),e.stopPropagation(),!0}const f=N(e.target,"av__cellassetimg");if(f)return Si(f.src),e.preventDefault(),e.stopPropagation(),!0;const p=N(e.target,"av__cellheader");if(p)return Rl(t,n,p.parentElement),e.preventDefault(),e.stopPropagation(),!0;const b=A(e.target,"data-type","block-more");if(b)return t.toolbar.range=document.createRange(),t.toolbar.range.selectNodeContents(b),z(t.toolbar.range),Hn(b.previousElementSibling.textContent.trim(),t,"av"),e.preventDefault(),e.stopPropagation(),!0;const m=N(e.target,"av__cell");if(m&&!m.parentElement.classList.contains("av__row--header")){const y=m.parentElement.parentElement.firstElementChild.querySelector(`[data-col-id="${m.getAttribute("data-col-id")}"]`).getAttribute("data-dtype");return y==="updated"||y==="created"||y==="block"&&!m.getAttribute("data-detached")?Wt(m.parentElement.querySelector(".av__firstcol"),"toggle"):(m.parentElement.parentElement.querySelectorAll(".av__row--select").forEach(E=>{E.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),E.classList.remove("av__row--select")}),Un(m.parentElement),yn(t,[m])),e.preventDefault(),e.stopPropagation(),!0}const h=N(e.target,"av__calc");if(h)return Wr(t,h),e.preventDefault(),e.stopPropagation(),!0;const w=N(e.target,"av__row--add");if(w){const y=n.getAttribute("data-av-id"),E=[Lute.NewNodeID()],S=w.previousElementSibling.getAttribute("data-id")||"";return F(t,[{action:"insertAttrViewBlock",avID:y,previousID:S,srcIDs:E,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:E,avID:y}]),xi(n,1,S,y),yn(t,[w.previousElementSibling.querySelector('[data-detached="true"]')],"block"),e.preventDefault(),e.stopPropagation(),!0}return!1},Ai=(t,e,n)=>{var a;if(e.classList.contains("av__row--header"))return!1;const i=I(e);if(!i)return!1;e.classList.contains("av__row--select")||(i.querySelectorAll(".av__row--select").forEach(u=>{u.classList.remove("av__row--select")}),i.querySelectorAll(".av__firstcol use").forEach(u=>{u.setAttribute("xlink:href","#iconUncheck")}));const s=new ut("av-row-menu");if(s.isOpen)return!0;e.classList.add("av__row--select"),e.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const l=[],o=[],r=i.querySelectorAll(".av__row--select:not(.av__row--header)");r.forEach(u=>{l.push(u.getAttribute("data-id")),o.push(u.querySelector(".av__cell").getAttribute("data-block-id"))}),Un(e),s.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){const u=r[0].previousElementSibling;F(t,[{action:"removeAttrViewBlock",srcIDs:o,avID:i.getAttribute("data-av-id")}],[{action:"insertAttrViewBlock",avID:i.getAttribute("data-av-id"),previousID:(u==null?void 0:u.getAttribute("data-id"))||"",srcIDs:l}]),r.forEach(d=>{d.remove()}),Un(u)}}),l.length===1&&(s.addSeparator(),Xs(t.app,l[0]),s.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:ma(l[0])})),s.addSeparator();const c=[];return e.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(u=>{let d=!1;const f=Array.from(i.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${u.dataset.colId}"]`));u.dataset.dtype==="block"&&f.find(b=>{if(!b.dataset.detached)return d=!0,!0});const p=u.getAttribute("data-dtype");if(!d&&!["updated","created"].includes(p)){const b=u.dataset.icon;c.push({iconHTML:b?le(b,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Lt(p)}"></use></svg>`,label:u.querySelector(".av__celltext").textContent.trim(),click(){yn(t,f)}})}}),s.addItem({icon:"iconAttr",label:window.siyuan.languages.attr,type:"submenu",submenu:c}),(a=t==null?void 0:t.app)!=null&&a.plugins&&ft({plugins:t.app.plugins,type:"open-menu-av",detail:{protyle:t,element:i,selectRowElements:r},separatorPosition:"top"}),s.open(n),!0},Qa=(t,e)=>{const n=e.getAttribute("data-av-id"),a=e.getAttribute("data-node-id"),i=e.querySelector(".av__title"),s=i.textContent.trim();if(s===i.dataset.title.trim())return;const l=ee().format("YYYYMMDDHHmmss");F(t,[{action:"setAttrViewName",id:n,data:s},{action:"doUpdateUpdated",id:a,data:l}],[{action:"setAttrViewName",id:n,data:i.dataset.title},{action:"doUpdateUpdated",id:a,data:e.getAttribute("updated")}]),e.setAttribute("updated",l),i.dataset.title=s,e.querySelector(".layout-tab-bar .item__text").textContent=s},Tt=t=>{t.style.opacity="0.38",t.style.backgroundColor="var(--b3-theme-surface-light)"},el=(t,e)=>{t.querySelectorAll(`.av__cell[data-col-id="${e}"]`).forEach(n=>{n.remove()})},Ci=(t,e)=>{let n="",a=!1;if(e&&e.forEach(i=>{(!t||t.toLowerCase().indexOf(i.name.toLowerCase())>-1||i.name.toLowerCase().indexOf(t.toLowerCase())>-1)&&(n+=`<button data-type="addColOptionOrCell" class="b3-menu__item${n?"":" b3-menu__item--current"}" draggable="true" data-name="${i.name}" data-color="${i.color}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">
            <span class="fn__ellipsis">${i.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`),t===i.name&&(a=!0)}),!a&&t){const i=((e==null?void 0:e.length)||0)%13+1;n=`<button data-type="addColOptionOrCell" class="b3-menu__item${n?"":" b3-menu__item--current"}" data-name="${t}" data-color="${i}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${i});color:var(--b3-font-color${i})">
        <span class="fn__ellipsis">${t}</span>
    </span>
</div>
<span class="b3-menu__accelerator">Enter</span>
</button>${n}`}return n},tl=(t,e,n,a)=>{if(!a)return;const i=n[0].dataset.colId,s=[],l=[];let o;n.forEach((r,c)=>{var u;const d=r.parentElement.dataset.id,f=r.dataset.id;let p;e.view.rows.find(m=>{if(m.id===d)return m.cells.find(h=>{if(h.id===f)return p=h,!0}),!0});const b=Object.assign([],p.value.mSelect);c===0?((u=p.value.mSelect)==null||u.find((m,h)=>{if(m.content===a.dataset.content)return p.value.mSelect.splice(h,1),!0}),o=p.value.mSelect):p.value.mSelect=o,s.push({action:"updateAttrViewCell",id:f,keyID:i,rowID:d,avID:e.id,data:p.value}),l.push({action:"updateAttrViewCell",id:f,keyID:i,rowID:d,avID:e.id,data:{mSelect:b}}),r.classList.contains("custom-attr__avvalue")?r.innerHTML=_n(p.value):Tt(r)}),F(t,s,l),a.remove()},Dr=(t,e,n,a)=>{const i=N(n,"b3-menu");if(!i)return;const s=a?a[0].dataset.colId:i.querySelector(".b3-menu__item").getAttribute("data-col-id");let l=n.parentElement.dataset.name,o=n.parentElement.dataset.color;const r=new ut("av-col-option",()=>{l!==u.value&&(F(t,[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{newColor:o,oldName:l,newName:u.value}}],[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{newColor:o,oldName:u.value,newName:l}}]),e.view.columns.find(d=>{if(d.id===s)return d.options.find(f=>{if(f.name===l)return f.name=u.value,!0}),!0}),a?(a.forEach(d=>{e.view.rows.find(f=>{if(f.id===d.parentElement.dataset.id)return f.cells.find(p=>{if(p.id===d.dataset.id)return p.value.mSelect.find(b=>{if(b.content===l)return b.content=u.value,!0}),d.classList.contains("custom-attr__avvalue")?d.innerHTML=_n(p.value):Tt(d),!0}),!0})}),i.innerHTML=Yn(e.view,a),Wn(t,e,i,a)):(i.innerHTML=rn({protyle:t,data:e,colId:s}),cn({protyle:t,data:e,menuElement:i})))});if(r.isOpen)return;r.addItem({iconHTML:"",label:`<input class="b3-text-field" style="margin: 4px 0" value="${l}">`,bind(d){d.querySelector("input").addEventListener("keydown",f=>{f.isComposing||f.key==="Enter"&&r.close()})}}),r.addItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){Te(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let d=[];e.view.columns.find(p=>{if(p.id===s)return d=p.options,!0});const f=n.parentElement.dataset.name;F(t,[{action:"removeAttrViewColOption",id:s,avID:e.id,data:f}],[{action:"updateAttrViewColOptions",id:s,avID:e.id,data:d}]),d.find((p,b)=>{if(p.name===f)return d.splice(b,1),!0}),a?(a.forEach(p=>{e.view.rows.find(b=>{if(b.id===p.parentElement.dataset.id)return b.cells.find(m=>{if(m.id===p.dataset.id)return m.value.mSelect.find((h,w)=>{if(h.content===f)return m.value.mSelect.splice(w,1),!0}),p.classList.contains("custom-attr__avvalue")?p.innerHTML=_n(m.value):Tt(p),!0}),!0})}),i.innerHTML=Yn(e.view,a),Wn(t,e,i,a)):(i.innerHTML=rn({protyle:t,data:e,colId:s}),cn({protyle:t,data:e,menuElement:i}))})}}),r.addSeparator(),Array.from(Array(13).keys()).forEach(d=>{r.addItem({accelerator:parseInt(o)===d+1?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,iconHTML:"",label:`<span class="color__square"  style="padding: 5px;margin: 2px;color: var(--b3-font-color${d+1});background-color: var(--b3-font-background${d+1});">A</span>`,click(f){var p;if(!f.lastElementChild.classList.contains("b3-menu__accelerator"))return(p=f.parentElement.querySelector(".b3-menu__accelerator"))==null||p.remove(),f.insertAdjacentHTML("beforeend",'<span class="b3-menu__accelerator"><svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg></span>'),F(t,[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{oldName:l,newName:u.value,oldColor:o,newColor:(d+1).toString()}}],[{action:"updateAttrViewColOption",id:s,avID:e.id,data:{oldName:u.value,newName:l,oldColor:(d+1).toString(),newColor:o}}]),e.view.columns.find(b=>{if(b.id===s)return b.options.find(m=>{if(m.name===l)return m.name=u.value,m.color=(d+1).toString(),!0}),!0}),a?(a.forEach(b=>{e.view.rows.find(m=>{if(m.id===b.parentElement.dataset.id)return m.cells.find(h=>{if(h.id===b.dataset.id)return h.value.mSelect.find(w=>{if(w.content===l)return w.content=u.value,w.color=(d+1).toString(),!0}),b.classList.contains("custom-attr__avvalue")?b.innerHTML=_n(h.value):Tt(b),!0}),!0})}),i.innerHTML=Yn(e.view,a),Wn(t,e,i,a)):(i.innerHTML=rn({protyle:t,data:e,colId:s}),cn({protyle:t,data:e,menuElement:i})),l=u.value,o=(d+1).toString(),!0}})});const c=n.getBoundingClientRect();r.open({x:c.right,y:c.bottom,w:c.width,h:c.height});const u=window.siyuan.menus.menu.element.querySelector("input");u.select()},Wn=(t,e,n,a)=>{const i=n.querySelector("input"),s=a[0].dataset.colId;let l;e.view.columns.find(r=>{if(r.id===s){l=r;return}}),l.options||(l.options=[]);const o=n.lastElementChild.lastElementChild;i.addEventListener("input",r=>{r.isComposing||(o.innerHTML=Ci(i.value,l.options))}),i.addEventListener("compositionend",r=>{r.isComposing||(o.innerHTML=Ci(i.value,l.options))}),i.addEventListener("keydown",r=>{if(r.isComposing)return;let c=bn(o,r,"b3-menu__item--current");r.key==="Enter"?(c||(c=n.querySelector(".b3-menu__item--current")),nl(t,e,a,c,n)):r.key==="Backspace"&&i.value===""?tl(t,e,a,i.previousElementSibling):r.key==="Escape"&&n.parentElement.remove()})},nl=(t,e,n,a,i)=>{let s=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(f=>{if(f.dataset.content===a.dataset.name)return s=!0,!0}),s){i.querySelector("input").focus();return}const l=n[0].dataset.colId;let o;Array.from(n[0].parentElement.querySelectorAll(".av__cell")).find((f,p)=>{if(f.dataset.id===n[0].dataset.id)return o=p,!0});let r;e.view.columns.find(f=>{if(f.id===l){r=f,r.options||(r.options=[]);return}});const c=[],u=[];let d;n.forEach((f,p)=>{let b;const m=f.parentElement.dataset.id;e.view.rows.find(w=>{if(w.id===m)return typeof o=="number"?(b=w.cells[o],b.id=f.dataset.id,(!b.value||!b.value.mSelect)&&(b.value={mSelect:[]})):b=w.cells.find(y=>{if(y.id===f.dataset.id)return!0}),!0});const h=Object.assign([],b.value.mSelect);if(r.type==="mSelect")if(p===0){let w=!1;b.value.mSelect.find(y=>{if(y.content===a.dataset.name)return w=!0,!0}),w||b.value.mSelect.push({color:a.dataset.color,content:a.dataset.name}),d=b.value.mSelect}else b.value.mSelect=d;else p===0?(b.value.mSelect=[{color:a.dataset.color,content:a.dataset.name}],d=b.value.mSelect):b.value.mSelect=d;c.push({action:"updateAttrViewCell",id:b.id,keyID:l,rowID:m,avID:e.id,data:b.value}),u.push({action:"updateAttrViewCell",id:b.id,keyID:l,rowID:m,avID:e.id,data:{[r.type]:h}}),f.classList.contains("custom-attr__avvalue")?f.innerHTML=_n(b.value):Tt(f)}),a.querySelector(".b3-menu__accelerator")?(r.options.push({color:a.dataset.color,name:a.dataset.name}),c.splice(0,0,{action:"updateAttrViewColOptions",id:l,avID:e.id,data:r.options}),F(t,c,[{action:"removeAttrViewColOption",id:l,avID:e.id,data:a.dataset.name}])):F(t,c,u),r.type==="select"?i.parentElement.remove():(i.innerHTML=Yn(e.view,n),Wn(t,e,i,n),i.querySelector("input").focus())},Yn=(t,e)=>{const n=e[0].dataset.colId,a=t.columns.find(l=>{if(l.id===n)return l});let i=[];t.rows.find(l=>{if(e[0].parentElement.dataset.id===l.id)return l.cells.find(o=>{if(o.id===e[0].dataset.id)return o.value&&o.value.mSelect&&(i=o.value.mSelect),!0}),!0});let s="";return i.forEach(l=>{s+=`<div class="b3-chip b3-chip--middle" data-content="${l.content}" style="background-color:var(--b3-font-background${l.color});color:var(--b3-font-color${l.color})">${l.content}<svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips">
    ${s}
    <input>
</div>
<div>${Ci("",a.options)}</div>
</div>`},Ti=t=>{if(t==="number"||t==="select")return"=";if(["text","mSelect","url","block","email","phone","template"].includes(t))return"Contains"},al=(t,e,n)=>{const a=N(t,"b3-menu");a&&a.querySelectorAll("input, .b3-chip").forEach((i,s)=>{const l=N(i,"b3-menu__item");l&&(["date","updated","created"].includes(n)?e==="Is between"?l.classList.remove("fn__none"):e==="Is empty"||e==="Is not empty"?l.classList.add("fn__none"):s===0?l.classList.remove("fn__none"):l.classList.add("fn__none"):e!=="Is empty"&&e!=="Is not empty"?l.classList.remove("fn__none"):l.classList.add("fn__none"))})},$i=t=>{var e,n;let a=t.target.getBoundingClientRect();a.height===0&&(a=t.protyle.wysiwyg.element.querySelector(`[data-col-id="${t.target.dataset.colId}"]`).getBoundingClientRect());const i=new ut("set-filter-"+t.filter.column,()=>{const c=JSON.parse(JSON.stringify(t.data.view.filters)),u=window.siyuan.menus.menu.element.querySelector(".b3-select").value;let d=!1,f;if(r.length>0)["date","updated","created"].includes(l.type)?f=pa(l.type,{isNotEmpty2:r[1].value!=="",isNotEmpty:r[0].value!=="",content:new Date(r[0].value).getTime(),content2:new Date(r[1].value).getTime(),hasEndDate:u==="Is between"}):f=pa(l.type,r[0].value);else{const h=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(w=>{if(w.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const y=w.nextElementSibling.firstElementChild;h.push({color:y.dataset.color,content:y.dataset.name})}}),h.length===0&&h.push({color:"",content:""}),f=pa(l.type,h)}const p={column:t.filter.column,value:f,operator:u};let b=!1;if(t.data.view.filters.find((h,w)=>{if(h.column===t.filter.column)return Ue(h,p)?(b=!0,!0):(t.data.view.filters[w]=p,d=!0,!0)}),b||!d)return;F(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters}],[{action:"setAttrViewFilters",avID:t.data.id,data:c}]);const m=N(t.target,"b3-menu");m&&(m.innerHTML=hn(t.data.view))});if(i.isOpen)return;let s="",l;switch(t.data.view.columns.find(c=>{if(c.id===t.filter.column)return l=c,!0}),l.type){case"block":case"text":case"url":case"phone":case"email":s=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":s=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":s=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${t.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":s=`<option ${t.filter.operator==="="?"selected":""} value="=">=</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"select":l.type==="select"?s=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`:s=`<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(i.addItem({iconHTML:"",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${s}</select>`}),l.type==="select"||l.type==="mSelect")(e=l.options)==null||e.forEach(c=>{var u;let d="iconUncheck";(u=t.filter.value)==null||u.mSelect.find(f=>{f.content===c.name&&(d="iconCheck")}),i.addItem({icon:d,label:`<span class="b3-chip b3-chip--middle" data-name="${c.name}" data-color="${c.color}" style="margin:3px 0;background-color:var(--b3-font-background${c.color});color:var(--b3-font-color${c.color})">
    <span class="fn__ellipsis">${c.name}</span>
</span>`,bind(f){f.addEventListener("click",()=>{const p=f.querySelector("use");p.getAttribute("xlink:href")==="#iconUncheck"?p.setAttribute("xlink:href","#iconCheck"):p.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template"].includes(l.type))i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${t.filter.value?t.filter.value[l.type].content:""}" class="b3-text-field fn__size200">`});else if(l.type==="number")i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${(n=t.filter.value)!=null&&n.number.isNotEmpty?t.filter.value.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(l.type)){const c=t.filter.value?t.filter.value[l.type]:null;i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${c.isNotEmpty||l.type!=="date"?ee(c.content).format("YYYY-MM-DDTHH:mm"):""}" type="datetime-local" class="b3-text-field fn__size200">`}),i.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${c.isNotEmpty2?ee(c.content2).format("YYYY-MM-DDTHH:mm"):""}" type="datetime-local" class="b3-text-field fn__size200">`})}i.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){const c=Object.assign([],t.data.view.filters);t.data.view.filters.find((d,f)=>{if(d.column===t.filter.column)return t.data.view.filters.splice(f,1),!0}),F(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters}],[{action:"setAttrViewFilters",avID:t.data.id,data:c}]);const u=N(t.target,"b3-menu");u&&(u.innerHTML=hn(t.data.view))}});const o=window.siyuan.menus.menu.element.querySelector(".b3-select");o.addEventListener("change",()=>{al(o,o.value,l.type)});const r=window.siyuan.menus.menu.element.querySelectorAll(".b3-text-field");r.forEach(c=>{c.addEventListener("keydown",u=>{if(u.isComposing){u.preventDefault();return}u.key==="Enter"&&(i.close(),u.preventDefault())})}),al(o,o.value,l.type),i.open({x:a.left,y:a.bottom}),r.length>0&&r[0].select()},Mr=t=>{const e=new ut("av-add-filter");t.data.view.columns.forEach(n=>{let a=!1;t.data.view.filters.find(i=>{if(i.column===n.id)return a=!0,!0}),!a&&n.type!=="mAsset"&&e.addItem({label:n.name,iconHTML:n.icon?le(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Lt(n.type)}"></use></svg>`,click:()=>{const i=Object.assign([],t.data.view.filters),s=pa(n.type,"");t.data.view.filters.push({column:n.id,operator:Ti(n.type),value:s}),F(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters}],[{action:"setAttrViewFilters",avID:t.data.id,data:i}]),t.menuElement.innerHTML=hn(t.data.view),Le(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height);const l=t.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);$i({filter:{operator:Ti(n.type),column:n.id,value:s},protyle:t.protyle,data:t.data,target:l})}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},hn=t=>{let e="";const n=a=>{let i="";return t.columns.find(s=>{var l,o,r,c,u,d,f,p,b,m,h,w,y,E,S,x,k,C,v,L,D,O,P,Z,pe,K,te,ue;if(s.id===a.column){let ye="";if(a.operator==="Is empty")ye=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(a.operator==="Is not empty")ye=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if((o=(l=a.value)==null?void 0:l.date)!=null&&o.content)(c=(r=a.value)==null?void 0:r.date)!=null&&c.content2&&a.operator==="Is between"?ye=` ${window.siyuan.languages.filterOperatorIsBetween} ${ee(a.value.date.content).format("YYYY-MM-DD HH:mm")} ${ee(a.value.date.content2).format("YYYY-MM-DD HH:mm")}`:a.operator==="="?ye=`: ${ee(a.value.date.content).format("YYYY-MM-DD HH:mm")}`:[">","<"].includes(a.operator)?ye=` ${a.operator} ${ee(a.value.date.content).format("YYYY-MM-DD HH:mm")}`:a.operator===">="?ye=` \u2265 ${ee(a.value.date.content).format("YYYY-MM-DD HH:mm")}`:a.operator==="<="&&(ye=` \u2264 ${ee(a.value.date.content).format("YYYY-MM-DD HH:mm")}`);else if(((d=(u=a.value)==null?void 0:u.mSelect)==null?void 0:d.length)>0){let ae="";a.value.mSelect.forEach((Ze,ve)=>{ae+=Ze.content,ve!==a.value.mSelect.length-1&&(ae+=", ")}),a.operator==="Contains"?ye=`: ${ae}`:a.operator==="Does not contains"&&(ye=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${ae}`)}else if((p=(f=a.value)==null?void 0:f.number)!=null&&p.content)["=","!=",">","<"].includes(a.operator)?ye=` ${a.operator} ${a.value.number.content}`:a.operator===">="?ye=` \u2265 ${a.value.number.content}`:a.operator==="<="&&(ye=` \u2264 ${a.value.number.content}`);else if((m=(b=a.value)==null?void 0:b.text)!=null&&m.content||(w=(h=a.value)==null?void 0:h.block)!=null&&w.content||(E=(y=a.value)==null?void 0:y.url)!=null&&E.content||(x=(S=a.value)==null?void 0:S.phone)!=null&&x.content||(C=(k=a.value)==null?void 0:k.email)!=null&&C.content){const ae=((L=(v=a.value)==null?void 0:v.text)==null?void 0:L.content)||((O=(D=a.value)==null?void 0:D.block)==null?void 0:O.content)||((Z=(P=a.value)==null?void 0:P.url)==null?void 0:Z.content)||((K=(pe=a.value)==null?void 0:pe.phone)==null?void 0:K.content)||((ue=(te=a.value)==null?void 0:te.email)==null?void 0:ue.content);["=","Contains"].includes(a.operator)?ye=`: ${ae}`:a.operator==="Does not contains"?ye=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${ae}`:a.operator==="!="?ye=` ${window.siyuan.languages.filterOperatorIsNot} ${ae}`:a.operator==="Starts with"?ye=` ${window.siyuan.languages.filterOperatorStartsWith} ${ae}`:a.operator==="Ends with"&&(ye=` ${window.siyuan.languages.filterOperatorEndsWith} ${ae}`)}return i+=`<span data-type="setFilter" class="b3-chip${ye?" b3-chip--primary":""}">
    ${s.icon?le(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Lt(s.type)}"></use></svg>`}
    <span class="fn__ellipsis">${s.name}${ye}</span>
</span>`,!0}}),i};return t.filters.forEach(a=>{e+=`<button class="b3-menu__item" draggable="true" data-id="${a.column}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${n(a)}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goConfig">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${e}
<button class="b3-menu__item${t.filters.length===t.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${e?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Hr=t=>{const e=new ut("av-add-sort");t.data.view.columns.forEach(n=>{let a=!1;t.data.view.sorts.find(i=>{if(i.column===n.id)return a=!0,!0}),a||e.addItem({label:n.name,iconHTML:n.icon?le(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Lt(n.type)}"></use></svg>`,click:()=>{const i=Object.assign([],t.data.view.sorts);t.data.view.sorts.push({column:n.id,order:"ASC"}),F(t.protyle,[{action:"setAttrViewSorts",avID:t.data.id,data:t.data.view.sorts}],[{action:"setAttrViewSorts",avID:t.data.id,data:i}]),t.menuElement.innerHTML=zn(t.data.view.columns,t.data.view.sorts),jn(t.protyle,t.menuElement,t.data),Le(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height)}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},jn=(t,e,n)=>{e.querySelectorAll("select").forEach(a=>{a.addEventListener("change",()=>{const i=a.parentElement.getAttribute("data-id"),s=JSON.parse(JSON.stringify(n.view.sorts));a.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(l=>{if(l.column===i)return l.column=a.value,a.parentElement.setAttribute("data-id",a.value),!0}):n.view.sorts.find(l=>l.column===i).order=a.value,F(t,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts}],[{action:"setAttrViewSorts",avID:n.id,data:s}])})})},zn=(t,e)=>{let n="";const a=i=>{let s="";return t.forEach(l=>{s+=`<option value="${l.id}" ${l.id===i?"selected":""}>${l.name}</option>`}),s};return e.forEach(i=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${a(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goConfig">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${e.length===t.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},Nr=(t,e)=>{var n,a,i,s;let l=!0,o;e.forEach(u=>{t.rows.find(d=>{if(u.parentElement.dataset.id===d.id)return d.cells.find(f=>{if(f.id===u.dataset.id)return(!f.value||!f.value.date||!f.value.date.hasEndDate)&&(l=!1),o=f,!0}),!0})}),o||(l=!1);let r="";(a=(n=o==null?void 0:o.value)==null?void 0:n.date)!=null&&a.isNotEmpty&&(r=ee(o.value.date.content).format("YYYY-MM-DDTHH:mm"));let c="";return(s=(i=o==null?void 0:o.value)==null?void 0:i.date)!=null&&s.isNotEmpty2&&(c=ee(o.value.date.content2).format("YYYY-MM-DDTHH:mm")),`<div class="b3-menu__items">
<div>
    <input type="datetime-local" value="${r}" class="b3-text-field fn__size200"><br>
    <input type="datetime-local" value="${c}" style="margin-top: 8px" class="b3-text-field fn__size200${l?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span>${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch fn__flex-center"${l?" checked":""}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},Pr=t=>{const e=t.menuElement.querySelectorAll(".b3-text-field");e[0].addEventListener("change",()=>{Ja({cellElements:t.cellElements,data:t.data,protyle:t.protyle,value:{isNotEmpty:e[0].value!=="",content:new Date(e[0].value).getTime()}})}),e[1].addEventListener("change",()=>{Ja({cellElements:t.cellElements,data:t.data,protyle:t.protyle,value:{isNotEmpty2:e[1].value!=="",content2:new Date(e[1].value).getTime()}})});const n=t.menuElement.querySelector(".b3-switch");n.addEventListener("change",()=>{n.checked?e[1].classList.remove("fn__none"):e[1].classList.add("fn__none"),Ja({cellElements:t.cellElements,data:t.data,protyle:t.protyle,value:{hasEndDate:n.checked}})})},Ja=t=>{let e;Array.from(t.cellElements[0].parentElement.querySelectorAll(".av__cell")).find((s,l)=>{if(s.dataset.id===t.cellElements[0].dataset.id)return e=l,!0});const n=t.cellElements[0].dataset.colId,a=[],i=[];t.cellElements.forEach(s=>{let l,o;const r=s.parentElement.dataset.id;t.data.view.rows.find(c=>{if(c.id===r)return typeof e=="number"?(l=c.cells[e],l.id=s.dataset.id,l.value||(l.value={})):l=c.cells.find(u=>{if(s.dataset.id===u.id)return!0}),o=Object.assign({},l.value.date),l.value.date=Object.assign(l.value.date||{isNotEmpty2:!1,isNotEmpty:!1},t.value),!0}),a.push({action:"updateAttrViewCell",id:l.id,keyID:n,rowID:r,avID:t.data.id,data:l.value}),i.push({action:"updateAttrViewCell",id:l.id,keyID:n,rowID:r,avID:t.data.id,data:{date:o}}),s.classList.contains("custom-attr__avvalue")?s.innerHTML=_n(l.value):Tt(s)}),F(t.protyle,a,i)},Et=t=>{t.menu.addItem({iconHTML:"",label:il(t.format),click(){F(t.protyle,[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.oldFormat,type:"number"}]),t.avPanelElement.remove()}})},Br=t=>{const e=new ut("av-col-format-number");Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"commas",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"percent",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"usDollar",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"yuan",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"euro",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"pound",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"yen",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"ruble",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"rupee",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"won",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"canadianDollar",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),Et({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"franc",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},il=t=>{switch(t){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},Re=(t,e,n=!1,a=!1)=>{var i,s;if(t==="")return;const l=a?e.toolbar.range:de(e.wysiwyg.element);gi(l);let o;A(l.startContainer,"data-type","NodeTable")&&!n&&(R(l.startContainer,"TABLE")?o=e.lute.BlockDOM2InlineBlockDOM(t):n=!0);let r=I(l.startContainer);if(r||(e.toolbar.range?r=I(e.toolbar.range.startContainer):r=e.wysiwyg.element.firstElementChild),!r)return;if(r.classList.contains("av")){l.deleteContents();const E=Fa();typeof E=="string"?(l.insertNode(document.createTextNode(E)),l.collapse(!1),Qa(e,r)):E.then(S=>{l.insertNode(document.createTextNode(S)),l.collapse(!1),Qa(e,r)});return}let c=r.getAttribute("data-node-id");l.insertNode(document.createElement("wbr"));let u=r.outerHTML;const d=r.getAttribute("data-type")==="NodeCodeBlock";if(!n&&(d||e.toolbar.getCurrentType(l).includes("code"))){l.deleteContents(),l.insertNode(document.createTextNode(t.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),l.collapse(!1),l.insertNode(document.createElement("wbr")),d?($(r).removeAttribute("data-render"),Ae(r)):re(r,l),r.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(e,c,r.outerHTML,u),setTimeout(()=>{Ie(e,r,!1,"smooth")},g.TIMEOUT_LOAD);return}const f=[],p=[];if(l.toString()!==""){const E=A(l.commonAncestorContainer,"data-type","inline-math");E?E.remove():(l.startContainer.nodeType===3&&((i=l.startContainer.parentElement.getAttribute("data-type"))==null?void 0:i.indexOf("block-ref"))>-1&&l.startContainer.parentElement.remove(),l.deleteContents()),l.insertNode(document.createElement("wbr")),f.push({action:"update",id:c,data:u}),p.push({action:"update",id:c,data:r.outerHTML})}const b=document.createElement("template");b.innerHTML=o||e.lute.SpinBlockDOM(t)||t;const m=$(r);if(!n&&(b.content.firstChild.nodeType===3||b.content.firstChild.nodeType!==3&&(b.content.firstElementChild.classList.contains("p")&&b.content.childElementCount===1||b.content.firstElementChild.tagName!=="DIV"))){b.content.firstChild.nodeType!==3&&b.content.firstElementChild.classList.contains("p")&&(b.innerHTML=b.content.firstElementChild.firstElementChild.innerHTML.trim());const E=l.startContainer.nodeType===3?l.startContainer.parentElement:l.startContainer;if(E.tagName==="SPAN"&&E.isSameNode(l.endContainer.nodeType===3?l.endContainer.parentElement:l.endContainer)&&b.content.querySelector("span, img")){const k=document.createElement("span"),C=E.attributes;for(let v=0;v<C.length;v++)k.setAttribute(C[v].name,C[v].value);l.setEnd(E.lastChild,E.lastChild.textContent.length),k.append(l.extractContents()),E.after(k),l.setStartBefore(k),l.collapse(!0)}l.insertNode(b.content.cloneNode(!0)),l.collapse(!1),r.setAttribute("updated",ee().format("YYYYMMDDHHmmss"));const S=m?m.innerHTML.trimStart():"";if(m&&(S.startsWith("```")||S.startsWith("~~~")||S.startsWith("\xB7\xB7\xB7")||S.indexOf("\n```")>-1||S.indexOf(`
~~~`)>-1||S.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(S.indexOf(`
`)===-1&&S.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let k=m.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();k.endsWith("\n```")||(k+="\n```");const C=k.indexOf("```")+3;k=k.substring(0,C)+(localStorage["local-codelang"]||"")+k.substring(C),m.innerHTML=k}const x=m.querySelector("wbr");if(x&&m&&!S.endsWith(`
`)){const k=xe(x);k&&k.nodeType!==3&&(k.dataset.type||"").indexOf("inline-math")>-1&&!Ee(x)&&x.insertAdjacentText("afterend",`
`)}en(r),j(e,c,r.outerHTML,u),re(e.wysiwyg.element,l);return}const h=N(r,"li");if(((s=b.content.children[0])==null?void 0:s.getAttribute("data-type"))==="NodeListItem")if(h)r=h,c=r.getAttribute("data-node-id"),u=r.outerHTML;else{const S=b.content.children[0].getAttribute("data-subtype");b.innerHTML=`<div${S==="o"?' data-marker="1."':""} data-subtype="${S}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${t}<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div></div>`}let w;Array.from(b.content.children).reverse().forEach(E=>{let S=E.getAttribute("data-node-id");if(S===c)p.push({action:"update",data:E.outerHTML,id:S}),f.push({action:"update",id:S,data:u});else{if(E.classList.contains("li")&&!r.parentElement.classList.contains("list")){S=Lute.NewNodeID();const x=document.createElement("div");x.setAttribute("data-subtype",E.getAttribute("data-subtype")),x.setAttribute("data-node-id",S),x.setAttribute("data-type","NodeList"),x.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),x.classList.add("list"),x.append(E),E=x}p.push({action:"insert",data:E.outerHTML,id:S,previousID:c}),f.push({action:"delete",id:S})}r.after(E),w||(w=E)}),m&&m.textContent===""&&r.classList.contains("p")&&(p.find((E,S)=>{if(E.id===c)return p.splice(S,1),!0}),p.push({action:"delete",id:c}),f.find((E,S)=>{if(E.id===c&&E.action==="update")return f.splice(S,1),!0}),f.push({action:"insert",data:u,id:c,previousID:r.previousElementSibling?r.previousElementSibling.getAttribute("data-node-id"):"",parentID:r.parentElement.getAttribute("data-node-id")||e.block.parentID}),r.remove()),w&&ce(w,void 0,!1);const y=e.wysiwyg.element.querySelector("wbr");y&&y.remove(),F(e,p,f)},sl=t=>{if(t){t.element.classList.remove("protyle"),t.element.removeAttribute("style"),t.wysiwyg&&(t.wysiwyg.lastHTMLs={}),t.undo&&t.undo.clear();try{t.ws.send("closews",{})}catch(e){setTimeout(()=>{t.ws.send("closews",{})},10240)}t.app.plugins.forEach(e=>{e.eventBus.emit("destroy-protyle",{protyle:t})})}},Vn=t=>{if(!t)return"";const e=we().extname(t).toLowerCase();return g.SIYUAN_ASSETS_IMAGE.includes(e)?`<img style="max-height: 100%" src="${t}">`:g.SIYUAN_ASSETS_AUDIO.includes(e)?`<audio style="max-width: 100%" controls="controls" src="${t}"></audio>`:g.SIYUAN_ASSETS_VIDEO.includes(e)?`<video style="max-width: 100%" controls="controls" src="${t}"></video>`:t},vu=()=>{},ll=(t,e,n,a)=>{let i="";if(g.SIYUAN_ASSETS_AUDIO.includes(t))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${ee().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${e}" data-src="${e}"></audio>${g.ZWSP}</div><div class="protyle-attr" contenteditable="false">${g.ZWSP}</div></div>`;else if(g.SIYUAN_ASSETS_IMAGE.includes(t)){let s="";e.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${e}" data-src="${e}" alt="${n}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else g.SIYUAN_ASSETS_VIDEO.includes(t)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${ee().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${g.ZWSP}<video controls="controls" src="${e}" data-src="${e}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${g.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${e}">${a}</span>`;return i};class qr{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const Or=(t,e)=>{const n=[];let a="",i="";for(let l=e.length,o=0;o<l;o++){const r=e[o];let c=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>t.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${t.options.upload.max/1024/1024}M</li>`,c=!1);const u=r.name.lastIndexOf("."),d=u===-1?"":r.name.substr(u),f=u===-1?r.name:t.options.upload.filename(r.name.substr(0,u))+d;t.options.upload.accept&&(t.options.upload.accept.split(",").some(b=>{const m=b.trim();if(m.indexOf(".")===0){if(d.toLowerCase()===m.toLowerCase())return!0}else if(r.type.split("/")[0]===m.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(n.push(r),i+=`<li>${f} ${window.siyuan.languages.uploading}</li>`)}let s;return(a!==""||i!=="")&&(s=oe(`<ul>${a}${i}</ul>`,-1)),{files:n,msgId:s}},ol=(t,e)=>{const n=JSON.parse(t);let a="";n.code===1&&(a=`${n.msg}`),n.data.errFiles&&n.data.errFiles.length>0&&(a=`<ul><li>${a}</li>`,n.data.errFiles.forEach(c=>{const u=c.lastIndexOf("."),d=u===-1?c:e.options.upload.filename(c.substr(0,u))+c.substr(u);a+=`<li>${d} ${window.siyuan.languages.uploadError}</li>`}),a+="</ul>"),a&&oe(a);let i=!0;const s=de(e.wysiwyg.element);s.toString()===""&&s.startContainer.nodeType===3&&e.toolbar.getCurrentType(s).length>0&&(s.setEndAfter(s.startContainer.parentElement),s.collapse(!1));const l=I(s.startContainer);if(l)if(l.classList.contains("table"))i=!1;else{const c=$(l);c&&c.textContent!==""&&l.classList.contains("p")&&(i=!1)}let o="";const r=Object.keys(n.data.succMap);r.forEach((c,u)=>{const d=n.data.succMap[c],f=we().extname(c).toLowerCase(),p=e.options.upload.filename(c);o+=ll(f,d,p.substring(0,p.length-f.length),p),!g.SIYUAN_ASSETS_AUDIO.includes(f)&&!g.SIYUAN_ASSETS_VIDEO.includes(f)&&r.length-1!==u&&(l&&l.classList.contains("table")?o+="<br>":i?o+=`

`:o+=`
`)}),Re(o,e,i)},rl=(t,e,n)=>{const a=oe(window.siyuan.languages.uploading,0);_("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:n,id:e.block.rootID},i=>{je(a),ol(JSON.stringify(i),e)})},an=(t,e,n,a)=>{if(!t){const u=new FormData;for(let f=0,p=e.length;f<p;f++)u.append("file[]",e[f]);const d=new XMLHttpRequest;d.open("POST",g.UPLOAD_ADDRESS),d.onreadystatechange=()=>{d.readyState===XMLHttpRequest.DONE&&(d.status===200?a(d.responseText):d.status===0?oe(window.siyuan.languages.fileTypeError):oe(d.responseText),n&&(n.value=""))},d.send(u);return}let i=[];for(let u=0;u<e.length;u++){let d=e[u];d instanceof DataTransferItem&&(d=d.getAsFile()),d.size===0&&d.type===""&&d.name.indexOf(".")===-1?rl([d.path],t,!1):i.push(d)}if(t.options.upload.handler){const u=t.options.upload.handler(i);if(typeof u=="string"){oe(u);return}return}if(!t.options.upload.url||!t.upload){n&&(n.value=""),oe("please config: options.upload.url");return}if(t.options.upload.file&&(i=t.options.upload.file(i)),t.options.upload.validate){const u=t.options.upload.validate(i);if(typeof u=="string"){oe(u);return}}const s=t.wysiwyg.element,l=Or(t,i);if(l.files.length===0){n&&(n.value="");return}const o=new FormData,r=t.options.upload.extraData;for(const u of Object.keys(r))o.append(u,r[u]);for(let u=0,d=l.files.length;u<d;u++)o.append(t.options.upload.fieldName,l.files[u]);o.append("id",t.block.rootID);const c=new XMLHttpRequest;c.open("POST",t.options.upload.url),t.options.upload.token&&c.setRequestHeader("X-Upload-Token",t.options.upload.token),t.options.upload.withCredentials&&(c.withCredentials=!0),t.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(t.upload.isUploading=!1,!document.body.contains(t.element)){sl(t);return}if(c.status===200)if(je(l.msgId),t.options.upload.success)t.options.upload.success(s,c.responseText);else if(a)a(c.responseText);else{let u=c.responseText;t.options.upload.format&&(u=t.options.upload.format(e,c.responseText)),ol(u,t)}else c.status===0?oe(window.siyuan.languages.fileTypeError):t.options.upload.error?t.options.upload.error(c.responseText):oe(c.responseText);n&&(n.value=""),t.upload.element.style.display="none"}},c.upload.onprogress=u=>{if(!u.lengthComputable)return;const d=u.loaded/u.total*100;t.upload.element.style.display="block";const f=t.upload.element;f.style.width=d+"%"},c.send(o)},cl=t=>{t.menuElement.querySelector("input").addEventListener("change",e=>{e.target.files.length!==0&&an(t.protyle,e.target.files,e.target,n=>{const a=JSON.parse(n),i=[];Object.keys(a.data.succMap).forEach(s=>{i.push({name:s,content:a.data.succMap[s],type:g.SIYUAN_ASSETS_IMAGE.includes(we().extname(a.data.succMap[s]).toLowerCase())?"image":"file"})}),Gn({protyle:t.protyle,data:t.data,cellElements:t.cellElements,type:"addUpdate",addUpdateValue:i})})})},dl=(t,e)=>{var n;const a=e[0].dataset.id,i=e[0].parentElement.dataset.id;let s;t.rows.find(o=>{if(o.id===i)return o.cells.find(r=>{if(r.id===a)return s=r,!0}),!0});let l="";return(n=s==null?void 0:s.value)!=null&&n.mAsset&&s.value.mAsset.forEach(o=>{if(!o.content)return;let r;o.type==="image"?r=`<span data-type="openAssetItem" class="fn__flex-1">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${o.content}"/>
</span>`:r=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label" style="max-width: 360px">${o.name}</span>`,l+=`<button class="b3-menu__item" draggable="true" data-name="${o.name}" data-type="${o.type}" data-content="${o.content}">
<svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
${r}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${l}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},Gn=t=>{let e;Array.from(t.cellElements[0].parentElement.querySelectorAll(".av__cell")).find((o,r)=>{if(o.dataset.id===t.cellElements[0].dataset.id)return e=r,!0});const n=t.cellElements[0].dataset.colId,a=[],i=[];let s=[];t.cellElements.forEach((o,r)=>{let c;const u=o.parentElement.dataset.id;t.data.view.rows.find(f=>{if(f.id===u)return typeof e=="number"?(c=f.cells[e],c.id=o.dataset.id,(!c.value||!c.value.mAsset)&&(c.value={mAsset:[]})):c=f.cells.find(p=>{if(p.id===o.dataset.id)return!0}),!0});const d=Object.assign([],c.value.mAsset);t.type==="remove"?r===0?(c.value.mAsset.find((f,p)=>{if(f.content===t.removeContent)return c.value.mAsset.splice(p,1),!0}),s=c.value.mAsset):c.value.mAsset=s:t.type==="addUpdate"?r===0?(t.addUpdateValue.forEach(f=>{if(!f.content)return;c.value.mAsset.find(b=>{if(b.content===f.content)return b.name=f.name,b.type=f.type,!0})||(f.type==="file"&&!f.name&&(f.name=f.content),c.value.mAsset.push(f))}),s=c.value.mAsset):c.value.mAsset=s:c.value.mAsset=t.replaceValue,a.push({action:"updateAttrViewCell",id:c.id,keyID:n,rowID:u,avID:t.data.id,data:c.value}),i.push({action:"updateAttrViewCell",id:c.id,keyID:n,rowID:u,avID:t.data.id,data:{mAsset:d}}),o.classList.contains("custom-attr__avvalue")?o.innerHTML=_n(c.value):Tt(o)}),F(t.protyle,a,i);const l=document.querySelector(".av__panel > .b3-menu");if(l){l.innerHTML=dl(t.data.view,t.cellElements),cl({protyle:t.protyle,data:t.data,menuElement:l,cellElements:t.cellElements});const o=(t.cellElements[0].classList.contains("custom-attr__avvalue")?t.cellElements[0]:t.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${t.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{Le(l,o.left,o.bottom,o.height)},g.TIMEOUT_LOAD)}},Rr=(t,e,n,a)=>{const i=a.dataset.content,s=a.dataset.type,l=new ut("av-asset-edit",()=>{!o||!o.value||o.value===a.dataset.name||Gn({protyle:t,data:e,cellElements:n,type:"addUpdate",addUpdateValue:[{content:i,name:o.value,type:s}]})});if(l.isOpen)return;s==="file"?l.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field"></textarea>`}):l.addItem({icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){Si(i)}}),l.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){Gn({protyle:t,data:e,cellElements:n,type:"remove",removeContent:i})}}),ba(t?t.app:window.siyuan.ws.app,i,!1,!0);const o=l.element.querySelector("textarea");o&&(o.value=a.dataset.name);const r=a.getBoundingClientRect();l.open({x:r.right,y:r.top,w:r.width,h:r.height})},Fr=(t,e,n,a)=>{const i=new ut("av-asset-link",()=>{const l=i.element.querySelectorAll("textarea");l[0].value&&Gn({protyle:t,data:e,cellElements:n,type:"addUpdate",addUpdateValue:[{type:"file",name:l[1].value,content:l[0].value}]})});if(i.isOpen)return;i.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.link}"></textarea>`}),i.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.title}"></textarea>`});const s=a.getBoundingClientRect();i.open({x:s.right,y:s.bottom,w:a.parentElement.clientWidth+8,h:s.height})},wn=t=>{let e=document.querySelector(".av__panel");if(e){e.remove();return}window.siyuan.menus.menu.remove();const n=t.blockElement.getAttribute("data-av-id");_("/api/av/renderAttributeView",{id:n},a=>{var i;const s=a.data;let l;t.type==="config"?l=ul(s.view):t.type==="properties"?l=Tn(s.view):t.type==="sorts"?l=zn(s.view.columns,s.view.sorts):t.type==="filters"?l=hn(s.view):t.type==="select"?l=Yn(s.view,t.cellElements):t.type==="asset"?l=dl(s.view,t.cellElements):t.type==="edit"?l=rn({protyle:t.protyle,data:s,colId:t.colId}):t.type==="date"&&(l=Nr(s.view,t.cellElements)),document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${l}</div>
</div>`),e=document.querySelector(".av__panel");const o=e.lastElementChild,r=(i=t.blockElement.querySelector(".layout-tab-bar"))==null?void 0:i.getBoundingClientRect();if(["select","date","asset"].includes(t.type)){const u=t.cellElements[t.cellElements.length-1].getBoundingClientRect();if(t.type==="select"?Wn(t.protyle,s,o,t.cellElements):t.type==="date"?Pr({protyle:t.protyle,data:s,menuElement:o,cellElements:t.cellElements}):t.type==="asset"&&(cl({protyle:t.protyle,data:s,menuElement:o,cellElements:t.cellElements}),setTimeout(()=>{Le(o,u.left,u.bottom,u.height)},g.TIMEOUT_LOAD)),["select","date"].includes(t.type)){const d=o.querySelector("input");d.select(),d.focus(),Le(o,u.left,u.bottom,u.height)}}else Le(o,r.right-o.clientWidth,r.bottom,r.height),t.type==="sorts"?jn(t.protyle,o,s):t.type==="edit"&&cn({protyle:t.protyle,data:s,menuElement:o});e.addEventListener("dragstart",u=>{window.siyuan.dragElement=u.target,window.siyuan.dragElement.style.opacity=".1"}),e.addEventListener("drop",u=>{var d,f;window.siyuan.dragElement.style.opacity="";const p=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,t.protyle&&t.protyle.disabled){u.preventDefault(),u.stopPropagation();return}if(!t.protyle&&window.siyuan.config.readonly){u.preventDefault(),u.stopPropagation();return}const b=u.target,m=A(b,"draggable","true");if(!m||!m.classList.contains("dragover__top")&&!m.classList.contains("dragover__bottom"))return;let h="columns";const w=m.classList.contains("dragover__top");if(m.querySelector('[data-type="removeSort"]'))h="sorts";else if(m.querySelector('[data-type="removeFilter"]'))h="filters";else if(m.querySelector('[data-type="editAssetItem"]'))h="assets";else if(m.querySelector('[data-type="setColOption"]')){const x=t.cellElements?t.cellElements[0].dataset.colId:o.querySelector(".b3-menu__item").getAttribute("data-col-id"),k=s.view.columns.find(L=>L.id===x).options,C=Object.assign([],k);let v;k.find((L,D)=>{if(L.name===p.dataset.name)return v=k.splice(D,1)[0],!0}),k.find((L,D)=>{if(L.name===m.dataset.name)return w?k.splice(D,0,v):k.splice(D+1,0,v),!0}),F(t.protyle,[{action:"updateAttrViewColOptions",id:x,avID:s.id,data:k}],[{action:"updateAttrViewColOptions",id:x,avID:s.id,data:C}]),t.cellElements?(o.innerHTML=Yn(s.view,t.cellElements),Wn(t.protyle,s,o,t.cellElements)):(o.innerHTML=rn({protyle:t.protyle,data:s,colId:x}),cn({protyle:t.protyle,data:s,menuElement:o}));return}const y=p.dataset.id,E=m.dataset.id;if(h==="sorts"){const x=s.view.sorts,k=Object.assign([],x);let C;x.find((v,L)=>{if(v.column===y)return C=x.splice(L,1)[0],!0}),x.find((v,L)=>{if(v.column===E)return w?x.splice(L,0,C):x.splice(L+1,0,C),!0}),F(t.protyle,[{action:"setAttrViewSorts",avID:n,data:x}],[{action:"setAttrViewSorts",avID:n,data:k}]),o.innerHTML=zn(s.view.columns,s.view.sorts),jn(t.protyle,o,s);return}if(h==="filters"){const x=s.view.filters,k=Object.assign([],x);let C;x.find((v,L)=>{if(v.column===y)return C=x.splice(L,1)[0],!0}),x.find((v,L)=>{if(v.column===E)return w?x.splice(L,0,C):x.splice(L+1,0,C),!0}),F(t.protyle,[{action:"setAttrViewFilters",avID:n,data:x}],[{action:"setAttrViewFilters",avID:n,data:k}]),o.innerHTML=hn(s.view);return}if(h==="assets"){w?m.before(p):m.after(p);const x=[];Array.from(m.parentElement.children).forEach(k=>{k.dataset.content&&x.push({content:k.dataset.content,name:k.dataset.name,type:k.dataset.type})}),Gn({protyle:t.protyle,data:s,cellElements:t.cellElements,type:"replace",replaceValue:x});return}F(t.protyle,[{action:"sortAttrViewCol",avID:n,previousID:(m.classList.contains("dragover__top")?(d=m.previousElementSibling)==null?void 0:d.getAttribute("data-id"):m.getAttribute("data-id"))||"",id:y}],[{action:"sortAttrViewCol",avID:n,previousID:((f=p.previousElementSibling)==null?void 0:f.getAttribute("data-id"))||"",id:y}]);let S;s.view.columns.find((x,k)=>{if(x.id===y)return S=s.view.columns.splice(k,1)[0],!0}),s.view.columns.find((x,k)=>{if(x.id===E)return w?s.view.columns.splice(k,0,S):s.view.columns.splice(k+1,0,S),!0}),o.innerHTML=Tn(s.view)});let c;e.addEventListener("dragover",u=>{const d=u.target,f=A(d,"draggable","true");if(!(!f||f.isSameNode(window.siyuan.dragElement))){if(u.preventDefault(),c&&f.isSameNode(c)){const p=f.getBoundingClientRect();u.clientY>p.top+p.height/2?f.classList.add("dragover__bottom"):f.classList.add("dragover__top");return}c=f}}),e.addEventListener("dragleave",u=>{const d=u.target,f=A(d,"draggable","true");f&&f.classList.remove("dragover__top","dragover__bottom")}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("click",u=>{let d=u.target;for(;d&&!d.isSameNode(e);){const f=d.dataset.type;if(f==="close"){t.protyle.toolbar.subElement.className.includes("fn__none")?e.remove():Y(["util"],t.protyle),window.siyuan.menus.menu.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="goConfig"){o.innerHTML=ul(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="goProperties"){o.innerHTML=Tn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="goSorts"){o.innerHTML=zn(s.view.columns,s.view.sorts),jn(t.protyle,o,s),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="removeSorts"){F(t.protyle,[{action:"setAttrViewSorts",avID:n,data:[]}],[{action:"setAttrViewSorts",avID:n,data:s.view.sorts}]),s.view.sorts=[],o.innerHTML=zn(s.view.columns,s.view.sorts),jn(t.protyle,o,s),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="addSort"){Hr({data:s,rect:d.getBoundingClientRect(),menuElement:o,tabRect:r,avId:n,protyle:t.protyle}),u.preventDefault(),u.stopPropagation();break}else if(f==="removeSort"){const p=Object.assign([],s.view.sorts);s.view.sorts.find((b,m)=>{if(b.column===d.parentElement.dataset.id)return s.view.sorts.splice(m,1),!0}),F(t.protyle,[{action:"setAttrViewSorts",avID:n,data:s.view.sorts}],[{action:"setAttrViewSorts",avID:n,data:p}]),o.innerHTML=zn(s.view.columns,s.view.sorts),jn(t.protyle,o,s),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="goFilters"){o.innerHTML=hn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="removeFilters"){F(t.protyle,[{action:"setAttrViewFilters",avID:n,data:[]}],[{action:"setAttrViewFilters",avID:n,data:s.view.filters}]),s.view.filters=[],o.innerHTML=hn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="addFilter"){Mr({data:s,rect:d.getBoundingClientRect(),menuElement:o,tabRect:r,avId:n,protyle:t.protyle}),u.preventDefault(),u.stopPropagation();break}else if(f==="removeFilter"){window.siyuan.menus.menu.remove();const p=Object.assign([],s.view.filters);s.view.filters.find((b,m)=>{if(b.column===d.parentElement.dataset.id)return s.view.filters.splice(m,1),!0}),F(t.protyle,[{action:"setAttrViewFilters",avID:n,data:s.view.filters}],[{action:"setAttrViewFilters",avID:n,data:p}]),o.innerHTML=hn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="setFilter"){s.view.filters.find(p=>{if(p.column===d.parentElement.parentElement.dataset.id)return $i({filter:p,protyle:t.protyle,data:s,target:d}),!0}),u.preventDefault(),u.stopPropagation();break}else if(f==="numberFormat"){Br({avPanelElement:e,element:d,protyle:t.protyle,oldFormat:d.dataset.format,colId:o.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:n}),u.preventDefault(),u.stopPropagation();break}else if(f==="newCol"){e.remove(),Zs(t.protyle,t.blockElement).open({x:r.right,y:r.bottom,h:r.height,isLeft:!0}),u.preventDefault(),u.stopPropagation();break}else if(f==="update-icon"){const p=d.getBoundingClientRect();hi("","av",{x:p.left,y:p.bottom,h:p.height,w:p.width},b=>{const m=o.querySelector(".b3-menu__item").getAttribute("data-col-id");F(t.protyle,[{action:"setAttrViewColIcon",id:m,avID:n,data:b}],[{action:"setAttrViewColIcon",id:m,avID:n,data:d.dataset.icon}]),d.innerHTML=b?le(b):`<svg><use xlink:href="#${Lt(d.dataset.colType)}"></use></svg>`,Tt(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${m}"]`))}),u.preventDefault(),u.stopPropagation();break}else if(f==="showAllCol"){const p=[],b=[];s.view.columns.forEach(m=>{m.hidden&&(p.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!1}),b.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!0}),m.hidden=!1)}),p.length>0&&(F(t.protyle,p,b),o.innerHTML=Tn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height)),u.preventDefault(),u.stopPropagation();break}else if(f==="hideAllCol"){const p=[],b=[];s.view.columns.forEach(m=>{!m.hidden&&m.type!=="block"&&(p.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!0}),b.push({action:"setAttrViewColHidden",id:m.id,avID:n,data:!1}),m.hidden=!0)}),p.length>0&&(F(t.protyle,p,b),o.innerHTML=Tn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height)),u.preventDefault(),u.stopPropagation();break}else if(f==="editCol"){o.innerHTML=rn({protyle:t.protyle,data:s,colId:d.parentElement.dataset.id}),cn({protyle:t.protyle,data:s,menuElement:o}),u.preventDefault(),u.stopPropagation();break}else if(f==="hideCol"){const p=o.querySelector('[data-type="goProperties"]'),b=p?o.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");F(t.protyle,[{action:"setAttrViewColHidden",id:b,avID:n,data:!0}],[{action:"setAttrViewColHidden",id:b,avID:n,data:!1}]),s.view.columns.find(m=>m.id===b).hidden=!0,p?(o.innerHTML=rn({protyle:t.protyle,data:s,colId:b}),cn({protyle:t.protyle,data:s,menuElement:o})):o.innerHTML=Tn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="showCol"){const p=o.querySelector('[data-type="goProperties"]'),b=p?o.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");F(t.protyle,[{action:"setAttrViewColHidden",id:b,avID:n,data:!1}],[{action:"setAttrViewColHidden",id:b,avID:n,data:!0}]),s.view.columns.find(m=>m.id===b).hidden=!1,p?(o.innerHTML=rn({protyle:t.protyle,data:s,colId:b}),cn({protyle:t.protyle,data:s,menuElement:o})):o.innerHTML=Tn(s.view),Le(o,r.right-o.clientWidth,r.bottom,r.height),u.preventDefault(),u.stopPropagation();break}else if(f==="duplicateCol"){const p=o.querySelector(".b3-menu__item").getAttribute("data-col-id"),b=s.view.columns.find(m=>m.id===p);Ol({protyle:t.protyle,type:b.type,avID:n,colId:p,icon:b.icon,newValue:b.name}),e.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="removeCol"){const p=o.querySelector(".b3-menu__item").getAttribute("data-col-id"),b=s.view.columns.find(m=>m.id===p);F(t.protyle,[{action:"removeAttrViewCol",id:p,avID:n}],[{action:"addAttrViewCol",name:b.name,avID:n,type:b.type,id:p}]),el(t.blockElement,p),e.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="setColOption"){Dr(t.protyle,s,d,t.cellElements),u.preventDefault(),u.stopPropagation();break}else if(f==="addColOptionOrCell"){nl(t.protyle,s,t.cellElements,d,o),window.siyuan.menus.menu.remove(),u.preventDefault(),u.stopPropagation();break}else if(f==="removeCellOption"){tl(t.protyle,s,t.cellElements,d.parentElement),u.preventDefault(),u.stopPropagation();break}else if(f==="addAssetLink"){Fr(t.protyle,s,t.cellElements,d),u.preventDefault(),u.stopPropagation();break}else if(f==="addAssetExist"){const p=d.getBoundingClientRect();t.protyle.toolbar.showAssets(t.protyle,{x:p.right,y:p.bottom,w:d.parentElement.clientWidth+8,h:p.height},b=>{let m;g.SIYUAN_ASSETS_IMAGE.includes(we().extname(b).toLowerCase())?m={type:"image",content:b,name:""}:m={type:"file",content:b,name:we().basename(b).substring(0,g.SIZE_LINK_TEXT_MAX)},Gn({protyle:t.protyle,data:s,cellElements:t.cellElements,type:"addUpdate",addUpdateValue:[m]}),Y(["util"],t.protyle)}),u.preventDefault(),u.stopPropagation();break}else if(f==="openAssetItem"){const p=d.parentElement.dataset.content,b=we().extname(p);g.SIYUAN_ASSETS_IMAGE.includes(b)?Si(p):window.open(p),u.preventDefault(),u.stopPropagation();break}else if(f==="editAssetItem"){Rr(t.protyle,s,t.cellElements,d.parentElement),u.preventDefault(),u.stopPropagation();break}else if(f==="clearDate"){Ja({cellElements:t.cellElements,data:s,protyle:t.protyle,value:{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1}}),e.remove(),u.preventDefault(),u.stopPropagation();break}d=d.parentElement}})})},Tn=t=>{let e="",n="";return t.columns.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${a.icon?le(a.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Lt(a.type)}"></use></svg>`}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__action" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`:e+=`<button class="b3-menu__item" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${a.icon?le(a.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Lt(a.type)}"></use></svg>`}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goConfig">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.attr}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${e}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},ul=t=>`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="goProperties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
    <span class="b3-menu__accelerator">${t.columns.filter(e=>!e.hidden).length}/${t.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.pageCount}</span>
    <span class="b3-menu__accelerator">50</span>
    <svg class="b3-menu__icon b3-menu__icon--arrow"><use xlink:href="#iconRight"></use></svg>
</button>
</div>`,Ur=t=>{if(!t.calc||!t.calc.result)return"";let e=t.calc.result.number;(t.calc.operator==="Earliest"||t.calc.operator==="Latest"||t.calc.operator==="Range"&&["date","created","updated"].includes(t.type))&&(e=t.calc.result[t.type]);let n="";switch(t.calc.operator){case"Count all":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountAll}`;break;case"Count values":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountValues}`;break;case"Count unique values":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountUniqueValues}`;break;case"Count empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountEmpty}`;break;case"Count not empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountNotEmpty}`;break;case"Percent empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultPercentEmpty}`;break;case"Percent not empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultPercentNotEmpty}`;break;case"Sum":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultSum}`;break;case"Average":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultAverage}`;break;case"Median":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMedian}`;break;case"Min":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMin}`;break;case"Max":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMax}`;break;case"Range":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultRange}`;break;case"Earliest":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcOperatorEarliest}`;break;case"Latest":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcOperatorLatest}`;break}return n},pa=(t,e)=>{let n;return typeof e=="string"?t==="number"?e?n={type:t,number:{content:parseFloat(e),isNotEmpty:!0}}:n={type:t,number:{isNotEmpty:!1}}:["text","block","url","phone","email","template"].includes(t)?n={type:t,[t]:{content:e}}:t==="mSelect"||t==="select"?n={type:t,mSelect:[{content:e,color:""}]}:["date","created","updated"].includes(t)&&e===""&&(n={type:t,[t]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1}}):t==="mSelect"||t==="select"?n={type:t,mSelect:e}:["date","created","updated"].includes(t)?n={type:t,[t]:e}:t==="mAsset"&&(n={type:t,mAsset:e}),n},nt=t=>{t.menu.addItem({iconHTML:"",label:t.label,click(){F(t.protyle,[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.operator}}],[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.oldOperator}}])}})},Wr=(t,e)=>{const n=I(e);if(!n)return;e.parentElement.classList.add("av__row--show");const a=new ut("av-calc",()=>{e.parentElement.classList.remove("av__row--show")});if(a.isOpen)return;const i=e.dataset.dtype,s=e.dataset.colId,l=n.dataset.avId,o=e.dataset.operator;nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"",label:window.siyuan.languages.calcOperatorNone}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Count all",label:window.siyuan.languages.calcOperatorCountAll}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Count values",label:window.siyuan.languages.calcOperatorCountValues}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Count unique values",label:window.siyuan.languages.calcOperatorCountUniqueValues}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Count empty",label:window.siyuan.languages.calcOperatorCountEmpty}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Count not empty",label:window.siyuan.languages.calcOperatorCountNotEmpty}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Percent empty",label:window.siyuan.languages.calcOperatorPercentEmpty}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Percent not empty",label:window.siyuan.languages.calcOperatorPercentNotEmpty}),["number","template"].includes(i)?(nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Sum",label:window.siyuan.languages.calcOperatorSum}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Average",label:window.siyuan.languages.calcOperatorAverage}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Median",label:window.siyuan.languages.calcOperatorMedian}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Min",label:window.siyuan.languages.calcOperatorMin}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Max",label:window.siyuan.languages.calcOperatorMax}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Range",label:window.siyuan.languages.calcOperatorRange})):["date","created","updated"].includes(i)&&(nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Earliest",label:window.siyuan.languages.calcOperatorEarliest}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Latest",label:window.siyuan.languages.calcOperatorLatest}),nt({menu:a,protyle:t,colId:s,avId:l,oldOperator:o,operator:"Range",label:window.siyuan.languages.calcOperatorRange}));const r=e.getBoundingClientRect();a.open({x:r.left,y:r.bottom,h:r.height})},$n=(t,e,n=!0)=>{if(!n){const i=t.querySelector(".av__scroll"),s=i.getBoundingClientRect();s.left>e.left?i.scrollLeft=i.scrollLeft+e.left-s.left:s.right<e.right&&(i.scrollLeft=i.scrollLeft+e.right-s.right)}const a=t.querySelector(".av__header").getBoundingClientRect();if(a.bottom>e.top){const i=N(t,"protyle-content",!0);i&&(i.scrollTop=i.scrollTop+e.top-a.bottom)}else{const i=t.querySelector(".av__row--footer").getBoundingClientRect();if(i.top<e.bottom){const s=N(t,"protyle-content",!0);s&&(s.scrollTop=s.scrollTop+e.bottom-i.top)}}},yn=(t,e,n)=>{if(n||(n=e[0].parentElement.parentElement.firstElementChild.querySelector(`[data-col-id="${e[0].getAttribute("data-col-id")}"]`).getAttribute("data-dtype")),n==="updated"||n==="created"||n==="block"&&(e.length>1||!e[0].getAttribute("data-detached")))return;const a=I(e[0]);let i=e[0].getBoundingClientRect();a&&$n(a,i),i=e[0].getBoundingClientRect();let s="";const l=`style="position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,100)}px;height: ${i.height}px"`;if(["text","url","email","phone","block","template"].includes(n))s=`<textarea ${l} class="b3-text-field">${e[0].firstElementChild.textContent}</textarea>`;else if(n==="number")s=`<input type="number" value="${e[0].firstElementChild.getAttribute("data-content")}" ${l} class="b3-text-field">`;else if(["select","mSelect"].includes(n)&&a){wn({protyle:t,blockElement:a,type:"select",cellElements:e});return}else if(n==="mAsset"&&a){wn({protyle:t,blockElement:a,type:"asset",cellElements:e});return}else if(n==="date"&&a){wn({protyle:t,blockElement:a,type:"date",cellElements:e});return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${s}
</div>`);const o=document.querySelector(".av__mask"),r=o.querySelector(".b3-text-field");r&&(r.select(),r.focus(),a&&n==="template"&&_("/api/av/renderAttributeView",{id:a.dataset.avId},c=>{c.data.view.columns.find(u=>{if(u.id===e[0].dataset.colId)return r.value=u.template,r.dataset.template=u.template,!0})}),r.addEventListener("blur",()=>{fl(t,n,e)}),r.addEventListener("keydown",c=>{c.isComposing||(c.key==="Escape"||c.key==="Enter"&&!c.shiftKey&&!Ce(c))&&(fl(t,n,e),c.preventDefault(),c.stopPropagation())})),o.addEventListener("click",c=>{c.target.classList.contains("av__mask")&&(o==null||o.remove())})},fl=(t,e,n)=>{if(!document.contains(n[0])&&n.length===1){const c=n[0].parentElement.dataset.avid;if(c)n[0]=t.wysiwyg.element.querySelector(`[data-av-id="${c}"] .av__row--add`).previousElementSibling.querySelector('[data-detached="true"]');else if(n[0]=t.wysiwyg.element.querySelector(`.av__cell[data-id="${n[0].dataset.id}"]`),!n[0])return}if(n.length===1&&n[0].dataset.detached==="true"&&!n[0].parentElement.dataset.id)return;const a=I(n[0]);if(!a)return;const i=document.querySelector(".av__mask"),s=[],l=[],o=a.getAttribute("data-av-id"),r=a.getAttribute("data-node-id");if(e==="template"){const c=n[0].getAttribute("data-col-id"),u=i.querySelector(".b3-text-field");u.value!==u.dataset.template&&F(t,[{action:"updateAttrViewColTemplate",id:c,avID:o,data:u.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:c,avID:o,data:u.dataset.template,type:"template"}])}else n.forEach(c=>{const u=N(c,"av__row");if(!u)return;const d=u.getAttribute("data-id"),f=c.getAttribute("data-id"),p=c.getAttribute("data-col-id"),b={content:i.querySelector(".b3-text-field").value},m={content:e==="block"?c.firstElementChild.textContent.trim():c.textContent.trim()};e==="number"&&(m.content=parseFloat(m.content),m.isNotEmpty=typeof m.content=="number"&&!isNaN(m.content),b.content=parseFloat(b.content),b.isNotEmpty=typeof b.content=="number"&&!isNaN(b.content)),!Ue(b,m)&&(s.push({action:"updateAttrViewCell",id:f,avID:o,keyID:p,rowID:d,data:{[e]:b}},{action:"doUpdateUpdated",id:r,data:ee().format("YYYYMMDDHHmmss")}),l.push({action:"updateAttrViewCell",id:f,avID:o,keyID:p,rowID:d,data:{[e]:m}},{action:"doUpdateUpdated",id:r,data:a.getAttribute("updated")}),Tt(c))});s.length>0&&F(t,s,l),n[0].classList.add("av__cell--select"),a&&ce(a),setTimeout(()=>{i.remove()})},_n=t=>{var e,n;let a="";switch(t.type){case"block":a=`<div class="fn__flex-1">${t.block.content}</div>`;break;case"text":a=`<textarea rows="${t.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1">${t.text.content}</textarea>`;break;case"number":a=`<input value="${t.number.content}" type="number" class="b3-text-field b3-text-field--text fn__flex-1">`;break;case"mSelect":case"select":(e=t.mSelect)==null||e.forEach(i=>{a+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">${i.content}</span>`});break;case"mAsset":(n=t.mAsset)==null||n.forEach(i=>{i.type==="image"?a+=`<img class="av__cellassetimg" src="${i.content}">`:a+=`<span class="b3-chip b3-chip--middle av__celltext--url" data-url="${i.content}">${i.name}</span>`});break;case"date":case"created":case"updated":t[t.type].isNotEmpty&&(a=`<span data-content="${t[t.type].content}">${ee(t[t.type].content).format("YYYY-MM-DD HH:mm")}</span>`),t[t.type].hasEndDate&&t[t.type].isNotEmpty2&&t[t.type].isNotEmpty&&(a+=`<svg class="custom-attr__avarrow"><use xlink:href="#iconForward"></use></svg><span data-content="${t[t.type].content2}">${ee(t[t.type].content2).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":a=`<input value="${t.url.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="${t.url.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":a=`<input value="${t.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="tel:${t.phone.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"template":a=`<div class="fn__flex-1">${t.template.content}</div>`;break;case"email":a=`<input value="${t.email.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="mailto:${t.email.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break}return a},Yr=(t,e,n)=>{_("/api/av/getAttributeViewKeys",{id:e},a=>{let i="";a.data.forEach(s=>{var l;i+=`<div data-av-id="${s.avID}" data-node-id="${e}" data-type="NodeAttributeView"><div class="block__logo custom-attr__avheader">
    <svg><use xlink:href="#iconDatabase"></use></svg>
    <span>${s.avName||window.siyuan.languages.database}</span>
</div>`,(l=s.keyValues)==null||l.forEach(o=>{var r;i+=`<div class="block__icons" data-id="${e}">
    <div class="block__logo">
        <svg><use xlink:href="#${Lt(o.key.type)}"></use></svg>
        <span>${o.key.name}</span>
    </div>
    <div data-av-id="${s.avID}" data-col-id="${o.values[0].keyID}" data-block-id="${o.values[0].blockID}" data-id="${o.values[0].id}" data-type="${o.values[0].type}" 
data-options="${(r=o.key)!=null&&r.options?On(JSON.stringify(o.key.options)):"[]"}"
class="fn__flex-1 fn__flex${["url","text","number","email","phone"].includes(o.values[0].type)?"":" custom-attr__avvalue"}">
        ${_n(o.values[0])}
    </div>
</div>`}),i+="</div>"}),t.innerHTML=i,t.addEventListener("click",s=>{const l=s.target,o=A(l,"data-type","date");if(o){yn(n,[o],"date"),s.stopPropagation(),s.preventDefault();return}const r=A(l,"data-type","select")||A(l,"data-type","mSelect");if(r){yn(n,[r],r.getAttribute("data-type")),s.stopPropagation(),s.preventDefault();return}const c=A(l,"data-type","mAsset");if(c){yn(n,[c],"mAsset"),s.stopPropagation(),s.preventDefault();return}}),t.querySelectorAll(".b3-text-field--text").forEach(s=>{s.addEventListener("change",()=>{let l;["url","text","email","phone"].includes(s.parentElement.dataset.type)?l={[s.parentElement.dataset.type]:{content:s.value}}:s.parentElement.dataset.type==="number"&&(l={number:{content:parseFloat(s.value)}}),_("/api/av/setAttributeViewBlockAttr",{avID:s.parentElement.dataset.avId,keyID:s.parentElement.dataset.colId,rowID:s.parentElement.dataset.blockId,cellID:s.parentElement.dataset.id,value:l})})})})};var jr=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const gl=(t,e)=>{t.addEventListener("change",()=>{_("/api/attr/setBlockAttrs",{id:e,attrs:{[t.dataset.name]:t.value}})})},zr=t=>{const e=t.getAttribute("data-node-id"),n=de(t),a=t.getAttribute(g.CUSTOM_REMINDER_WECHAT);let i="";a&&(i=ee(a).format("YYYY-MM-DDTHH:mm"));const s=new be({width:H()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){z(n)}}),l=s.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{s.destroy()}),l[1].addEventListener("click",()=>{l[1].getAttribute("disabled")||(l[1].setAttribute("disabled","disabled"),_("/api/block/setBlockReminder",{id:e,timed:"0"},()=>{t.removeAttribute(g.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),l[2].addEventListener("click",()=>{const o=s.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){oe(window.siyuan.languages.reminderTip);return}if(l[2].getAttribute("disabled"))return;l[2].setAttribute("disabled","disabled");const r=ee(o).format("YYYYMMDDHHmmss");_("/api/block/setBlockReminder",{id:e,timed:r},()=>{t.setAttribute(g.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else oe(window.siyuan.languages.notEmpty)})},Vr=t=>{_("/api/block/getDocInfo",{id:t.block.rootID},e=>{const n=e.data.ial[g.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=ee(n).format("YYYY-MM-DDTHH:mm"));const i=new be({width:H()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{_("/api/block/setBlockReminder",{id:t.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const l=i.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){oe(window.siyuan.languages.reminderTip);return}_("/api/block/setBlockReminder",{id:t.block.rootID,timed:ee(l).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else oe(window.siyuan.languages.notEmpty)})})},sn=(t,e="bookmark",n)=>{let a="",i="",s=!1;const l=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(t).forEach(r=>{g.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===g.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" readonly data-name="${r}" value="${ee(t[r]).format("YYYY-MM-DDTHH:mm")}">
</label>`:r.indexOf("custom-av")>-1?s=!0:r.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" rows="1" data-name="${r}">${t[r]}</textarea>
</label>`))});const o=new be({width:H()?"92vw":"50vw",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${t.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--outline">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){z(l)}});o.element.querySelector('.b3-text-field[data-name="bookmark"]').value=t.bookmark||"",o.element.querySelector('.b3-text-field[data-name="name"]').value=t.name||"",o.element.querySelector('.b3-text-field[data-name="alias"]').value=t.alias||"",o.element.addEventListener("click",r=>{let c=r.target;for(typeof r.detail=="string"&&(c=o.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!c.isSameNode(o.element);){const u=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),o.element.querySelectorAll(".custom-attr").forEach(d=>{d.dataset.type===c.dataset.type?(d.dataset.type==="NodeAttributeView"&&d.innerHTML===""&&Yr(d,t.id,n),d.classList.remove("fn__none")):d.classList.add("fn__none")});else if(u==="remove"){_("/api/attr/setBlockAttrs",{id:t.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(u==="bookmark"){_("/api/attr/getBookmarkLabels",{},d=>{window.siyuan.menus.menu.remove(),d.data.length===0?window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.emptyContent,type:"readonly"}).element):d.data.forEach(f=>{window.siyuan.menus.menu.append(new T({label:f,click(){const p=c.parentElement.parentElement.querySelector("input");p.value=f,p.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(u==="addCustom"){const d=new be({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),f=d.element.querySelector("input"),p=d.element.querySelectorAll(".b3-button");d.bindInput(f,()=>{p[1].click()}),f.focus(),f.select(),p[0].addEventListener("click",()=>{d.destroy()}),p[1].addEventListener("click",()=>{if(!ke(f.value))return oe(window.siyuan.languages.attrName+" <b>"+f.value+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${f.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea data-name="custom-${f.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const b=c.parentElement.previousElementSibling.querySelector(".b3-text-field");b.focus(),gl(b,t.id),d.destroy()}),r.stopPropagation(),r.preventDefault();break}c=c.parentElement}}),o.element.querySelectorAll(".b3-text-field").forEach(r=>{e!=="av"&&e===r.getAttribute("data-name")&&r.focus(),gl(r,t.id)}),e==="av"&&o.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},ln=(t,e="bookmark",n)=>{if(t.getAttribute("data-type")==="NodeThematicBreak")return;const a=t.getAttribute("data-node-id");_("/api/attr/getBlockAttrs",{id:a},i=>{sn(i.data,e,n)})},ma=(t,e=!0,n)=>[{icon:"iconRef",accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{_("/api/block/getRefText",{id:t},a=>{Pe(`((${t} '${a.data}'))`)}),n&&ce(n)}},{icon:"iconSQL",label:window.siyuan.languages.copyBlockEmbed,accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{Pe(`{{select * from blocks where id='${t}'}}`),n&&ce(n)}},{icon:"iconSiYuan",label:window.siyuan.languages.copyProtocol,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{Pe(`siyuan://blocks/${t}`),n&&ce(n)}},{label:window.siyuan.languages.copyProtocolInMd,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{_("/api/block/getRefText",{id:t},a=>{Pe(`[${a.data}](siyuan://blocks/${t})`)}),n&&ce(n)}},{label:window.siyuan.languages.copyHPath,accelerator:e?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{_("/api/filetree/getHPathByID",{id:t},a=>{Pe(a.data)})}},{label:window.siyuan.languages.copyID,accelerator:e?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{Pe(t),n&&ce(n)}}],pl=t=>new T({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:()=>jr(void 0,null,function*(){const e=yield Dt("/api/block/getRefText",{id:t}),n=new be({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),a=n.element.querySelector("input"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()});let s=Ut(e.data);const l=32;s.length>l&&(s=s.substring(0,l)),a.value=s,a.focus(),a.select(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{a.value.trim()===""?a.value="Untitled":a.value=Ut(a.value),s.length>l&&(s=s.substring(0,l)),_("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!1},o=>{if(o.code===1){Te(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{_("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!0},r=>{r.code===0&&oe(window.siyuan.languages.exportTplSucc)})});return}oe(window.siyuan.languages.exportTplSucc)}),n.destroy()})})},{label:"Markdown",icon:"iconMarkdown",click:()=>{const e=oe(window.siyuan.languages.exporting,-1);_("/api/export/exportMd",{id:t},n=>{je(e),Nt(n.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=oe(window.siyuan.languages.exporting,-1);_("/api/export/exportSY",{id:t},n=>{je(e),Nt(n.data.zip)})}},{label:window.siyuan.languages.image,icon:"iconImage",click:()=>{Tr(t)}}]}).element,ba=(t,e,n,a)=>{const i=[];if(vs(e)&&g.SIYUAN_ASSETS_EXTS.includes(we().extname(e))&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&e.startsWith("file://")),i.push({label:window.siyuan.languages.useBrowserView,accelerator:a?"Click":"",click:()=>{Nt(e)}}),n)return i;window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.openBy,submenu:i}).element)},ml=t=>new T({accelerator:window.siyuan.config.keymap.editor.general.rename.custom,label:window.siyuan.languages.rename,click:()=>{Ks(t)}}).element,Ii=t=>new T({label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){Rn((e,n)=>{mr(t,n[0],e[0])},t)}}).element,gt=(t,e=0,n=1e3)=>{t.scroll.lastScrollTop=-1,setTimeout(()=>{t.scroll.lastScrollTop=e},n)},bl=t=>{var e;const n=parseInt(t.getAttribute("data-subtype").substr(1));let a=t.nextElementSibling;for(;a;)if(a.classList.contains("sb")){let i=a.firstElementChild;for(;i&&i.classList.contains("sb");)i=i.firstElementChild;if(i.getAttribute("data-type")==="NodeHeading"&&parseInt(i.getAttribute("data-subtype").substr(1))>n||i.getAttribute("data-type")!=="NodeHeading"){const s=a;a=a.nextElementSibling,s.remove()}else break}else{const i=parseInt((e=a.getAttribute("data-subtype"))==null?void 0:e.substr(1));if(!a.classList.contains("protyle-attr")&&(isNaN(i)||i>n)){const s=a;a=a.nextElementSibling,s.remove()}else break}};class Gr{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();this.render(e,n,!1),this.hasUndo=!0,this.redoStack.push(n)}redo(e){if(e.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();this.render(e,n,!0),this.undoStack.push(n)}render(e,n,a){Y(["hint","gutter"],e),e.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(i=>{Yi(e,i,!0)}),F(e,n.doOperations)):(n.undoOperations.forEach(i=>{Yi(e,i,!0)}),F(e,n.undoOperations)),gt(e),Ie(e)}replace(e){this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1),this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,n){this.undoStack.push({undoOperations:n,doOperations:e}),this.undoStack.length>g.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1)}clear(){this.undoStack=[],this.redoStack=[]}}const In=t=>!1,hl=(t,e,n)=>{var a,i,s,l,o,r,c,u,d;let f,p="",b=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(b.length===0){let h=he(e);const w=A(h,"fold","1");w&&(h=w),(a=h.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(h=he(h.parentElement)),b=[h]}const m=b[0].getAttribute("data-type");if(m==="NodeListItem"&&!b[0].previousElementSibling&&((s=(i=b[0].parentElement.previousElementSibling)==null?void 0:i.previousElementSibling)!=null&&s.classList.contains("protyle-action")))if((l=b[0].parentElement.parentElement.previousElementSibling)!=null&&l.classList.contains("li")){if(f=b[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),p=b[0].parentElement.parentElement.parentElement.outerHTML,!f){const h=Lute.NewNodeID();b[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${b[0].getAttribute("data-subtype")}" data-node-id="${h}" data-type="NodeList" class="list" updated="${h.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=b[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(m==="NodeList"&&((r=(o=b[0].previousElementSibling)==null?void 0:o.previousElementSibling)!=null&&r.classList.contains("protyle-action")))if((c=b[0].parentElement.previousElementSibling)!=null&&c.classList.contains("li")){if(f=b[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),p=b[0].parentElement.parentElement.outerHTML,!f){const h=Lute.NewNodeID();b[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${b[0].getAttribute("data-subtype")}" data-node-id="${h}" data-type="NodeList" class="list" updated="${h.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),f=b[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(f){f=f.lastElementChild.previousElementSibling;const h=b[0].classList.contains("list")?b[0]:b[0].parentElement;b.reverse().forEach(w=>{w.classList.contains("list")?f.after(w.firstElementChild):f.after(w)}),f.id==="moveTempLi"&&(f=f.nextElementSibling,f.previousElementSibling.remove()),h.childElementCount===1?h.remove():h.getAttribute("data-subtype")==="o"&&h.classList.contains("list")&&Ne(h,1),f.getAttribute("data-subtype")==="o"&&Ne(f.parentElement),j(t,f.parentElement.parentElement.parentElement.getAttribute("data-node-id"),f.parentElement.parentElement.parentElement.outerHTML,p),gt(t),Ie(t),re(f.parentElement,n);return}if(!(!b[0].previousElementSibling||(u=b[0].previousElementSibling)!=null&&u.classList.contains("protyle-action"))){if(f=b[0].previousElementSibling,b[0].getAttribute("data-subtype")==="o"&&m==="NodeListItem"){const h=b[0].parentElement.outerHTML;b[b.length-1].after(f),Ne(b[0].parentElement,1),j(t,b[0].parentElement.getAttribute("data-node-id"),b[0].parentElement.outerHTML,h)}else{const h=f.getAttribute("data-node-id");F(t,[{action:"move",id:h,previousID:b[b.length-1].getAttribute("data-node-id")}],[{action:"move",id:h,previousID:(d=f.previousElementSibling)==null?void 0:d.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||t.block.parentID}]),b[b.length-1].after(f)}gt(t),Ie(t)}},wl=(t,e,n)=>{var a,i,s,l,o,r,c;let u,d="",f=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(f.length===0){let b=he(e);const m=A(b,"fold","1");m&&(b=m),(a=b.previousElementSibling)!=null&&a.classList.contains("protyle-action")&&(b=he(b.parentElement)),f=[b]}const p=f[0].getAttribute("data-type");if(p==="NodeListItem"&&f[f.length-1].nextElementSibling.classList.contains("protyle-attr")&&((i=f[0].parentElement.parentElement)!=null&&i.classList.contains("li")))if((s=f[0].parentElement.parentElement.nextElementSibling)!=null&&s.classList.contains("li")){if(u=f[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),d=f[0].parentElement.parentElement.parentElement.outerHTML,!u){const b=Lute.NewNodeID();f[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=f[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(p==="NodeList"&&f[f.length-1].nextElementSibling.classList.contains("protyle-attr")&&((l=f[0].parentElement)!=null&&l.classList.contains("li")))if((o=f[0].parentElement.nextElementSibling)!=null&&o.classList.contains("li")){if(u=f[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),d=f[0].parentElement.parentElement.outerHTML,!u){const b=Lute.NewNodeID();f[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${b}" data-type="NodeList" class="list" updated="${b.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),u=f[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(u){const b=f[0].classList.contains("list")?f[0]:f[0].parentElement;f.forEach(m=>{m.classList.contains("list")?u.before(m.firstElementChild):u.before(m)}),b.childElementCount===1?b.remove():b.getAttribute("data-subtype")==="o"&&b.classList.contains("list")&&Ne(b,1),u.getAttribute("data-subtype")==="o"&&Ne(u.parentElement,1),j(t,u.parentElement.parentElement.parentElement.getAttribute("data-node-id"),u.parentElement.parentElement.parentElement.outerHTML,d),gt(t),Ie(t),re(u.parentElement,n);return}if(!(!f[f.length-1].nextElementSibling||(r=f[f.length-1].nextElementSibling)!=null&&r.classList.contains("protyle-attr"))){if(u=f[f.length-1].nextElementSibling,u.getAttribute("data-subtype")==="o"&&u.getAttribute("data-type")==="NodeListItem"){const b=u.parentElement.outerHTML;f[0].before(u),Ne(u.parentElement,1),j(t,u.parentElement.getAttribute("data-node-id"),u.parentElement.outerHTML,b)}else{const b=u.getAttribute("data-node-id");F(t,[{action:"move",id:b,previousID:(c=f[0].previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:b,previousID:f[f.length-1].getAttribute("data-node-id")}]),f[0].before(u)}gt(t),Ie(t)}};class Kn{constructor(e,n){this.element=document.createElement("button");const a=n.hotkey?` ${De(n.hotkey)}`:"",i=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",i+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(qn(),s=>{s.preventDefault(),e.toolbar.setInlineMark(e,n.name,"toolbar")})}}class Kr extends Kn{constructor(e,n){super(e,n),this.element.addEventListener("click",()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append(Zr(e,Mi(e))),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0,z(e.toolbar.range)})}}const Zr=(t,e)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(u=>{n+=`<button class="color__square" data-type="color" style="color:${u}">A</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(u=>{a+=`<button class="color__square" data-type="backgroundColor" style="background-color:${u}"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;e==null||e.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return s=!0,!0});let l="";const o=window.siyuan.storage[g.LOCAL_FONTSTYLES];o.length>0&&(l=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="ft__on-surface fn__flex-center">${De(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex" style="align-items: center">`,o.forEach(u=>{const d=u.split(g.ZWSP);switch(d[0]){case"color":l+=`<button class="color__square" data-type="${d[0]}" style="color:${d[1]}">A</button>`;break;case"backgroundColor":l+=`<button class="color__square" data-type="${d[0]}" style="background-color:${d[1]}"></button>`;break;case"style2":l+=`<button data-type="${d[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":l+=`<button data-type="${d[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(l+=`<button data-type="${d[0]}" class="protyle-font__style">${d[1]}</button>`);break;case"style1":l+=`<button data-type="${d[0]}" style="background-color:${d[1]};color:${d[2]}" class="color__square">A</button>`;break;case"clear":l+=`<button data-type="${d[0]}" class="protyle-font__style">${window.siyuan.languages.clearFontStyle}</button>`;break}}),l+="</div>");let r,c="16px";return e&&e.length>0?r=e[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=A(t.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px"),i.innerHTML=`${l}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div class="${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${s?" fn__none":""}"></div>
<div class="fn__flex${s?" fn__none":""}">
    <select class="b3-select fn__block">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>
<div class="fn__hr"></div>
<button class="b3-button b3-button--cancel" data-type="clear">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
</button>`,i.addEventListener("click",function(u){let d=u.target;for(;d&&!d.isEqualNode(i);){const f=d.getAttribute("data-type");if(d.tagName==="BUTTON"){f==="style1"?kt(t,e,f,d.style.backgroundColor+g.ZWSP+d.style.color):f==="fontSize"?kt(t,e,f,d.textContent.trim()):f==="backgroundColor"?kt(t,e,f,d.style.backgroundColor):f==="color"?kt(t,e,f,d.style.color):kt(t,e,f);break}d=d.parentElement}}),i.querySelector("select").addEventListener("change",function(u){kt(t,e,"fontSize",u.target.value)}),i},kt=(t,e,n,a)=>{let i=window.siyuan.storage[g.LOCAL_FONTSTYLES];if(n)i.splice(0,0,`${n}${g.ZWSP}${a}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[g.LOCAL_FONTSTYLES]=i,et(g.LOCAL_FONTSTYLES,window.siyuan.storage[g.LOCAL_FONTSTYLES]);else if(i.length===0)n="style1",a="var(--b3-card-error-color)"+g.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(g.ZWSP);n=s[0],a=s[1]}e&&e.length>0?(va(e,t,s=>{if(n==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="";else if(n==="style1"){const l=a.split(g.ZWSP);s.style.backgroundColor=l[0],s.style.color=l[1]}else n==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):n==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?s.style.color=a:n==="backgroundColor"?s.style.backgroundColor=a:n==="fontSize"&&(s.style.fontSize=a);(n==="fontSize"||n==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&da(s.querySelector(".hljs"))}),z(t.toolbar.range)):n==="clear"?t.toolbar.setInlineMark(t,"clear","range",{type:"text"}):t.toolbar.setInlineMark(t,"text","range",{type:n,color:a})},Di=(t,e)=>{const n=s=>{const l=s.split(g.ZWSP);t.setAttribute("data-id",l.splice(0,1)[0]),t.setAttribute("data-subtype",l.splice(0,1)[0]),t.removeAttribute("data-href"),t.innerText=l.join("")},a=s=>{const l=s.split(g.ZWSP);t.setAttribute("data-href",l[0]),t.removeAttribute("data-subtype"),t.removeAttribute("data-id"),l[1]&&(t.textContent=l[1])},i=s=>{const l=s.split(g.ZWSP);t.setAttribute("data-id",l[0]),t.removeAttribute("data-href"),t.removeAttribute("data-subtype"),l[1]&&(t.textContent=l[1])};if(e)switch(e.type){case"color":t.style.color=e.color;break;case"fontSize":t.style.fontSize=e.color;break;case"backgroundColor":t.style.backgroundColor=e.color;break;case"style1":t.style.backgroundColor=e.color.split(g.ZWSP)[0],t.style.color=e.color.split(g.ZWSP)[1];break;case"style2":t.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",t.style.webkitTextFillColor="transparent";break;case"style4":t.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(e.color);break;case"inline-math":t.className="render-node",t.setAttribute("contenteditable","false"),t.setAttribute("data-subtype","math"),t.setAttribute("data-content",t.textContent.replace(g.ZWSP,"")),t.removeAttribute("data-render"),t.textContent="";break;case"a":a(e.color);break;case"file-annotation-ref":i(e.color);break;case"inline-memo":t.removeAttribute("contenteditable"),t.removeAttribute("data-subtype"),t.removeAttribute("data-content");break}},Zn=(t,e,n)=>{if(!n)return!0;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(t.nodeType!==3)return t.getAttribute("data-id")===e.getAttribute("data-id")&&t.getAttribute("data-subtype")===e.getAttribute("data-subtype")&&t.textContent===e.textContent;const c=n.color.split(g.ZWSP);return c[0]===e.getAttribute("data-id")&&c[1]===e.getAttribute("data-subtype")&&c[2]===e.textContent}if(n.type==="file-annotation-ref")return t.nodeType!==3?t.getAttribute("data-id")===e.getAttribute("data-id")&&t.textContent===e.textContent:n.color===e.getAttribute("data-id");let a="",i="",s="",l="",o="",r="";return t.nodeType!==3&&(a=t.style.color,i=t.style.webkitTextFillColor,s=t.style.webkitTextStroke,l=t.style.textShadow,o=t.style.backgroundColor,r=t.style.fontSize),n.type==="text"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&l===e.style.textShadow&&r===e.style.fontSize&&o===e.style.backgroundColor:n.type==="color"?n.color===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&l===e.style.textShadow&&r===e.style.fontSize&&o===e.style.backgroundColor:n.type==="backgroundColor"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&l===e.style.textShadow&&r===e.style.fontSize&&n.color===e.style.backgroundColor:n.type==="style1"?n.color.split(g.ZWSP)[0]===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&l===e.style.textShadow&&r===e.style.fontSize&&n.color.split(g.ZWSP)[1]===e.style.backgroundColor:n.type==="style2"?a===e.style.color&&e.style.webkitTextFillColor==="transparent"&&e.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&l===e.style.textShadow&&r===e.style.fontSize&&o===e.style.backgroundColor:n.type==="style4"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&r===e.style.fontSize&&e.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&o===e.style.backgroundColor:n.type==="fontSize"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&l===e.style.textShadow&&n.color===e.style.fontSize&&o===e.style.backgroundColor:!0},Mi=t=>{let e;if(t.toolbar.range.toString()===""&&(e=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0)){const n=I(t.toolbar.range.startContainer);n&&(e=[n])}return e};let yl,ha=!1;const me=(t,e,n,a="false")=>{let i;return e&&e.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${e}"></use></svg>`:i=e,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(t)}">
    ${i}
    <span class="keyboard__slash-text">${n}</span>
</button>`},_l=(t,e)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((d,f)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" style="color:${d}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${f+1}</span>
</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((d,f)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" style="background-color:${d}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${f+1}</span>
</button>`});const i=Mi(t);let s=!1;i==null||i.find(d=>{if(d.classList.contains("list")||d.classList.contains("li"))return s=!0,!0});let l="";const o=window.siyuan.storage[g.LOCAL_FONTSTYLES];o.length>0&&(l=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,o.forEach(d=>{const f=d.split(g.ZWSP);switch(f[0]){case"color":l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${parseInt(f[1].replace("var(--b3-font-color",""))+1}</span>
</button>`;break;case"backgroundColor":l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${parseInt(f[1].replace("var(--b3-font-background",""))+1}</span>
</button>`;break;case"style2":l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${f[1]}</span>
</button>`);break;case"style1":l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]};color:${f[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[f[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`;break;case"clear":l+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),l+="</div>");let r,c="16px";i&&i.length>0?r=i[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=A(t.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const u=e.querySelector(".keyboard__util");u.innerHTML=`${l}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,u.querySelector("select").addEventListener("change",function(d){kt(t,i,"fontSize",d.target.value)})},Xr=(t,e)=>{t.hint.splitChar="/",t.hint.lastIndex=-1;const n=e.querySelector(".keyboard__util");n.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${me(g.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${me(g.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${me(g.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${me("((","iconRef",window.siyuan.languages.ref,"true")}
    ${me("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${me(g.ZWSP+5,"iconSparkles","AI Chat")}
    ${me(g.ZWSP+4,"iconFile",window.siyuan.languages.newFile)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${me("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${me("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${me("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${me("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${me("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${me("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${me("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${me("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${me("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${me("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${me("```","iconCode",window.siyuan.languages.code,"true")}
    ${me(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${me("---","iconLine",window.siyuan.languages.line,"true")}
    ${me("$$","iconMath",window.siyuan.languages.math)}
    ${me("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${me("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
    ${me("a","iconLink",window.siyuan.languages.link)}
    ${me("strong","iconBold",window.siyuan.languages.bold,"true")}
    ${me("em","iconItalic",window.siyuan.languages.italic,"true")}
    ${me("u","iconUnderline",window.siyuan.languages.underline,"true")}
    ${me("s","iconStrike",window.siyuan.languages.strike,"true")}
    ${me("mark","iconMark",window.siyuan.languages.mark,"true")}
    ${me("sup","iconSup",window.siyuan.languages.sup,"true")}
    ${me("sub","iconSub",window.siyuan.languages.sub,"true")}
    ${me("tag","iconTags",window.siyuan.languages.tag,"true")}
    ${me("code","iconInlineCode",window.siyuan.languages["inline-code"],"true")}
    ${me("inline-math","iconMath",window.siyuan.languages["inline-math"])}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${me(g.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true")}
    ${me('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${me("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${me('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${me('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${me("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${me("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${me("```flowchart\n```","","Flow Chart","true")}
    ${me("```graphviz\n```","","Graph","true")}
    ${me("```mermaid\n```","","Mermaid","true")}
    ${me("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${me("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${me(`style${g.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${me(`style${g.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${me(`style${g.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${me(`style${g.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${me(`style${g.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>`,t.hint.bindUploadEvent(t,n)},Hi=t=>{window.siyuan.menus.menu.remove(),ha=!0;const e=document.getElementById("keyboardToolbar");let n=e.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.innerHeight/2)+"px";const a=St();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=t),setTimeout(()=>{e.style.height=n},g.TIMEOUT_TRANSITION),setTimeout(()=>{ha=!1},1e3)},wa=()=>{const t=document.getElementById("keyboardToolbar");t.style.height="";const e=St();e&&(e.protyle.element.parentElement.style.paddingBottom="42px"),t.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},Qr=()=>{clearTimeout(yl),yl=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){pt();return}if(document.activeElement&&document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA"&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){pt();return}ha||wa(),vl();const t=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),e=getSelection().getRangeAt(0);if(!N(e.startContainer,"protyle-wysiwyg",!0)){t[0].classList.add("fn__none"),t[1].classList.add("fn__none");return}e.toString()||t[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(t[0].classList.add("fn__none"),t[1].classList.remove("fn__none")):(t[0].classList.remove("fn__none"),t[1].classList.add("fn__none"));const i=St().protyle;if(!t[0].classList.contains("fn__none")){i.undo.undoStack.length===0?t[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?t[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=I(e.startContainer);if(s){const l=t[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(l.classList.remove("fn__none"),l.nextElementSibling.classList.remove("fn__none"),l.nextElementSibling.nextElementSibling.classList.remove("fn__none")):(l.classList.add("fn__none"),l.nextElementSibling.classList.add("fn__none"),l.nextElementSibling.nextElementSibling.classList.add("fn__none"))}}t[1].classList.contains("fn__none")||(t[1].querySelectorAll(".protyle-toolbar__item--current").forEach(l=>{l.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(e).forEach(l=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(l))return;const o=t[1].querySelector(`[data-type="${l}"]`);o&&o.classList.add("protyle-toolbar__item--current")}))},620)},vl=()=>{ha||wa();const t=document.getElementById("keyboardToolbar");if(!t.classList.contains("fn__none"))return;t.classList.remove("fn__none"),t.style.zIndex=(++window.siyuan.zIndex).toString();const e=document.getElementById("model");e.style.transform==="translateY(0px)"&&(e.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=St();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),setTimeout(()=>{const i=N(n.startContainer,"protyle-content",!0);if(i){const s=Rt(i).top-i.getBoundingClientRect().top;if(s<window.innerHeight-118.5)return;i.scroll({top:i.scrollTop+s-((window.outerHeight-118.5)/2-26),left:i.scrollLeft,behavior:"smooth"})}},g.TIMEOUT_TRANSITION)},pt=()=>{if(ha)return;const t=document.getElementById("keyboardToolbar");t.classList.add("fn__none"),t.style.height="";const e=St();e&&(e.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom="")},$t=()=>{document.activeElement.blur()},Jr=()=>{let t=!1;document.addEventListener("selectionchange",()=>{t||Qr()},!1);const e=document.getElementById("keyboardToolbar");e.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="more"><svg><use xlink:href="#iconMore"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,e.addEventListener("click",n=>{var a;const i=(a=St())==null?void 0:a.protyle,s=n.target,l=N(n.target,"keyboard__slash-item");if(l&&!l.getAttribute("data-type")){const d=decodeURIComponent(l.getAttribute("data-value"));i.hint.fill(d,i,!1),d!==g.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),l.getAttribute("data-focus")==="true"&&z(i.toolbar.range);return}const o=R(s,"BUTTON");if(!o||o.getAttribute("disabled"))return;const r=o.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(r)){const d=Mi(i),f=o.firstElementChild;r==="style1"?kt(i,d,r,f.style.backgroundColor+g.ZWSP+f.style.color):r==="fontSize"?kt(i,d,r,f.textContent.trim()):r==="backgroundColor"?kt(i,d,r,f.style.backgroundColor):r==="color"?kt(i,d,r,f.style.color):kt(i,d,r)}if(n.preventDefault(),n.stopPropagation(),getSelection().rangeCount===0)return;const c=getSelection().getRangeAt(0);if(r==="done"){e.clientHeight>100?(wa(),z(c)):($t(),pt());return}if(window.siyuan.config.readonly||!i||i.disabled)return;if(r==="undo"){i.undo.undo(i);return}else if(r==="redo"){i.undo.redo(i);return}if(getSelection().rangeCount===0)return;const u=I(c.startContainer);if(u){if(r==="goback"){e.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const d=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");d[0].classList.remove("fn__none"),d[1].classList.add("fn__none"),z(c),t=!0,setTimeout(()=>{t=!1},1e3);return}else if(r==="goinline"){o.classList.add("protyle-toolbar__item--current");const d=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");d[1].classList.remove("fn__none"),d[0].classList.add("fn__none"),z(c);return}else if(["a","block-ref","inline-math","inline-memo"].includes(r)){A(c.startContainer,"data-type","NodeCodeBlock")||(Y(["util"],i),i.toolbar.element.querySelector(`[data-type="${r}"]`).dispatchEvent(new CustomEvent("click")));return}else if(o.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(r)){A(c.startContainer,"data-type","NodeCodeBlock")||i.toolbar.setInlineMark(i,r,"toolbar");return}else if(r==="text"){if(o.classList.contains("protyle-toolbar__item--current"))wa(),z(c);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const d=i.contentElement.scrollTop;_l(i,e),Hi(d)}return}else if(r==="moveup"){hl(i,u,c),z(c);return}else if(r==="movedown"){wl(i,u,c),z(c);return}else if(r==="add"){if(o.classList.contains("protyle-toolbar__item--current"))wa(),z(c);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const d=i.contentElement.scrollTop;Xr(i,e),Hi(d)}return}else if(r==="more"){i.breadcrumb.showMenu(i,{x:0,y:0,isLeft:!0}),$t(),pt();return}else if(r==="block"){i.gutter.renderMenu(i,u),window.siyuan.menus.menu.fullscreen(),$t(),pt();return}else if(r==="outdent"){ga(i,[u.parentElement],c),z(c);return}else if(r==="indent"){vi(i,[u.parentElement],c),z(c);return}}})},Be=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const t=document.querySelector(".side-mask");t.classList.add("fn__none"),t.style.opacity="",window.siyuan.menus.menu.remove()},El=()=>{document.getElementById("model").style.transform="",$t(),pt()},Ni=[],ec=t=>{const e=St().protyle;if(window.siyuan.storage[g.LOCAL_DOCINFO]={id:t.id},et(g.LOCAL_DOCINFO,window.siyuan.storage[g.LOCAL_DOCINFO]),Y(["toolbar","hint","util"],e),e.contentElement.classList.contains("fn__none")&&fa(e,"wysiwyg"),e.notebookId=t.data.notebookId,e.path=t.data.path,t.data.startId===e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&t.data.endId===e.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){e.contentElement.scrollTo({top:t.scrollTop,behavior:"smooth"});return}if(t.id!==e.block.rootID&&_("/api/block/getDocInfo",{id:t.id},n=>{document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name,e.background.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial)}),t.zoomId){t.zoomId!==e.block.id?_("/api/block/checkBlockExist",{id:t.id},n=>{n.data&&mt({protyle:e,id:t.id,isPushBack:!1,callback:()=>{e.contentElement.scrollTop=t.scrollTop}})}):e.contentElement.scrollTop=t.scrollTop;return}_("/api/filetree/getDoc",{id:t.id,startID:t.data.startId,endID:t.data.endId},n=>{if(e.block.parentID=n.data.parentID,e.block.parent2ID=n.data.parent2ID,e.block.rootID=n.data.rootID,e.block.showAll=!1,e.block.mode=n.data.mode,e.block.blockCount=n.data.blockCount,e.block.id=n.data.id,e.block.action=t.callback,e.wysiwyg.element.setAttribute("data-doc-type",n.data.type),e.wysiwyg.element.innerHTML=n.data.content,Oe(e.wysiwyg.element),Ae(e.wysiwyg.element),Ye(e.wysiwyg.element,e),Se(e,e.wysiwyg.element,t.scrollTop),n.data.isSyncing)Vl(e);else{let a=window.siyuan.config.readonly?"true":"false";a==="false"&&(a=e.wysiwyg.element.getAttribute(g.CUSTOM_SY_READONLY),a||(a=window.siyuan.config.editor.readOnly?"true":"false")),a==="true"?Yt(e):ei(e)}e.contentElement.scrollTop=t.scrollTop})},Pi=()=>{const t=St().protyle;window.siyuan.backStack.push({id:t.block.showAll?t.block.id:t.block.rootID,data:{startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:t.notebookId,path:t.path},scrollTop:t.contentElement.scrollTop,callback:t.block.action,zoomId:t.block.showAll?t.block.id:void 0})},tc=()=>{const t=St();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){Be();return}else if(t&&!t.protyle.toolbar.subElement.classList.contains("fn__none")){Y(["util"],t.protyle),Be();return}else if(window.siyuan.dialogs.length!==0){Y(["dialog"]),Be();return}if(window.JSAndroid&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid.returnDesktop():oe(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(Ni.length===0&&t){const n=t.protyle;Ni.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const e=window.siyuan.backStack.pop();Ni.push(e),ec(e)},Xn=(t,e,n)=>{if(!t){e.innerHTML="";return}_("/api/template/render",{id:n,path:t},a=>{e.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},kl=(t,e,n=!0)=>{if(!t.getAttribute("data-type")||!e.getAttribute("data-type"))return!1;t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim()),e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim());const a=t.attributes;let i=!0;for(let s=0;s<a.length;s++)e.getAttribute(a[s].name)!==a[s].value&&(i=!1);return i&&(n?t.innerHTML=t.innerHTML+e.innerHTML:t.innerHTML=e.innerHTML+t.innerHTML,e.remove()),i},Ll=t=>{let e=t.previousSibling;for(;e&&e.nodeType!==3&&kl(t,e,!1);)e=t.previousSibling;let n=t.nextSibling;for(;n&&n.nodeType!==3&&kl(t,n);)n=t.nextSibling;(t.getAttribute("data-type")||"").includes("search-mark")&&t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim())},Bi=(t,e)=>{const n=t.getAttribute("data-type").split(" ");if(n.length===1){const a=t.parentElement;t.outerHTML=t.innerHTML.replace(g.ZWSP,"")+"<wbr>",e&&re(a,e)}else n.find((a,i)=>{if(a==="a")return n.splice(i,1),!0}),t.setAttribute("data-type",n.join(" ")),t.removeAttribute("data-href"),e&&(e.selectNodeContents(t),e.collapse(!1),z(e))},nc=t=>{t.element.querySelector(".wysiwygLoading")||(Qn(t),Y(["toolbar"],t),_("/api/format/netImg2LocalAssets",{id:t.block.rootID},()=>{jt(t,!1)}))},ac=(t,e)=>{var n,a;setTimeout(()=>{nr(["gutter"])},g.TIMEOUT_TRANSITION);const i=t.className.includes("fullscreen");if(i?(t.classList.remove("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&((n=document.getElementById("drag"))==null||n.classList.remove("fn__hidden"))):(t.classList.add("fullscreen"),document.querySelector("body").classList.contains("body--win32")&&((a=document.getElementById("drag"))==null||a.classList.add("fn__hidden"))),e){i?e.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):e.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const s=N(t,"layout--float");s&&(i?(s.setAttribute("data-temp",s.style.transform),s.style.transform="none"):(s.style.transform=s.getAttribute("data-temp"),s.removeAttribute("data-temp")));return}},Eu=(t,e,n,a)=>{const i=e.target;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return fetchPost("/api/filetree/getHPathByID",{id:t.block.rootID},s=>{writeText(s.data)}),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,e))return netImg2LocalAssets(t),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,e))return fetchPost("/api/format/autoSpace",{id:t.block.rootID}),e.preventDefault(),e.stopPropagation(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)||matchHotKey(window.siyuan.config.keymap.general.dailyNote.custom,e))return e.preventDefault(),!0;if(matchHotKey(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e)){const s=n?n.getAttribute("data-node-id"):t.block.rootID;return fetchPost("/api/block/getRefText",{id:s},l=>{writeText(`[${l.data}](siyuan://blocks/${s})`)}),e.preventDefault(),e.stopPropagation(),!0}},xl=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else if(Qe(t.nodeElement,t.editorElement,t.range).start!==0){const a=$(t.nodeElement);if(a.tagName==="TABLE"){const i=R(t.range.startContainer,"TH")||R(t.range.startContainer,"TD")||a.querySelector("th, td");if(Qe(i,i,t.range).start!==0){Oa(i,t.range),t.event.stopPropagation(),t.event.preventDefault();return}}else return}t.range.collapse(!0),Y(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Fe(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},Sl=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else if(Qe(t.nodeElement,t.editorElement,t.range).end<$(t.nodeElement).textContent.length)return;t.range.collapse(!1),Y(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Fe(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},Al=t=>{let e,n;return t.forEach(a=>{a.getAttribute("select-start")&&(e=a),a.getAttribute("select-end")&&(n=a)}),e||(e=t[0],e.setAttribute("select-start","true")),n||(n=t[t.length-1],n.setAttribute("select-end","true")),{startElement:e,endElement:n}},qi=(t,e)=>{let n;const a=[],i=[];t.reverse().forEach((s,l)=>{const o=s.cloneNode(!0);l===0&&(n=o);const r=Lute.NewNodeID();o.setAttribute("data-node-id",r),o.querySelectorAll("[data-node-id]").forEach(c=>{c.setAttribute("data-node-id",Lute.NewNodeID())}),s.classList.remove("protyle-wysiwyg--select"),t[0].after(o),a.push({action:"insert",data:o.outerHTML,id:r,previousID:t[0].getAttribute("data-node-id")}),i.push({action:"delete",id:r})}),F(e,a,i),ce(n),Ie(e)},Cl=t=>{t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.options.backlinkData?(ce(t.wysiwyg.element.firstElementChild),t.contentElement.scrollTop=0,t.scroll.lastScrollTop=1):_("/api/filetree/getDoc",{id:t.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{qe({data:e,protyle:t,action:[g.CB_GET_FOCUS]})})},Tl=t=>{!t.scroll.element.classList.contains("fn__none")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?_("/api/filetree/getDoc",{id:t.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{qe({data:e,protyle:t,action:[g.CB_GET_FOCUS]})}):(t.contentElement.scrollTop=t.contentElement.scrollHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop,ce(t.wysiwyg.element.lastElementChild,void 0,!1))},$l=(t,e,n,a,i)=>{e.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.display="block";let l=s.nextSibling;for(;l;)if(l.textContent==="")l=l.nextSibling;else if(l.textContent===g.ZWSP){l.textContent="";break}else break;let o=s.previousSibling;for(;o;)if(o.textContent==="")o=o.previousSibling;else if(o.textContent===g.ZWSP){o.textContent="";break}else break}),j(t,a,e.outerHTML,i)},Il=(t,e,n,a,i)=>{e.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.display="",Ee(s)||s.insertAdjacentText("afterend",g.ZWSP),xe(s)||s.insertAdjacentText("beforebegin",g.ZWSP)}),j(t,a,e.outerHTML,i)},Oi=(t,e)=>{var n;const a=I(e);if(!a)return;Y(["util","toolbar","hint"],t);const i=a.getAttribute("data-node-id"),s=a.outerHTML;window.siyuan.menus.menu.remove();let l;window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" value="${e.getAttribute("data-id")||""}" readonly placeholder="ID">`}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" data-type="anchor" placeholder="${window.siyuan.languages.anchor}">`,bind(r){l=r.querySelector("input"),l.value=e.textContent;const c=()=>{l.value?e.innerHTML=Lute.EscapeHTMLStr(l.value):e.innerHTML="*"};l.addEventListener("input",u=>{u.isComposing||(c(),u.stopPropagation())}),l.addEventListener("compositionend",u=>{u.isComposing||(c(),u.stopPropagation())}),l.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(In(u))return}})}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.outerHTML=e.textContent+"<wbr>"}}).element),window.siyuan.menus.menu.append(new T({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){const r=a.outerHTML;Bi(e,t.toolbar.range),j(t,i,a.outerHTML,r)}}).element),(n=t==null?void 0:t.app)!=null&&n.plugins&&ft({plugins:t.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),l.select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==s&&(a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,i,a.outerHTML,s));const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!t.element.contains(r.startContainer)&&(e.parentElement?(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),z(t.toolbar.range)):re(a,t.toolbar.range))}},Ri=(t,e)=>{var n;const a=I(e);if(!a)return;Y(["util","toolbar","hint"],t);const i=e.getAttribute("data-id"),s=a.getAttribute("data-node-id");let l=a.outerHTML;if(window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new T({label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(r){const c=r.querySelector("input");c.value=e.getAttribute("data-subtype")==="d"?"":e.textContent,c.addEventListener("input",()=>{c.value?e.innerHTML=Lute.EscapeHTMLStr(c.value):_("/api/block/getRefText",{id:i},u=>{e.innerHTML=u.data}),e.setAttribute("data-subtype",c.value?"s":"d")}),c.addEventListener("keydown",u=>{if(!u.isComposing){if(u.key==="Enter"&&!u.isComposing)window.siyuan.menus.menu.remove();else if(In(u))return}})}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element)),!t.disabled){let r=[];e.getAttribute("data-subtype")==="s"?r.push({label:window.siyuan.languages.turnToDynamic,click(){e.setAttribute("data-subtype","d"),_("/api/block/getRefText",{id:i},c=>{e.innerHTML=c.data,a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l)}),z(t.toolbar.range)}}):r.push({label:window.siyuan.languages.turnToStatic,click(){e.setAttribute("data-subtype","s"),a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),z(t.toolbar.range)}}),r=r.concat([{label:window.siyuan.languages.text,click(){e.outerHTML=`${e.innerHTML}<wbr>`,a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),re(a,t.toolbar.range)}},{label:"*",click(){e.setAttribute("data-subtype","s"),e.textContent="*",a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),z(t.toolbar.range)}},{label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.setAttribute("data-subtype","s"),e.textContent="*",a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),z(t.toolbar.range)}},{label:window.siyuan.languages.link,icon:"iconLink",click(){e.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${e.getAttribute("data-id")}">${e.innerHTML}</span><wbr>`,a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),re(a,t.toolbar.range)}}]),e.parentElement.textContent.trim()===e.textContent.trim()&&e.parentElement.tagName==="DIV"&&r.push({label:window.siyuan.languages.blockEmbed,icon:"iconSQL",click(){const c=`<div data-content="select * from blocks where id='${i}'" data-node-id="${s}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${ee().format("YYYYMMDDHHmmss")}">${a.querySelector(".protyle-attr").outerHTML}</div>`;a.outerHTML=c,j(t,s,c,l),Se(t,t.wysiwyg.element)}}),r.push({label:window.siyuan.languages.defBlock,click(){_("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!1})}}),r.push({label:window.siyuan.languages.defBlockChildren,click(){_("/api/block/swapBlockRef",{refID:s,defID:i,includeChildren:!0})}}),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:r}).element)}window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,icon:"iconCopy",click(){const r=e.getAttribute("data-subtype")==="s"?'"':"'";Pe(`((${i} ${r}${e.textContent}${r}))`)}}).element),t.disabled||window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),re(a,t.toolbar.range)}}).element),(n=t==null?void 0:t.app)!=null&&n.plugins&&ft({plugins:t.app.plugins,type:"open-menu-blockref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),t.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{a.outerHTML!==l&&(a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,a.outerHTML,l),l=a.outerHTML);const r=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);r&&!t.element.contains(r.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),z(t.toolbar.range))})},ic=(t,e)=>{var n;const a=de(e);window.siyuan.menus.menu.remove(),t.toolbar.showContent(t,a,e),(n=t==null?void 0:t.app)!=null&&n.plugins&&ft({plugins:t.app.plugins,type:"open-menu-content",detail:{protyle:t,range:a,element:e},separatorPosition:"top"})},Fi=(t,e)=>{if(t.block.showAll)mt({protyle:t,id:t.block.parent2ID,focusId:e});else{const n=t.path.split("/");n.length>2&&Ke(t.app,n[n.length-2],[g.CB_GET_FOCUS,g.CB_GET_SCROLL])}},mt=t=>{var e,n;if(t.protyle.options.backlinkData)return;typeof t.isPushBack=="undefined"&&(t.isPushBack=!0),typeof t.reload=="undefined"&&(t.reload=!1);const a=(e=t.protyle.breadcrumb)==null?void 0:e.element.querySelector(".protyle-breadcrumb__item--active");if(!t.reload&&a&&a.getAttribute("data-node-id")===t.id){if(t.id===t.protyle.block.rootID)return;const i=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`);if(i){ce(i),i.scrollIntoView();return}}(n=window.siyuan.mobile)!=null&&n.editor&&(window.siyuan.storage[g.LOCAL_DOCINFO]={id:t.id},et(g.LOCAL_DOCINFO,window.siyuan.storage[g.LOCAL_DOCINFO]),t.isPushBack&&Pi()),_("/api/filetree/getDoc",{id:t.id,size:t.id===t.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:g.SIZE_GET_MAX},i=>{if(t.isPushBack?qe({data:i,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[g.CB_GET_FOCUS,g.CB_GET_HTML]:[g.CB_GET_ALL,g.CB_GET_FOCUS,g.CB_GET_HTML],afterCB:t.callback}):qe({data:i,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[g.CB_GET_FOCUS,g.CB_GET_HTML,g.CB_GET_UNUNDO]:[g.CB_GET_ALL,g.CB_GET_FOCUS,g.CB_GET_UNUNDO,g.CB_GET_HTML],afterCB:t.callback}),t.focusId){const s=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`);if(s)ce(s),s.scrollIntoView();else if(t.id===t.protyle.block.rootID){_("/api/filetree/getDoc",{id:t.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{qe({data:l,protyle:t.protyle,action:t.isPushBack?[g.CB_GET_FOCUS]:[g.CB_GET_FOCUS,g.CB_GET_UNUNDO]})});return}}else t.id!==t.protyle.block.rootID&&(t.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{t.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365))})},Ui=(t,e,n,a)=>{var i;window.siyuan.menus.menu.remove();const s=I(n);if(!s)return;Y(["util","toolbar","hint"],t);const l=s.getAttribute("data-node-id"),o=n.querySelector("img"),r=n.querySelector(".protyle-action__title"),c=s.outerHTML;window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<textarea style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.imageURL}">${o.getAttribute("src")}</textarea>`,bind(b){b.querySelector("textarea").addEventListener("input",m=>{if(m.isComposing)return;const h=m.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");if(o.setAttribute("src",h),o.setAttribute("data-src",h),h.startsWith("assets/")){const w=n.querySelector(".img__net");w&&w.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')})}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<textarea style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.title}"></textarea>`,bind(b){const m=b.querySelector("textarea");m.value=r.textContent,m.addEventListener("input",h=>{const w=h.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");o.setAttribute("title",w),r.textContent=w,en(r),n.style.maxWidth=o.clientWidth+10+"px"})}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<textarea style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.tooltipText}"></textarea>`,bind(b){b.querySelector("textarea").value=o.getAttribute("alt")||""}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){Pe(t.lute.BlockDOM2StdMd(n.outerHTML))}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy+" PNG",accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){Qs(o)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){Pe(t.lute.BlockDOM2StdMd(n.outerHTML)),n.outerHTML="<wbr>",s.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,l,s.outerHTML,c),re(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",s.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,l,s.outerHTML,c),re(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element);const u=o.getAttribute("data-src");u.startsWith("assets/")&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.rename,click(){Li(u)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){$l(t,s,[n],l,c)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){Il(t,s,[n],l,c)}}).element);const d=parseInt(n.style.width||"0");window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.width,submenu:[Dn("25%",n,o,t,l,s,c),Dn("33%",n,o,t,l,s,c),Dn("50%",n,o,t,l,s,c),Dn("67%",n,o,t,l,s,c),Dn("75%",n,o,t,l,s,c),Dn("100%",n,o,t,l,s,c),{type:"separator"},{label:`<div aria-label="${d===0?window.siyuan.languages.default:d+"%"}" class="b3-tooltips b3-tooltips__n${H()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${d}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(b){const m=b.querySelector("input");m.addEventListener("input",()=>{n.style.width=m.value+"%",o.style.width="10000px",n.style.maxWidth="",m.parentElement.setAttribute("aria-label",`${m.value}%`)}),m.addEventListener("change",()=>{s.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,l,s.outerHTML,c),window.siyuan.menus.menu.remove(),ce(s)})}},{type:"separator"},Dn(window.siyuan.languages.default,n,o,t,l,s,c)]}).element);const f=o.getAttribute("src");f&&(window.siyuan.menus.menu.append(new T({type:"separator"}).element),ba(t.app,f,!1,!1)),(i=t==null?void 0:t.app)!=null&&i.plugins&&ft({plugins:t.app.plugins,type:"open-menu-image",detail:{protyle:t,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY});const p=window.siyuan.menus.menu.element.querySelectorAll("textarea");p[0].focus(),window.siyuan.menus.menu.removeCB=()=>{const b=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');b&&_("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:b.value}),o.setAttribute("alt",p[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),s.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,l,s.outerHTML,c)}},ya=(t,e,n=!1)=>{var a;window.siyuan.menus.menu.remove();const i=I(e);if(!i)return;Y(["util","toolbar","hint"],t);const s=i.getAttribute("data-node-id"),l=i.outerHTML,o=e.getAttribute("data-href");window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${H()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.link}"></textarea>`,bind(u){const d=u.querySelector("textarea");d.value=Lute.UnEscapeHTMLStr(o)||"",d.addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&!f.isComposing)f.preventDefault(),f.stopPropagation(),u.nextElementSibling.querySelector("textarea").focus();else if(In(f))return})}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<textarea style="width: ${H()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.anchor}"></textarea>`,bind(u){const d=u.querySelector("textarea");let f=e.textContent.replace(g.ZWSP,"");!f&&o&&(f=o.replace("https://","").replace("http://",""),f.length>24&&(f=f.substring(0,g.SIZE_LINK_TEXT_MAX)+"..."),e.innerHTML=Lute.EscapeHTMLStr(f)),d.value=f,d.addEventListener("compositionend",()=>{e.innerHTML=Lute.EscapeHTMLStr(d.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),d.addEventListener("input",p=>{p.isComposing||(e.innerHTML=Lute.EscapeHTMLStr(d.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),d.addEventListener("keydown",p=>{if((p.key==="Enter"||p.key==="Escape")&&!p.isComposing)p.preventDefault(),p.stopPropagation(),window.siyuan.menus.menu.remove();else if(p.key==="Tab"&&!p.isComposing)p.preventDefault(),p.stopPropagation(),p.shiftKey?u.previousElementSibling.querySelector("textarea").focus():u.nextElementSibling.querySelector("textarea").focus();else if(In(p))return})}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:`<textarea style="width: ${H()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field" placeholder="${window.siyuan.languages.title}"></textarea>`,bind(u){const d=u.querySelector("textarea");d.value=Lute.UnEscapeHTMLStr(e.getAttribute("data-title")||""),d.addEventListener("keydown",f=>{if((f.key==="Enter"||f.key==="Escape")&&!f.isComposing)f.preventDefault(),f.stopPropagation(),window.siyuan.menus.menu.remove();else if(f.key==="Tab"&&f.shiftKey&&!f.isComposing)f.preventDefault(),f.stopPropagation(),u.previousElementSibling.querySelector("textarea").focus();else if(In(f))return})}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const u=i.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),i.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,i.outerHTML,u),re(i,t.toolbar.range)}}).element),window.siyuan.menus.menu.append(new T({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){Bi(e,t.toolbar.range),j(t,s,i.outerHTML,l)}}).element),o!=null&&o.startsWith("assets/")&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.rename,click(){Li(o)}}).element),o!=null&&o.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new T({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){e.setAttribute("data-subtype","s");const u=e.getAttribute("data-type").split(" ");u.push("block-ref"),u.splice(u.indexOf("a"),1),e.setAttribute("data-type",u.join(" ")),e.setAttribute("data-id",o==null?void 0:o.replace("siyuan://blocks/","")),e.removeAttribute("data-href"),e.removeAttribute("data-title"),i.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,i.outerHTML,l),t.toolbar.range.selectNode(e),t.toolbar.range.collapse(!1),z(t.toolbar.range)}}).element),o&&(window.siyuan.menus.menu.append(new T({type:"separator"}).element),ba(t.app,o,!1,!0)),(a=t==null?void 0:t.app)!=null&&a.plugins&&ft({plugins:t.app.plugins,type:"open-menu-link",detail:{protyle:t,element:e},separatorPosition:"top"});const r=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:r.left,y:r.top+26,h:26});const c=window.siyuan.menus.menu.element.querySelectorAll("textarea");n||t.lute.IsValidLinkDest(o)?c[1].select():c[0].select(),window.siyuan.menus.menu.removeCB=()=>{c[2].value?e.setAttribute("data-title",Lute.EscapeHTMLStr(c[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-title"),e.setAttribute("data-href",Lute.EscapeHTMLStr(c[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")));const u=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);e.textContent===""||e.textContent===g.ZWSP?Bi(e,u&&!t.element.contains(u.startContainer)?t.toolbar.range:void 0):u&&!t.element.contains(u.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),z(t.toolbar.range)),i.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,s,i.outerHTML,l)}},Wi=(t,e)=>{var n;window.siyuan.menus.menu.remove();const a=I(e);if(!a)return;Y(["util","toolbar","hint"],t);const i=a.getAttribute("data-node-id");let s=a.outerHTML;window.siyuan.menus.menu.append(new T({label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(o){const r=o.querySelector("input");r.value=e.textContent.replace(g.ZWSP,""),r.addEventListener("change",()=>{j(t,i,a.outerHTML,s),s=a.outerHTML}),r.addEventListener("compositionend",()=>{e.innerHTML=g.ZWSP+Lute.EscapeHTMLStr(r.value||"")}),r.addEventListener("input",c=>{c.isComposing||(e.innerHTML=g.ZWSP+Lute.EscapeHTMLStr(r.value||""))}),r.addEventListener("keydown",c=>{if((c.key==="Enter"||c.key==="Escape")&&!c.isComposing){if(c.preventDefault(),c.stopPropagation(),r.value)t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),z(t.toolbar.range);else{const u=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,i,a.outerHTML,u),re(a,t.toolbar.range)}window.siyuan.menus.menu.remove()}else if(In(c))return})}}).element),window.siyuan.menus.menu.append(new T({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){t.toolbar.range.setStart(e.firstChild,0),t.toolbar.range.setEnd(e.lastChild,e.lastChild.textContent.length),t.toolbar.setInlineMark(t,"tag","range")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.rename,click(){hs(e.textContent.replace(g.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const o=a.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,i,a.outerHTML,o),re(a,t.toolbar.range)}}).element),(n=t==null?void 0:t.app)!=null&&n.plugins&&ft({plugins:t.app.plugins,type:"open-menu-tag",detail:{protyle:t,element:e},separatorPosition:"top"});const l=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+26,h:26}),window.siyuan.menus.menu.element.querySelector("input").select()},Dn=(t,e,n,a,i,s,l)=>({label:t,click(){s.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),t===window.siyuan.languages.default?(e.style.display==="block"?(e.style.width="",e.style.maxWidth=""):e.removeAttribute("style"),n.removeAttribute("style")):(e.style.width=t,e.style.maxWidth="",n.style.width="10000px"),j(a,i,s.outerHTML,l),ce(s)}}),sc=(t,e)=>{const n=e.getAttribute("data-node-id"),a=e.querySelector("iframe");let i=e.outerHTML;const s=[{iconHTML:"",label:`<textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(o){o.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""),u=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||u&&u[1])){const d={bvid:ne("bvid",c)||u&&u[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((b,m)=>{m===0&&(b=b.substr(1));const h=b.split("=");d[h[0]]=h[1]});let f="https://player.bilibili.com/player.html?";const p=Object.keys(d);p.forEach((b,m)=>{f+=`${b}=${d[b]}`,m<p.length-1&&(f+="&")}),a.setAttribute("src",f),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",c);j(t,n,e.outerHTML,i),i=e.outerHTML,r.stopPropagation()})}}],l=a.getAttribute("src");return l?(s.push({type:"separator"}),s.concat(ba(t.app,l,!0,!1))):s},lc=(t,e,n)=>{const a=e.getAttribute("data-node-id"),i=e.querySelector(n==="NodeVideo"?"video":"audio");let s=e.outerHTML;const l=[{iconHTML:"",label:`<textarea rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(c){c.querySelector("textarea").addEventListener("change",u=>{i.setAttribute("src",u.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),j(t,a,e.outerHTML,s),s=e.outerHTML,u.stopPropagation()})}}],o=i.getAttribute("src");o.startsWith("assets/")&&(l.push({type:"separator"}),l.push({label:window.siyuan.languages.rename,click(){Li(o)}}));const r=i.getAttribute("src");return r&&l.push({label:window.siyuan.languages.openBy,submenu:ba(t.app,r,!0,!1)}),l},oc=(t,e,n,a)=>{var i;const s=[],l=Ft(n);(n.rowSpan>1||n.colSpan>1)&&s.push({label:window.siyuan.languages.cancelMerged,click:()=>{const v=e.outerHTML;let L=n.rowSpan,D=n.parentElement;const O=n.colSpan;for(;L>0&&D;){let P=D.children[l],Z=O;for(;Z>0&&P;)P.classList.remove("fn__none"),P.colSpan=1,P.rowSpan=1,P=P.nextElementSibling,Z--;D=D.nextElementSibling,L--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let P;if(Array.from(e.querySelectorAll("thead tr")).find(Z=>{if(P=Z,Array.from(Z.children).forEach(pe=>{(pe.rowSpan!==1||pe.classList.contains("fn__none"))&&(P=void 0)}),P)return!0}),P){const Z=e.querySelector("tbody"),pe=e.querySelector("thead");for(;!P.isSameNode(pe.lastElementChild);)Z.insertAdjacentElement("afterbegin",pe.lastElementChild)}}z(a),j(t,e.getAttribute("data-node-id"),e.outerHTML,v)}});const o=e.querySelectorAll("col")[l];(o.style.width||o.style.minWidth)&&s.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const v=e.outerHTML;o.style.width="",o.style.minWidth="",j(t,e.getAttribute("data-node-id"),e.outerHTML,v)}});const r=e.getAttribute("custom-pinthead");s.push({icon:"iconPin",label:r?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const v=e.outerHTML;r?e.removeAttribute("custom-pinthead"):e.setAttribute("custom-pinthead","true"),j(t,e.getAttribute("data-node-id"),e.outerHTML,v)}}),s.push({type:"separator"}),s.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{tn(t,[n],e,"left",a)}}),s.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{tn(t,[n],e,"center",a)}}),s.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{tn(t,[n],e,"right",a)}}),s.push({type:"separator"});const c=e.querySelector("table"),u=n.parentElement.querySelector(".fn__none");let d=!1,f=!1;Array.from(n.parentElement.children).forEach(v=>{v.colSpan>1&&(d=!0),v.rowSpan>1&&(f=!0)});let p=!1,b=!1,m=!1,h=n.parentElement.previousElementSibling;!h&&n.parentElement.parentElement.tagName==="TBODY"&&(h=c.querySelector("thead").lastElementChild),h&&(p=h.querySelector(".fn__none"),Array.from(h.children).forEach(v=>{v.colSpan>1&&(b=!0),v.rowSpan>1&&(m=!0)}));let w=!1,y=!1,E=!1,S=n.parentElement.nextElementSibling;!S&&n.parentElement.parentElement.tagName==="THEAD"&&(S=(i=c.querySelector("tbody"))==null?void 0:i.firstElementChild),S&&(w=S.querySelector(".fn__none"),Array.from(S.children).forEach(v=>{v.colSpan>1&&(y=!0),v.rowSpan>1&&(E=!0)}));let x=!0;Array.from(c.rows).find(v=>{const L=v.cells[l];if(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1)return x=!1,!0});let k=!0;Array.from(c.rows).find(v=>{const L=v.cells[l+1];if(L&&(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1))return k=!1,!0});let C=!0;return Array.from(c.rows).find(v=>{const L=v.cells[l-1];if(L&&(L.classList.contains("fn__none")||L.colSpan>1||L.rowSpan>1))return C=!1,!0}),s.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{Fs(t,a,n,e)}}),(!w||w&&!E&&y)&&s.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{ki(t,a,n,e)}}),(x||C)&&s.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{Za(t,e,n,"beforebegin",a)}}),(x||k)&&s.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{Za(t,e,n,"afterend",a)}}),((!u||u&&!f&&d)&&(!p||p&&!m&&b)||(!u||u&&!f&&d)&&(!w||w&&!E&&y)||x&&C||x&&k)&&s.push({type:"separator"}),(!u||u&&!f&&d)&&(!p||p&&!m&&b)&&s.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{Ys(t,a,n,e)}}),(!u||u&&!f&&d)&&(!w||w&&!E&&y)&&s.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{js(t,a,n,e)}}),x&&C&&s.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{zs(t,a,n,e)}}),x&&k&&s.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{Vs(t,a,n,e)}}),(n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&d)||x)&&s.push({type:"separator"}),n.parentElement.parentElement.tagName!=="THEAD"&&(!u&&!f||u&&!f&&d)&&s.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{Us(t,a,n,e)}}),x&&s.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{Ws(t,a,e,n)}}),s},at=(t,e,n,a)=>{if(e.getAttribute("data-type")==="NodeListItem"&&e.childElementCount<4||e.getAttribute("data-type")==="NodeThematicBreak")return-1;let i="0";if(e.getAttribute("fold")==="1"){if(typeof n=="boolean"&&!n)return-1;e.removeAttribute("fold"),e.querySelectorAll(".protyle-linenumber").forEach(l=>{da(l)})}else{if(typeof n=="boolean"&&n)return-1;if(i="1",e.setAttribute("fold","1"),getSelection().rangeCount>0){const l=getSelection().getRangeAt(0),o=I(l.startContainer);o&&o.getBoundingClientRect().width===0&&ce(e,void 0,!1)}e.querySelectorAll(".img--select, .av__cell--select, .av__row--select").forEach(l=>{l.classList.contains("av__row--select")?(l.classList.remove("av__row--select"),l.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),Un(l)):l.classList.remove("img--select","av__cell--select")})}const s=e.getAttribute("data-node-id");return e.getAttribute("data-type")==="NodeHeading"?i==="0"?(e.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" src="/stage/loading-pure.svg"></div>'),F(t,[{action:"unfoldHeading",id:s,data:a?"remove":void 0}],[{action:"foldHeading",id:s}])):(F(t,[{action:"foldHeading",id:s}],[{action:"unfoldHeading",id:s}]),bl(e)):F(t,[{action:"setAttrs",id:s,data:JSON.stringify({fold:i})}],[{action:"setAttrs",id:s,data:JSON.stringify({fold:i==="0"?"1":"0"})}]),gt(t),i},Dl=(t,e)=>{const n=he(t),a=[];if(n.isSameNode(t)||(t.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),e.block.rootID===e.block.id&&e.wysiwyg.element.childElementCount===0){const i=Lute.NewNodeID(),s=mn(!1,!1,i);a.push({action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}),e.wysiwyg.element.innerHTML=s.outerHTML}a.length>0&&F(e,a,[])},Ml=()=>{if(window.siyuan.transactions.length===0)return;const t=window.siyuan.transactions[0].protyle,e=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),_("/api/transactions",{session:t.id,app:g.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},a=>{if(window.siyuan.transactions.length===0?Fe([],t.block.rootID,!0):Ml(),(window.siyuan.config.sync.provider!==0&&!oa("")||window.siyuan.config.sync.provider===0&&!Qt(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),a.data[0].doOperations[0].action==="setAttrs"){const s=t.gutter.element.querySelector('[data-type="fold"]');s&&s.removeAttribute("disabled"),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${a.data[0].doOperations[0].id}"]`)&&(l.removeAttribute("data-render"),Se(t,l))});return}let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){const l=t.gutter.element.querySelector('[data-type="fold"]');if(l&&l.removeAttribute("disabled"),s.action==="unfoldHeading"){const o=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(r=>{if(r.lastElementChild.classList.contains("protyle-attr")||r.lastElementChild.remove(),Bl(s.retData,t),r.insertAdjacentHTML("afterend",s.retData),s.data==="remove"){const c=getSelection();c.rangeCount>0&&r.contains(c.getRangeAt(0).startContainer)&&ce(r.nextElementSibling,void 0,!0),r.remove()}}),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t),Se(t,t.wysiwyg.element),t.contentElement.scrollTop=o,t.scroll.lastScrollTop=o;return}t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&_("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{qe({data:o,protyle:t,action:[g.CB_GET_APPEND,g.CB_GET_UNCHANGEID]})});return}if(s.action==="update"){t.options.backlinkData&&(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(l=>{(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(l,"data-type","NodeBlockQueryEmbed"))&&(i&&(l.isSameNode(i.startContainer)||l.contains(i.startContainer))||(l.outerHTML=s.data.replace("<wbr>","")))}),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t),Se(t,t.wysiwyg.element)),Hl(t,s),_a(t,s.id);return}if(s.action==="delete"||s.action==="append"){t.options.backlinkData&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(l=>{A(l,"data-type","NodeBlockQueryEmbed")||l.remove()}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${s.id}"]`)&&(l.removeAttribute("data-render"),Se(t,l))});return}if(s.action==="move"){if(t.options.backlinkData){const l=[];Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(r,"data-type","NodeBlockQueryEmbed")){l.push(r);return}});let o=!1;s.previousID&&l.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&(r.after(l[0].cloneNode(!0)),o=!0)}):l.length>0&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{var c;(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&((c=r.firstElementChild)!=null&&c.classList.contains("protyle-action")?r.firstElementChild.after(l[0].cloneNode(!0)):r.prepend(l[0].cloneNode(!0)),o=!0)}),l.forEach(r=>{o?r.remove():!o&&r.parentElement&&Dl(r,t)})}t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${s.id}"]`)&&(l.removeAttribute("data-render"),Se(t,l))});return}if(s.action==="insert"){if(t.options.backlinkData){const l=[];s.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(o=>{var r;((r=o.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"))!==s.id&&!A(o,"data-node-id",s.id)&&(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(o.parentElement,"data-type","NodeBlockQueryEmbed"))&&(o.insertAdjacentHTML("afterend",s.data),l.push(o.nextElementSibling))}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(o=>{(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(o.parentElement,"data-type","NodeBlockQueryEmbed"))&&(o.firstElementChild&&o.firstElementChild.classList.contains("protyle-action")&&o.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(o.firstElementChild.insertAdjacentHTML("afterend",s.data),l.push(o.firstElementChild.nextElementSibling)):o.firstElementChild&&o.firstElementChild.getAttribute("data-node-id")!==s.id&&(o.insertAdjacentHTML("afterbegin",s.data),l.push(o.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(o=>{o.lastElementChild.getAttribute("spin")==="1"&&o.lastElementChild.remove()}),l.forEach(o=>{Oe(o),Ae(o),Ye(o,t),Se(t,o);const r=o.querySelector("wbr");r&&r.remove()})}_a(t,s.id)}})})},Hl=(t,e)=>{let n=!1;t.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${e.id}"]`).forEach(a=>{const i=document.createElement("div");i.innerHTML=e.data,i.querySelectorAll('[contenteditable="true"]').forEach(l=>{l.setAttribute("contenteditable","false")});const s=i.querySelector("wbr");s&&s.remove(),a.outerHTML=i.innerHTML,n=!0}),n&&(Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t))},Nl=(t,e,n,a)=>{a&&Ra(t[0]),t.forEach(i=>{i.remove()}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${e}"]`)&&(i.removeAttribute("data-render"),Se(n,i))})},Pl=(t,e,n,a)=>{t.forEach(s=>{s.outerHTML=n.data}),Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(s=>{if(s.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(s,"data-type","NodeBlockQueryEmbed"))return t[0]=s,!0});const i=t[0].querySelector("wbr");if(a){const s=de(t[0]);i?re(t[0],s):ce(t[0])}else i&&i.remove();Oe(t.length===1?t[0]:e.wysiwyg.element),Ae(t.length===1?t[0]:e.wysiwyg.element),Ye(t.length===1?t[0]:e.wysiwyg.element,e),Se(e,t.length===1?t[0]:e.wysiwyg.element),Hl(e,n),_a(e,n.id)},Yi=(t,e,n)=>{const a=[];if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{A(i.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(i)}),e.action==="setAttrs"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{JSON.parse(e.data).fold==="1"?i.setAttribute("fold","1"):i.removeAttribute("fold")});return}if(e.action==="unfoldHeading"){const i=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{e.retData&&(Bl(e.retData,t),s.insertAdjacentHTML("afterend",e.retData)),s.removeAttribute("fold"),e.data==="remove"&&s.remove()}),e.retData&&(Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t),Se(t,t.wysiwyg.element),t.contentElement.scrollTop=i,t.scroll.lastScrollTop=i);return}if(e.action==="foldHeading"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{i.setAttribute("fold","1"),e.retData||bl(i)}),e.retData&&e.retData.forEach(i=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`).forEach(s=>{s.remove()})});return}if(e.action==="delete"){a.length>0?Nl(a,e.id,t,n):n&&mt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{A(i.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(i)}),Nl(a,e.id,t,n)}});return}if(e.action==="update"){a.length>0?Pl(a,t,e,n):n&&mt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{A(i.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(i)}),Pl(a,t,e,n)}});return}if(e.action==="updateAttrs"){const i=e.data,s={};let l="",o="",r="",c="";Object.keys(i.new).forEach(d=>{s[d]=i.new[d];const f=Lute.EscapeHTMLStr(i.new[d]);d==="bookmark"?l=`<div class="protyle-attr--bookmark">${f}</div>`:d==="name"?o=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${f}</div>`:d==="alias"?r=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${f}</div>`:d==="memo"?c=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${f}"><svg><use xlink:href="#iconM"></use></svg></div>`:d==="custom-avs"&&(c='<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg></div>')});let u=l+o+r+c;if(t.block.rootID===e.id){if(t.title){const d=t.title.element.querySelector(".protyle-attr--refcount");d&&(u+=d.outerHTML),i.new[g.CUSTOM_RIFF_DECKS]&&i.new[g.CUSTOM_RIFF_DECKS]!==i.old[g.CUSTOM_RIFF_DECKS]?(t.title.element.style.animation="addCard 450ms linear",t.title.element.setAttribute(g.CUSTOM_RIFF_DECKS,i.new[g.CUSTOM_RIFF_DECKS]),setTimeout(()=>{t.title.element.style.animation=""},450)):i.new[g.CUSTOM_RIFF_DECKS]||t.title.element.removeAttribute(g.CUSTOM_RIFF_DECKS),t.title.element.querySelector(".protyle-attr").innerHTML=u}if(t.wysiwyg.renderCustom(s),i.new[g.CUSTOM_SY_FULLWIDTH]!==i.old[g.CUSTOM_SY_FULLWIDTH]&&ua(t),i.new[g.CUSTOM_SY_READONLY]!==i.old[g.CUSTOM_SY_READONLY]){let d=i.new[g.CUSTOM_SY_READONLY];d||(d=window.siyuan.config.editor.readOnly?"true":"false"),d==="true"?Yt(t):ei(t)}i.new.icon!==i.old.icon&&window.siyuan.mobile.editor.protyle.background.ial.icon!==i.new.icon&&(window.siyuan.mobile.editor.protyle.background.ial.icon=i.new.icon,window.siyuan.mobile.editor.protyle.background.render(window.siyuan.mobile.editor.protyle.background.ial,window.siyuan.mobile.editor.protyle.block.rootID));return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(d=>{if(d.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(i.old).forEach(p=>{d.removeAttribute(p)}),i.new.style&&i.new[g.CUSTOM_RIFF_DECKS]&&i.new[g.CUSTOM_RIFF_DECKS]!==i.old[g.CUSTOM_RIFF_DECKS]&&(i.new.style+=";animation:addCard 450ms linear"),Object.keys(i.new).forEach(p=>{d.setAttribute(p,i.new[p]),p===g.CUSTOM_RIFF_DECKS&&i.new[g.CUSTOM_RIFF_DECKS]!==i.old[g.CUSTOM_RIFF_DECKS]&&(d.style.animation="addCard 450ms linear",setTimeout(()=>{d.style.animation=""},450))});const f=d.lastElementChild.querySelector(".protyle-attr--refcount");f&&(u+=f.outerHTML),d.lastElementChild.innerHTML=u+g.ZWSP});return}if(e.action==="move"){let i;n&&getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),i.insertNode(document.createElement("wbr")));let s=!1;e.previousID&&a.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(l=>{A(l.parentElement,"data-type","NodeBlockQueryEmbed")||(l.after(a[0].cloneNode(!0)),s=!0)}):a.length>0&&(!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.prepend(a[0].cloneNode(!0)),s=!0):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(l=>{var o;A(l.parentElement,"data-type","NodeBlockQueryEmbed")||((o=l.firstElementChild)!=null&&o.classList.contains("protyle-action")?l.firstElementChild.after(a[0].cloneNode(!0)):l.prepend(a[0].cloneNode(!0)),s=!0)})),a.forEach(l=>{s?l.remove():!s&&l.parentElement&&Dl(l,t)}),n&&i&&(e.data==="focus"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(l=>{if(!A(l.parentElement,"data-type","NodeBlockQueryEmbed"))return ce(l),!0}):re(t.wysiwyg.element,i)),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(l=>{l.querySelector(`[data-node-id="${e.id}"],[data-node-id="${e.parentID}"],[data-node-id="${e.previousID}"]`)&&(l.removeAttribute("data-render"),Se(t,l))});return}if(e.action==="insert"){const i=[];if(e.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(s=>{const l=A(s.parentElement,"data-type","NodeBlockQueryEmbed");l?(l.removeAttribute("data-render"),Se(t,l)):(s.insertAdjacentHTML("afterend",e.data),i.push(s.nextElementSibling))}):!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.data),i.push(t.wysiwyg.element.firstElementChild)):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(s=>{var l;A(s.parentElement,"data-type","NodeBlockQueryEmbed")||((l=s.firstElementChild)!=null&&l.classList.contains("protyle-action")?(s.firstElementChild.insertAdjacentHTML("afterend",e.data),i.push(s.firstElementChild.nextElementSibling)):(s.insertAdjacentHTML("afterbegin",e.data),i.push(s.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(s=>{s.lastElementChild.getAttribute("spin")==="1"&&s.lastElementChild.remove()}),i.length===0)return;i.forEach(s=>{Oe(s),Ae(s),Ye(s,t),Se(t,s);const l=s.querySelector("wbr");if(n){const o=de(s);l?re(s,o):ce(s)}else l&&l.remove()}),_a(t,e.id)}else e.action==="append"?jt(t,!1):["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColIcon"].includes(e.action)?rc(t,e):e.action==="doUpdateUpdated"&&a.forEach(i=>{i.setAttribute("updated",e.data)})},ji=t=>{let e;const n=Lute.NewNodeID();if(t.type==="BlocksMergeSuperBlock")e=qs(t.level,n);else if(t.type==="Blocks2Blockquote")e=document.createElement("div"),e.classList.add("bq"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeBlockquote"),e.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(t.type.endsWith("Ls")){e=document.createElement("div"),e.classList.add("list"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeList"),t.type==="Blocks2ULs"?e.setAttribute("data-subtype","u"):t.type==="Blocks2OLs"?e.setAttribute("data-subtype","o"):e.setAttribute("data-subtype","t");let r="";t.selectsElement.forEach((c,u)=>{t.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:t.type==="Blocks2OLs"?r+=`<div data-marker="${u+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${u+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),e.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=t.selectsElement[0].getAttribute("data-node-id"),i=t.selectsElement[0].parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,s=[{action:"insert",id:n,data:e.outerHTML,nextID:a,parentID:i}],l=[];t.selectsElement[0].previousElementSibling?t.selectsElement[0].before(e):t.selectsElement[0].parentElement.prepend(e);let o;t.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const u=r.getAttribute("data-node-id");l.push({action:"move",id:u,previousID:o||n,parentID:i}),t.type.endsWith("Ls")?(s.push({action:"move",id:u,parentID:e.children[c].getAttribute("data-node-id")}),e.children[c].firstElementChild.after(r)):(s.push({action:"move",id:u,previousID:o,parentID:n}),e.lastElementChild.before(r)),o=r.getAttribute("data-node-id"),c===t.selectsElement.length-1&&l.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Se(t.protyle,r))}),F(t.protyle,s,l),ce(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.selectsElement[0].getAttribute("data-node-id")}"]`)),Y(["gutter"],t.protyle)},Bl=(t,e)=>{const n=document.createElement("template");n.innerHTML=t,Array.from(n.content.children).forEach(a=>{var i;(i=e.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`))==null||i.remove()})},on=t=>{let e=t.selectsElement,n;if(t.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),e=Array.from(t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0&&(e=[t.nodeElement]);let l=!1,o=!1,r=!1;if(e.find((c,u)=>{if(c.classList.contains("li"))return r=!0,!0;if((c.classList.contains("bq")||c.classList.contains("sb")||c.classList.contains("p"))&&(o=!0),c.nextElementSibling&&e[u+1]&&c.nextElementSibling.isSameNode(e[u+1]))l=!0;else if(u!==e.length-1)return l=!1,!0}),r||o&&t.type==="Blocks2Ps")return;e.length===1&&t.type==="Blocks2Hs"&&e[0].getAttribute("data-type")==="NodeHeading"&&t.level===parseInt(e[0].getAttribute("data-subtype").substr(1))&&(t.type="Blocks2Ps"),t.isContinue=l}let a="";const i=[],s=[];e.forEach((l,o)=>{(t.type==="Blocks2Ps"||t.type==="Blocks2Hs")&&l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&at(t.protyle,l),l.classList.remove("protyle-wysiwyg--select"),l.removeAttribute("select-start"),l.removeAttribute("select-end"),a+=l.outerHTML;const r=l.getAttribute("data-node-id");if(s.push({action:"update",id:r,data:l.outerHTML}),(t.type==="Blocks2Ps"||t.type==="Blocks2Hs")&&!t.isContinue)l.outerHTML=t.protyle.lute[t.type](l.outerHTML,t.level);else if(o===e.length-1){const c=document.createElement("div");c.innerHTML=t.protyle.lute[t.type](a,t.level),l.outerHTML=c.innerHTML}else l.remove()}),s.forEach(l=>{const o=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);i.push({action:"update",id:l.id,data:o.outerHTML})}),F(t.protyle,i,s),Oe(t.protyle.wysiwyg.element),Ae(t.protyle.wysiwyg.element),Ye(t.protyle.wysiwyg.element,t.protyle),Se(t.protyle,t.protyle.wysiwyg.element),n?re(t.protyle.wysiwyg.element,n):ce(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${e[0].getAttribute("data-node-id")}"]`)),Y(["gutter"],t.protyle)},_a=(t,e,n=0)=>{n>6||t.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${e}"]`).forEach(a=>{a.getAttribute("data-subtype")==="d"&&_("/api/block/getRefText",{id:e},i=>{a.innerHTML=i.data;const s=I(a);s&&_a(t,s.getAttribute("data-node-id"),n+1)})})};let ql;const F=(t,e,n)=>{if(!t){_("/api/transactions",{session:g.SIYUAN_APPID,app:g.SIYUAN_APPID,transactions:[{doOperations:e}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&e.length===1&&e[0].action==="update"&&a.doOperations[0].id===e[0].id&&t.transactionTime-s<g.TIMEOUT_INPUT&&(i=!0),t.wysiwyg.lastHTMLs={},n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.model&&t.model.headElement.classList.remove("item--unupdate"),t.updated=!0,i?t.undo.replace(e):t.undo.add(e,n)),i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=t,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=e):window.siyuan.transactions.push({protyle:t,doOperations:e,undoOperations:n}),t.transactionTime=s,window.clearTimeout(ql),ql=window.setTimeout(()=>{Ml()},g.TIMEOUT_INPUT*2)},j=(t,e,n,a)=>{n!==a&&F(t,[{id:e,data:n,action:"update"}],[{id:e,data:a,action:"update"}])},va=(t,e,n)=>{const a=[],i=[];t.forEach(s=>{const l=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:l,data:s.outerHTML}),n(s),a.push({action:"update",id:l,data:s.outerHTML})}),F(e,a,i)},Ol=t=>{const e=Lute.NewNodeID(),n=t.newValue.match(/^(.*) \((\d+)\)$/);n?t.newValue=`${n[1]} (${parseInt(n[2])+1})`:t.newValue=`${t.newValue} (1)`,["select","mSelect"].includes(t.type)?_("/api/av/renderAttributeView",{id:t.avID},a=>{const i=a.data;let s;i.view.columns.find(l=>{if(l.id===t.colId)return s=l.options,!0}),F(t.protyle,[{action:"addAttrViewCol",name:t.newValue,avID:t.avID,type:t.type,data:t.icon,id:e},{action:"sortAttrViewCol",avID:t.avID,previousID:t.colId,id:e},{action:"updateAttrViewColOptions",id:e,avID:t.avID,data:s}],[{action:"removeAttrViewCol",id:e,avID:t.avID}])}):F(t.protyle,[{action:"addAttrViewCol",name:t.newValue,avID:t.avID,type:t.type,data:t.icon,id:e},{action:"sortAttrViewCol",avID:t.avID,previousID:t.colId,id:e}],[{action:"removeAttrViewCol",id:e,avID:t.avID}]),xt({blockElement:t.protyle.wysiwyg.element.querySelector(`[data-av-id="${t.avID}"]`),protyle:t.protyle,type:t.type,name:t.newValue,icon:t.icon,previousId:t.colId,id:e})},rn=t=>{let e;t.data.view.columns.find(a=>{if(a.id===t.colId)return e=a,!0});let n=`<button class="b3-menu__item" data-type="nobg" data-col-id="${t.colId}">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goProperties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-col-type="${e.type}" data-icon="${e.icon}" data-type="update-icon">${e.icon?le(e.icon):`<svg><use xlink:href="#${Lt(e.type)}"></use></svg>`}</span>
    <span class="b3-menu__label" style="padding: 4px"><input data-type="name" class="b3-text-field fn__block" type="text" value="${e.name}"></span>
</button>`;return e.options&&e.options.length>0&&(n+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label" style="padding: 4px"><input data-type="addOption" class="b3-text-field fn__block fn__size200" type="text" placeholder="Enter ${window.siyuan.languages.addAttr}"></span>
</button>`,e.options.forEach(a=>{n+=`<button class="b3-menu__item${n?"":" b3-menu__item--current"}" draggable="true" data-name="${a.name}" data-color="${a.color}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`})),e.type==="number"?n+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${e.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${il(e.numberFormat)}</span>
</button>`:e.type==="template"&&(n+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <textarea rows="${e.template.split(`
`).length}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${e.template}</textarea>
</button>`),`<div class="b3-menu__items">
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="${e.hidden?"showCol":"hideCol"}">
    <svg class="b3-menu__icon" style=""><use xlink:href="#icon${e.hidden?"Eye":"Eyeoff"}"></use></svg>
    <span class="b3-menu__label">${e.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
</button>
<button class="b3-menu__item" data-type="duplicateCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="removeCol">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},cn=t=>{const e=t.data.id,n=t.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=t.data.view.columns.find(o=>o.id===n),i=t.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const o=i.value;o!==a.name&&(F(t.protyle,[{action:"updateAttrViewCol",id:n,avID:e,name:o,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:e,name:a.name,type:a.type}]),a.name=o,Tt(t.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`)))}),i.addEventListener("keydown",o=>{o.isComposing||(o.key==="Escape"?t.menuElement.parentElement.remove():o.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))});const s=t.menuElement.querySelector('[data-type="updateTemplate"]');s&&(s.addEventListener("blur",()=>{const o=s.value;o!==a.template&&(F(t.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:e,data:o,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:e,data:a.template,type:a.type}]),a.template=o)}),s.addEventListener("keydown",o=>{o.isComposing||(o.key==="Escape"?t.menuElement.parentElement.remove():o.key==="Enter"&&!o.shiftKey&&(s.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}));const l=t.menuElement.querySelector('[data-type="addOption"]');l&&l.addEventListener("keydown",o=>{if(!o.isComposing&&(o.key==="Escape"&&t.menuElement.parentElement.remove(),o.key==="Enter")){let r=!1;if(a.options.find(c=>{if(l.value===c.name)return r=!0,!0}),r)return;a.options.push({color:(a.options.length+1).toString(),name:l.value}),F(t.protyle,[{action:"updateAttrViewColOptions",id:n,avID:e,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:e,data:l.value}]),t.menuElement.innerHTML=rn({protyle:t.protyle,colId:n,data:t.data}),cn({protyle:t.protyle,menuElement:t.menuElement,data:t.data}),t.menuElement.querySelector('[data-type="addOption"]').focus()}})},Lt=t=>{switch(t){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath"}},xt=t=>{t.blockElement&&(t.blockElement.querySelectorAll(".av__row").forEach((e,n)=>{let a;t.previousId?a=e.querySelector(`[data-col-id="${t.previousId}"]`):a=e.lastElementChild.previousElementSibling;let i="";n===0?i=`<div class="av__cell" data-icon="${t.icon||""}" data-col-id="${t.id}" data-dtype="${t.type}" style="width: 200px;white-space: nowrap;">
    <div draggable="true" class="av__cellheader">
        ${t.icon?le(t.icon,"av__cellicon",!0):`<svg class="av__cellicon"><use xlink:href="#${Lt(t.type)}"></use></svg>`}
        <span class="av__celltext">${t.name}</span>
    </div>
    <div class="av__widthdrag"></div>
</div>`:i='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',a.insertAdjacentHTML("afterend",i)}),window.siyuan.menus.menu.remove(),Rl(t.protyle,t.blockElement,t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${t.id}"]`)))},Rl=(t,e,n)=>{const a=n.getAttribute("data-dtype"),i=n.getAttribute("data-col-id"),s=e.getAttribute("data-av-id"),l=n.querySelector(".av__celltext").textContent.trim(),o=new ut("av-header-cell",()=>{const u=window.siyuan.menus.menu.element.querySelector(".b3-text-field").value;u!==l&&(F(t,[{action:"updateAttrViewCol",id:i,avID:s,name:u,type:a}],[{action:"updateAttrViewCol",id:i,avID:s,name:l,type:a}]),Tt(n))});o.addItem({iconHTML:`<span style="align-self: center;margin-right: 8px;width: 14px;" class="block__icon block__icon--show">${n.dataset.icon?le(n.dataset.icon):`<svg><use xlink:href="#${Lt(a)}"></use></svg>`}</span>`,type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block fn__size200" type="text" value="${l}">`,bind(u){const d=u.querySelector(".block__icon");d.setAttribute("data-icon",n.dataset.icon),d.addEventListener("click",f=>{const p=d.getBoundingClientRect();hi("","av",{x:p.left,y:p.bottom,h:p.height,w:p.width},b=>{F(t,[{action:"setAttrViewColIcon",id:i,avID:s,data:b}],[{action:"setAttrViewColIcon",id:i,avID:s,data:n.dataset.icon}]),d.setAttribute("data-icon",b),d.innerHTML=b?le(b):`<svg><use xlink:href="#${Lt(a)}"></use></svg>`,Tt(n)}),f.preventDefault(),f.stopPropagation()}),u.querySelector("input").addEventListener("keydown",f=>{f.isComposing||f.key==="Enter"&&o.close()})}}),a!=="block"&&o.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){wn({protyle:t,blockElement:e,type:"edit",colId:i})}}),o.addSeparator(),o.addItem({icon:"iconUp",label:window.siyuan.languages.asc,click(){_("/api/av/renderAttributeView",{id:s},u=>{F(t,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:i,order:"ASC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),o.addItem({icon:"iconDown",label:window.siyuan.languages.desc,click(){_("/api/av/renderAttributeView",{id:s},u=>{F(t,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:i,order:"DESC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),a!=="mAsset"&&o.addItem({icon:"iconFilter",label:window.siyuan.languages.filter,click(){_("/api/av/renderAttributeView",{id:s},u=>{const d=u.data;let f;d.view.filters.find(p=>{if(p.column===i)return f=p,!0}),f||(f={column:i,operator:Ti(a),value:pa(a,"")},d.view.filters.push(f),F(t,[{action:"setAttrViewFilters",avID:s,data:[f]}],[{action:"setAttrViewFilters",avID:s,data:[]}])),$i({filter:f,protyle:t,data:d,target:e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),o.addSeparator(),a!=="block"&&(o.addItem({icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){F(t,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1}])}}),o.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){Ol({protyle:t,type:a,avID:s,colId:i,icon:o.element.querySelector(".block__icon").getAttribute("data-icon"),newValue:window.siyuan.menus.menu.element.querySelector(".b3-text-field").value})}}),o.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){F(t,[{action:"removeAttrViewCol",id:i,avID:s}],[{action:"addAttrViewCol",name:l,avID:s,type:a,id:i}]),el(e,i)}}),o.addSeparator()),o.addItem({label:`<label class="fn__flex" style="margin: 4px 0"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${n.style.whiteSpace==="nowrap"?"":" checked"}></label>`,bind(u){const d=u.querySelector("input");d.addEventListener("change",()=>{F(t,[{action:"setAttrViewColWrap",id:i,avID:s,data:d.checked}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!d.checked}])})}});const r=n.getBoundingClientRect();o.open({x:r.left,y:r.bottom,h:r.height});const c=window.siyuan.menus.menu.element.querySelector(".b3-text-field");c&&(c.select(),c.focus())},Ye=(t,e,n)=>{let a=[];t.getAttribute("data-type")==="NodeAttributeView"?a=[t]:a=Array.from(t.querySelectorAll('[data-type="NodeAttributeView"]')),a.length!==0&&a.length>0&&a.forEach(i=>{var s,l,o;if(i.getAttribute("data-render")==="true")return;let r;if(i.firstElementChild.innerHTML===""){i.style.alignSelf="",r=new Date().getTime();let b="";[1,2,3].forEach(()=>{b+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),i.firstElementChild.innerHTML=b}const c=((s=i.querySelector(".av__scroll"))==null?void 0:s.scrollLeft)||0,u=(l=i.querySelector(".av__row--header"))==null?void 0:l.style.transform,d=(o=i.querySelector(".av__row--footer"))==null?void 0:o.style.transform;let f="";const p=i.querySelector(".av__cell--select");p&&(f=p.parentElement.dataset.id+g.ZWSP+p.getAttribute("data-col-id")),_("/api/av/renderAttributeView",{id:i.getAttribute("data-av-id")},b=>{const m=b.data.view;let h='<div class="av__row av__row--header"><div class="av__firstcol"><svg style="height: 32px"><use xlink:href="#iconUncheck"></use></svg></div>',w="";m.columns.forEach(E=>{var S;E.hidden||(h+=`<div class="av__cell" data-col-id="${E.id}" data-icon="${E.icon}" data-dtype="${E.type}"  
style="width: ${E.width||"200px"};
${E.wrap?"":"white-space: nowrap;"}">
    <div draggable="true" class="av__cellheader">
        ${E.icon?le(E.icon,"av__cellicon",!0):`<svg class="av__cellicon"><use xlink:href="#${Lt(E.type)}"></use></svg>`}
        <span class="av__celltext">${E.name}</span>
    </div>
    <div class="av__widthdrag"></div>
</div>`,w+=`<div class="av__calc${w?"":" av__calc--show"}${E.calc&&E.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${E.id}" data-dtype="${E.type}" data-operator="${((S=E.calc)==null?void 0:S.operator)||""}"  
style="width: ${E.width||"200px"}">${Ur(E)||'<svg><use xlink:href="#iconDown"></use></svg>'+window.siyuan.languages.calc}</div>`)}),h+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-add"><svg><use xlink:href="#iconAdd"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show"  data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
</div>
</div>`,m.rows.forEach(E=>{h+=`<div class="av__row" data-id="${E.id}">
<div class="av__gutters ariaLabel" draggable="true" data-position="right" aria-label="${window.siyuan.languages.rowTip}">
    <button><svg><use xlink:href="#iconDrag"></use></svg></button>
</div>
<div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>`,E.cells.forEach((S,x)=>{var k,C,v,L,D,O,P,Z,pe;if(m.columns[x].hidden)return;let K="";if(["text","template"].includes(S.valueType))K=`<span class="av__celltext">${S.value&&S.value[S.valueType].content||""}</span>`;else if(["url","email","phone"].includes(S.valueType)){const te=S.value?S.value[S.valueType].content:"";let ue="";S.valueType==="url"&&(ue=` data-href="${te}"`),K=`<span class="av__celltext av__celltext--url" data-type="${S.valueType}"${ue}>${te}</span>`}else if(S.valueType==="block")K=`<span class="av__celltext">${S.value.block.content||""}</span>`,(k=S.value)!=null&&k.isDetached?K+=`<span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more" >${window.siyuan.languages.more}</span>`:K+=`<span class="b3-chip b3-chip--info b3-chip--small" data-type="block-ref" data-id="${S.value.block.id}" data-subtype="s">${window.siyuan.languages.openBy}</span>`;else if(S.valueType==="number")K=`<span class="av__celltext" data-content="${(C=S.value)!=null&&C.number.isNotEmpty?(v=S.value)==null?void 0:v.number.content:""}">${((L=S.value)==null?void 0:L.number.formattedContent)||""}</span>`;else if(S.valueType==="mSelect"||S.valueType==="select")(O=(D=S.value)==null?void 0:D.mSelect)==null||O.forEach(te=>{K+=`<span class="b3-chip" style="background-color:var(--b3-font-background${te.color});color:var(--b3-font-color${te.color})">${te.content}</span>`}),K?K=`<span class="av__celltext">${K}</span>`:K='<span class="av__celltext"></span>';else if(S.valueType==="date"){K='<span class="av__celltext">';const te=S.value?S.value.date:null;te&&te.isNotEmpty&&(K+=ee(te.content).format("YYYY-MM-DD HH:mm")),te&&te.hasEndDate&&te.isNotEmpty&&te.isNotEmpty2&&(K+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${ee(te.content2).format("YYYY-MM-DD HH:mm")}`),K+="</span>"}else if(["created","updated"].includes(S.valueType)){K='<span class="av__celltext">';const te=S.value?S.value[S.valueType]:null;te&&te.isNotEmpty&&(K+=ee(te.content).format("YYYY-MM-DD HH:mm")),K+="</span>"}else S.valueType==="mAsset"&&((Z=(P=S.value)==null?void 0:P.mAsset)==null||Z.forEach(te=>{te.type==="image"?K+=`<img class="av__cellassetimg" src="${te.content}">`:K+=`<span class="b3-chip av__celltext--url" data-url="${te.content}">${te.name}</span>`}),K?K=`<span class="av__celltext">${K}</span>`:K='<span class="av__celltext"></span>');["text","template","url","email","phone","number","date","created","updated"].includes(S.valueType)&&S.value&&S.value[S.valueType].content&&(K+=`<span data-type="copy" class="b3-tooltips b3-tooltips__n block__icon" aria-label="${window.siyuan.languages.copy}"><svg><use xlink:href="#iconCopy"></use></svg></span>`),h+=`<div class="av__cell" data-id="${S.id}" data-col-id="${m.columns[x].id}"
${S.valueType==="block"?'data-block-id="'+(S.value.block.id||"")+'"':""}  
${(pe=S.value)!=null&&pe.isDetached?' data-detached="true"':""} 
style="width: ${m.columns[x].width||"200px"};
${S.bgColor?`background-color:${S.bgColor};`:""}
white-space: ${m.columns[x].wrap?"pre-wrap":"nowrap"};
${S.valueType!=="number"?"":"flex-direction: row-reverse;"}
${S.color?`color:${S.color};`:""}">${K}</div>`}),h+="<div></div></div>"});let y="";b.data.views.forEach(E=>{y+=`<div data-id="${b.data.viewID}" class="item${E.id===b.data.viewID?" item--focus":""}">
    <svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>
    <span class="item__text">${E.name}</span>
</div>`}),setTimeout(()=>{if(i.firstElementChild.outerHTML=`<div>
    <div class="av__header">
        <div class="layout-tab-bar fn__flex">
            ${y}
            <div class="fn__flex-1"></div>
            <span data-type="av-filter" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${m.filters.length>0?" block__icon--active":""}" aria-label="${window.siyuan.languages.filter}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${m.sorts.length>0?" block__icon--active":""}" aria-label="${window.siyuan.languages.sort}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.more}">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
        </div>
        <div contenteditable="${e.disabled?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title" data-title="${m.name||""}" data-tip="${window.siyuan.languages.title}">${b.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        <div style="float: left;">
            ${h}
            <div class="av__row--add">
                <svg><use xlink:href="#iconAdd"></use></svg>
                ${window.siyuan.languages.addAttr}
            </div>
            <div class="av__row--footer"><div style="width: 24px"></div>${w}</div>
        </div>
    </div>
</div>`,i.setAttribute("data-render","true"),Ct(i),c&&(i.querySelector(".av__scroll").scrollLeft=c),u&&(i.querySelector(".av__row--header").style.transform=u),d&&(i.querySelector(".av__row--footer").style.transform=d),f){const E=i.querySelector(`.av__row[data-id="${f.split(g.ZWSP)[0]}"] .av__cell[data-col-id="${f.split(g.ZWSP)[1]}"]`);E&&E.classList.add("av__cell--select"),ce(i)}n&&n()},r?256-(new Date().getTime()-r):0)})})};let zi,Fl;const rc=(t,e)=>{if(e.action==="setAttrViewName"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.id}"]`)).forEach(a=>{const i=a.querySelector(".av__title");i&&(i.textContent=e.data,i.dataset.title=e.data,a.querySelector(".layout-tab-bar .item__text").textContent=e.data)}),zi===e.parentID&&t.contentElement.isSameNode(Fl))return;Fl=t.contentElement,zi=e.parentID;const n=e.avID;e.action==="setAttrViewColWidth"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(a=>{const i=a.querySelector(`.av__cell[data-col-id="${e.id}"]`);!i||i.style.width===e.data||a.querySelectorAll(".av__row").forEach(s=>{s.querySelector(`[data-col-id="${e.id}"]`).style.width=e.data})}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(a=>{a.removeAttribute("data-render"),Ye(a,t)}),setTimeout(()=>{zi=null},g.TIMEOUT_TRANSITION)},Ul=(t,e)=>{t.block.showAll=!0;let n="";e.forEach(a=>{n+=jl(a.blockPaths)+Yl(a.dom,a.expand)}),t.wysiwyg.element.innerHTML=n,Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t),Se(t,t.wysiwyg.element),ti(t),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&Yt(t)},Wl=(t,e)=>{e.firstElementChild.classList.contains("li")?t?e.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):e.firstElementChild.setAttribute("fold","1"):e.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(e.children).forEach((n,a)=>{(t&&a>2||!t&&a>1)&&((t&&a===3||!t&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},Yl=(t,e)=>{const n=document.createElement("template");return n.innerHTML=t,Wl(e,n.content),n.innerHTML},ku=(t,e)=>{fetchPost("/api/filetree/getDoc",{id:e.getAttribute("data-id"),size:Constants.SIZE_GET_MAX},n=>{e.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),e.classList.add("protyle-breadcrumb__item--active");let a=e.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const i=a;a=a.nextElementSibling,i.remove()}e.parentElement.insertAdjacentHTML("afterend",Yl(n.data.content,!0)),processRender(e.parentElement.parentElement),avRender(e.parentElement.parentElement,t),blockRender(t,e.parentElement.parentElement),n.data.isSyncing?disabledForeverProtyle(t):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?disabledProtyle(t):e.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&e.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},Lu=t=>{let e=t.nextElementSibling;for(;e&&!e.classList.contains("protyle-breadcrumb__bar");)e.classList.remove("fn__none"),e=e.nextElementSibling;t.remove()},jl=(t,e=!1)=>{let n="";return t.forEach((a,i)=>{i===0&&!e||(n+=`<span class="protyle-breadcrumb__item${i===t.length-1?" protyle-breadcrumb__item--active":""}" data-id="${a.id}">
    <svg class="popover__block" data-id="${a.id}"><use xlink:href="#${_t(a.type,a.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${a.name}">${a.name}</span>
</span>`,i!==t.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${n}</div>`},Se=(t,e,n)=>{let a=[];e.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true"),i.style.height=i.clientHeight-8+"px",i.innerHTML=`<div class="protyle-icons${A(i.parentElement,"data-type","NodeBlockQueryEmbed")?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${i.lastElementChild.outerHTML}`;const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let l=i.getAttribute("breadcrumb");l?l=l==="true":l=window.siyuan.config.editor.embedBlockBreadcrumb,tt(i,"sb")&&(l=!1),_("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[i.getAttribute("data-node-id"),t.block.rootID],breadcrumb:l},r=>{const c=i.querySelector(".fn__rotate");c&&c.classList.remove("fn__rotate");let u="";r.data.blocks.forEach(p=>{let b="";p.blockPaths.length!==0&&(b=jl(p.blockPaths,!0)),u+=`<div class="protyle-wysiwyg__embed" data-id="${p.block.id}">${b}${p.block.content}</div>`}),r.data.blocks.length>0?i.lastElementChild.insertAdjacentHTML("beforebegin",u+`<div style="position: absolute;">${g.ZWSP}</div>`):i.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${g.ZWSP}</div>`),Oe(i),Ae(i),Ye(i,t),n&&(t.contentElement.scrollTop=n);let d=0,f=i;for(;d<4&&f;)f=A(f.parentElement,"data-type","NodeBlockQueryEmbed"),d++;d<4&&i.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(p=>{Se(t,p)}),i.style.height=""})})},qe=t=>{if(t.action||(t.action=[]),t.protyle.wysiwyg.element.removeAttribute("data-top"),t.data.code===1){t.protyle.model?t.protyle.model.parent.parent.removeTab(t.protyle.model.parent.id,!1,!1):t.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`;return}if(t.data.code!==3&&(t.protyle.notebookId=t.data.data.box,t.protyle.path=t.data.data.path,!(t.data.data.eof&&!t.scrollAttr&&(t.action.includes(g.CB_GET_BEFORE)?t.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):t.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),t.data.data.mode!==4)))){if(Y(["gutter"],t.protyle),t.protyle.block.parentID=t.data.data.parentID,t.protyle.block.parent2ID=t.data.data.parent2ID,t.protyle.block.rootID=t.data.data.rootID,t.protyle.block.showAll=!1,t.protyle.block.mode=t.data.data.mode,t.protyle.block.blockCount=t.data.data.blockCount,t.protyle.block.scroll=t.data.data.scroll,t.protyle.block.action=t.action,t.action.includes(g.CB_GET_UNCHANGEID)||(t.protyle.block.id=t.data.data.id,t.protyle.scroll.lastScrollTop=0,t.protyle.contentElement.scrollTop=0,t.protyle.wysiwyg.element.setAttribute("data-doc-type",t.data.data.type)),t.action.includes(g.CB_GET_APPEND)||t.action.includes(g.CB_GET_BEFORE)||t.action.includes(g.CB_GET_HTML)){zl({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),ti(t.protyle);return}_("/api/block/getDocInfo",{id:t.protyle.block.rootID},e=>{t.protyle.options.render.title?t.protyle.title.render(t.protyle,e):(t.protyle.options.render.background&&t.protyle.background.render(e.data.ial,t.protyle.block.rootID),t.protyle.wysiwyg.renderCustom(e.data.ial)),zl({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),t.protyle.model&&Bc(e.data.ial.title),ti(t.protyle)})}},zl=(t,e)=>{if(e.contentElement.classList.contains("fn__none")&&e.wysiwyg.element.innerHTML!=="")return;e.block.showAll=t.action.includes(g.CB_GET_ALL);const n=e.contentElement.clientHeight*8;if(t.action.includes(g.CB_GET_APPEND)){if(!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad&&e.contentElement.scrollHeight>n){let a=e.wysiwyg.element.firstElementChild;const i=[];for(;e.wysiwyg.element.childElementCount>2&&i&&!e.wysiwyg.element.lastElementChild.isSameNode(a)&&e.contentElement.scrollHeight-a.offsetTop>n;){i.push(a);a=a.nextElementSibling}const s=a.getBoundingClientRect().top;i.forEach(l=>{l.remove()}),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-s),e.scroll.lastScrollTop=e.contentElement.scrollTop,Y(["toolbar"],e)}e.wysiwyg.element.insertAdjacentHTML("beforeend",t.content)}else if(t.action.includes(g.CB_GET_BEFORE)){const a=e.wysiwyg.element.firstElementChild,i=a.getBoundingClientRect().top;if(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.content),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-i),e.scroll.lastScrollTop=e.contentElement.scrollTop,!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad){const s=[];let l=e.wysiwyg.element.childElementCount,o=e.contentElement.scrollHeight,r=e.wysiwyg.element.lastElementChild;for(;l>2&&o>n&&r.getBoundingClientRect().top>window.innerHeight;)s.push(r),r=r.previousElementSibling,l--,o-=r.clientHeight+8;s.forEach(c=>{c.remove()}),Y(["toolbar"],e)}}else e.wysiwyg.element.innerHTML=t.content;if(t.action.includes(g.CB_GET_BACKLINK)&&Wl(t.expand,e.wysiwyg.element),Oe(e.wysiwyg.element),Ae(e.wysiwyg.element),Ye(e.wysiwyg.element,e),Se(e,e.wysiwyg.element),!t.action.includes(g.CB_GET_HISTORY)){if(e.options.render.scroll&&e.scroll.update(e),t.scrollAttr){if(e.contentElement.scrollTop=t.scrollAttr.scrollTop,t.action.includes(g.CB_GET_HL))Bs(e,t.scrollAttr.focusId,!0);else if(t.action.includes(g.CB_GET_FOCUS))if(t.scrollAttr.focusId){const a=ps(e.wysiwyg.element.querySelector(`[data-node-id="${t.scrollAttr.focusId}"]`),t.scrollAttr.focusStart,t.scrollAttr.focusEnd)}else Gl(e,t.action);if(!e.scroll.element.classList.contains("fn__none")){e.scroll.updateIndex(e,t.scrollAttr.startId);const a=e.contentElement.getBoundingClientRect();e.wysiwyg.element.clientHeight-parseInt(e.wysiwyg.element.style.paddingBottom)<e.contentElement.clientHeight&&e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom<a.bottom&&e.wysiwyg.element.firstElementChild.getBoundingClientRect().top>a.top&&oe(window.siyuan.languages.scrollGetMore)}}else if(t.action.includes(g.CB_GET_HL)){gt(e);const a=Bs(e,e.block.id,!0)}else if(t.action.includes(g.CB_GET_FOCUS))Gl(e,t.action);else if(t.action.includes(g.CB_GET_FOCUSFIRST)){const a=e.wysiwyg.element.offsetTop-16;gt(e,a,256),e.contentElement.scrollTop=a,ce(e.wysiwyg.element.firstElementChild)}if(t.isSyncing)Vl(e);else{e.breadcrumb&&(e.breadcrumb.element.nextElementSibling.textContent=""),e.element.removeAttribute("disabled-forever");let a=window.siyuan.config.readonly?"true":"false";a==="false"&&(a=e.wysiwyg.element.getAttribute(g.CUSTOM_SY_READONLY),a||(a=window.siyuan.config.editor.readOnly?"true":"false")),a==="true"?Yt(e):ei(e)}if(t.action.includes(g.CB_GET_SETID)&&(e.block.id=e.block.rootID,e.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),e.options.defId&&(e.wysiwyg.element.querySelectorAll(`[data-id="${e.options.defId}"]`).forEach(a=>{a.classList.add("def--mark")}),e.options.defId=void 0),!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("block__edit")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&e.contentElement.scrollHeight>0&&!t.action.includes(g.CB_GET_FOCUSFIRST)&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&_("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{qe({data:a,protyle:e,action:[g.CB_GET_APPEND,g.CB_GET_UNCHANGEID]})}),t.action.includes(g.CB_GET_APPEND)||t.action.includes(g.CB_GET_BEFORE)){e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle-dynamic",{protyle:e,positon:t.action.includes(g.CB_GET_APPEND)?"afterend":"beforebegin"})});return}e.options.render.breadcrumb&&(e.breadcrumb.toggleExit(!t.action.includes(g.CB_GET_ALL)),e.breadcrumb.render(e)),t.afterCB&&t.afterCB(),e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle",e)})}},Vl=t=>{Yt(t),t.breadcrumb&&!H()?t.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:oe(window.siyuan.languages._kernel[81]),t.element.setAttribute("disabled-forever","true")},Yt=t=>{if(window.siyuan.menus.menu.remove(),Y(["gutter","toolbar","select","hint","util"],t),t.disabled=!0,t.title){const e=t.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","false"),e.style.userSelect="text"}document.getElementById("toolbarName").setAttribute("readonly","readonly"),t.background&&(t.background.element.classList.remove("protyle-background--enable"),t.background.element.classList.remove("protyle-background--mobileshow")),t.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(e=>{e.classList.remove("protyle-icons--show")}),t.wysiwyg.element.style.userSelect="text",t.wysiwyg.element.setAttribute("contenteditable","false"),t.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(e=>{e.setAttribute("contenteditable","false")}),t.breadcrumb&&(t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.languages.unlockEdit)),Cn()},ei=t=>{if(t.element.getAttribute("disabled-forever")!=="true"){if(t.disabled=!1,H()?document.getElementById("toolbarName").removeAttribute("readonly"):(t.wysiwyg.element.setAttribute("contenteditable","true"),t.wysiwyg.element.style.userSelect=""),t.title){const e=t.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","true"),e.style.userSelect=""}t.background&&t.background.element.classList.add("protyle-background--enable"),t.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(e=>{N(e,"protyle-wysiwyg__embed")||e.setAttribute("contenteditable","true")}),t.breadcrumb&&(t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.languages.lockEdit)),Cn()}},Gl=(t,e)=>{let n;Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${t.block.id}"]`)).find(a=>{if(!A(a,"data-type","block-render",!0))return n=a,!0}),t.block.mode===4&&(gt(t),n=t.wysiwyg.element.lastElementChild),n&&!t.wysiwyg.element.firstElementChild.isSameNode(n)?(ce(n),n.scrollIntoView(),setTimeout(()=>{n.scrollIntoView()},g.TIMEOUT_LOAD)):ce(t.wysiwyg.element.firstElementChild)};let Kl;const cc=(t,e)=>{let n=e.getBoundingClientRect();e.addEventListener("scroll",()=>{if(!t.toolbar.element.classList.contains("fn__none")){const a=t.toolbar.element.getAttribute("data-inity").split(g.ZWSP),i=parseInt(a[0])+(parseInt(a[1])-e.scrollTop);n.width===0&&(n=e.getBoundingClientRect());const s=29;i<n.top-s||i>n.bottom-s?t.toolbar.element.style.display="none":(t.toolbar.element.style.top=i+"px",t.toolbar.element.style.display="")}t.wysiwyg.element.querySelectorAll(".av").forEach(a=>{if(a.parentElement.classList.contains("protyle-wysiwyg")){const i=a.offsetTop+48,s=a.querySelector(".av__row--header");s&&(i<e.scrollTop&&i+s.parentElement.clientHeight>e.scrollTop?s.style.transform=`translateY(${e.scrollTop-i}px)`:s.style.transform="");const l=a.querySelector(".av__row--footer");if(l){const o=i+l.parentElement.clientHeight,r=e.scrollTop+e.clientHeight+5;i+42+36*2<r&&o>r?l.style.transform=`translateY(${r-o}px)`:l.style.transform=""}}}),!t.element.classList.contains("block__edit")&&!H()&&t.contentElement.setAttribute("data-scrolltop",e.scrollTop.toString()),window.siyuan.dragElement||Y(["gutter"],t),t.scroll&&!t.scroll.element.classList.contains("fn__none")&&(clearTimeout(Kl),Kl=window.setTimeout(()=>{n=e.getBoundingClientRect();const a=document.elementFromPoint(n.left+n.width/2,n.top+10),i=I(a);if(!i){if((t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(N(a,"protyle-background")||N(a,"protyle-title"))){const s=t.scroll.element.querySelector(".b3-slider");s.value="1",t.scroll.element.setAttribute("aria-label",`Blocks 1/${t.block.blockCount}`)}return}t.scroll.updateIndex(t,i.getAttribute("data-node-id"))},g.TIMEOUT_LOAD)),!(t.wysiwyg.element.getAttribute("data-top")||t.block.showAll||t.scroll&&t.scroll.element.classList.contains("fn__none")||!t.scroll||t.scroll.lastScrollTop===e.scrollTop||t.scroll.lastScrollTop===-1)&&(t.scroll.lastScrollTop-e.scrollTop>0?e.scrollTop<e.clientHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(t.contentElement.style.width=t.contentElement.clientWidth+"px",t.contentElement.style.overflow="hidden",t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),_("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{t.contentElement.style.overflow="",t.contentElement.style.width="",qe({data:a,protyle:t,action:[g.CB_GET_BEFORE,g.CB_GET_UNCHANGEID]})})):e.scrollTop>e.scrollHeight-e.clientHeight*1.8&&t.wysiwyg.element.lastElementChild&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),_("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{qe({data:a,protyle:t,action:[g.CB_GET_APPEND,g.CB_GET_UNCHANGEID]})})),t.scroll.lastScrollTop=Math.max(e.scrollTop,0))},{capture:!1,passive:!0,once:!1})},dc=t=>{t.contentElement=document.createElement("div"),t.contentElement.className="protyle-content",t.options.render.background&&t.contentElement.appendChild(t.background.element),t.options.render.title&&t.contentElement.appendChild(t.title.element),t.contentElement.appendChild(t.wysiwyg.element),t.options.action.includes(g.CB_GET_HISTORY)||cc(t,t.contentElement),t.element.append(t.contentElement),t.element.appendChild(t.preview.element),t.upload&&t.element.appendChild(t.upload.element),t.options.render.scroll&&t.element.appendChild(t.scroll.element.parentElement),t.gutter&&t.element.appendChild(t.gutter.element),t.element.appendChild(t.hint.element),t.selectElement=document.createElement("div"),t.selectElement.className="protyle-select fn__none",t.element.appendChild(t.selectElement),t.element.appendChild(t.toolbar.element),t.element.appendChild(t.toolbar.subElement),Qn(t),fa(t,t.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p"),t.contentElement.addEventListener("touchstart",a=>{if(t.disabled)return;const i=a.target;if(N(i,"protyle-icons")||N(i,"item")||i.classList.contains("protyle-background__icon"))return;if(N(i,"protyle-background")){t.background.element.classList.toggle("protyle-background--mobileshow");return}const s=A(i,"data-type","NodeBlockQueryEmbed");s&&s.firstElementChild.classList.toggle("protyle-icons--show")});let e;const n=Ya();t.contentElement.addEventListener("mousewheel",a=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||n&&!a.metaKey||!n&&!a.ctrlKey||a.deltaX!==0)){if(a.preventDefault(),a.stopPropagation(),a.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(a.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;yi(),clearTimeout(e),e=window.setTimeout(()=>{_("/api/setting/setEditor",window.siyuan.config.editor),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(i=>{da(i)})},g.TIMEOUT_LOAD)}},{passive:!1})},Qn=(t,e)=>{t.element.removeAttribute("data-loading"),setTimeout(()=>{t.element.getAttribute("data-loading")!=="finished"&&t.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${e||""}</div>
</div>`)},g.TIMEOUT_LOAD)},ti=t=>{t.element.setAttribute("data-loading","finished"),t.element.querySelectorAll(".wysiwygLoading").forEach(e=>{e.remove()})},uc=t=>{if(t.options.action.includes(g.CB_GET_HISTORY))return{width:0,padding:0};const e=parseInt(t.wysiwyg.element.style.paddingLeft);let n=16,a=24;if(!H()){let o=t.wysiwyg.element.getAttribute(g.CUSTOM_SY_FULLWIDTH);o||(o=window.siyuan.config.editor.fullWidth?"true":"false");let r=(t.element.clientWidth-g.SIZE_EDITOR_WIDTH)/2;o==="false"&&r>96?(r>g.SIZE_EDITOR_WIDTH&&(r=t.element.clientWidth*.382/1.382),r=Math.ceil(r),n=r,a=r):t.element.clientWidth>g.SIZE_EDITOR_WIDTH&&(n=96,a=96)}let i="16px";if(t.options.typewriterMode&&(H()?i=window.innerHeight/5+"px":i=t.element.clientHeight/2+"px"),t.options.backlinkData?t.wysiwyg.element.style.padding=`4px ${n}px 4px ${a}px`:t.wysiwyg.element.style.padding=`16px ${n}px ${i} ${a}px`,t.options.render.background&&(t.background.element.lastElementChild.setAttribute("style",`left:${n}px`),t.background.element.querySelector(".protyle-background__img .protyle-icons").setAttribute("style",`right:${n}px`)),t.options.render.title&&(t.title.element.style.margin=`16px ${n}px 0 ${a}px`),window.siyuan.config.editor.displayBookmarkIcon){const o=document.getElementById("editorAttr");o&&(o.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${t.wysiwyg.element.clientWidth-n-a}px; }`)}const s=t.wysiwyg.element.getAttribute("data-realwidth"),l=t.wysiwyg.element.clientWidth-parseInt(t.wysiwyg.element.style.paddingLeft)-parseInt(t.wysiwyg.element.style.paddingRight);return t.wysiwyg.element.setAttribute("data-realwidth",l.toString()),{width:Math.abs(parseInt(s)-l),padding:Math.abs(e-parseInt(t.wysiwyg.element.style.paddingLeft))}},ni=(t,e=!1)=>{if(!t.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:t.block.rootID,startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:t.contentElement.scrollTop||parseInt(t.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!t.wysiwyg.element.contains(a.startContainer))&&(a=t.toolbar.range),a&&t.wysiwyg.element.contains(a.startContainer)){const s=I(a.startContainer);if(s){const l=Qe(s,void 0,a);n.focusId=s.getAttribute("data-node-id"),n.focusStart=l.start,n.focusEnd=l.end}}if(t.block.showAll&&(n.zoomInId=t.block.id),e)return n;const i=JSON.stringify(n);_("/api/attr/setBlockAttrs",{id:t.block.rootID,attrs:{scroll:i}},()=>{t.wysiwyg.element.setAttribute("scroll",i)})},Vi=t=>{var e,n;let a=[];if(t.mergedOptions?a=t.mergedOptions.action:t.focus?a=[g.CB_GET_UNUNDO,g.CB_GET_FOCUS]:a=[g.CB_GET_UNUNDO],t.scrollAttr.zoomInId){_("/api/filetree/getDoc",{id:t.scrollAttr.zoomInId,size:g.SIZE_GET_MAX},i=>{a.push(g.CB_GET_ALL),qe({data:i,protyle:t.protyle,action:a,scrollAttr:t.scrollAttr,afterCB:t.cb})});return}_("/api/filetree/getDoc",{id:t.scrollAttr.rootId||((e=t.mergedOptions)==null?void 0:e.blockId)||((n=t.protyle.block)==null?void 0:n.rootID)||t.scrollAttr.startId,startID:t.scrollAttr.startId,endID:t.scrollAttr.endId},i=>{qe({data:i,protyle:t.protyle,action:a,scrollAttr:t.scrollAttr,afterCB:t.cb})})},jt=(t,e)=>{if(!t.preview.element.classList.contains("fn__none")){t.preview.render(t);return}if(window.siyuan.config.editor.displayBookmarkIcon?t.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):t.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),t.title&&(t.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?t.title.element.classList.add("protyle-wysiwyg--attr"):t.title.element.classList.remove("protyle-wysiwyg--attr")),t.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),Qn(t),t.options.backlinkData){const n=t.element.getAttribute("data-ismention")==="true",a=N(t.element,"sy__backlink");if(a){const i=a.querySelectorAll(".b3-form__icon-input");_(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:t.element.getAttribute("data-defid"),refTreeID:t.block.rootID,keyword:n?i[1].value:i[0].value},s=>{t.options.backlinkData=n?s.data.backmentions:s.data.backlinks,Ul(t,t.options.backlinkData)})}}else gt(t),Vi({protyle:t,focus:e,scrollAttr:ni(t,!0)})},fc=()=>{if(window.siyuan.dialogs.find(i=>{if(i.element.getAttribute("data-key")===window.siyuan.config.keymap.general.dailyNote.custom)return i.destroy(),!0}))return;const e=Ga();if(e===0){oe(window.siyuan.languages.newFileTip);return}if(e===1){let i="";window.siyuan.notebooks.find(s=>{s.closed||(i=s.id)}),_("/api/filetree/createDailyNote",{notebook:i,app:g.SIYUAN_APPID});return}const n=window.siyuan.storage[g.LOCAL_DAILYNOTEID],a=window.siyuan.notebooks.find(i=>{if(i.id===n&&!i.closed)return!0});if(n&&a&&!H())_("/api/filetree/createDailyNote",{notebook:n,app:g.SIYUAN_APPID});else{let i="";window.siyuan.notebooks.forEach(r=>{r.closed||(i+=`<option value="${r.id}">${r.name}</option>`)});const s=new be({title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${i}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"});s.element.setAttribute("data-key",window.siyuan.config.keymap.general.dailyNote.custom);const l=s.element.querySelectorAll(".b3-button"),o=s.element.querySelector(".b3-select");o.value=n,l[0].addEventListener("click",()=>{s.destroy()}),l[1].addEventListener("click",()=>{const r=o.value;window.siyuan.storage[g.LOCAL_DAILYNOTEID]=r,et(g.LOCAL_DAILYNOTEID,window.siyuan.storage[g.LOCAL_DAILYNOTEID]),_("/api/filetree/createDailyNote",{notebook:r,app:g.SIYUAN_APPID}),s.destroy()})}},Gi=()=>{const t=g.HELP_PATH[window.siyuan.config.appearance.lang];_("/api/notebook/removeNotebook",{notebook:t,callback:g.CB_MOUNT_REMOVE},()=>{_("/api/notebook/openNotebook",{notebook:t})})},Ki=()=>{const t=new be({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");t.bindInput(t.element.querySelector("input"),()=>{e[1].dispatchEvent(new CustomEvent("click"))}),e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input").value;if(!Xa(n))return!1;_("/api/notebook/createNotebook",{name:n}),t.destroy()})},gc=t=>{let e="",n="";return e||window.siyuan.notebooks.find(a=>{if(!a.closed)return e=a.id,n="/",!0}),{notebookId:e,currentPath:n}},Jn=t=>{if(Ga()===0){oe(window.siyuan.languages.newFileTip);return}if(!t.notebookId){const e=gc(t.useSavePath);t.notebookId=e.notebookId,t.currentPath=e.currentPath}_("/api/filetree/getDocCreateSavePath",{notebook:t.notebookId},e=>{if(e.data.path.indexOf("/")>-1&&t.useSavePath||t.name)e.data.path.startsWith("/")||t.currentPath==="/"?_("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:we().join(e.data.path,t.name||""),markdown:""},n=>{Ke(t.app,n.data,[g.CB_GET_HL,g.CB_GET_CONTEXT])}):_("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.currentPath.endsWith(".sy")?t.currentPath:t.currentPath+".sy"},n=>{_("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:we().join(n.data,e.data.path,t.name||""),parentID:ze(t.currentPath,!0,!0),markdown:""},a=>{Ke(t.app,a.data,[g.CB_GET_HL,g.CB_GET_CONTEXT])})});else{let n=e.data.path||"Untitled";if(n=n.substring(n.lastIndexOf("/")+1),!Xa(n))return;const a=Lute.NewNodeID(),i=we().join(ze(t.currentPath,!1,!0),a+".sy");t.paths&&(t.paths[t.paths.indexOf(void 0)]=i),_("/api/filetree/createDoc",{notebook:t.notebookId,path:i,title:n,md:"",sorts:t.paths},()=>{Ke(t.app,a,[g.CB_GET_HL,g.CB_GET_CONTEXT])})}})},Zi=(t,e,n)=>{_("/api/filetree/getRefCreateSavePath",{notebook:e},a=>{a.data.path?a.data.path.startsWith("/")?n(ze(a.data.path,!1,!0)):_("/api/filetree/getHPathByPath",{notebook:e,path:t},i=>{n(ze(we().join(i.data,a.data.path),!1,!0))}):_("/api/filetree/getHPathByPath",{notebook:e,path:t},i=>{n(ze(i.data,!1,!0))})})},pc=(t,e)=>{Y(["dialog"]),Jn({app:t,useSavePath:!0,name:Ut(e.trim())||"Untitled"})},It=t=>{const e=document.getElementById("model");e.style.transform="translateY(0px)",e.querySelector(".toolbar__icon use").setAttribute("xlink:href","#"+t.icon),e.querySelector(".toolbar__text").innerHTML=t.title;const n=e.querySelector("#modelMain");n.innerHTML=t.html,t.bindEvent(n)};var mc=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const bc=(t,e)=>{const n=new be({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${t.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${t.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${t.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${t.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${t.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${t.types.document?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${t.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${t.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${t.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${t.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${t.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${t.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${t.types.databaseBlock?" checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px",height:"70vh"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.types[i.getAttribute("data-type")]=i.checked}),e(),n.destroy()})},xu=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.keyword,current:t.method===0,click(){t.method=0,e()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.querySyntax,current:t.method===1,click(){t.method=1,e()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:"SQL",current:t.method===2,click(){t.method=2,e()}}).element),window.siyuan.menus.menu.append(new MenuItem({iconHTML:"",label:window.siyuan.languages.regex,current:t.method===3,click(){t.method=3,e()}}).element)},ai=(t,e,n,a,i)=>{t.removed=!1;const s=t;s.name=a,e.push(Object.assign({},s)),window.siyuan.storage[g.LOCAL_SEARCHDATA]=Object.assign({},t),et(g.LOCAL_SEARCHDATA,window.siyuan.storage[g.LOCAL_SEARCHDATA]),_("/api/storage/setCriterion",{criterion:s},()=>{var l;i.destroy();const o=n.querySelector("#criteria").firstElementChild;o.classList.remove("fn__none"),(l=o.querySelector(".b3-chip--current"))==null||l.classList.remove("b3-chip--current"),o.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][o.childElementCount%7]}">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},hc=(t,e,n)=>{const a=new be({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),i=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{const s=a.element.querySelector("input").value;if(!s){oe(window.siyuan.languages._kernel[142]);return}H()?(t.k=document.querySelector("#toolbarSearch").value,t.r=n.querySelector("#toolbarReplace").value):(t.k=n.querySelector("#searchInput").value,t.r=n.querySelector("#replaceInput").value);const l=n.querySelector("#criteria").firstElementChild;let o="",r="";if(e.forEach(c=>{c.name===s&&(o=c.name),Zl(c,t)&&(r=c.name)}),o&&!r)Te(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(l.children).forEach(c=>{c.textContent===s&&c.remove()}),e.find((c,u)=>{if(c.name===s)return e.splice(u,1),!0}),ai(t,e,n,s,a)});else if(o&&r)if(o===r)a.destroy();else{const c=o===s?r:o;Te(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",s),()=>{Array.from(l.children).forEach(u=>{(u.textContent===r||u.textContent===o)&&u.remove()}),e.find((u,d)=>{if(u.name===c||u.name===o)return _("/api/storage/removeCriterion",{name:c}),e.splice(d,1),!0}),ai(t,e,n,s,a)})}else!o&&r?Te(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",r).replace("${y}",s),()=>{Array.from(l.children).forEach(c=>{c.textContent===r&&c.remove()}),e.find((c,u)=>{if(c.name===r)return _("/api/storage/removeCriterion",{name:r}),e.splice(u,1),!0}),ai(t,e,n,s,a)}):ai(t,e,n,s,a)})},wc=(t,e,n,a,i,s)=>mc(void 0,null,function*(){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore"),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.type,click(){bc(t,()=>{st(t,n,!0)})}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.searchMethod,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.keyword,current:t.method===0,click(){t.method=0,t.page=1,st(t,n,!0)}},{iconHTML:"",label:window.siyuan.languages.querySyntax,current:t.method===1,click(){t.method=1,t.page=1,st(t,n,!0)}},{iconHTML:"",label:"SQL",current:t.method===2,click(){t.method=2,t.page=1,st(t,n,!0)}},{iconHTML:"",label:window.siyuan.languages.regex,current:t.method===3,click(){t.method=3,t.page=1,st(t,n,!0)}}]}).element);const l=[{iconHTML:"",label:window.siyuan.languages.type,current:t.sort===0,click(){t.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:t.sort===1,click(){t.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:t.sort===2,click(){t.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:t.sort===3,click(){t.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:t.sort===4,click(){t.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:t.sort===6,click(){t.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:t.sort===7,click(){t.sort=7,a()}}];t.group===1&&l.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:t.sort===5,click(){t.sort=5,a()}}),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:t.group===0,click(){H()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),t.group=0,t.sort===5&&(t.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:t.group===1,click(){H()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),t.group=1,a()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){hc(t,e,n)}}).element),window.siyuan.menus.menu.append(new T({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)}),Zl=(t,e)=>!!(e.group===t.group&&e.hPath===t.hPath&&e.hasReplace===t.hasReplace&&e.k===t.k&&e.method===t.method&&e.r===t.r&&e.sort===t.sort&&Ue(e.types,t.types)&&Ue(e.idPath,t.idPath)),yc=(t,e,n)=>{_("/api/storage/getCriteria",{},a=>{let i="";a.data.forEach((s,l)=>{e.push(s);let o=!1;Zl(s,n)&&(o=!0),i+=`<div data-type="set-criteria" class="${o?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][l%7]}">${$e(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),t.innerHTML=`<div class="b3-chips">
    ${i}
</div>`,i===""?t.classList.add("fn__none"):t.classList.remove("fn__none")})},_c=t=>{const e=[];return t.querySelectorAll("mark").forEach(n=>{e.push(n.textContent)}),[...new Set(e)].join(" ")},Su=(t,e)=>{};let Xl;const dn=(t,e,n=1)=>{t.nextElementSibling.classList.remove("fn__none"),clearTimeout(Xl),Xl=window.setTimeout(()=>{e||(e=window.siyuan.storage[g.LOCAL_SEARCHASSET]);const a=t.querySelector('[data-type="assetPrevious"]');n>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=t.querySelector("#searchAssetInput");_("/api/search/fullTextSearchAssetContent",{page:n,query:i.value,types:e.types,method:e.method,orderBy:e.sort},s=>{var l,o;t.nextElementSibling.classList.add("fn__none");const r=t.querySelector('[data-type="assetNext"]');n<s.data.pageCount?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled");let c="";s.data.assetContents.forEach((d,f)=>{c+=`<div data-type="search-item" class="b3-list-item${f===0?" b3-list-item--focus":""}" data-id="${d.id}">
<span class="ft__on-surface">${d.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${d.content}</span>
<span class="b3-list-item__meta">${d.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${ja(d.path)}">${d.name}</span>
</div>`});const u=t.querySelector("#searchAssetPreview");s.data.assetContents.length>0?(u.classList.remove("fn__none"),(l=t.querySelector(".search__drag"))==null||l.classList.remove("fn__none"),Ql(u,s.data.assetContents[0].id,i.value,e.method)):(u.classList.add("fn__none"),(o=t.querySelector(".search__drag"))==null||o.classList.add("fn__none")),t.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${s.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${s.data.matchedAssetCount}</span>`,t.querySelector("#searchAssetList").innerHTML=c||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},g.TIMEOUT_INPUT)},Au=(t,e)=>{if(t.classList.contains("fn__none")){const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET].keys;if(!n||n.length===0)return;let a="";if(n.forEach(i=>{i!==e.value&&i&&(a+=`<div class="b3-list-item${a?"":" b3-list-item--focus"}">${escapeHtml(i)}</div>`)}),a==="")return;t.classList.remove("fn__none"),t.innerHTML=a}else t.classList.add("fn__none")},Ql=(t,e,n,a)=>{_("/api/search/getAssetContent",{id:e,query:n,queryMethod:a},i=>{t.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=t.querySelector("mark");if(s){s.classList.add("mark--hl");const l=t.getBoundingClientRect();t.scrollTop=t.scrollTop+s.getBoundingClientRect().top-l.top-l.height/2}})},vc=t=>{let e;const n=Array.from(t.querySelectorAll("mark"));if(n.find((a,i)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),e=n[i+1];return}}),e||(e=n[0]),e){e.classList.add("mark--hl");const a=t.getBoundingClientRect();t.scrollTop=t.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},Ec=(t,e)=>{const n=window.siyuan.storage[g.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[g.LOCAL_SEARCHASSET].method=0,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[g.LOCAL_SEARCHASSET].method=1,e()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[g.LOCAL_SEARCHASSET].method=3,e()}}).element),window.siyuan.menus.menu.fullscreen()},kc=t=>{let e="";return g.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{e+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${t[n]?" checked":""}>
    </label>`}),e},Lc=t=>{const e=window.siyuan.storage[g.LOCAL_SEARCHASSET].types,n=new be({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${kc(e)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{e[i.getAttribute("data-type")]=i.checked}),dn(t),et(g.LOCAL_SEARCHASSET,window.siyuan.storage[g.LOCAL_SEARCHASSET]),n.destroy()})},xc=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const a=window.siyuan.storage[g.LOCAL_SEARCHASSET],i=[{iconHTML:g.ZWSP,label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:g.ZWSP,label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:g.ZWSP,label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:g.ZWSP,label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.rebuildIndex,click(){e.nextElementSibling.classList.remove("fn__none"),_("/api/asset/fullReindexAssetContent",{},()=>{dn(e,a)})}}).element),window.siyuan.menus.menu.fullscreen()},Jl=(t,e,n)=>{if(e.method===1||e.method===2){oe(window.siyuan.languages._kernel[132]);return}const a=t.querySelector("#searchList"),i=t.querySelector("#toolbarReplace"),s=i.nextElementSibling;if(!s.classList.contains("fn__none"))return;let l=a.querySelector(".b3-list-item--focus");if(!l)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none"),a.previousElementSibling.innerHTML="";let o=[];n?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{o.push(r.getAttribute("data-node-id"))}):o=[l.getAttribute("data-node-id")],_("/api/search/findReplace",{k:e.method===0?_c(l):document.querySelector("#toolbarSearch").value,r:i.value,ids:o,types:e.types,method:e.method},r=>{var c;if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){oe(r.msg);return}if(!(o.length>1)){if(jt(window.siyuan.mobile.editor.protyle,!1),l.nextElementSibling?l.nextElementSibling.classList.add("b3-list-item--focus"):l.previousElementSibling&&l.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(l.nextElementSibling||l.previousElementSibling)l.remove();else{const u=l.parentElement.nextElementSibling||((c=l.parentElement.previousElementSibling.previousElementSibling)==null?void 0:c.previousElementSibling);u&&(u.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),u.nextElementSibling.classList.remove("fn__none"),u.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),l.parentElement.previousElementSibling.remove(),l.parentElement.remove()}else l.remove();if(l=a.querySelector(".b3-list-item--focus"),!l){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<l.offsetTop-a.clientHeight+30||a.scrollTop>l.offsetTop)&&(a.scrollTop=l.offsetTop-a.clientHeight+30)}})},eo=(t,e,n)=>{n.hasReplace!==e.hasReplace&&(e.hasReplace?(t.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),t.querySelector(".toolbar").classList.remove("fn__none")):(t.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),t.querySelector(".toolbar").classList.add("fn__none")));const a=t.querySelector("#searchPath");e.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${$e(e.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==e.group&&(e.group===0?(t.querySelector('[data-type="expand"]').classList.add("fn__none"),t.querySelector('[data-type="contract"]').classList.add("fn__none")):(t.querySelector('[data-type="expand"]').classList.remove("fn__none"),t.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;e.idPath.forEach(o=>{o.endsWith(".sy")&&(i=!1),o.split("/").length>1&&(s=!0)});const l=t.querySelector('[data-type="include"]');i?l.classList.add("toolbar__icon--active"):l.classList.remove("toolbar__icon--active"),s?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=e.k,t.querySelector("#toolbarReplace").value=e.r,Object.assign(n,e),window.siyuan.storage[g.LOCAL_SEARCHDATA]=Object.assign({},n),et(g.LOCAL_SEARCHDATA,window.siyuan.storage[g.LOCAL_SEARCHDATA]),st(n,t),window.siyuan.menus.menu.remove()},to=(t,e,n)=>{const a=document.querySelector("#searchList");let i="";t.forEach((l,o)=>{const r=At(l.box)+ze(l.hPath,!1);l.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${le(br(l.box)||g.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${bs(r)}</span>
</div><div>`,l.children.forEach((c,u)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${u===0&&o===0?" b3-list-item--focus":""}" data-node-id="${c.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${_t(c.type)}"></use></svg>
${le(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
</div>`}),i+="</div>"):i+=`<div class="b3-list-item b3-list-item--two${o===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${l.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${_t(l.type)}"></use></svg>
    ${le(l.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${l.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta" style="margin-top: -4px">${bs(r)}</span>
</div>`}),a.innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let s="";n&&(s=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e.page}/${n.data.pageCount||1}</span>`),a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=s};let no=0;const st=(t,e,n=!1)=>{clearTimeout(no),no=window.setTimeout(()=>{var a;n&&((a=e.querySelector("#criteria .b3-chip--current"))==null||a.classList.remove("b3-chip--current"));const i=e.querySelector(".fn__loading--top");i.classList.remove("fn__none");const s=e.querySelector('[data-type="previous"]'),l=e.querySelector('[data-type="next"]'),o=document.getElementById("toolbarSearch");o.value===""&&(!t.idPath||t.idPath.length===0)?_("/api/block/getRecentUpdatedBlocks",{},r=>{to(r.data,t),i.classList.add("fn__none"),s.setAttribute("disabled","true"),l.setAttribute("disabled","true")}):(t.page||(t.page=1),t.page>1?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),_("/api/search/fullTextSearchBlock",{query:o.value,method:t.method,types:t.types,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},r=>{to(r.data.blocks,t,r),i.classList.add("fn__none"),t.page<r.data.pageCount?l.removeAttribute("disabled"):l.setAttribute("disabled","disabled")}))},g.TIMEOUT_INPUT)},Sc=(t,e,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",c=>{c&&c.isComposing||(n.page=1,st(n,e,!0))}),a.addEventListener("input",c=>{c&&c.isComposing||(n.page=1,st(n,e,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[g.LOCAL_SEARCHDATA]=Object.assign({},n),et(g.LOCAL_SEARCHDATA,window.siyuan.storage[g.LOCAL_SEARCHDATA]))});const i=e.querySelector(".toolbar .toolbar__title");i.value=n.r||"";const s=[];yc(e.querySelector("#criteria"),s,n);const l=document.querySelector("#searchAssetsPanel"),o=e.querySelector("#searchList"),r=window.siyuan.storage[g.LOCAL_SEARCHASSET];e.addEventListener("click",c=>{var u;let d=c.target;for(;d&&!d.isSameNode(e);){const f=d.getAttribute("data-type");if(f==="previous"){d.getAttribute("disabled")||(n.page--,st(n,e)),c.stopPropagation(),c.preventDefault();break}else if(f==="next"){d.getAttribute("disabled")||(n.page++,st(n,e)),c.stopPropagation(),c.preventDefault();break}else if(f==="set-criteria"){n.removed=!1,(u=d.parentElement.querySelector(".b3-chip--current"))==null||u.classList.remove("b3-chip--current"),d.classList.add("b3-chip--current"),s.find(p=>{if(p.name===d.innerText.trim())return eo(e,p,n),!0}),c.stopPropagation(),c.preventDefault();break}else if(f==="remove-criteria"){const p=d.parentElement.innerText.trim();_("/api/storage/removeCriterion",{name:p}),s.find((b,m)=>{if(b.name===p)return s.splice(m,1),!0}),d.parentElement.parentElement.childElementCount===1&&d.parentElement.parentElement.classList.add("fn__none"),d.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(f==="remove-path"){n.idPath=[],n.hPath="",e.querySelector("#searchPath").classList.add("fn__none"),n.page=1,st(n,e,!0);const p=e.querySelector('[data-type="include"]');p.classList.remove("toolbar__icon--active"),p.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(f==="expand"){Array.from(o.children).forEach(p=>{p.classList.contains("b3-list-item")&&(p.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),p.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(f==="contract"){Array.from(o.children).forEach(p=>{p.classList.contains("b3-list-item")&&(p.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),p.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(f==="currentPath"&&!d.hasAttribute("disabled")){const p=St().protyle;_("/api/filetree/getHPathsByPaths",{paths:[p.path]},b=>{n.idPath=[we().join(p.notebookId,p.path)],n.hPath=b.data[0];const m=e.querySelector("#searchPath");m.classList.remove("fn__none"),m.innerHTML=`<div class="b3-chip b3-chip--middle">${$e(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const h=e.querySelector('[data-type="include"]');h.classList.remove("toolbar__icon--active"),h.removeAttribute("disabled"),n.page=1,st(n,e,!0)}),c.stopPropagation(),c.preventDefault();break}else if(f==="path"){Rn((p,b)=>{_("/api/filetree/getHPathsByPaths",{paths:p},m=>{n.idPath=[];const h=[];let w=!1;p.forEach((S,x)=>{S==="/"?(n.idPath.push(b[x]),h.push(At(b[x]))):(w=!0,n.idPath.push(we().join(b[x],S.replace(".sy",""))))}),m.data&&h.push(...m.data),n.hPath=h.join(" ");const y=e.querySelector("#searchPath");y.classList.remove("fn__none"),y.innerHTML=`<div class="b3-chip b3-chip--middle">${$e(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const E=e.querySelector('[data-type="include"]');E.classList.add("toolbar__icon--active"),w?E.removeAttribute("disabled"):E.setAttribute("disabled","disabled"),n.page=1,st(n,e,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(f==="include"&&!d.hasAttribute("disabled")){d.classList.toggle("toolbar__icon--active"),d.classList.contains("toolbar__icon--active")?n.idPath.forEach((p,b)=>{p.endsWith(".sy")&&(n.idPath[b]=p.replace(".sy",""))}):n.idPath.forEach((p,b)=>{!p.endsWith(".sy")&&p.split("/").length>1&&(n.idPath[b]=p+".sy")}),n.page=1,st(n,e,!0),c.stopPropagation(),c.preventDefault();break}else if(f==="toggle-replace"){n.hasReplace=!n.hasReplace,i.parentElement.classList.toggle("fn__none"),d.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(f==="more"){wc(n,s,e,()=>{n.page=1,st(n,e,!0)},()=>{eo(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock}},n)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(f==="replace-all"){Jl(e,n,!0),c.stopPropagation(),c.preventDefault();break}else if(f==="queryAsset"){Ec(d,()=>{dn(l,r),et(g.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(f==="filterAsset"){Lc(l),c.stopPropagation(),c.preventDefault();break}else if(f==="moreAsset"){xc(d,l,()=>{dn(l),et(g.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(f==="goAsset"){Ac(),c.stopPropagation(),c.preventDefault();break}else if(f==="goSearch"){l.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(f==="assetPrevious"){d.getAttribute("disabled")||dn(l,r,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(f==="assetNext"){d.getAttribute("disabled")||dn(l,r,parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(f==="replace"){Jl(e,n,!1),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__toggle")){d.parentElement.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")){if(d.getAttribute("data-type")==="search-new")pc(t,a.value);else if(d.getAttribute("data-type")==="search-item"){const p=d.getAttribute("data-node-id");p?(window.siyuan.mobile.editor.protyle&&gt(window.siyuan.mobile.editor.protyle),_("/api/block/checkBlockFold",{id:p},b=>{Ke(t,p,b.data?[g.CB_GET_ALL,g.CB_GET_HL]:[g.CB_GET_HL,g.CB_GET_CONTEXT,g.CB_GET_ROOTSCROLL])}),Be()):d.classList.contains("b3-list-item--focus")?d.classList.contains("b3-list-item--focus")&&vc(e.querySelector("#searchAssetPreview")):(e.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus"),Ql(e.querySelector("#searchAssetPreview"),d.dataset.id,e.querySelector("#searchAssetInput").value,window.siyuan.storage[g.LOCAL_SEARCHASSET].method))}else d.querySelector(".b3-list-item__toggle")&&(d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}d=d.parentElement}},!1)},zt=(t,e=window.siyuan.storage[g.LOCAL_SEARCHDATA])=>{$t(),pt();let n=!0,a=!1;e.idPath.forEach(i=>{i.endsWith(".sy")&&(n=!1),i.split("/").length>1&&(a=!0)}),It({title:`<input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">`,icon:"iconSearch",html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${e.hasReplace?"":" fn__none"}">
        <svg class="toolbar__icon"><use xlink:href="#iconReplace"></use></svg>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${e.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${$e(e.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${e.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${a?"":"disabled"} data-type="include" class="toolbar__icon${n?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
            <svg class="toolbar__icon"><use xlink:href="#iconSearch"></use></svg>
            <span class="toolbar__text"><input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block"></span>
            <svg class="toolbar__icon" data-type="goSearch">
                <use xlink:href="#iconCloseRound"></use>
            </svg>
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(i){Sc(t,i.firstElementChild,e),st(e,i)}})},Ac=()=>{const t=document.querySelector("#searchAssetsPanel");if(t.classList.remove("fn__none"),t.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[g.LOCAL_SEARCHASSET],a=t.querySelector("input");a.value=n.k,a.addEventListener("compositionend",i=>{i.isComposing||dn(t,n)}),a.addEventListener("input",i=>{i.isComposing||dn(t,n)}),dn(t,n)},ao=t=>{_("/api/storage/getRecentDocs",{},e=>{let n="";e.data.forEach((a,i)=>{n+=`<li data-index="${i}" data-node-id="${a.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${le(a.icon||g.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${$e(a.title)}</span>
</li>`}),It({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",i=>{const s=N(i.target,"b3-list-item");s&&Ke(t,s.dataset.nodeId,[g.CB_GET_SCROLL])})}})})},Xi=(t,e)=>{if(!t||t.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return t.forEach((a,i)=>{let s="";e&&(s=`data-id2="${e[i].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${On(a.path)} ${a.hSize}">${$e(a.title)}</span>
</li>`}),n};let ea,Ea;const Cc=(t,e)=>{const n=N(e,"history__diff");if(!n)return;const a=n.nextElementSibling.firstElementChild,i=n.nextElementSibling.lastElementChild;ea||(ea=new un(t,a.lastElementChild,{blockId:"",action:[g.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yt(ea.protyle),Ea=new un(t,i.lastElementChild,{blockId:"",action:[g.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yt(Ea.protyle)),_("/api/repo/openRepoSnapshotDoc",{id:e.getAttribute("data-id")},l=>{a.classList.remove("fn__none");const o=a.querySelector("textarea"),r=we().extname(l.data.content).toLowerCase();g.SIYUAN_ASSETS_IMAGE.concat(g.SIYUAN_ASSETS_AUDIO).concat(g.SIYUAN_ASSETS_VIDEO).includes(r)?(o.previousElementSibling.innerHTML=Vn(l.data.content),o.previousElementSibling.classList.remove("fn__none"),o.classList.add("fn__none"),a.lastElementChild.classList.add("fn__none")):l.data.isProtyleDoc?(o.value=l.data.content,o.classList.remove("fn__none"),a.lastElementChild.classList.add("fn__none"),o.previousElementSibling.classList.add("fn__none")):(o.classList.add("fn__none"),a.lastElementChild.classList.remove("fn__none"),o.previousElementSibling.classList.add("fn__none"),qe({data:l,protyle:ea.protyle,action:[g.CB_GET_HISTORY,g.CB_GET_HTML]})),a.querySelector(".history__date").textContent=ee(l.data.updated).format("YYYY-MM-DD HH:mm")});const s=e.getAttribute("data-id2");s?(i.classList.remove("fn__none"),_("/api/repo/openRepoSnapshotDoc",{id:s},l=>{const o=i.querySelector("textarea"),r=we().extname(l.data.content).toLowerCase();g.SIYUAN_ASSETS_IMAGE.concat(g.SIYUAN_ASSETS_AUDIO).concat(g.SIYUAN_ASSETS_VIDEO).includes(r)?(o.previousElementSibling.innerHTML=Vn(l.data.content),o.previousElementSibling.classList.remove("fn__none"),o.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):l.data.isProtyleDoc?(o.value=l.data.content,o.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),o.previousElementSibling.classList.add("fn__none")):(o.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),o.previousElementSibling.classList.add("fn__none"),qe({data:l,protyle:Ea.protyle,action:[g.CB_GET_HISTORY,g.CB_GET_HTML]})),i.querySelector(".history__date").textContent=ee(l.data.updated).format("YYYY-MM-DD HH:mm")})):i.classList.add("fn__none")},Tc=(t,e)=>{if(e.length!==2)return;let n,a;e[0].time>e[1].time?(n=e[1].id,a=e[0].id):(n=e[0].id,a=e[1].id);const i=new be({title:window.siyuan.languages.compare,content:"",width:H()?"92vw":"90vw",height:"80vh",destroyCallback(){ea=void 0,Ea=void 0}});i.element.addEventListener("click",s=>{var l;let o=s.target;for(;o&&o!==i.element;){if(o.classList.contains("b3-list-item")&&!o.dataset.id){o.nextElementSibling.classList.toggle("fn__none"),o.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item")&&o.dataset.id){if(o.classList.contains("b3-list-item--focus"))return;(l=i.element.querySelector(".history__diff .b3-list-item--focus"))==null||l.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),Cc(t,o),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("block__icon")){o.getAttribute("data-direct")==="left"?(o.setAttribute("data-direct","right"),Qi(a,n,i,"right")):(o.setAttribute("data-direct","left"),Qi(n,a,i,"left")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}}),Qi(n,a,i,"left")},Qi=(t,e,n,a)=>{ea=void 0,Ea=void 0;const i=H();_("/api/repo/diffRepoSnapshots",{left:t,right:e},s=>{const l=n.element.querySelector(".b3-dialog__header");l.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}">${t.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${ee(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${ee(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,l.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__diff">
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${Xi(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${Xi(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${Xi(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="fn__flex-1 fn__flex">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${ee(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${ee(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`})};let ka;const La=(t,e)=>{const n=t.querySelector('[data-type="docprevious"]'),a=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const i=t.querySelector(".b3-text-field"),s=t.querySelector('.b3-select[data-type="opselect"]'),l=t.querySelector('.b3-select[data-type="typeselect"]'),o=t.querySelector('.b3-select[data-type="notebookselect"]');window.siyuan.storage[g.LOCAL_HISTORYNOTEID]=o.value,et(g.LOCAL_HISTORYNOTEID,window.siyuan.storage[g.LOCAL_HISTORYNOTEID]);const r=t.querySelector('.history__text[data-type="docPanel"]'),c=t.querySelector('.history__text[data-type="assetPanel"]'),u=t.querySelector('.history__text[data-type="mdPanel"]');r.classList.add("fn__none"),u.classList.add("fn__none"),l.value==="0"||l.value==="1"?(s.removeAttribute("disabled"),o.removeAttribute("disabled"),c.classList.add("fn__none")):(s.setAttribute("disabled","disabled"),o.setAttribute("disabled","disabled"),c.classList.remove("fn__none")),_("/api/history/searchHistory",{notebook:o.value,query:i.value,page:e,op:s.value,type:parseInt(l.value)},d=>{if(e<d.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),a.nextElementSibling.nextElementSibling.textContent=`${e}/${d.data.pageCount||1}`,d.data.histories.length===0){t.lastElementChild.lastElementChild.previousElementSibling.classList.add("fn__none"),t.lastElementChild.lastElementChild.classList.add("fn__none"),t.lastElementChild.firstElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let f="";d.data.histories.forEach(p=>{f+=`<li class="b3-list-item" data-type="toggle" data-created="${p}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${ee(parseInt(p)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),t.lastElementChild.firstElementChild.innerHTML=f})},io=(t,e,n)=>{if(t.data.snapshots.length===0){e.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeCloudRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getCloudRepoSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="downloadSnapshot">
    <svg><use xlink:href="#iconDownload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.download}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoTagSnapshots"?a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="uploadSnapshot">
    <svg><use xlink:href="#iconUpload"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.upload}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="removeRepoTagSnapshot">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.remove}
</span>
<span class="fn__flex-1"></span>`:n==="getRepoSnapshots"&&(a=`<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="genTag">
    <svg><use xlink:href="#iconTags"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.tagSnapshot}
</span>
<span class="fn__flex-1"></span>
<span class="b3-list-item__action" data-type="rollback">
    <svg><use xlink:href="#iconUndo"></use></svg>
    <span class="fn__space"></span>
    ${window.siyuan.languages.rollback}
</span>
<span class="fn__flex-1"></span>`);let i="";const s=H();t.data.snapshots.forEach(l=>{let o="";l.typesCount&&(o=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${l.count}<span class="fn__space"></span>`,l.typesCount.forEach(c=>{o+=`${c.type} ${c.count}<span class="fn__space"></span>`}),o+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${l.hCreated}</span>
    <span class="fn__space"></span>
    ${l.hSize}
    <span class="fn__space"></span>
    ${l.systemOS}${l.systemName&&l.systemOS?"/":""}${l.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${l.tag?"":" fn__none"}">${l.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${$e(l.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${l.id.substring(0,7)}</code>
</div>
${o}`;i+=`<li class="b3-list-item" data-type="repoitem" data-id="${l.id}" data-tag="${l.tag}">
<div class="fn__flex-1">
    ${r}
    <div class="fn__flex" style="height: 26px" data-id="${l.id}" data-tag="${l.tag}">
        ${a}
        <span class="b3-list-item__action" data-type="more">
            <svg><use xlink:href="#iconMore"></use></svg>
            <span class="fn__space"></span>
            ${window.siyuan.languages.more}
        </span>
        <span class="fn__flex-1"></span>
    </div>
</div>
</li>`}),e.lastElementChild.innerHTML=`${i}`},Mn=(t,e)=>{const n=t.querySelector(".b3-select").value;t.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const a=t.querySelector('[data-type="previous"]'),i=t.querySelector('[data-type="next"]'),s=i.nextElementSibling.nextElementSibling;t.setAttribute("data-init","true"),n==="getRepoTagSnapshots"||n==="getCloudRepoTagSnapshots"?(_(`/api/repo/${n}`,{},l=>{io(l,t,n)}),a.classList.add("fn__none"),i.classList.add("fn__none"),s.classList.add("fn__none")):(a.classList.remove("fn__none"),i.classList.remove("fn__none"),s.classList.remove("fn__none"),t.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.setAttribute("disabled","disabled"),_(`/api/repo/${n}`,{page:e},l=>{e<l.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),s.textContent=`${e}/${l.data.pageCount||1}`,io(l,t,n)}))},$c=t=>{t.setAttribute("data-init","true"),_("/api/history/getNotebookHistory",{},e=>{if(e.data.histories.length===0){t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";e.data.histories.forEach((a,i)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${i===0?"":"fn__none"}">`,a.items.forEach(s=>{n+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${$e(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),t.innerHTML=n})},so=t=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(i=>{if(i.element.querySelector("#historyContainer"))return i.destroy(),!0}))return;let n="";window.siyuan.notebooks.forEach(i=>{i.closed||(n+=` <option value="${i.id}"${i.id===window.siyuan.storage[g.LOCAL_HISTORYNOTEID]?" selected":""}>${$e(i.name)}</option>`)});const a=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div style="overflow:auto;">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${H()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${H()?"fn__size96":"fn__size200"}">
                        <option value="0" selected>${window.siyuan.languages.docName}</option>
                        <option value="1">${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2">${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${H()?" fn__size96":""}">
                        <option value="all" selected>${window.siyuan.languages.allOp}</option>
                        <option value="clean">clean</option>
                        <option value="update">update</option>
                        <option value="delete">delete</option>
                        <option value="format">format</option>
                        <option value="sync">sync</option>
                        <option value="replace">replace</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${H()?"fn__size96":"fn__size200"}">
                        ${n}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background" style="overflow:auto;">
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div style="overflow: auto"">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${H()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if(H())It({html:a,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(i){lo(t,i.firstElementChild)}});else{const i=new be({content:a,width:"90vw",height:"80vh",destroyCallback(){ka=void 0}});lo(t,i.element,i)}},lo=(t,e,n)=>{const a=e.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(c=>{c.addEventListener("change",()=>{La(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",c=>{c.isComposing||La(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{La(a,1)});const i=a.querySelector('.history__text[data-type="docPanel"]'),s=a.querySelector('.history__text[data-type="assetPanel"]'),l=a.querySelector('.history__text[data-type="mdPanel"]');La(a,1),ka=new un(t,i,{blockId:"",action:[g.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yt(ka.protyle);const o=e.querySelector('#historyContainer [data-type="repo"]'),r=o.querySelector(".b3-select");r.addEventListener("change",()=>{Mn(o,1);const c=e.querySelector(".b3-button[data-type='compare']");c.setAttribute("disabled","disabled"),c.removeAttribute("data-ids")}),e.addEventListener("click",c=>{var u;let d=c.target;for(;d&&!d.isEqualNode(e);){const f=d.getAttribute("data-type");if(d.classList.contains("item")){d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(e.querySelector("#historyContainer").children).forEach(p=>{p.getAttribute("data-type")===f?(p.classList.remove("fn__none"),p.classList.add("fn__block"),d.classList.add("item--focus"),p.getAttribute("data-init")!=="true"&&(f==="notebook"?$c(p):f==="repo"&&Mn(p,1))):(p.classList.add("fn__none"),p.classList.remove("fn__block"))}),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__action")&&f==="rollback"&&!window.siyuan.config.readonly){Te("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",d.parentElement.textContent.trim())}`,()=>{const p=d.parentElement.getAttribute("data-type");p==="assets"?_("/api/history/rollbackAssetsHistory",{historyPath:d.parentElement.getAttribute("data-path")}):p==="doc"?_("/api/history/rollbackDocHistory",{notebook:a.querySelector('.b3-select[data-type="notebookselect"]').value,historyPath:d.parentElement.getAttribute("data-path")}):p==="notebook"?_("/api/history/rollbackNotebookHistory",{historyPath:d.parentElement.getAttribute("data-path")}):_("/api/repo/checkoutRepo",{id:d.parentElement.getAttribute("data-id")})}),c.stopPropagation(),c.preventDefault();break}else if(f==="more"){d.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(p=>{p.classList.toggle("fn__none")}),c.stopPropagation(),c.preventDefault();break}else if(f==="toggle"){const p=d.firstElementChild.firstElementChild;if(p.classList.contains("b3-list-item__arrow--open"))d.nextElementSibling.classList.add("fn__none"),p.classList.remove("b3-list-item__arrow--open");else if(d.nextElementSibling&&d.nextElementSibling.tagName==="UL")d.nextElementSibling.classList.remove("fn__none"),p.classList.add("b3-list-item__arrow--open");else{const b=a.querySelector(".b3-text-field"),m=a.querySelector('.b3-select[data-type="opselect"]'),h=a.querySelector('.b3-select[data-type="typeselect"]'),w=a.querySelector('.b3-select[data-type="notebookselect"]');_("/api/history/getHistoryItems",{notebook:w.value,query:b.value,op:m.value,type:parseInt(h.value),created:d.getAttribute("data-created")},y=>{p.classList.add("b3-list-item__arrow--open");let E="";y.data.items.forEach(S=>{E+=`<li title="${On(S.title)}" data-type="${h.value==="2"?"assets":"doc"}" data-path="${S.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 40px">
    <span class="b3-list-item__text">${$e(S.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),d.insertAdjacentHTML("afterend",`<ul>${E}</ul>`)})}c.stopPropagation(),c.preventDefault();break}else if(f==="rmtoggle"){d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")&&f==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(r.value)){const p=e.querySelector(".b3-button[data-type='compare']"),b=JSON.parse(p.getAttribute("data-ids")||"[]"),m=d.getAttribute("data-id");if(d.classList.contains("b3-list-item--focus"))d.classList.remove("b3-list-item--focus"),b.forEach((h,w)=>{m===h.id&&b.splice(w,1)});else{for(d.classList.add("b3-list-item--focus");b.length>1;)b[0].id!==m&&((u=d.parentElement.querySelector(`.b3-list-item[data-id="${b.splice(0,1)[0].id}"]`))==null||u.classList.remove("b3-list-item--focus"));b.push({id:m,time:d.querySelector('[data-type="hCreated"]').textContent})}b.length===2?p.removeAttribute("disabled"):p.setAttribute("disabled","disabled"),p.setAttribute("data-ids",JSON.stringify(b)),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")&&(f==="assets"||f==="doc")){const p=d.getAttribute("data-path");f==="assets"?s.innerHTML=Vn(p):f==="doc"&&_("/api/history/getDocHistoryContent",{historyPath:p,k:a.querySelector(".b3-text-field").value},m=>{m.data.isLargeDoc?(l.value=m.data.content,l.classList.remove("fn__none"),i.classList.add("fn__none")):(l.classList.add("fn__none"),i.classList.remove("fn__none"),qe({data:m,protyle:ka.protyle,action:[g.CB_GET_HISTORY,g.CB_GET_HTML]}))});let b=N(d,"b3-list");b&&(b=b.querySelector(".b3-list-item--focus"),b&&b.classList.remove("b3-list-item--focus")),d.classList.add("b3-list-item--focus"),c.stopPropagation(),c.preventDefault();break}else if(f==="genRepo"){const p=new be({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),b=p.element.querySelector("textarea");b.focus();const m=p.element.querySelectorAll(".b3-button");p.bindInput(b,()=>{m[1].click()}),m[0].addEventListener("click",()=>{p.destroy()}),m[1].addEventListener("click",()=>{_("/api/repo/createSnapshot",{memo:b.value},()=>{Mn(o,1)}),p.destroy()}),c.stopPropagation(),c.preventDefault();break}else if(f==="removeRepoTagSnapshot"||f==="removeCloudRepoTagSnapshot"){const p=d.parentElement.getAttribute("data-tag");Te(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${p}</i>?`,()=>{_("/api/repo/"+f,{tag:p},()=>{Mn(o,1)})}),c.stopPropagation(),c.preventDefault();break}else if(f==="uploadSnapshot"){_("/api/repo/uploadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(f==="downloadSnapshot"){_("/api/repo/downloadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(f==="genTag"){const p=new be({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${ee().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:H()?"92vw":"520px"}),b=p.element.querySelector(".b3-text-field");b.select();const m=p.element.querySelectorAll(".b3-button");m[0].addEventListener("click",()=>{p.destroy()}),m[2].addEventListener("click",()=>{_("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:b.value},()=>{_("/api/repo/uploadCloudSnapshot",{tag:b.value,id:d.parentElement.getAttribute("data-id")},()=>{Mn(o,1)})}),p.destroy()}),m[1].addEventListener("click",()=>{_("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:b.value},()=>{Mn(o,1)}),p.destroy()}),c.stopPropagation(),c.preventDefault();break}else if((f==="previous"||f==="next")&&d.getAttribute("disabled")!=="disabled"){const p=parseInt(o.getAttribute("data-page"));Mn(o,f==="previous"?p-1:p+1),c.stopPropagation(),c.preventDefault();break}else if((f==="docprevious"||f==="docnext")&&d.getAttribute("disabled")!=="disabled"){const p=parseInt(a.getAttribute("data-page"));La(a,f==="docprevious"?p-1:p+1),c.stopPropagation(),c.preventDefault();break}else if(f==="rebuildIndex"){_("/api/history/reindexHistory"),n?n.destroy():(El(),ka=void 0),c.stopPropagation(),c.preventDefault();break}else if(f==="compare"&&!d.getAttribute("disabled")){Tc(t,JSON.parse(d.getAttribute("data-ids")||"[]")),c.stopPropagation(),c.preventDefault();break}d=d.parentElement}})},xa=t=>{document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.classList.remove("fn__none"),e.innerHTML===""&&(e.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${Ga()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.help}</span>
</div>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.id==="emptySearch"){zt(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){ao(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){so(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){window.siyuan.mobile.editor?Jn({app:t,notebookId:window.siyuan.mobile.editor.protyle.notebookId,currentPath:window.siyuan.mobile.editor.protyle.path,useSavePath:!0}):window.siyuan.notebooks.find(i=>{if(!i.closed)return Jn({app:t,notebookId:i.id,currentPath:"/",useSavePath:!0}),!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){Ki(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){Gi(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},Ic=()=>{document.getElementById("toolbarName").classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},Cu=(t,e)=>{fetchPost("/api/block/getDocInfo",{id:t},n=>{e.updateTitle(n.data.name)})},oo=(t,e)=>{je(),window.siyuan.mobile.popEditor&&(e.removeRootIDs.includes(window.siyuan.mobile.popEditor.protyle.block.rootID)?Y(["dialog"]):jt(window.siyuan.mobile.popEditor.protyle,!1)),window.siyuan.mobile.editor&&(e.removeRootIDs.includes(window.siyuan.mobile.editor.protyle.block.rootID)?xa(t):(jt(window.siyuan.mobile.editor.protyle,!1),_("/api/block/getDocInfo",{id:window.siyuan.mobile.editor.protyle.block.rootID},n=>{document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name}))),Jt(()=>{window.siyuan.mobile.files.init(!1)})},Dc=()=>{window.siyuan.config.readonly||_("/api/system/logoutAuth",{},()=>{gr()})},ro=()=>{if(document.querySelector("#errorLog"))return;let t="";Pt()&&(t=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const e=new be({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${g.SIYUAN_VERSION}</small>`,width:H()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${t}
</div>
</div>`});e.element.id="errorLog";const n=e.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{e.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},Sa=()=>{ni(window.siyuan.mobile.editor.protyle),_("/api/system/exit",{force:!1},t=>{if(t.code===1){const e=oe(t.msg,t.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${e}"] button`);n&&n.addEventListener("click",()=>{_("/api/system/exit",{force:!0},()=>{(Pt()||yt())&&(window.location.href="siyuan://api/system/exit")})})}else t.code===2?(je(),Te(window.siyuan.languages.tip,t.msg,()=>{_("/api/system/exit",{force:!0,execInstallPkg:2},()=>{})},()=>{_("/api/system/exit",{force:!0,execInstallPkg:1},()=>{})})):(Pt()||yt())&&(window.location.href="siyuan://api/system/exit")})},Mc=()=>{if(document.getElementById("transactionError"))return;const t=new be({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${g.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:H()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{Sa()}),e[1].addEventListener("click",()=>{_("/api/filetree/refreshFiletree",{}),t.destroy()})},Hc=t=>{const e=document.querySelector("#status");if(!e)return;if(H()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;e.innerHTML=t.msg,e.classList.remove("status--hide"),e.style.bottom="0";return}const n=e.querySelector(".status__msg");n&&(n.innerHTML=t.msg)},Nc=t=>{let e=document.getElementById("progress");if(e||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),e=document.getElementById("progress")),t.code===2){e.remove();return}t.code===0?e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:var(--b3-theme-on-surface);">
    <div style="text-align: right">${t.data.current}/${t.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${t.data.current/t.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div>${t.msg}</div>
</div>`:t.code===1&&(e.lastElementChild?e.lastElementChild.lastElementChild.innerHTML=t.msg:e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:var(--b3-theme-on-surface);">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div>${t.msg}</div>
</div>`)},Tu=t=>{const e=document.querySelector(".status__backgroundtask");e&&(t.length===0?(e.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(e.classList.remove("fn__none"),e.setAttribute("data-tasks",JSON.stringify(t)),e.innerHTML=t[0].action+"<div><div></div></div>"))},Pc=()=>{_("/api/sync/getBootSync",{},t=>{if(t.code===1){const e=new be({width:H()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${t.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),_("/api/sync/performBootSync",{},a=>{a.code===0&&e.destroy(),n[1].removeAttribute("disabled")}))})}})},Bc=t=>{const e=document.getElementById("drag"),n=rr();if(t===window.siyuan.languages.siyuanNote){const a=`${t} - ${n} - v${g.SIYUAN_VERSION}`;document.title=a,e&&(e.textContent=a,e.setAttribute("title",a))}else{if(t=t||"Untitled",document.title=`${t} - ${n} - ${window.siyuan.languages.siyuanNote} v${g.SIYUAN_VERSION}`,!e)return;e.setAttribute("title",t),e.innerHTML=$e(t)}},$u=t=>{const e=document.querySelector("#configBazaarReadme .item__side");if(!e||t.id!==JSON.parse(e.getAttribute("data-obj")).repoURL)return;const n=e.querySelector('[data-type="install"]');n&&(t.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${t.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${t.percent*100}%"></span>`))},Vt=t=>{const e=document.querySelector("#menuSyncNow use"),n=document.querySelector("#toolbarSync use");if(!t){!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&Qt("")?(e==null||e.setAttribute("xlink:href","#iconCloudOff"),n.setAttribute("xlink:href","#iconCloudOff")):(e==null||e.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc"));return}e==null||e.parentElement.classList.remove("fn__rotate"),n.parentElement.classList.remove("fn__rotate"),t.code===0?(e==null||e.parentElement.classList.add("fn__rotate"),n.parentElement.classList.add("fn__rotate"),e==null||e.setAttribute("xlink:href","#iconRefresh"),n.setAttribute("xlink:href","#iconRefresh")):t.code===2?(e==null||e.setAttribute("xlink:href","#iconCloudError"),n.setAttribute("xlink:href","#iconCloudError")):t.code===1&&(e==null||e.setAttribute("xlink:href","#iconCloudSucc"),n.setAttribute("xlink:href","#iconCloudSucc"))};var qc=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const _=(t,e,n,a)=>{const i={method:"POST"};e&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(t)&&(window.siyuan.reqIds[t]=new Date().getTime(),e.type==="local"&&t==="/api/graph/getLocalGraph"||(e.reqId=window.siyuan.reqIds[t])),t==="/api/transactions"&&(e.reqId=new Date().getTime()),e instanceof FormData?i.body=e:i.body=JSON.stringify(e)),a&&(i.headers=a),fetch(t,i).then(s=>{var l;return s.status===404?{data:null,msg:s.statusText,code:s.status}:((l=s.headers.get("content-type"))==null?void 0:l.indexOf("application/json"))>-1?s.json():s.text()}).then(s=>{if(typeof s=="string"){n&&n(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(t)&&s.data.reqId&&window.siyuan.reqIds[t]&&window.siyuan.reqIds[t]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?mi(s)&&n&&n(s):n&&n(s))}).catch(s=>{if(console.warn("fetch post error",s),t==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){ro();return}})},Dt=(t,e)=>qc(void 0,null,function*(){const n={method:"POST"};e&&(n.body=JSON.stringify(e));const i=yield(yield fetch(t,n)).json();return mi(i),i}),co=(t,e)=>{fetch(t).then(n=>n.json()).then(n=>{e(n)})},Ji=(t,e)=>{const n=[{filter:["\u6A21\u7248","moban","mb","template"],value:g.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["\u6302\u4EF6","widget","gj","guajian"],value:g.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:["\u8D44\u6E90","assets","zy","ziyuan"],value:g.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["\u5F15\u7528\u5757","yinyong","yy","block reference"],value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["\u5D4C\u5165\u5757","qianrukuai","qrk","embed block"],value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["ai chat"],value:g.ZWSP+5,html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI Chat</span></div>'}];dr()&&n.push({filter:["\u6570\u636E\u5E93","\u5C5E\u6027\u89C6\u56FE","shujuku","shuxingshitu","sjk","sxst","database","attribute view"],value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`}),[{filter:["\u6587\u6863","\u5B50\u6587\u6863","wendang","wd","ziwendang","zwd","xjwd"],value:g.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.general.newFile.custom)}</span></div>`},{value:"",html:"separator"},{filter:["yijibiaoti","\u4E00\u7EA7\u6807\u9898","yjbt","h1","heading"],value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.heading.heading1.custom)}</span></div>`},{filter:["erjibiaoti","\u4E8C\u7EA7\u6807\u9898","ejbt","h2","heading"],value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.heading.heading2.custom)}</span></div>`},{filter:["sanjibiaoti","\u4E09\u7EA7\u6807\u9898","sjbt","h3","heading"],value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.heading.heading3.custom)}</span></div>`},{filter:["sijibiaoti","\u56DB\u7EA7\u6807\u9898","sjbt","h4","heading"],value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.heading.heading4.custom)}</span></div>`},{filter:["wujibiaoti","\u4E94\u7EA7\u6807\u9898","wjbt","h5","heading"],value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.heading.heading5.custom)}</span></div>`},{filter:["liujibiaoti","\u516D\u7EA7\u6807\u9898","ljbt","h6","heading"],value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.heading.heading6.custom)}</span></div>`},{filter:["\u65E0\u5E8F\u5217\u8868","wuxuliebiao","wxlb","unordered list"],value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span><span class="b3-list-item__meta">*&nbsp;</span></div>`},{filter:["\u6709\u5E8F\u5217\u8868","youxuliebiao","yxlb","ordered list"],value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span><span class="b3-list-item__meta">1.&nbsp;</span></div>`},{filter:["\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb","task list","todo list"],value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.check.custom)}</span></div>`},{filter:["\u5F15\u8FF0","yinshu","ys","bq","blockquote"],value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span><span class="b3-list-item__meta">&gt;</span></div>`},{filter:["\u4EE3\u7801\u5757","daimakuai","dmk","code block"],value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span><span class="b3-list-item__meta">\`\`\`Enter</span></div>`},{filter:["\u8868\u683C","biaoge","bg","table"],value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["\u5206\u5272\u7EBF","\u5206\u9694\u7EBF","fengexian","fgx","divider","thematic","break"],value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:["\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk","math block"],value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",html:"separator"},{filter:["\u8868\u60C5","biaoqing","bq","emoji"],value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:["\u94FE\u63A5","lianjie","lj","link","a"],value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["\u7C97\u4F53","cuti","ct","bold","strong"],value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["\u659C\u4F53","xieti","xt","italic","em"],value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["\u4E0B\u5212\u7EBF","xiahuaxian","xhx","underline"],value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["\u5220\u9664\u7EBF","shanchuxian","scx","strike"],value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["\u6807\u8BB0","biaoji","bj","mark"],value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["\u4E0A\u6807","shangbiao","sb","superscript"],value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["\u4E0B\u6807","xiaobiao","xb","subscript"],value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["\u6807\u7B7E","biaoqian","bq","tag"],value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["\u884C\u5185\u4EE3\u7801","hangneidaima","hndm","inline code"],value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["\u884C\u5185\u6570\u5B66\u516C\u5F0F","hangneishuxuegongshi","hnsxgs","inline math"],value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${De(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",html:"separator"},{filter:["\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","upload","\u4E0A\u4F20","crtphwj","sc"],value:g.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${e.options.upload.accept?'multiple="'+e.options.upload.accept+'"':""}></div>`},{filter:["iframe","\u5D4C\u5165\u7F51\u5740","qianruwangzhan","qrwz"],value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["\u63D2\u5165\u56FE\u7247\u94FE\u63A5","insert image link","charutupianlianjie","crtptp"],value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj","insert video url"],value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj","insert audio url"],value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",html:"separator"},{filter:["\u4E94\u7EBF\u8C31","wuxianpu","wxp","staff"],value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["\u56FE\u8868","tubiao","tb","chart"],value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["\u6D41\u7A0B\u56FE","liuchengtu","lct","flow chart"],value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["\u72B6\u6001\u56FE","zhuangtaitu","ztt","graph viz"],value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["\u6D41\u7A0B\u56FE","\u65F6\u5E8F\u56FE","\u7518\u7279\u56FE","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["\u8111\u56FE","naotu","nt","mind map"],value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["\u7EDF\u4E00\u5EFA\u6A21\u8BED\u8A00","tongyijianmoyuyan","tyjmyy","plant uml"],value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",html:"separator"},{filter:["\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys","info style"],value:`style${g.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys","success style"],value:`style${g.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys","warning style"],value:`style${g.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys","error style"],value:`style${g.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["\u79FB\u9664\u6837\u5F0F","yichuyangshi","ycys","remove style"],value:`style${g.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`}].forEach(i=>{n.push(i)}),n.push({value:"",html:"separator"});let a=!1;return e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n.push({filter:s.filter,value:`plugin${g.ZWSP}${i.name}${g.ZWSP}${s.id}`,html:s.html}),a=!0})}),a||n.pop(),t===""?n:n.filter(i=>i.filter?!!i.filter.find(l=>{if(l.indexOf(t.toLowerCase())>-1)return!0}):!1)},Oc=(t,e)=>(e.hint.genLoading(e),_("/api/search/searchTag",{k:t},n=>{const a=[];let i=!1;n.data.tags.forEach(s=>{const l=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`#${l}#`,html:s}),l===n.data.k&&(i=!0)}),n.data.k&&!i&&(a.splice(0,0,{value:`#${n.data.k}#`,html:`${window.siyuan.languages.new} <mark>${$e(n.data.k)}</mark>`}),a.length>1&&(a[1].focus=!0)),e.hint.genHTML(a,e,!0,"hint")}),[]),es=t=>{let e;t.type==="NodeDocument"&&t.ial.icon?(e=le(t.ial.icon,"b3-list-item__graphic popover__block",!0),e=e.replace('popover__block"',`popover__block" data-id="${t.id}"`)):e=`<svg class="b3-list-item__graphic popover__block" data-id="${t.id}"><use xlink:href="#${_t(t.type)}"></use></svg>`;let n="";return t.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${t.name}</span></span><span class="fn__space"></span>`),t.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${t.alias}</span></span><span class="fn__space"></span>`),t.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${t.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`),`${n}<div class="b3-list-item__first">
    ${e}
    <span class="b3-list-item__text">${t.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall" style="margin-bottom: 4px">${t.hPath}</div>`},Hn=(t,e,n)=>{const a=I(de(e.wysiwyg.element).startContainer);return e.hint.genLoading(e),_("/api/search/searchRefBlock",{k:t,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID,isSquareBrackets:["[[","\u3010\u3010"].includes(e.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const l=Lute.UnEscapeHTMLStr(Ut(i.data.k));s.push({value:n==="search"?`((newFile "${l}"${g.ZWSP}'${l}${Lute.Caret}'))`:`((newFile '${l}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(l=>{let o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="d">${l.name||l.refText}</span>`;n==="search"&&(o=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${t}</span>`),s.push({value:o,html:es(l)})}),n==="search"&&(e.hint.splitChar="((",e.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),e.hint.genHTML(s,e,!0,n)}),[]},ta=(t,e)=>{if(t.endsWith("}}")||t.endsWith("\u300D\u300D"))return[];e.hint.genLoading(e);const n=I(de(e.wysiwyg.element).startContainer);return _("/api/search/searchRefBlock",{k:t,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):e.block.parentID,rootID:e.block.rootID},a=>{const i=[];a.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:es(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),e.hint.genHTML(i,e,!0,"hint")}),[]},uo=(t,e,n)=>{_("/api/template/render",{id:e.block.parentID,path:t},a=>{z(e.toolbar.range);const i=$(n);i&&i.textContent.trim()===""?Re(a.data.content,e,!0):Re(a.data.content,e),e.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),Se(e,e.wysiwyg.element),Oe(e.wysiwyg.element),Ae(e.wysiwyg.element),Ye(e.wysiwyg.element,e),Y(["util"],e)})},fo=(t,e)=>{z(e.toolbar.range),Re(e.lute.SpinBlockDOM(`<iframe src="/widgets/${t}" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),e,!0),Y(["util"],e)},go=(t,e)=>{z(e.toolbar.range);const n=we().extname(t).toLowerCase(),a=t.startsWith("assets/")?_s(t):t;Re(ll(n,t,a,t.startsWith("assets/")?a+n:t),e),Y(["util"],e)},po=(t,e,n)=>{if(t==="/")return;const a=ze(t,!0,!0);if(n.block.rootID===a)return;const i=[];let s;const l=e[0].parentElement;let o;if(e.forEach((r,c)=>{c===e.length-1&&r.parentElement&&(s=he(r),o=s.nextElementSibling||s.previousElementSibling,s.isSameNode(r)&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(l.classList.contains("list")&&l.getAttribute("data-subtype")==="o"&&l.childElementCount>1)Ne(l,1),Array.from(l.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&l.classList.contains("protyle-wysiwyg")&&l.childElementCount===0)setTimeout(()=>{mt({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},g.TIMEOUT_INPUT*2+100);else if(l.classList.contains("protyle-wysiwyg")&&l.innerHTML===""&&!N(l,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),c=mn(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:n.block.parentID}),l.innerHTML=c.outerHTML,ce(c)}else o&&ce(o);F(n,i)},lt=(t,e,n)=>{e&&(ot($(n[n.length-1]),t.toolbar.range),t.toolbar.range.collapse(!0),Re(e,t,!0,!0),Se(t,t.wysiwyg.element),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element))},mo=(t,e)=>{const n=[];t.forEach(i=>{n.push(i.getAttribute("data-node-id"))});const a=[{iconHTML:g.ZWSP,label:window.siyuan.languages.aiCustomAction,click(){const i=new be({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),s=i.element.querySelector("textarea"),l=i.element.querySelectorAll(".b3-button");i.bindInput(s,()=>{l[1].click()}),s.focus(),l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{_("/api/ai/chatGPTWithAction",{ids:n,action:s.value},o=>{i.destroy(),lt(e,o.data,t)})})}},{iconHTML:g.ZWSP,label:`${window.siyuan.languages.aiCustomAction} & ${window.siyuan.languages.save}`,click(){const i=new be({title:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),s=i.element.querySelector("input"),l=i.element.querySelectorAll(".b3-button");i.bindInput(s,()=>{l[1].click()}),s.focus(),l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{const o=i.element.querySelector("textarea").value;window.siyuan.storage[g.LOCAL_AI].push({name:s.value,memo:o}),et(g.LOCAL_AI,window.siyuan.storage[g.LOCAL_AI]),_("/api/ai/chatGPTWithAction",{ids:n,action:o},r=>{i.destroy(),lt(e,r.data,t)}),i.destroy()})}}];window.siyuan.storage[g.LOCAL_AI].forEach(i=>{a.push({iconHTML:g.ZWSP,action:"iconCloseRound",label:`<div aria-label="${On(i.memo)}" data-type="a">${$e(i.name)}</div>`,bind:s=>{s.addEventListener("click",l=>{N(l.target,"b3-menu__action")?window.siyuan.storage[g.LOCAL_AI].find((o,r)=>{if(s.querySelector(".b3-menu__label").textContent.trim()===o.name)return window.siyuan.storage[g.LOCAL_AI].splice(r,1),et(g.LOCAL_AI,window.siyuan.storage[g.LOCAL_AI]),s.remove(),!0}):(_("/api/ai/chatGPTWithAction",{ids:n,action:i.memo},o=>{lt(e,o.data,t)}),window.siyuan.menus.menu.remove()),l.preventDefault(),l.stopPropagation()})}})}),window.siyuan.menus.menu.append(new T({icon:"iconSparkles",label:window.siyuan.languages.ai,type:"submenu",submenu:[{iconHTML:g.ZWSP,label:window.siyuan.languages.aiContinueWrite,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Continue writing"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate,type:"submenu",submenu:[{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hans,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hans]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hant,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hant]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_ja_JP,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ja-JP]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_ko_KR,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ko-KR]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_en_US,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [en-US]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_es_ES,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [es-ES]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_fr_FR,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [fr-FR]"},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiTranslate_de_DE,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [de-DE]"},i=>{lt(e,i.data,t)})}}]},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiExtractSummary,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiExtractSummary},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiBrainStorm,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiBrainStorm},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.aiFixGrammarSpell,click(){_("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiFixGrammarSpell},i=>{lt(e,i.data,t)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.custom,type:"submenu",submenu:a}]}).element)},Rc=(t,e)=>{const n=new be({title:"AI Chat",content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),a=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()}),a.focus(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{_("/api/ai/chatGPT",{msg:a.value},s=>{n.destroy();let l="";s.data&&s.data!==""&&(l=`

`+s.data),lt(t,`${a.value}${l}`,[e])})})};class Fc{constructor(e){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`width:${Math.max(e.element.clientWidth/2,320)}px;`),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{var a;const i=n.target;if(i.tagName==="INPUT"){n.stopPropagation();return}const s=R(i,"BUTTON");if(s&&!s.classList.contains("emojis__item")&&!s.classList.contains("emojis__type")){this.source!=="search"?this.fill(decodeURIComponent(s.getAttribute("data-value")),e,!0,Ce(n)):setTimeout(()=>{this.fill(decodeURIComponent(s.getAttribute("data-value")),e)},148),z(e.toolbar.range),n.preventDefault(),n.stopPropagation();return}const l=this.element.querySelector(".emojis__panel"),o=N(i,"emojis__type");if(o){const c=l.querySelector(`[data-type="${o.getAttribute("data-type")}"]`);if(c){const u=c.nextElementSibling.getAttribute("data-index");if(u){let d="";window.siyuan.emojis[parseInt(u)].items.forEach(f=>{d+=`<button data-unicode="${f.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?f.description_zh_cn:f.description}">
${le(f.unicode)}</button>`}),c.nextElementSibling.innerHTML=d,c.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:c.offsetTop})}return}const r=N(i,"emojis__item");if(r){const c=r.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const u=getSelection().getRangeAt(0);u.endContainer.nodeType!==3?(a=u.endContainer.childNodes[u.endOffset-1])==null||a.remove():u.endContainer.textContent===":"&&(u.endContainer.textContent=""),kn(c);let d;c.indexOf(".")>-1?d=`:${c.split(".")[0]}: `:d=le(c)+" ",Re(e.lute.SpinBlockDOM(d),e,!1,!0),this.element.classList.add("fn__none")}else this.fill(c,e)}})}render(e){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(e.toolbar.range=getSelection().getRangeAt(0),e.toolbar.range.startContainer.nodeType===3&&e.toolbar.range.startContainer.textContent===""){const s=xe(e.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let l=s.previousSibling;for(;l&&l.nodeType===3;)if(l.textContent==="")l=l.previousSibling,l.nextSibling.remove();else{s.textContent=l.textContent+s.textContent,l.remove();break}}e.toolbar.range.setStart(s,s.textContent.length),e.toolbar.range.collapse(!0)}}const n=Qe(e.toolbar.range.startContainer,e.wysiwyg.element).start,a=e.toolbar.range.startContainer.textContent.substring(0,n)||"",i=this.getKey(a,e.options.hint.extend);if(typeof i=="undefined"||A(e.toolbar.range.startContainer,"data-type","code")||A(e.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=I(e.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const l=Qe(e.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(l))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(e,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!H()&&this.genHTML(Ji(i,e),e,!1,"hint");return}e.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,e,"hint"),e,!1,"hint")},e.options.hint.delay))})}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=Rt(e.wysiwyg.element);Le(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(e,n){const a=n.querySelector('input[type="file"]');a&&a.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=de(e.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),an(e,i.target.files,i.target),Y(["hint","toolbar"],e)})}getHTMLByData(e){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),e.forEach((a,i)=>{let s="";(i===1&&e[i].focus||i===0&&(e.length===1||!e[1].focus))&&(s=" b3-list-item--focus"),a.html==="separator"?n+='<div class="b3-menu__separator"></div>':n+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(e,n,a=!1,i){var s;if(this.source=i,e.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(e),this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(n.element.clientWidth/2,320)+"px",this.source==="av"){const l=N(n.toolbar.range.startContainer,"av__cell");if(l){const o=l.getBoundingClientRect();Le(this.element,o.left,o.bottom,o.height)}}else{const l=Rt(n.wysiwyg.element);Le(this.element,l.left,l.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(n,this.element),this.source!=="hint"){const l=this.element.querySelector("input.b3-text-field"),o=((s=this.element.querySelector("mark"))==null?void 0:s.textContent)||"";l.value=o,l.select(),l.addEventListener("keydown",c=>{c.key!=="Meta"&&c.key!=="Control"&&c.stopPropagation(),!c.isComposing&&(bn(this.element.lastElementChild,c),c.key==="Enter"?(setTimeout(()=>{this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n)},148),z(n.toolbar.range),c.preventDefault()):c.key==="Escape"&&(this.element.classList.add("fn__none"),z(n.toolbar.range)))});const r=n.toolbar.range?I(n.toolbar.range.startContainer):!1;l.addEventListener("input",c=>{c.isComposing||(c.stopPropagation(),this.genSearchHTML(n,l,r,o))}),l.addEventListener("compositionend",c=>{c.stopPropagation(),this.genSearchHTML(n,l,r,o)})}}genSearchHTML(e,n,a,i){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',_("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID},s=>{let l="";if(s.data.newDoc){const o=`((newFile "${i}"${g.ZWSP}'${s.data.k}${Lute.Caret}'))`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(o)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div></button>`}s.data.blocks.forEach((o,r)=>{const c=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${i}</span>`;l+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${r===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${es(o)}
</button>`}),l===""&&(l=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=l})}genEmojiHTML(e,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=ca(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),ra(a)):(this.element.innerHTML=`<div style="padding: 0" class="emojis">
<div class="emojis__panel">${ca(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    <button data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${le("2b50")}</button>
    <button data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f527")}</button>
    <button data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f60d")}</button>
    <button data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f433")}</button>
    <button data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f96a")}</button>
    <button data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f3a8")}</button>
    <button data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f3dd")}</button>
    <button data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f52e")}</button>
    <button data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("267e")}</button>
    <button data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${le("1f6a9")}</button>
</div>
</div>`,za(this.element),ra(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(e.element.clientWidth/2,320)+"px";const s=Rt(e.wysiwyg.element);Le(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,n,a=!0,i=!1){var s;Y(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=de(n.wysiwyg.element));const l=n.toolbar.range;let o=I(n.toolbar.range.startContainer);if(!o)return;if(this.source==="av"){const d=N(n.toolbar.range.startContainer,"av__cell");if(!d)return;const f=d.dataset.blockId,p=o.getAttribute("data-av-id");let b=document.createElement("div");if(b.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),b=b.firstElementChild,e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const m=e.substring(11,e.length-4).split(`"${g.ZWSP}'`),h=m.length===1?m[0]:m[1];Zi(n.path,n.notebookId,w=>{_("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:we().join(w,h),parentID:n.block.rootID,markdown:""},y=>{F(n,[{action:"replaceAttrViewBlock",avID:p,previousID:f,nextID:y.data,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:y.data,nextID:f,isDetached:!0}])})})}else{const m=b.getAttribute("data-id");F(n,[{action:"replaceAttrViewBlock",avID:p,previousID:f,nextID:m,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:p,previousID:m,nextID:f,isDetached:!0}])}return}this.enableExtend=!1;let r="";o&&(r=o.getAttribute("data-node-id"));const c=o.outerHTML,u=g.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(g.BLOCK_HINT_KEYS.includes(this.splitChar)&&u&&l.startContainer.nodeType===3&&l.startContainer.wholeText.indexOf(u)>-1&&l.startContainer.wholeText.indexOf(this.splitChar)>-1){let d=0,f=l.startContainer;for(;f&&d<2;){const p=f.textContent.indexOf(u),b=f.textContent.indexOf(this.splitChar);if(p>-1&&(p<b||b<0)){d=2,l.setEnd(f,p+2);break}const m=f.textContent.indexOf(u.substr(1));if(m>-1&&(d+=1),d===2){l.setEnd(f,m+1);break}f=f.nextSibling}}if(this.lastIndex>-1&&(l.setStart(l.startContainer,this.lastIndex),Wa()&&z(l)),g.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){z(l);const d=e.substring(11,e.length-4).split(`"${g.ZWSP}'`),f=d.length===1?d[0]:d[1];Zi(n.path,n.notebookId,p=>{_("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:we().join(p,f),parentID:n.block.rootID,markdown:""},b=>{n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${b.data}${g.ZWSP}${d.length===2||i?"s":"d"}${g.ZWSP}${(d.length===2?d[0]:f).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(g.BLOCK_HINT_KEYS.includes(this.splitChar)){if(e===""){const f=$(o);f.textContent===""&&(f.innerHTML="<wbr>",re(f,l));return}let d=document.createElement("div");if(d.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),d=d.firstElementChild,i){const f=l.toString().replace(this.splitChar,"");f&&(d.setAttribute("data-subtype","s"),d.innerText=f)}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${d.getAttribute("data-id")}${g.ZWSP}${d.getAttribute("data-subtype")}${g.ZWSP}${d.textContent}`});return}else if(this.splitChar===":"){kn(e);let d;e.indexOf(".")>-1?d=`:${e.split(".")[0]}: `:d=le(e)+" ",Re(n.lute.SpinBlockDOM(d),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(e===""){const d=$(o);d.textContent===""&&(d.innerHTML="<wbr>",re(d,l));return}Re(n.lute.SpinBlockDOM(e),n,!1,H()),Se(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,e==="(("||e==="{{"){e==="(("?Hn("",n,"hint"):ta("",n),this.splitChar=e,this.lastIndex=0,l.deleteContents();const d=document.createTextNode(e);l.insertNode(d),l.setEnd(d,e.length),l.collapse(!1);return}else if(e===g.ZWSP){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showTpl(n,o,l),j(n,r,o.outerHTML,c);return}else if(e===g.ZWSP+1){l.deleteContents(),this.fixImageCursor(l),n.toolbar.showWidget(n,o,l),j(n,r,o.outerHTML,c);return}else if(e===g.ZWSP+2){l.deleteContents(),this.fixImageCursor(l),n.toolbar.range=l;const d=Rt(o,l);n.toolbar.showAssets(n,{x:d.left,y:d.top+26,w:0,h:26}),j(n,r,o.outerHTML,c);return}else if(e===g.ZWSP+3){l.deleteContents();return}else if(e===g.ZWSP+4){const d=Lute.NewNodeID();_("/api/filetree/createDoc",{notebook:n.notebookId,path:we().join(ze(n.path,!1,!0),d+".sy"),title:"Untitled",md:""},()=>{Re(`<span data-type="block-ref" data-id="${d}" data-subtype="d">Untitled</span>`,n),Ke(n.app,d,[g.CB_GET_HL,g.CB_GET_CONTEXT])});return}else if(e===g.ZWSP+5){l.deleteContents(),Rc(n,o);return}else if(g.INLINE_TYPE.includes(e)){if(l.deleteContents(),z(l),["a","block-ref","inline-math","inline-memo","text"].includes(e)){n.toolbar.element.querySelector(`[data-type="${e}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,e,"range");return}else if(e==="emoji"){l.deleteContents(),l.insertNode(document.createTextNode(":")),l.collapse(!1),this.genEmojiHTML(n);return}else if(e.indexOf("style")>-1){l.deleteContents(),this.fixImageCursor(l),o.setAttribute("style",e.split(g.ZWSP)[1]||""),j(n,r,o.outerHTML,c);return}else if(e.startsWith("plugin")){n.app.plugins.find(d=>{const f=e.split(g.ZWSP);if(f[1]===d.name)return d.protyleSlash.find(p=>{if(p.id===f[2])return p.callback(n.getInstance()),!0}),!0});return}else{l.deleteContents(),e!=="![]()"&&this.fixImageCursor(l);let d=e;e==="```"&&(d=e+window.siyuan.storage[g.LOCAL_CODELANG]+Lute.Caret+"\n```");const f=$(o);if(e==="![]()"){let p="";l.insertNode(document.createElement("wbr")),l.insertNode(document.createTextNode(e)),p=n.lute.SpinBlockDOM(o.outerHTML),o.outerHTML=p,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),re(o,l),j(n,r,o.outerHTML,c);let b=l.startContainer.childNodes[l.startOffset-1]||l.startContainer;b&&b.nodeType!==3&&b.classList.contains("img")||(((s=b.previousSibling)==null?void 0:s.nodeType)!==3&&b.previousSibling.classList.contains("img")?b=b.previousSibling:Array.from(o.querySelectorAll(".img")).find(h=>{if(h.querySelector("img").getAttribute("data-src")==="")return b=h,!0}));const m=b.getBoundingClientRect();Ui(n,l,b,{clientX:m.left,clientY:m.top});return}else if(f.textContent===""&&o.getAttribute("data-type")==="NodeParagraph"){let p="";e==="<div>"?p=`<div data-node-id="${r}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${pn()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${g.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(f.textContent=d,p=n.lute.SpinBlockDOM(o.outerHTML)),o.outerHTML=p,o=n.wysiwyg.element.querySelector(`[data-node-id="${r}"]`),o.getAttribute("data-type")==="NodeTable"&&(o.querySelectorAll("colgroup col").forEach(b=>{b.style.minWidth="60px"}),p=o.outerHTML),j(n,r,p,c)}else{let p=n.lute.SpinBlockDOM(d);e==="<div>"&&(p=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${pn()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${g.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),o.insertAdjacentHTML("afterend",p);const b=o.outerHTML,m=p.substr(p.indexOf('data-node-id="')+14,22);o=n.wysiwyg.element.querySelector(`[data-node-id="${m}"]`),o.getAttribute("data-type")==="NodeTable"&&o.querySelectorAll("colgroup col").forEach(h=>{h.style.minWidth="60px"}),F(n,[{data:b,id:r,action:"update"},{data:o.outerHTML,id:m,previousID:r,action:"insert"}],[{id:m,action:"delete"},{data:c,id:r,action:"update"}])}if(e==="<div>"||e==="$$"||e.indexOf("```")>-1&&e.length>3)n.toolbar.showRender(n,o),Oe(o);else if(e.startsWith("```"))Ae(o);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){n.gutter.renderMenu(n,o);const p=o.getBoundingClientRect();window.siyuan.menus.menu.popup({x:p.left,y:p.top,isLeft:!0});const b=window.siyuan.menus.menu.element.querySelector('[data-id="assetSubMenu"]');b.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(b.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else e==="---"?ce(o):o.classList.contains("av")?Ye(o,n):re(o,l)}}select(e,n){var a,i,s;const l=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!l)return!1;if(e.key==="Enter"){if(l){const o=this.element.querySelector(".emojis__item--current");if(!o)return!1;const r=o.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3&&((a=c.endContainer.childNodes[c.endOffset-1])==null||a.remove()),kn(r);let u;r.indexOf(".")>-1?u=`:${r.split(".")[0]}: `:u=le(r)+" ",Re(n.lute.SpinBlockDOM(u),n),this.element.classList.add("fn__none")}else this.fill(r,n)}else{const o=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));o===g.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(o,n,!0,Ce(e))}return e.preventDefault(),e.stopPropagation(),!0}if(l){const o=this.element.querySelector(".emojis__item--current");if(!o)return!1;let r;if(e.key==="ArrowLeft"||e.key==="ArrowUp"?o.previousElementSibling?(o.classList.remove("emojis__item--current"),r=o.previousElementSibling):(i=o.parentElement.previousElementSibling)!=null&&i.previousElementSibling&&(o.classList.remove("emojis__item--current"),r=o.parentElement.previousElementSibling.previousElementSibling.lastElementChild):(e.key==="ArrowRight"||e.key==="ArrowDown")&&(o.nextElementSibling?(o.classList.remove("emojis__item--current"),r=o.nextElementSibling):(s=o.parentElement.nextElementSibling)!=null&&s.nextElementSibling&&(o.classList.remove("emojis__item--current"),r=o.parentElement.nextElementSibling.nextElementSibling.firstElementChild)),r){r.classList.add("emojis__item--current");const c=4,u=this.element.querySelector(".emojis__panel");r.offsetTop-c<u.scrollTop?u.scrollTop=r.offsetTop-c:r.offsetTop-c-u.clientHeight+r.clientHeight>u.scrollTop&&(u.scrollTop=r.offsetTop-c-u.clientHeight+r.clientHeight)}return e.preventDefault(),e.stopPropagation(),!0}else if(e.key==="ArrowDown"||e.key==="ArrowUp")return bn(this.element.firstElementChild,e),e.preventDefault(),e.stopPropagation(),!0;return e.key==="ArrowLeft"||e.key==="ArrowRight"?(Y(["hint"],n),e.preventDefault(),e.stopPropagation(),!0):!1}fixImageCursor(e){const n=xe(e.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(Ee(n)||(e.insertNode(document.createTextNode(g.ZWSP)),e.collapse(!1)))}getKey(e,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(s=>{const l=e.lastIndexOf(s.key);this.lastIndex<l&&(g.BLOCK_HINT_KEYS.includes(this.splitChar)&&(s.key===":"||s.key==="#"||s.key==="/"||s.key==="\u3001")||this.splitChar==="#"&&(s.key==="/"||s.key==="\u3001")||(this.splitChar=s.key,this.lastIndex=l))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(e.substr(this.lastIndex-1,1))||e.substr(this.lastIndex-1,2)==="::"));const a=e.split(this.splitChar),i=a[a.length-1];if(a.length>1&&i.trim()===i&&i.length<g.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&e.endsWith("\u3010\u3010\u3011")?"":i}}const Uc=t=>{const e=Lute.New();if(e.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.SetFileAnnotationRef(!0),e.SetTextMark(!0),e.SetHeadingID(!1),e.SetYamlFrontMatter(!1),e.PutEmojis(t.emojis),e.SetEmojiSite(t.emojiSite),e.SetHeadingAnchor(t.headingAnchor),e.SetInlineMathAllowDigitAfterOpenMarker(!0),e.SetToC(!1),e.SetIndentCodeBlock(!1),e.SetParagraphBeginningSpace(!0),e.SetSetext(!1),e.SetFootnotes(!1),e.SetLinkRef(!1),e.SetSanitize(t.sanitize),e.SetChineseParagraphBeginningSpace(t.paragraphBeginningSpace),e.SetRenderListStyle(t.listStyle),e.SetImgPathAllowSpace(!0),e.SetKramdownIAL(!0),e.SetTag(!0),e.SetSuperBlock(!0),e.SetGitConflict(!0),e.SetMark(!0),e.SetSup(!0),e.SetSub(!0),e.SetProtyleWYSIWYG(!0),t.lazyLoadImage&&e.SetImageLazyLoading(t.lazyLoadImage),e.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach(a=>{n[a.keywords]=t.emojiSite+"/"+a.unicode}),e.PutEmojis(n)}return e},Wc=(t,e)=>{if(typeof speechSynthesis=="undefined"||typeof SpeechSynthesisUtterance=="undefined")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const o=speechSynthesis.getVoices();let r,c;return o.forEach(u=>{u.lang===e.replace("_","-")&&(r=u),u.default&&(c=u)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const l=s();i.onclick=()=>{if(i.className==="protyle-speech"){const o=new SpeechSynthesisUtterance(i.getAttribute("data-text"));o.voice=l,o.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=n},speechSynthesis.speak(o),i.className="protyle-speech protyle-speech--current",i.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=a):(speechSynthesis.pause(),i.innerHTML=n));z(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}t.addEventListener("mouseup",s=>{const l=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const o=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=n,i.style.display="block",i.style.top=o.top+o.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",l)})};class Yc{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",e.options.classes.preview&&n.classList.add(e.options.classes.preview),n.style.padding=e.wysiwyg.element.style.padding;const a=e.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let l=0;l<a.length;l++){const o=a[l];if(typeof o=="object"){s.push(`<button type="button" data-type="${o.key}" class="${o.className}">${o.text}</button>`);continue}switch(o){case"desktop":s.push('<button type="button" class="protyle-preview__action--current" data-type="desktop">Desktop</button>');break;case"tablet":s.push('<button type="button" data-type="tablet">Tablet</button>');break;case"mobile":s.push('<button type="button" data-type="mobile">Mobile/Wechat</button>');break;case"mp-wechat":s.push('<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u516C\u4F17\u53F7"><svg><use xlink:href="#iconMp"></use></svg></button>');break;case"zhihu":s.push('<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u77E5\u4E4E"><svg><use xlink:href="#iconZhihu"></use></svg></button>');break;case"yuque":s.push('<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u8BED\u96C0"><svg><use xlink:href="#iconYuque"></use></svg></button>');break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(n),this.element.addEventListener("click",l=>{e.model&&(setPanelFocus(e.model.element.parentElement.parentElement),updateOutline(getAllModels(),e.model.editor.protyle));let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){const r=o.getAttribute("href");if(r.startsWith("#")){n.querySelector(r).scrollIntoView(),l.stopPropagation(),l.preventDefault();break}if(H()){Nt(r),l.stopPropagation(),l.preventDefault();break}l.stopPropagation(),l.preventDefault(),vs(r)||window.open(r);break}else if(o.tagName==="IMG"){Js(l.target.src,e.block.rootID),l.stopPropagation(),l.preventDefault();break}else if(o.tagName==="BUTTON"){const r=o.getAttribute("data-type"),c=a.find(u=>(u==null?void 0:u.key)===r);c?c.click(r):r==="mp-wechat"||r==="zhihu"||r==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),e,r):r==="desktop"?(n.style.width="",n.style.padding=e.wysiwyg.element.style.padding):r==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),this.render(e),i.querySelectorAll("button").forEach(u=>{u.classList.remove("protyle-preview__action--current")}),o.classList.add("protyle-preview__action--current")}o=o.parentElement}}),this.previewElement=n}render(e,n){if(this.element.style.display==="none")return;let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{_("/api/export/preview",{id:e.block.parentID||e.options.blockId},i=>{const s=e.preview.previewElement.scrollTop;e.preview.previewElement.innerHTML=i.data.html,Oe(e.preview.previewElement),Ae(e.preview.previewElement),Ye(e.preview.previewElement,e),Wc(e.preview.previewElement,e.options.lang),e.preview.previewElement.scrollTop=s,n&&n(i.data.outline),a.remove()})},e.options.preview.delay)}link2online(e){Qt("")||e.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const i=g.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",i):n.setAttribute("src",i)}})}copyToX(e,n,a){if(a==="mp-wechat")this.link2online(e),e.querySelectorAll(".katex-html .base").forEach(l=>{l.style.display="initial"}),e.querySelectorAll("mjx-container > svg").forEach(l=>{l.setAttribute("width",parseInt(l.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach(l=>{l.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${l.getAttribute("data-content")}\\" style="display: block; margin: 0 auto; max-width: 100%;">`}),e.querySelectorAll("blockquote").forEach(l=>{const o=[];this.processZHBlockquote(l,o),o.reverse().forEach(r=>{l.insertAdjacentElement("afterend",r)}),l.remove()}),this.processZHTable(e);else if(a==="yuque"){_("/api/lute/copyStdMarkdown",{id:n.block.rootID},l=>{Pe(l.data),oe("\u5DF2\u590D\u5236\uFF0C\u53EF\u5230\u8BED\u96C0\u8FDB\u884C\u7C98\u8D34")});return}e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach(l=>{l.style.backgroundImage="none"}),this.element.append(e);const i=getSelection().getRangeAt(0).cloneRange(),s=e.ownerDocument.createRange();s.selectNodeContents(e),z(s),document.execCommand("copy"),this.element.lastElementChild.remove(),z(i),a&&oe(`\u5DF2\u590D\u5236\uFF0C\u53EF\u5230${a==="zhihu"?"\u77E5\u4E4E":"\u5FAE\u4FE1\u516C\u4F17\u53F7\u5E73\u53F0"}\u8FDB\u884C\u7C98\u8D34`)}processZHBlockquote(e,n){Array.from(e.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const i=n[n.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(e){e.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const i=n.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const bo=(...t)=>{const e={},n=a=>{for(const i in a)a.hasOwnProperty(i)&&(Object.prototype.toString.call(a[i])==="[object Object]"?e[i]=bo(e[i],a[i]):e[i]=a[i])};for(let a=0;a<t.length;a++)n(t[a]);return e};class jc{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},debugger:g.NODE_ENV==="development",hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:Hn},{key:"\u3010\u3010",hint:Hn},{key:"\uFF08\uFF08",hint:Hn},{key:"[[",hint:Hn},{key:"{{",hint:ta},{key:"\u300C\u300C",hint:ta},{key:"\u300C\u300E",hint:ta},{key:"\u300E\u300C",hint:ta},{key:"\u300E\u300E",hint:ta},{key:"#",hint:Oc},{key:"/",hint:Ji},{key:"\u3001",hint:Ji},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:1e3,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:H()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],typewriterMode:!1,upload:{max:1024*1024*1024*4,url:g.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){var e;return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),(e=this.options.hint)!=null&&e.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),bo(this.defaultOptions,this.options)}mergeToolbar(e){const n=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return e.forEach(i=>{let s=i;n.find(l=>{if(typeof i=="string"&&l.name===i)return s=l,!0;if(typeof i=="object"&&l.name===i.name)return s=Object.assign({},l,i),!0}),a.push(s)}),a}}class zc{constructor(e){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),H()||(this.parentElement.style.right="10px"),this.parentElement.innerHTML=`<div class="b3-tooltips b3-tooltips__w protyle-scroll__up" aria-label="${De("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar b3-tooltips b3-tooltips__s" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="b3-tooltips b3-tooltips__w protyle-scroll__down" aria-label="${De("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,e.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)}),this.inputElement.addEventListener("change",()=>{this.setIndex(e)}),this.inputElement.addEventListener("touchend",()=>{this.setIndex(e)}),this.parentElement.addEventListener("click",n=>{const a=n.target;N(a,"protyle-scroll__up")?Cl(e):N(a,"protyle-scroll__down")?Tl(e):a.classList.contains("b3-slider")&&this.setIndex(e)})}setIndex(e){e.wysiwyg.element.getAttribute("data-top")||(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),_("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{qe({data:n,protyle:e,action:[g.CB_GET_FOCUSFIRST,g.CB_GET_UNCHANGEID]})}))}updateIndex(e,n){_("/api/block/getBlockIndex",{id:n},a=>{if(!a.data)return;const i=e.scroll.element.querySelector(".b3-slider");i.value=a.data,e.scroll.element.setAttribute("aria-label",`Blocks ${a.data}/${e.block.blockCount}`)})}update(e){typeof e.block.blockCount=="number"&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.scroll?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}class ii{constructor(e){this.app=e.app,e.msgCallback&&this.connect(e)}connect(e){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${g.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);a.onopen=()=>{e.callback&&e.callback.call(this),document.getElementById("errorLog")&&(oo(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},a.onmessage=i=>{if(e.msgCallback){const s=mi(JSON.parse(i.data));e.msgCallback.call(this,s)}},a.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})},3e3))},a.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&ro()},this.ws=a}send(e,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:n})))}}var ts=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Vc=(t,e)=>ts(void 0,null,function*(){try{let n=yield Fa();n=n.replace(/\\/g,"\\\\\\\\").replace(/\*/g,"\\\\\\*").replace(/\_/g,"\\\\\\_").replace(/\[/g,"\\\\\\[").replace(/\]/g,"\\\\\\]").replace(/\!/g,"\\\\\\!").replace(/\`/g,"\\\\\\`").replace(/\</g,"\\\\\\<").replace(/\>/g,"\\\\\\>").replace(/\&/g,"\\\\\\&").replace(/\~/g,"\\\\\\~").replace(/\{/g,"\\\\\\{").replace(/\}/g,"\\\\\\}").replace(/\(/g,"\\\\\\(").replace(/\)/g,"\\\\\\)").replace(/\=/g,"\\\\\\=").replace(/\#/g,"\\\\\\#").replace(/\$/g,"\\\\\\$").replace(/\^/g,"\\\\\\^").replace(/\|/g,"\\\\\\|"),wo(t,n,e)}catch(n){console.log(n)}}),Aa=(t,e)=>{let n=!0;t.options.hint.extend.find(a=>{if(a.key===e)return n=!1,!0}),n&&t.hint.render(t)},ho=t=>ts(void 0,null,function*(){[].length===0&&navigator.clipboard.readText().then(n=>{Re(t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(n)),t),Aa(t,n)})}),wo=(t,e,n)=>{const a=de(t.wysiwyg.element);if(n.getAttribute("data-type")==="NodeCodeBlock"){Re(e,t);return}a.toString()!==""&&(Q(e)?e=e.replace(/'.+'\)\)$/,` "${a.toString()}"))`):ge(e)?e=e.replace(/".+">>$/,`"${a.toString()}">>`):t.lute.IsValidLinkDest(e)&&(e=`[${a.toString()}](${e})`)),Re(t.lute.Md2BlockDOM(e),t),Se(t,t.wysiwyg.element),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t),Aa(t,e),Ie(t,void 0,!1,"smooth")},yo=(t,e)=>ts(void 0,null,function*(){var n;e.stopPropagation(),e.preventDefault();let a,i,s,l;if("clipboardData"in e?(a=e.clipboardData.getData("text/html"),i=e.clipboardData.getData("text/plain"),s=e.clipboardData.getData("text/siyuan"),l=e.clipboardData.files):(a=e.dataTransfer.getData("text/html"),i=e.dataTransfer.getData("text/plain"),s=e.dataTransfer.getData("text/siyuan"),e.dataTransfer.types[0]==="Files"&&(l=e.dataTransfer.items)),(a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${i}">${i}</a>`||a.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${i}">${i}</a><!--EndFragment-->`)&&(a=""),i.endsWith(g.ZWSP)&&!a&&!s&&(s=i.substr(0,i.length-1)),!s){const u=new DOMParser().parseFromString(a,"text/html");u.body&&u.body.innerHTML&&(a=u.body.innerHTML),a.startsWith(`
<!--StartFragment-->`)&&a.endsWith(`<!--EndFragment-->

`)&&(a=u.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),a=Lute.Sanitize(a)}const o=I(e.target);if(!o){l&&l.length>0&&an(t,l);return}Y(["select"],t),t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(u=>{u.classList.remove("protyle-wysiwyg--hl")});const r=Er(a,i),c=de(t.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||t.toolbar.getCurrentType(c).includes("code")){(n=o.querySelector(".protyle-action"))!=null&&n.contains(c.startContainer)&&c.setStart(o.querySelector(".hljs").firstChild,0),Re(i,t);return}else if(s){const u=document.createElement("div");u.innerHTML=s;let d=!1;u.querySelectorAll("[data-node-id]").forEach(p=>{const b=Lute.NewNodeID();p.setAttribute("data-node-id",b),p.removeAttribute(g.CUSTOM_RIFF_DECKS),p.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),p.setAttribute("updated",b.split("-")[0]),d=!0}),o.classList.contains("table")&&(d=!1),u.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(p=>{p.setAttribute("contenteditable","true")});const f=u.innerHTML;Re(f,t,d),Aa(t,t.lute.BlockDOM2StdMd(f)),Se(t,t.wysiwyg.element),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t)}else if(r)r.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(Re(r,t,!0),Ae(t.wysiwyg.element)):Re(r,t),Y(["hint"],t);else{let u=!1;if(a.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(a=a.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),l&&l.length===1&&(a.startsWith("<img")||a.startsWith("<table")&&a.indexOf("<img")>-1)?u=!1:u=!0),u){const d=document.createElement("div");d.innerHTML=a,d.querySelectorAll("[style]").forEach(f=>{f.removeAttribute("style")}),d.querySelectorAll("a").forEach(f=>{f.innerHTML.trim()===""&&f.remove()}),_("/api/lute/html2BlockDOM",{dom:d.innerHTML},f=>{Re(f.data,t),t.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(p=>{p.textContent===""&&_("/api/block/getRefText",{id:p.getAttribute("data-id")},b=>{p.innerHTML=b.data})}),Se(t,t.wysiwyg.element),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t),Aa(t,f.data),Ie(t,void 0,!1,"smooth")});return}else if(l&&l.length>0)an(t,l);else if(i.trim()!==""&&l&&l.length===0){if(c.toString()!==""){const f=i.split(`
`)[0];if(Q(i)){t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${i.substring(2,22+2)}${g.ZWSP}s${g.ZWSP}${c.toString()}`});return}else if(ge(f)){t.toolbar.setInlineMark(t,"file-annotation-ref","range",{type:"file-annotation-ref",color:f.substring(2).replace(/ ".+">>$/,"")});return}else if(t.lute.IsValidLinkDest(i)){t.toolbar.setInlineMark(t,"a","range",{type:"a",color:i});return}}const d=t.lute.Md2BlockDOM(i);Re(d,t),Aa(t,i)}Se(t,t.wysiwyg.element),Oe(t.wysiwyg.element),Ae(t.wysiwyg.element),Ye(t.wysiwyg.element,t)}Ie(t,void 0,!1,"smooth")});var si=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const _o=(t,e,n,a,i,s,l)=>{let o;const r=n.getAttribute("data-node-id"),c=a.getAttribute("data-node-id"),u=[],d=[];return n.insertAdjacentElement(s?"afterend":"beforebegin",a),s?u.push({action:"insert",data:a.outerHTML,id:c,previousID:r}):u.push({action:"insert",data:a.outerHTML,id:c,nextID:r}),e.reverse().forEach((f,p)=>{var b;const m=f.getAttribute("data-node-id");p===e.length-1&&(o=he(f),o.isSameNode(f)&&(o=void 0));const h=Lute.NewNodeID();if(l?d.push({action:"delete",id:h}):d.push({action:"move",id:m,previousID:(b=f.previousElementSibling)==null?void 0:b.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||t.block.rootID}),!i&&!l){const w=t.wysiwyg.element.querySelector(`[data-node-id="${m}"]`);w&&w.remove()}if(l){const w=f.cloneNode(!0);w.setAttribute("data-node-id",h),w.querySelectorAll("[data-node-id]").forEach(y=>{const E=Lute.NewNodeID();y.setAttribute("data-node-id",E),y.setAttribute("updated",E.split("-")[0])}),a.insertAdjacentElement("afterbegin",w),u.push({action:"insert",id:h,data:w.outerHTML,parentID:c})}else a.insertAdjacentElement("afterbegin",f),u.push({action:"move",id:m,parentID:c})}),d.reverse(),a.getAttribute("data-subtype")==="o"&&(d.splice(0,0,{action:"update",id:c,data:a.outerHTML}),Ne(a,1),u.push({action:"update",id:c,data:a.outerHTML})),d.push({action:"delete",id:c}),{doOperations:u,undoOperations:d,topSourceElement:o}},vo=(t,e,n,a,i,s)=>si(void 0,null,function*(){let l;const o=[],r=[],c=[],u=n.getAttribute("data-node-id");let d=n;e.reverse().forEach((f,p)=>{var b,m,h,w,y;const E=f.getAttribute("data-node-id"),S=f.parentElement.getAttribute("data-node-id")||t.block.rootID;p===e.length-1&&(l=he(f),l.isSameNode(f)?l=void 0:l.contains(f)&&l.contains(n)&&(l=n)),s&&f.getAttribute("data-type")==="NodeHeading"&&f.getAttribute("fold")==="1"&&(f.removeAttribute("fold"),c.push({id:E,parentID:S}));let x,k;if(s?(x=Lute.NewNodeID(),r.push({action:"delete",id:x})):r.push({action:"move",id:E,previousID:(b=f.previousElementSibling)==null?void 0:b.getAttribute("data-node-id"),parentID:S}),!a&&!s){const C=t.wysiwyg.element.querySelector(`[data-node-id="${E}"]`);C&&C.remove()}s?(k=f.cloneNode(!0),k.setAttribute("data-node-id",x),k.querySelectorAll("[data-node-id]").forEach(C=>{const v=Lute.NewNodeID();C.setAttribute("data-node-id",v),C.setAttribute("updated",v.split("-")[0])}),d.insertAdjacentElement(i,k),o.push({action:"insert",id:x,data:k.outerHTML,previousID:i==="afterend"?u:(m=k.previousElementSibling)==null?void 0:m.getAttribute("data-node-id"),parentID:((h=k.parentElement)==null?void 0:h.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID})):(d.insertAdjacentElement(i,f),o.push({action:"move",id:E,previousID:i==="afterend"?u:(w=f.previousElementSibling)==null?void 0:w.getAttribute("data-node-id"),parentID:((y=f.parentElement)==null?void 0:y.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID})),i!=="afterend"&&(d=s?k:f)}),r.reverse();for(let f=0;f<c.length;f++){const p=c[f];(yield Dt("/api/block/getHeadingChildrenIDs",{id:p.id})).data.reverse().forEach(m=>{r.push({action:"move",id:m,previousID:p.id,parentID:p.parentID})}),r.push({action:"foldHeading",id:p.id,data:"remove"}),o.push({action:"unfoldHeading",id:p.id})}return{doOperations:o,undoOperations:r,topSourceElement:l}}),Eo=(t,e,n,a,i,s)=>si(void 0,null,function*(){var l,o,r,c,u,d;const f=t.element.contains(e[0]);let p;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(p=document.createElement("div"),p.setAttribute("data-node-id",Lute.NewNodeID()),p.setAttribute("data-type","NodeList"),p.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),p.className="list",p.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div>`));const b=[{action:"move",id:n.getAttribute("data-node-id"),previousID:(l=n.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:((o=n.parentElement)==null?void 0:o.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}];let m,h=e[0].parentElement;const w=qs(i);n.parentElement.replaceChild(w,n);const y=[{action:"insert",data:w.outerHTML,id:w.getAttribute("data-node-id"),nextID:(r=w.nextElementSibling)==null?void 0:r.getAttribute("data-node-id"),previousID:(c=w.previousElementSibling)==null?void 0:c.getAttribute("data-node-id"),parentID:w.parentElement.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];if(p){const E=p.getAttribute("data-node-id");w.insertAdjacentElement("afterbegin",n),y.push({action:"move",id:n.getAttribute("data-node-id"),parentID:w.getAttribute("data-node-id")}),a?(n.insertAdjacentElement("afterend",p),y.push({action:"insert",data:p.outerHTML,id:E,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",p),y.push({action:"insert",data:p.outerHTML,id:E,nextID:n.getAttribute("data-node-id")})),e.reverse().forEach((S,x)=>{var k;x===e.length-1&&(m=he(S),m.isSameNode(S)&&(m=void 0));const C=Lute.NewNodeID();if(s?b.push({action:"delete",id:C}):b.push({action:"move",id:S.getAttribute("data-node-id"),previousID:(k=S.previousElementSibling)==null?void 0:k.getAttribute("data-node-id"),parentID:S.parentElement.getAttribute("data-node-id")||t.block.rootID}),!f&&!s){const v=t.wysiwyg.element.querySelector(`[data-node-id="${S.getAttribute("data-node-id")}"]`);v&&v.remove()}if(s){const v=S.cloneNode(!0);v.setAttribute("data-node-id",C),v.querySelectorAll("[data-node-id]").forEach(L=>{const D=Lute.NewNodeID();L.setAttribute("data-node-id",D),L.setAttribute("updated",D.split("-")[0])}),p.insertAdjacentElement("afterbegin",v),y.push({action:"insert",id:C,data:v.outerHTML,parentID:E})}else p.insertAdjacentElement("afterbegin",S),y.push({action:"move",id:S.getAttribute("data-node-id"),parentID:E})}),b.reverse(),b.push({action:"delete",id:E})}else{const E=[];let S;e.reverse().forEach((x,k)=>{var C;const v=x.getAttribute("data-node-id"),L=x.parentElement.getAttribute("data-node-id")||t.block.rootID;k===e.length-1&&(m=he(x),m.isSameNode(x)&&(m=void 0));const D=Lute.NewNodeID();if(k===0&&(S=s?D:v),s&&x.getAttribute("data-type")==="NodeHeading"&&x.getAttribute("fold")==="1"&&(x.removeAttribute("fold"),E.push({id:v,parentID:L})),s?b.push({action:"delete",id:D}):b.push({action:"move",id:v,previousID:(C=x.previousElementSibling)==null?void 0:C.getAttribute("data-node-id"),parentID:L}),!f&&!s){const O=t.wysiwyg.element.querySelector(`[data-node-id="${v}"]`);O&&O.remove()}if(s){const O=x.cloneNode(!0);O.setAttribute("data-node-id",D),O.querySelectorAll("[data-node-id]").forEach(P=>{const Z=Lute.NewNodeID();P.setAttribute("data-node-id",Z),P.setAttribute("updated",Z.split("-")[0])}),w.insertAdjacentElement("afterbegin",O),y.push({action:"insert",id:D,data:O.outerHTML,parentID:w.getAttribute("data-node-id")})}else w.insertAdjacentElement("afterbegin",x),y.push({action:"move",id:v,parentID:w.getAttribute("data-node-id")})}),b.reverse();for(let x=0;x<E.length;x++){const k=E[x],C=yield Dt("/api/block/getHeadingChildrenIDs",{id:k.id});C.data.reverse().forEach(v=>{b.push({action:"move",id:v,previousID:k.id,parentID:k.parentID})}),x===0&&(S=C.data[0]),b.push({action:"foldHeading",id:k.id,data:"remove"}),y.push({action:"unfoldHeading",id:k.id})}a?(w.insertAdjacentElement("afterbegin",n),y.push({action:"move",id:n.getAttribute("data-node-id"),parentID:w.getAttribute("data-node-id")})):(w.lastElementChild.insertAdjacentElement("beforebegin",n),y.push({action:"move",id:n.getAttribute("data-node-id"),previousID:S}))}if(b.push({action:"delete",id:w.getAttribute("data-node-id")}),!s&&h&&h.classList.contains("list")&&h.getAttribute("data-subtype")==="o"&&!h.isSameNode(e[0].parentElement)&&h.childElementCount>1&&(Array.from(h.children).forEach(E=>{E.classList.contains("protyle-attr")||b.splice(0,0,{action:"update",id:E.getAttribute("data-node-id"),data:E.outerHTML})}),Ne(h,1),Array.from(h.children).forEach(E=>{E.classList.contains("protyle-attr")||y.push({action:"update",id:E.getAttribute("data-node-id"),data:E.outerHTML})})),!s&&m){if(y.push({action:"delete",id:m.getAttribute("data-node-id")}),b.splice(0,0,{action:"insert",data:m.outerHTML,id:m.getAttribute("data-node-id"),previousID:(u=m.previousElementSibling)==null?void 0:u.getAttribute("data-node-id"),parentID:((d=m.parentElement)==null?void 0:d.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),!f){const E=t.wysiwyg.element.querySelector(`[data-node-id="${m.getAttribute("data-node-id")}"]`);E&&E.remove()}h=m.parentElement,m.remove()}if(!s&&h&&h.classList.contains("sb")&&h.childElementCount===2){const E=Fn(t,h);y.push(E.doOperations[0],E.doOperations[1]),b.splice(0,0,E.undoOperations[0],E.undoOperations[1])}else!s&&h&&h.classList.contains("protyle-wysiwyg")&&h.innerHTML;f||s?F(t,y,b):F(t,y),ce(e[0])}),ko=(t,e,n,a,i)=>si(void 0,null,function*(){var s,l;const o=t.element.contains(e[0]),r=[],c=[];let u;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(u=document.createElement("div"),u.setAttribute("data-node-id",Lute.NewNodeID()),u.setAttribute("data-type","NodeList"),u.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),u.className="list",u.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div>`));let d,f=e[0].parentElement;if(a)if(u){const p=_o(t,e,n,u,o,a,i);r.push(...p.doOperations),c.push(...p.undoOperations),d=p.topSourceElement}else{const p=yield vo(t,e,n,o,"afterend",i);r.push(...p.doOperations),c.push(...p.undoOperations),d=p.topSourceElement}else if(u){const p=_o(t,e,n,u,o,a,i);r.push(...p.doOperations),c.push(...p.undoOperations),d=p.topSourceElement}else{const p=yield vo(t,e,n,o,"beforebegin",i);r.push(...p.doOperations),c.push(...p.undoOperations),d=p.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(p=>{p.classList.contains("protyle-attr")||c.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})}),Ne(n.parentElement,1),Array.from(n.parentElement.children).forEach(p=>{p.classList.contains("protyle-attr")||r.push({action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})})),!i&&o&&f&&f.classList.contains("list")&&f.getAttribute("data-subtype")==="o"&&!f.isSameNode(e[0].parentElement)&&f.childElementCount>1&&(Array.from(f.children).forEach(p=>{p.classList.contains("protyle-attr")||(f.contains(n)?c.splice(0,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}):c.splice(n.parentElement.childElementCount-1,0,{action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML}))}),Ne(f,1),Array.from(f.children).forEach(p=>{p.classList.contains("protyle-attr")||r.push({action:"update",id:p.getAttribute("data-node-id"),data:p.outerHTML})})),!i&&d&&(r.push({action:"delete",id:d.getAttribute("data-node-id")}),c.splice(0,0,{action:"insert",data:d.outerHTML,id:d.getAttribute("data-node-id"),previousID:(s=d.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:((l=d.parentElement)==null?void 0:l.getAttribute("data-node-id"))||t.block.parentID||t.block.rootID}),f=d.parentElement,d.remove(),!o)){const p=t.wysiwyg.element.querySelector(`[data-node-id="${d.getAttribute("data-node-id")}"]`);p&&p.remove()}if(!i&&f&&f.classList.contains("sb")&&f.childElementCount===2){const p=Fn(t,f);r.push(p.doOperations[0],p.doOperations[1]),c.splice(0,0,p.undoOperations[0],p.undoOperations[1])}else!i&&f&&f.classList.contains("protyle-wysiwyg")&&f.childElementCount;o||i?F(t,r,c):F(t,r),ce(e[0])}),Gc=(t,e)=>{e.addEventListener("dragstart",i=>{const s=i.target;if(s.tagName==="IMG"){window.siyuan.dragElement=void 0,i.preventDefault();return}if(s.classList){if(N(s,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,i.preventDefault();else if(s.classList.contains("protyle-action")){window.siyuan.dragElement=t.wysiwyg.element,i.dataTransfer.setData(`${g.SIYUAN_DROP_GUTTER}NodeListItem${g.ZWSP}${s.parentElement.getAttribute("data-subtype")}${g.ZWSP}${[s.parentElement.getAttribute("data-node-id")]}`,t.wysiwyg.element.innerHTML);return}else if(s.classList.contains("av__cellheader")){window.siyuan.dragElement=s.parentElement,i.dataTransfer.setData(`${g.SIYUAN_DROP_GUTTER}NodeAttributeView${g.ZWSP}Col${g.ZWSP}${[s.parentElement.getAttribute("data-col-id")]}`,s.innerHTML);return}else if(s.classList.contains("av__gutters")){if(!I(s))return;const o=s.parentElement,r=[];o.classList.contains("av__row--select")?o.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(c=>{r.push(c.getAttribute("data-id"))}):r.push(o.getAttribute("data-id")),r.length===1&&i.dataTransfer.setDragImage(o,0,0),window.siyuan.dragElement=o,i.dataTransfer.setData(`${g.SIYUAN_DROP_GUTTER}NodeAttributeView${g.ZWSP}Row${g.ZWSP}${r}`,o.innerHTML);return}}i.dataTransfer.setData(g.SIYUAN_DROP_EDITOR,g.SIYUAN_DROP_EDITOR),t.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),e.addEventListener("drop",i=>si(void 0,null,function*(){var s,l,o,r,c;if(t.disabled||i.dataTransfer.getData(g.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation();return}let u="";for(const f of i.dataTransfer.items)f.type.startsWith(g.SIYUAN_DROP_GUTTER)&&(u=f.type);const d=(u.startsWith(`application/siyuan-gutternodeattributeview${g.ZWSP}col`)?N(i.target,"av__cell"):N(i.target,"av__row"))||I(i.target);if(u){const f=[],p=u.replace(g.SIYUAN_DROP_GUTTER,"").split(g.ZWSP),b=p[2].split(",");if(i.altKey){z(pi(i.clientX,i.clientY));let m="";for(let h=0;h<b.length;h++){const w=yield Dt("/api/block/getRefText",{id:b[h]});m+=`((${b[h]} '${w.data}')) `}Re(m,t)}else if(i.shiftKey){z(pi(i.clientX,i.clientY));let m="";b.forEach(h=>{m+=`{{select * from blocks where id='${h}'}}
`}),Re(t.lute.SpinBlockDOM(m),t,!0),Se(t,t.wysiwyg.element)}else if(d&&d.className.indexOf("dragover__")>-1){let m="";if(b.forEach(y=>{m+=`[data-node-id="${y}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(m.substring(0,m.length-1)).forEach(y=>{(y.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(y,"data-type","NodeBlockQueryEmbed"))&&f.push(y)});else{const y=document.createElement("template");y.innerHTML=`<div>${i.dataTransfer.getData(u)}</div>`,y.content.querySelectorAll(m.substring(0,m.length-1)).forEach(E=>{(E.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(E,"data-type","NodeBlockQueryEmbed"))&&f.push(E)})}const h=[];f.forEach(y=>{y.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),y.removeAttribute("select-start"),y.removeAttribute("select-end"),y.querySelectorAll('[data-type="search-mark"]').forEach(E=>{E.outerHTML=E.innerHTML}),h.push(y.getAttribute("data-node-id"))}),Y(["gutter"],t);const w=d.className.split(" ");if(d.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right","protyle-wysiwyg--select"),d.classList.contains("av__cell")){const y=I(d);if(y){const E=y.getAttribute("data-av-id");F(t,[{action:"sortAttrViewCol",avID:E,previousID:(w.includes("dragover__left")?(s=d.previousElementSibling)==null?void 0:s.getAttribute("data-col-id"):d.getAttribute("data-col-id"))||"",id:p[2]}],[{action:"sortAttrViewCol",avID:E,previousID:((l=d.parentElement.querySelector(`[data-col-id="${p[2]}"`).previousElementSibling)==null?void 0:l.getAttribute("data-col-id"))||"",id:p[2]}])}}else if(d.classList.contains("av__row")){const y=I(d);if(y){let E="";w.includes("dragover__bottom")?E=d.getAttribute("data-id")||"":E=((o=d.previousElementSibling)==null?void 0:o.getAttribute("data-id"))||"";const S=y.getAttribute("data-av-id");if(p[0]==="nodeattributeview"&&p[1]==="row"){const x=[],k=[],C=y.querySelector(`[data-id="${b[0]}"]`).previousElementSibling.getAttribute("data-id")||"";b.reverse().forEach(v=>{x.push({action:"sortAttrViewRow",avID:S,previousID:E,id:v}),k.push({action:"sortAttrViewRow",avID:S,previousID:C,id:v})}),F(t,x,k)}else F(t,[{action:"insertAttrViewBlock",avID:S,previousID:E,srcIDs:h}],[{action:"removeAttrViewBlock",srcIDs:h,avID:S}]),xi(y,h.length,E)}}else d.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&d.parentElement.getAttribute("data-sb-layout")==="col"?w.includes("dragover__left")||w.includes("dragover__right")?ko(t,f,d,w.includes("dragover__right"),i.ctrlKey):Eo(t,f,d,w.includes("dragover__bottom"),"row",i.ctrlKey):w.includes("dragover__left")||w.includes("dragover__right")?Eo(t,f,d,w.includes("dragover__right"),"col",i.ctrlKey):ko(t,f,d,w.includes("dragover__bottom"),i.ctrlKey),f.forEach(y=>{y.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(y.removeAttribute("data-render"),Se(t,y))}),d.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(d.removeAttribute("data-render"),Se(t,d))}}else if(((r=i.dataTransfer.getData(g.SIYUAN_DROP_FILE))==null?void 0:r.split("-").length)>1&&d&&!t.options.backlinkData&&d.className.indexOf("dragover__")>-1){const f=t.contentElement.scrollTop,p=i.dataTransfer.getData(g.SIYUAN_DROP_FILE).split(",");if(d.classList.contains("av__row")){const b=I(d);if(b){let m="";d.classList.contains("dragover__bottom")?m=d.getAttribute("data-id")||"":m=((c=d.previousElementSibling)==null?void 0:c.getAttribute("data-id"))||"";const h=b.getAttribute("data-av-id");F(t,[{action:"insertAttrViewBlock",avID:h,previousID:m,srcIDs:p}],[{action:"removeAttrViewBlock",srcIDs:p,avID:h}]),xi(b,p.length,m)}}else{for(let b=0;b<p.length;b++)p[b]&&(yield Dt("/api/filetree/doc2Heading",{srcID:p[b],after:d.classList.contains("dragover__bottom"),targetID:d.getAttribute("data-node-id")}));_("/api/filetree/getDoc",{id:t.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},b=>{qe({data:b,protyle:t}),setTimeout(()=>{t.contentElement.scrollTop=f,t.scroll.lastScrollTop=f-1},g.TIMEOUT_LOAD)})}d.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right","protyle-wysiwyg--select")}else if(!window.siyuan.dragElement&&(i.dataTransfer.types[0]==="Files"||i.dataTransfer.types.includes("text/html")))if(z(pi(i.clientX,i.clientY)),i.dataTransfer.types[0]==="Files"&&!se()){const f=[];for(let p=0;p<i.dataTransfer.files.length;p++)f.push(i.dataTransfer.files[p].path);rl(f,t,!i.altKey)}else yo(t,i);window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}));let n,a;e.addEventListener("dragover",i=>{var s,l;if(i.dataTransfer.types.includes("Files")&&i.target.classList.contains("protyle-wysiwyg")){i.preventDefault();return}let o="";for(const u of i.dataTransfer.items)u.type.startsWith(g.SIYUAN_DROP_GUTTER)&&(o=u.type);if(!o&&!window.siyuan.dragElement){i.preventDefault();return}if(i.shiftKey||i.altKey){const u=I(i.target);u&&u.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),i.preventDefault();return}i.preventDefault();let r=N(i.target,"av__row")||I(i.target);if(o&&o.startsWith(`${g.SIYUAN_DROP_GUTTER}NodeAttributeView${g.ZWSP}Col${g.ZWSP}`.toLowerCase())?(r=N(i.target,"av__cell"),r&&!r.parentElement.isSameNode(window.siyuan.dragElement.parentElement)&&(r=!1)):r&&o&&o.startsWith(`${g.SIYUAN_DROP_GUTTER}NodeAttributeView${g.ZWSP}Row${g.ZWSP}`.toLowerCase())&&(!r.classList.contains("av__row")||!r.parentElement.isSameNode(window.siyuan.dragElement.parentElement))&&(r=!1),!r||r!=null&&r.classList.contains("av"))return;const c=i.dataTransfer.types.includes(g.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(r&&n&&r.isSameNode(n)){const u=r.getBoundingClientRect();if(r.classList.remove("protyle-wysiwyg--select","dragover__top","dragover__bottom","dragover__left","dragover__right"),r.getAttribute("data-type")==="NodeAttributeView"&&Je(i.target,"TD")){r.classList.add("protyle-wysiwyg--select");return}if(r.getAttribute("data-type")==="NodeListItem"||c.indexOf("-")>-1){i.clientY>u.top+u.height/2?r.classList.add("dragover__bottom","protyle-wysiwyg--select"):r.classList.contains("av__row--header")||r.classList.add("dragover__top","protyle-wysiwyg--select");return}if(r.classList.contains("av__cell")){i.clientX<u.left+u.width/2&&i.clientX>u.left&&!r.classList.contains("av__row")?r.classList.add("dragover__left","protyle-wysiwyg--select"):i.clientX>u.right-u.width/2&&i.clientX<u.right&&!r.classList.contains("av__row")&&r.classList.add("dragover__right","protyle-wysiwyg--select");return}i.clientX<u.left+32&&i.clientX>u.left&&!r.classList.contains("av__row")?r.classList.add("dragover__left","protyle-wysiwyg--select"):i.clientX>u.right-32&&i.clientX<u.right&&!r.classList.contains("av__row")?r.classList.add("dragover__right","protyle-wysiwyg--select"):i.clientY>u.top+u.height/2&&a!=="bottom"?r.classList.add("dragover__bottom","protyle-wysiwyg--select"):a!=="top"&&r.classList.add("dragover__top","protyle-wysiwyg--select");return}if(c.indexOf("-")>-1){c.split(",").includes(t.block.rootID)&&!r.classList.contains("av__row")?n=void 0:n=r;return}if(o){a="";const u=o.replace(g.SIYUAN_DROP_GUTTER,"").split(g.ZWSP);if(u[0]==="nodeattributeview"&&u[1]==="col"&&r.getAttribute("data-id")===u[2]||u[2].split(",").find(f=>{if(f&&A(r,"data-node-id",f))return!0})||A(r.parentElement,"data-type","NodeBlockQueryEmbed")||u[0]==="nodelistitem"&&u[1]!==r.getAttribute("data-subtype")&&r.getAttribute("data-type")==="NodeListItem"||u[0]!=="nodelistitem"&&r.getAttribute("data-type")==="NodeListItem")return;u[0]==="nodelistitem"&&r.parentElement.classList.contains("li")&&((s=r.previousElementSibling)!=null&&s.classList.contains("protyle-action"))&&(a="top"),u[0]==="nodelistitem"&&((l=r.nextElementSibling)!=null&&l.classList.contains("list"))&&(a="bottom"),r&&r.classList.contains("av__row--header")&&(a="top"),n=r}}),e.addEventListener("dragleave",i=>{let s=N(i.target,"av__row")||I(i.target);if(s&&!s.classList.contains("av")){let l="";for(const o of i.dataTransfer.items)o.type.startsWith(g.SIYUAN_DROP_GUTTER)&&(l=o.type);s.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right"),s.classList.contains("av__row")?(s.classList.remove("protyle-wysiwyg--select"),s.classList.contains("av__row--header")&&(s=N(i.target,"av__cell"),s&&s.classList.remove("protyle-wysiwyg--select","dragover__left","dragover__right"))):l.indexOf(s.getAttribute("data-node-id"))===-1&&(s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"))}})},Lo=(t,e,n,a)=>{a&&console.log(`${t} - ${n}: ${e}`)},Kc=(t,e,n,a,i)=>{if(e!=="NodeCodeBlock"&&n.parentElement.getAttribute("data-subtype")!=="t"&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const s=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,l=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const o=n.parentElement.parentElement,r=o.outerHTML;return o.setAttribute("data-subtype","t"),o.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),l&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(s),j(t,o.getAttribute("data-node-id"),o.outerHTML,r),re(t.wysiwyg.element,i),!0}return!1}else{const o=n.getAttribute("data-node-id"),r=Lute.NewNodeID(),c=Lute.NewNodeID(),u=Lute.NewNodeID(),d=n.outerHTML;return a.innerHTML=a.innerHTML.substring(s),F(t,[{action:"update",id:o,data:n.outerHTML},{action:"insert",id:r,data:`<div data-subtype="t" data-node-id="${r}" updated="${r.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div><div data-node-id="${c}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:o},{action:"move",id:o,previousID:c},{action:"delete",id:c}],[{action:"update",id:o,data:d},{action:"move",id:o,previousID:r},{action:"delete",id:r}]),n.outerHTML=`<div data-subtype="t" data-node-id="${r}" data-type="NodeList" class="list" updated="${r.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${u}" data-type="NodeListItem" class="li${l?" protyle-task--done":""}" updated="${u.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${l?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,re(t.wysiwyg.element,i),!0}}return!1},Zc=(t,e,n,a,i)=>{if(e==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=n.getAttribute("data-node-id"),l=Lute.NewNodeID(),o=Lute.NewNodeID(),r=Lute.NewNodeID(),c=n.outerHTML,u=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),F(t,[{action:"update",id:s,data:n.outerHTML},{action:"insert",id:l,data:`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${u}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${o}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:o},{action:"delete",id:o}],[{action:"update",id:s,data:c},{action:"move",id:s,previousID:l},{action:"delete",id:l}]),n.outerHTML=`<div data-subtype="u" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div data-marker="${u}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,re(t.wysiwyg.element,i),!0}return!1};var Xc=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const ns=(t,e,n,a=!0)=>Xc(void 0,null,function*(){var i,s,l,o;if(!e.parentElement)return;if(e.classList.contains("av")){Qa(t,e);return}const r=$(e),c=e.getAttribute("data-type");if(!r){c==="NodeThematicBreak"?e.innerHTML="<div><wbr></div>":c==="NodeBlockQueryEmbed"?e.lastElementChild.previousElementSibling.innerHTML="<wbr>"+g.ZWSP:c==="NodeMathBlock"||c==="NodeHTMLBlock"?e.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+g.ZWSP:c==="NodeIFrame"||c==="NodeWidget"?e.innerHTML="<wbr>"+e.firstElementChild.outerHTML+e.lastElementChild.outerHTML:c==="NodeVideo"?e.firstElementChild.innerHTML="<wbr>"+g.ZWSP+e.firstElementChild.firstElementChild.outerHTML+e.firstElementChild.lastElementChild.outerHTML:c==="NodeAudio"?e.firstElementChild.innerHTML=e.firstElementChild.firstElementChild.outerHTML+"<wbr>"+g.ZWSP:c==="NodeCodeBlock"&&(n.startContainer.textContent=g.ZWSP),re(e,n);return}const u=document.createElement("wbr");n.insertNode(u);const d=e.getAttribute("data-node-id");if(c!=="NodeCodeBlock"&&(r.innerHTML.endsWith(`
<wbr>`)||r.innerHTML.endsWith(`
<wbr>
`))){j(t,d,e.outerHTML,e.outerHTML.replace(`
<wbr>`,"<wbr>")),u.remove();return}if(Kc(t,c,e,r,n)||Zc(t,c,e,r,n))return;const f=e.querySelector("br");f&&f.parentElement.tagName!=="TD"&&f.parentElement.tagName!=="TH"&&(f.parentElement.textContent.trim()===""||((s=(i=f.previousSibling)==null?void 0:i.previousSibling)==null?void 0:s.textContent)===`
`)&&f.remove(),e.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),(r.innerHTML==="\u300B<wbr>"||r.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(r.innerHTML=r.innerHTML.replace("\u300B<wbr>","><wbr>"));const p=r.innerHTML.trimStart();if(!((p.startsWith("````")||p.startsWith("\xB7\xB7\xB7\xB7")||p.startsWith("~~~~"))&&p.indexOf(`
`)===-1)){if((p.startsWith("```")||p.startsWith("\xB7\xB7\xB7")||p.startsWith("~~~"))&&p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){j(t,d,e.outerHTML,t.wysiwyg.lastHTMLs[d]),u.remove();return}}(p==="\xA5\xA5<wbr>"||p==="\uFFE5\uFFE5<wbr>")&&(r.innerHTML="$$<wbr>");const b=A(n.startContainer,"data-type","block-ref");b&&b.getAttribute("data-subtype")==="d"&&(yield Dt("/api/block/getRefText",{id:b.getAttribute("data-id")})).data!==b.innerHTML.replace("<wbr>","")&&b.setAttribute("data-subtype","s");let m=e.outerHTML,h=!1;if(r.textContent==="---"&&c!=="NodeCodeBlock"){m=`<div data-node-id="${d}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const y=B(r);y?q(y)?h=!0:ce(y):m+=Ka(!1,!0)}else{if(c!=="NodeCodeBlock"&&(p.startsWith("```")||p.startsWith("~~~")||p.startsWith("\xB7\xB7\xB7")||p.indexOf("\n```")>-1||p.indexOf(`
~~~`)>-1||p.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(p.indexOf(`
`)===-1&&p.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let y=r.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();y.endsWith("\n```")||(y=y.replace("<wbr>","")+"<wbr>\n```"),r.innerHTML=y,m=e.outerHTML}m=t.lute.SpinBlockDOM(m)}Y(["util"],t,!0);const w=document.createElement("template");if(w.innerHTML=m,a&&(((l=$(w.content.firstElementChild))==null?void 0:l.innerHTML)!==$(e).innerHTML||w.content.childElementCount===1&&((o=$(w.content.firstElementChild))==null?void 0:o.innerHTML)==="<wbr>")&&!(w.content.childElementCount===1&&w.content.firstElementChild.classList.contains("code-block")&&c==="NodeCodeBlock")){Lo("SpinBlockDOM",e.outerHTML,"argument",t.options.debugger),Lo("SpinBlockDOM",m,"result",t.options.debugger);let y;e.classList.contains("table")&&(y=$(e).scrollLeft),/<span data-type="backslash"><span>\\<\/span>.<\/span><wbr>/.test(m)?e.outerHTML=m:e.outerHTML=m.replace("</span><wbr>","</span>"+g.ZWSP+"<wbr>"),t.wysiwyg.element.querySelectorAll(`[data-node-id="${d}"]`).forEach(E=>{(E.getAttribute("data-type")==="NodeBlockQueryEmbed"||!A(E,"data-type","NodeBlockQueryEmbed"))&&(e=E)}),m.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(e.querySelectorAll('[data-type="inline-math"]')).find(E=>{if(E.dataset.content.indexOf("<wbr>")>-1)return E.setAttribute("data-content",E.dataset.content.replace("<wbr>","")),t.toolbar.showRender(t,E),!0}),Array.from(w.content.children).forEach((E,S)=>{const x=E.getAttribute("data-node-id");let k;x===d?k=e:k=t.wysiwyg.element.querySelector(`[data-node-id="${x}"]`);const C=k.getAttribute("data-type");if(C==="NodeCodeBlock"){const v=k.querySelector(".protyle-action__language");v?(window.siyuan.storage[g.LOCAL_CODELANG]&&v.textContent===""&&(v.textContent=window.siyuan.storage[g.LOCAL_CODELANG]),Ae(k)):w.content.childElementCount===1&&t.toolbar.showRender(t,k)}else["NodeMathBlock","NodeHTMLBlock"].includes(C)?(C==="NodeMathBlock"&&en(k),t.toolbar.showRender(t,k)):C==="NodeBlockQueryEmbed"?(Se(t,k),t.toolbar.showRender(t,k),Y(["hint"],t)):C==="NodeThematicBreak"&&h?ce(e):(k.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(v=>{v.textContent===""&&_("/api/block/getRefText",{id:v.getAttribute("data-id")},L=>{v.innerHTML=L.data})}),en(k),S===w.content.childElementCount-1&&(re(t.wysiwyg.element,n),t.hint.render(t),y>0&&($(k).scrollLeft=y)))})}else e.getAttribute("data-type")==="NodeCodeBlock"?(r.removeAttribute("data-render"),Ae(e)):(re(t.wysiwyg.element,n),t.hint.render(t));Y(["gutter"],t),Qc(m,t,d)}),Qc=(t,e,n)=>{const a=document.createElement("template");a.innerHTML=t;const i=[],s=[];Array.from(a.content.children).forEach((l,o)=>{var r;l.getAttribute("spellcheck")==="false"&&l.getAttribute("contenteditable")==="false"&&l.setAttribute("contenteditable","true");const c=l.getAttribute("data-node-id");if(c===n)i.push({id:n,data:l.outerHTML,action:"update"}),s.push({id:n,data:e.wysiwyg.lastHTMLs[n],action:"update"});else{let u;o===0&&(u=e.wysiwyg.element.querySelector(`[data-node-id="${c}"]`)),i.push({action:"insert",data:l.outerHTML,id:c,previousID:o===0?(r=u==null?void 0:u.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"):l.previousElementSibling.getAttribute("data-node-id"),parentID:(u==null?void 0:u.parentElement.getAttribute("data-node-id"))||e.block.parentID}),s.push({id:c,action:"delete"})}}),F(e,i,s)},Jc=(t,e,n)=>{var a;if(!e.parentElement.previousElementSibling&&e.parentElement.nextElementSibling&&e.parentElement.nextElementSibling.classList.contains("protyle-attr")){ga(t,[e.parentElement],n);return}if(!e.parentElement.previousElementSibling&&e.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const d=e.parentElement.parentElement,f=d.outerHTML,p=e.parentElement.parentElement.previousElementSibling.lastElementChild,b=p.parentElement.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove(),p.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),d.getAttribute("data-subtype")==="o"&&Ne(d),F(t,[{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML},{action:"update",data:p.parentElement.outerHTML,id:p.parentElement.getAttribute("data-node-id")}],[{action:"update",data:b,id:p.parentElement.getAttribute("data-node-id")},{action:"update",data:f,id:d.getAttribute("data-node-id")}]),re(p.parentElement,n);return}if(!e.parentElement.previousElementSibling){if(e.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;n.insertNode(document.createElement("wbr"));const d=e.parentElement.parentElement,f=d.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove();const p=document.createElement("div");p.innerHTML=e.parentElement.innerHTML;const b=[],m=[];Array.from(p.children).forEach((h,w)=>{var y;b.push({action:"insert",id:h.getAttribute("data-node-id"),data:h.outerHTML,previousID:w===0?(y=d.previousElementSibling)==null?void 0:y.getAttribute("data-node-id"):b[w-1].id,parentID:d.parentElement.getAttribute("data-node-id")||t.block.parentID}),m.push({action:"delete",id:h.getAttribute("data-node-id")})}),d.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),d.getAttribute("data-subtype")==="o"&&Ne(d,parseInt(d.firstElementChild.getAttribute("data-marker"))-1),b.splice(0,0,{action:"update",id:d.getAttribute("data-node-id"),data:d.outerHTML}),m.push({action:"update",data:f,id:d.getAttribute("data-node-id")}),F(t,b,m),re(t.wysiwyg.element,n);return}const i=e.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const s=i.getAttribute("data-node-id"),l=i.parentElement;n.insertNode(document.createElement("wbr"));const o=l.outerHTML,r=[],c=[{action:"insert",id:s,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],u=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if($(e).textContent.trim()===""&&e.nextElementSibling.classList.contains("protyle-attr"))r.push({action:"delete",id:s}),c[0].data=i.outerHTML,ot($(i.previousElementSibling),n),n.collapse(!0),i.remove();else{ot($(i.previousElementSibling),n),n.collapse(!0),z(n),(a=e.querySelector("wbr"))==null||a.remove();return}else{let d=u.previousElementSibling.getAttribute("data-node-id");Array.from(e.parentElement.children).forEach((f,p)=>{if(f.classList.contains("protyle-action")||f.classList.contains("protyle-attr"))return;const b=f.getAttribute("data-node-id");r.push({action:"move",id:b,previousID:d}),c.push({action:"move",id:b,previousID:p===1?void 0:d,parentID:s}),d=b,u.before(f)}),r.push({action:"delete",id:s}),c[0].data=i.outerHTML,i.remove()}l.classList.contains("protyle-wysiwyg")?F(t,r,c):(l.getAttribute("data-subtype")==="o"&&Ne(l),j(t,l.getAttribute("data-node-id"),l.outerHTML,o)),re(u.parentElement,n)},bt=(t,e,n)=>{var a,i,s,l,o,r,c;gt(t);const u=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if((u==null?void 0:u.length)>0){const x=[],k=[];let C=u[0].previousElementSibling||u[u.length-1].nextElementSibling,v,L;if(Y(["select"],t),u.find(D=>{const O=he(D);L=O.parentElement;const P=O.getAttribute("data-node-id");if(x.push({action:"delete",id:P}),C=B(O)||ie(O)||O.parentElement||t.wysiwyg.element.firstElementChild,O.getAttribute("data-type")==="NodeHeading"&&O.getAttribute("fold")==="1"){at(t,O,void 0,!0),k.push({action:"insert",data:O.outerHTML,id:P,previousID:u[0].previousElementSibling?u[0].previousElementSibling.getAttribute("data-node-id"):"",parentID:O.parentElement.getAttribute("data-node-id")||t.block.parentID}),O.firstElementChild.removeAttribute("contenteditable");const Z=O.nextElementSibling;if(Z){const pe=Z.getAttribute("data-type");if(pe!=="NodeHeading"||pe==="NodeHeading"&&Z.getAttribute("data-subtype")>O.getAttribute("data-subtype"))return!0}}else{let Z=O.outerHTML;(O.classList.contains("render-node")||O.querySelector("div.render-node"))&&(Z=t.lute.SpinBlockDOM(O.outerHTML)),k.push({action:"insert",data:Z,id:P,previousID:O.previousElementSibling?O.previousElementSibling.getAttribute("data-node-id"):"",parentID:O.parentElement.getAttribute("data-node-id")||t.block.parentID}),O.getAttribute("data-subtype")==="o"&&O.classList.contains("li")?v=O.parentElement:v=void 0,O.remove()}}),C)if(t.block.showAll&&C.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0)setTimeout(()=>{mt({protyle:t,id:t.block.parent2ID,focusId:t.block.parent2ID})},g.TIMEOUT_INPUT*2+100);else{if(C.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0){const D=Lute.NewNodeID(),O=mn(!1,!0,D);C.insertAdjacentElement("afterbegin",O),x.push({action:"insert",data:O.outerHTML,id:D,parentID:C.getAttribute("data-node-id")||t.block.parentID}),k.push({action:"delete",id:D}),C=void 0,re(O,n)}ce(C),Ie(t,C),v&&(k.push({action:"update",id:v.getAttribute("data-node-id"),data:v.outerHTML}),Ne(v,1),x.push({action:"update",id:v.getAttribute("data-node-id"),data:v.outerHTML}))}if(x.length>0)if(L&&L.getAttribute("data-type")==="NodeSuperBlock"&&L.childElementCount===2){const D=Fn(t,L);F(t,x.concat(D.doOperations),D.undoOperations.concat(k.reverse()))}else F(t,x,k.reverse());Y(["util"],t);return}if(e.getAttribute("data-type")==="NodeCodeBlock"&&$(e).textContent.trim()===""){e.classList.add("protyle-wysiwyg--select"),bt(t,e,n);return}if(e.getAttribute("data-type")==="NodeCodeBlock"||e.getAttribute("data-type")==="NodeTable"){e.previousElementSibling&&ce(e.previousElementSibling,void 0,!1);return}if(e.getAttribute("data-type")==="NodeHeading"){on({protyle:t,selectsElement:[e],type:"Blocks2Ps"});return}if(!e.previousElementSibling&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const x=e.parentElement;x.insertAdjacentElement("beforebegin",e),x.childElementCount===1?(F(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(a=e.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"delete",id:x.getAttribute("data-node-id")}],[{action:"insert",id:x.getAttribute("data-node-id"),data:x.outerHTML,previousID:(i=e.previousElementSibling)==null?void 0:i.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"move",id:e.getAttribute("data-node-id"),parentID:x.getAttribute("data-node-id")}]),x.remove()):F(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:(s=e.previousElementSibling)==null?void 0:s.getAttribute("data-node-id"),parentID:x.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:e.getAttribute("data-node-id"),parentID:x.getAttribute("data-node-id")}]),re(e,n);return}if(e.parentElement.classList.contains("li")&&e.previousElementSibling.classList.contains("protyle-action")){Jc(t,e,n);return}if(e.previousElementSibling&&e.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const d=ie(e);if(!d){if(t.wysiwyg.element.childElementCount>1&&$(e).textContent===""){ce(t.wysiwyg.element.firstElementChild.nextElementSibling);const x=he(e);F(t,[{action:"delete",id:x.getAttribute("data-node-id")}],[{action:"insert",data:x.outerHTML,id:x.getAttribute("data-node-id"),parentID:t.block.parentID}]),x.remove()}return}const f=e.parentElement,p=$(e),b=G(d);if(n.toString()===""&&H()&&b&&b.classList.contains("hr")&&Qe(p).start===0){F(t,[{action:"delete",id:b.getAttribute("data-node-id")}],[{action:"insert",data:b.outerHTML,id:b.getAttribute("data-node-id"),previousID:(l=b.previousElementSibling)==null?void 0:l.getAttribute("data-node-id"),parentID:b.parentElement.getAttribute("data-node-id")}]),b.remove();return}const m=b&&(b.classList.contains("table")||b.classList.contains("render-node")||b.classList.contains("iframe")||b.classList.contains("hr")||b.classList.contains("code-block")),h=b.getAttribute("data-node-id");if(m){if(b.classList.contains("code-block")){if(p.textContent.trim()===""){const x=e.getAttribute("data-node-id"),k=[{action:"delete",id:x}],C=[{action:"insert",data:e.outerHTML,id:x,previousID:(o=e.previousElementSibling)==null?void 0:o.getAttribute("data-node-id"),parentID:e.parentElement.getAttribute("data-node-id")}];if(e.remove(),f.getAttribute("data-type")==="NodeSuperBlock"&&f.childElementCount===2){const v=Fn(t,f);F(t,k.concat(v.doOperations),v.undoOperations.concat(C))}else F(t,k,C);ce(t.wysiwyg.element.querySelector(`[data-node-id="${h}"]`),void 0,!1)}else ce(b,void 0,!1);return}if(p.textContent!==""){ce(b,void 0,!1);return}}const w=Me(e),y=w.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const E=[{action:"update",data:b.outerHTML,id:h},{action:"insert",data:w.outerHTML,id:y,previousID:(r=e.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:f.getAttribute("data-node-id")}],S=[{action:"delete",id:y}];if(m)w.remove(),ce(b,void 0,!1);else{const x=$(b);if(p&&p.textContent!==""&&(n.setEndAfter(p.lastChild),(((c=x==null?void 0:x.lastElementChild)==null?void 0:c.getAttribute("data-type"))||"").indexOf("inline-math")>-1)){const v=Ee(x==null?void 0:x.lastElementChild);v&&v.textContent===`
`&&v.remove()}const k=t.contentElement.scrollTop,C=n.extractContents();n.selectNodeContents(x),n.collapse(!1),n.insertNode(C),w.remove(),t.contentElement.scrollTop=k,t.scroll.lastScrollTop=k-1,S.push({action:"update",data:b.outerHTML,id:h})}if(f.getAttribute("data-type")==="NodeSuperBlock"&&f.childElementCount===2){const x=Fn(t,f);F(t,S.concat(x.doOperations),x.undoOperations.concat(E))}else F(t,S,E);re(t.wysiwyg.element,n)},ed=(t,e,n)=>{var a,i;const s=e.parentElement,l=$(e);if(["",`
`].includes(l.textContent)&&e.previousElementSibling.classList.contains("protyle-action")&&!e.querySelector("img")){if((a=s.nextElementSibling)!=null&&a.classList.contains("protyle-attr"))return ga(t,[e.parentElement],n),!0;if(!s.parentElement.classList.contains("protyle-wysiwyg"))return xr(t,e,n),!0}const o=Qe(l,t.wysiwyg.element,n);if(n.toString()===""&&o.start===0&&!xe(n.startContainer)){if(s.parentElement.classList.contains("protyle-wysiwyg"))return!0;const p=document.createElement("wbr");n.insertNode(p);const b=s.parentElement.outerHTML;p.remove();let m=An(s,-1,!0);if(e.previousElementSibling.classList.contains("protyle-action"))$(e).textContent===""?s.insertAdjacentElement("afterend",m):s.insertAdjacentElement("beforebegin",m);else{if($(e).textContent!=="")return!1;e.remove(),m=An(s,-1,!0),s.insertAdjacentElement("afterend",m)}return s.getAttribute("data-subtype")==="o"&&Ne(s.parentElement),j(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,b),re(m,n),Ie(t),na(m),!0}const r=s.querySelector(".list");let c;if(r&&s.getAttribute("fold")!=="1"&&e.nextElementSibling.isSameNode(r)){if(o.end>=l.textContent.length-(l.textContent.endsWith(g.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const p=r.outerHTML;e.querySelector("wbr").remove(),c=An(r.firstElementChild,-1,!0),r.firstElementChild.before(c),r.getAttribute("data-subtype")==="o"&&Ne(r),j(t,r.getAttribute("data-node-id"),r.outerHTML,p),re(s,n),Ie(t)}else{n.insertNode(document.createElement("wbr"));const p=s.outerHTML,b=s.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(l.lastChild),c=An(s,0,!1);const m=$(c);m.appendChild(n.extractContents()),m.parentElement.after(r),s.insertAdjacentElement("afterend",c),s.getAttribute("data-subtype")==="o"&&Ne(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?F(t,[{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",data:p,id:s.getAttribute("data-node-id")}]):j(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,b),re(c,n),Ie(t)}return na(c),!0}(n.toString()===""||n.toString()===g.ZWSP)&&n.startContainer.nodeType===3&&n.startContainer.textContent===g.ZWSP&&n.startOffset===0&&(n.setStart(n.startContainer,1),n.collapse(!1)),n.insertNode(document.createElement("wbr"));const u=s.outerHTML,d=s.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(l.lastChild),c=An(s,0,!1);const f=n.extractContents();return f.firstChild.nodeType!==3&&f.firstChild.textContent===""&&(f.firstChild.after(document.createElement("wbr")),f.firstChild.remove()),(((i=l==null?void 0:l.lastElementChild)==null?void 0:i.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!Ee(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",`
`),$(c).appendChild(f),s.insertAdjacentElement("afterend",c),s.getAttribute("data-subtype")==="o"&&Ne(s.parentElement),s.parentElement.classList.contains("protyle-wysiwyg")?F(t,[{action:"update",id:s.getAttribute("data-node-id"),data:s.outerHTML},{action:"insert",id:c.getAttribute("data-node-id"),data:c.outerHTML,previousID:s.getAttribute("data-node-id")}],[{action:"delete",id:c.getAttribute("data-node-id")},{action:"update",id:s.getAttribute("data-node-id"),data:u}]):j(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,d),re(c,n),Ie(t),na(c),!0},td=(t,e,n)=>{var a,i;const s=q(t);if(!s&&t.classList.contains("protyle-wysiwyg--select")){ot($(t),e,!1),e.collapse(!1),Y(["select"],n);return}if(s){if(t.parentElement.classList.contains("li")){const b=t.parentElement.parentElement.outerHTML,m=An(t.parentElement,0,!0);t.parentElement.insertAdjacentElement("afterend",m),j(n,t.parentElement.parentElement.getAttribute("data-node-id"),t.parentElement.parentElement.outerHTML,b),re(m,e),na(m),Ie(n);return}if(t.classList.contains("hr")){vt(n,"afterend");return}t.classList.contains("protyle-wysiwyg--select")&&t.classList.contains("render-node")?n.toolbar.showRender(n,t):vt(n,"afterend");return}const l=$(t);l.querySelectorAll(".img--select").forEach(b=>{b.classList.remove("img--select")});const o=l.innerHTML.trimStart();if((o.startsWith("```")||o.startsWith("\xB7\xB7\xB7")||o.startsWith("~~~")||o.indexOf("\n```")>-1||o.indexOf(`
~~~`)>-1||o.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(o.indexOf(`
`)===-1&&o.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(t.classList.contains("p")){const b=t.outerHTML;let m=l.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");m.endsWith("\n```")||(m+="<wbr>\n```"),l.innerHTML=m,t.outerHTML=n.lute.SpinBlockDOM(t.outerHTML),t=n.wysiwyg.element.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);const h=t.querySelector(".protyle-action__language");return h?(window.siyuan.storage[g.LOCAL_CODELANG]&&h.textContent===""?h.textContent=window.siyuan.storage[g.LOCAL_CODELANG]:(window.siyuan.storage[g.LOCAL_CODELANG]=h.textContent,et(g.LOCAL_CODELANG,window.siyuan.storage[g.LOCAL_CODELANG])),Ae(t)):n.toolbar.showRender(n,t),j(n,t.getAttribute("data-node-id"),t.outerHTML,b),!0}}if(t.getAttribute("data-type")==="NodeCodeBlock"){const b=document.createElement("wbr");e.insertNode(b);const m=t.outerHTML;return b.remove(),e.extractContents(),l.textContent.endsWith(`
`)||l.insertAdjacentText("beforeend",`
`),e.insertNode(document.createTextNode(`
`)),e.collapse(!1),e.insertNode(b),l.removeAttribute("data-render"),Ae(t),j(n,t.getAttribute("data-node-id"),t.outerHTML,m),!0}if(l.textContent.replace(g.ZWSP,"").replace(`
`,"")===""&&t.nextElementSibling&&t.nextElementSibling.classList.contains("protyle-attr")&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){e.insertNode(document.createElement("wbr"));const b=Me(t),m=t.getAttribute("data-node-id"),h=b.getAttribute("data-node-id"),w={action:"insert",id:m,data:t.outerHTML},y={action:"insert",id:h,data:b.outerHTML};return h===m?(w.previousID=t.parentElement.getAttribute("data-node-id"),y.previousID=t.previousElementSibling.getAttribute("data-node-id"),t.parentElement.after(t)):(w.previousID=b.previousElementSibling?b.previousElementSibling.getAttribute("data-node-id"):void 0,w.parentID=b.parentElement.getAttribute("data-node-id")||n.block.parentID,y.previousID=w.previousID,y.parentID=w.parentID,b.after(t),b.remove()),F(n,[{action:"delete",id:h},w],[{action:"delete",id:m},y]),re(t,e),!0}const r=Qe(l,n.wysiwyg.element,e);if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&(t.nextElementSibling.classList.contains("protyle-attr")||t.nextElementSibling.classList.contains("list")&&((a=t.previousElementSibling)!=null&&a.classList.contains("protyle-action"))||r.start===0&&t.previousElementSibling.classList.contains("protyle-action")||t.parentElement.getAttribute("fold")==="1")&&ed(n,t,e))return!0;if(l.textContent!==""&&e.toString()===""&&r.start===0){const b=mn(!1,!0),m=b.getAttribute("data-node-id");return F(n,[{action:"insert",data:b.outerHTML,id:m,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):"",parentID:t.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:m}]),b.querySelector("wbr").remove(),t.insertAdjacentElement("beforebegin",b),na(b),!0}e.toString()===""&&e.startContainer.nodeType===3&&e.startContainer.textContent===g.ZWSP&&e.startOffset===0&&e.setStart(e.startContainer,1),e.insertNode(document.createElement("wbr"));const c=t.outerHTML;e.toString()!==""&&(e.extractContents(),e.insertNode(document.createElement("wbr"))),l.lastChild&&e.setEndAfter(l.lastChild);const u=mn(!1,!1),d=e.extractContents();d.firstChild&&d.firstChild.nodeType!==3&&d.firstChild.textContent===""&&(d.firstChild.after(document.createElement("wbr")),d.firstChild.remove()),(((i=l==null?void 0:l.lastElementChild)==null?void 0:i.getAttribute("data-type"))||"").indexOf("inline-math")>-1&&!Ee(l==null?void 0:l.lastElementChild)&&l.insertAdjacentText("beforeend",`
`),$(u).appendChild(d);const f=t.getAttribute("data-node-id"),p=u.getAttribute("data-node-id");return t.insertAdjacentElement("afterend",u),F(n,[{action:"update",data:t.outerHTML,id:f},{action:"insert",data:u.outerHTML,id:p,previousID:f}],[{action:"delete",id:p},{action:"update",data:c,id:f}]),t.insertAdjacentElement("afterend",u),re(u,e),Ie(n),na(u),!0},na=t=>{const e=$(t).childNodes;for(let n=0;n<e.length;n++)e[n].nodeType===3&&e[n].textContent.length===0&&(e[n].remove(),n--)},nd=(t,e,n)=>{if(!e.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(t.isComposing)return!0;if(J("\u2318B",t)||J("\u2318I",t)||J("\u2318U",t))return t.preventDefault(),!0;const a=e.querySelector(".av__cell--select");if(a){if(t.key==="Escape")return a.classList.remove("av__cell--select"),Wt(a.parentElement.querySelector(".av__firstcol"),"select"),t.preventDefault(),!0;if(t.key==="Enter")return yn(n,[a]),t.preventDefault(),!0;let s;if(t.key==="ArrowLeft"){const l=a.parentElement.previousElementSibling;return a.previousElementSibling&&a.previousElementSibling.classList.contains("av__cell")?s=a.previousElementSibling:l&&!l.classList.contains("av__row--header")&&(s=l.lastElementChild.previousElementSibling),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),$n(e,s.getBoundingClientRect())),t.preventDefault(),!0}if(t.key==="ArrowRight"){const l=a.parentElement.nextElementSibling;return a.nextElementSibling&&a.nextElementSibling.classList.contains("av__cell")?s=a.nextElementSibling:l&&!l.classList.contains("av__row--footer")&&(s=l.querySelector(".av__cell")),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),$n(e,s.getBoundingClientRect())),t.preventDefault(),!0}if(t.key==="ArrowUp"){const l=a.parentElement.previousElementSibling;return l&&!l.classList.contains("av__row--header")&&(s=l.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),$n(e,s.getBoundingClientRect())),t.preventDefault(),!0}if(t.key==="ArrowDown"){const l=a.parentElement.nextElementSibling;return l&&!l.classList.contains("av__row--footer")&&(s=l.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),s&&(a.classList.remove("av__cell--select"),s.classList.add("av__cell--select"),$n(e,s.getBoundingClientRect())),t.preventDefault(),!0}}const i=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(i.length>0){if(J("\u2318/",t))return t.stopPropagation(),t.preventDefault(),Ai(n,i[0],{x:e.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:i[0].getBoundingClientRect().bottom}),!0;if(t.key==="Escape")return t.preventDefault(),Wt(i[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(t.key==="Enter")return Wt(i[0].querySelector(".av__firstcol"),"unselectAll"),yn(n,[i[0].querySelector(".av__cell")]),t.preventDefault(),!0;if(t.key==="ArrowUp"){const s=i[0].previousElementSibling;return Wt(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--header")?(Wt(s.querySelector(".av__firstcol"),"select"),$n(e,s.getBoundingClientRect(),!0)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}if(t.key==="ArrowDown"){const s=i[i.length-1].nextElementSibling;return Wt(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--add")?(Wt(s.querySelector(".av__firstcol"),"select"),$n(e,s.getBoundingClientRect(),!0)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}}return!1},as=(t,e)=>{let n="";Array.from(t.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),_("/api/block/getDOMText",{dom:n},a=>{e(a.data)})},ad=(t,e)=>{e.addEventListener("keydown",n=>{var a,i,s,l,o,r,c,u;if(n.target.localName==="protyle-html"){n.stopPropagation();return}if(t.disabled||!t.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}t.wysiwyg.preventKeyup=!1,Y(["util"],t),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&Y(["toolbar"],t);let d=de(t.wysiwyg.element);const f=I(d.startContainer);if(!f)return;const p=I(d.endContainer);if(!J("\u2318C",n)&&p&&!f.isSameNode(p)){n.stopPropagation(),n.preventDefault();return}if(nd(n,f,t))return;if(f.classList.contains("protyle-wysiwyg--select")&&!Ce(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{vt(t,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{vt(t,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(!Ce(n)&&!n.shiftKey&&!n.altKey&&(n.code==="Slash"?t.hint.enableSlash=!0:n.code==="Backslash"&&(t.hint.enableSlash=!1,Y(["hint"],t))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!q(f)&&!/^F\d{1,2}$/.test(n.key)&&typeof t.wysiwyg.lastHTMLs[f.getAttribute("data-node-id")]=="undefined"){const m=d.cloneRange();d.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[f.getAttribute("data-node-id")]=f.outerHTML,f.querySelector("wbr").remove(),d=m}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(n.code.startsWith("Arrow")||n.code==="Enter")&&!n.altKey&&!n.shiftKey&&!Ce(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&t.options.render.breadcrumb&&t.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&!Ce(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>0){if(n.preventDefault(),n.stopPropagation(),Y(["select"],t),n.key==="ArrowDown"){const h=m[m.length-1];let w=B(h);if(w)if(w.getBoundingClientRect().width===0){const E=Ht(w,"fold","1");E?(w=B(E),w?w=V(w):w=h):w=h}else w.getAttribute("fold")==="1"&&(w.classList.contains("sb")||w.classList.contains("bq"))||(w=V(w));else w=h;w.classList.add("protyle-wysiwyg--select"),Fe([w.getAttribute("data-node-id")]);const y=w.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;y>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+y,t.scroll.lastScrollTop=t.contentElement.scrollTop-1),ce(w)}else if(n.key==="ArrowUp"){let h=ie(m[0]);if(h){if(h=G(h),h.getBoundingClientRect().width===0){const w=Ht(h,"fold","1");w?h=V(w):h=m[0]}else if(h){const w=Ht(h,"fold","1");w&&(w.classList.contains("sb")||w.classList.contains("bq"))&&(h=w)}}else t.title&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)?t.title.editElement.focus():t.contentElement.scrollTop!==0?(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8):h=m[0];if(h){h.classList.add("protyle-wysiwyg--select"),Fe([h.getAttribute("data-node-id")]);const w=h.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;w<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+w,t.scroll.lastScrollTop=t.contentElement.scrollTop+1),ce(h)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&!Ce(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),Y(["select"],t),!1;if(J(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return m.length>0?at(t,m[0]):f.parentElement.getAttribute("data-type")==="NodeListItem"?f.parentElement.childElementCount>3?at(t,f.parentElement):at(t,f):f.getAttribute("data-type")==="NodeHeading"?at(t,f):at(t,he(f)),n.stopPropagation(),n.preventDefault(),!1}if(J(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");m.length>0?at(t,m[0],!0):f.parentElement.getAttribute("data-type")==="NodeListItem"?f.parentElement.childElementCount>3?at(t,f.parentElement,!0):at(t,f,!0):f.getAttribute("data-type")==="NodeHeading"?at(t,f,!0):at(t,he(f),!0),n.stopPropagation(),n.preventDefault();return}if((J("\u21E7\u2190",n)||J("\u21E7\u2192",n))&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if(J(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){xl({protyle:t,event:n,nodeElement:f,editorElement:e,range:d,cb(m){const h=m[0].previousElementSibling;if(h&&h.getAttribute("data-node-id")){h.classList.add("protyle-wysiwyg--select"),m.forEach(y=>{y.removeAttribute("select-end")}),h.setAttribute("select-end","true");const w=h.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;w<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+w,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else m[0].parentElement.classList.contains("protyle-wysiwyg")||(Y(["select"],t),m[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(J(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){Sl({protyle:t,event:n,nodeElement:f,editorElement:e,range:d,cb(m){const h=m[m.length-1],w=h.nextElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),m.forEach(E=>{E.removeAttribute("select-end")}),w.setAttribute("select-end","true");const y=w.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;y>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+y,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else h.parentElement.classList.contains("protyle-wysiwyg")||(Y(["select"],t),h.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if(J("\u21E7\u2191",n)){xl({protyle:t,event:n,nodeElement:f,editorElement:e,range:d,cb(m){const h=Al(m);if(h.startElement.getBoundingClientRect().top>=h.endElement.getBoundingClientRect().top){const w=h.endElement.previousElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),w.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end");const y=w.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;y<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+y,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else h.endElement.parentElement.classList.contains("protyle-wysiwyg")||(Y(["select"],t),h.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{h.endElement.classList.remove("protyle-wysiwyg--select"),h.endElement.removeAttribute("select-end");const w=ie(h.endElement);w&&(w.setAttribute("select-end","true"),w.getBoundingClientRect().top<=t.contentElement.getBoundingClientRect().top&&(gt(t),w.scrollIntoView(!0)))}}});return}if(J("\u21E7\u2193",n)){Sl({protyle:t,event:n,nodeElement:f,editorElement:e,range:d,cb(m){const h=Al(m);if(h.startElement.getBoundingClientRect().top<=h.endElement.getBoundingClientRect().top){const w=h.endElement.nextElementSibling;if(w&&w.getAttribute("data-node-id")){w.classList.add("protyle-wysiwyg--select"),w.setAttribute("select-end","true"),h.endElement.removeAttribute("select-end");const y=w.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;y>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+y,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else h.endElement.parentElement.classList.contains("protyle-wysiwyg")||(Y(["select"],t),h.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{h.endElement.classList.remove("protyle-wysiwyg--select"),h.endElement.removeAttribute("select-end");const w=B(h.endElement);w&&(w.setAttribute("select-end","true"),w.getBoundingClientRect().bottom>=t.contentElement.getBoundingClientRect().bottom&&(gt(t),w.scrollIntoView(!1)))}}});return}if(J(window.siyuan.config.keymap.general.enter.custom,n)){let m=he(f);m.parentElement.classList.contains("li")&&m.parentElement.parentElement.classList.contains("list")&&((a=m.nextElementSibling)!=null&&a.classList.contains("list"))&&m.previousElementSibling.classList.contains("protyle-action")&&(m=m.parentElement),mt({protyle:t,id:m.getAttribute("data-node-id")}),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.general.enterBack.custom,n)){Fi(t,f.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&!Ce(n)&&(n.key==="Home"||n.key==="End")&&Ya()||n.shiftKey&&!n.altKey&&Ce(n)&&(n.key==="Home"||n.key==="End")&&!Ya()){const m=Ht(f,"data-node-id",null);if(m){m.querySelectorAll(".protyle-wysiwyg--select").forEach(w=>{w.classList.remove("protyle-wysiwyg--select")}),m.classList.add("protyle-wysiwyg--select");let h=n.key==="Home"?m.previousElementSibling:m.nextElementSibling;for(;h;)h.classList.add("protyle-wysiwyg--select"),h=n.key==="Home"?h.previousElementSibling:h.nextElementSibling;n.key==="Home"?t.wysiwyg.element.firstElementChild.scrollIntoView():t.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&Ce(n)&&n.key==="Home"){Cl(t),Y(["select"],t),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&Ce(n)&&n.key==="End"){Tl(t),Y(["select"],t),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&!Ce(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(t.contentElement.scrollTop=t.contentElement.scrollTop-t.contentElement.clientHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop+1):(t.contentElement.scrollTop=t.contentElement.scrollTop+t.contentElement.clientHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop-1);const m=t.contentElement.getBoundingClientRect();let h=document.elementFromPoint(m.x+m.width/2,m.y+m.height/2);h.classList.contains("protyle-wysiwyg")&&(h=document.elementFromPoint(m.x+m.width/2,m.y+m.height/2+g.SIZE_TOOLBAR_HEIGHT));const w=I(h);w&&!w.isSameNode(f)&&ce(w,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&!Ce(n)||n.key==="Enter")&&!t.hint.element.classList.contains("fn__none")&&t.hint.select(n,t)){n.stopPropagation(),n.preventDefault();return}if(J("\u2318/",n)){n.stopPropagation(),n.preventDefault();const m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length===0){const w=A(d.startContainer,"data-type",null);if(w&&w.tagName==="SPAN"){const y=w.getAttribute("data-type").split(" ");if(y.length>0&&(t.toolbar.range=d,Ll(w)),y.includes("block-ref")){Ri(t,w);return}else if(y.includes("inline-memo")){t.toolbar.showRender(t,w);return}else if(y.includes("file-annotation-ref")){Oi(t,w);return}else if(y.includes("a")){ya(t,w);return}else if(y.includes("tag")){Wi(t,w);return}}if(d.startOffset===0&&d.startContainer.nodeType===3){const y=xe(d.startContainer);if(y&&y.nodeType!==3&&((i=y.getAttribute("data-type"))==null?void 0:i.indexOf("inline-math"))>-1){t.toolbar.showRender(t,y);return}else if(!y&&d.startContainer.parentElement.previousSibling&&d.startContainer.parentElement.previousSibling.isSameNode(d.startContainer.parentElement.previousElementSibling)&&((s=d.startContainer.parentElement.previousElementSibling.getAttribute("data-type"))==null?void 0:s.indexOf("inline-math"))>-1){t.toolbar.showRender(t,d.startContainer.parentElement.previousElementSibling);return}}m.push(f)}m.length===1?t.gutter.renderMenu(t,m[0]):t.gutter.renderMultipleMenu(t,m);const h=f.getBoundingClientRect();window.siyuan.menus.menu.popup({x:h.left,y:h.top,isLeft:!0});return}if(Sr(t,n,d)){n.preventDefault();return}const b=d.toString();if(!n.altKey&&!n.shiftKey&&!Ce(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const m=$(f)||f,h=Qe(m,t.wysiwyg.element,d),w=R(d.startContainer,"TD");if(n.key==="ArrowDown"&&(m==null?void 0:m.textContent.trimRight().substr(h.start).indexOf(`
`))===-1&&(w&&!w.parentElement.nextElementSibling&&f.getAttribute("data-type")==="NodeTable"&&!B(f)||f.getAttribute("data-type")==="NodeCodeBlock"&&!B(f)||f.parentElement.getAttribute("data-type")==="NodeBlockquote"&&f.nextElementSibling.classList.contains("protyle-attr")&&!B(f.parentElement)))f.parentElement.getAttribute("data-type")==="NodeBlockquote"?vt(t,"afterend",f.parentElement.getAttribute("data-node-id")):vt(t,"afterend",f.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const y=$(t.wysiwyg.element.firstElementChild);if(!ie(f)&&f.contains(y)||!y&&f.isSameNode(t.wysiwyg.element.firstElementChild))(Rt(f,d).top-t.wysiwyg.element.getBoundingClientRect().top<40||f.classList.contains("av"))&&(t.title&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)?t.title.editElement.focus():(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8));else if((m==null?void 0:m.textContent.substr(0,h.end).indexOf(`
`))===-1){let E=ie(f);if(E&&(E=G(E),E)){const S=A(E,"fold","1");(l=$(E))!=null&&l.textContent.endsWith(`
`)&&!S?(ce(E,void 0,!1),Ie(t,E),n.stopPropagation(),n.preventDefault()):S&&S.getAttribute("data-type")!=="NodeListItem"&&(S.scrollTop=0,ce(S,void 0,!0),Ie(t,S),n.stopPropagation(),n.preventDefault())}}}else if(b===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&f.isSameNode(G(t.wysiwyg.element.lastElementChild))&&!R(d.startContainer,"TD")&&!R(d.startContainer,"TH")){const y=$(f);y&&y.textContent.replace(/\n$/,"").length<=Qe(y,void 0,d).end&&(n.stopPropagation(),n.preventDefault(),z(d))}else if(b===""&&n.key==="ArrowLeft"&&f.isSameNode(V(t.wysiwyg.element.firstElementChild))){const y=$(f);y&&Qe(y,void 0,d).start===0&&(n.stopPropagation(),n.preventDefault(),z(d))}if(n.key==="ArrowDown"){const y=A(d.startContainer,"fold","1");if(y){let E=B(y);E&&(E.getAttribute("fold")==="1"&&(E.classList.contains("sb")||E.classList.contains("bq"))||(E=V(E)),ce(E),Ie(t,E)),n.stopPropagation(),n.preventDefault()}else if((m==null?void 0:m.textContent.substr(h.end+1).indexOf(`
`))===-1){const E=B(f);E&&E.getAttribute("fold")==="1"&&(ce(E),Ie(t,E),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")){if(t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){bt(t,f,d),n.stopPropagation(),n.preventDefault();return}if(b===""&&n.key==="Backspace"&&d.startOffset===d.startContainer.textContent.length&&d.startContainer.textContent.endsWith(`
`+g.ZWSP)){d.setStart(d.startContainer,d.startOffset-1),d.collapse(!0),n.stopPropagation(),n.preventDefault();return}const m=xe(d.startContainer);if(d.startOffset===1&&d.startContainer.textContent===g.ZWSP&&m&&m.nodeType!==3&&n.key==="Backspace"){if(m.classList.contains("img"))m.classList.add("img--select");else if(((o=m.getAttribute("data-type"))==null?void 0:o.indexOf("inline-math"))>-1){m.after(document.createElement("wbr"));const w=f.outerHTML;d.startContainer.textContent="",m.remove(),j(t,f.getAttribute("data-node-id"),f.outerHTML,w),re(f,d),n.stopPropagation(),n.preventDefault();return}}if(d.startOffset===0&&b===""&&m&&((r=m.parentElement.getAttribute("data-type"))==null?void 0:r.indexOf("backslash"))>-1&&m.nodeType!==3&&m.outerHTML==="<span>\\</span>"&&!xe(m.parentElement)){d.setStartBefore(m.parentElement),bt(t,f,d),n.stopPropagation(),n.preventDefault();return}if(d.startOffset===1&&d.startContainer.nodeType!==3&&((c=d.startContainer.parentElement.getAttribute("data-type"))==null?void 0:c.indexOf("backslash"))>-1&&!xe(d.startContainer.parentElement)){d.setStartBefore(d.startContainer.parentElement),bt(t,f,d),n.stopPropagation(),n.preventDefault();return}const h=t.wysiwyg.element.querySelector(".img--select");if(h){if(h.classList.remove("img--select"),f.contains(h)){h.insertAdjacentHTML("afterend","<wbr>");const w=f.outerHTML;h.remove(),j(t,f.getAttribute("data-node-id"),f.outerHTML,w),re(f,d),n.stopPropagation(),n.preventDefault();return}}else if(b===""){const w=$(f);if(!w){f.classList.add("protyle-wysiwyg--select"),bt(t,f,d),n.stopPropagation(),n.preventDefault();return}const y=Qe(w,t.wysiwyg.element,d);if(n.key==="Delete"){if(y.end===w.textContent.length){const E=B(he(f));if(E){const S=ce(E);if(S){const x=I(S.startContainer);x&&bt(t,x,S)}n.stopPropagation(),n.preventDefault();return}}else if(y.end===w.textContent.length-1&&f.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}}else{const E=d.startContainer.childNodes[d.startOffset-1];if(y.start===0&&(d.startOffset===0||E&&E.nodeType===3&&!xe(E)&&E.textContent==="")){bt(t,f,d),n.stopPropagation(),n.preventDefault();return}if(d.startContainer.nodeType!==3&&f.getAttribute("data-type")==="NodeTable"&&((u=d.startContainer.children[d.startOffset-1])==null?void 0:u.tagName)==="TABLE"){f.classList.add("protyle-wysiwyg--select"),bt(t,f,d),n.stopPropagation(),n.preventDefault();return}if(E&&E.nodeType!==3&&E.classList.contains("img")){d.insertNode(document.createElement("wbr"));const S=f.outerHTML;E.remove(),j(t,f.getAttribute("data-node-id"),f.outerHTML,S),re(f,d),n.stopPropagation(),n.preventDefault();return}if(f.classList.contains("code-block")&&Ce(n)&&d.startContainer.nodeType===3&&d.startContainer.textContent.substring(d.startOffset-1,d.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}}}else if(f.classList.contains("code-block")&&$(f).textContent===`
`){d.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if(J("\u21E7\u21A9",n)&&b===""){let m=d.startContainer;const h=Ee(m);if(h&&h.nodeType!==3&&h.classList.contains("img")){h.insertAdjacentHTML("beforebegin","<wbr>");const w=f.outerHTML;h.previousElementSibling.remove();const y=document.createTextNode(`
`);m.after(document.createTextNode(g.ZWSP)),m.after(y),d.selectNode(y),d.collapse(!1),j(t,f.getAttribute("data-node-id"),f.outerHTML,w),n.stopPropagation(),n.preventDefault();return}if(m.nodeType===3&&(m=m.parentElement),m&&t.toolbar.getCurrentType(d).length>0&&Qe(m,m,d).end===m.textContent.length){m.insertAdjacentHTML("afterend","<wbr>");const w=f.outerHTML;m.nextElementSibling.remove(),Ee(m)||m.after(document.createTextNode(`
`));const y=document.createTextNode(`
`);m.after(y),d.selectNode(y),d.collapse(!1),j(t,f.getAttribute("data-node-id"),f.outerHTML,w),n.stopPropagation(),n.preventDefault();return}if(window.siyuan.config.system.container==="ios"){m=d.startContainer;const w=Ee(m);if(w&&w.textContent.trim()!==""){document.execCommand("insertHTML",!1,`
`),n.stopPropagation(),n.preventDefault();return}w||m.after(document.createTextNode(`
`));const y=document.createTextNode(`
`);m.after(y);const E=Ee(y);E&&E.textContent===`
`?d.setStart(E,0):d.setStart(y,0),d.collapse(!1),z(d),n.stopPropagation(),n.preventDefault();return}}if(!n.altKey&&!n.shiftKey&&!Ce(n)&&n.key==="Enter"){n.stopPropagation(),n.preventDefault(),td(f,d,t);return}if(J("\u2318A",n))return n.preventDefault(),Ba(t,f,d),!0;if(J(window.siyuan.config.keymap.editor.general.undo.custom,n)){t.undo.undo(t),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.redo.custom,n)){t.undo.redo(t),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.copyProtocol.custom,n)){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;return m.length===1?h=m[0]:h=f,Pe(`siyuan://blocks/${h.getAttribute("data-node-id")}`),n.preventDefault(),n.stopPropagation(),!0}if(J(window.siyuan.config.keymap.editor.general.copyID.custom,n))return Pe(f.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.general.copyText.custom,n))return b!==""?as(d,m=>{Pe(`${Lute.EscapeHTMLStr(m.trim())} ((${f.getAttribute("data-node-id")} "*"))`)}):(f.setAttribute("data-reftext","true"),z(de(f)),document.execCommand("copy")),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,n)){n.preventDefault(),n.stopPropagation();const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;if(m.length===1)h=m[0];else{const y=f.querySelector(".img--select");if(y)return Qs(y.querySelector("img")),!0;h=f}const w=h.getAttribute("data-node-id");return b!==""?as(d,y=>{Pe(`((${w} "${Lute.EscapeHTMLStr(y.trim())}"))`)}):_("/api/block/getRefText",{id:w},y=>{Pe(`((${w} '${y.data}'))`)}),!0}if(J(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,n)){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let h;return m.length===1?h=m[0]:h=f,Pe(`{{select * from blocks where id='${h.getAttribute("data-node-id")}'}}`),n.preventDefault(),n.stopPropagation(),!0}if(J(window.siyuan.config.keymap.editor.general.attr.custom,n)){const m=he(f);if(b===""){const h=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let w;h.length===1?w=h[0]:w=m,ln(w,"bookmark",t)}else as(d,h=>{const w=m.outerHTML,y=Lute.EscapeHTMLStr(h.trim()),E=m.lastElementChild.querySelector(".protyle-attr--name");E?E.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${y}`:m.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${y}</div>`),m.setAttribute("name",y),j(t,m.getAttribute("data-node-id"),m.outerHTML,w)});return n.preventDefault(),n.stopPropagation(),!0}if(J(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!t.disabled){b===""?_("/api/block/getDocInfo",{id:t.block.rootID},m=>{Ks({notebookId:t.notebookId,path:t.path,name:m.data.ial.title,range:d,type:"file"})}):_("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:Ut(b)}),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.newNameFile.custom,n)){if(!(!b.trim()&&(f.querySelector("tr")||f.querySelector("span")))){!b.trim()&&$(f).textContent&&Ba(t,f,d);const m=Ut(b.trim()?b.trim():t.lute.BlockDOM2Content(f.outerHTML).replace(/\n/g,""))||"Untitled";_("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.path},h=>{_("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:we().join(h.data,m),parentID:t.block.rootID,markdown:""},w=>{Re(`<span data-type="block-ref" data-id="${w.data}" data-subtype="d">${$e(m.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,t),Y(["toolbar"],t)})})}n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!b.trim()&&(f.querySelector("tr")||f.querySelector("span"))||(!b.trim()&&$(f).textContent&&Ba(t,f,d),Zi(t.path,t.notebookId,m=>{const h=Ut(b.trim()?b.trim():t.lute.BlockDOM2Content(f.outerHTML).replace(/\n/g,""))||"Untitled";_("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:we().join(m,h),parentID:t.block.rootID,markdown:""},w=>{Re(`<span data-type="block-ref" data-id="${w.data}" data-subtype="d">${$e(h.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,t),Y(["toolbar"],t)})})),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){Cr(t),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const m=f.querySelectorAll(".img--select");if(m.length>0)Il(t,f,Array.from(m),f.getAttribute("data-node-id"),f.outerHTML);else{let h=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[f]),va(h,t,w=>{w.classList.contains("av")?(w.style.margin="",Ct(w)):w.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if(J(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const m=f.querySelectorAll(".img--select");if(m.length>0)$l(t,f,Array.from(m),f.getAttribute("data-node-id"),f.outerHTML);else{let h=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));h.length===0&&(h=[f]),va(h,t,w=>{w.classList.contains("av")?(w.style.margin="0 auto",Ct(w)):w.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if(J(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));m.length===0&&(m=[f]),va(m,t,h=>{h.classList.contains("av")?(h.style.margin="0 0 0 auto",Ct(h)):h.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){!t.toolbar.element.classList.contains("fn__none")||!t.hint.element.classList.contains("fn__none")||!t.toolbar.subElement.classList.contains("fn__none")?(Y(["toolbar","hint","util"],t),t.hint.enableExtend=!1):f.classList.contains("protyle-wysiwyg--select")?(Y(["select"],t),Fe([],t.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(Y(["select"],t),d.collapse(!1),f.classList.add("protyle-wysiwyg--select"),Fe([f.getAttribute("data-node-id")],t.block.rootID)):window.siyuan.menus.menu.remove(),n.preventDefault();return}if(J(window.siyuan.config.keymap.editor.heading.paragraph.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Ps"}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return on({protyle:t,nodeElement:f,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(f.getAttribute("data-type"))){const m=f.getAttribute("data-node-id"),h=f.outerHTML,w=$(f);w.innerHTML="```"+window.siyuan.storage[g.LOCAL_CODELANG]+`
`+w.textContent+"<wbr>\n```";const y=t.lute.SpinBlockDOM(f.outerHTML);f.outerHTML=y;const E=t.wysiwyg.element.querySelector(`[data-node-id="${m}"]`);return j(t,m,y,h),Ae(E),n.preventDefault(),n.stopPropagation(),!0}if(J(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){t.toolbar.range=d;let m=[];b===""&&t.toolbar.getCurrentType(d).length===0&&(m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),m.length===0&&(m=[f])),kt(t,m),n.stopPropagation(),n.preventDefault();return}if(!f.classList.contains("code-block")&&!n.repeat&&!A(f,"data-type","NodeBlockQueryEmbed")){let m=!1;if(t.options.toolbar.find(h=>{if(!h.hotkey)return!1;if(J(h.hotkey,n))return t.toolbar.range=de(t.wysiwyg.element),["block-ref"].includes(h.name)&&t.toolbar.range.toString()===""||(m=!0,["a","block-ref","inline-math","inline-memo","text"].includes(h.name)?t.toolbar.element.querySelector(`[data-type="${h.name}"]`).dispatchEvent(new CustomEvent("click")):t.toolbar.setInlineMark(t,h.name,"range")),!0}),m)return n.preventDefault(),n.stopPropagation(),t.wysiwyg.preventKeyup=!0,!0}if(J(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>0&&m[0].getAttribute("data-type")==="NodeListItem")return ga(t,Array.from(m),d),n.preventDefault(),n.stopPropagation(),!0;if(f.parentElement.classList.contains("li")&&f.getAttribute("data-type")!=="NodeCodeBlock")return ga(t,[f.parentElement],d),n.preventDefault(),n.stopPropagation(),!0}if(J(window.siyuan.config.keymap.editor.list.indent.custom,n)){const m=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(m.length>0&&m[0].getAttribute("data-type")==="NodeListItem")return vi(t,Array.from(m),d),n.preventDefault(),n.stopPropagation(),!0;if(f.parentElement.classList.contains("li")&&f.getAttribute("data-type")!=="NodeCodeBlock")return vi(t,[f.parentElement],d),n.preventDefault(),n.stopPropagation(),!0}if(J(window.siyuan.config.keymap.editor.insert.check.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill("* [ ] "+Lute.Caret,t),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.insert.table.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,t),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const m=A(d.startContainer,"data-subtype","t");if(!m)return;const h=m.outerHTML;m.classList.contains("protyle-task--done")?(m.querySelector("use").setAttribute("xlink:href","#iconUncheck"),m.classList.remove("protyle-task--done")):(m.querySelector("use").setAttribute("xlink:href","#iconCheck"),m.classList.add("protyle-task--done")),m.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(t,m.getAttribute("data-node-id"),m.outerHTML,h),n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return vt(t,"beforebegin"),n.preventDefault(),!0;if(J(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return vt(t,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return Os(t,f),n.preventDefault(),n.stopPropagation(),!0;if(J(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),hl(t,f,d);return}if(J(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),wl(t,f,d);return}if((J("\u2318X",n)||J("\u2318C",n))&&b===""&&!f.querySelector(".img--select")&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length===0&&f.dataset.type!=="NodeHTMLBlock"&&f.classList.add("protyle-wysiwyg--select"),J(window.siyuan.config.keymap.editor.general.copyPlainText.custom,n)){if(b===""){const m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let h="";m.length===0&&m.push(f),m.forEach(w=>{w.querySelectorAll("[spellcheck]").forEach(y=>{const E=y.cloneNode(!0);E.querySelectorAll('[data-type="backslash"]').forEach(S=>{S.firstElementChild.remove()}),h+=E.textContent+`
`})}),Ua(h.trimEnd())}else{const m=d.cloneContents();m.querySelectorAll('[data-type="backslash"]').forEach(h=>{h.firstElementChild.remove()}),Pe(m.textContent)}n.preventDefault(),n.stopPropagation();return}if(J(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length<2)return;ji({protyle:t,selectsElement:m,type:"BlocksMergeSuperBlock",level:"row"});return}if(J(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(m.length<2)return;ji({protyle:t,selectsElement:m,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&J(window.siyuan.config.keymap.editor.general.duplicate.custom,n)){n.preventDefault(),n.stopPropagation();let m=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));m.length===0&&(m=[f]),qi(m,t);return}if(n.key==="Tab"&&!n.ctrlKey&&!Ce(n)&&!n.altKey){n.preventDefault();const m=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(f.getAttribute("data-type")==="NodeCodeBlock"&&b!==""){const h=document.createElement("wbr");d.startContainer.nodeType!==3&&d.startContainer.classList.contains("protyle-action")&&d.setStart(f.querySelector(".hljs").firstChild,0),d.insertNode(h),d.setStartAfter(h);const w=f.outerHTML;let y="";n.shiftKey?d.extractContents().textContent.split(`
`).forEach(x=>{x.startsWith(m)?y+=x.replace(m,"")+`
`:y+=x+`
`}):d.extractContents().textContent.split(`
`).forEach(x=>{y+=m+x+`
`});const E=document.createElement("span");let S=f.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(S)||(S="plaintext"),E.innerHTML=window.hljs.highlight(y.substr(0,y.length-1),{language:S,ignoreIllegals:!0}).value,d.insertNode(E),j(t,f.getAttribute("data-node-id"),f.outerHTML,w),h.remove();return}if(!n.shiftKey){const h=document.createElement("wbr");d.insertNode(h);const w=f.outerHTML;return d.extractContents(),d.insertNode(document.createTextNode(m)),d.collapse(!1),z(d),h.remove(),j(t,f.getAttribute("data-node-id"),f.outerHTML,w),!0}}if(n.key==="ContextMenu"){const m=Rt(f,d);t.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:f,y:m.top+8,x:m.left}})),n.preventDefault(),n.stopPropagation();return}if(J("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),ho(t);return}!Ce(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&Y(["select"],t)})},id=(t,e,n)=>{const a=H(),i=N(t.target,"protyle-attr--bookmark");if(i)return!a&&(t.ctrlKey||t.metaKey)||(n?sn(n,"bookmark",e):ln(i.parentElement.parentElement,"bookmark",e)),t.stopPropagation(),!0;const s=N(t.target,"protyle-attr--name");if(s)return!a&&(t.ctrlKey||t.metaKey)||(n?sn(n,"name",e):ln(s.parentElement.parentElement,"name",e)),t.stopPropagation(),!0;const l=N(t.target,"protyle-attr--av");if(l)return n?sn(n,"av",e):ln(l.parentElement.parentElement,"av",e),t.stopPropagation(),!0;const o=N(t.target,"protyle-attr--alias");if(o)return!a&&(t.ctrlKey||t.metaKey)||(n?sn(n,"alias",e):ln(o.parentElement.parentElement,"alias",e)),t.stopPropagation(),!0;const r=N(t.target,"protyle-attr--memo");if(r)return!a&&(t.ctrlKey||t.metaKey)||(n?sn(n,"memo",e):ln(r.parentElement.parentElement,"memo",e)),t.stopPropagation(),!0};class sd{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),H()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),!e.options.action.includes(g.CB_GET_HISTORY)&&(this.bindEvent(e),ad(e,this.element),Gc(e,this.element))}renderCustom(e){let n=e[g.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(e);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","scroll","data-realwidth"].includes(s)&&!a.includes(s)&&(this.element.removeAttribute(s),i--)}a.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth"].includes(i)||this.element.setAttribute(i,e[i])})}escapeInline(e,n,a){if(!a.data)return;const i=a.data;e.toolbar.range=n;const s=n.startContainer.parentElement,l=e.toolbar.getCurrentType();let o=i.length;if((i==="<"||i===">")&&(o=4),l.length>0&&n.toString()===""&&n.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(g.ZWSP,"")!==i&&s.textContent.replace(g.ZWSP,"").length>=i.length&&!xe(n.startContainer)&&!xe(s)){const r=s.innerHTML.replace(g.ZWSP,"");s.innerHTML=r.substr(o);const c=document.createTextNode(i);s.before(c),n.selectNodeContents(c),n.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!l.includes("search-mark")&&n.toString()===""&&n.startContainer.nodeType===3&&(l.includes("inline-memo")||l.includes("text")||l.includes("block-ref")||l.includes("file-annotation-ref")||l.includes("a"))&&!Ee(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&s.textContent.length>i.length){const r=Qe(s,e.wysiwyg.element,n),c=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=c.substr(0,c.length-o);const u=document.createTextNode(i);s.after(u),n.selectNodeContents(u),n.collapse(!1)}}}setEmptyOutline(e,n){e.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__row--select").forEach(i=>{i.classList.contains("av__row--select")&&!N(n,"av")?(i.classList.remove("av__row--select"),i.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),Un(i)):i.classList.remove("img--select","av__cell--select")});let a=n;if(!n.getAttribute("data-node-id")){const i=I(n);if(!i)return;a=i}}emojiToMd(e){e.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(e){this.element.addEventListener("copy",n=>{if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const a=de(e.wysiwyg.element),i=I(a.startContainer);if(!i)return;const s=i.querySelector(".img--select");let l=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));l.length===0&&a.toString()===""&&!a.cloneContents().querySelector("img")&&!s&&(i.classList.add("protyle-wysiwyg--select"),Fe([i.getAttribute("data-node-id")]),l=[i]);let o="",r="";if(l.length>0){const c=l[0].getAttribute("data-reftext")==="true";if(l[0].getAttribute("data-type")==="NodeListItem"&&l[0].parentElement.classList.contains("list")&&l[0].parentElement.childElementCount-1===l.length)if(c){const u=l[0].parentElement.cloneNode(!0),d=$(u);d&&d.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),o=u.outerHTML,l[0].removeAttribute("data-reftext")}else o=l[0].parentElement.outerHTML;else l.forEach((u,d)=>{if(c&&d===0){const f=u.cloneNode(!0),p=$(f);p&&p.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),o+=nn(f),l[0].removeAttribute("data-reftext")}else o+=nn(u)})}else{const c=document.createElement("div"),u=e.toolbar.getCurrentType(a);if((u.length>0||a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading")&&(a.startContainer.nodeType===3&&a.startContainer.parentElement.textContent===a.toString()||a.startContainer.nodeType!==3&&a.startContainer.textContent===a.toString()))a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading"?c.append(a.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(a.startContainer.parentElement.tagName)?(c.append(a.cloneContents()),this.emojiToMd(c)):(c.append(a.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(c)),o=c.innerHTML;else if(s)o=s.outerHTML;else if(u.length>0&&a.startContainer.nodeType===3&&a.startContainer.parentElement.tagName==="SPAN"&&a.startContainer.parentElement.isSameNode(a.endContainer.parentElement)){const d=a.startContainer.parentElement.attributes,f=document.createElement("span");for(let p=0;p<d.length;p++)f.setAttribute(d[p].name,d[p].value);f.getAttribute("data-type").indexOf("block-ref")>-1&&f.getAttribute("data-subtype")==="d"&&f.setAttribute("data-subtype","s"),f.textContent=a.toString(),o=f.outerHTML}else{c.append(a.cloneContents()),this.emojiToMd(c);const d=A(a.commonAncestorContainer,"data-type","inline-math");d?o=d.outerHTML:o=c.innerHTML,(A(a.startContainer,"data-type","NodeCodeBlock")||R(a.startContainer,"CODE"))&&(r=c.textContent.replace(g.ZWSP,""))}}e.disabled&&(o=Ar(o)),r=r||e.lute.BlockDOM2StdMd(o).trimEnd(),r=r.replace(/\u00A0/g," "),n.clipboardData.setData("text/plain",r),n.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(o)),n.clipboardData.setData("text/siyuan",o)}),this.element.addEventListener("mousedown",n=>{var a;if(n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=I(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||Y(["select"],e);const i=n.target;if(N(i,"protyle-action")||N(i,"av__gutters")||N(i,"av__cellheader"))return;const s=document,l=e.element.getBoundingClientRect(),o=l.left+parseInt(e.wysiwyg.element.style.paddingLeft)+1,r=o+(e.wysiwyg.element.clientWidth-parseInt(e.wysiwyg.element.style.paddingLeft)-parseInt(e.wysiwyg.element.style.paddingRight))-2,c=l.bottom,u=n.clientY;if(!e.disabled&&i.classList.contains("av__widthdrag")){const y=I(i);if(!y)return;const E=y.getAttribute("data-av-id"),S=i.parentElement,x=S.clientWidth,k=S.getAttribute("data-col-id");let C;s.onmousemove=v=>{C=Math.max(x+(v.clientX-n.clientX),100)+"px",S.parentElement.parentElement.querySelectorAll(".av__row, .av__row--footer").forEach(L=>{L.querySelector(`[data-col-id="${k}"]`).style.width=C})},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,F(e,[{action:"setAttrViewColWidth",id:k,avID:E,data:C}],[{action:"setAttrViewColWidth",id:k,avID:E,data:x+"px"}])},n.stopPropagation(),n.preventDefault();return}if(!e.disabled&&i.classList.contains("protyle-action__drag")){const y=I(i);if(!y)return;let E=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(y.getAttribute("data-type"))?(y.classList.add("iframe--drag"),(y.style.textAlign==="left"||y.style.textAlign==="right")&&(E=!1)):i.parentElement.parentElement.getAttribute("data-type")==="img"&&i.parentElement.parentElement.classList.add("img--drag");const S=y.getAttribute("data-node-id"),x=y.outerHTML,k=n.clientX,C=i.previousElementSibling,v=C.clientWidth,L=C.clientHeight;s.onmousemove=D=>{C.tagName==="IMG"&&(C.parentElement.parentElement.style.width=""),D.clientX>k-v+8&&D.clientX<r&&(C.tagName==="IMG"&&C.parentElement.parentElement.style.display!=="block"||!E?C.style.width=Math.max(17,v+(D.clientX-k))+"px":C.style.width=Math.max(17,v+(D.clientX-k)*2)+"px"),C.tagName!=="IMG"?D.clientY>u-L+8&&D.clientY<c&&(C.style.height=L+(D.clientY-u)+"px"):(C.parentElement.parentElement.style.width=parseInt(C.style.width)+10+"px",C.parentElement.parentElement.style.maxWidth="")},s.onmouseup=()=>{s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,i.classList.contains("protyle-action__drag")&&y&&j(e,S,y.outerHTML,x),y.classList.remove("iframe--drag"),i.parentElement.parentElement.classList.remove("img--drag")};return}let d;if((i.tagName==="TH"||i.tagName==="TD"||((a=i.firstElementChild)==null?void 0:a.tagName)==="TABLE"||i.classList.contains("table__resize")||i.classList.contains("table__select"))&&(d=I(i),d&&(d.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),n.stopPropagation())),!e.disabled&&i.classList.contains("table__resize")){const y=I(i);if(!y)return;const E=y.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),y.firstElementChild.style.webkitUserModify="read-only",y.style.cursor="col-resize",i.removeAttribute("style");const S=y.getAttribute("data-node-id"),x=n.clientX,k=parseInt(i.getAttribute("data-col-index")),C=y.querySelectorAll("table col")[k];C.style.minWidth&&(C.style.width=y.querySelectorAll("table td, table th")[k].offsetWidth+"px",C.style.minWidth=""),y.querySelectorAll("tr").forEach(D=>{D.cells[k].style.width=""});const v=C.clientWidth,L=y.firstElementChild.clientWidth<y.firstElementChild.scrollWidth;s.onmousemove=D=>{y.style.textAlign==="center"&&!L?C.style.width=v+(D.clientX-x)*2+"px":C.style.width=v+(D.clientX-x)+"px"},s.onmouseup=()=>{y.firstElementChild.style.webkitUserModify="",y.style.cursor="",s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,y&&j(e,S,y.outerHTML,E)};return}if(["IMG","VIDEO","AUDIO"].includes(i.tagName))return;let f=n.clientX;n.clientX>r?f=r:n.clientX<o&&(f=o);const p=l.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let b,m,h,w;s.onmousemove=y=>{const E=y.target;if(!e.disabled&&d&&d.contains(E)&&!N(d,"protyle-wysiwyg__embed")){if((E.tagName==="TH"||E.tagName==="TD")&&!E.isSameNode(i)&&(!m||!m.isSameNode(E))){d.firstElementChild.style.webkitUserModify="read-only";let K=i.offsetLeft+i.clientWidth-E.offsetLeft,te=E.offsetLeft;i.offsetLeft===E.offsetLeft?K=Math.max(i.clientWidth,E.clientWidth):i.offsetLeft<E.offsetLeft&&(K=E.offsetLeft+E.clientWidth-i.offsetLeft,te=i.offsetLeft);let ue=i.offsetTop+i.clientHeight-E.offsetTop,ye=E.offsetTop;i.offsetTop===E.offsetTop?ue=Math.max(i.clientHeight,E.clientHeight):i.offsetTop<E.offsetTop&&(ue=E.offsetTop+E.clientHeight-i.offsetTop,ye=i.offsetTop),Array.from(d.querySelectorAll("th, td")).find(ae=>{const Ze=ae.offsetLeft<te+K&&ae.offsetLeft+ae.clientWidth>te+K,ve=ae.offsetLeft<te&&ae.offsetLeft+ae.clientWidth>te;ae.offsetTop<ye&&ae.offsetTop+ae.clientHeight>ye?((ae.offsetLeft+6>te&&ae.offsetLeft+ae.clientWidth-6<te+K||Ze||ve)&&(ue=ye+ue-ae.offsetTop,ye=ae.offsetTop),Ze&&(K=ae.offsetLeft+ae.clientWidth-te),ve&&(K=te+K-ae.offsetLeft,te=ae.offsetLeft)):ae.offsetTop<ye+ue&&ae.offsetTop+ae.clientHeight>ye+ue?((ae.offsetLeft+6>te&&ae.offsetLeft+ae.clientWidth-6<te+K||Ze||ve)&&(ue=ae.clientHeight+ae.offsetTop-ye),Ze&&(K=ae.offsetLeft+ae.clientWidth-te),ve&&(K=te+K-ae.offsetLeft,te=ae.offsetLeft)):ve&&ae.offsetTop+6>ye&&ae.offsetTop+ae.clientHeight-6<ye+ue?(K=te+K-ae.offsetLeft,te=ae.offsetLeft):Ze&&ae.offsetTop+6>ye&&ae.offsetTop+ae.clientHeight-6<ye+ue&&(K=ae.offsetLeft+ae.clientWidth-te)}),d.querySelector(".table__select").setAttribute("style",`left:${te-d.firstElementChild.scrollLeft}px;top:${ye}px;height:${ue}px;width:${K+1}px;`),m=E}return}e.selectElement.classList.remove("fn__none"),Y(["gutter"],e);let S=0,x=0,k=0,C=0;if(y.clientX<f?(y.clientX<o?x=o:x=y.clientX,k=f-x):y.clientX>r?(x=f,k=r-x):(x=f,k=y.clientX-f),y.clientY>u?y.clientY>c?(S=u,C=c-u):(S=u,C=y.clientY-u):(y.clientY<p?S=p:S=y.clientY,C=u-S),C<4)return;e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${S}px;height:${C}px;left:${x+2}px;width:${k-2}px;`);const v=document.elementFromPoint(y.clientX,y.clientY);if(b&&b.isSameNode(v)&&!b.classList.contains("protyle-wysiwyg")&&!b.classList.contains("list")&&!b.classList.contains("bq")&&!b.classList.contains("sb"))return;b=v,Y(["select"],e);let L;if(y.clientY>u?(L=h||document.elementFromPoint(x,S),w=void 0):(L=document.elementFromPoint(x,S),h=void 0),!L||((L.classList.contains("protyle-wysiwyg")||L.classList.contains("list")||L.classList.contains("sb")||L.classList.contains("bq"))&&(L=document.elementFromPoint(x,S+16)),!L))return;let D=I(L);y.clientY>u?h||(h=L):!D&&y.clientY<e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(D=e.wysiwyg.element.firstElementChild);let O=[],P=D,Z=!1;const pe=w?w.getBoundingClientRect().bottom:S+C;for(;P;)if(P&&!P.classList.contains("protyle-attr")){const K=P.getBoundingClientRect();if(K.height>0&&K.top<pe&&K.left<x+k)if(Z)if(P.nextElementSibling&&!P.nextElementSibling.classList.contains("protyle-attr")){const te=P.nextElementSibling.getBoundingClientRect();if(te.top<pe&&te.left<x+k)O=[P],P=P.nextElementSibling,Z=!1;else if(P.parentElement.classList.contains("sb"))P=I(P.parentElement),Z=!0;else break}else P=I(P.parentElement),Z=!0;else O.push(P),P=P.nextElementSibling;else if(P.parentElement.classList.contains("sb"))P=I(P.parentElement),Z=!0;else if(K.height===0&&K.width===0&&P.parentElement.getAttribute("fold")==="1")P=P.parentElement,O=[];else break}else P=I(P.parentElement),Z=!0;y.clientY<=u&&!w&&(w=O[O.length-1]),O.length===1&&!O[0].classList.contains("list")&&!O[0].classList.contains("bq")&&!O[0].classList.contains("sb")?e.selectElement.style.backgroundColor="transparent":(O.forEach(K=>{N(K,"protyle-wysiwyg__embed")||K.classList.add("protyle-wysiwyg--select")}),e.selectElement.style.backgroundColor="")},s.onmouseup=y=>{var E;if(s.onmousemove=null,s.onmouseup=null,s.ondragstart=null,s.onselectstart=null,s.onselect=null,h=void 0,w=void 0,e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),!e.disabled&&d){d.firstElementChild.style.webkitUserModify="";const k=d.querySelector(".table__select");k.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.mergeCell,click:()=>{if(d){const C=[],v=[],L=d.querySelectorAll("th").length;let D=0;const O=d.firstElementChild.scrollLeft;let P=!1,Z=!1;d.querySelectorAll("th, td").forEach((ve,Kt)=>{ve.classList.contains("fn__none")?(ve.previousElementSibling&&ve.previousElementSibling.isSameNode(C[C.length-1])||Kt<D&&v.includes((Kt+1)%L))&&(C.push(ve),!P&&ve.parentElement.parentElement.tagName==="THEAD"?P=!0:!Z&&ve.parentElement.parentElement.tagName==="TBODY"&&(Z=!0)):ve.offsetLeft+6>k.offsetLeft+O&&ve.offsetLeft+ve.clientWidth-6<k.offsetLeft+O+k.clientWidth&&ve.offsetTop+6>k.offsetTop&&ve.offsetTop+ve.clientHeight-6<k.offsetTop+k.clientHeight&&(C.push(ve),!P&&ve.parentElement.parentElement.tagName==="THEAD"?P=!0:!Z&&ve.parentElement.parentElement.tagName==="TBODY"&&(Z=!0),v.push((Kt+1)%L),D=Math.max((ve.rowSpan-1)*L+Kt+1,D))}),k.removeAttribute("style");const pe=d.outerHTML;let K=C[0],te=K.colSpan,ue=1;for(;K.nextElementSibling&&K.nextElementSibling.isSameNode(C[ue]);)K=K.nextElementSibling,K.classList.contains("fn__none")||(te+=K.colSpan),ue++;let ye="",ae=C[0].parentElement,Ze=C[0].rowSpan;if(C.forEach((ve,Kt)=>{let fn=ve.innerHTML.trim();fn.endsWith("<br>")&&(fn=fn.substr(0,fn.length-4)),ye+=fn+(!fn||Kt===C.length-1?"":"<br>"),Kt!==0&&(ae.isSameNode(ve.parentElement)||(ve.classList.contains("fn__none")||(Ze+=ve.rowSpan),ae=ve.parentElement,C[0].parentElement.parentElement.tagName==="THEAD"&&ve.parentElement.parentElement.tagName!=="THEAD"&&C[0].parentElement.parentElement.insertAdjacentElement("beforeend",ve.parentElement)),ve.classList.add("fn__none"),ve.innerHTML="")}),P&&Z)for(ae=ae.parentElement.nextElementSibling.firstElementChild;ae&&ae.parentElement.tagName!=="THEAD";){let ve=0,Kt=0;if(Array.from(ae.children).forEach(fn=>{ve+=fn.colSpan-1,fn.classList.contains("fn__none")&&Kt++}),ve!==Kt)C[0].parentElement.parentElement.insertAdjacentElement("beforeend",ae),ae=ae.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{d&&(C[0].innerHTML=ye+"<wbr>",C[0].colSpan=te,C[0].rowSpan=Ze,re(C[0],document.createRange()),j(e,d.getAttribute("data-node-id"),d.outerHTML,pe))})}}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(d){const C=[],v=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(L=>{!L.classList.contains("fn__none")&&L.offsetLeft+6>k.offsetLeft+v&&L.offsetLeft+L.clientWidth-6<k.offsetLeft+v+k.clientWidth&&L.offsetTop+6>k.offsetTop&&L.offsetTop+L.clientHeight-6<k.offsetTop+k.clientHeight&&(C.length===0||C.length>0&&L.offsetTop===C[0].offsetTop)&&C.push(L)}),k.removeAttribute("style"),tn(e,C,d,"left",de(d))}}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(d){const C=[],v=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(L=>{!L.classList.contains("fn__none")&&L.offsetLeft+6>k.offsetLeft+v&&L.offsetLeft+L.clientWidth-6<k.offsetLeft+v+k.clientWidth&&L.offsetTop+6>k.offsetTop&&L.offsetTop+L.clientHeight-6<k.offsetTop+k.clientHeight&&(C.length===0||C.length>0&&L.offsetTop===C[0].offsetTop)&&C.push(L)}),k.removeAttribute("style"),tn(e,C,d,"center",de(d))}}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(d){const C=[],v=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(L=>{!L.classList.contains("fn__none")&&L.offsetLeft+6>k.offsetLeft+v&&L.offsetLeft+L.clientWidth-6<k.offsetLeft+v+k.clientWidth&&L.offsetTop+6>k.offsetTop&&L.offsetTop+L.clientHeight-6<k.offsetTop+k.clientHeight&&(C.length===0||C.length>0&&L.offsetTop===C[0].offsetTop)&&C.push(L)}),k.removeAttribute("style"),tn(e,C,d,"right",de(d))}}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.clear,icon:"iconTrashcan",click(){if(d){const C=[],v=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(D=>{!D.classList.contains("fn__none")&&D.offsetLeft+6>k.offsetLeft+v&&D.offsetLeft+D.clientWidth-6<k.offsetLeft+v+k.clientWidth&&D.offsetTop+6>k.offsetTop&&D.offsetTop+D.clientHeight-6<k.offsetTop+k.clientHeight&&C.push(D)}),k.removeAttribute("style");const L=d.outerHTML;C.forEach(D=>{D.innerHTML=""}),j(e,d.getAttribute("data-node-id"),d.outerHTML,L)}}}).element),window.siyuan.menus.menu.popup({x:y.clientX-8,y:y.clientY-16}))}const S=[],x=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(x.forEach(k=>{S.push(k.getAttribute("data-node-id"))}),Fe(S),getSelection().rangeCount>0){const k=getSelection().getRangeAt(0);if((k.toString()===""||window.siyuan.shiftIsPressed)&&n.detail===3){let L=I(k.startContainer);if(L){if((E=L.nextElementSibling)!=null&&E.classList.contains("table"))ot($(L),k,!1);else if(L.classList.contains("table")){const D=L.querySelectorAll("th, td");L=D[D.length-1],L.contains(k.startContainer)&&ot(L,k,!1)}}return}if(x.length>0){k.collapse(!0);return}const C=I(k.startContainer);let v;y.detail===3&&k.endContainer.nodeType!==3&&k.endContainer.tagName==="DIV"&&k.endOffset===0?k.endContainer.classList.contains("protyle-attr")&&ot(k.endContainer.previousElementSibling,k,!1):v=I(k.endContainer),C&&v&&!v.isSameNode(C)&&k.collapse(!0)}}})}bindEvent(e){this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const o=getSelection().getRangeAt(0);(this.element.isSameNode(o.startContainer)||this.element.contains(o.startContainer))&&(e.toolbar.range=o)}),this.element.addEventListener("cut",o=>{var r,c;if(window.siyuan.ctrlIsPressed=!1,e.disabled)return;if(o.target.tagName==="PROTYLE-HTML"){o.stopPropagation();return}e.options.render.breadcrumb&&e.breadcrumb.hide();const u=de(e.wysiwyg.element);let d=I(u.startContainer);if(!d){o.stopPropagation(),o.preventDefault();return}if(d.classList.contains("av")){Qa(e,d),o.stopPropagation();return}o.stopPropagation(),o.preventDefault();const f=d.querySelector(".img--select");let p=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));p.length===0&&u.toString()===""&&!u.cloneContents().querySelector("img")&&!f&&(d.classList.add("protyle-wysiwyg--select"),p=[d]);let b="";if(p.length>0){p[0].getAttribute("data-type")==="NodeListItem"&&p[0].parentElement.classList.contains("list")&&p[0].parentElement.childElementCount-1===p.length?b=p[0].parentElement.outerHTML:(p.forEach(w=>{const y=he(w);w.getAttribute("data-type")==="NodeHeading"&&w.getAttribute("fold")==="1"?b+=nn(y).replace('fold="1"',""):b+=nn(y)}),p[0].getAttribute("data-type")==="NodeListItem"&&(b=`<div data-subtype="${p[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${b}<div class="protyle-attr" contenteditable="false">${g.ZWSP}</div></div>`));const h=B(p[p.length-1]);bt(e,d,u),h&&ce(h)}else{const h=d.getAttribute("data-node-id"),w=d.outerHTML,y=document.createElement("div");let E=u.startContainer;if(E.nodeType===3&&E.textContent===""){const k=Ee(u.startContainer);k&&(E=k)}const S=A(E,"data-type","NodeHeading");let x=!1;if(S&&u.toString()===S.firstElementChild.textContent){const k=[{action:"delete",id:S.getAttribute("data-node-id")}],C=[{action:"insert",id:S.getAttribute("data-node-id"),data:S.outerHTML,previousID:(r=S.previousElementSibling)==null?void 0:r.getAttribute("data-node-id"),parentID:((c=S.parentElement)==null?void 0:c.getAttribute("data-node-id"))||e.block.parentID}];if(S.getAttribute("fold")==="1"){x=!0;const v=S.cloneNode(!0);v.removeAttribute("fold"),y.append(v),C[0].data=v.outerHTML,at(e,S,void 0,!0)}else{if(S.parentElement.childElementCount===3&&S.parentElement.classList.contains("li")||S.parentElement.childElementCount===2&&(S.parentElement.classList.contains("bq")||S.parentElement.classList.contains("sb"))||S.parentElement.childElementCount===1&&S.parentElement.classList.contains("protyle-wysiwyg")){const v=Lute.NewNodeID(),L=mn(!1,!1,v);k.push({id:v,data:L.outerHTML,action:"insert",parentID:S.parentElement.getAttribute("data-node-id")||e.block.parentID}),C.push({id:v,action:"delete"}),S.before(L)}Ra(S),y.append(S)}F(e,k,C)}else if(u.toString()!==""&&E.isSameNode(u.endContainer)&&u.startContainer.nodeType===3&&u.endOffset===u.endContainer.textContent.length&&u.startOffset===0&&!["DIV","TD","TH","TR"].includes(u.startContainer.parentElement.tagName))y.append(u.startContainer.parentElement);else if(f)y.append(f);else if(u.startContainer.nodeType===3&&u.startContainer.parentElement.tagName==="SPAN"&&u.startContainer.parentElement.getAttribute("data-type")&&u.startContainer.parentElement.isSameNode(u.endContainer.parentElement)){const k=u.startContainer.parentElement,C=k.attributes,v=document.createElement("span");for(let L=0;L<C.length;L++)v.setAttribute(C[L].name,C[L].value);k.getAttribute("data-type").indexOf("block-ref")>-1&&k.getAttribute("data-subtype")==="d"&&(v.setAttribute("data-subtype","s"),k.setAttribute("data-subtype","s")),v.textContent=u.toString(),u.deleteContents(),y.append(v)}else if(u.cloneContents().querySelectorAll("td, th").length>0){const k=document.createElement("wbr");u.insertNode(k),u.setStartAfter(k),y.append(u.extractContents()),d.outerHTML=e.lute.SpinBlockDOM(d.outerHTML),d=e.wysiwyg.element.querySelector(`[data-node-id="${h}"]`),re(d,u)}else{const k=A(u.commonAncestorContainer,"data-type","inline-math");if(k)y.append(k);else{y.append(u.extractContents());let C;d.classList.contains("table")?C=R(u.startContainer,"TD")||R(u.startContainer,"TH"):C=$(d),C&&Array.from(C.children).forEach(v=>{v.textContent===""&&v.nodeType===1&&!["BR","IMG"].includes(v.tagName)&&v.remove()})}}if(this.emojiToMd(y),b=y.innerHTML,!d.classList.contains("table")){const k=$(d);k&&k.textContent===""&&(k.innerHTML="")}d.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),d.getAttribute("data-type")==="NodeCodeBlock"&&(u.insertNode(document.createElement("wbr")),$(d).removeAttribute("data-render"),Ae(d)),d.parentElement.parentElement&&!x&&j(e,h,d.outerHTML,w)}e.hint.render(e);let m=e.lute.BlockDOM2StdMd(b).trimEnd();m=m.replace(/\u00A0/g," "),o.clipboardData.setData("text/plain",m),o.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(b)),o.clipboardData.setData("text/siyuan",b)});let n;this.element.addEventListener("contextmenu",o=>{var r,c,u,d;if(o.shiftKey)return;o.stopPropagation(),o.preventDefault();const f=o.clientX||o.detail.x,p=o.clientY||o.detail.y,b=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(b.length>1){Y(["util"],e),e.gutter.renderMenu(e,b[0]),window.siyuan.menus.menu.popup({x:f,y:p});return}const m=o.detail.target||o.target,h=A(m,"data-type","NodeBlockQueryEmbed");if(h)return getSelection().rangeCount===0&&Ra(h),e.gutter.renderMenu(e,h),window.siyuan.menus.menu.fullscreen(),!1;if(e.toolbar.range=de(e.element),m.tagName==="SPAN"){let E=e.toolbar.getCurrentType(e.toolbar.range);if(E.length===0&&(E=(m.dataset.type||"").split(" ")),E.length>0&&Ll(m),E.includes("block-ref"))return Ri(e,m),m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620),!1;if(E.includes("file-annotation-ref")&&!e.disabled)return Oi(e,m),!1;if(E.includes("tag")&&!e.disabled)return Wi(e,m),!1;if(E.includes("inline-memo"))return e.toolbar.showRender(e,m),!1;if(E.includes("a")&&!e.disabled)return ya(e,m),window.siyuan.config.editor.floatWindowMode===0&&((r=m.getAttribute("data-href"))!=null&&r.startsWith("siyuan://blocks"))&&(m.setAttribute("prevent-popover","true"),setTimeout(()=>{m.removeAttribute("prevent-popover")},620)),!1}if(!e.disabled&&m.tagName==="IMG"&&N(m,"img"))return Ui(e,e.toolbar.range,m.parentElement.parentElement,{clientX:f+4,clientY:p}),!1;const w=I(m),y=N(m,"av__row");if(y&&Ai(e,y,{x:o.clientX,y:y.getBoundingClientRect().bottom,h:y.clientHeight})){o.stopPropagation(),o.preventDefault();return}if(!w)return!1;!q(w)&&!w.classList.contains("protyle-wysiwyg--select")&&!N(m,"protyle-action")&&(H()||o.detail.target||n&&w.contains(n.startContainer))?(!H()||(c=e.toolbar)!=null&&c.element.classList.contains("fn__none"))&&!w.classList.contains("av")&&(ic(e,w),window.siyuan.menus.menu.popup({x:f,y:p+13,h:26}),(u=e.toolbar)==null||u.element.classList.add("fn__none"),w.classList.contains("table")&&w.querySelector(".table__select").removeAttribute("style")):e.toolbar.range.toString()===""&&(Y(["util"],e),e.gutter&&e.gutter.renderMenu(e,w),window.siyuan.menus.menu.fullscreen(),(d=e.toolbar)==null||d.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",o=>{if(!a&&o.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(_("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{a=!1,qe({data:c,protyle:e,action:[g.CB_GET_BEFORE,g.CB_GET_UNCHANGEID]})}),a=!0),o.deltaX===0)return;const r=N(o.target,"table");if(r){const c=r.querySelector(".table__select");c!=null&&c.style.width&&(c.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0});let i=!1;this.element.addEventListener("mouseover",o=>{const r=N(o.target,"protyle-attr");if(r){i=!0,r.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const u=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");u&&u.classList.remove("protyle-wysiwyg--hl"),i=!1}if(N(o.target,"protyle-action")||!e.options.render.gutter)return;const c=I(o.target);if(!(c&&(c.classList.contains("list")||c.classList.contains("li")))&&c){const u=A(c,"data-type","NodeBlockQueryEmbed");u?e.gutter.render(e,u,this.element):e.gutter.render(e,c,this.element)}}),this.element.addEventListener("paste",o=>{if(e.disabled){o.stopPropagation(),o.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,o.target.tagName==="PROTYLE-HTML"){o.stopPropagation();return}yo(e,o)});let s=!1;this.element.addEventListener("compositionstart",o=>{const r=de(e.wysiwyg.element),c=I(r.startContainer);c&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove()),s=!0,o.stopPropagation()}),this.element.addEventListener("compositionend",o=>{o.stopPropagation(),s=!1;const r=de(this.element),c=I(r.startContainer);if(!(c&&c.getAttribute("data-type")==="NodeHTMLBlock")&&c)if(o.data!=="")this.escapeInline(e,r,o),ns(e,c,r,!0);else{const u=c.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[u]&&j(e,u,c.outerHTML,e.wysiwyg.lastHTMLs[u])}});let l;this.element.addEventListener("input",o=>{const r=o.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||o.inputType==="historyRedo")return;if(o.inputType==="historyUndo"){window.siyuan.menus.menu.remove();return}const c=de(this.element),u=I(c.startContainer);if(u){if(u&&u.getAttribute("data-type")==="NodeHTMLBlock"){o.stopPropagation();return}[":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(o.data)&&(e.hint.enableExtend=!0),!(o.isComposing||s||o.inputType==="deleteByDrag"||o.inputType==="insertFromDrop")&&(this.escapeInline(e,c,o),/^\d{1}$/.test(o.data)||o.data==="\u2018"||o.data==="\u201C"||o.data==="\u300C"?(clearTimeout(l),l=window.setTimeout(()=>{ns(e,u,c,!0)})):ns(e,u,c,!0),o.stopPropagation())}}),this.element.addEventListener("keyup",o=>{const r=de(this.element).cloneRange(),c=I(r.startContainer);if(o.key!=="PageUp"&&o.key!=="PageDown"&&o.key!=="Home"&&o.key!=="End"&&o.key.indexOf("Arrow")===-1&&o.key!=="Alt"&&o.key!=="Shift"&&o.key!=="CapsLock"&&o.key!=="Escape"&&o.key!=="Meta"&&!/^F\d{1,2}$/.test(o.key)&&(!o.isComposing||o.isComposing&&r.toString()!=="")){r.toString()===""&&c&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=="undefined"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove());return}if(!this.preventKeyup&&((o.shiftKey||Ce(o))&&!o.isComposing&&r.toString()!==""&&(e.toolbar.render(e,r,o),Ge(r)),o.eventPhase!==3&&!o.shiftKey&&(o.key.indexOf("Arrow")>-1||o.key==="Home"||o.key==="End"||o.key==="PageUp"||o.key==="PageDown")&&!o.isComposing&&(c&&(this.setEmptyOutline(e,c),r.toString()===""&&Ge(r,e.block.rootID)),o.stopPropagation()),(o.key==="ArrowLeft"||o.key==="ArrowRight"||o.key==="Alt"||o.key==="Shift")&&c&&!c.classList.contains("protyle-wysiwyg--select"))){const u=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let d=!1;u.find(f=>{if(f.contains(r.startContainer))return d=!0,!0}),!d&&u.length>0&&(u.forEach(f=>{f.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",o=>{if(o.target.tagName==="IMG"&&!o.target.classList.contains("emoji")){Js(o.target.src,e.block.rootID);return}}),this.element.addEventListener("click",o=>{e.app.plugins.forEach(L=>{L.eventBus.emit("click-editorcontent",{protyle:e,event:o})}),Y(["hint","util"],e);const r=o.metaKey||o.ctrlKey;o.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(e,o.target);const c=N(o.target,"table");this.element.querySelectorAll(".table").forEach(L=>{(!c||!L.isSameNode(c))&&L.querySelector(".table__select").removeAttribute("style"),c&&c.isSameNode(L)&&L.querySelector(".table__select").getAttribute("style")&&o.stopPropagation()}),e.options.render.breadcrumb&&e.breadcrumb.render(e);const u=de(this.element),d=A(o.target,"data-type","block-ref"),f=A(o.target,"data-type","a")||A(o.target,"data-type","url");let p="";if(f&&(f.classList.contains("av__celltext")?p=f.textContent.trim():p=f.getAttribute("data-href")),d||p.startsWith("siyuan://blocks/")){if(o.stopPropagation(),o.preventDefault(),Y(["dialog","toolbar"],e),u.toString()!==""&&!o.shiftKey)return;let L;d?L=d.getAttribute("data-id"):f&&(L=p.substring(16,38)),_("/api/block/checkBlockFold",{id:L},D=>{Ke(e.app,L,D.data?[g.CB_GET_ALL,g.CB_GET_HL]:[g.CB_GET_HL,g.CB_GET_CONTEXT]),$t(),pt()});return}const b=A(o.target,"data-type","file-annotation-ref");if(b&&u.toString()===""){o.stopPropagation(),o.preventDefault();const D=`assets/${b.getAttribute("data-id").split("/")[1]}`;Nt(D);return}if(f&&!o.altKey){o.stopPropagation(),o.preventDefault();const L=Lute.UnEscapeHTMLStr(p);Nt(L);return}const m=A(o.target,"data-type","tag");if(m&&!o.altKey){const L=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(e.app,{removed:L.removed,sort:L.sort,group:L.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${m.textContent}#`,r:"",page:1,types:Object.assign({},L.types)});return}const h=N(o.target,"protyle-wysiwyg__embed");if(h){const L=h.getAttribute("data-id");_("/api/block/checkBlockFold",{id:L},D=>{Ke(e.app,L,D.data?[g.CB_GET_ALL,g.CB_GET_HL]:[g.CB_GET_HL,g.CB_GET_CONTEXT]),$t(),pt()}),o.stopPropagation();return}if(id(o,e)||tt(o.target,"protyle-action__copy"))return;const w=N(o.target,"protyle-action__edit");if(w&&!e.disabled){e.toolbar.showRender(e,w.parentElement.parentElement),o.stopPropagation(),o.preventDefault();return}const y=N(o.target,"protyle-action__menu");if(y){e.gutter.renderMenu(e,y.parentElement.parentElement),window.siyuan.menus.menu.fullscreen(),o.stopPropagation(),o.preventDefault();return}const E=N(o.target,"protyle-action__reload");if(E){const L=A(E,"data-type","NodeBlockQueryEmbed");L&&(L.removeAttribute("data-render"),Se(e,L)),o.stopPropagation(),o.preventDefault();return}const S=N(o.target,"protyle-action__language");if(S&&!e.disabled){e.toolbar.showCodeLanguage(e,S),o.stopPropagation(),o.preventDefault();return}const x=A(o.target,"data-subtype","math");if(!o.shiftKey&&!r&&x&&!e.disabled){e.toolbar.showRender(e,x),o.stopPropagation();return}const k=N(o.target,"protyle-action");if(k){if(k.parentElement.parentElement.getAttribute("data-type")==="img"&&!e.disabled)Ui(e,u,k.parentElement.parentElement,{clientX:o.clientX+4,clientY:o.clientY});else if(k.parentElement.classList.contains("li")){const D=k.parentElement.getAttribute("data-node-id");if(o.altKey&&!e.disabled){if(k.parentElement.parentElement.classList.contains("protyle-wysiwyg"))at(e,k.parentElement);else{let O=!0;const P=k.parentElement.parentElement.outerHTML;Array.from(k.parentElement.parentElement.children).find(Z=>{if(Z.classList.contains("li")&&Z.getAttribute("fold")!=="1"&&Z.childElementCount>3)return O=!1,!0}),Array.from(k.parentElement.parentElement.children).find(Z=>{Z.classList.contains("li")&&(O?Z.removeAttribute("fold"):Z.childElementCount>3&&Z.setAttribute("fold","1"))}),j(e,k.parentElement.parentElement.getAttribute("data-node-id"),k.parentElement.parentElement.outerHTML,P)}Y(["gutter"],e)}else if(o.shiftKey&&!e.disabled)ln(k.parentElement,"bookmark",e);else if(r)mt({protyle:e,id:D});else if(k.classList.contains("protyle-action--task")){if(!e.disabled){const O=k.parentElement.outerHTML;k.parentElement.classList.contains("protyle-task--done")?(k.querySelector("use").setAttribute("xlink:href","#iconUncheck"),k.parentElement.classList.remove("protyle-task--done")):(k.querySelector("use").setAttribute("xlink:href","#iconCheck"),k.parentElement.classList.add("protyle-task--done")),k.parentElement.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(e,D,k.parentElement.outerHTML,O)}}else e.block.showAll&&e.block.id===D?Fi(e,D):mt({protyle:e,id:D})}o.stopPropagation();return}const C=N(o.target,"hr")||N(o.target,"iframe");if(!o.shiftKey&&!r&&C){C.classList.add("protyle-wysiwyg--select"),o.stopPropagation();return}const v=tt(o.target,"img");if(!o.shiftKey&&!r&&v){v.classList.add("img--select"),u.setStartAfter(v),u.collapse(!0),z(u),e.options.render.breadcrumb&&e.breadcrumb.render(e);return}if(!Ir(e,o)){if(o.target.contains(this.element)&&this.element.lastElementChild&&!e.disabled){const L=this.element.lastElementChild.getBoundingClientRect();if(o.y>L.bottom){const D=$(G(this.element.lastElementChild));if(!D||this.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||this.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&$(D).innerHTML!==""){const O=mn(!1,!1);this.element.insertAdjacentElement("beforeend",O),F(e,[{action:"insert",data:O.outerHTML,id:O.getAttribute("data-node-id"),previousID:O.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:O.getAttribute("data-node-id")}]);const P=$(O);u.selectNodeContents(P),u.collapse(!0),z(u),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},g.TIMEOUT_TRANSITION)}else D&&(u.selectNodeContents(D),u.collapse(!1),z(u))}}if(setTimeout(()=>{const L=de(this.element);e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||Ge(L,e.block.rootID),getSelection().rangeCount===0&&z(L)},H()||Pt()?520:0),e.hint.enableExtend=!1,o.shiftKey){o.preventDefault(),o.stopPropagation();let L=this.shiftStartElement,D=I(o.target);if(this.shiftStartElement&&D&&!this.shiftStartElement.isSameNode(D)){let O=!0;u.collapse(!0);const P=L.getBoundingClientRect(),Z=D.getBoundingClientRect();let pe=P.top,K=Z.top;if(pe===K&&(pe=P.left,K=Z.left),pe>K){const ae=D;D=L,L=ae;const Ze=K;K=pe,pe=Ze,O=!1}let te=[],ue=L,ye=!1;for(;ue;)if(ue&&!ue.classList.contains("protyle-attr")){const ae=ue.getBoundingClientRect();if(P.top===Z.top?ae.left<=K:ae.top<=K)if(ye)if(ue.nextElementSibling&&!ue.nextElementSibling.classList.contains("protyle-attr")){const Ze=ue.nextElementSibling.getBoundingClientRect();if(P.top===Z.top?Ze.left<=K&&Ze.bottom<=Z.bottom:Ze.top<=K)te=[ue],ue=ue.nextElementSibling,ye=!1;else if(ue.parentElement.classList.contains("sb"))ue=I(ue.parentElement),ye=!0;else break}else ue=I(ue.parentElement),ye=!0;else te.push(ue),ue=ue.nextElementSibling;else if(ue.parentElement.classList.contains("sb"))ue=I(ue.parentElement),ye=!0;else break}else ue=I(ue.parentElement),ye=!0;if(te.length===1&&!te[0].classList.contains("list")&&!te[0].classList.contains("bq")&&!te[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const ae=[];!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&e.scroll&&!e.scroll.element.classList.contains("fn__none")&&!e.scroll.keepLazyLoad&&(L.getBoundingClientRect().top<-e.contentElement.clientHeight*2||D.getBoundingClientRect().bottom>e.contentElement.clientHeight*2)&&oe(window.siyuan.languages.crossKeepLazyLoad),te.forEach(Ze=>{Ze.classList.add("protyle-wysiwyg--select"),ae.push(Ze.getAttribute("data-node-id")),Ze.querySelectorAll(".protyle-wysiwyg--select").forEach(ve=>{ve.classList.remove("protyle-wysiwyg--select")})}),Fe(ae),ce(O?te[te.length-1]:te[0],e.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&u.toString()!==""&&(u.collapse(!1),z(u)),r&&u.toString()===""){let L=I(o.target);if(L){L=he(L),L.classList.contains("protyle-wysiwyg--select")?(L.classList.remove("protyle-wysiwyg--select"),L.removeAttribute("select-start"),L.removeAttribute("select-end")):L.classList.add("protyle-wysiwyg--select"),L.querySelectorAll(".protyle-wysiwyg--select").forEach(P=>{P.classList.remove("protyle-wysiwyg--select"),P.removeAttribute("select-start"),P.removeAttribute("select-end")});const D=N(L.parentElement,"protyle-wysiwyg--select");D&&(D.classList.remove("protyle-wysiwyg--select"),D.removeAttribute("select-start"),D.removeAttribute("select-end"));const O=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(P=>{O.push(P.getAttribute("data-node-id"))}),Fe(O)}}}})}}class ld{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}var od=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class rd extends Kn{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>od(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!I(i.startContainer))return;const l=A(i.startContainer,"data-type","a");if(l){ya(e,l);return}const o=i.toString().trim().replace(g.ZWSP,"");let r="",c="";try{const u=yield Fa();if(e.lute.IsValidLinkDest(o))r=o;else if(e.lute.IsValidLinkDest(u))r=u;else{const d=u.lastIndexOf(" ");d>-1&&e.lute.IsValidLinkDest(u.substring(d))&&(r=u.substring(d),c=u.substring(0,d))}}catch(u){console.log(u)}e.toolbar.setInlineMark(e,"a","range",{type:"a",color:r+(c?g.ZWSP+c:"")})}))}}class cd extends Kn{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>{e.toolbar.range.toString()!==""&&(gi(e.toolbar.range),Hn(e.toolbar.range.toString(),e,"search"),e.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}var dd=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class ud extends Kn{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>dd(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!I(i.startContainer))return;let l=A(i.startContainer,"data-type","inline-math");if(!l&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const o=xe(i.startContainer.childNodes[i.startOffset]);o&&o.getAttribute("data-type").indexOf("inline-math")>-1&&(l=o)}if(!l&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let o=!0,r=!1;if(i.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:o=!1}),o&&r){const c=Ee(i.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)l=c;else{const u=xe(i.startContainer);i.startOffset===0&&u&&u.nodeType!==3&&u.getAttribute("data-type").indexOf("inline-math")>-1&&(l=u)}}}if(l){e.toolbar.showRender(e,l);return}e.toolbar.setInlineMark(e,"inline-math","range",{type:"inline-math"})}))}}var fd=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class gd extends Kn{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>fd(this,null,function*(){e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!I(i.startContainer))return;const l=A(i.startContainer,"data-type","inline-memo");if(l&&l.textContent===i.toString()){e.toolbar.showRender(e,l);return}i.toString()!==""&&e.toolbar.setInlineMark(e,"inline-memo","range",{type:"inline-memo"})}))}}var pd=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class md{constructor(e){const n=e.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none protyle-util--mobile",this.toolbarHeight=29,n.toolbar.forEach(i=>{const s=this.genItem(e,i);this.element.appendChild(s)})}render(e,n,a){this.range=n;let i=I(n.startContainer);if(H()||!i||e.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!0,l=!0;if(Array.from(n.cloneContents().childNodes).find(f=>{if(f.nodeType!==1){if(f.textContent.length>0)return l=!1,!0}else if(!f.classList.contains("img"))return s=!1,!0}),s&&l||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const o=I(n.startContainer),r=I(n.endContainer);if(o&&r&&!o.isSameNode(r)){if(a)if(a.key==="ArrowLeft")this.range=ot($(o),n,!1);else if(a.key==="ArrowRight")this.range=Oa($(r),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=Oa($(r),n),i=I(r),!i)return}else a.key==="ArrowDown"&&(this.range=ot($(o),n,!1));else this.range=ot($(i),n,!1);if(z(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const c=Rt(i,n);this.element.classList.remove("fn__none");const u=c.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",u+g.ZWSP+e.contentElement.scrollTop.toString()),Le(this.element,c.left-52,u),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(f=>{f.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(f=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(f))return;const p=this.element.querySelector(`[data-type="${f}"]`);p&&p.classList.add("protyle-toolbar__item--current")})}getCurrentType(e=this.range){var n,a;let i=[],s=e.startContainer;if(s.nodeType===3?s=s.parentElement:s.childElementCount>0&&((n=s.childNodes[e.startOffset])==null?void 0:n.nodeType)!==3&&(s=s.childNodes[e.startOffset]),!s||s.nodeType===3)return[];["DIV","TD","TH","TR"].includes(s.tagName)||(i=(s.getAttribute("data-type")||"").split(" "));let l=e.endContainer;return l.nodeType===3?l=l.parentElement:l.childElementCount>0&&((a=l.childNodes[e.endOffset])==null?void 0:a.nodeType)!==3&&(l=l.childNodes[e.endOffset]),!l||l.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(l.tagName)&&!s.isSameNode(l)&&(i=i.concat((l.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach(o=>{o.nodeType!==3&&(i=i.concat((o.getAttribute("data-type")||"").split(" ")))}),i=[...new Set(i)],i.find((o,r)=>{if(o==="")return i.splice(r,1),!0}),i)}genItem(e,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new Kn(e,n);break;case"block-ref":a=new cd(e,n);break;case"inline-math":a=new ud(e,n);break;case"inline-memo":a=new gd(e,n);break;case"|":a=new ld;break;case"text":a=new Kr(e,n);break;case"a":a=new rd(e,n);break}if(a)return a.element}mergeNode(e){for(let n=0;n<e.length;n++)e[n].nodeType!==3&&e[n].tagName==="WBR"&&(e[n].remove(),n--);for(let n=0;n<e.length;n++)e[n].nodeType===3&&(e[n].textContent===""?(e[n].remove(),n--):e[n+1]&&e[n+1].nodeType===3&&(e[n].textContent=e[n].textContent+e[n+1].textContent,e[n+1].remove(),n--))}setInlineMark(e,n,a,i){var s;const l=I(this.range.startContainer);if(!l)return;const o=I(this.range.endContainer);if(!o)return;l.isSameNode(o)||(this.range=ot($(l),this.range,!1));const r=this.getCurrentType(this.range),c=this.range.toString();gi(this.range);let u,d,f,p;const b=xe(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?b&&b.nodeType!==3&&this.range.startOffset===0&&(u=b):this.range.startOffset===0&&!b?(u=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):u=this.range.startContainer.parentElement;let m=!1;const h=Ee(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?h&&h.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(d=h):this.range.endOffset===this.range.endContainer.textContent.length&&!h?(d=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),c===""&&(m=!0,this.range.collapse(!1))):d=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const w=l.outerHTML,y=this.range.extractContents();if(this.mergeNode(y.childNodes),u&&d&&u.isSameNode(d)&&((s=y.firstChild)==null?void 0:s.nodeType)===3){const v=u.attributes;y.childNodes.forEach(L=>{const D=document.createElement("span");for(let O=0;O<v.length;O++)D.setAttribute(v[O].name,v[O].value);D.innerHTML=L.textContent,L.replaceWith(D)})}const E=H()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,S=a==="toolbar"?E.querySelector(`[data-type="${n}"]`):void 0,x=[];if(n==="clear"||S!=null&&S.classList.contains("protyle-toolbar__item--current")||a==="range"&&r.length>0&&r.includes(n)&&!i){if(n==="clear"?E.querySelectorAll('[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="strong"]').forEach(v=>{v.classList.remove("protyle-toolbar__item--current")}):S&&S.classList.remove("protyle-toolbar__item--current"),y.childNodes.length===0)if(r.find((v,L)=>{if(n===v)return r.splice(L,1),!0}),r.length===0||n==="clear")x.push(document.createTextNode(g.ZWSP));else{let v=0;for(;v<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[v])?r.splice(v,1):++v;const L=document.createElement("span");L.setAttribute("data-type",r.join(" ")),L.textContent=g.ZWSP,x.push(L)}y.childNodes.forEach((v,L)=>{if(v.nodeType!==3&&v.tagName!=="BR"&&v.tagName!=="IMG"){const D=(v.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let O=0;O<D.length;O++)i&&i.type==="text"?D[O]==="text"&&(D.splice(O,1),O--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(D[O])&&(D.splice(O,1),O--);else D.find((O,P)=>{if(n===O)return D.splice(P,1),!0});if(D.length===0)v.textContent===""&&(v.textContent=g.ZWSP),x.push(document.createTextNode(v.textContent));else{if(c&&n==="clear"&&i&&i.type==="text"&&v.style.color===""&&v.style.webkitTextFillColor===""&&v.style.webkitTextStroke===""&&v.style.textShadow===""&&v.style.backgroundColor===""&&v.style.fontSize==="")return v.setAttribute("data-type",D.join(" ")),x.push(v),!0;n==="clear"&&(v.style.color="",v.style.webkitTextFillColor="",v.style.webkitTextStroke="",v.style.textShadow="",v.style.backgroundColor="",v.style.fontSize=""),L===0&&u&&u.nodeType!==3&&U(D,(u.getAttribute("data-type")||"").split(" "))&&Zn(v,u,i)?(f=u.textContent.length,u.innerHTML=u.innerHTML+v.innerHTML):L===y.childNodes.length-1&&d&&d.nodeType!==3&&U(D,(d.getAttribute("data-type")||"").split(" "))&&Zn(v,d,i)?(p=v.textContent.length,d.innerHTML=v.innerHTML+d.innerHTML):(v.setAttribute("data-type",D.join(" ")),x.push(v))}}else x.push(v)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&S&&S.classList.add("protyle-toolbar__item--current"),c===""){const v=document.createElement("span");if(r.push(n),m){let L=0;for(;L<r.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(r[L])?r.splice(L,1):++L}v.setAttribute("data-type",[...new Set(r)].join(" ")),v.textContent=g.ZWSP,Di(v,i),x.push(v)}else{if(n==="block-ref")for(;y.childNodes.length>1;)y.childNodes[0].remove();y.childNodes.forEach((v,L)=>{var D,O;if(v.nodeType===3)if(L===0&&u&&u.nodeType!==3&&n===u.getAttribute("data-type")&&Zn(v,u,i))f=u.textContent.length,u.innerHTML=u.innerHTML+v.textContent;else if(L===y.childNodes.length-1&&d&&d.nodeType!==3&&n===d.getAttribute("data-type")&&Zn(v,d,i))p=v.textContent.length,d.innerHTML=v.textContent+d.innerHTML;else{const P=document.createElement("span");P.setAttribute("data-type",n),P.textContent=v.textContent,Di(P,i),x.push(P)}else{let P=(v.getAttribute("data-type")||"").split(" ");for(let Z=0;Z<P.length;Z++)["backslash","virtual-block-ref","search-mark"].includes(P[Z])&&(P.splice(Z,1),Z--);P.push(n),n==="sub"&&P.includes("sup")?P.find((Z,pe)=>{if(Z==="sup")return P.splice(pe,1),E.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&P.includes("sub")?P.find((Z,pe)=>{if(Z==="sub")return P.splice(pe,1),E.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(P.includes("a")||P.includes("file-annotation-ref"))?P.find((Z,pe)=>{if(Z==="a"||Z==="file-annotation-ref")return P.splice(pe,1),!0}):n==="a"&&(P.includes("block-ref")||P.includes("file-annotation-ref"))?P.find((Z,pe)=>{if(Z==="block-ref"||Z==="file-annotation-ref")return P.splice(pe,1),!0}):n==="file-annotation-ref"&&(P.includes("block-ref")||P.includes("a"))?P.find((Z,pe)=>{if(Z==="block-ref"||Z==="a")return P.splice(pe,1),!0}):n==="inline-memo"&&P.includes("inline-math")?(P.find((Z,pe)=>{if(Z==="inline-math")return P.splice(pe,1),!0}),v.textContent=v.getAttribute("data-content")):n==="inline-math"&&P.includes("inline-memo")&&P.find((Z,pe)=>{if(Z==="inline-memo")return P.splice(pe,1),!0}),P=[...new Set(P)],L===0&&u&&u.nodeType!==3&&U(P,(u.getAttribute("data-type")||"").split(" "))&&Zn(v,u,i)?(f=u.textContent.length,u.innerHTML=u.innerHTML+v.innerHTML):L===y.childNodes.length-1&&d&&d.nodeType!==3&&U(P,(d.getAttribute("data-type")||"").split(" "))&&Zn(v,d,i)?(p=v.textContent.length,d.innerHTML=v.innerHTML+d.innerHTML):(v.tagName!=="BR"&&v.tagName!=="IMG"&&(((D=v.getAttribute("data-type"))==null?void 0:D.indexOf("backslash"))>-1&&((O=v.firstChild)==null?void 0:O.textContent)==="\\"&&v.firstChild.remove(),v.setAttribute("data-type",P.join(" ")),Di(v,i)),x.push(v))}})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!m){const v=this.range.startContainer,L=document.createElement("span"),D=v.attributes;for(let O=0;O<D.length;O++)L.setAttribute(D[O].name,D[O].value);this.range.setEnd(v.lastChild,v.lastChild.textContent.length),L.append(this.range.extractContents()),v.after(L),this.range.setStartBefore(L),this.range.collapse(!0)}for(let v=0;v<x.length;v++){const L=x[v],D=x[v+1];if(L.nodeType!==3&&D&&D.nodeType!==3&&D.tagName===L.tagName&&U((D.getAttribute("data-type")||"").split(" "),(L.getAttribute("data-type")||"").split(" "))&&L.getAttribute("data-id")===D.getAttribute("data-id")&&L.getAttribute("data-subtype")===D.getAttribute("data-subtype")&&L.style.color===D.style.color&&L.style.webkitTextFillColor===D.style.webkitTextFillColor&&L.style.webkitTextStroke===D.style.webkitTextStroke&&L.style.textShadow===D.style.textShadow&&L.style.fontSize===D.style.fontSize&&L.style.backgroundColor===D.style.backgroundColor){const O=L.getAttribute("data-type");O.indexOf("inline-math")>-1?D.setAttribute("data-content",L.getAttribute("data-content")+D.getAttribute("data-content")):(D.innerHTML=L.innerHTML+D.innerHTML,O.indexOf("inline-memo")>-1&&D.setAttribute("data-inline-memo-content",(L.getAttribute("data-inline-memo-content")||"")+(D.getAttribute("data-inline-memo-content")||""))),x.splice(v,1),v--}else{if(this.range.insertNode(L),L.nodeType!==3&&["code","tag","kbd"].includes(n)){const O=xe(L);(!O||O.textContent.endsWith(`
`))&&L.before(document.createTextNode(g.ZWSP)),L.textContent.startsWith(g.ZWSP)||(L.textContent=g.ZWSP+L.textContent);const P=Ee(L);(!P||P&&(P.nodeType!==3||P.nodeType===3&&!P.textContent.startsWith(g.ZWSP)))&&L.after(document.createTextNode(g.ZWSP))}this.range.collapse(!1)}}if(u&&(u.nodeType!==3&&u.textContent===g.ZWSP?u.remove():this.mergeNode(u.childNodes)),d&&this.mergeNode(d.childNodes),f?this.range.setStart(u.firstChild,f):x.length>0?x[0].nodeType!==3&&x[0].getAttribute("data-type")==="inline-math"||(x[0].firstChild?x[0].firstChild.textContent===g.ZWSP?this.range.setStart(x[0].firstChild,1):this.range.setStart(x[0].firstChild,0):x[0].nodeType===3?this.range.setStart(x[0],0):this.range.setStartBefore(x[0])):d&&this.range.setStart(d.firstChild,0),p)this.range.setEnd(d.lastChild,p);else if(x.length>0){const v=x[x.length-1];if(v.nodeType!==3&&v.getAttribute("data-type").indexOf("inline-math")>-1){const L=xe(v);L&&L.nodeType===3?this.range.setStart(L,L.textContent.length):this.range.setStartBefore(v);const D=Ee(v);D&&D.nodeType===3?this.range.setEnd(D,0):this.range.setEndAfter(v)}else v.lastChild?v.lastChild.textContent===g.ZWSP?this.range.collapse(!0):this.range.setEnd(v.lastChild,v.lastChild.textContent.length):v.nodeType===3?(this.range.setEnd(v,v.textContent.length),v.textContent===g.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(v)}else u&&this.range.setEnd(u.firstChild,u.firstChild.textContent.length);let k=!0;if(n==="inline-math"){if(en(l),c===""){e.toolbar.showRender(e,x[0],void 0,w);return}}else if(n==="inline-memo"){e.toolbar.showRender(e,x[0],x,w);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const v=x[0];v.textContent.replace(g.ZWSP,"")===""||!v.getAttribute("data-href")?(k=!1,ya(e,v,!!v.getAttribute("data-href"))):this.range.collapse(!1)}l.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(e,l.getAttribute("data-node-id"),l.outerHTML,w);const C=l.querySelector("wbr");C&&C.remove(),k&&z(this.range)}showRender(e,n,a,i){var s;const l=I(n);if(!l)return;Y(["hint"],e),window.siyuan.menus.menu.remove();const o=l.getAttribute("data-node-id"),r=(n.getAttribute("data-type")||"").split(" "),c=i||e.lute.SpinBlockDOM(l.outerHTML);let u="HTML",d="";const f=r.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":u=window.siyuan.languages.staff;break;case"echarts":u=window.siyuan.languages.chart;break;case"flowchart":u="Flow Chart";break;case"graphviz":u="Graphviz";break;case"mermaid":u="Mermaid";break;case"mindmap":d=`- foo
  - bar
- baz`,u=window.siyuan.languages.mindmap;break;case"plantuml":u="UML";break;case"math":r.includes("NodeMathBlock")?u=window.siyuan.languages.math:u=window.siyuan.languages["inline-math"];break}r.includes("NodeBlockQueryEmbed")?u=window.siyuan.languages.blockEmbed:f&&(u=window.siyuan.languages.memo);const p=(s=this.subElement.querySelector('[data-type="pin"]'))==null?void 0:s.classList.contains("block__icon--active"),b={};if(p){const S=this.subElement.querySelector(".b3-text-field");b.styleH=S.style.height,b.styleW=S.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${p&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${u}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${p&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${r.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${p?" block__icon--active":""}" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${e.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${d}" style="${H()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:50vh;min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const m=()=>{if(y.style.height=y.scrollHeight+"px",H()){Le(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){y.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const S=E.bottom===E.top?E.bottom+26:E.bottom;this.subElement.clientHeight<=window.innerHeight-S||this.subElement.clientHeight<=E.top?r.includes("inline-math")||f?Le(this.subElement,E.left,S,E.height||26):Le(this.subElement,E.left+(E.width-this.subElement.clientWidth)/2,S,E.height||26):Le(this.subElement,E.right,S)},h=this.subElement.querySelector(".block__icons");h.addEventListener("click",S=>{const x=S.target,k=N(x,"b3-tooltips");if(!k){if(S.detail===2){const C=h.querySelector('[data-type="pin"]');C.classList.contains("block__icon--active")?(C.classList.remove("block__icon--active"),C.setAttribute("aria-label",window.siyuan.languages.pin)):(C.classList.add("block__icon--active"),C.setAttribute("aria-label",window.siyuan.languages.unpin)),S.preventDefault(),S.stopPropagation()}return}switch(S.stopPropagation(),k.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),Y(["util"],e);break;case"pin":k.classList.contains("block__icon--active")?(k.classList.remove("block__icon--active"),k.setAttribute("aria-label",window.siyuan.languages.pin)):(k.classList.add("block__icon--active"),k.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":k.classList.toggle("block__icon--active");break;case"before":vt(e,"beforebegin",o),Y(["util"],e);break;case"after":vt(e,"afterend",o),Y(["util"],e);break;case"export":w();break}});const w=()=>{const S=oe(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(x){return x.blob()}).then(function(x){const k=new FormData;k.append("file",x),k.append("type","image/png"),_("/api/export/exportAsFile",k,C=>{Nt(C.data.file),je(S)})});return}setTimeout(()=>{fe("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(x=>{x.toBlob(k=>{const C=new FormData;C.append("file",k),C.append("type","image/png"),_("/api/export/exportAsFile",C,v=>{Nt(v.data.file),je(S)})})})})},g.TIMEOUT_LOAD)},y=this.subElement.querySelector(".b3-text-field");r.includes("NodeHTMLBlock")?y.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):f?y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),y.addEventListener("input",S=>{if(n.parentElement&&(y.clientHeight!==y.scrollHeight&&m(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(r.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(y.value));else if(f){let x;a?x=a:x=[n],x.forEach(k=>{k.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render");(!r.includes("NodeBlockQueryEmbed")||!r.includes("NodeHTMLBlock")||!f)&&Oe(n),S.stopPropagation()}}),y.addEventListener("keydown",S=>{if(S.stopPropagation(),J(window.siyuan.config.keymap.editor.insert["inline-math"].custom,S)){S.preventDefault();return}if(!S.isComposing){if(S.key==="Escape"||J("\u2318\u21A9",S))this.subElement.querySelector('[data-type="pin"]').classList.remove("block__icon--active"),Y(["util"],e);else if(S.key==="Tab")document.execCommand("insertText",!1,"	"),S.preventDefault();else if(In(S))return}}),this.subElementCloseCB=()=>{var S;if(!n.parentElement||e.disabled)return;let x;if(r.includes("NodeHTMLBlock")){let C=y.value;C&&(C=C.trim().replace(/\n+/g,`
`),C.startsWith("<div>")&&C.endsWith("</div>")||(C=`<div>
${C}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(C))}else if(f){let C;a?C=a:C=[n],C.forEach((v,L)=>{if(y.value)v.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value.replace(/\n/g," ")));else{const D=v.getAttribute("data-type").split(" ");D.length===1&&D[0]==="inline-memo"?v.outerHTML=v.innerHTML+(L===C.length-1?"<wbr>":""):(D.find((O,P)=>{if(O==="inline-memo")return D.splice(P,1),!0}),v.setAttribute("data-type",D.join(" ")),v.removeAttribute("data-inline-memo-content")),L===C.length-1&&(x=v)}})}else r.includes("inline-math")?y.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value.replace(/\n/g,""))),n.removeAttribute("data-render"),Oe(n)):(x=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),r.includes("NodeBlockQueryEmbed")?Se(e,n):Oe(n));getSelection().rangeCount===0||getSelection().rangeCount>0&&N(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?x?x.parentElement?(this.range.setStartAfter(x),this.range.collapse(!0),z(this.range)):re(l,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),z(this.range)):(ce(n),n.classList.add("protyle-wysiwyg--select")):(S=l.querySelector("wbr"))==null||S.remove(),l.setAttribute("updated",ee().format("YYYYMMDDHHmmss"));const k=e.lute.SpinBlockDOM(l.outerHTML);if(r.includes("NodeHTMLBlock")){const C=document.createElement("template");C.innerHTML=k,C.content.childElementCount>1&&oe(window.siyuan.languages.htmlBlockTip)}j(e,o,k,c)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const E=n.getBoundingClientRect();this.element.classList.add("fn__none"),p?(y.style.width=b.styleW,y.style.height=b.styleH):m(),e.disabled||y.select(),e.app.plugins.forEach(S=>{S.eventBus.emit("open-noneditableblock",{protyle:e,toolbar:this})})}showCodeLanguage(e,n){var a,i;const s=I(n);if(!s)return;Y(["hint"],e),window.siyuan.menus.menu.remove(),this.range=de(s);const l=s.getAttribute("data-node-id");let o=s.outerHTML,r=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const c=g.ALIAS_CODE_LANGUAGES.concat((i=(a=window.hljs)==null?void 0:a.listLanguages())!=null?i:[]).sort();c.forEach((f,p)=>{r+=`<div class="b3-list-item${p===0?" b3-list-item--focus":""}">${f}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${r}</div>
</div>`;const u=this.subElement.lastElementChild.lastElementChild,d=this.subElement.querySelector("input");d.addEventListener("keydown",f=>{if(f.stopPropagation(),!f.isComposing){if(bn(u,f),f.key==="Enter"){const p=this.subElement.querySelector(".b3-list-item--focus").textContent;n.textContent=p===window.siyuan.languages.clear?"":p,window.siyuan.storage[g.LOCAL_CODELANG]=n.textContent,et(g.LOCAL_CODELANG,window.siyuan.storage[g.LOCAL_CODELANG]);const b=$(s),m=s.getAttribute("linenumber");m==="true"||m!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?b.classList.add("protyle-linenumber"):b.classList.remove("protyle-linenumber"),b.textContent=b.textContent,b.removeAttribute("data-render"),Ae(s),s.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(e,l,s.outerHTML,o),o=s.outerHTML,f.preventDefault(),f.stopPropagation()}(f.key==="Escape"||f.key==="Enter")&&(this.subElement.classList.add("fn__none"),z(this.range))}}),d.addEventListener("input",f=>{const p=d.value.toLowerCase(),b=c.filter(w=>w.includes(p));let m="",h=!1;b.sort((w,y)=>w.startsWith(p)&&y.startsWith(p)?w.length<y.length?-1:w.length===y.length?0:1:w.startsWith(p)?-1:y.startsWith(p)?1:0).forEach(w=>{d.value===w&&(h=!0),m+=`<div class="b3-list-item">${w.replace(p,"<b>"+p+"</b>")}</div>`}),d.value.trim()&&!h&&(m=`<div class="b3-list-item"><b>${d.value.replace(/`| /g,"_")}</b></div>${m}`),m=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+m,u.innerHTML=m,u.firstElementChild.nextElementSibling?u.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):u.firstElementChild.classList.add("b3-list-item--focus"),f.stopPropagation()}),u.addEventListener("click",f=>{const p=f.target,b=N(p,"b3-list-item");if(!b)return;n.textContent=b.textContent===window.siyuan.languages.clear?"":b.textContent,window.siyuan.storage[g.LOCAL_CODELANG]=n.textContent,et(g.LOCAL_CODELANG,window.siyuan.storage[g.LOCAL_CODELANG]);const m=I(n);if(m){const h=$(m),w=m.getAttribute("linenumber");w==="true"||w!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?h.classList.add("protyle-linenumber"):h.classList.remove("protyle-linenumber"),h.textContent=h.textContent,h.removeAttribute("data-render"),Ae(m),m.setAttribute("updated",ee().format("YYYYMMDDHHmmss")),j(e,l,m.outerHTML,o),o=m.outerHTML,this.subElement.classList.add("fn__none"),z(this.range)}}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,Le(this.subElement,0,0),this.element.classList.add("fn__none"),d.select()}showTpl(e,n,a){this.range=a,Y(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${H()?"width: 100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 520px;${H()||window.outerWidth<window.outerWidth/2+520?"display:none":""};overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list"),s=this.subElement.firstElementChild.lastElementChild;let l=i.firstElementChild.getAttribute("data-value");Xn(l,s,e.block.parentID),i.addEventListener("mouseover",r=>{const c=r.target,u=N(c,"b3-list-item");if(!u)return;const d=u.getAttribute("data-value");l!==d&&(l=d,Xn(l,s,e.block.parentID))});const o=this.subElement.querySelector("input");o.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const u=bn(i,r);if(u){const d=u.getAttribute("data-value");if(l===d)return;l=d,Xn(l,s,e.block.parentID)}}r.key==="Enter"?(c?z(this.range):uo(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),z(this.range))}),o.addEventListener("input",r=>{r.stopPropagation(),_("/api/search/searchTemplate",{k:o.value},c=>{var u;let d="";c.data.blocks.forEach((p,b)=>{d+=`<div data-value="${p.path}" class="b3-list-item${b===0?" b3-list-item--focus":""}">${p.content}</div>`}),i.innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const f=(u=c.data.blocks[0])==null?void 0:u.path;l!==f&&(l=f,Xn(l,s,e.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),z(this.range),r.stopPropagation();return}const u=N(c,"b3-list-item__action");if(u&&u.getAttribute("data-type")==="remove"){Te(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{_("/api/search/removeTemplate",{path:u.parentElement.getAttribute("data-value")},()=>{if(u.parentElement.parentElement.childElementCount===1)u.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Xn("",s,e.block.parentID);else{if(u.parentElement.classList.contains("b3-list-item--focus")){const b=u.parentElement.previousElementSibling||u.parentElement.nextElementSibling;b.classList.add("b3-list-item--focus");const m=b.getAttribute("data-value");if(l===m)return;l=m,Xn(l,s,e.block.parentID)}u.parentElement.remove()}})}),r.stopPropagation();return}if(A(c,"data-type","previous")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(A(c,"data-type","next")){o.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const p=N(c,"b3-list-item");p&&(uo(decodeURIComponent(p.getAttribute("data-value")),e,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),o.select(),_("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((u,d)=>{c+=`<div data-value="${u.path}" class="b3-list-item--hide-action b3-list-item${d===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${u.content}</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),c===""&&(c=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.querySelector(".b3-list--background").innerHTML=c,Le(this.subElement,0,0)})}showWidget(e,n,a){this.range=a,Y(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",l=>{l.stopPropagation(),!l.isComposing&&(bn(i,l),l.key==="Enter"?(fo(this.subElement.querySelector(".b3-list-item--focus").textContent,e),this.subElement.classList.add("fn__none"),l.preventDefault()):l.key==="Escape"&&(this.subElement.classList.add("fn__none"),z(this.range)))}),s.addEventListener("input",l=>{l.stopPropagation(),_("/api/search/searchWidget",{k:s.value},o=>{let r="";o.data.blocks.forEach((c,u)=>{r+=`<div data-value="${c.path}" class="b3-list-item${u===0?" b3-list-item--focus":""}">${c.content}</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",l=>{const o=l.target,r=N(o,"b3-list-item");r&&fo(r.textContent,e)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),_("/api/search/searchWidget",{k:""},l=>{let o="";l.data.blocks.forEach((r,c)=>{o+=`<div class="b3-list-item${c===0?" b3-list-item--focus":""}">${r.content}</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=o,Le(this.subElement,0,0)})}renderAssetList(e,n,a,i){_("/api/search/searchAsset",{k:a},s=>{let l="";s.data.forEach((o,r)=>{l+=`<div data-value="${o.path}" class="b3-list-item${r===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${o.hName}</div></div>`}),e.innerHTML=l||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,s.data.length>0&&(n.innerHTML=Vn(s.data[0].path))})}showAssets(e,n,a){Y(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${H()?"width:100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 260px;display: ${H()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list"),s=this.subElement.firstElementChild.lastElementChild;i.addEventListener("mouseover",o=>{const r=o.target,c=N(r,"b3-list-item");c&&(s.innerHTML=Vn(c.getAttribute("data-value")))});const l=this.subElement.querySelector("input");l.addEventListener("keydown",o=>{if(o.stopPropagation(),o.isComposing)return;const r=this.subElement.querySelector(".b3-list--empty");if(!r){const c=bn(i,o);c&&(s.innerHTML=Vn(c.getAttribute("data-value")))}if(o.key==="Enter"){if(r)a||z(this.range);else{const c=this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value");a?a(c):go(c,e)}this.subElement.classList.add("fn__none"),o.preventDefault()}else o.key==="Escape"&&(this.subElement.classList.add("fn__none"),a||z(this.range))}),l.addEventListener("input",o=>{o.stopPropagation(),this.renderAssetList(i,s,l.value,n)}),this.subElement.lastElementChild.addEventListener("click",o=>{const r=o.target;if(A(r,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),o.stopPropagation();return}if(A(r,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),o.stopPropagation();return}if(r.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),a||z(this.range),o.stopPropagation();return}const d=N(r,"b3-list-item");if(d){o.stopPropagation();const f=d.getAttribute("data-value");a?a(f):go(f,e)}}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,Le(this.subElement,0,0),this.element.classList.add("fn__none"),l.select(),this.renderAssetList(i,s,"",n)}showContent(e,n,a){var i,s;this.range=n,Y(["hint"],e),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let l="";const o=n.toString()!==""||((s=(i=n.cloneContents().childNodes[0])==null?void 0:i.classList)==null?void 0:s.contains("emoji"));o&&(l+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',e.disabled||(l+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),e.disabled||(l+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(o||!e.disabled)&&(l+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${l}</div>`,this.subElement.lastElementChild.addEventListener("click",c=>pd(this,null,function*(){const u=N(c.target,"keyboard__action");if(!u)return;const d=u.getAttribute("data-action");if(d==="copy")z(de(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(d==="cut")z(de(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(d==="delete"){const f=de(a);f.insertNode(document.createElement("wbr"));const p=a.outerHTML;f.extractContents(),re(a,f),z(f),j(e,a.getAttribute("data-node-id"),a.outerHTML,p),this.subElement.classList.add("fn__none")}else if(d==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const f=yield Fa();wo(e,f,a)}catch(f){console.log(f)}this.subElement.classList.add("fn__none")}else if(d==="select")Ba(e,a,n),this.subElement.classList.add("fn__none");else if(d==="copyPlainText"){z(de(a));const f=getSelection().getRangeAt(0).cloneContents();f.querySelectorAll('[data-type="backslash"]').forEach(p=>{p.firstElementChild.remove()}),Ua(f.textContent),this.subElement.classList.add("fn__none")}else d==="pasteAsPlainText"?(z(de(a)),ho(e),this.subElement.classList.add("fn__none")):d==="pasteEscaped"?(Vc(e,a),this.subElement.classList.add("fn__none")):d==="back"?this.subElement.lastElementChild.innerHTML=l:d==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${o?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${o?"":" fn__none"}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,Le(this.subElement,r.left,r.top+28,g.SIZE_TOOLBAR_HEIGHT))})),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const r=Rt(a,n);Le(this.subElement,r.left,r.top-48,g.SIZE_TOOLBAR_HEIGHT)}}const Ca=(t,e,n,a,i)=>{let s=1,l;_(`/api/riff/get${a}RiffCards`,{id:e,page:s},o=>{var r;const c=new be({content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${$e(n)}</span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${o.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${o.data.total}</span>
        ${H()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${H()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${is(o.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:H()?"100vw":"80vw",height:H()?"100vh":"70vh",destroyCallback(){l&&(l.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});o.data.blocks.length>0&&(l=new un(t,c.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=l),c.editor=l,Nn(l,(r=c.element.querySelector(".b3-list-item--focus"))==null?void 0:r.getAttribute("data-id")));const u=c.element.querySelector('[data-type="previous"]'),d=c.element.querySelector('[data-type="next"]'),f=c.element.querySelector(".b3-list--background");o.data.pageCount>1&&d.removeAttribute("disabled"),c.element.setAttribute("data-key","viewCards"),c.element.addEventListener("click",p=>{var b;if(typeof p.detail=="string"){let h=f.querySelector(".b3-list-item--focus");if(h){h.classList.remove("b3-list-item--focus"),p.detail==="arrowup"?h=h.previousElementSibling||h.parentElement.lastElementChild:p.detail==="arrowdown"&&(h=h.nextElementSibling||h.parentElement.firstElementChild);const w=h.getBoundingClientRect(),y=h.parentElement.getBoundingClientRect();(w.top<y.top||w.bottom>y.bottom)&&h.scrollIntoView(w.top<y.top),Nn(l,h.getAttribute("data-id")),h.classList.add("b3-list-item--focus")}p.stopPropagation(),p.preventDefault();return}let m=p.target;for(;m&&!c.element.isSameNode(m);){const h=m.getAttribute("data-type");if(h==="close"){c.destroy(),p.stopPropagation(),p.preventDefault();break}else if(h==="previous"){if(s<=1)return;s--,s<=1&&u.setAttribute("disabled","disabled"),_(`/api/riff/get${a}RiffCards`,{id:e,page:s},w=>{var y;s===w.data.pageCount?d.setAttribute("disabled","disabled"):w.data.pageCount>1&&d.removeAttribute("disabled"),d.nextElementSibling.nextElementSibling.textContent=`${s}/${w.data.pageCount||1}`,f.innerHTML=is(w.data.blocks,n,a),f.scrollTop=0,Nn(l,(y=c.element.querySelector(".b3-list-item--focus"))==null?void 0:y.getAttribute("data-id"))}),p.stopPropagation(),p.preventDefault();break}else if(h==="next"){if(s>=o.data.pageCount)return;s++,u.removeAttribute("disabled"),_(`/api/riff/get${a}RiffCards`,{id:e,page:s},w=>{var y;s===w.data.pageCount?d.setAttribute("disabled","disabled"):w.data.pageCount>1&&d.removeAttribute("disabled"),d.nextElementSibling.nextElementSibling.textContent=`${s}/${w.data.pageCount||1}`,f.innerHTML=is(w.data.blocks,n,a),f.scrollTop=0,Nn(l,(y=c.element.querySelector(".b3-list-item--focus"))==null?void 0:y.getAttribute("data-id"))}),p.stopPropagation(),p.preventDefault();break}else if(h==="card-item"){Nn(l,m.getAttribute("data-id")),(b=f.querySelector(".b3-list-item--focus"))==null||b.classList.remove("b3-list-item--focus"),m.classList.add("b3-list-item--focus"),p.stopPropagation(),p.preventDefault();break}else if(h==="remove"){_("/api/riff/removeRiffCards",{deckID:a===""?e:g.QUICK_DECK_ID,blockIDs:[m.getAttribute("data-id")]},w=>{var y;let E=m.parentElement.nextElementSibling;E||(E=m.parentElement.previousElementSibling),!E&&m.parentElement.parentElement.childElementCount>1&&(E=m.parentElement.parentElement.firstElementChild),E?(Nn(l,E.getAttribute("data-id")),(y=f.querySelector(".b3-list-item--focus"))==null||y.classList.remove("b3-list-item--focus"),E.classList.add("b3-list-item--focus"),m.parentElement.remove()):(Nn(l,""),f.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),c.element.querySelector(".counter").textContent=(parseInt(c.element.querySelector(".counter").textContent)-1).toString(),i&&i(w)}),p.stopPropagation(),p.preventDefault();break}m=m.parentElement}})})},is=(t,e,n)=>{let a="",i=!0;const s=e.split("/");return s.splice(0,1),t.forEach(l=>{if(l.type){let o;n===""?o=At(l.box)+ze(Lute.UnEscapeHTMLStr(l.hPath),!1):(o=ze(Lute.UnEscapeHTMLStr(l.hPath),!1).replace("/"+s.join("/"),""),o.startsWith("/")&&(o=o.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${H()?"":" b3-list-item--hide-action"}" data-id="${l.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${_t(l.type)}"></use></svg>
${le(l.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${l.content||g.ZWSP}</span>
<span data-type="remove" data-id="${l.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span class="${H()||!o?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${On(o)}">${$e(o)}</span>
<span aria-label="${window.siyuan.languages.revisionCount}" class="b3-tooltips b3-tooltips__w counter${l.riffCardReps===0?" fn__none":""}">${l.riffCardReps}</span>
</div>`,i=!1}else a+=`<div data-type="card-item" class="b3-list-item${H()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${l.content}</span>
<span data-type="remove" data-id="${l.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),t.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},Nn=(t,e)=>{if(!e){t.protyle.element.classList.add("fn__none"),t.protyle.element.nextElementSibling.classList.remove("fn__none");return}t.protyle.element.classList.remove("fn__none"),t.protyle.element.nextElementSibling.classList.add("fn__none"),t.protyle.scroll.lastScrollTop=0,Qn(t.protyle),_("/api/filetree/getDoc",{id:e,mode:0,size:g.SIZE_GET_MAX},n=>{qe({data:n,protyle:t.protyle,action:n.data.rootID===n.data.id?[g.CB_GET_HTML]:[g.CB_GET_ALL,g.CB_GET_HTML]})})},Ta=t=>`<li data-id="${t.id}" data-name="${On(t.name)}" class="b3-list-item b3-list-item--narrow${H()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${$e(t.name)}</span>
    <span class="b3-list-item__meta">${t.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${H()?" fn__none":""}">${t.updated}</span>
</li>`,$a=(t,e)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")==="makeCard")return Y(["dialog"]),!0}),_("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(s=>{a+=Ta(s)});const i=new be({width:H()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});i.element.setAttribute("data-key","makeCard"),i.element.addEventListener("click",s=>{let l=s.target;for(;l&&!l.isSameNode(i.element);){const o=l.getAttribute("data-type");if(o==="create"){let r="";const c=i.element.querySelector(".b3-text-field");c.value?(r&&je(r),_("/api/riff/createRiffDeck",{name:c.value},u=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",Ta(u.data)),c.value=""})):(r=oe(window.siyuan.languages._kernel[142]),c.focus()),s.stopPropagation(),s.preventDefault();break}else if(o==="add"){_("/api/riff/addRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:e},r=>{l.parentElement.outerHTML=Ta(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(o==="remove"){_("/api/riff/removeRiffCards",{deckID:l.parentElement.getAttribute("data-id"),blockIDs:e},r=>{l.parentElement.outerHTML=Ta(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(o==="delete"){Te(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDelete} <b>${$e(l.parentElement.getAttribute("data-name"))}</b>?`,()=>{_("/api/riff/removeRiffDeck",{deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.remove()})}),s.stopPropagation(),s.preventDefault();break}else if(o==="view"){Ca(t,l.parentElement.getAttribute("data-id"),l.parentElement.getAttribute("data-name"),"",r=>{l.parentElement.outerHTML=Ta(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(o==="viewall"){Ca(t,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(o==="rename"){const r=new be({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),c=r.element.querySelector("input"),u=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{u[1].click()}),c.value=l.parentElement.getAttribute("data-name"),c.focus(),c.select(),u[0].addEventListener("click",()=>{r.destroy()}),u[1].addEventListener("click",()=>{_("/api/riff/renameRiffDeck",{name:c.value,deckID:l.parentElement.getAttribute("data-id")},()=>{l.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,l.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}l=l.parentElement}})})},ss=(t,e)=>{let n=!0;const a=[];e.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),a.push(i.getAttribute("data-node-id")),(i.getAttribute(g.CUSTOM_RIFF_DECKS)||"").indexOf(g.QUICK_DECK_ID)===-1&&(n=!1))}),n?F(t,[{action:"removeFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}]):F(t,[{action:"addFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}])},xo=t=>{window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const e=new be({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{_("/api/block/transferBlockRef",{fromID:t,toID:n.value}),e.destroy()})}}).element)};var bd=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())}),hd=(t,e,n)=>(e=t[Symbol.asyncIterator],n=(a,i)=>(i=t[a])&&(e[a]=s=>new Promise((l,o,r)=>(s=i.call(t,s),r=s.done,Promise.resolve(s.value).then(c=>l({value:c,done:r}),o)))),e?e.call(t):(t=t[Symbol.iterator](),e={},n("next"),n("return"),e));class wd{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-gutters",/Mac/.test(navigator.platform)||navigator.platform==="iPhone"?this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip):this.element.setAttribute("aria-label",window.siyuan.languages.gutterTip.replace("\u2325\u2318A","Ctrl+Alt+A").replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+")),this.element.setAttribute("data-type","a"),this.element.setAttribute("data-position","right"),this.element.addEventListener("dragstart",n=>{Cn();let a=[n.target.getAttribute("data-node-id")];const i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");i.length>0&&(a=[],i.forEach(s=>{a.push(s.getAttribute("data-node-id"))})),i.length===0&&n.dataTransfer.setDragImage(e.wysiwyg.element.querySelector(`[data-node-id="${a[0]}"]`),0,0),n.target.style.opacity="0.1",window.siyuan.dragElement=e.wysiwyg.element,n.dataTransfer.setData(`${g.SIYUAN_DROP_GUTTER}${n.target.getAttribute("data-type")}${g.ZWSP}${n.target.getAttribute("data-subtype")}${g.ZWSP}${a}`,e.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{const a=Je(n.target,"BUTTON");if(!a)return;n.preventDefault(),n.stopPropagation();const i=a.getAttribute("data-node-id");if(!i){if(a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");let s;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${(a.previousElementSibling||a.nextElementSibling).getAttribute("data-node-id")}"]`)).find(l=>{if(!A(l.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(l))return s=l,!0}),!s)return;if(n.altKey){let l=!0;Array.from(s.children).find(c=>{if(c.classList.contains("list")&&Array.from(c.children).find(d=>{if(d.classList.contains("li")&&d.getAttribute("fold")!=="1"&&d.childElementCount>3)return l=!1,!0}))return!0});const o=[],r=[];Array.from(s.children).forEach(c=>{c.classList.contains("list")&&Array.from(c.children).forEach(u=>{if(u.classList.contains("li")){l?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const d=u.getAttribute("data-node-id");o.push({action:"setAttrs",id:d,data:JSON.stringify({fold:l?"0":"1"})}),r.push({action:"setAttrs",id:d,data:JSON.stringify({fold:l?"1":"0"})})}})}),F(e,o,r),a.removeAttribute("disabled")}else{const l=at(e,s);l==="1"?a.firstElementChild.style.transform="":l==="0"&&(a.firstElementChild.style.transform="rotate(90deg)")}Y(["select"],e),window.siyuan.menus.menu.remove();return}if(n.ctrlKey||n.metaKey)mt({protyle:e,id:i});else if(n.altKey){let s;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(l=>{if(!A(l.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(l))return s=l,!0}),!s)return;if(a.getAttribute("data-type")==="NodeListItem"&&s.parentElement.getAttribute("data-node-id")){let l=!0;Array.from(s.parentElement.children).find(c=>{if(c.classList.contains("li")&&c.getAttribute("fold")!=="1"&&c.childElementCount>3)return l=!1,!0});const o=[],r=[];Array.from(s.parentElement.children).find(c=>{if(c.classList.contains("li")){l?c.removeAttribute("fold"):c.childElementCount>3&&c.setAttribute("fold","1");const u=c.getAttribute("data-node-id");o.push({action:"setAttrs",id:u,data:JSON.stringify({fold:l?"0":"1"})}),r.push({action:"setAttrs",id:u,data:JSON.stringify({fold:l?"1":"0"})})}}),F(e,o,r)}else at(e,s);s.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!e.disabled?ln(e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",e):(this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=de(e.wysiwyg.element.firstElementChild)),H()?window.siyuan.menus.menu.fullscreen():(window.siyuan.menus.menu.popup({x:n.clientX-16,y:n.clientY-16,isLeft:!0}),z(e.toolbar.range)))}),this.element.addEventListener("contextmenu",n=>{const a=Je(n.target,"BUTTON");!a||e.disabled||a.getAttribute("data-type")==="fold"||(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(e,a),window.siyuan.menus.menu.popup({x:n.clientX-16,y:n.clientY-16,isLeft:!0})),n.preventDefault(),n.stopPropagation())}),this.element.addEventListener("mouseover",n=>{const a=Je(n.target,"BUTTON");if(a){if(a.getAttribute("data-type")==="fold"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(i=>{i.classList.remove("protyle-wysiwyg--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a.getAttribute("data-node-id")}"]`)).find(i=>{if(!A(i.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(i))return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(s=>{i.isSameNode(s)||s.classList.remove("protyle-wysiwyg--hl")}),i.classList.add("protyle-wysiwyg--hl"),!0}),n.preventDefault()}}),this.element.addEventListener("mouseleave",n=>{Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")}),n.preventDefault(),n.stopPropagation()})}isMatchNode(e){const n=e.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+4;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){return bd(this,null,function*(){var n,a;if(e.nodeElement.querySelector("wbr")||(n=$(e.nodeElement))==null||n.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")try{for(var i=hd(e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')),s,l,o;s=!(l=yield i.next()).done;s=!1){const f=l.value,p=f.getAttribute("data-node-id");f.removeAttribute("fold");const b=yield Dt("/api/transactions",{session:e.protyle.id,app:g.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:p}],undoOperations:[{action:"foldHeading",id:p}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:p}],[{action:"foldHeading",id:p}]),f.insertAdjacentHTML("afterend",b.data[0].doOperations[0].retData)}}catch(f){o=[f]}finally{try{s&&(l=i.return)&&(yield l.call(i))}finally{if(o)throw o[0]}}const r=e.nodeElement.outerHTML,c=(a=e.nodeElement.previousElementSibling)==null?void 0:a.getAttribute("data-node-id"),u=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,d=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=d,e.type==="CancelList"||e.type==="CancelBlockquote"){const f=document.createElement("template");f.innerHTML=d;const p=[{action:"delete",id:e.id}],b=[];let m=c;Array.from(f.content.children).forEach(h=>{const w=h.getAttribute("data-node-id");p.push({action:"insert",data:h.outerHTML,id:w,previousID:m,parentID:u}),b.push({action:"delete",id:w}),m=w}),b.push({action:"insert",data:r,id:e.id,previousID:c,parentID:u}),F(e.protyle,p,b)}else j(e.protyle,e.id,d,r);re(e.protyle.wysiwyg.element,de(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(f=>{f.textContent===""&&_("/api/block/getRefText",{id:f.getAttribute("data-id")},p=>{f.innerHTML=p.data})}),Se(e.protyle,e.protyle.wysiwyg.element),Oe(e.protyle.wysiwyg.element),Ae(e.protyle.wysiwyg.element),Ye(e.protyle.wysiwyg.element,e.protyle)})}}}turnsIntoOne(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){ji(e)}}}turnsInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){on(e)}}}showMobileAppearance(e){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const i=e.contentElement.scrollTop+333.5;_l(e,n),Hi(i)}renderMultipleMenu(e,n){var a;let i=!1,s=!1,l=!1;if(n.find((u,d)=>{if(u.classList.contains("li"))return i=!0,!0;if((u.classList.contains("bq")||u.classList.contains("sb")||u.classList.contains("p"))&&(l=!0),u.nextElementSibling&&n[d+1]&&u.nextElementSibling.isSameNode(n[d+1]))s=!0;else if(d!==n.length-1)return s=!1,!0}),!i&&!e.disabled){const u=[];s&&(u.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:n,type:"Blocks2ULs"})),u.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:n,type:"Blocks2OLs"})),u.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:n,type:"Blocks2TLs"})),u.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:n,type:"Blocks2Blockquote"}))),l||u.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:n,type:"Blocks2Ps",isContinue:s})),u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:s})),u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:s})),window.siyuan.menus.menu.append(new T({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),s&&window.siyuan.menus.menu.append(new T({icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}e.disabled||mo(n,e);const o=[{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){if(q(n[0])){let u="";n.forEach(d=>{u+=nn(d)}),Pe(e.lute.BlockDOM2StdMd(u).trimEnd())}else z(de(n[0])),document.execCommand("copy")}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let u="";n.forEach(d=>{d.querySelectorAll("[spellcheck]").forEach(f=>{const p=f.cloneNode(!0);p.querySelectorAll('[data-type="backslash"]').forEach(b=>{b.firstElementChild.remove()}),u+=p.textContent+`
`})}),Ua(u.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){qi(n,e)}}],r=this.genCopyTextRef(n);if(r&&o.splice(2,0,r),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),e.disabled)return;window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var u;if(q(n[0])){let d="";n.forEach(f=>{d+=nn(f)}),Pe(e.lute.BlockDOM2StdMd(d).trimEnd()),(u=e.breadcrumb)==null||u.hide(),bt(e,n[0],de(n[0]))}else z(de(n[0])),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{Rn(u=>{po(u[0],n,e)})}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var u;(u=e.breadcrumb)==null||u.hide(),bt(e,n[0],de(n[0]))}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element);const c=new T({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(e)}}).element;return window.siyuan.menus.menu.append(c),H()||c.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,e),this.genWidths(n,e),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){ss(e,n)}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){const u=[];n.forEach(d=>{d.getAttribute("data-type")!=="NodeThematicBreak"&&u.push(d.getAttribute("data-node-id"))}),$a(e.app,u)}}).element),(a=e==null?void 0:e.app)!=null&&a.plugins&&ft({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(e,n){var a,i;if(!n)return;Y(["util","toolbar","hint"],e),window.siyuan.menus.menu.remove(),H()&&$t();const s=n.getAttribute("data-node-id"),l=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(l.length>1&&Array.from(l).find(m=>{if(s===m.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(e,Array.from(l));let o;if(n.tagName==="BUTTON"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${s}"]`)).find(b=>{if(!A(b.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(b))return o=b,!0}):o=n,!o)return;const r=o.getAttribute("data-type"),c=o.getAttribute("data-subtype"),u=[];Y(["select"],e),o.classList.add("protyle-wysiwyg--select"),Fe([s],e.block.rootID),r==="NodeParagraph"&&!e.disabled?(u.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:[o],type:"Blocks2ULs"})),u.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:[o],type:"Blocks2OLs"})),u.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:[o],type:"Blocks2TLs"})),u.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:[o],type:"Blocks2Blockquote"})),u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[o],level:1,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[o],level:2,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[o],level:3,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[o],level:4,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[o],level:5,type:"Blocks2Hs"})),u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeHeading"&&!e.disabled?(u.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[o],level:6,type:"Blocks2Ps"})),c!=="h1"&&u.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[o],level:1,type:"Blocks2Hs"})),c!=="h2"&&u.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[o],level:2,type:"Blocks2Hs"})),c!=="h3"&&u.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[o],level:3,type:"Blocks2Hs"})),c!=="h4"&&u.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[o],level:4,type:"Blocks2Hs"})),c!=="h5"&&u.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[o],level:5,type:"Blocks2Hs"})),c!=="h6"&&u.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[o],level:6,type:"Blocks2Hs"}))):r==="NodeList"&&!e.disabled?(u.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:o,id:s,type:"CancelList"})),o.getAttribute("data-subtype")==="o"?(u.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:o,id:s,type:"OL2UL"})),u.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:o,id:s,type:"UL2TL"}))):o.getAttribute("data-subtype")==="t"?(u.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:o,id:s,type:"TL2UL"})),u.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:o,id:s,type:"TL2OL"}))):(u.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:o,id:s,type:"UL2OL"})),u.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:o,id:s,type:"OL2TL"})))):r==="NodeBlockquote"&&!e.disabled&&u.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:o,id:s,type:"CancelBlockquote"})),u.length>0&&!e.disabled&&window.siyuan.menus.menu.append(new T({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:u}).element),!e.disabled&&!o.classList.contains("hr")&&mo([o],e);const d=ma(s,!0,o).concat([{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){q(o)?Pe(e.lute.BlockDOM2StdMd(nn(o)).trimEnd()):(z(de(o)),document.execCommand("copy"))}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let b="";o.querySelectorAll("[spellcheck]").forEach(m=>{const h=m.cloneNode(!0);h.querySelectorAll('[data-type="backslash"]').forEach(w=>{w.firstElementChild.remove()}),b+=h.textContent+`
`}),Ua(b.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){qi([o],e)}}]),f=this.genCopyTextRef([o]);if(f&&d.splice(d.length-1,0,f),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:d}).element),e.disabled||(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{var b;q(o)?(Pe(e.lute.BlockDOM2StdMd(nn(o)).trimEnd()),bt(e,o,de(o)),(b=e.breadcrumb)==null||b.hide()):(z(de(o)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{Rn(b=>{po(b[0],[o],e)})}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{var b;(b=e.breadcrumb)==null||b.hide(),bt(e,o,de(o))}}).element)),r==="NodeSuperBlock"&&!e.disabled)window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const b=Fn(e,o);F(e,b.doOperations,b.undoOperations),ce(e.wysiwyg.element.querySelector(`[data-node-id="${b.previousId}"]`)),Y(["gutter"],e)}}).element);else if(r==="NodeCodeBlock"&&!e.disabled&&!o.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new T({type:"separator"}).element);const b=o.getAttribute("linewrap"),m=o.getAttribute("ligatures"),h=o.getAttribute("linenumber");window.siyuan.menus.menu.append(new T({type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.codeLineWrap&&b!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",y=>{const E=w.querySelector("input");y.target.tagName!=="INPUT"&&(E.checked=!E.checked),o.setAttribute("linewrap",E.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),Ae(o),_("/api/attr/setBlockAttrs",{id:s,attrs:{linewrap:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${m==="true"||window.siyuan.config.editor.codeLigatures&&m!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",y=>{const E=w.querySelector("input");y.target.tagName!=="INPUT"&&(E.checked=!E.checked),o.setAttribute("ligatures",E.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),Ae(o),_("/api/attr/setBlockAttrs",{id:s,attrs:{ligatures:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&h!=="false"?" checked":""}></div>`,bind(w){w.addEventListener("click",y=>{const E=w.querySelector("input");y.target.tagName!=="INPUT"&&(E.checked=!E.checked),o.setAttribute("linenumber",E.checked.toString()),o.querySelector(".hljs").removeAttribute("data-render"),Ae(o),_("/api/attr/setBlockAttrs",{id:s,attrs:{linenumber:E.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeCodeBlock"&&!e.disabled&&["echarts","mindmap"].includes(o.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new T({type:"separator"}).element);const b=o.style.height;let m=o.outerHTML;window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${b?parseInt(b):"420"}">`,bind:h=>{h.querySelector("input").addEventListener("change",w=>{const y=(w.target.value||"420")+"px";o.style.height=y,o.firstElementChild.nextElementSibling.style.height=y,j(e,s,o.outerHTML,m),m=o.outerHTML,w.stopPropagation();const E=window.echarts.getInstanceById(o.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));E&&E.resize()})}},{label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,o)}}]}).element)}else if(r==="NodeTable"&&!e.disabled){let b=de(o);const m=o.querySelector("table");m.contains(b.startContainer)||(b=de(m.querySelector("th")));const h=R(b.startContainer,"TD")||R(b.startContainer,"TH");h&&(window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:oc(e,o,h,b)}).element))}else if((r==="NodeVideo"||r==="NodeAudio")&&!e.disabled)window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"assetSubMenu",type:"submenu",icon:r==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:lc(e,o,r)}).element);else if(r==="NodeIFrame"&&!e.disabled)window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({id:"assetSubMenu",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:sc(e,o)}).element);else if(r==="NodeHTMLBlock"&&!e.disabled)window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,o)}}).element);else if(r==="NodeBlockQueryEmbed"&&!e.disabled){window.siyuan.menus.menu.append(new T({type:"separator"}).element);const b=o.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new T({id:"assetSubMenu",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){o.removeAttribute("data-render"),Se(e,o)}},{icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,o)}},{type:"separator"},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${b==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&b!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",h=>{const w=m.querySelector("input");h.target.tagName!=="INPUT"&&(w.checked=!w.checked),o.setAttribute("breadcrumb",w.checked.toString()),_("/api/attr/setBlockAttrs",{id:s,attrs:{breadcrumb:w.checked.toString()}}),o.removeAttribute("data-render"),Se(e,o),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${o.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(m){m.addEventListener("click",h=>{const w=m.querySelector("input");h.target.tagName!=="INPUT"&&(w.checked=!w.checked),o.setAttribute("custom-heading-mode",w.checked?"1":"0"),_("/api/attr/setBlockAttrs",{id:s,attrs:{"custom-heading-mode":w.checked?"1":"0"}}),o.removeAttribute("data-render"),Se(e,o),window.siyuan.menus.menu.remove()})}}]}).element)}else if(r==="NodeHeading"&&!e.disabled){window.siyuan.menus.menu.append(new T({type:"separator"}).element);const b=[];c!=="h1"&&b.push(this.genHeadingTransform(e,s,1)),c!=="h2"&&b.push(this.genHeadingTransform(e,s,2)),c!=="h3"&&b.push(this.genHeadingTransform(e,s,3)),c!=="h4"&&b.push(this.genHeadingTransform(e,s,4)),c!=="h5"&&b.push(this.genHeadingTransform(e,s,5)),c!=="h6"&&b.push(this.genHeadingTransform(e,s,6)),window.siyuan.menus.menu.append(new T({type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:b}).element),window.siyuan.menus.menu.append(new T({icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){_("/api/block/getHeadingChildrenDOM",{id:s},m=>{Pe(m.data+g.ZWSP)})}}).element),window.siyuan.menus.menu.append(new T({icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){_("/api/block/getHeadingChildrenDOM",{id:s},m=>{Pe(m.data+g.ZWSP),_("/api/block/getHeadingDeleteTransaction",{id:s},h=>{h.data.doOperations.forEach(w=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${w.id}"]`).forEach(y=>{y.remove()})}),F(e,h.data.doOperations,h.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){_("/api/block/getHeadingDeleteTransaction",{id:s},m=>{m.data.doOperations.forEach(h=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${h.id}"]`).forEach(w=>{w.remove()})}),F(e,m.data.doOperations,m.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new T({type:"separator"}).element),e.options.backlinkData||(window.siyuan.menus.menu.append(new T({accelerator:`${De(window.siyuan.config.keymap.general.enter.custom)}/${De("\u2318Click")}`,label:window.siyuan.languages.enter,click:()=>{mt({protyle:e,id:s})}}).element),window.siyuan.menus.menu.append(new T({accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{Fi(e,s)}}).element)),!e.disabled){window.siyuan.menus.menu.append(new T({icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){Y(["select"],e),Fe([],e.block.rootID),vt(e,"beforebegin",s)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){Y(["select"],e),Fe([],e.block.rootID),vt(e,"afterend",s)}}).element);const b=o.lastElementChild.querySelector(".protyle-attr--refcount");b&&b.textContent&&xo(s)}if(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){Y(["select"],e),Os(e,o)}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.fold,accelerator:`${De(window.siyuan.config.keymap.editor.general.collapse.custom)}/${De("\u2325Click")}`,click(){at(e,o),ce(o)}}).element),e.disabled||window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+De("\u21E7Click"),click(){ln(o,"bookmark",e)}}).element)),!e.disabled){const b=new T({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{this.showMobileAppearance(e)}}).element;window.siyuan.menus.menu.append(b),H()||b.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([o],e),this.genWidths([o],e)}window.siyuan.menus.menu.append(new T({type:"separator"}).element),!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(r)&&((a=$(o))==null?void 0:a.textContent.trim())!==""&&(r!=="NodeCodeBlock"||r==="NodeCodeBlock"&&!o.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){zr(o)}}).element),r!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){ss(e,[o])}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){$a(e.app,[o.getAttribute("data-node-id")])}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element)),(i=e==null?void 0:e.app)!=null&&i.plugins&&ft({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:[o]},separatorPosition:"bottom"});let p=o.getAttribute("updated")||"";return p&&(p=`${window.siyuan.languages.modifiedAt} ${ee(p).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,type:"readonly",label:`${p}${window.siyuan.languages.createdAt} ${ee(s.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(e,n,a){return{iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){_("/api/block/getHeadingLevelTransaction",{id:n,level:a},i=>{i.data.doOperations.forEach((s,l)=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(o=>{o.outerHTML=s.data}),e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(o=>{en(o)}),l===0&&ce(e.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),e.wysiwyg.element,!0)}),F(e,i.data.doOperations,i.data.undoOperations)})}}}genClick(e,n,a){va(e,n,a),ce(e[0])}genAlign(e,n){window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.layout,type:"submenu",submenu:[{label:window.siyuan.languages.alignLeft,icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?(a.style.margin="",Ct(a)):a.style.textAlign="left"})}},{label:window.siyuan.languages.alignCenter,icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?(a.style.margin="0 auto",Ct(a)):a.style.textAlign="center"})}},{label:window.siyuan.languages.alignRight,icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?(a.style.margin="0 0 0 auto",Ct(a)):a.style.textAlign="right"})}},{label:window.siyuan.languages.justify,icon:"iconMenu",click:()=>{this.genClick(e,n,a=>{a.style.textAlign="justify"})}},{type:"separator"},{label:window.siyuan.languages.ltr,icon:"iconLtr",click:()=>{this.genClick(e,n,a=>{a.style.direction="ltr"})}},{label:window.siyuan.languages.rtl,icon:"iconRtl",click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?(a.style.margin="",Ct(a)):(a.style.textAlign="",a.style.direction="")})}}]}).element)}genWidths(e,n){const a=[];["25%","33%","50%","67%","75%"].forEach(s=>{a.push({label:s,click:()=>{this.genClick(e,n,l=>{l.style.width=s,l.style.flex="none",Ct(l)})}})}),a.push({type:"separator"});let i=100;if(e.length===1){const s=e[0].style.width;s.endsWith("%")&&(i=parseInt(s))}window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.width,submenu:a.concat([{label:`<div aria-label="${i}%" class="b3-tooltips b3-tooltips__n${H()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${i}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(s){const l=s.querySelector("input");l.addEventListener("input",()=>{e.forEach(c=>{c.style.width=l.value+"%",c.style.flex="none"}),l.parentElement.setAttribute("aria-label",`${l.value}%`)});const o=[],r=[];e.forEach(c=>{o.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML})}),l.addEventListener("change",()=>{e.forEach(c=>{r.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML}),Ct(c)}),F(n,r,o),window.siyuan.menus.menu.remove(),ce(e[0])})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,n,s=>{s.style.width&&(s.style.width="",s.style.flex="",Ct(s))})}}])}).element)}genCopyTextRef(e){return q(e[0])?!1:{accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){e[0].setAttribute("data-reftext","true"),z(de(e[0])),document.execCommand("copy")}}}render(e,n,a){var i;const s=a.parentElement.querySelector(".protyle-title__input");if(s&&s.getAttribute("data-render")!=="true")return;const l=a.parentElement.parentElement.querySelector(".protyle-select");if(l&&!l.classList.contains("fn__none"))return;let o="",r=n,c=0,u=0,d,f=!1;for(;r;){const y=!f||f&&r.getAttribute("fold")==="1";if(!A(r.parentElement,"data-type","NodeBlockQueryEmbed")){let x;if(y&&(x=r.getAttribute("data-type")),u===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(x))return;const C=he(r);d=C.querySelector(".li")||C.querySelector(".list"),A(d,"data-type","NodeBlockQueryEmbed")&&(d=void 0),!C.isSameNode(r)&&x!=="NodeHeading"&&(r=C,x=r.getAttribute("data-type"))}x==="NodeListItem"&&u===1&&!y&&(o=""),u+=1,y&&(o=`<button ${e.disabled?"":'draggable="true"'} data-type="${x}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${_t(x,r.getAttribute("data-subtype"))}"></use></svg></button>`+o);let k="";if(x==="NodeListItem"&&r.childElementCount>3||x==="NodeHeading"){const C=r.getAttribute("fold");k=`<button data-type="fold"><svg style="width:10px${C&&C==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(x==="NodeListItem"||x==="NodeList")&&(d=r,x==="NodeListItem"&&r.childElementCount>3&&(o=`<button ${e.disabled?"":'draggable="true"'} data-type="${x}"  data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}"><svg><use xlink:href="#${_t(x,r.getAttribute("data-subtype"))}"></use></svg></button>${k}`)),x==="NodeHeading"&&(o=o+k),x==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(f=!0)}const S=I(r.parentElement);if(S)r=S;else break}let p=!0;const b=this.element.querySelectorAll("button");if(b.length!==o.split("</button>").length-1?p=!1:b.forEach(y=>{const E=y.getAttribute("data-node-id");E&&o.indexOf(E)===-1&&(p=!1)}),p&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=o,this.element.classList.remove("fn__none"),this.element.style.width="";let m=n.getBoundingClientRect(),h=0;if(d?(m=d.firstElementChild.getBoundingClientRect(),c=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(m=r.getBoundingClientRect(),c=0):(m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||m.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&m.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8)&&(h=(m.height-this.element.clientHeight)/2),r.getAttribute("data-type")==="NodeAttributeView"){const y=r.querySelector(".item__graphic");y?this.element.style.top=`${Math.max(y.getBoundingClientRect().top-(window.siyuan.config.editor.fontSize*1.625-14)/2,a.parentElement.getBoundingClientRect().top)}px`:this.element.style.top=`${Math.max(m.top,a.parentElement.getBoundingClientRect().top)+8}px`}else this.element.style.top=`${Math.max(m.top,a.parentElement.getBoundingClientRect().top)+h}px`;let w=m.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1?w=r.getBoundingClientRect().left-this.element.clientWidth-c:r.getAttribute("data-type")==="NodeAttributeView"&&(w=w+(parseInt((i=r.firstElementChild.firstElementChild)==null?void 0:i.style.paddingLeft)||0)),this.element.style.left=`${w}px`,w<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${m.left-this.element.clientWidth-c/2+3}px`,o="",Array.from(this.element.children).reverse().forEach((y,E)=>{E!==0&&(y.firstElementChild.style.height="14px"),o+=y.outerHTML}),this.element.innerHTML=o):this.element.querySelectorAll("svg").forEach(y=>{y.style.height=""})}}class yd{constructor(e){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let n;if(typeof AudioContext!="undefined")n=new AudioContext;else if(webkitAudioContext)n=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=n.sampleRate;const a=n.createGain();n.createMediaStreamSource(e).connect(a),this.recorder=n.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(n.destination),this.readyFlag=!0}cloneChannelData(e,n){this.leftChannel.push(new Float32Array(e)),this.rightChannel.push(new Float32Array(n)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const e=this.mergeBuffers(this.leftChannel),n=this.mergeBuffers(this.rightChannel);let a=new Float32Array(e.length);for(let d=0;d<e.length;++d)a[d]=.5*(e[d]+n[d]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const i=44+a.length*2,s=new ArrayBuffer(i),l=new DataView(s);this.writeUTFBytes(l,0,"RIFF"),l.setUint32(4,i,!0),this.writeUTFBytes(l,8,"WAVE"),this.writeUTFBytes(l,12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,1,!0),l.setUint32(24,this.SAMPLE_RATE,!0),l.setUint32(28,this.SAMPLE_RATE*2,!0),l.setUint16(32,2,!0),l.setUint16(34,16,!0);const o=a.length*2;this.writeUTFBytes(l,36,"data"),l.setUint32(40,o,!0);const r=a.length;let c=44;const u=1;for(let d=0;d<r;d++)l.setInt16(c,a[d]*(32767*u),!0),c+=2;return new Blob([l],{type:"audio/wav"})}downSampleBuffer(e,n){if(n===this.DEFAULT_SAMPLE_RATE||n>this.DEFAULT_SAMPLE_RATE)return e;const a=this.DEFAULT_SAMPLE_RATE/n,i=Math.round(e.length/a),s=new Float32Array(i);let l=0,o=0;for(;l<s.length;){const r=Math.round((l+1)*a);let c=0,u=0;for(let d=o;d<r&&d<e.length;d++)c+=e[d],u++;s[l]=c/u,l++,o=r}return s}mergeBuffers(e){const n=new Float32Array(this.recordingLength);let a=0;const i=e.length;for(let s=0;s<i;++s){const l=e[s];n.set(l,a),a+=l.length}return n}writeUTFBytes(e,n,a){const i=a.length;for(let s=0;s<i;s++)e.setUint8(n+s,a.charCodeAt(s))}}const So=(t,e)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){_("/api/filetree/removeDoc",{notebook:t,path:e});return}_("/api/block/getDocInfo",{id:ze(e,!0,!0)},n=>{const a=$e(n.data.name);let i=`${window.siyuan.languages.confirmDelete} <b>${a}</b>?`;n.data.subFileCount>0&&(i=`${window.siyuan.languages.confirmDelete} <b>${a}</b> ${window.siyuan.languages.andSubFile.replace("x",n.data.subFileCount)}?`),Te(window.siyuan.languages.deleteOpConfirm,i,()=>{_("/api/filetree/removeDoc",{notebook:t,path:e})})})},ls=t=>{if(t.length===1){const e=wt(t[0],"UL");if(e){const n=e.getAttribute("data-url");t[0].getAttribute("data-type")==="navigation-file"?So(n,t[0].getAttribute("data-path")):Te(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${Lute.EscapeHTMLStr(At(n))}</b>?`,()=>{_("/api/notebook/removeNotebook",{notebook:n,callback:g.CB_MOUNT_REMOVE})})}}else{const e=[];if(t.forEach(n=>{n.getAttribute("data-path")!=="/"&&e.push(n.getAttribute("data-path"))}),e.length===0){oe(window.siyuan.languages.notBatchRemove);return}Te(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmRemoveAll.replace("${count}",e.length),()=>{_("/api/filetree/removeDocs",{paths:e})})}},_d=t=>{let e;return e=`<div class="toolbar toolbar--border">
    <svg class="toolbar__icon"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="fn__flex-1 fn__flex-center toolbar__text">${window.siyuan.languages.riffCard}</span>
    <div data-type="count" class="${t.blocks.length===0?"fn__none":""}">1/${t.blocks.length}</span></div>
    <svg class="toolbar__icon" data-id="${t.id||""}" data-cardtype="${t.cardType}" data-type="filter"><use xlink:href="#iconFilter"></use></svg>
    <svg class="toolbar__icon" data-type="close"><use xlink:href="#iconCloseRound"></use></svg>
</div>`,`<div class="card__main">
    ${e}
    <div class="card__block fn__flex-1 ${t.blocks.length===0?"fn__none":""} 
${window.siyuan.config.flashcard.mark?"card__block--hidemark":""} 
${window.siyuan.config.flashcard.superBlock?"card__block--hidesb":""} 
${window.siyuan.config.flashcard.heading?"card__block--hideh":""} 
${window.siyuan.config.flashcard.list?"card__block--hideli":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${t.blocks.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action${t.blocks.length===0?" fn__none":""}">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            (p)
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer} (${window.siyuan.languages.space})</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <span>${window.siyuan.languages.nextRound}</span>
            <button data-type="-3" aria-label="0" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div>\u{1F4A4}</div>
                ${window.siyuan.languages.skip} (0)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div>\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain} (1)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div>\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard} (2)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div>\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood} (3)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ;" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div>\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy} (4)
            </button>
        </div>
    </div>
</div>`},vd=t=>{let e=0;const n=new un(t.app,t.element.querySelector("[data-type='render']"),{blockId:"",action:[g.CB_GET_ALL],render:{background:!1,title:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),t.blocks.length>0&&_("/api/filetree/getDoc",{id:t.blocks[e].blockID,mode:0,size:g.SIZE_GET_MAX},o=>{qe({data:o,protyle:n.protyle,action:o.data.rootID===o.data.id?[g.CB_GET_HTML]:[g.CB_GET_ALL,g.CB_GET_HTML]})}),t.element.setAttribute("data-key",window.siyuan.config.keymap.general.riffCard.custom);const a=t.element.querySelector('[data-type="count"]'),i=t.element.querySelectorAll(".card__action"),s=t.element.querySelector('[data-type="filter"]'),l=()=>{const o=s.getAttribute("data-cardtype");_(o==="all"?"/api/riff/getRiffDueCards":o==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:s.getAttribute("data-id"),deckID:s.getAttribute("data-id"),notebook:s.getAttribute("data-id")},r=>{e=0,t.blocks=r.data.cards,t.blocks.length>0?oi({countElement:a,editor:n,actionElements:i,index:e,blocks:t.blocks}):Ao(a,n,i)})};return t.element.addEventListener("click",o=>{const r=o.target;let c="";if(typeof o.detail=="string")o.detail==="1"||o.detail==="j"?c="1":o.detail==="2"||o.detail==="k"?c="2":o.detail==="3"||o.detail==="l"?c="3":o.detail==="4"||o.detail===";"?c="4":o.detail===" "?c="-1":o.detail==="p"?c="-2":o.detail==="0"&&(c="-3");else{if(A(r,"data-type","fullscreen")){ac(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]')),ua(n.protyle),o.stopPropagation(),o.preventDefault();return}if(A(r,"data-type","close")){t.dialog&&t.dialog.destroy(),o.stopPropagation(),o.preventDefault();return}const f=A(r,"data-type","filter");if(f){_("/api/riff/getRiffDecks",{},b=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),l()}}).element),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:window.siyuan.languages.fileTree,click(){Rn((h,w)=>{s.setAttribute("data-id",h[0]==="/"?w[0]:ze(h[0],!0,!0)),s.setAttribute("data-cardtype",h[0]==="/"?"notebook":"doc"),l()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(t.title||b.data.length>0)&&window.siyuan.menus.menu.append(new T({type:"separator"}).element),t.title&&(window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:$e(t.title),click(){s.setAttribute("data-id",t.id),s.setAttribute("data-cardtype",t.cardType),l()}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element)),b.data.forEach(h=>{window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,label:$e(h.name),click(){s.setAttribute("data-id",h.id),s.setAttribute("data-cardtype","all"),l()}}).element)});const m=f.getBoundingClientRect();window.siyuan.menus.menu.popup({x:m.left,y:m.bottom})}),o.stopPropagation(),o.preventDefault();return}if(A(r,"data-type","newround")){l(),o.stopPropagation(),o.preventDefault();return}}if(!c){const u=N(r,"b3-button");u&&(c=u.getAttribute("data-type"))}if(!(!c||!t.blocks[e])){if(o.preventDefault(),o.stopPropagation(),Y(["toolbar","hint","util"],n.protyle),c==="-1"){if(i[0].classList.contains("fn__none"))return;n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),i[0].classList.add("fn__none"),i[1].querySelectorAll(".b3-button").forEach((u,d)=>{u.previousElementSibling.textContent=t.blocks[e].nextDues[d]}),i[1].classList.remove("fn__none");return}if(c==="-2"){if(i[0].classList.contains("fn__none"))return;e>0&&(e--,oi({countElement:a,editor:n,actionElements:i,index:e,blocks:t.blocks}));return}["1","2","3","4","-3"].includes(c)&&i[0].classList.contains("fn__none")&&_(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:t.blocks[e].deckID,cardID:t.blocks[e].cardID,rating:parseInt(c),reviewedCards:t.blocks},()=>{if(c!=="-3"&&(window.siyuan.config.sync.provider!==0&&!oa("")||window.siyuan.config.sync.provider===0&&!Qt(""))&&window.siyuan.config.repo.key&&window.siyuan.config.sync.enabled&&document.getElementById("toolbarSync").classList.remove("fn__none"),e++,e>t.blocks.length-1){const u=s.getAttribute("data-cardtype");_(u==="all"?"/api/riff/getRiffDueCards":u==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:s.getAttribute("data-id"),deckID:s.getAttribute("data-id"),notebook:s.getAttribute("data-id"),reviewedCards:t.blocks},d=>{e=0,t.blocks=d.data.cards,t.blocks.length===0?d.data.unreviewedCount>0?kd(a,n,i,d.data.unreviewedCount):Ao(a,n,i):oi({countElement:a,editor:n,actionElements:i,index:e,blocks:t.blocks})});return}oi({countElement:a,editor:n,actionElements:i,index:e,blocks:t.blocks})})}}),n},Ed=t=>{_("/api/riff/getRiffDueCards",{deckID:""},e=>{li(t,e.data,"all")})},li=(t,e,n,a,i)=>{if(window.siyuan.dialogs.find(r=>{if(r.element.getAttribute("data-key")===window.siyuan.config.keymap.general.riffCard.custom)return r.destroy(),!0}))return;const l=new be({content:_d({id:a,cardType:n,blocks:e.cards,isTab:!1}),width:H()?"100vw":"80vw",height:H()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});l.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",l.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const o=vd({app:t,element:l.element,blocks:e.cards,title:i,id:a,cardType:n,dialog:l});l.editor=o},oi=t=>{t.editor.protyle.element.classList.add("card__block--hide"),window.siyuan.config.flashcard.superBlock&&t.editor.protyle.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&t.editor.protyle.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&t.editor.protyle.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&t.editor.protyle.element.classList.add("card__block--hidemark"),t.actionElements[0].classList.remove("fn__none"),t.actionElements[1].classList.add("fn__none"),t.editor.protyle.element.classList.remove("fn__none"),t.editor.protyle.element.nextElementSibling.classList.add("fn__none"),t.countElement.innerHTML=`${t.index+1}/${t.blocks.length}`,t.countElement.classList.remove("fn__none"),t.index===0?t.actionElements[0].firstElementChild.setAttribute("disabled","disabled"):t.actionElements[0].firstElementChild.removeAttribute("disabled"),_("/api/filetree/getDoc",{id:t.blocks[t.index].blockID,mode:0,size:g.SIZE_GET_MAX},e=>{qe({data:e,protyle:t.editor.protyle,action:e.data.rootID===e.data.id?[g.CB_GET_HTML]:[g.CB_GET_ALL,g.CB_GET_HTML]})})},Ao=(t,e,n)=>{t.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const a=e.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},kd=(t,e,n,a)=>{t.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const i=e.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")};let ri,Ia=!1;const os=(t,e,n)=>{const a=t.querySelector('[data-type="docprevious"]'),i=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const s=t.querySelector('.b3-select[data-type="opselect"]'),l=t.querySelector(".b3-list--background");t.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),t.querySelector('.history__text[data-type="mdPanel"]').classList.remove("fn__none"),_("/api/history/searchHistory",{query:n,page:e,op:s.value,type:3},o=>{if(e<o.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),i.nextElementSibling.nextElementSibling.textContent=`${e}/${o.data.pageCount||1}`,o.data.histories.length===0){l.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let r="";o.data.histories.forEach(c=>{r+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${c}">
    <span class="b3-list-item__text">${ee(parseInt(c)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),l.innerHTML=r})},Co=t=>{const e=`<div class="fn__flex-column" style="height: 100%;">
        <div class="block__icons">
            ${H()?"":t.pathString}
            <span class="fn__space"></span>
            <div class="fn__flex-1"></div>
            <select data-type="opselect" class="b3-select">
                <option value="all" selected>${window.siyuan.languages.allOp}</option>
                <option value="clean">clean</option>
                <option value="update">update</option>
                <option value="delete">delete</option>
                <option value="format">format</option>
                <option value="sync">sync</option>
                <option value="replace">replace</option>
            </select>
            <span class="fn__space"></span>
            <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
            <span class="fn__space"></span>
            <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
            <span class="fn__space"></span>
            <span>1/1</span>
            ${H()?'<span class="fn__space"></span><span data-type="close" class="block__icon block__icon--show"><svg><use xlink:href="#iconClose"></use></svg></span>':""}
        </div>
        <div class="fn__flex fn__flex-1 history__panel">
            <ul class="b3-list b3-list--background" style="overflow:auto;">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
            <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
            <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
        </div>
</div>`,n=new be({content:e,width:H()?"100vw":"90vw",height:H()?"100vh":"80vh",destroyCallback(){ri=void 0}}),a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{os(n.element,1,t.id)});const i=n.element.querySelector('.history__text[data-type="docPanel"]'),s=n.element.querySelector('.history__text[data-type="mdPanel"]');os(n.element,1,t.id),ri=new un(t.app,i,{blockId:"",action:[g.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),Yt(ri.protyle),n.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(n.element);){const r=o.getAttribute("data-type");if(r==="close")n.destroy();else if(r==="rollback"&&!Ia){To(o.parentElement,a.value,t.id,c=>{Ia=!1,Te("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",o.parentElement.textContent.trim())}`,()=>{_("/api/history/rollbackDocHistory",{notebook:t.notebookId,historyPath:c})})}),l.stopPropagation(),l.preventDefault();break}else if(o.classList.contains("b3-list-item")&&!Ia){To(o,a.value,t.id,c=>{var u;_("/api/history/getDocHistoryContent",{historyPath:c},d=>{d.data.isLargeDoc?(s.value=d.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),qe({data:d,protyle:ri.protyle,action:[g.CB_GET_HISTORY,g.CB_GET_HTML]})),Ia=!1}),(u=o.parentElement.querySelector(".b3-list-item--focus"))==null||u.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus")}),l.stopPropagation(),l.preventDefault();break}else if((r==="docprevious"||r==="docnext")&&o.getAttribute("disabled")!=="disabled"){const c=parseInt(n.element.getAttribute("data-page"));os(n.element,r==="docprevious"?c-1:c+1,t.id),l.stopPropagation(),l.preventDefault();break}o=o.parentElement}})},To=(t,e,n,a)=>{Ia=!0;const i=t.getAttribute("data-path");i&&a(i),_("/api/history/getHistoryItems",{query:n,op:e,type:3,created:t.getAttribute("data-created")},s=>{a(s.data.items[0].path)})},Ld=t=>{const e=`<div class="fn__flex">${$e(t.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label">
    ${window.siyuan.languages.fileTree12}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="docCreateSavePath" value="">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree5}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${t.conf.dailyNoteTemplatePath}">
</div></div>`;let a;H()?It({title:e,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){$o(document.querySelector("#model"),t)}}):(a=new be({width:"80vw",title:e,content:n}).element,$o(a,t))},$o=(t,e)=>{t.querySelector(".b3-button--small").addEventListener("click",()=>{Pe(e.box),oe(window.siyuan.languages.copied)});const n=t.querySelector("#dailyNoteSavePath");n.value=e.conf.dailyNoteSavePath;const a=t.querySelector("#docCreateSavePath");a.value=e.conf.docCreateSavePath;const i=t.querySelector("#refCreateSavePath");i.value=e.conf.refCreateSavePath;const s=t.querySelector("#dailyNoteTemplatePath");s.value=e.conf.dailyNoteTemplatePath,t.querySelectorAll("input").forEach(l=>{l.addEventListener("change",()=>{_("/api/notebook/setNotebookConf",{notebook:e.box,conf:{refCreateSavePath:i.value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:s.value}})})})};var Io=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Do=(t,e)=>{if(!Array.from(t).find(s=>{if(s.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;window.siyuan.menus.menu.append(Ii(Es(Array.from(t)))),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{ls(Array.from(t))}}).element);const a=[];if(t.forEach(s=>{const l=s.getAttribute("data-node-id");l&&a.push(l)}),a.length===0)return window.siyuan.menus.menu;window.siyuan.menus.menu.append(new T({type:"separator"}).element);const i=[{iconHTML:g.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{F(void 0,[{action:"addFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}])}},{iconHTML:g.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{F(void 0,[{action:"removeFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:a}])}}];return window.siyuan.config.flashcard.deck&&i.push({iconHTML:g.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{$a(e,a)}}),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:i}).element),e.plugins&&ft({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:t,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},Mo=(t,e)=>{window.siyuan.menus.menu.remove();const n=Je(e,"DIV");if(!n)return window.siyuan.menus.menu;e.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(l=>{l.classList.remove("b3-list-item--focus"),l.removeAttribute("select-end"),l.removeAttribute("select-start")}),e.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return Do(a,t);const i=e.parentElement.getAttribute("data-url"),s=At(i);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(ml({path:"/",notebookId:i,name:s,type:"notebook"})),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{_("/api/notebook/getNotebookConf",{notebook:i},o=>{Ld(o.data)})}}).element);const l=No("notebook",parseInt(e.parentElement.getAttribute("data-sortmode")),o=>(_("/api/notebook/setNotebookConf",{notebook:i,conf:{sortMode:o}},()=>{var r;e.parentElement.setAttribute("data-sortmode",o.toString());let c;c=window.siyuan.mobile.files;const u=e.querySelector(".b3-list-item__arrow--open");u&&(u.classList.remove("b3-list-item__arrow--open"),(r=e.nextElementSibling)==null||r.remove(),c.getLeaf(e,i))}),!0));window.siyuan.menus.menu.append(new T({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:l}).element)}return window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{iconHTML:g.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{_("/api/riff/getNotebookRiffDueCards",{notebook:i},l=>{li(t,l.data,"notebook",i,s)}),Be()}},{iconHTML:g.ZWSP,label:window.siyuan.languages.manage,click:()=>{Ca(t,i,s,"Notebook"),Be()}}]}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){const l=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(t,{removed:l.removed,sort:l.sort,group:l.group,hasReplace:!1,method:l.method,hPath:At(i),idPath:[i],k:l.k,r:l.r,page:1,types:Object.assign({},l.types)})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){const l=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(t,{removed:l.removed,sort:l.sort,group:l.group,hasReplace:!0,method:l.method,hPath:At(i),idPath:[i],k:l.k,r:l.r,page:1,types:Object.assign({},l.types)})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.close,icon:"iconClose",click:()=>{_("/api/notebook/closeNotebook",{notebook:i})}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{ls(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new T({type:"separator"}).element),rs(i,"/"),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:"Markdown",icon:"iconMarkdown",click:()=>{const l=oe(window.siyuan.languages.exporting,-1);_("/api/export/batchExportMd",{notebook:i,path:"/"},o=>{je(l),window.open(o.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const l=oe(window.siyuan.languages.exporting,-1);_("/api/export/exportNotebookSY",{id:i},o=>{je(l),window.open(o.data.zip)})}}]}).element),t.plugins&&ft({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},Ho=(t,e,n,a)=>{window.siyuan.menus.menu.remove();const i=Je(a,"DIV");if(!i)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(i.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const s=i.querySelectorAll(".b3-list-item--focus");if(s.length>1)return Do(s,t);const l=a.getAttribute("data-node-id");let o=a.getAttribute("data-name");if(o=ze(o,!1,!0),!window.siyuan.config.readonly){let r,c;window.siyuan.config.fileTree.sort===6&&(window.siyuan.menus.menu.append(new T({icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const d=[];Array.from(a.parentElement.children).forEach(f=>{f.tagName==="LI"&&(f.isSameNode(a)&&d.push(void 0),d.push(f.getAttribute("data-path")))}),Jn({app:t,notebookId:e,currentPath:we().dirname(n),paths:d,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new T({icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const d=[];Array.from(a.parentElement.children).forEach(f=>{f.tagName==="LI"&&(d.push(f.getAttribute("data-path")),f.isSameNode(a)&&d.push(void 0))}),Jn({app:t,notebookId:e,currentPath:we().dirname(n),paths:d,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element)),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:ma(l,!1).concat([{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){_("/api/filetree/duplicateDoc",{id:l})}}])}).element),window.siyuan.menus.menu.append(Ii(Es(Array.from(i.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{ls(Array.from(i.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(ml({path:n,notebookId:e,name:o,type:"file"})),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.attr,icon:"iconAttr",click(){_("/api/block/getDocInfo",{id:l},d=>{sn(d.data.ial)})}}).element);const u=[{iconHTML:g.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{_("/api/riff/getTreeRiffDueCards",{rootID:l},d=>{li(t,d.data,"doc",l,o)}),Be()}},{iconHTML:g.ZWSP,label:window.siyuan.languages.manage,click:()=>{_("/api/filetree/getHPathByID",{id:l},d=>{Ca(t,l,we().join(At(e),d.data),"Tree")}),Be()}},{iconHTML:g.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{F(void 0,[{action:"addFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:[l]}],[{action:"removeFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:[l]}])}},{iconHTML:g.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{F(void 0,[{action:"removeFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:[l]}],[{action:"addFlashcards",deckID:g.QUICK_DECK_ID,blockIDs:[l]}])}}];window.siyuan.config.flashcard.deck&&u.push({iconHTML:g.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{$a(t,[l])}}),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:u}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return Io(this,null,function*(){const d=ze(n,!1,!0),f=yield Dt("/api/filetree/getHPathByPath",{notebook:e,path:d+".sy"}),p=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(t,{removed:p.removed,sort:p.sort,group:p.group,hasReplace:!1,method:p.method,hPath:we().join(At(e),f.data),idPath:[we().join(e,d)],k:p.k,r:p.r,page:1,types:Object.assign({},p.types)})})}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){return Io(this,null,function*(){const d=ze(n,!1,!0),f=yield Dt("/api/filetree/getHPathByPath",{notebook:e,path:d+".sy"}),p=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(t,{removed:p.removed,sort:p.sort,group:p.group,hasReplace:!0,method:p.method,hPath:we().join(At(e),f.data),idPath:[we().join(e,d)],k:p.k,r:p.r,page:1,types:Object.assign({},p.types)})})}}).element),window.siyuan.menus.menu.append(new T({type:"separator"}).element)}return Xs(t,l,e,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Co({app:t,id:l,notebookId:e,pathString:o})}}).element),rs(e,n),window.siyuan.menus.menu.append(pl(l)),t.plugins&&ft({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:s,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu},rs=(t,e)=>{window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:n=>{n.querySelector(".b3-form__upload").addEventListener("change",a=>{const i=new FormData;i.append("file",a.target.files[0]),i.append("notebook",t),i.append("toPath",e),_("/api/import/importSY",i,()=>{var s;let l;l=window.siyuan.mobile.files;const o=l.element.querySelector(`[data-path="${e}"]`),r=o.querySelector(".b3-list-item__arrow--open");r&&(r.classList.remove("b3-list-item__arrow--open"),(s=o.nextElementSibling)==null||s.remove()),l.getLeaf(o,t),window.siyuan.menus.menu.remove()})})}}]}).element)},No=(t,e,n)=>{const a=[{icon:e===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{icon:e===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{icon:e===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{icon:e===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{type:"separator"},{icon:e===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{icon:e===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{icon:e===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{icon:e===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{type:"separator"},{icon:e===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{icon:e===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{type:"separator"},{icon:e===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{icon:e===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{type:"separator"},{icon:e===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{icon:e===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{type:"separator"},{icon:e===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return t==="notebook"&&a.push({icon:e===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a};var xd=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const Sd=(t,e)=>{if(Cn(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}_("/api/block/getDocInfo",{id:t.block.rootID},n=>{var a;window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:ma(t.block.rootID)}).element),t.disabled||(window.siyuan.menus.menu.append(Ii([t.path])),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{So(t.notebookId,t.path)}}).element)),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+De("\u21E7Click"),click(){sn(n.data.ial,"bookmark",t)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){Vr(t)}}).element);const i=[{iconHTML:g.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{_("/api/riff/getTreeRiffDueCards",{rootID:t.block.rootID},s=>{li(t.app,s.data,"doc",t.block.rootID,s.data.name)})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.manage,click:()=>{_("/api/filetree/getHPathByID",{id:t.block.rootID},s=>{Ca(t.app,t.block.rootID,we().join(At(t.notebookId),s.data),"Tree")})}},{iconHTML:g.ZWSP,label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{var s;let l=(s=t.title)==null?void 0:s.element;l||(l=document.createElement("div"),l.setAttribute("data-node-id",t.block.rootID),l.setAttribute(g.CUSTOM_RIFF_DECKS,n.data.ial[g.CUSTOM_RIFF_DECKS])),ss(t,[l])}}];window.siyuan.config.flashcard.deck&&i.push({iconHTML:g.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{$a(t.app,[t.block.rootID])}}),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:i}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,click(){return xd(this,null,function*(){const s=ze(t.path,!1,!0),l=yield Dt("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:s+".sy"}),o=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(t.app,{removed:o.removed,sort:o.sort,group:o.group,hasReplace:!1,method:o.method,hPath:we().join(At(t.notebookId),l.data),idPath:[we().join(t.notebookId,s)],k:o.k,r:o.r,page:1,types:Object.assign({},o.types)})})}}).element),t.disabled||xo(t.block.rootID),window.siyuan.menus.menu.append(new T({type:"separator"}).element),t.disabled||window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){Co({app:t.app,id:t.block.rootID,notebookId:t.notebookId,pathString:n.data.name})}}).element),rs(t.notebookId,t.path),window.siyuan.menus.menu.append(pl(t.block.showAll?t.block.id:t.block.rootID)),(a=t==null?void 0:t.app)!=null&&a.plugins&&ft({plugins:t.app.plugins,type:"click-editortitleicon",detail:{protyle:t,data:n.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${ee(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>
${window.siyuan.languages.createdAt} ${ee(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.fullscreen()})};var Ad=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class Cd{constructor(e){const n=document.createElement("div");n.className="protyle-breadcrumb",n.innerHTML=`${H()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<span class="fn__space"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="doc" aria-label="${window.siyuan.languages.gutterTip2}"><svg><use xlink:href="#iconFile"></use></svg></button>
<span class="fn__space"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon block__icon--show fn__flex-center fn__none ariaLabel" style="margin-left: 8px" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",a=>{let i=a.target;for(;i&&!i.isEqualNode(n);){const s=i.getAttribute("data-node-id"),l=i.getAttribute("data-type");if(s){a.preventDefault();break}else if(l==="mobile-menu"){this.genMobileMenu(e),a.preventDefault(),a.stopPropagation();break}else if(l==="doc"){if(window.siyuan.shiftIsPressed)_("/api/block/getDocInfo",{id:e.block.rootID},o=>{sn(o.data.ial,"bookmark",e)});else{const o=i.getBoundingClientRect();Sd(e,{x:o.right,y:o.bottom,isLeft:!0})}a.stopPropagation(),a.preventDefault();break}else if(l==="more"){const o=i.getBoundingClientRect();this.showMenu(e,{x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation(),a.preventDefault();break}else if(l==="readonly"){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[g.CUSTOM_SY_READONLY]:i.querySelector("use").getAttribute("xlink:href")==="#iconUnlock"?"true":"false"}}),a.stopPropagation(),a.preventDefault();break}else if(l==="exit-focus"){mt({protyle:e,id:e.block.rootID,focusId:e.block.id}),a.stopPropagation(),a.preventDefault();break}else if(l==="context"){a.stopPropagation(),a.preventDefault(),i.classList.contains("block__icon--active")?(mt({protyle:e,id:e.options.blockId}),i.classList.remove("block__icon--active")):(_("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{qe({data:o,protyle:e,action:[g.CB_GET_HL]})}),i.classList.add("block__icon--active"));break}i=i.parentElement}}),n.addEventListener("mouseleave",()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mouseover",a=>{if(!e.selectElement.classList.contains("fn__none"))return;const i=a.target,s=A(i,"data-node-id",null);if(s){e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(o=>{o.classList.remove("protyle-wysiwyg--hl")});const l=e.wysiwyg.element.querySelector(`[data-node-id="${s.getAttribute("data-node-id")}"]`);l&&l.classList.add("protyle-wysiwyg--hl")}}),this.element.addEventListener("mousewheel",a=>{this.element.scrollLeft=this.element.scrollLeft+a.deltaY},{passive:!0})}startRecord(e){this.messageId=oe(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),je(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});an(e,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(e){const n=new ut("breadcrumb-mobile-path");let a;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?a=M(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:a=I(s.startContainer)}a||(a=M(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const i=a.getAttribute("data-node-id");_("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(l=>{let o=!1;(!e.block.showAll&&l.id===e.block.parentID||e.block.showAll&&l.id===e.block.id)&&(o=!0),n.addItem({current:o,icon:_t(l.type,l.subType),label:l.name,click(){mt({protyle:e,id:l.id,focusId:i})}})}),n.fullscreen()})}toggleExit(e){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');e?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(e,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let a;const i=I(de(e.element).startContainer);i&&(a=i.getAttribute("data-node-id")),_("/api/block/getTreeStat",{id:a||(e.block.showAll?e.block.id:e.block.rootID)},s=>{var l,o,r;if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!e.contentElement.classList.contains("fn__none")&&!e.disabled){let d="";d='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?d+=` accept="${e.options.upload.accept}">`:d+=">";const f=new T({icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${d}`}).element;f.querySelector("input").addEventListener("change",p=>{p.target.files.length!==0&&(an(e,p.target.files,p.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(f),yt()||window.siyuan.menus.menu.append(new T({current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:(l=this.mediaRecorder)!=null&&l.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:()=>Ad(this,null,function*(){if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(p=>{this.mediaRecorder=new yd(p),this.mediaRecorder.recorder.onaudioprocess=b=>{if(!this.mediaRecorder.isRecording)return;const m=b.inputBuffer.getChannelData(0),h=b.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(m,h)},this.startRecord(e)}).catch(()=>{oe(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),je(this.messageId);const p=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});an(e,[p])}else je(this.messageId),this.startRecord(e)})}).element)}e.disabled||(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.netImg2LocalAsset,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){nc(e)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){Qt()||Te("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{_("/api/asset/uploadCloud",{id:e.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){Te("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{_("/api/export/export2Liandi",{id:e.block.parentID})})}}).element)),(o=e.scroll)!=null&&o.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new T({current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{jt(e,!H())}}).element),e.disabled||window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{Y(["toolbar"],e),_("/api/format/autoSpace",{id:e.block.rootID})}}).element);const c=[{current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{fa(e,"wysiwyg"),e.scroll.lastScrollTop=0,_("/api/filetree/getDoc",{id:e.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},d=>{qe({data:d,protyle:e})})}}];c.push({current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{fa(e,"preview"),window.siyuan.menus.menu.remove()}}),window.siyuan.menus.menu.append(new T({icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:c}).element);const u=e.wysiwyg.element.getAttribute(g.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{iconHTML:"",current:u==="true",label:window.siyuan.languages.enable,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[g.CUSTOM_SY_READONLY]:"true"}})}},{iconHTML:"",current:u==="false",label:window.siyuan.languages.disable,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[g.CUSTOM_SY_READONLY]:"false"}})}},{iconHTML:"",current:!u,label:window.siyuan.languages.default,click(){_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[g.CUSTOM_SY_READONLY]:""}})}}]}).element),(r=e==null?void 0:e.app)!=null&&r.plugins&&ft({plugins:e.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:e,data:s.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new T({type:"separator"}).element),window.siyuan.menus.menu.append(new T({iconHTML:g.ZWSP,type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.runeCount}</div>
<div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.wordCount}</div>
<div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.linkCount}</div>
<div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.imageCount}</div>
<div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.refCount}</div>`}).element),window.siyuan.menus.menu.fullscreen()})}render(e,n=!1){var a;if(H())return;let i,s;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),!e.wysiwyg.element.isEqualNode(i.startContainer)&&!e.wysiwyg.element.contains(i.startContainer)?e.element.id==="searchPreview"?s=I(e.wysiwyg.element.querySelector('[data-type="search-mark"]')):s=M(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:s=I(i.startContainer)),s||(s=M(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const l=s.getAttribute("data-node-id");if(l===this.id&&!n){e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(c=>{c.classList.remove("protyle-breadcrumb__item--active")});const r=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);r&&r.classList.add("protyle-breadcrumb__item--active");return}this.id=l;const o=[];(a=this.element.parentElement)!=null&&a.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&o.push("NodeTextMark-mark"),_("/api/block/getBlockBreadcrumb",{id:l,excludeTypes:o},r=>{let c="";r.data.forEach((f,p)=>{let b=!1;(!e.block.showAll&&f.id===e.block.parentID||e.block.showAll&&f.id===e.block.id)&&(b=!0),p===0&&!e.options.render.breadcrumbDocName?c+=`<span class="protyle-breadcrumb__item${b?" protyle-breadcrumb__item--active":""}" data-node-id="${f.id}"${r.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${f.id}"><use xlink:href="#${_t(f.type,f.subType)}"></use></svg>
</span>`:c+=`<span class="protyle-breadcrumb__item${b?" protyle-breadcrumb__item--active":""}" data-node-id="${f.id}"${r.data.length===1||p===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${f.id}"><use xlink:href="#${_t(f.type,f.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${f.name}">${f.name}</span>
</span>`,p!==r.data.length-1&&(c+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.classList.remove("protyle-breadcrumb__bar--nowrap"),this.element.innerHTML=c;const u=Array.from(this.element.querySelectorAll(".protyle-breadcrumb__text"));if(u.length===0)return;let d=!1;for(;this.element.scrollHeight>30&&!d&&u.length>1;)u.find((f,p)=>{if(p>0){if(!f.classList.contains("protyle-breadcrumb__text--ellipsis"))return f.classList.add("protyle-breadcrumb__text--ellipsis"),!0;p===u.length-1&&f.classList.contains("protyle-breadcrumb__text--ellipsis")&&(d=!0)}});this.element.classList.add("protyle-breadcrumb__bar--nowrap"),this.element.lastElementChild&&(this.element.scrollLeft=this.element.lastElementChild.offsetLeft-this.element.clientWidth+14)})}hide(){H()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}var Po=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class Td{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img class="fn__none">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__sw" style="position: relative" aria-label="${window.siyuan.languages.upload}"><input type="file" style="position: absolute;width: 22px;height: 100%;top: 0;left: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__sw" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="b3-chips"></div>
<div class="protyle-background__iconw">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="protyle-icons fn__flex-center">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__s" data-menu="true" data-type="tag" aria-label="${window.siyuan.languages.addTag}"><svg><use xlink:href="#iconTags"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__s" data-type="icon" aria-label="${window.siyuan.languages.randomIcon}"><svg><use xlink:href="#iconEmoji"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__s" data-type="random" aria-label="${window.siyuan.languages.titleBg}"><svg><use xlink:href="#iconImage"></use></svg></span>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.firstElementChild.firstElementChild,W()?this.imgElement.addEventListener("touchstart",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.touches[0].clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let l=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(l=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.ontouchmove=o=>{this.imgElement.style.objectPosition=`center ${((a-o.touches[0].clientY)/s*100+l).toFixed(2)}%`,n.preventDefault()},i.ontouchend=()=>{i.ontouchmove=null,i.ontouchstart=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}):(this.element.addEventListener("dragover",n=>Po(this,null,function*(){n.preventDefault()})),this.element.addEventListener("drop",n=>Po(this,null,function*(){n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&an(e,[n.dataTransfer.files[0]],void 0,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})})),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let l=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(l=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=o=>{this.imgElement.style.objectPosition=`center ${((a-o.clientY)/s*100+l).toFixed(2)}%`,n.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}})),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&an(e,n.target.files,n.target,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(qn(),n=>{if(e.disabled)return;let a=n.target;for(Y(["gutter"],e);a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type");if(i==="position"){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const l=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=l,_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":l}})}else this.render(this.ial,e.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(i==="open-emoji"){const s=this.iconElement.getBoundingClientRect();hi(e.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width}),n.preventDefault(),n.stopPropagation();break}else if(i==="random"){const s=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"],l=s[X(0,s.length-1)];this.ial["title-img"]=l,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(i==="remove"){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(i==="icon"){const s=ws();s&&(Ln(s,e.block.rootID),Va(s,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:s}}),e.model&&e.model.parent.setDocIcon(s)),n.preventDefault(),n.stopPropagation();break}else if(i==="tag"){this.openTag(e),n.preventDefault(),n.stopPropagation();break}else if(i==="link"){const s=new be({title:window.siyuan.languages.link,width:H()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),l=s.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{s.destroy()}),l[1].addEventListener("click",()=>{const o=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=o,this.render(this.ial,e.block.rootID),_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(i==="open-search"){const s=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(e.app,{removed:s.removed,sort:s.sort,group:s.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${a.textContent}#`,r:"",page:1,types:Object.assign({},s.types)}),n.preventDefault(),n.stopPropagation();break}else if(i==="remove-tag"){a.parentElement.remove();const s=this.getTags();_("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:s.toString()}}),s.length===0?delete this.ial.tags:this.ial.tags=s.toString(),this.render(this.ial,e.block.rootID),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}render(e,n){var a;const i=e["title-img"],s=e.icon,l=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",n),l){let o="";const r=["secondary","primary","info","success","warning","error","pink"];l.split(",").forEach((c,u)=>{o+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${r[u%7]}" data-type="open-search">${c}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`}),this.tagsElement.innerHTML=o}else this.tagsElement.innerHTML="";if(s?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=le(s)):this.iconElement.classList.add("fn__none"),i)if(this.imgElement.classList.remove("fn__none"),this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(i)),i.indexOf("url(")>-1){const o=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,r=(a=this.imgElement.style.backgroundImage)==null?void 0:a.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",r),this.imgElement.style.objectPosition=o,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");else this.imgElement.classList.add("fn__none");i?this.element.style.minHeight=H()?"200px":"30vh":s?this.element.style.minHeight=this.tagsElement.clientHeight+56+"px":l?this.element.style.minHeight=this.tagsElement.clientHeight+"px":this.element.style.minHeight="0"}openTag(e){_("/api/search/searchTag",{k:""},n=>{let a="";n.data.tags.forEach((o,r)=>{a+=`<div class="b3-list-item${r===0?" b3-list-item--focus":""}">${o}</div>`}),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.lastElementChild.innerHTML=`<div class="fn__flex-column" style="max-height:50vh;margin: 0 -8px"><input style="margin: 0px 8px 4px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>
</div>`;const i=window.siyuan.menus.menu.element.querySelector(".b3-list--background"),s=window.siyuan.menus.menu.element.querySelector("input");s.addEventListener("keydown",o=>{if(o.stopPropagation(),!o.isComposing)if(bn(i,o),o.key==="Enter"){const r=i.querySelector(".b3-list-item--focus");r?this.addTags(r.textContent,e):this.addTags(s.value,e),window.siyuan.menus.menu.remove()}else o.key==="Escape"&&window.siyuan.menus.menu.remove()}),s.addEventListener("input",o=>{o.stopPropagation(),_("/api/search/searchTag",{k:s.value},r=>{let c="",u=!1;r.data.tags.forEach(d=>{c+=`<div class="b3-list-item">${d}</div>`,d===`<mark>${r.data.k}</mark>`&&(u=!0)}),!u&&r.data.k&&(c=`<div class="b3-list-item"><mark>${r.data.k}</mark></div>`+c),i.innerHTML=c,i.firstElementChild.classList.add("b3-list-item--focus")})}),i.addEventListener("click",o=>{const r=o.target,c=N(r,"b3-list-item");c&&this.addTags(c.textContent,e)});const l=this.iconElement.nextElementSibling.getBoundingClientRect();window.siyuan.menus.menu.popup({x:l.left,y:l.top+l.height}),s.focus()})}getTags(){const e=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(n=>{e.push(n.textContent.trim())}),e}addTags(e,n){window.siyuan.menus.menu.remove();const a=this.getTags();a.includes(e)||(a.push(e),_("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,n.block.rootID))}}class un{constructor(e,n,a){this.version=g.SIYUAN_VERSION;const s=new jc(a).merge();if(this.protyle={getInstance:()=>this,app:e,transactionTime:new Date().getTime(),id:Bn(),disabled:!1,updated:!1,element:n,options:s,block:{}},this.protyle.hint=new Fc(this.protyle),s.render.breadcrumb&&(this.protyle.breadcrumb=new Cd(this.protyle)),s.render.background&&(this.protyle.background=new Td(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),s.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new Gr,this.protyle.wysiwyg=new sd(this.protyle),this.protyle.toolbar=new md(this.protyle),this.protyle.scroll=new zc(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new wd(this.protyle)),(s.upload.url||s.upload.handler)&&(this.protyle.upload=new qr),this.init(),s.action.includes(g.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new ii({app:e,id:this.protyle.id,type:"protyle",msgCallback:l=>{switch(l.cmd){case"reload":l.data===this.protyle.block.rootID&&jt(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${l.data.id}"]`)).forEach(o=>{o.removeAttribute("data-render"),Ye(o,this.protyle)});break;case"addLoading":l.data===this.protyle.block.rootID&&Qn(this.protyle,l.msg);break;case"transactions":l.data[0].doOperations.forEach(o=>{!this.protyle.preview.element.classList.contains("fn__none")&&o.action!=="updateAttrs"?this.protyle.preview.render(this.protyle):Yi(this.protyle,o,!1)});break;case"readonly":this.protyle.wysiwyg.element.getAttribute(g.CUSTOM_SY_READONLY)||(l.data?Yt(this.protyle):ei(this.protyle));break;case"heading2doc":case"li2doc":this.protyle.block.rootID===l.data.srcRootBlockID&&(this.protyle.block.showAll&&l.cmd==="heading2doc"&&!this.protyle.options.backlinkData?_("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{qe({data:o,protyle:this.protyle})}):jt(this.protyle,!1));break;case"rename":this.protyle.path===l.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(l.data.title),this.protyle.background&&(this.protyle.background.ial.title=l.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===l.data.id&&(getSelection().rangeCount>0&&this.protyle.title.editElement.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(l.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${l.data.id}"]`).forEach(o=>{o.getAttribute("data-subtype")==="d"&&(o.textContent=l.data.refText)});break;case"moveDoc":this.protyle.path===l.data.fromPath&&(this.protyle.path=l.data.newPath,this.protyle.notebookId=l.data.toNotebook);break;case"unmount":this.protyle.notebookId===l.data.box&&xa(e);break;case"removeDoc":l.data.ids.includes(this.protyle.block.rootID)&&xa(e);break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,Ul(this.protyle,a.backlinkData);return}if(!a.blockId){ti(this.protyle);return}a.scrollAttr?Vi({protyle:this.protyle,scrollAttr:a.scrollAttr,mergedOptions:s,cb:()=>{this.afterOnGet(s)}}):this.protyle.options.mode!=="preview"&&(s.action.includes(g.CB_GET_SCROLL)||s.action.includes(g.CB_GET_ROOTSCROLL))?_("/api/block/getDocInfo",{id:a.blockId},l=>{if(!s.action.includes(g.CB_GET_SCROLL)&&l.data.rootID!==a.blockId&&s.action.includes(g.CB_GET_ROOTSCROLL)){this.getDoc(s);return}let o;if(l.data.ial.scroll)try{o=JSON.parse(l.data.ial.scroll.replace(/&quot;/g,'"'))}catch(r){o=void 0}o?(o.rootId=l.data.rootID,Vi({protyle:this.protyle,scrollAttr:o,mergedOptions:s,cb:()=>{this.afterOnGet(s)}})):this.getDoc(s)}):this.getDoc(s)}}getDoc(e){var n;_("/api/filetree/getDoc",{id:e.blockId,isBacklink:e.action.includes(g.CB_GET_BACKLINK),mode:e.action&&e.action.includes(g.CB_GET_CONTEXT)?3:0,size:(n=e.action)!=null&&n.includes(g.CB_GET_ALL)?g.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},a=>{qe({data:a,protyle:this.protyle,action:e.action,afterCB:()=>{this.afterOnGet(e)}})})}afterOnGet(e){this.protyle.model,ua(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{}),e.after&&e.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=Uc({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new Yc(this.protyle),dc(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){sl(this.protyle)}resize(){ua(this.protyle)}reload(e){jt(this.protyle,e)}insert(e,n=!1,a=!1){Re(e,this.protyle,n,a)}transaction(e,n){F(this.protyle,e,n)}}const St=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,Ke=(t,e,n=[g.CB_GET_HL])=>{if(window.siyuan.storage[g.LOCAL_DOCINFO]={id:e},et(g.LOCAL_DOCINFO,window.siyuan.storage[g.LOCAL_DOCINFO]),window.siyuan.mobile.editor){Y(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&fa(window.siyuan.mobile.editor.protyle,"wysiwyg");let a;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find(i=>{if(!A(i.parentElement,"data-type","NodeBlockQueryEmbed"))return a=i,!0}),a){Pi(),Ie(window.siyuan.mobile.editor.protyle,a,!0),Be();return}}_("/api/block/getBlockInfo",{id:e},a=>{if(a.code===3){oe(a.msg);return}window.siyuan.mobile.editor?(Pi(),Qn(window.siyuan.mobile.editor.protyle),_("/api/filetree/getDoc",{id:e,size:n.includes(g.CB_GET_ALL)?g.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(g.CB_GET_CONTEXT)?3:0},i=>{qe({data:i,protyle:window.siyuan.mobile.editor.protyle,action:n})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new un(t,document.getElementById("editor"),{blockId:e,action:n,render:{scroll:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]}}),document.getElementById("toolbarName").value=a.data.rootTitle==="Untitled"?"":a.data.rootTitle,Ic(),Be()})},$d=(t,e)=>{if(e)switch(e.cmd){case"syncMergeResult":oo(t,e.data);break;case"readonly":window.siyuan.config.editor.readOnly=e.data;break;case"progress":Nc(e);break;case"syncing":Vt(e),e.code===1&&document.getElementById("toolbarSync").classList.add("fn__none");break;case"createdailynote":Ke(t,e.data.id);break;case"openFileById":Ke(t,e.data.id,[g.CB_GET_FOCUS]);break;case"txerr":Mc();break;case"statusbar":Hc(e);break}};class Id{constructor(e){this.menu=new kr}getDir(e){const n=wt(e,"UL");if(n)return n.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}const ci=(t,e)=>{let n="";return t.forEach(a=>{typeof a=="string"?n+=`<option value="${a}" ${e===a?"selected":""}>${a}</option>`:n+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label}</option>`}),n},Dd=()=>{It({title:window.siyuan.languages.appearance,icon:"iconTheme",html:`<div class="b3-label">
    ${window.siyuan.languages.appearance4}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
    <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.theme}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="themeLight">
      ${ci(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme11}</div>
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="themeDark">
       ${ci(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme12}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.icon}
    <div class="fn__hr"></div>
    <select class="b3-select fn__block" id="icon">
        ${ci(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
    </select>
    <div class="b3-label__text">${window.siyuan.languages.theme2}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.language}
    <div class="fn__hr"></div>
    <select id="lang" class="b3-select fn__block">${ci(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
    <div class="b3-label__text">${window.siyuan.languages.language1}</div>
</div>`,bindEvent(t){t.querySelectorAll("select").forEach(e=>{e.addEventListener("change",()=>{const n=parseInt(t.querySelector("#mode").value);_("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:t.querySelector("#icon").value,mode:n===2?window.siyuan.config.appearance.mode:n,modeOS:n===2,themeDark:t.querySelector("#themeDark").value,themeLight:t.querySelector("#themeLight").value,lang:t.querySelector("#lang").value}),()=>{window.location.reload()})})})}})},Md=t=>{const e=new be({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',_("/api/sync/createCloudSyncDir",{name:n.value},()=>{e.destroy(),Da(t,!0)})})},Bo=(t,e)=>{t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){const i=a.getAttribute("data-type");if(i){switch(i){case"addCloud":Md(t);break;case"removeCloud":Te(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',_("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},s=>{window.siyuan.config.sync.cloudName=s.data,Da(t,!0,e)})});break;case"selectCloud":t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',_("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),Da(t,!0,e)});break}n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})},Da=(t,e=!1,n)=>{!e&&t.firstElementChild.tagName!=="IMG"||_("/api/sync/listCloudSyncDir",{},a=>{let i=`<div class="fn__hr"></div><ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?i=`<div class="fn__hr"></div>
<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(i='<div class="fn__hr"></div><ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(s=>{i+=`<li data-type="selectCloud" data-name="${s.cloudName}" class="b3-list-item b3-list-item--two">
    <div class="b3-list-item__first" data-name="${s.cloudName}">
        <input type="radio" name="cloudName"${s.cloudName===a.data.checkedSyncDir?" checked":""}/>
        <span class="fn__space"></span>
        <span>${s.cloudName}</span>
        <span class="fn__flex-1 fn__space"></span>
        <span data-type="removeCloud" class="b3-list-item__action">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
    </div>
    <div class="b3-list-item__meta fn__flex">
        <span>${s.hSize}</span>
        <span class="fn__flex-1 fn__space"></span>
        <span>${s.updated}</span>
    </div>
</li>`}),i+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),t.innerHTML=i,n&&n()})},qo=t=>{if(!window.siyuan.config.readonly&&!(window.siyuan.config.sync.provider===0&&Qt()||window.siyuan.config.sync.provider!==0&&oa())){if(!window.siyuan.config.repo.key){Ro(!0);return}if(!window.siyuan.config.sync.enabled){Oo();return}cs()}},cs=()=>{if(window.siyuan.config.sync.mode!==3){_("/api/sync/performSync",{});return}const t=new be({title:window.siyuan.languages.chooseSyncDirection,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="true">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.uploadData2Cloud}
            <div class="b3-label__text">${window.siyuan.languages.uploadData2CloudTip}</div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="false">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.downloadDataFromCloud}
            <div class="b3-label__text">${window.siyuan.languages.downloadDataFromCloudTip}</div>
        </div>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input[name=upload]:checked");if(!n){oe(window.siyuan.languages.plsChoose);return}_("/api/sync/performSync",{upload:n.value==="true"}),t.destroy()})},Oo=(t,e)=>{if(t&&(window.siyuan.config.repo.key=t),window.siyuan.config.sync.enabled)e&&e.destroy(),Te(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{cs()});else{const n=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;e?(e.element.querySelector(".b3-dialog__header").innerHTML=window.siyuan.languages.cloudSyncDir,e.element.querySelector(".b3-dialog__body").innerHTML=n):e=new be({title:window.siyuan.languages.cloudSyncDir,content:n,width:H()?"92vw":"520px"});const a=e.element.querySelector(".b3-dialog__content").lastElementChild,i=e.element.querySelector(".b3-button");Bo(a,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),Da(a,!1,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{e.destroy(),_("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,Vt(),Te(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{cs()})})})}},Ro=(t,e)=>{const n=new be({title:window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">
    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>
    <div class="fn__hr--b"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.duplicate} ${window.siyuan.languages.passphrase}">
</div>
<div class="b3-dialog__action">
    <label>
        <input type="checkbox" class="b3-switch fn__flex-center">
        <span class="fn__space"></span>
        ${window.siyuan.languages.confirmPassword}
    </label>
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--text" id="initKeyByPW" disabled>
        ${window.siyuan.languages.confirm}
    </button>
</div>`,width:H()?"92vw":"520px"});n.element.querySelector(".b3-button--cancel").addEventListener("click",()=>{n.destroy()});const a=n.element.querySelector("#initKeyByPW");n.element.querySelector(".b3-switch").addEventListener("change",function(){this.checked?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});const i=n.element.querySelectorAll(".b3-text-field");a.addEventListener("click",()=>{if(!i[0].value||!i[1].value){oe(window.siyuan.languages._kernel[142]);return}if(i[0].value!==i[1].value){oe(window.siyuan.languages.passwordNoMatch);return}Te("\u{1F511} "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,()=>{t||n.destroy(),_("/api/repo/initRepoKeyFromPassphrase",{pass:i[0].value},s=>{window.siyuan.config.repo.key=s.data.key,e&&e(),t&&Oo(s.data.key,n)})})}),i[0].focus()},Fo=t=>t===0?Qt("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",dt("subscribe/siyuan"))}</div>
<div class="b3-label b3-label--noborder">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--noborder">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:oa("")?`<div class="b3-label b3-label--inner">${window.siyuan.languages.needLogin}</div>`:t===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.featureBetaStage}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon"><use xlink:href="#iconEye"></use></svg>
    </div>
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Region</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
    </select>
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</label>`:t===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.featureBetaStage}</em>
    <div class="fn__hr"></div>    
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon"><use xlink:href="#iconEye"></use></svg>
    </div>
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</label>
<label class="b3-label b3-label--noborder fn__flex config__item">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</label>`:"",Uo=()=>{const t=it.element.querySelector("#reposData"),e=it.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(Qt("")){e.classList.add("fn__none");let i=t;for(;i;)i.classList.add("fn__none"),i=i.nextElementSibling;return}_("/api/cloud/getCloudSpace",{},i=>{if(e.classList.add("fn__none"),i.code===1){t.innerHTML=i.msg;return}else t.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${i.data.sync?i.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${i.data.backup?i.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${dt("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${i.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${i.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${i.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${dt("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${i.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${i.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),t.classList.remove("fn__none");return}e.classList.add("fn__none");let n=t.nextElementSibling;for(;n;)oa("")?n.classList.add("fn__none"):n.classList.remove("fn__none"),n=n.nextElementSibling;t.classList.add("fn__none");const a=it.element.querySelector("#syncProviderPanel");a.querySelectorAll(".b3-text-field, .b3-select").forEach(i=>{i.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let s=parseInt(a.querySelector("#timeout").value,10);7>s&&(1>s?s=30:s=7),300<s&&(s=300),a.querySelector("#timeout").value=s.toString();const l={endpoint:a.querySelector("#endpoint").value,accessKey:a.querySelector("#accessKey").value,secretKey:a.querySelector("#secretKey").value,bucket:a.querySelector("#bucket").value,pathStyle:a.querySelector("#pathStyle").value==="true",region:a.querySelector("#region").value,skipTlsVerify:a.querySelector("#s3SkipTlsVerify").value==="true",timeout:s};_("/api/sync/setSyncProviderS3",{s3:l},()=>{window.siyuan.config.sync.s3=l})}else if(window.siyuan.config.sync.provider===3){let s=parseInt(a.querySelector("#timeout").value,10);7>s&&(s=7),300<s&&(s=300),a.querySelector("#timeout").value=s.toString();const l={endpoint:a.querySelector("#endpoint").value,username:a.querySelector("#username").value,password:a.querySelector("#password").value,skipTlsVerify:a.querySelector("#webdavSkipTlsVerify").value==="true",timeout:s};_("/api/sync/setSyncProviderWebDAV",{webdav:l},()=>{window.siyuan.config.sync.webdav=l})}})})},it={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.sync.provider===0?"selected":""}>SiYuan</option>
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
    </select>
</label>
<div id="syncProviderPanel" class="b3-label">
    ${Fo(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <label class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </label>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <label class="fn__flex config__item">
        <div class="fn__flex-center">${window.siyuan.languages.cloudSyncDir}</div>
        <div class="fn__flex-1"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-type="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </label>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{Uo();const t=it.element.querySelector("#reposCloudSyncSwitch");t.addEventListener("change",()=>{if(t.checked&&window.siyuan.config.sync.cloudName===""){t.checked=!1,oe(window.siyuan.languages._kernel[123]);return}_("/api/sync/setSyncEnable",{enabled:t.checked},()=>{window.siyuan.config.sync.enabled=t.checked,Vt()})});const e=it.element.querySelector("#syncPerception");e.addEventListener("change",()=>{_("/api/sync/setSyncPerception",{enabled:e.checked},()=>{window.siyuan.config.sync.perception=e.checked,Vt()})});const n=it.element.querySelector("#generateConflictDoc");n.addEventListener("change",()=>{_("/api/sync/setSyncGenerateConflictDoc",{enabled:n.checked},()=>{window.siyuan.config.sync.generateConflictDoc=n.checked})});const a=it.element.querySelector("#syncMode");a.addEventListener("change",()=>{_("/api/sync/setSyncMode",{mode:parseInt(a.value,10)},()=>{a.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?e.parentElement.classList.remove("fn__none"):e.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(a.value,10)})});const i=it.element.querySelector("#reposCloudSyncList"),s=it.element.querySelector("#syncProvider");s.addEventListener("change",()=>{_("/api/sync/setSyncProvider",{provider:parseInt(s.value,10)},o=>{o.code===1?(oe(o.msg),s.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(s.value,10),it.element.querySelector("#syncProviderPanel").innerHTML=Fo(window.siyuan.config.sync.provider),Uo(),i.innerHTML="",i.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?e.parentElement.classList.add("fn__none"):e.parentElement.classList.remove("fn__none")})});const l=it.element.querySelector("#reposLoading");l.style.width=it.element.clientWidth+"px",l.style.height=it.element.clientHeight+"px",Bo(i),it.element.firstElementChild.addEventListener("click",o=>{const r=o.target;if(r.getAttribute("data-type")==="config"){i.classList.contains("fn__none")?(Da(i,!0),i.classList.remove("fn__none")):i.classList.add("fn__none");return}const c=N(r,"b3-form__icona-icon");if(c){const u=c.firstElementChild.getAttribute("xlink:href")==="#iconEye";c.firstElementChild.setAttribute("xlink:href",u?"#iconEyeoff":"#iconEye"),c.previousElementSibling.setAttribute("type",u?"text":"password")}})}},Gt={element:void 0,genHTML:()=>{let t="";return t=`<div class="b3-label">
    ${window.siyuan.languages.apiTimeout}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>     
    <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiModel}
    <div class="b3-label__text">
        ${window.siyuan.languages.apiModelTip}
    </div>
    <div class="b3-label__text fn__flex config__item" style="padding: 4px 0 4px 4px;">
        <select id="apiModel" class="b3-select">
            <option value="gpt-4" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4"?"selected":""}>gpt-4</option>
            <option value="gpt-4-32k" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4-32k"?"selected":""}>gpt-4-32k</option>
            <option value="gpt-3.5-turbo" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo"?"selected":""}>gpt-3.5-turbo</option>
            <option value="gpt-3.5-turbo-16k" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo-16k"?"selected":""}>gpt-3.5-turbo-16k</option>
        </select>
    </div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiMaxTokens}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiKey}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiKey" value="${window.siyuan.config.ai.openAI.apiKey}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiKeyTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiProxy}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.apiBaseURL}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}"/>
    <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
</div>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">OpenAI</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${t}
    </div>
</div>
</div>`},bindEvent:()=>{Gt.element.querySelectorAll("input,select").forEach(t=>{t.addEventListener("change",()=>{_("/api/setting/setAI",{openAI:{apiBaseURL:Gt.element.querySelector("#apiBaseURL").value,apiKey:Gt.element.querySelector("#apiKey").value,apiModel:Gt.element.querySelector("#apiModel").value,apiMaxTokens:parseInt(Gt.element.querySelector("#apiMaxTokens").value),apiProxy:Gt.element.querySelector("#apiProxy").value,apiTimeout:parseInt(Gt.element.querySelector("#apiTimeout").value)}},e=>{window.siyuan.config.ai=e.data})})})}},Hd=()=>{It({title:"AI",icon:"iconSparkles",html:Gt.genHTML(),bindEvent(t){Gt.element=t,Gt.bindEvent()}})},ht={element:void 0,genHTML:()=>{let t=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>`;return t=`${t}<div class="b3-label">
    ${window.siyuan.languages.flashcardNewCardLimit}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardReviewCardLimit}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
</div>
<div class="b3-label">
    ${window.siyuan.languages.flashcardFSRSParamWeights}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
</div>`,t},bindEvent:()=>{ht.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{_("/api/setting/setFlashcard",{newCardLimit:parseInt(ht.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(ht.element.querySelector("#reviewCardLimit").value),mark:ht.element.querySelector("#mark").checked,list:ht.element.querySelector("#list").checked,superBlock:ht.element.querySelector("#superBlock").checked,heading:ht.element.querySelector("#heading").checked,deck:ht.element.querySelector("#deck").checked,requestRetention:parseFloat(ht.element.querySelector("#requestRetention").value),maximumInterval:parseInt(ht.element.querySelector("#maximumInterval").value),weights:ht.element.querySelector("#weights").value},e=>{window.siyuan.config.flashcard=e.data})})})}},Nd=()=>{It({title:window.siyuan.languages.riffCard,icon:"iconRiffCard",html:ht.genHTML(),bindEvent(t){ht.element=t,ht.bindEvent()}})};var Pd=Mt(970),Bd=Mt.n(Pd);const Wo=()=>{let t="";window.siyuan.user.userTitles.length>0&&(t='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(e=>{t+=`<div class="b3-chip b3-chip--middle">${e.icon} ${e.name}</div>`}),t+="</div>"),It({title:window.siyuan.languages.manage,icon:"iconAccount",html:`<div class="fn__flex-column">
<div class="config-account__bg">
    <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
    <a href="${dt("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
    <h1 class="config-account__name">
        <a target="_blank" class="fn__a" href="${dt("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
        <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
    </h1>
    ${t}
</div>
<div class="config-account__info">
    <div class="fn__flex">
        <a class="b3-button b3-button--text" href="${dt("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--cancel" id="logout">
            ${window.siyuan.languages.logout}
        </button>
        <span class="fn__space"></span>
        <button class="b3-button b3-button--cancel" id="deactivateUser">
            ${window.siyuan.languages.deactivateUser}
        </button>
        <span class="fn__flex-1"></span>
        <button class="b3-button b3-button--cancel" id="refresh">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </button>
    </div>
</div></div>`,bindEvent(e){e.querySelector("#logout").addEventListener(qn(),()=>{_("/api/setting/logoutCloudUser",{},()=>{window.siyuan.user=null,Be(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,Vt()})}),e.querySelector("#deactivateUser").addEventListener("click",()=>{const a=new be({title:"\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,width:"92vw",content:Yo(!0)});zo(a.element.querySelector(".b3-dialog__body"),!0)});const n=e.querySelector("#refresh");n.addEventListener("click",()=>{const a=n.firstElementChild;a.classList.contains("fn__rotate")||(a.classList.add("fn__rotate"),_("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},i=>{window.siyuan.user=i.data,oe(window.siyuan.languages.refreshUser,3e3),Wo();const s=document.getElementById("menuAccount");window.siyuan.user?s.innerHTML=`<img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/><span class="b3-menu__label">${window.siyuan.user.userName}</span>`:s.innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,Vt()}))})}})},Yo=(t=!1)=>{let e;return t?e=`<div class="b3-form__img fn__none">
    <div class="fn__hr--b"></div>
    <img id="captchaImg" class="fn__pointer" style="top: 17px">
    <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
</div>
<div class="fn__hr--b"></div>
<button id="login" class="b3-button fn__block">${window.siyuan.languages.deactivateUser}</button>`:e=`<div class="b3-form__icon">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconFocus"></use></svg>
    <select class="b3-select b3-form__icon-input fn__block" id="cloudRegion">
        <option value="0"${window.siyuan.config.cloudRegion===0?" selected":""}>${window.siyuan.languages.cloudRegionChina}</option>
        <option value="1"${window.siyuan.config.cloudRegion===1?" selected":""}>${window.siyuan.languages.cloudRegionNorthAmerica}</option>
    </select>
</div>
<div class="b3-form__img fn__none">
    <div class="fn__hr--b"></div>
    <img id="captchaImg" class="fn__pointer" style="top: 17px">
    <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
</div>
<div class="fn__hr--b"></div>
<label class="ft__smaller ft__on-surface fn__flex">
    <span class="fn__space"></span>
    <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">
    <span class="fn__space"></span>
    <span>${window.siyuan.languages.accountTip}</span>
</label>
<div class="fn__hr--b"></div>
<button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>
<div class="fn__hr--b"></div>
<div class="ft__center">
    <a href="${dt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
    <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
    <a href="${dt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>
</div>`,`<div class="b3-form__space" id="form1">
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>
        <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">
    </div>
    <div class="fn__hr--b"></div>
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
        <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">
    </div>
    <div class="fn__hr--b"></div>
    ${e}
</div>
<div class="b3-form__space fn__none" id="form2">
    <div class="b3-form__icon">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
        <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">
    </div>
    <div class="fn__hr--b"></div>
    <button id="login2" class="b3-button fn__block">${t?window.siyuan.languages.deactivateUser:window.siyuan.languages.login}</button>
</div>`},jo=(t,e=!1)=>{e?(Y(["dialog"]),Te("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{_("/api/account/deactivate",{},()=>{window.siyuan.user=null,Be(),document.getElementById("menuAccount").innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>`,Vt()})})):_("/api/setting/getCloudUser",{token:t.data.token},n=>{window.siyuan.user=n.data,Be(),document.getElementById("menuAccount").innerHTML=`<img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/>
<span class="b3-menu__label">${window.siyuan.user.userName}</span>`,Vt()})},zo=(t,e=!1)=>{const n=t.querySelector("#agreeLogin"),a=t.querySelector("#userName"),i=t.querySelector("#userPassword"),s=t.querySelector("#captchaImg"),l=t.querySelector("#captcha"),o=t.querySelector("#twofactorAuthCode"),r=t.querySelector("#login"),c=t.querySelector("#login2");a.focus();let u,d;n&&n.addEventListener("click",()=>{n.checked?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")}),s.addEventListener("click",()=>{s.setAttribute("src",dt("captcha")+`/login?needCaptcha=${d}&t=${new Date().getTime()}`)});const f=t.querySelector("#cloudRegion");f&&f.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(f.value),t.querySelector("#form1").lastElementChild.innerHTML=`<a href="${dt("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
        <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
        <a href="${dt("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),r.addEventListener("click",()=>{_("/api/account/login",{userName:a.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:Bd()(i.value),captcha:l.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},p=>{if(p.code===1){if(oe(p.msg),p.data.needCaptcha){d=p.data.needCaptcha,l.parentElement.classList.remove("fn__none"),l.previousElementSibling.setAttribute("src",dt("captcha")+`/login?needCaptcha=${p.data.needCaptcha}`),l.value="";return}return}if(p.code===10){t.querySelector("#form1").classList.add("fn__none"),t.querySelector("#form2").classList.remove("fn__none"),o.focus(),u=p.data.token;return}jo(p,e)})}),c.addEventListener("click",()=>{_("/api/setting/login2faCloudUser",{code:o.value,token:u},p=>{jo(p,e)})})},qd=()=>{It({title:window.siyuan.languages.login,icon:"iconAccount",html:Yo(),bindEvent(t){zo(t)}})},Od=()=>{(!window.siyuan.config.localIPs||window.siyuan.config.localIPs.length===0||window.siyuan.config.localIPs.length===1&&window.siyuan.config.localIPs[0]==="")&&(window.siyuan.config.localIPs=["127.0.0.1"]),It({title:window.siyuan.languages.about,icon:"iconInfo",html:`<div>
<div class="b3-label fn__flex${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</div>
<div class="b3-label">
        ${window.siyuan.languages.about2}
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" readonly value="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}">
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        <div class="fn__hr"></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(t=>!(t.startsWith("[")&&t.endsWith("]"))).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(t=>t.startsWith("[")&&t.endsWith("]")).join("</code> <code class='fn__code'>")}</code></div>
        <div class="fn__hr"></div>
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly||se()&&!Pt()&&!yt()&&!ms()?" fn__none":""}">
    ${window.siyuan.languages.about5}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="authCode">
        <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.dataRepoKey}
    <div class="fn__hr"></div>
    <div class="${window.siyuan.config.repo.key?"fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            ${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="${window.siyuan.config.repo.key?"":"fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="removeKey">
            <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
    <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
    <div class="b3-label__text ft__error">${window.siyuan.languages.dataRepoKeyTip2}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.dataRepoPurge}
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="purgeRepo">
        <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.purge}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.dataRepoPurgeTip}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    ${window.siyuan.languages.about13}
    <span class="b3-label__text">${window.siyuan.config.api.token}</span>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="token">
        <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copy}
    </button>
    <div class="b3-label__text">${window.siyuan.languages.about14}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex">
        ${window.siyuan.languages.export}
    </div>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportData">
       <svg><use xlink:href="#iconUpload"></use></svg>Data
    </button>
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
    <div class="fn__hr--b"></div>
    <button class="b3-button b3-button--outline fn__block" id="exportLog">
       <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.systemLog}
    </button>
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
</div>
<div class="b3-label${window.siyuan.config.readonly?" fn__none":""}">
    <div class="fn__flex">
        ${window.siyuan.languages.import}
    </div>
    <div class="fn__hr"></div>
    <button class="b3-button b3-button--outline fn__block" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg> ${window.siyuan.languages.import} Data
    </button>
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
</div>
<div class="b3-label${!window.siyuan.config.readonly&&(yt()||Pt())?"":" fn__none"}">
    ${window.siyuan.languages.workspaceList}
    <div class="fn__hr"></div>
    <button id="openWorkspace" class="b3-button b3-button--outline fn__block">${window.siyuan.languages.openBy}...</button>
    <div class="fn__hr"></div>
    <ul id="workspaceDir" class="b3-list b3-list--background"></ul>
    <div class="fn__hr"></div>
    <button id="creatWorkspace" class="b3-button fn__block">${window.siyuan.languages.new}</button>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span class="fn__space"></span>
        <div>
            <span>${window.siyuan.languages.siyuanNote}</span>
            <span class="fn__space"></span>
            <span class="ft__on-surface">v${g.SIYUAN_VERSION}</span>
            <br>
            <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        </div>
    </div>
    <div style="color:var(--b3-theme-surface);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</div>
    ${window.siyuan.languages.about1}
</div>
</div>`,bindEvent(t){const e=t.querySelector("#workspaceDir");ds(e);const n=t.querySelector("#importKey");t.firstElementChild.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isSameNode(t);){if(s.id==="authCode"){cr(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="importKey"){const l=new be({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"}),o=l.element.querySelector("textarea");o.focus();const r=l.element.querySelectorAll(".b3-button");r[0].addEventListener("click",()=>{l.destroy()}),r[1].addEventListener("click",()=>{_("/api/repo/importRepoKey",{key:o.value},()=>{window.siyuan.config.repo.key=o.value,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none"),l.destroy()})}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="initKey"){Te("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{_("/api/repo/initRepoKey",{},l=>{window.siyuan.config.repo.key=l.data.key,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")})}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="initKeyByPW"){Ro(!1,()=>{n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="copyKey"){oe(window.siyuan.languages.copied),Pe(window.siyuan.config.repo.key),i.preventDefault(),i.stopPropagation();break}else if(s.id==="removeKey"){Te("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{_("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,Vt(),n.parentElement.classList.remove("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")})}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="purgeRepo"){Te("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{_("/api/repo/purgeRepo")}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="token"){oe(window.siyuan.languages.copied),Pe(window.siyuan.config.api.token),i.preventDefault(),i.stopPropagation();break}else if(s.id==="exportData"){_("/api/export/exportData",{},l=>{Nt(l.data.zip)}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="exportLog"){_("/api/system/exportLog",{},l=>{Nt(l.data.zip)}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="openWorkspace"){_("/api/system/getMobileWorkspaces",{},l=>{let o="";l.data.forEach((u,d)=>{o+=`<option value="${u}"${d===0?' selected="selected"':""}>${we().basename(u)}</option>`});const r=new be({title:window.siyuan.languages.openBy,content:`<div class="b3-dialog__content">
    <select class="b3-text-field fn__block">${o}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"}),c=r.element.querySelectorAll(".b3-button");c[0].addEventListener("click",()=>{r.destroy()}),c[1].addEventListener("click",()=>{const u=r.element.querySelector("select").value;if(u===window.siyuan.config.system.workspaceDir){r.destroy();return}Te(window.siyuan.languages.confirm,`${we().basename(window.siyuan.config.system.workspaceDir)} -> ${we().basename(u)}?`,()=>{_("/api/system/setWorkspaceDir",{path:u},()=>{Sa()})})})}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="creatWorkspace"){const l=new be({title:window.siyuan.languages.new,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"92vw"}),o=l.element.querySelector("input");o.focus();const r=l.element.querySelectorAll(".b3-button");r[0].addEventListener("click",()=>{l.destroy()}),r[1].addEventListener("click",()=>{_("/api/system/createWorkspaceDir",{path:we().join(we().dirname(window.siyuan.config.system.workspaceDir),o.value)},()=>{ds(e),l.destroy()})}),i.preventDefault(),i.stopPropagation();break}else if(s.getAttribute("data-type")==="remove"){const l=s.parentElement.getAttribute("data-path");_("/api/system/removeWorkspaceDir",{path:l},()=>{ds(e),Te(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeWorkspacePhysically.replace("${x}",l),()=>{_("/api/system/removeWorkspaceDirPhysically",{path:l})})}),i.preventDefault(),i.stopPropagation();break}else if(s.classList.contains("b3-list-item")&&!s.classList.contains("b3-list-item--focus")){Te(window.siyuan.languages.confirm,`${we().basename(window.siyuan.config.system.workspaceDir)} -> ${we().basename(s.getAttribute("data-path"))}?`,()=>{_("/api/system/setWorkspaceDir",{path:s.getAttribute("data-path")},()=>{Sa()})}),i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),t.querySelector("#importData").addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),_("/api/import/importData",s)});const a=t.querySelector("#networkServe");a.addEventListener("change",()=>{_("/api/system/setNetworkServe",{networkServe:a.checked},()=>{Sa()})})}})},ds=t=>{_("/api/system/getWorkspaces",{},e=>{let n="";e.data.forEach(a=>{n+=`<li data-path="${a.path}" class="b3-list-item b3-list-item--narrow${window.siyuan.config.system.workspaceDir===a.path?" b3-list-item--focus":""}">
    <span class="b3-list-item__text">${we().basename(a.path)}</span>
    <span data-type="remove" class="b3-list-item__action">
        <svg><use xlink:href="#iconMin"></use></svg>
    </span>
</li>`}),t.innerHTML=n})},Vo=t=>{let e=parseInt(t.querySelector("#dynamicLoadBlocks").value);48>e&&(e=48,t.querySelector("#dynamicLoadBlocks").value="48"),1024<e&&(e=1024,t.querySelector("#dynamicLoadBlocks").value="1024"),window.siyuan.config.editor.dynamicLoadBlocks=e,window.siyuan.config.editor.justify=t.querySelector("#justify").checked,window.siyuan.config.editor.rtl=t.querySelector("#rtl").checked,window.siyuan.config.editor.readOnly=t.querySelector("#readOnly").checked,window.siyuan.config.editor.displayBookmarkIcon=t.querySelector("#displayBookmarkIcon").checked,window.siyuan.config.editor.displayNetImgMark=t.querySelector("#displayNetImgMark").checked,window.siyuan.config.editor.codeSyntaxHighlightLineNum=t.querySelector("#codeSyntaxHighlightLineNum").checked,window.siyuan.config.editor.embedBlockBreadcrumb=t.querySelector("#embedBlockBreadcrumb").checked,window.siyuan.config.editor.listLogicalOutdent=t.querySelector("#listLogicalOutdent").checked,window.siyuan.config.editor.spellcheck=t.querySelector("#spellcheck").checked,window.siyuan.config.editor.onlySearchForDoc=t.querySelector("#onlySearchForDoc").checked,window.siyuan.config.editor.plantUMLServePath=t.querySelector("#plantUMLServePath").value,window.siyuan.config.editor.katexMacros=t.querySelector("#katexMacros").value,window.siyuan.config.editor.codeLineWrap=t.querySelector("#codeLineWrap").checked,window.siyuan.config.editor.virtualBlockRef=t.querySelector("#virtualBlockRef").checked,window.siyuan.config.editor.virtualBlockRefInclude=t.querySelector("#virtualBlockRefInclude").value,window.siyuan.config.editor.virtualBlockRefExclude=t.querySelector("#virtualBlockRefExclude").value,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen=parseInt(t.querySelector("#blockRefDynamicAnchorTextMaxLen").value),window.siyuan.config.editor.backlinkExpandCount=parseInt(t.querySelector("#backlinkExpandCount").value),window.siyuan.config.editor.backmentionExpandCount=parseInt(t.querySelector("#backmentionExpandCount").value),window.siyuan.config.editor.codeLigatures=t.querySelector("#codeLigatures").checked,window.siyuan.config.editor.codeTabSpaces=parseInt(t.querySelector("#codeTabSpaces").value),window.siyuan.config.editor.fontSize=parseInt(t.querySelector("#fontSize").value),window.siyuan.config.editor.generateHistoryInterval=parseInt(t.querySelector("#generateHistoryInterval").value),window.siyuan.config.editor.historyRetentionDays=parseInt(t.querySelector("#historyRetentionDays").value),_("/api/setting/setEditor",window.siyuan.config.editor,n=>{window.siyuan.config.editor=n.data,jt(window.siyuan.mobile.editor.protyle,!1),yi()})},Rd=()=>{It({title:window.siyuan.languages.editor,icon:"iconEdit",html:`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly}
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.md9}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="virtualBlockRefInclude" value="${window.siyuan.config.editor.virtualBlockRefInclude}" />
    <div class="b3-label__text">${window.siyuan.languages.md36}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.md35}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="virtualBlockRefExclude" value="${window.siyuan.config.editor.virtualBlockRefExclude}" />
    <div class="b3-label__text">${window.siyuan.languages.md36}</div>
    <div class="b3-label__text">${window.siyuan.languages.md41}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.md39}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
    <div class="b3-label__text">${window.siyuan.languages.md40}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.dynamicLoadBlocks}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="dynamicLoadBlocks" type="number" min="48" max="1024" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
    <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.md37}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
    <div class="b3-label__text">${window.siyuan.languages.md38}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.backlinkExpand}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
    <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.backmentionExpand}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="backmentionExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
    <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.generateHistory}
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
    <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.historyRetentionDays} 
    <a href="javascript:void(0)" id="clearHistory">${window.siyuan.languages.clearHistory}</a>
    <span class="fn__hr"></span>
    <input class="b3-text-field fn__block" id="historyRetentionDays" type="number" min="0" value="${window.siyuan.config.editor.historyRetentionDays}"/>
    <div class="b3-label__text">${window.siyuan.languages.historyRetentionDaysTip}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.fontSize} 
    <span class="ft__on-surface">${window.siyuan.config.editor.fontSize}</span>
    <div class="fn__hr"></div>
    <input id="fontSize" class="b3-slider fn__block" max="72" min="9" step="1" type="range" value="${window.siyuan.config.editor.fontSize}">
    <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.md29} 
    <span class="ft__on-surface">${window.siyuan.config.editor.codeTabSpaces}</span>
    <div class="fn__hr"></div>
    <input class="b3-slider fn__block" id="codeTabSpaces" max="8" min="0" step="2" type="range" value="${window.siyuan.config.editor.codeTabSpaces}">
    <div class="b3-label__text">${window.siyuan.languages.md30}</div>
</label>
<label class="b3-label fn__displayblock">
    ${window.siyuan.languages.katexMacros}
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="katexMacros">${window.siyuan.config.editor.katexMacros}</textarea>
    <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
</label>`,bindEvent(t){t.querySelector("#clearHistory").addEventListener("click",()=>{Te(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{_("/api/history/clearWorkspaceHistory",{})})}),t.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(e=>{e.addEventListener("change",()=>{Vo(t)})}),t.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(e=>{e.addEventListener("blur",()=>{Vo(t)})}),t.querySelectorAll("input.b3-slider").forEach(e=>{e.addEventListener("input",n=>{const a=n.target;a.previousElementSibling.previousElementSibling.textContent=a.value})})}})},Ma=()=>{$t(),pt(),document.getElementById("menu").style.transform="translateX(0px)"},Fd=t=>{const e=document.getElementById("menu");let n="";window.siyuan.user&&!window.siyuan.config.readonly?n=`<div class="b3-menu__item" id="menuAccount">
    <img class="b3-menu__icon" src="${window.siyuan.user.userAvatarURL}"/>
    <span class="b3-menu__label">${window.siyuan.user.userName}</span>
</div>`:window.siyuan.config.readonly||(n=`<div class="b3-menu__item" id="menuAccount">
    <svg class="b3-menu__icon"><use xlink:href="#iconAccount"></use></svg><span class="b3-menu__label">${window.siyuan.languages.login}</span>
</div>`);let a=`<div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAI">
        <svg class="b3-menu__icon"><use xlink:href="#iconSparkles"></use></svg><span class="b3-menu__label">AI</span>
    </div>`;lr()&&(a=""),e.innerHTML=`<div class="b3-menu__title">
    <svg class="b3-menu__icon"><use xlink:href="#iconLeft"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.back}</span>
</div>
<div class="b3-menu__items">
    ${n}
    <div id="menuRecent" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconList"></use></svg><span class="b3-menu__label">${window.siyuan.languages.recentDocs}</span>
    </div>
    <div id="menuSearch" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconSearch"></use></svg><span class="b3-menu__label">${window.siyuan.languages.search}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuSyncNow">
        <svg class="b3-menu__icon"><use xlink:href="#iconCloudSucc"></use></svg><span class="b3-menu__label">${window.siyuan.languages.syncNow}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuNewNotebook">
        <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg><span class="b3-menu__label">${window.siyuan.languages.newNotebook}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div id="menuNewDaily" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconCalendar"></use></svg><span class="b3-menu__label">${window.siyuan.languages.dailyNote}</span>
    </div>
    <div id="menuCard" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon" style="color: var(--b3-theme-secondary)"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-menu__label">${window.siyuan.languages.spaceRepetition}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuLock">
        <svg class="b3-menu__icon"><use xlink:href="#iconLock"></use></svg><span class="b3-menu__label">${window.siyuan.languages.lockScreen}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuHistory">
        <svg class="b3-menu__icon"><use xlink:href="#iconHistory"></use></svg><span class="b3-menu__label">${window.siyuan.languages.dataHistory}</span>
    </div>
    <div class="b3-menu__item${yt()||Pt()?"":" fn__none"}" id="menuSafeQuit">
        <svg class="b3-menu__icon"><use xlink:href="#iconQuit"></use></svg><span class="b3-menu__label">${window.siyuan.languages.safeQuit}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuEditor">
        <svg class="b3-menu__icon"><use xlink:href="#iconEdit"></use></svg><span class="b3-menu__label">${window.siyuan.languages.editor}</span>
    </div>
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuRiffCard">
        <svg class="b3-menu__icon"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-menu__label">${window.siyuan.languages.riffCard}</span>
    </div>
    ${a}
    <div class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}" id="menuAppearance">
        <svg class="b3-menu__icon"><use xlink:href="#iconTheme"></use></svg><span class="b3-menu__label">${window.siyuan.languages.appearance}</span>
    </div>
    <div id="menuSync" class="b3-menu__item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-menu__icon"><use xlink:href="#iconCloud"></use></svg><span class="b3-menu__label">${window.siyuan.languages.cloud}</span>
    </div>
    <div class="b3-menu__item" id="menuAbout">
        <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg><span class="b3-menu__label">${window.siyuan.languages.about}</span>
    </div>
    <div class="b3-menu__separator"></div>
    <div class="b3-menu__item" id="menuHelp">
        <svg class="b3-menu__icon"><use xlink:href="#iconHelp"></use></svg><span class="b3-menu__label">${window.siyuan.languages.help}</span>
    </div>
    <a class="b3-menu__item" href="${window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?"https://ld246.com/article/1649901726096":"https://liuyun.io/article/1686530886208"}" target="_blank">
        <svg class="b3-menu__icon"><use xlink:href="#iconFeedback"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.feedback}</span>
    </a>
</div>`,Vt(),e.addEventListener("click",i=>{let s=i.target;for(;s&&!s.isEqualNode(e);){if(s.classList.contains("b3-menu__title")){Be(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuSearch"){zt(t),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuRecent"){ao(t),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuAppearance"){Dd(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuAI"){Hd(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuRiffCard"){Nd(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuEditor"){Rd(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuSafeQuit"){Sa(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuAbout"){Od(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuNewDaily"){fc(),Be(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuCard"){Ed(t),Be(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuNewNotebook"){Ki(),Be(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuHelp"){Gi(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuLock"){Dc(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuSync"){It({title:window.siyuan.languages.cloud,icon:"iconCloud",html:it.genHTML(),bindEvent(l){it.element=l,it.bindEvent()}}),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuSyncNow"){qo(),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuHistory"){so(t),i.preventDefault(),i.stopPropagation();break}else if(s.id==="menuAccount"){if(i.preventDefault(),i.stopPropagation(),document.querySelector("#menuAccount img")){Wo();return}qd();break}s=s.parentElement}})},Ud=(t,e,n,a)=>{const i=t.target,s=ms();if(typeof e=="undefined"&&new Date().getTime()-n>900){const l=A(i,"data-type","navigation-root")||A(i,"data-type","navigation-file");if(l){if(!window.siyuan.config.readonly&&l.dataset.type==="navigation-root"){const o=Mo(a,l);if(s){const r=l.getBoundingClientRect();o.popup({x:r.right-52,y:r.bottom,h:r.height}),Cn()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(l.dataset.type==="navigation-file"){const o=wt(l,"UL");if(o){const r=Ho(a,o.dataset.url,l.dataset.path,l);if(s){const c=l.getBoundingClientRect();r.popup({x:c.right-52,y:c.bottom,h:c.height}),Cn()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(i.tagName==="SPAN"&&!A(i,"data-type","NodeBlockQueryEmbed")){let o;if(N(i,"protyle-wysiwyg",!0)&&(o=St()),!o)return!1;const r=(i.getAttribute("data-type")||"").split(" ");if(r.includes("inline-memo")&&o.protyle.toolbar.showRender(o.protyle,i),o.protyle.disabled)return t.stopImmediatePropagation(),t.preventDefault(),!0;if(r.includes("block-ref"))return Ri(o.protyle,i),!0;if(r.includes("file-annotation-ref"))return Oi(o.protyle,i),!0;if(r.includes("tag"))return Wi(o.protyle,i),!0;if(r.includes("a"))return ya(o.protyle,i),!0}}return!1};let aa,Ha,Ve,ia,di,vn,Bt;const ui=(t=!0)=>{t?document.getElementById("toolbarFile").dispatchEvent(new CustomEvent("click")):(pt(),$t(),document.getElementById("sidebar").style.transform="translateX(0px)")},Wd=(t,e)=>{if(Wa()&&Ud(t,ia,di,e)){t.stopImmediatePropagation(),t.preventDefault();return}const n=t.target;if(!aa||!Ha||typeof ia=="undefined"||n.tagName==="AUDIO"||N(n,"b3-dialog",!0)||window.siyuan.mobile.editor&&!window.siyuan.mobile.editor.protyle.toolbar.subElement.classList.contains("fn__none")||N(n,"viewer-container")||N(n,"keyboard")||A(n,"id","commonMenu")||A(n,"id","model",!0))return;window.siyuan.mobile.editor&&(window.siyuan.mobile.editor.protyle.contentElement.style.overflow=""),aa=null;let a=A(n,"data-type","NodeCodeBlock")||A(n,"data-type","NodeAttributeView")||A(n,"data-type","NodeTable")||tt(n,"list");if(a&&(a.classList.contains("table")?a=a.firstElementChild:a.classList.contains("code-block")?a=a.firstElementChild.nextElementSibling:a.classList.contains("av")&&(a=a.querySelector(".av__scroll")),Ve<=0&&a.scrollLeft>0||Ve>=0&&a.clientWidth+a.scrollLeft<a.scrollWidth)){Be();return}let i=!1;(new Date().getTime()-di<1e3||Math.abs(Ve)>window.innerWidth/3)&&(i=!0);const s=Math.abs(Ve)>Math.abs(ia);if(A(n,"id","menu")){s?vn==="toRight"?Bt?Ma():Be():Bt?Be():Ma():Ma();return}if(A(n,"id","sidebar")){s?vn==="toLeft"?Bt?ui(!1):Be():Bt?Be():ui(!1):ui(!1);return}if(!i||!s){Be();return}Ve>0?Bt?Be():Ma():Bt?Be():ui()},Yd=t=>{vn=null,Ve=void 0,ia=void 0,Bt=void 0,Wa()||t.touches[0].clientX>8&&t.touches[0].clientX<window.innerWidth-8?(aa=t.touches[0].clientX,Ha=t.touches[0].clientY,di=new Date().getTime()):(aa=null,Ha=null,di=0,t.stopImmediatePropagation())};let fi;const jd=t=>{const e=t.target;if(!(!aa||!Ha||e.tagName==="AUDIO"||N(e,"b3-dialog",!0)||window.siyuan.mobile.editor&&!window.siyuan.mobile.editor.protyle.toolbar.subElement.classList.contains("fn__none")||N(e,"keyboard")||N(e,"viewer-container")||A(e,"id","commonMenu")||A(e,"id","model",!0))){if(getSelection().rangeCount>0){const n=getSelection().getRangeAt(0);if(n.toString()!==""&&window.siyuan.mobile.editor.protyle.wysiwyg.element.contains(n.startContainer))return}if(Ve=Math.floor(aa-t.touches[0].clientX),ia=Math.floor(Ha-t.touches[0].clientY),vn||(vn=Ve>0?"toLeft":"toRight"),fi&&(vn==="toRight"?fi>t.touches[0].clientX?Bt=t.touches[0].clientX:Bt=void 0:vn==="toLeft"&&(fi<t.touches[0].clientX?Bt=t.touches[0].clientX:Bt=void 0)),fi=t.touches[0].clientX,Math.abs(Ve)>Math.abs(ia)){let n=A(e,"data-type","NodeCodeBlock")||A(e,"data-type","NodeAttributeView")||A(e,"data-type","NodeTable")||tt(e,"list");if(n&&(n.classList.contains("table")?n=n.firstElementChild:n.classList.contains("code-block")?n=n.firstElementChild.nextElementSibling:n.classList.contains("av")&&(n=n.querySelector(".av__scroll")),Ve<0&&n.scrollLeft>0||Ve>0&&n.clientWidth+n.scrollLeft<n.scrollWidth))return;const a=window.innerWidth,i=A(e,"id","menu");if(i){Ve<0?(i.style.transform=`translateX(${-Ve}px)`,sa(-Ve/a)):(i.style.transform="translateX(0px)",sa(0));return}const s=A(e,"id","sidebar");if(s){Ve>0?(s.style.transform=`translateX(${-Ve}px)`,sa(Ve/a)):(s.style.transform="translateX(0px)",sa(0));return}vn==="toRight"?(document.getElementById("sidebar").style.transform=`translateX(${-Ve-a}px)`,sa((a+Ve)/a)):(document.getElementById("menu").style.transform=`translateX(${a-Ve}px)`,sa((a-Ve)/a)),$t(),pt(),window.siyuan.mobile.editor&&(window.siyuan.mobile.editor.protyle.contentElement.style.overflow="hidden")}}},sa=t=>{const e=document.querySelector(".side-mask");e.classList.remove("fn__none"),e.style.opacity=Math.min(1-t,.68).toString()},Go=()=>{_("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{t.data.snippets.forEach(e=>{const n=`snippet${e.type==="css"?"CSS":"JS"}${e.id}`;let a=document.getElementById(n);if(!e.enabled){a&&a.remove();return}if(a){if(a.innerHTML===e.content)return;a.remove()}e.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${n}">${e.content}</style>`):e.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=e.content,a.id=n,document.head.appendChild(a))})})},Iu=()=>{fetchPost("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{let e="",n="";t.data.snippets.forEach(s=>{s.type==="css"?e+=us(s):n+=us(s)});const a=new Dialog({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        ${e}
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="addCodeSnippetCSS">
                <svg><use xlink:href="#iconAdd"></use></svg> ${window.siyuan.languages.addAttr} CSS
            </button>
        </div>
    </div>
    <div class="fn__none">
        ${n}
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="addCodeSnippetJS">
                <svg><use xlink:href="#iconAdd"></use></svg> ${window.siyuan.languages.addAttr} JS
            </button>
        </div>
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`});t.data.snippets.forEach(s=>{const l=a.element.querySelector(`[data-id="${s.id}"] input`);l.value=s.name;const o=a.element.querySelector(`[data-id="${s.id}"] textarea`);o.textContent=s.content});const i=[];a.element.addEventListener("click",s=>{const l=s.target;if(l.id==="addCodeSnippetCSS"||l.id==="addCodeSnippetJS"){l.parentElement.insertAdjacentHTML("beforebegin",us({type:l.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!1}));return}if(l.classList.contains("b3-button--cancel")){a.destroy();return}if(l.classList.contains("b3-button--text")){const c=[];a.element.querySelectorAll("[data-id]").forEach(u=>{c.push({id:u.getAttribute("data-id"),name:u.querySelector("input").value,type:u.getAttribute("data-type"),content:u.querySelector("textarea").value,enabled:u.querySelector(".b3-switch").checked})}),fetchPost("/api/snippet/setSnippet",{snippets:c},()=>{i.forEach(u=>{const d=document.querySelector(u);d&&d.remove()}),Go(),a.destroy()});return}const o=hasClosestByClassName(l,"item");if(o){o.getAttribute("data-type")==="css"?(o.classList.add("item--focus"),o.nextElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(o.classList.add("item--focus"),o.previousElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none"));return}const r=hasClosestByClassName(l,"b3-tooltips");if(r){const c=r.parentElement.parentElement;i.push("#snippet"+(c.getAttribute("data-type")==="css"?"CSS":"JS")+c.getAttribute("data-id")),c.nextElementSibling.remove(),c.remove()}})})},us=t=>`<div data-id="${t.id||""}" data-type="${t.type}">
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__flex-1 fn__space"></div>
        <input data-type="snippet" class="b3-switch fn__flex-center" type="checkbox"${t.enabled?" checked":""}>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
</div><div class="fn__hr--b"></div>`;class zd extends ii{constructor(e){super({app:e,id:Bn(),type:"filetree",msgCallback(a){if(a)switch(a.cmd){case"moveDoc":this.onMove(a.data);break;case"reloadFiletree":Jt(()=>{this.init(!1)});break;case"mount":this.onMount(a);break;case"createnotebook":Jt(i=>{let s;i.find(l=>{if(!l.closed){if(l.id===a.data.box.id)return s?this.element.querySelector(`.b3-list[data-url="${s}"]`).insertAdjacentHTML("afterend",this.genNotebook(a.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(a.data.box)),!0;s=l.id}})});break;case"unmount":case"removeDoc":this.onRemove(a);break;case"createdailynote":case"create":case"heading2doc":case"li2doc":this.onMkdir(a.data);break;case"renamenotebook":this.element.querySelector(`[data-url="${a.data.box}"] .b3-list-item__text`).innerHTML=a.data.name;break;case"rename":this.onRename(a.data);break}}}),this.genFileHTML=a=>{let i="";return a.count&&a.count>0&&(i=`<span class="counter">${a.count}</span>`),`<li data-node-id="${a.id}" data-name="${Lute.EscapeHTMLStr(a.name)}" data-type="navigation-file" 
class="b3-list-item" data-path="${a.path}">
    <span style="padding-left: ${(a.path.split("/").length-2)*20+24}px" class="b3-list-item__toggle${a.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon">${le(a.icon||(a.subFileCount===0?g.SIYUAN_IMAGE_FILE:g.SIYUAN_IMAGE_FOLDER))}</span>
    <span class="b3-list-item__text">${ze(a.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${i}
</li>`};const n=document.querySelector('#sidebar [data-type="sidebar-file"]');n.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">${window.siyuan.languages.fileTree}</div>
    <div class="fn__flex-1 fn__space"></div>
    <svg data-type="newNotebook" class="toolbar__icon"><use xlink:href="#iconFilesRoot"></use></svg>
    <svg data-type="refresh" class="toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
    <svg data-type="focus" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>
</div>
<div class="fn__flex-1"></div>
<ul class="b3-list b3-list--background fn__flex-column" style="min-height: auto;transition: var(--b3-transition)">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=n.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=this.element.nextElementSibling,n.addEventListener("click",a=>{let i=a.target;for(;i&&!i.isEqualNode(this.actionsElement);){const s=i.getAttribute("data-type");if(s==="refresh"){if(!i.getAttribute("disabled")){i.setAttribute("disabled","disabled");const l=[];Array.from(this.element.children).forEach(o=>{l.push(o.getAttribute("data-url"))}),_("/api/filetree/refreshFiletree",{},()=>{i.removeAttribute("disabled"),this.init(!1)})}a.preventDefault();break}else if(s==="focus"){window.siyuan.mobile.editor&&this.selectItem(window.siyuan.mobile.editor.protyle.notebookId,window.siyuan.mobile.editor.protyle.path),a.preventDefault();break}else if(s==="newNotebook")Ki();else if(s==="collapse"){Array.from(this.element.children).forEach(l=>{const o=l.firstElementChild,r=o.querySelector(".b3-list-item__arrow");r.classList.contains("b3-list-item__arrow--open")&&(r.classList.remove("b3-list-item__arrow--open"),o.nextElementSibling.remove())}),a.preventDefault();break}else if(s==="sort"){this.genSort(),a.preventDefault(),a.stopPropagation();break}else if(i.classList.contains("b3-list-item__toggle")&&!i.classList.contains("fn__hidden")&&i.parentElement.getAttribute("data-type")!=="toggle"){const l=wt(i,"UL");if(l){const o=l.getAttribute("data-url");this.getLeaf(i.parentElement,o),this.setCurrent(i.parentElement),window.siyuan.menus.menu.remove()}a.preventDefault(),a.stopPropagation();break}else if(s==="toggle"){this.closeElement.classList.contains("fn__flex-1")?(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1"),i.querySelector("svg").classList.remove("b3-list-item__arrow--open")):(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1"),i.querySelector("svg").classList.add("b3-list-item__arrow--open")),a.stopPropagation(),a.preventDefault();break}else if(s==="remove"){Te(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${$e(i.parentElement.querySelector(".b3-list-item__text").textContent)}</b>?`,()=>{_("/api/notebook/removeNotebook",{notebook:i.getAttribute("data-url"),callback:g.CB_MOUNT_REMOVE})}),a.stopPropagation(),a.preventDefault();break}else if(s==="open"){_("/api/notebook/openNotebook",{notebook:i.getAttribute("data-url")}),a.stopPropagation(),a.preventDefault();break}else if(i.classList.contains("b3-list-item__action")){const l=i.getAttribute("data-type"),o=i.parentElement.getAttribute("data-path"),r=wt(i,"UL");if(r){const c=r.getAttribute("data-url");window.siyuan.config.readonly||(l==="new"?Jn({app:e,notebookId:c,currentPath:o,useSavePath:!1}):l==="more-root"&&(Mo(e,i.parentElement),window.siyuan.menus.menu.fullscreen("bottom"))),l==="more-file"&&(Ho(e,c,o,i.parentElement),window.siyuan.menus.menu.fullscreen("bottom"))}a.preventDefault(),a.stopPropagation();break}else if(i.tagName==="LI"){if(this.setCurrent(i),i.getAttribute("data-type")==="navigation-file")Ke(e,i.getAttribute("data-node-id"));else if(i.getAttribute("data-type")==="navigation-root"){const l=wt(i,"UL");if(l){const o=l.getAttribute("data-url");this.getLeaf(i,o)}}a.preventDefault();break}i=i.parentElement}}),this.init(),window.siyuan.config.openHelp&&Gi()}genSort(){window.siyuan.menus.menu.remove(),No("notebooks",window.siyuan.config.fileTree.sort,n=>{window.siyuan.config.fileTree.sort=n,_("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{Jt(()=>{this.init(!1)})})}).forEach(n=>{window.siyuan.menus.menu.append(new T(n).element)}),window.siyuan.menus.menu.fullscreen("bottom")}genNotebook(e){const n=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${le(e.icon||g.SIYUAN_IMAGE_NOTE)}</span>`;return e.closed?`<li data-type="open" data-url="${e.id}" class="b3-list-item">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text">${$e(e.name)}</span>
    <span data-type="remove" data-url="${e.id}" class="b3-list-item__action${window.siyuan.config.readonly?" fn__none":""}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${e.id}" data-sortmode="${e.sortMode}">
<li class="b3-list-item" data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle${e.closed?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text${e.closed?" ft__on-surface":""}">${$e(e.name)}</span>
    <span data-type="more-root" class="b3-list-item__action${window.siyuan.config.readonly||e.closed?" fn__none":""}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action${window.siyuan.config.readonly||e.closed?" fn__none":""}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(e=!0){let n="",a="";window.siyuan.notebooks.forEach(i=>{i.closed?a+=this.genNotebook(i):n+=this.genNotebook(i)}),this.element.innerHTML=n,this.closeElement.lastElementChild.innerHTML=a,e&&(n===""?(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1")):(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1")))}onMove(e){const n=this.element.querySelector(`ul[data-url="${e.fromNotebook}"] li[data-path="${e.fromPath}"]`);if(n)if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),n.parentElement.childElementCount===1){if(n.parentElement.previousElementSibling){n.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),n.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const i=n.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");i.innerHTML===le(g.SIYUAN_IMAGE_FOLDER)&&(i.innerHTML=le(g.SIYUAN_IMAGE_FILE))}n.parentElement.remove()}else n.remove();const a=this.element.querySelector(`[data-url="${e.toNotebook}"] li[data-path="${e.toPath}"]`);if(a){const i=a.querySelector(".b3-list-item__icon");i.innerHTML===le(g.SIYUAN_IMAGE_FILE)&&(i.innerHTML=le(g.SIYUAN_IMAGE_FOLDER)),a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden"),a.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&a.nextElementSibling.remove(),this.getLeaf(a,e.toNotebook)}}onMkdir(e){let n=this.element.querySelector(`ul[data-url="${e.box.id}"]`),a=we().dirname(e.path)+".sy";for(;a!=="/"&&(n=n.querySelector(`li[data-path="${a}"]`),!n);)n=this.element.querySelector(`ul[data-url="${e.box.id}"]`),a=we().dirname(a);if(n.tagName==="UL"&&(we().dirname(e.path)==="/"?n=n.firstElementChild:n=void 0),n){n.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),n.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=n.querySelector(".b3-list-item__icon");i.innerHTML===le(g.SIYUAN_IMAGE_FILE)&&(i.innerHTML=le(g.SIYUAN_IMAGE_FOLDER)),n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),this.getLeaf(n,e.box.id)}}onRemove(e){if(e.cmd==="unmount"){if(Jt(n=>{const a=this.element.querySelector(`ul[data-url="${e.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),g.CB_MOUNT_REMOVE!==e.callback)){let i="";n.find(s=>{s.closed&&(i+=this.genNotebook(s))}),this.closeElement.lastElementChild.innerHTML=i}}),g.CB_MOUNT_REMOVE===e.callback){const n=this.closeElement.querySelector(`li[data-url="${e.data.box}"]`);n&&n.remove()}return}e.data.ids.forEach(n=>{var a;const i=this.element.querySelector(`li.b3-list-item[data-node-id="${n}"]`);if(i){((a=i.nextElementSibling)==null?void 0:a.tagName)==="UL"&&i.nextElementSibling.remove();const s=i.parentElement.previousElementSibling;if(i.parentElement.childElementCount===1){if(s){const l=s.querySelector("svg");l.classList.remove("b3-list-item__arrow--open"),l.parentElement.classList.add("fn__hidden");const o=l.parentElement.nextElementSibling;o.innerHTML===le(g.SIYUAN_IMAGE_FOLDER)&&(o.innerHTML=le(g.SIYUAN_IMAGE_FILE))}i.parentElement.remove()}else i.remove()}})}onRename(e){const n=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);n&&(n.setAttribute("data-name",Lute.EscapeHTMLStr(e.title)),n.querySelector(".b3-list-item__text").innerHTML=$e(e.title))}onMount(e){if(e.data.existed)return;const n=this.closeElement.querySelector(`li[data-url="${e.data.box.id}"]`);n&&n.remove(),Jt(a=>{const i=this.genNotebook(e.data.box);if(this.element.childElementCount===0)this.element.innerHTML=i;else{let s;a.find((l,o)=>{if(l.id===e.data.box.id){for(;o>0;)if(a[o-1].closed)o--;else{s=a[o-1].id;break}return!0}}),s?this.element.querySelector(`[data-url="${s}"]`).insertAdjacentHTML("afterend",i):this.element.insertAdjacentHTML("afterbegin",i)}})}onLsHTML(e){let n="";if(e.files.forEach(s=>{n+=this.genFileHTML(s)}),n==="")return;const a=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);let i=a.nextElementSibling;i&&i.tagName==="UL"&&i.remove(),a.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),a.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${n}</ul>`),i=a.nextElementSibling,setTimeout(()=>{i.setAttribute("style",`height:${i.childElementCount*a.clientHeight}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(s=>{s.classList.remove("file-tree__sliderDown"),s.removeAttribute("style")})},120)},2)}onLsSelect(e,n){let a="";if(e.files.forEach(s=>{a+=this.genFileHTML(s),n===s.path?this.selectItem(e.box,n):n.startsWith(s.path.replace(".sy",""))&&_("/api/filetree/listDocsByPath",{notebook:e.box,path:s.path},l=>{this.selectItem(l.data.box,n,l.data)})}),a==="")return;const i=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);i.nextElementSibling&&i.nextElementSibling.tagName==="UL"&&i.nextElementSibling.remove(),i.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.insertAdjacentHTML("afterend",`<ul>${a}</ul>`),this.setCurrent(this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${n}"]`))}setCurrent(e){if(!e)return;this.element.querySelectorAll("li").forEach(a=>{a.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus");const n=this.actionsElement.clientHeight;e.offsetTop-n<this.element.scrollTop?this.element.scrollTop=e.offsetTop-n:e.offsetTop-this.element.clientHeight-n+e.clientHeight>this.element.scrollTop&&(this.element.scrollTop=e.offsetTop-this.element.clientHeight-n+e.clientHeight)}getLeaf(e,n){var a;const i=e.querySelector(".b3-list-item__arrow");if(i.classList.contains("b3-list-item__arrow--open")){i.classList.remove("b3-list-item__arrow--open"),(a=e.nextElementSibling)==null||a.remove();return}_("/api/filetree/listDocsByPath",{notebook:n,path:e.getAttribute("data-path")},s=>{if(s.data.path==="/"&&s.data.files.length===0){oe(window.siyuan.languages.emptyContent);return}this.onLsHTML(s.data)})}selectItem(e,n,a){const i=this.element.querySelector(`[data-url="${e}"]`);if(!i)return;let s=n,l;for(;!l;)if(l=i.querySelector(`[data-path="${s}"]`),!l){const o=we().dirname(s);o==="/"?s=o:s=o+".sy"}if(l.getAttribute("data-path")===n){this.setCurrent(l);return}a&&a.path===s?this.onLsSelect(a,n):_("/api/filetree/listDocsByPath",{notebook:e,path:s},o=>{this.onLsSelect(o.data,n)})}}class Na{constructor(e){this.click=e.click,this.ctrlClick=e.ctrlClick,this.altClick=e.altClick,this.shiftClick=e.shiftClick,this.rightClick=e.rightClick,this.toggleClick=e.toggleClick,this.element=e.element,this.blockExtHTML=e.blockExtHTML,this.topExtHTML=e.topExtHTML,this.updateData(e.data),this.bindEvent()}updateData(e){this.data=e,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),en(this.element))}genHTML(e){let n=`<ul${e[0].depth===0?" class='b3-list b3-list--background'":""}>`;return e.forEach(a=>{let i="",s='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(i=` aria-label="${ja(a.hPath)}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${_t(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(i=` aria-label="${ja(Lute.BlockDOM2Content(a.name))}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${_t(a.nodeType,a.subType)}"></use></svg>`);let l="";a.count&&(l=`<span class="counter">${a.count}</span>`);const o=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";H()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${(a.depth-1)*18+22}px;margin-right: 2px`,n+=`<li class="b3-list-item${H()?"":" b3-list-item--hide-action"}" 
${a.nodeType!=="NodeDocument"&&a.type==="backlink"?'draggable="true" ':""}
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${a.type==="backlink"||o?" b3-list-item__toggle--hl":""}${o||a.type==="backlink"?"":" fn__hidden"}">
        <svg data-id="${encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${o?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${s}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${i}>${a.name}</span>
    ${this.topExtHTML||""}
    ${l}
</li>`,a.children&&a.children.length>0&&(n+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(n+=this.genBlockHTML(a.blocks,!0,a.type)+"</ul>")}),n}genBlockHTML(e,n=!1,a){let i=`<ul class="${n?"":"fn__none"}">`;return e.forEach(s=>{let l="";s.count&&(l=`<span class="counter">${s.count}</span>`);let o;s.type==="NodeDocument"?o=`<span data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}">${le(s.ial.icon||g.SIYUAN_IMAGE_FILE)}</span>`:o=`<svg data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}"><use xlink:href="#${_t(s.type,s.subType)}"></use></svg>`;let r="";H()?s.depth>0&&(r=`padding-left: ${(s.depth-1)*20+24}px`):r=`padding-left: ${(s.depth-1)*18+22}px;margin-right: 2px`,i+=`<li ${a==="backlink"?'draggable="true"':""} 
class="b3-list-item${H()?"":" b3-list-item--hide-action"}"  
data-node-id="${s.id}" 
data-ref-text="${encodeURIComponent(s.refText)}" 
data-def-id="${s.defID}" 
data-type="${s.type}" 
data-subtype="${s.subType}" 
data-treetype="${a}"
data-def-path="${s.defPath}">
    <span style="${r}" class="b3-list-item__toggle${s.children?" b3-list-item__toggle--hl":""}${s.children?"":" fn__hidden"}">
        <svg data-id="${s.id}" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${o}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+ja(Lute.BlockDOM2Content(s.content))+'"':""}>${s.content}</span>
    ${l}
    ${this.blockExtHTML||""}
</li>`,s.children&&s.children.length>0&&(i+=this.genBlockHTML(s.children,!1,a)+"</ul>")}),i}toggleBlocks(e){if(this.toggleClick){this.toggleClick(e);return}if(!e.nextElementSibling)return;const n=e.firstElementChild.firstElementChild;n.classList.contains("b3-list-item__arrow--open")?(n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling.classList.add("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(e){e.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(n=>{n.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.tagName==="LI"&&this.rightClick){this.rightClick(n,e),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),this.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.classList.contains("b3-list-item__toggle")&&!n.classList.contains("fn__hidden")){this.toggleBlocks(n.parentElement),this.setCurrent(n.parentElement),e.preventDefault();break}if(n.classList.contains("b3-list-item__action")&&this.click){const a=R(n,"LI");a&&this.click(a,e),e.preventDefault(),e.stopPropagation();break}else if(n.tagName==="LI"){this.setCurrent(n),n.getAttribute("data-node-id")||n.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(n):this.altClick&&window.siyuan.altIsPressed?this.altClick(n):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(n):this.click&&this.click(n,e),e.stopPropagation()):this.toggleBlocks(n),e.preventDefault();break}n=n.parentElement}}),this.element.addEventListener("dragstart",e=>{const n=Je(e.target,"LI");n&&(e.dataTransfer.setData("text/html",n.outerHTML),n.style.opacity="0.1",window.siyuan.dragElement=n)}),this.element.addEventListener("dragend",e=>{const n=Je(e.target,"LI");n&&(n.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const e=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(n=>{e.push(n.getAttribute("data-id"))}),e}setExpandIds(e){this.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{e.includes(n.getAttribute("data-id"))?(n.classList.add("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(n.classList.remove("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.tagName==="UL"&&n.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}class Vd{constructor(e){this.openNodes={},this.element=document.querySelector('#sidebar [data-type="sidebar-outline"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.outline}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="fn__flex-1"></div>`,this.tree=new Na({element:this.element.lastElementChild,data:null,click:a=>{var i;const s=a.getAttribute("data-node-id");window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none")?_("/api/block/checkBlockFold",{id:s},l=>{Ke(e,s,l.data?[g.CB_GET_FOCUS,g.CB_GET_ALL,g.CB_GET_HTML]:[g.CB_GET_FOCUS,g.CB_GET_SETID,g.CB_GET_CONTEXT,g.CB_GET_HTML])}):(Be(),(i=document.getElementById(s))==null||i.scrollIntoView())}}),this.element.firstElementChild.querySelector('[data-type="collapse"]').addEventListener(qn(),()=>{this.tree.collapseAll()});const n=this.element.firstElementChild.querySelector('[data-type="expand"]');n.addEventListener(qn(),()=>{n.classList.contains("toolbar__icon--active")?n.classList.remove("toolbar__icon--active"):n.classList.add("toolbar__icon--active"),this.tree.expandAll()}),this.update()}update(){if(!window.siyuan.mobile.editor.protyle.preview.element.classList.contains("fn__none")){window.siyuan.mobile.editor.protyle.preview.render(window.siyuan.mobile.editor.protyle,e=>{this.tree.updateData(e)});return}_("/api/outline/getDocOutline",{id:window.siyuan.mobile.editor.protyle.block.rootID},e=>{let n,a=this.element.querySelector(".b3-list-item--focus");a&&(n=a.getAttribute("data-node-id"));const i=window.siyuan.mobile.editor.protyle.block.rootID;this.openNodes[i]&&(this.openNodes[i]=this.tree.getExpandIds()),this.tree.updateData(e.data),this.openNodes[i]&&!this.element.firstElementChild.querySelector('[data-type="expand"]').classList.contains("toolbar__icon--active")?this.tree.setExpandIds(this.openNodes[i]):(this.tree.expandAll(),this.openNodes[i]=this.tree.getExpandIds()),n&&(a=this.element.querySelector(`[data-node-id="${n}"]`),a&&a.classList.add("b3-list-item--focus"))})}}class Gd{constructor(e){this.beforeLen=10,this.element=document.querySelector('#sidebar [data-type="sidebar-backlink"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount"></span>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="toolbar">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount"></span>
    <span class="fn__space"></span>
    <svg data-type="mExpand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="mCollapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="layout" class="toolbar__icon"><use xlink:href="#iconDown"></use></svg>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.tree=new Na({element:this.element.querySelector(".backlinkList"),data:null,click(n){Ke(e,n.getAttribute("data-node-id"),[g.CB_GET_FOCUS,g.CB_GET_CONTEXT])}}),this.mTree=new Na({element:this.element.querySelector(".backlinkMList"),data:null,click:n=>{Ke(e,n.getAttribute("data-node-id"),[g.CB_GET_FOCUS,g.CB_GET_CONTEXT])}}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break;case"mExpand":this.mTree.expandAll();break;case"mCollapse":this.mTree.collapseAll();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")):a.getAttribute("aria-label")===window.siyuan.languages.down?(this.mTree.element.setAttribute("style","flex:none;height:0px"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")),a.setAttribute("data-clicked","true");break}a=a.parentElement}}),this.update()}update(){_("/api/ref/getBacklink",{id:window.siyuan.mobile.editor.protyle.block.id,beforeLen:this.beforeLen,k:"",mk:""},e=>{this.notebookId=e.data.box,this.tree.updateData(e.data.backlinks),this.mTree.updateData(e.data.backmentions);const n=this.element.querySelector(".listCount");e.data.linkRefsCount===0?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=e.data.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");e.data.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=e.data.mentionsCount.toString());const i=this.element.querySelector("[data-type='layout']");if(!i.getAttribute("data-clicked")){if(e.data.mentionsCount===0){this.mTree.element.setAttribute("style","flex:none;height:0px"),i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp");return}e.data.linkRefsCount===0?(this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")):(this.mTree.element.removeAttribute("style"),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown"))}})}}const Kd=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="bookmarkMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=t.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new T({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent,s=new be({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:H()?"92vw":"520px"}),l=s.element.querySelectorAll(".b3-button");l[0].addEventListener("click",()=>{s.destroy()});const o=s.element.querySelector("input");s.bindInput(o,()=>{l[1].click()}),o.value=i,o.focus(),o.select(),l[1].addEventListener("click",()=>{_("/api/bookmark/renameBookmark",{oldBookmark:i,newBookmark:o.value},()=>{s.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:ma(t.getAttribute("data-node-id"),!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent;Te(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${$e(i)}</b>`),()=>{a?(_("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{n.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(s=>{s.setAttribute("bookmark","");const l=s.querySelector(".protyle-attr--bookmark");l&&l.remove()})):_("/api/bookmark/removeBookmark",{bookmark:i})})}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","bookmarkMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Zd{constructor(e){this.element=document.querySelector('#sidebar [data-type="sidebar-bookmark"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
</div>
<div class="fn__flex-1 bookmarkList"></div>
<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new Na({element:this.element.querySelector(".bookmarkList"),data:null,click:(n,a)=>{const i=n.getAttribute("data-node-id");if(a){const s=N(a.target,"b3-list-item__action");if(s){Kd(s.parentElement,a,this);return}}_("/api/block/checkBlockFold",{id:i},s=>{Ke(e,i,s.data?[g.CB_GET_FOCUS,g.CB_GET_ALL]:[g.CB_GET_FOCUS,g.CB_GET_CONTEXT,g.CB_GET_ROOTSCROLL])})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll();break;case"expand":this.tree.expandAll();break}a=a.parentElement}}),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),_("/api/bookmark/getBookmark",{},e=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(e.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")})}}const Xd=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tagMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{hs(n)}}).element),window.siyuan.menus.menu.append(new T({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{Te(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${$e(n)}</b>?`,()=>{_("/api/tag/removeTag",{label:n})})}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","tagMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Qd{constructor(e){this.element=document.querySelector('#sidebar [data-type="sidebar-tag"]'),this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.tag}
    </div>
    <span class="fn__space"></span>
    <svg data-type="expand" class="toolbar__icon"><use xlink:href="#iconExpand"></use></svg>
    <span class="fn__space"></span>
    <svg data-type="collapse" class="toolbar__icon"><use xlink:href="#iconContract"></use></svg>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <svg data-type="sort" class="toolbar__icon${window.siyuan.config.readonly?" fn__none":""}"><use xlink:href="#iconSort"></use></svg>
</div>
<div class="fn__flex-1 tagList"></div>
<img style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 30vw;box-sizing: border-box;" src="/stage/loading-pure.svg">`,this.tree=new Na({element:this.element.querySelector(".tagList"),data:null,click:(n,a)=>{const i=n.getAttribute("data-label");if(a){const l=N(a.target,"b3-list-item__action");if(l){Xd(l.parentElement,a,i);return}}const s=window.siyuan.storage[g.LOCAL_SEARCHDATA];zt(e,{removed:s.removed,sort:s.sort,group:s.group,hasReplace:!1,method:0,hPath:"",idPath:[],k:`#${i}#`,r:"",page:1,types:Object.assign({},s.types)})},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("toolbar__icon"))switch(a.getAttribute("data-type")){case"collapse":this.tree.collapseAll(),n.preventDefault(),n.stopPropagation();break;case"expand":this.tree.expandAll(),n.preventDefault(),n.stopPropagation();break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new T({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}}),this.update()}update(){this.element.lastElementChild.classList.remove("fn__none"),_("/api/tag/getTag",{sort:window.siyuan.config.tag.sort},e=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(e.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),this.element.lastElementChild.classList.add("fn__none")})}}class Jd extends ii{constructor(e,n){super({app:e,id:n.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},n instanceof Element?this.element=n:this.element=n.panelElement,this.element.innerHTML=`<div class="toolbar toolbar--border toolbar--dark">
    <div class="fn__space"></div>
    <div class="toolbar__text">
        ${window.siyuan.languages.inbox}
        <span class="fn__space"></span>
        <span class="inboxSelectCount ft__smaller ft__on-surface"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="toolbar__icon" data-type="selectall" type="checkbox">  
    <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href='#iconLeft'></use></svg>
    <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href='#iconRight'></use></svg>
    <svg data-type="more" class="toolbar__icon"><use xlink:href='#iconMore'></use></svg>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),i=this.element.querySelector(".inboxDetails"),s=this.element.firstElementChild.querySelector("input");this.element.addEventListener("click",l=>{let o=l.target;for(;o&&!o.isEqualNode(this.element);){if(o.tagName==="A"){l.stopPropagation();break}const r=o.getAttribute("data-type");if(r==="min"){getDockByType("inbox").toggleModel("inbox"),l.preventDefault();break}else if(r==="selectall"){o.checked?this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("input").checked=!0,this.selectIds.push(c.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}):this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(c=>{c.querySelector("input").checked=!1,this.selectIds.splice(this.selectIds.indexOf(c.getAttribute("data-id")),1)}),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),l.stopPropagation();break}else if(r==="select"){o.firstElementChild.nextElementSibling.checked?(this.selectIds.push(o.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]):this.selectIds.splice(this.selectIds.indexOf(o.parentElement.getAttribute("data-id")),1),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,s.checked=this.element.lastElementChild.querySelectorAll("input:checked").length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length,window.siyuan.menus.menu.remove(),l.stopPropagation();break}else if(r==="previous"){o.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),l.preventDefault();break}else if(r==="next"){o.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),l.preventDefault();break}else if(r==="back"){this.back(),l.preventDefault();break}else if(r==="more"){this.more(l),l.stopPropagation(),l.preventDefault();break}else if(o.classList.contains("b3-list-item")){const c=this.data[o.getAttribute("data-id")];s.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),i.innerHTML=this.genDetail(c),i.setAttribute("data-id",c.oId),i.classList.remove("fn__none"),i.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),l.preventDefault();break}o=o.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector("input").classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(e){let n="";return e.shorthandURL&&(n=`<a href="${e.shorthandURL}" target="_blank">
        <svg class="toolbar__icon" style="float: left"><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="toolbar toolbar--dark">
    <svg data-type="back" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
    <span data-type="back" class="toolbar__text fn__flex-1">${e.shorthandTitle}</span>
    ${n}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px">
${Lute.New().MarkdownStr("",e.shorthandContent)}
</div>`}more(e){const n=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{n.classList.contains("fn__none")?(this.currentPage=1,this.update()):_("/api/inbox/getShorthand",{id:n.getAttribute("data-id")},i=>{n.innerHTML=this.genDetail(i.data),n.scrollTop=0})}}).element);let a=[];n.classList.contains("fn__none")?a=this.selectIds:a=[n.getAttribute("data-id")],a.length>0&&(window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(a)}}).element),window.siyuan.menus.menu.append(new T({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{Te(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete+"?",()=>{n.classList.contains("fn__none")?this.remove():this.remove(n.getAttribute("data-id"))})}}).element)),window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}remove(e){let n;e?n=[e]:n=this.selectIds,_("/api/inbox/removeShorthands",{ids:n},()=>{e?(this.back(),this.selectIds.find((a,i)=>{if(a===e)return this.selectIds.splice(i,1),!0})):this.selectIds=[],this.currentPage=1,this.update()})}move(e){Rn((n,a)=>{e.forEach(i=>{_("/api/filetree/createDoc",{notebook:a[0],path:we().join(ze(n[0],!1,!0),Lute.NewNodeID()+".sy"),title:Ut(this.data[i].shorthandTitle),md:this.data[i].shorthandContent},()=>{this.remove(i)})})})}update(){const e=this.element.querySelector(".fn__loading");if(Qt("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",dt("subscribe/siyuan"))}
    </li>
</ul>`,e.classList.add("fn__none");return}e.classList.contains("fn__none")&&(e.classList.remove("fn__none"),_("/api/inbox/getShorthands",{page:this.currentPage},n=>{e.classList.add("fn__none");let a="";n.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',n.data.data.shorthands.forEach(o=>{a+=`<li style="padding-left: 0" data-id="${o.oId}" class="b3-list-item">
    <label data-type="select" class="fn__flex">
        <span class="fn__space"></span>
        <input class="fn__flex-center" type="checkbox"${this.selectIds.includes(o.oId)?" checked":""}>
        <span class="fn__space"></span>
    </label>
    <span class="b3-list-item__text" title="${o.shorthandTitle}${o.shorthandTitle===o.shorthandDesc?"":`
`+o.shorthandDesc}">${o.shorthandTitle}</span>
    <span class="b3-list-item__meta">${o.hCreated}</span>
</li>`,this.data[o.oId]=o}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=n.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const i=this.element.querySelector('[data-type="previous"]'),s=this.element.querySelector('[data-type="next"]');n.data.data.pagination.paginationPageCount>this.currentPage?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),this.currentPage===1?i.setAttribute("disabled","disabled"):i.removeAttribute("disabled");const l=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector("input").checked=this.element.lastElementChild.querySelectorAll("input:checked").length===l&&l!==0,this.element.lastElementChild.scrollTop=0}))}}const eu=t=>{yi(),Go(),Jr();const e=document.getElementById("sidebar");let n,a,i,s,l;const o=e.querySelector(".toolbar--border");if(o.addEventListener("click",r=>{const c=wt(r.target,"svg");if(!c||c.classList.contains("toolbar__icon--active"))return;const u=c.getAttribute("data-type");if(!u){Be();return}o.querySelectorAll(".toolbar__icon").forEach(d=>{const f=d.getAttribute("data-type");f&&(f===u?(u==="sidebar-outline-tab"?n?n.update():n=new Vd(t):u==="sidebar-backlink-tab"?a?a.update():a=new Gd(t):u==="sidebar-bookmark-tab"?i?i.update():i=new Zd(t):u==="sidebar-tag-tab"?l?l.update():l=new Qd(t):u==="sidebar-inbox-tab"&&!s&&(s=new Jd(t,document.querySelector('#sidebar [data-type="sidebar-inbox"]'))),c.classList.add("toolbar__icon--active"),e.lastElementChild.querySelector(`[data-type="${f.replace("-tab","")}"]`).classList.remove("fn__none")):(d.classList.remove("toolbar__icon--active"),e.lastElementChild.querySelector(`[data-type="${f.replace("-tab","")}"]`).classList.add("fn__none")))})}),window.siyuan.mobile.files=new zd(t),document.getElementById("toolbarFile").addEventListener("click",()=>{pt(),$t(),e.style.transform="translateX(0px)";const r=e.querySelector(".toolbar--border .toolbar__icon--active").getAttribute("data-type");r==="sidebar-outline-tab"?n.update():r==="sidebar-backlink-tab"?a.update():r==="sidebar-bookmark-tab"?i.update():r==="sidebar-tag-tab"&&l.update()}),document.getElementById("toolbarMore").addEventListener("click",()=>{Ma()}),document.getElementById("toolbarSync").addEventListener(qn(),()=>{qo(t)}),document.getElementById("modelClose").addEventListener("click",()=>{El()}),tu(),Ga()>0){if(window.JSAndroid&&window.openFileByURL(window.JSAndroid.getBlockURL()))return;const r=ur();if(r.id){Ke(t,r.id,r.isZoomIn?[g.CB_GET_ALL,g.CB_GET_FOCUS]:[g.CB_GET_FOCUS,g.CB_GET_CONTEXT,g.CB_GET_ROOTSCROLL]);return}const c=window.siyuan.storage[g.LOCAL_DOCINFO];_("/api/block/checkBlockExist",{id:c.id},u=>{u.data?Ke(t,c.id,[g.CB_GET_SCROLL]):_("/api/block/getRecentUpdatedBlocks",{},d=>{d.data.length!==0?Ke(t,d.data[0].id,[g.CB_GET_HL,g.CB_GET_CONTEXT,g.CB_GET_ROOTSCROLL]):xa(t)})});return}xa(t)},tu=()=>{const t=document.getElementById("toolbarName");t.setAttribute("placeholder",window.siyuan.languages._kernel[16]),t.addEventListener("blur",()=>{if(t.getAttribute("readonly")!=="readonly"){if(!Xa(t.value))return t.value=t.value.substring(0,g.SIZE_TITLE),!1;_("/api/filetree/renameDoc",{notebook:window.siyuan.mobile.editor.protyle.notebookId,path:window.siyuan.mobile.editor.protyle.path,title:t.value})}})},nu=()=>{_("/api/system/getChangelog",{},t=>{if(!t.data.show)return;const e=new be({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:H()?"92vw":"768px",height:H()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${t.data.html}</div>`});Ae(e.element)})},au=(t,e="/",n="module")=>{!("serviceWorker"in navigator)||typeof navigator.serviceWorker=="undefined"||!("caches"in window)||!("fetch"in window)||window.navigator.serviceWorker.register(t,{scope:e,type:n}).then(a=>{a.update()}).catch(a=>{console.debug(`Registration failed with ${a}`)})};class iu{constructor(e){this.defIds=[],this.editors=[],this.id=Bn(),this.targetElement=e.targetElement,this.nodeIds=e.nodeIds,this.defIds=e.defIds||[],this.app=e.app,this.x=e.x,this.y=e.y,this.isBacklink=e.isBacklink,this.element=document.createElement("div"),this.element.classList.add("block__popover");const n=N(this.targetElement,"block__popover",!0);let a=1;n?(this.element.setAttribute("data-oid",n.getAttribute("data-oid")),a=parseInt(n.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.nodeIds[0]),this.element.setAttribute("data-level",a.toString());for(let i=0;i<window.siyuan.blockPanels.length;i++){const s=window.siyuan.blockPanels[i];s.element.getAttribute("data-pin")==="false"&&s.targetElement&&parseInt(s.element.getAttribute("data-level"))>=a&&(s.destroy(),i--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",i=>{const s=i.target,l=N(s,"block__icons");if(l){const o=l.querySelector('[data-type="pin"]');o.classList.contains("block__icon--active")?(o.classList.remove("block__icon--active"),o.setAttribute("aria-label",window.siyuan.languages.pin),this.element.setAttribute("data-pin","false")):(o.classList.add("block__icon--active"),o.setAttribute("aria-label",window.siyuan.languages.unpin),this.element.setAttribute("data-pin","true")),i.preventDefault(),i.stopPropagation()}}),this.element.addEventListener("click",i=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let s=i.target;for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("block__icon")||s.classList.contains("block__logo")){const l=s.getAttribute("data-type");l==="close"?this.destroy():l==="pin"&&(s.classList.contains("block__icon--active")?(s.classList.remove("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.pin),this.element.setAttribute("data-pin","false")):(s.classList.add("block__icon--active"),s.setAttribute("aria-label",window.siyuan.languages.unpin),this.element.setAttribute("data-pin","true"))),i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),this.render()}initProtyle(e,n){const a=parseInt(e.getAttribute("data-index"));_("/api/block/getBlockInfo",{id:this.nodeIds[a]},i=>{if(i.code===3){oe(i.msg);return}if(!this.targetElement&&typeof this.x=="undefined"&&typeof this.y=="undefined")return;const s=[];i.data.rootID!==this.nodeIds[a]?s.push(g.CB_GET_ALL):(s.push(g.CB_GET_CONTEXT),s.push(g.CB_GET_HL)),this.isBacklink&&s.push(g.CB_GET_BACKLINK);const l=new un(this.app,e,{blockId:this.nodeIds[a],defId:this.defIds[a]||this.defIds[0]||"",action:s,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1,after:o=>{e.addEventListener("mouseleave",()=>{Y(["gutter"],o.protyle)}),i.data.rootID!==this.nodeIds[a]&&o.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),n&&n(),(o.protyle.element.nextElementSibling||o.protyle.element.previousElementSibling)&&(o.protyle.element.style.minHeight=Math.min(30+o.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),o.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(o.protyle.contentElement.clientHeight-49,200)}px;${H()?"":"right:10px"}`)}});this.editors.push(l)})}destroy(){window.siyuan.blockPanels.find((e,n)=>{if(e.id===this.id)return window.siyuan.blockPanels.splice(n,1),!0}),this.editors.length>0&&(this.editors.forEach(e=>{Y(["util"],e.protyle),e.destroy()}),this.editors=[]),this.element.remove(),this.element=void 0,this.targetElement=void 0,window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let n=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.nodeIds.length===0?n+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.nodeIds.forEach((i,s)=>{n+=`<div class="block__edit fn__flex-1 protyle" data-index="${s}"></div>`}),n&&(n+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=n;const a=new IntersectionObserver(i=>{i.forEach(s=>{s.isIntersecting&&s.target.innerHTML===""&&this.initProtyle(s.target)})},{threshold:0});this.element.querySelectorAll(".block__edit").forEach((i,s)=>{s<5?this.initProtyle(i,s===0?()=>{let l;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){l=this.targetElement.getBoundingClientRect();let r=l.top;const c=N(this.targetElement,"protyle-content",!0);if(c){const u=c.getBoundingClientRect().top;l.top<u&&(r=u)}this.element.style.height=Math.min(window.innerHeight-g.SIZE_TOOLBAR_HEIGHT,l.height+42)+"px",Le(this.element,l.left,Math.max(r-42,g.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?l=this.targetElement.firstElementChild.getBoundingClientRect():l=this.targetElement.getBoundingClientRect(),window.innerHeight-l.bottom-4>l.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-l.bottom-12)+"px"),Le(this.element,l.left,l.bottom+4,l.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(Le(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,g.SIZE_TOOLBAR_HEIGHT)-12)+"px");const o=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(o.top<l.top?this.element.style.maxHeight=Math.floor(l.top-o.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-o.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):a.observe(i)}),this.targetElement&&(this.targetElement.style.cursor="")}}class Ko{constructor(e){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=n=>{window.siyuan.blockPanels.push(new iu({app:this.app,targetElement:n.targetElement,isBacklink:n.isBacklink,x:n.x,y:n.y,nodeIds:n.ids,defIds:n.defIds}))},this.app=e.app,this.i18n=e.i18n,this.name=e.name,this.displayName=e.displayName,this.eventBus=new $r(e.name)}onload(){}onunload(){}onLayoutReady(){}addCommand(e){this.commands.push(e)}addIcons(e){document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${e}</defs></svg>`)}addTopBar(e){if(!e.icon.startsWith("icon")&&!e.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const n=document.createElement("div");return n.setAttribute("data-menu","true"),n.addEventListener("click",e.callback),n.id=`plugin_${this.name}_${this.topBarIcons.length}`,H()?(n.className="b3-menu__item",n.innerHTML=(e.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${e.icon}"></use></svg>`:e.icon)+`<span class="b3-menu__label">${e.title}</span>`):_e()||(n.className="toolbar__item ariaLabel",n.setAttribute("aria-label",e.title),n.innerHTML=e.icon.startsWith("icon")?`<svg><use xlink:href="#${e.icon}"></use></svg>`:e.icon,n.addEventListener("click",e.callback),n.setAttribute("data-position",e.position||"right")),this.topBarIcons.push(n),n}addStatusBar(e){}openSetting(){this.setting&&this.setting.open(this.name)}loadData(e){return typeof this.data[e]=="undefined"&&(this.data[e]=""),new Promise(n=>{_("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{a.code!==404&&(this.data[e]=a),n(this.data[e])})})}saveData(e,n){return new Promise(a=>{const i=`/data/storage/petal/${this.name}/${e}`;let s;typeof n=="object"?s=new File([new Blob([JSON.stringify(n)],{type:"application/json"})],i.split("/").pop()):s=new File([new Blob([n])],i.split("/").pop());const l=new FormData;l.append("path",i),l.append("file",s),l.append("isDir","false"),_("/api/file/putFile",l,o=>{this.data[e]=n,a(o)})})}removeData(e){return new Promise(n=>{this.data||(this.data={}),_("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{delete this.data[e],n(a)})})}getOpenedTab(){const e={};return Object.keys(this.models).forEach(a=>{e[a.replace(this.name,"")]=[]}),e}addTab(e){}addDock(e){}}class su{constructor(e){this.items=[],this.confirmCallback=e.confirmCallback,this.width=e.width||(H()?"92vw":"768px"),this.height=e.height||"80vh"}addItem(e){this.items.push(e)}open(e){var n;const a=new be({title:e,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),i=a.element.querySelector(".b3-dialog__content");this.items.forEach(l=>{let o="",r=l.actionElement;!l.actionElement&&l.createActionElement&&(r=l.createActionElement()),r&&r.tagName==="TEXTAREA"?o=`<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${l.title}
        ${l.description?`<div class="b3-label__text">${l.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</label>`:o=`<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${l.title}
        ${l.description?`<div class="b3-label__text">${l.description}</div>`:""}
    </div>
    <span class="fn__space${r?"":" fn__none"}"></span>
</label>`,i.insertAdjacentHTML("beforeend",o),r&&(["INPUT","TEXTAREA"].includes(r.tagName)&&a.bindInput(r,()=>{s[1].dispatchEvent(new CustomEvent("click"))}),r.tagName==="TEXTAREA"?i.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",r):i.lastElementChild.insertAdjacentElement("beforeend",r))}),(n=i.querySelector("input"))==null||n.focus();const s=a.element.querySelectorAll(".b3-dialog__action .b3-button");s[0].addEventListener("click",()=>{a.destroy()}),s[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),a.destroy()})}}let Zo,Xo;Zo=()=>{},Xo=()=>{};const lu={confirm:Te,showMessage:oe,adaptHotkey:De,fetchPost:_,fetchSyncPost:Dt,fetchGet:co,getFrontend:rt,getBackend:qt,openTab:Zo,openWindow:Xo,Protyle:un,Plugin:Ko,Dialog:be,Menu:ut,Setting:su};var fs=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});const ou=t=>({siyuan:lu})[t],ru=(t,e)=>window.eval("(function anonymous(require, module, exports){".concat(t,`
})
//# sourceURL=`).concat(e,`
`)),cu=t=>fs(void 0,null,function*(){const e=yield Dt("/api/petal/loadPetals",{frontend:rt()});let n="";e.data.forEach(i=>{Qo(t,i),n+=i.css||`
`});const a=document.createElement("style");a.id="pluginsStyle",a.textContent=n,document.head.append(a)}),Qo=(t,e)=>fs(void 0,null,function*(){const n={},a={exports:n};try{ru(e.js,"plugin:"+encodeURIComponent(e.name))(ou,a,n)}catch(l){console.error(`plugin ${e.name} run error:`,l);return}const i=(a.exports||n).default||a.exports;if(typeof i!="function"){console.error(`plugin ${e.name} has no export`);return}if(!(i.prototype instanceof Ko)){console.error(`plugin ${e.name} does not extends Plugin`);return}const s=new i({app:t,displayName:e.displayName,name:e.name,i18n:e.i18n});t.plugins.push(s);try{yield s.onload()}catch(l){console.error(`plugin ${e.name} onload error:`,l)}return s}),Du=(t,e)=>fs(void 0,null,function*(){const n=yield Qo(t,e),a=document.createElement("style");return a.textContent=e.css,document.head.append(a),Jo(n),n}),Mu=(t,e,n,a)=>{const i=Object.keys(n.docks);t.forEach((s,l)=>{i.includes(s.type)&&(a==="Left"?n.docks[s.type].config.position=e===0?"LeftTop":"LeftBottom":a==="Right"?n.docks[s.type].config.position=e===0?"RightTop":"RightBottom":a==="Bottom"&&(n.docks[s.type].config.position=e===0?"BottomLeft":"BottomRight"),n.docks[s.type].config.index=l,n.docks[s.type].config.show=s.show,n.docks[s.type].config.size=s.size)})},Hu=t=>{window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={}),t.commands.forEach(e=>{if(!window.siyuan.config.keymap.plugin[t.name]){e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[t.name]={[e.langKey]:{default:e.hotkey,custom:e.hotkey}};return}if(!window.siyuan.config.keymap.plugin[t.name][e.langKey]){e.customHotkey=e.hotkey,window.siyuan.config.keymap.plugin[t.name][e.langKey]={default:e.hotkey,custom:e.hotkey};return}window.siyuan.config.keymap.plugin[t.name][e.langKey]&&(e.customHotkey=window.siyuan.config.keymap.plugin[t.name][e.langKey].custom||e.hotkey,window.siyuan.config.keymap.plugin[t.name][e.langKey].default=e.hotkey)})},Jo=t=>{try{t.onLayoutReady()}catch(e){console.error(`plugin ${t.name} onLayoutReady error:`,e)}if(!_e()||H()){const e=[];if(t.topBarIcons.forEach(n=>{H()?window.siyuan.storage[g.LOCAL_PLUGINTOPUNPIN].includes(n.id)?e.push({iconHTML:n.firstElementChild.outerHTML,label:n.textContent.trim(),click(){n.dispatchEvent(new CustomEvent("click"))}}):document.querySelector("#menuAbout").after(n):_e()||(window.siyuan.storage[g.LOCAL_PLUGINTOPUNPIN].includes(n.id)&&n.classList.add("fn__none"),document.querySelector("#"+(n.getAttribute("data-position")==="right"?"barPlugins":"drag")).before(n))}),H()&&e.length>0){const n=document.createElement("div");n.classList.add("b3-menu__item"),n.setAttribute("data-menu","true"),n.innerHTML=`<svg class="b3-menu__icon"><use xlink:href="#iconPlugin"></use></svg><span class="b3-menu__label">${window.siyuan.languages.plugin}</span>`,n.addEventListener("click",()=>{const a=new ut;e.forEach(i=>{a.addItem(i)}),a.fullscreen()}),document.querySelector("#menuAbout").after(n)}}_e()};var du=(t,e,n)=>new Promise((a,i)=>{var s=r=>{try{o(n.next(r))}catch(c){i(c)}},l=r=>{try{o(n.throw(r))}catch(c){i(c)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,l);o((n=n.apply(t,e)).next())});class uu{constructor(){this.plugins=[];var e;!((e=window.webkit)!=null&&e.messageHandlers)&&!window.JSAndroid&&au(`${g.SERVICE_WORKER_PATH}?v=${g.SIYUAN_VERSION}`),We(`${g.PROTYLE_CDN}/js/lute/lute.min.js?v=${g.SIYUAN_VERSION}`,"protyleLuteScript"),fe(`${g.PROTYLE_CDN}/js/protyle-html.js?v=${g.SIYUAN_VERSION}`,"protyleWcHtmlScript"),pr(),window.siyuan={zIndex:10,notebooks:[],transactions:[],reqIds:{},backStack:[],dialogs:[],blockPanels:[],mobile:{},ws:new ii({app:this,id:Bn(),type:"main",msgCallback:n=>{this.plugins.forEach(a=>{a.eventBus.emit("ws-main",n)}),$d(this,n)}})},window.addEventListener("click",n=>{!window.siyuan.menus.menu.element.contains(n.target)&&!A(n.target,"data-menu","true")&&window.siyuan.menus.menu.remove();const a=tt(n.target,"protyle-action__copy");if(a){let i=a.parentElement.nextElementSibling.textContent.trimEnd();i=i.replace(/\u00A0/g," "),Pe(i),oe(window.siyuan.languages.copied,2e3),n.preventDefault()}}),window.addEventListener("beforeunload",()=>{ni(window.siyuan.mobile.editor.protyle)},!1),window.addEventListener("pagehide",()=>{ni(window.siyuan.mobile.editor.protyle)},!1),_("/api/system/getConf",{},n=>du(this,null,function*(){n.data.conf.keymap=g.SIYUAN_KEYMAP,window.siyuan.config=n.data.conf,yield cu(this),or(()=>{co(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${g.SIYUAN_VERSION}`,a=>{window.siyuan.languages=a,window.siyuan.menus=new Id(this),document.title=window.siyuan.languages.siyuanNote,Pc(),Ls(n.data.conf.appearance),ir(),wr(),_("/api/setting/getCloudUser",{},i=>{window.siyuan.user=i.data,_("/api/system/getEmojiConf",{},s=>{window.siyuan.emojis=s.data,Jt(()=>{eu(this),Fd(this),nu(),this.plugins.forEach(l=>{Jo(l)})})})}),yr()})}),document.addEventListener("touchstart",Yd,!1),document.addEventListener("touchmove",jd,!1),document.addEventListener("touchend",a=>{Wd(a,er)},!1),window.addEventListener("keydown",a=>{if(getSelection().rangeCount>0){const i=getSelection().getRangeAt(0),s=St();if(i.toString()===""&&s&&s.protyle.wysiwyg.element.contains(i.startContainer)&&!a.altKey&&(a.key==="Backspace"||a.key==="Delete")){const l=I(i.startContainer);if(l&&q(l)){l.classList.add("protyle-wysiwyg--select"),bt(s.protyle,l,i),a.stopPropagation(),a.preventDefault();return}}}})}))}}const er=new uu;window.reconnectWebSocket=()=>{window.siyuan.ws.send("ping",{}),window.siyuan.mobile.files.send("ping",{}),window.siyuan.mobile.editor.protyle.ws.send("ping",{}),window.siyuan.mobile.popEditor.protyle.ws.send("ping",{})},window.goBack=tc,window.showKeyboardToolbar=t=>{document.getElementById("keyboardToolbar").setAttribute("data-keyboardheight",(t||window.innerHeight/2-42).toString()),vl()},window.hideKeyboardToolbar=pt,window.openFileByURL=t=>t&&fr(t)?(Ke(er,ys(t),ne("focus",t)==="1"?[g.CB_GET_ALL,g.CB_GET_FOCUS]:[g.CB_GET_FOCUS,g.CB_GET_CONTEXT,g.CB_GET_ROOTSCROLL]),!0):!1})()})();})();
